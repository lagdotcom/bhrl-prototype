"use strict";(()=>{var ie=Object.create;var q=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames,Dt=Object.getOwnPropertySymbols,ae=Object.getPrototypeOf,Rt=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var Ft=(e,t,o)=>t in e?q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,E=(e,t)=>{for(var o in t||={})Rt.call(t,o)&&Ft(e,o,t[o]);if(Dt)for(var o of Dt(t))se.call(t,o)&&Ft(e,o,t[o]);return e};var le=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),A=(e,t)=>{for(var o in t)q(e,o,{get:t[o],enumerable:!0})},pe=(e,t,o,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of re(t))!Rt.call(e,r)&&r!==o&&q(e,r,{get:()=>t[r],enumerable:!(i=ne(t,r))||i.enumerable});return e};var w=(e,t,o)=>(o=e!=null?ie(ae(e)):{},pe(t||!e||!e.__esModule?q(o,"default",{value:e,enumerable:!0}):o,e));var P=le((to,It)=>{It.exports=globalThis.wglt});var ot=w(P());var C=w(P());function K(e,t=new Map){if(!e||typeof e!="object")return e;if(t.has(e))return t.get(e);let o;if(e.nodeType&&"cloneNode"in e)o=e.cloneNode(!0),t.set(e,o);else if(e instanceof Date)o=new Date(e.getTime()),t.set(e,o);else if(e instanceof RegExp)o=new RegExp(e),t.set(e,o);else if(Array.isArray(e)){o=new Array(e.length),t.set(e,o);for(let i=0;i<e.length;i++)o[i]=K(e[i],t)}else if(e instanceof Map){o=new Map,t.set(e,o);for(let[i,r]of e.entries())o.set(i,K(r,t))}else if(e instanceof Set){o=new Set,t.set(e,o);for(let i of e)o.add(K(i,t))}else if(e instanceof Object){o={},t.set(e,o);for(let[i,r]of Object.entries(e))o[i]=K(r,t)}else throw Error(`Unable to clone ${e}`);return o}function Lt(e){return K(e,new Map)}var it=Lt,Gt=Object.keys,Nt=e=>{let t={};for(let[o,i]of e)t[o]=i;return t};var B=class{constructor(t,o){this.g=t;this.name=o;this.alive=!0,this.id=++t.lastEntityId,this.solid=!1,this.tags=new Set}applyPrefab(t,o){if(this.prefab=t,o.components&&Object.assign(this,it(o.components)),o.children)for(let{name:i,x:r,y:n,overlay:a,tags:s}of o.children){let l=this.g.spawn(i).setAttachment({parent:this,x:r,y:n});if(a)for(let p of Gt(a))Object.assign(l[p],it(a[p]));if(s)for(let p of s)l.tags.add(p)}return this}get[Symbol.toStringTag](){return this.name}kill(t){return this.alive=!1,this.eachChild(o=>this.g.kill(o,t)),this}eachChild(t){var o;for(let i of this.g.entities.get())((o=i.attachment)==null?void 0:o.parent)===this&&t(i,i.attachment)}setOwner(t){return this.owner=t,this}setAI(t){return this.ai=t,this}setAppearance(t){return this.g.dirty=!0,this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setPilot(t){return this.pilot=t,this}setPosition(t){return this.g.dirty=!0,this.position=t,this}setShip(t){return this.ship=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,o){return this.g.dirty=!0,this.position={x:t,y:o},this.eachChild((i,r)=>i.move(t+r.x,o+r.y)),this}};function Ot(e,t){var r,n,a,s;let o=(n=(r=e.appearance)==null?void 0:r.layer)!=null?n:0,i=(s=(a=t.appearance)==null?void 0:a.layer)!=null?s:0;return o!==i?o-i:e.id-t.id}var Kt=["damage","draw","kill","move","notice","playerFire","playerMove","spawn","tick"];function v(e){return typeof e=="undefined"?NaN:Math.floor(e)}function T(e){return{x:v(e.x),y:v(e.y)}}function F(e,t){let o=T(e),i=T(t);return o.x===i.x&&o.y===i.y}function H(e,t){return{x:e.x+t.x,y:e.y+t.y}}function me(e,t){if(!t||!e.length)throw new Error("Could not get midpoint");let o=i=>e.reduce((r,{offset:n})=>r+n[i],0)/e.length;return{x:t.x+o("x"),y:t.y+o("y")}}function fe(e,t,o,i=[]){let r=[];for(let{offset:n}of t){let a=H(o,n),{wall:s,solid:l}=e.getContents(a,i);s?r.push({absolute:a,offset:n,entity:"wall"}):l&&r.push({absolute:a,offset:n,entity:l})}return r}function S(e,t){let o=e.getRoot(t);return e.entities.get().filter(i=>e.getRoot(i)===o)}function V(e,t){return S(e,t).map(o=>o.id)}function R(e,t){var a;let o=e.getRoot(t),i=(a=e.getRoot(t).position)!=null?a:{x:0,y:0},r=S(e,t),n=[];for(let s of r){let{attachment:l,solid:p}=s;if(l&&p){let{x:h,y:u}=l;n.push({absolute:H(i,l),offset:{x:h,y:u},entity:s})}}return{layout:n,topLeft:i}}function Vt(e,t,o){let i=V(e,t),{layout:r,topLeft:n}=R(e,t);return!o||!n?[]:fe(e,r,o||n,i)}function I(e,t){let{layout:o,topLeft:i}=R(e,t);if(!i||!o.length)throw new Error(`Could not get midpoint of entity#${t.id}`);return me(o,i)}var rt={};A(rt,{Battleship:()=>ce,BattleshipHull:()=>he});var nt=w(P());var Wt=(n=>(n[n.Effect=0]="Effect",n[n.Ship=1]="Ship",n[n.Gun=2]="Gun",n[n.Bullet=3]="Bullet",n[n.Player=4]="Player",n))(Wt||{}),c=Wt;var ce={components:{ai:{idealDistance:8,speed:1},ship:{name:"Battleship",hp:40,maxHp:40}},children:[{name:"BattleshipHull",x:1,y:0},{name:"BattleshipHull",x:2,y:0},{name:"BattleshipHull",x:0,y:1},{name:"BattleshipHull",x:1,y:1},{name:"BattleshipHull",x:2,y:1},{name:"MachineGun",x:0,y:1},{name:"HomingMissileLauncher",x:2,y:1},{name:"FighterLauncher",x:2,y:0}]},he={components:{solid:!0,appearance:{glyph:"/",layer:c.Ship,fg:nt.Colors.WHITE,bg:nt.Colors.BROWN}}};var at={};A(at,{Bullet:()=>de,HomingMissile:()=>ye,PlayerBullet:()=>ge});var Q=w(P());var ue={Club:"",RingInvert:`
`,Female:"\f",Pilcrow:"",Silcrow:"",ResizeVertical:"",RightArrow:"",LeftArrow:"\x1B",DownWedge:"",Pentagon:"\x7F",CapitalUUmlaut:"\x9A",Cent:"\x9B",Yen:"\x9D",NotFlip:"\xA9",Not:"\xAA",InvertedExclamation:"\xAD",BoxVerticalSingle:"\xB3",BoxUpSingleHorizontalSingle:"\xC1",BoxDownSingleHorizontalSingle:"\xC2",BoxHorizontalSingle:"\xC4",BoxUpDoubleHorizontalSingle:"\xD0",BoxDownSingleHorizontalDouble:"\xD1",BoxVerticalDoubleHorizontalSingle:"\xD7",Pi:"\xE3",Theta:"\xE9",Omega:"\xEA",SymbolED:"\xED",HorizontalDivide:"\xF6"},m=ue;var de={components:{projectile:{damage:1},appearance:{glyph:".",layer:c.Bullet,fg:Q.Colors.YELLOW}}},ye={components:{projectile:{damage:1},homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,falloff:1},appearance:{glyph:"*",layer:c.Bullet,fg:Q.Colors.DARK_RED}}},ge={components:{projectile:{damage:1},appearance:{glyph:m.InvertedExclamation,layer:c.Bullet,fg:Q.Colors.YELLOW}}};var st={};A(st,{AirFistRange:()=>xe,SmokePuff:()=>be});var L=w(P());var xe={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:c.Effect,bg:(0,L.fromRgb)(0,255,255,100),blendMode:L.BlendMode.Add}}},be={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:c.Effect,bg:(0,L.fromRgb)(100,100,100,50),blendMode:L.BlendMode.Add}}};var lt={};A(lt,{Fighter:()=>Ee,FighterHull:()=>we,FighterLauncher:()=>Pe});var X=w(P());var D=(e,t,{bulletPrefab:o="Bullet",bulletVelocity:i=1,salvoCount:r=1,timeBetweenShots:n=1,timeBetweenSalvos:a=1})=>({name:e,bulletPrefab:o,bulletAngle:t,bulletVelocity:i,salvoCount:r,timeBetweenShots:n,timeBetweenSalvos:a,timer:0,salvo:r});var Pe={components:{appearance:{glyph:"_",layer:c.Gun,fg:X.Colors.DARK_CYAN},turret:D("Fighter Bay","nearestEnemy",{bulletPrefab:"Fighter",bulletVelocity:0,salvoCount:1,timeBetweenSalvos:20})}},Ee={components:{ai:{idealDistance:6,speed:2},ship:{name:"Fighter",hp:2,maxHp:2}},children:[{name:"FighterHull",x:0,y:0,overlay:{appearance:{glyph:"<"}}},{name:"FighterHull",x:1,y:0},{name:"FighterHull",x:2,y:0,overlay:{appearance:{glyph:">"}}},{name:"PeaShooter",x:1,y:0}]},we={components:{solid:!0,appearance:{glyph:"-",layer:c.Ship,fg:X.Colors.YELLOW,bg:X.Colors.DARK_BLUE}}};var pt={};A(pt,{HomingMissileLauncher:()=>Me,MachineGun:()=>He,PeaShooter:()=>Te,PlayerGun:()=>Se});var ve={Right:0,Down:Math.PI/2,Left:Math.PI,Up:Math.PI*3/2},J=ve;var W=w(P());var He={components:{appearance:{glyph:"o",layer:c.Gun,fg:W.Colors.WHITE},turret:D("Machine Gun",J.Down,{bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:5,timeBetweenShots:0,timeBetweenSalvos:12})}},Me={components:{appearance:{glyph:"o",layer:c.Gun,fg:W.Colors.YELLOW},turret:D("Homing Missile","nearestEnemy",{bulletPrefab:"HomingMissile",bulletVelocity:1,salvoCount:1,timeBetweenSalvos:8})}},Te={components:{appearance:{glyph:"o",layer:c.Gun,fg:W.Colors.LIGHT_GRAY},turret:D("Pea Shooter",J.Down,{bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:1,timeBetweenSalvos:3})}},Se={components:{appearance:{glyph:"o",layer:c.Gun,fg:W.Colors.WHITE},turret:D("Pew Pew",J.Up,{bulletPrefab:"PlayerBullet",bulletVelocity:2,salvoCount:2,timeBetweenShots:0,timeBetweenSalvos:3})}};var ft={};A(ft,{PlayerHull:()=>ke,PlayerShip:()=>Ce});var mt=w(P());var f=(e,t,o,i,r)=>({name:e,x:t,y:o,overlay:i,tags:r});var ke={components:{solid:!0,appearance:{glyph:"#",layer:c.Player,fg:mt.Colors.DARK_GRAY}}},Ce={components:{player:{weaponArrays:["Primary"]},ship:{name:"Alpha",hp:20,maxHp:20}},children:[f("PlayerHull",0,0,{appearance:{glyph:m.LeftArrow}}),f("PlayerHull",1,0,{appearance:{glyph:m.Club,fg:mt.Colors.LIGHT_GRAY}}),f("PlayerHull",2,0,{appearance:{glyph:m.RightArrow}}),f("PlayerGun",1,0,void 0,["Primary"])]};var ct={};A(ct,{CruiseyWing:()=>We,Demigod:()=>_e,DroneA:()=>Oe,DroneB:()=>Ke,DroneC:()=>Ve,GoutOFlame:()=>je,Hull:()=>Ae,Olm:()=>$e,ShipA:()=>Be,ShipB:()=>De,ShipC:()=>Fe,ShipD:()=>Re,ShipE:()=>Ie,ShipF:()=>Le,ShipG:()=>Ge,ShipH:()=>Ne});var $t=w(P());var Ae={components:{solid:!0,appearance:{glyph:"#",layer:c.Ship,fg:$t.Colors.DARK_GRAY}}},Be={components:{ship:{name:"A",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Pilcrow}})]},De={components:{ship:{name:"B",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Yen}})]},Fe={components:{ship:{name:"C",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:"W"}})]},Re={components:{ship:{name:"D",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Omega}})]},Ie={components:{ship:{name:"E",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.DownWedge}})]},Le={components:{ship:{name:"F",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.BoxVerticalDoubleHorizontalSingle}})]},Ge={components:{ship:{name:"G",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:"M"}})]},Ne={components:{ship:{name:"H",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Female}})]},Oe={components:{ship:{name:"Drone A",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Theta}})]},Ke={components:{ship:{name:"Drone B",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.SymbolED}})]},Ve={components:{ship:{name:"Drone C",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Silcrow}})]},We={components:{ship:{name:"Cruisey Wing",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Not}}),f("Hull",1,0,{appearance:{glyph:m.HorizontalDivide}}),f("Hull",2,0,{appearance:{glyph:m.NotFlip}})]},$e={components:{ship:{name:"Olm",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Cent}}),f("Hull",0,1,{appearance:{glyph:m.ResizeVertical}}),f("Hull",0,2,{appearance:{glyph:m.BoxDownSingleHorizontalDouble}})]},je={components:{ship:{name:"Gout-'o-flame",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Pentagon}}),f("Hull",1,0,{appearance:{glyph:m.BoxVerticalDoubleHorizontalSingle}}),f("Hull",2,0,{appearance:{glyph:m.BoxUpDoubleHorizontalSingle}})]},_e={components:{ship:{name:"Demigod",hp:1,maxHp:1}},children:[f("Hull",1,0,{appearance:{glyph:m.CapitalUUmlaut}}),f("Hull",0,1,{appearance:{glyph:"}"}}),f("Hull",1,1,{appearance:{glyph:m.RingInvert}}),f("Hull",2,1,{appearance:{glyph:"{"}}),f("Hull",1,2,{appearance:{glyph:"Y"}})]};var Ye=E(E(E(E(E(E(E({},rt),at),st),lt),pt),ft),ct);function ht(e,t){return e.add(new B(e,t).applyPrefab(t,Ye[t]))}var $=class{constructor(t,o=[]){this.compareFn=t;this.entities=o;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}add(t){this.entities.push(t),this.dirty=!0}clearDead(){this.entities=this.entities.filter(t=>t.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var Ue={name:"Ace",difficulty:NaN},ze=[Ue],jt=ze;var d=class{constructor(t,o){this.list=t;this.filter=o}matches(t){if(!t.alive)return!1;for(let o of this.filter)if(!t[o])return!1;return!0}forEach(t){for(let o of this.list.get())this.matches(o)&&t(o,o)}};var ut=[{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:-1}];function dt(e){return ut.map(t=>H(e,t))}function yt(e){if(!e.length)throw new Error("oneOf passed empty array");return e[Math.floor(Math.random()*e.length)]}function gt(e){let t=new d(e.entities,["ai","position"]);e.on("tick",()=>t.forEach(({ai:o,position:i},r)=>{o.attacking||(o.attacking=e.player,e.fire("notice",{e:r,noticed:e.player}));let n=V(e,r),{layout:a}=R(e,r),s=T(i),l=e.getDistanceMap(o.attacking),p=g=>{let{solid:b,wall:M}=e.getContents(g,n);return!b&&!M},h=g=>p(g)?Math.abs(l.getOrDefault(g,1/0)-o.idealDistance):1/0,u=g=>a.reduce((b,{offset:M})=>b+h(H(g,M)),0)/a.length,x=u(s),y=[];for(let g of ut){let b=H(s,g);if(!l.has(b))continue;let M=u(b);M<x?(x=M,y=[b]):M===x&&y.push(b)}if(y.length){let g=yt(y);r.move(g.x,g.y);return}})),e.on("damage",({e:o,inflicter:i})=>{if(o!==i&&o.ai&&!o.ai.attacking){let r=e.getRoot(i);r.alive&&(o.ai.attacking=r)}})}function xt(e){let t=new d(e.entities,["appearance","position"]);e.on("draw",()=>t.forEach(({appearance:o,position:i})=>e.drawIfVisible(v(i.x),v(i.y),o.glyph,o.fg,o.bg,o.blendMode)))}var _t=w(P());var Z=w(P());function G(e,t,o){return e*(1-o)+t*o}var j=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[o])=>t-o)}add(t,o){return this.points.push([t,o]),this.sort(),this}get(t){let[o,i]=this.points[0];if(t<=o)return(0,Z.fromRgb)(...i);let[r,n]=this.points[this.points.length-1];if(t>=r)return(0,Z.fromRgb)(...n);let a=this.points.findIndex(([oe])=>oe>t),[s,[l,p,h,u]]=this.points[a-1],[x,[y,g,b,M]]=this.points[a],z=(t-s)/(x-s);return(0,Z.fromRgb)(G(l,y,z),G(p,g,z),G(h,b,z),G(u,M,z))}};function _(e,t){let o=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);return Math.sqrt(o*o+i*i)}var qe={fire:new j([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function bt(e){if(!(e.intensity<=0))return{glyph:" ",layer:c.Effect,bg:qe[e.type].get(e.intensity),blendMode:_t.BlendMode.Add}}function Yt(e,t){let o=[],i=Math.floor(e.x-t),r=Math.ceil(e.x+t),n=Math.floor(e.y-t),a=Math.ceil(e.y+t);for(let s=n;s<=a;s++)for(let l=i;l<=r;l++){let p=_(e,{x:l,y:s});p>=t||o.push({x:l,y:s,intensity:t-p})}return o}function Pt(e){e.on("kill",({e:t})=>{let{explodes:o,name:i,position:r}=t;if(o&&r)for(let{x:n,y:a,intensity:s}of Yt(r,o.size))e.add(new B(e,i+"Explosion").setPosition({x:n,y:a}).setField({type:"fire",intensity:s,falloff:o.falloff}))})}function Et(e){let t=new d(e.entities,["ship"]),o=new d(e.entities,["field","position"]);e.on("tick",()=>o.forEach(({field:i,position:r},n)=>{i.intensity-=i.falloff,n.setAppearance(bt(i)),i.intensity<=0?e.kill(n):t.forEach(({},a)=>{let{layout:s}=R(e,a);s.find(({absolute:p})=>F(p,r))&&e.damage(a,i.intensity,n)})})),e.on("spawn",({e:i})=>{i.field&&i.setAppearance(bt(i.field))})}var k=w(P());var Ut=Math.PI*2;function N(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}function zt(e,t){let o=(e-t)%Ut,i=(t-e)%Ut;return o<i?-o:i}function qt(e){let t=Math.cos(e.angle)*e.vel,o=Math.sin(e.angle)*e.vel;return[t,o]}function Qt(e){return e.salvo<=0?"Reloading":e.timer>0?"Chambering":"Ready"}function Xt(e){e.timer>0&&(e.timer--,e.timer<=0&&e.salvo<=0&&(e.salvo=e.salvoCount))}function tt(e){return e.timer===0}function et(e,t,o,i,r,n=[]){--t.salvo<=0?t.timer=t.timeBetweenSalvos:t.timer=t.timeBetweenShots;let a={x:o.x+.5,y:o.y+.5},s=t.bulletAngle==="nearestEnemy"?N(a,i):t.bulletAngle,l=e.spawn(t.bulletPrefab).setIgnoreSolid({ids:n}).move(a.x,a.y);return t.bulletVelocity&&l.setMotion({angle:s,vel:t.bulletVelocity}),l.ai||l.setOwner(r),l}function wt(e,t){return t===1?e:e+"s"}var O=5;function Qe(e,t,o,i,r,n,a,s,l){let p=`${Math.ceil(r)}/${n}`,h=Math.floor(r/n*i);e.drawHLine(t,o,i," ",void 0,s),h&&e.drawHLine(t,o,h," ",void 0,a),e.drawCenteredString(t+i/2,o,p,l)}function Xe(e,t,o,i){e.drawString(t,o,i.name);let r=Qt(i);if(r==="Reloading"){e.drawString(t,o+1,`Reloading (${i.timer})`,k.Colors.LIGHT_RED);return}let n=`${i.salvo}/${i.salvoCount}`;e.drawString(t,o+1,n,k.Colors.YELLOW),r==="Chambering"&&e.drawString(t+n.length,o+1,` (${i.timer})`,k.Colors.BROWN)}function vt(e){let{mapWidth:t,mapHeight:o,term:i}=e,r=o;e.on("draw",()=>{let n=e.player;i.fillRect(0,o,i.width,O," "),i.drawSingleBox(0,o,i.width,O);let a=1,s=o+1,l=`${n.pilot.name} in ${n.ship.name}`,p=Math.max(10,l.length-3);i.drawString(a,s,l),i.drawString(a,s+1,"HP:"),Qe(i,a+3,s+1,p,n.ship.hp,n.ship.maxHp,k.Colors.DARK_GREEN,k.Colors.DARK_RED,k.Colors.WHITE),a+=p+4,i.drawChar(a-1,s-1,m.BoxDownSingleHorizontalSingle),i.drawVLine(a-1,s,O-2,m.BoxVerticalSingle),i.drawChar(a-1,s+O-2,m.BoxUpSingleHorizontalSingle);for(let h of n.player.weaponArrays){let u=S(e,n).filter(y=>y.turret),x=a;for(let y of u)Xe(i,x,s+1,y.turret),x+=15;i.drawString(a,s,`${h} ${wt("Weapon",u.length)}`,k.Colors.LIGHT_CYAN)}})}function Ht(e){let t=new d(e.entities,["homing","motion","position"]);e.on("tick",()=>t.forEach(({homing:o,motion:i,position:r},n)=>{var p;if(!((p=o.target)!=null&&p.alive))return;let a=I(e,o.target),s=N(r,a),l=zt(i.angle,s);Math.abs(l)<=o.strength?i.angle=s:l<0?i.angle-=o.strength:i.angle+=o.strength,--o.duration<=0&&(n.setHoming(),n.setTrail())}))}function Mt(e){let t=new d(e.entities,["lifetime"]);e.on("tick",()=>t.forEach(({lifetime:o},i)=>{--o.duration<=0&&e.kill(i)}))}function Jt(e,t){let o=t.x-e.x,i=t.y-e.y,r=Math.abs(o),n=Math.abs(i),a=o>0?1:-1,s=i>0?1:-1,l=E({},e),p=[E({},l)];for(let h=0,u=0;h<r||u<n;)(.5+h)/r<(.5+u)/n?(l.x+=a,h++):(l.y+=s,u++),p.push(E({},l));return p}function Zt(e,t,o){let i=[],r=(n,a)=>{let s=v(n),l=v(a);i.find(p=>p.x===s&&p.y===l)||i.push({x:s,y:l})};for(let n=0;n<=Math.floor(o*Math.sqrt(.5));n++){let a=Math.floor(Math.sqrt(o*o-n*n));r(e-a,t+n),r(e+a,t+n),r(e-a,t-n),r(e+a,t-n),r(e+n,t-a),r(e+n,t+a),r(e-n,t-a),r(e-n,t+a)}return i}function Tt(e){let t=new d(e.entities,["motion","position"]);e.on("tick",()=>t.forEach(({motion:o,position:i,projectile:r,ignoreSolid:n},a)=>{let[s,l]=qt(o),p={x:i.x+s,y:i.y+l},h=Jt(T(i),T(p)),u=!1,x;for(let y of h){if(!e.inBounds(y)){e.kill(a);return}e.move(a,y);let{wall:g,solid:b}=e.getContents(y,n==null?void 0:n.ids);if(g){u=!0;break}else if(b){x=b;break}}u?e.kill(a):x?(r&&e.damage(x,r.damage,a),e.kill(a)):e.move(a,p)}))}function St(e){e.on("playerMove",({move:t})=>{let o=e.player,i=H(o.position,t);Vt(e,o,i).length||(o.move(i.x,i.y),e.tick())}),e.on("playerFire",({array:t})=>{let o=e.player,i=o.player.weaponArrays[t],r=S(e,o),n=r.filter(s=>s.tags.has(i)),a=!1;for(let s of n)s.turret&&tt(s.turret)&&(et(e,s.turret,s.position,{x:0,y:0},o,r.map(l=>l.id)),a=!0);a&&e.tick()})}function kt(e){e.on("move",({e:t,old:o,pos:i})=>{t.trail&&!F(o,i)&&e.spawn(t.trail.effectPrefab).setPosition(o)})}function Ct(e){let t=new d(e.entities,["position","turret"]);e.on("tick",()=>t.forEach(({position:o,turret:i},r)=>{var s;let n=e.getRoot(r),a=(s=n.ai)==null?void 0:s.attacking;if(Xt(i),!!(a!=null&&a.alive)&&tt(i)&&a){let l=I(e,a),p=et(e,i,o,l,n,V(e,r));p.homing&&(p.homing.target=a),p.ai&&(p.ai.attacking=a)}}))}function te(e){Mt(e),Ht(e),Ct(e),Et(e),Tt(e),gt(e),xt(e),vt(e),kt(e),Pt(e),St(e)}var Y=class{constructor(t){this.keyFn=t;this.items=new Map}has(t){return this.items.has(this.keyFn(t))}get(t){return this.items.get(this.keyFn(t))}getOrDefault(t,o){let i=this.items.get(this.keyFn(t));return typeof i!="undefined"?i:o}getOrDie(t){let o=this.keyFn(t),i=this.items.get(o);if(typeof i=="undefined")throw new Error(`Invalid key: ${o}`);return i}set(t,o){this.items.set(this.keyFn(t),o)}};function At(e,t,o=1/0){let i=[],r=new Y(n=>`${n.x},${n.y}`);for(let n of e)i.push(n),r.set(n,0);for(;;){let n=i.shift();if(!n)break;let a=r.getOrDie(n)+1;if(!(a>o))for(let s of dt(n))!r.has(s)&&t(s)&&(r.set(s,a),i.push(s))}return r}function ee(e,t,o){for(let i of e.entities.get()){let{motion:r,projectile:n,position:a}=i;if(r&&n&&a&&_(t,a)<=o){let s=N(t,a);r.angle=s,i.setIgnoreSolid()}}for(let i of Zt(t.x,t.y,o))e.spawn("AirFistRange").setPosition(i)}function Bt(e){return typeof e!="undefined"}var U=class{constructor(t,o,i){this.term=t;this.mapWidth=o;this.mapHeight=i;t.update=this.update.bind(this),this.dirty=!0,this.map=new C.Console(o,i,()=>!0),this.lastEntityId=0,this.entities=new $(Ot),this.overlays=new Map,this.eventCallbacks=Nt(Kt.map(r=>[r,[]])),te(this)}fire(t,o){for(let i of this.eventCallbacks[t])i(o)}on(t,o){this.eventCallbacks[t].push(o)}spawn(t){return ht(this,t)}add(t){return this.dirty=!0,this.entities.add(t),this.fire("spawn",{e:t}),t}kill(t,o){t.alive&&(t.kill(o),this.fire("kill",{e:t,by:o}))}move(t,o){let i=t.position;t.move(o.x,o.y),i&&this.fire("move",{e:t,old:i,pos:o})}gotoDemoRoom(){this.entities.clear(),this.blankMap(),this.player=this.spawn("PlayerShip").move(v(this.mapWidth/2)-1,this.mapHeight-5).setPilot(jt[0]),this.spawn("Battleship").move(8,5)}blankMap(){let{map:t,mapHeight:o,mapWidth:i}=this;t.clear();for(let r=0;r<o;r++)for(let n=0;n<i;n++)t.setBlocked(n,r,!1),t.setBlockedSight(n,r,!1);t.computeFov(0,0,1/0)}drawIfVisible(t,o,i,r,n,a){this.map.isVisible(t,o)&&(a?this.term.drawCell(t,o,{bg:n},a):this.term.drawChar(t,o,i,r,n))}draw(){let{map:t,mapWidth:o,mapHeight:i,term:r}=this;for(let n=0;n<i;n++)for(let a=0;a<o;a++){let s=t.grid[n][a];r.drawChar(a,n,0,s.fg,s.bg)}if(this.fire("draw",void 0),this.dirty=!1,this.showOverlay){let n=this.overlays.get(this.showOverlay);if(n)for(let a=0;a<i;a++)for(let s=0;s<o;s++){let l=n.get({x:s,y:a})||1/0,p=l===1/0?"-":l<10?`${l}`:"*";r.drawChar(s,a,p,C.Colors.LIGHT_RED)}}}getRoot(t){var i;let o=(i=t.owner)!=null?i:t;return o.attachment?this.getRoot(o.attachment.parent):o}getContents(t,o=[]){let i=T(t);if(!this.inBounds(i))return{wall:!0};let r=this.map.isBlocked(i.x,i.y),n=this.entities.get().filter(s=>s.position&&F(i,s.position)),a=n.filter(s=>!o.includes(s.id)).find(s=>s.solid);return{wall:r,solid:a,other:n.filter(s=>!s.solid)}}tick(){this.overlays.clear(),this.fire("tick",void 0),this.entities.clearDead()}handleKeys(){let t=this.term.getMovementKey();if(t){this.fire("playerMove",{move:t});return}if(this.term.isKeyPressed(C.Key.VK_1)){this.fire("playerFire",{array:0});return}if(this.term.isKeyPressed(C.Key.VK_2)){this.fire("playerFire",{array:1});return}if(this.term.isKeyPressed(C.Key.VK_F)){ee(this,I(this,this.player),4.5),this.tick();return}}update(){this.handleKeys(),this.dirty&&this.draw()}saveOverlay(t,o,i){this.overlays.set(`${t.id}.${o}`,i)}inBounds(t){return t.x>=0&&t.y>=0&&t.x<this.mapWidth&&t.y<this.mapHeight}getDistanceMap(t){let o=`${t.id}.distance`,i=this.overlays.get(o);return i||(i=At(S(this,t).map(r=>r.position).filter(Bt),this.inBounds.bind(this)),this.overlays.set(o,i)),i}damage(t,o,i){let r=this.getRoot(t);r.ship&&(r.ship.hp-=o,console.log(i.name,"hits",r.name,"for",o),this.fire("damage",{e:r,inflicter:i,amount:o}),r.ship.hp<=0&&this.kill(r,i))}};function Je(e){let i=ot.DEFAULT_FONT,r=document.createElement("div");e.appendChild(r);let n=()=>{let p=60*i.charWidth,h=40*i.charHeight,u=Math.floor(window.innerWidth/p),x=Math.floor(window.innerHeight/h),y=Math.min(u,x);r.style.width=`${p*y}px`,r.style.height=`${h*y}px`};window.addEventListener("resize",n),n();let a=document.createElement("canvas");r.appendChild(a),requestAnimationFrame(()=>a.focus());let s=new ot.Terminal(a,60,40,{font:i}),l=new U(s,60,40-O);l.gotoDemoRoom(),window.g=l}window.addEventListener("load",()=>Je(document.body));})();
//# sourceMappingURL=bundle.js.map
