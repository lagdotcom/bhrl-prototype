"use strict";(()=>{var ko=Object.create;var Ut=Object.defineProperty,Go=Object.defineProperties,Fo=Object.getOwnPropertyDescriptor,Ko=Object.getOwnPropertyDescriptors,Wo=Object.getOwnPropertyNames,$e=Object.getOwnPropertySymbols,Oo=Object.getPrototypeOf,qe=Object.prototype.hasOwnProperty,No=Object.prototype.propertyIsEnumerable;var ze=(e,t,o)=>t in e?Ut(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,G=(e,t)=>{for(var o in t||={})qe.call(t,o)&&ze(e,o,t[o]);if($e)for(var o of $e(t))No.call(t,o)&&ze(e,o,t[o]);return e},Qe=(e,t)=>Go(e,Ko(t));var _o=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),ot=(e,t)=>{for(var o in t)Ut(e,o,{get:t[o],enumerable:!0})},Uo=(e,t,o,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Wo(t))!qe.call(e,r)&&r!==o&&Ut(e,r,{get:()=>t[r],enumerable:!(i=Fo(t,r))||i.enumerable});return e};var D=(e,t,o)=>(o=e!=null?ko(Oo(e)):{},Uo(t||!e||!e.__esModule?Ut(o,"default",{value:e,enumerable:!0}):o,e));var w=_o((wr,Je)=>{Je.exports=globalThis.wglt});var ee=D(w());var te=D(w());function Dt(e,t=new Map){if(!e||typeof e!="object")return e;if(t.has(e))return t.get(e);let o;if(e.nodeType&&"cloneNode"in e)o=e.cloneNode(!0),t.set(e,o);else if(e instanceof Date)o=new Date(e.getTime()),t.set(e,o);else if(e instanceof RegExp)o=new RegExp(e),t.set(e,o);else if(Array.isArray(e)){o=new Array(e.length),t.set(e,o);for(let i=0;i<e.length;i++)o[i]=Dt(e[i],t)}else if(e instanceof Map){o=new Map,t.set(e,o);for(let[i,r]of e.entries())o.set(i,Dt(r,t))}else if(e instanceof Set){o=new Set,t.set(e,o);for(let i of e)o.add(Dt(i,t))}else if(e instanceof Object){o={},t.set(e,o);for(let[i,r]of Object.entries(e))o[i]=Dt(r,t)}else throw Error(`Unable to clone ${e}`);return o}function Xe(e){return Dt(e,new Map)}var j=Xe,Ze=Object.keys,to=e=>{let t={};for(let[o,i]of e)t[o]=i;return t};var st=class{constructor(t,o){this.g=t;this.name=o;this.alive=!0,this.id=++t.lastEntityId,this.solid=!1,this.tags=new Set}applyPrefab(t,o){if(this.prefab=t,o.components&&Object.assign(this,j(o.components)),o.children)for(let{name:i,x:r,y:n,overlay:a,tags:s}of o.children){let l=this.g.spawn(i).setAttachment({parent:this,x:r,y:n});if(a)for(let m of Ze(a))Object.assign(l[m],j(a[m]));if(s)for(let m of s)l.tags.add(m)}return this}get[Symbol.toStringTag](){return this.name}kill(t){return this.alive=!1,this.eachChild(o=>this.g.kill(o,t)),this}eachChild(t){var o;for(let i of this.g.entities.get())((o=i.attachment)==null?void 0:o.parent)===this&&t(i,i.attachment)}setAI(t){return this.ai=t,this}setAppearance(t){return this.g.refresh(),this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setDelayedShot(t){return this.delayedShot=t,this}setDoubleShot(t){return this.doubleShot=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setItem(t){return this.item=t,this}setLastMovement(t){return this.lastMovement=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setOrigin(t){return this.origin=t,this}setPilot(t){return this.pilot=t,this}setPosition(t){return this.g.refresh(),this.position=t,this}setShip(t){return this.ship=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,o){return this.g.refresh(),this.position={x:t,y:o},this.eachChild((i,r)=>i.move(t+r.x,o+r.y)),this}};function eo(e,t){var r,n,a,s;let o=(n=(r=e.appearance)==null?void 0:r.layer)!=null?n:0,i=(s=(a=t.appearance)==null?void 0:a.layer)!=null?s:0;return o!==i?o-i:e.id-t.id}var oo=["damage","draw","kill","move","notice","playerBomb","playerFire","playerMove","spawn","tick","waveBegin","waveNext"];var oe={};ot(oe,{AcidBullet:()=>zo,BellowMissile:()=>oi,Bullet:()=>jo,CrushBullet:()=>Qo,DroneBullet:()=>Yo,HomingMissile:()=>Xo,OutcryBullet:()=>$o,PlayerBullet:()=>ii,SalvoMissileA:()=>Zo,SalvoMissileB:()=>ti,SalvoMissileC:()=>ei,SmiteMissile:()=>Jo,TalonBullet:()=>qo});var F=D(w());var Vo={Heart:"",Diamond:"",Club:"",Dot:"\x07",Ring:"	",RingInvert:`
`,Male:"\v",Female:"\f",DoubleNote:"",Star:"",Pilcrow:"",Silcrow:"",ResizeVertical:"",UpArrow:"",DownArrow:"",RightArrow:"",LeftArrow:"\x1B",DownWedge:"",Pentagon:"\x7F",AHat:"\x83",EHat:"\x88",CapitalUUmlaut:"\x9A",Cent:"\x9B",Yen:"\x9D",CurlyF:"\x9F",NotFlip:"\xA9",Not:"\xAA",InvertedExclamation:"\xAD",Fill1:"\xB0",Fill2:"\xB1",Fill3:"\xB2",BoxVerticalSingle:"\xB3",BoxLeftSingleUpDouble:"\xBD",BoxUpSingleHorizontalSingle:"\xC1",BoxDownSingleHorizontalSingle:"\xC2",BoxHorizontalSingle:"\xC4",BoxUpDoubleHorizontalSingle:"\xD0",BoxDownSingleHorizontalDouble:"\xD1",BoxRightSingleUpDouble:"\xD3",BoxVerticalDoubleHorizontalSingle:"\xD7",Filled:"\xDB",Beta:"\xE1",Gamma:"\xE2",Pi:"\xE3",Theta:"\xE9",Omega:"\xEA",SymbolED:"\xED",SetMember:"\xEE",HorizontalDivide:"\xF6",Approximates:"\xF7",Squared:"\xFD",Square:"\xFE"},f=Vo;var io=(s=>(s[s.Effect=0]="Effect",s[s.Item=1]="Item",s[s.Ship=2]="Ship",s[s.Gun=3]="Gun",s[s.Bullet=4]="Bullet",s[s.Player=5]="Player",s[s.PlayerBullet=6]="PlayerBullet",s))(io||{}),x=io;var jo={components:{projectile:{damage:1,scaling:{stat:"body",multiplier:1}},appearance:{glyph:f.InvertedExclamation,layer:x.Bullet,fg:F.Colors.YELLOW}}},Yo={components:{projectile:{damage:1,scaling:{stat:"body",multiplier:1}},appearance:{glyph:".",layer:x.Bullet,fg:F.Colors.ORANGE}}},$o={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:"o",layer:x.Bullet,fg:(0,F.fromRgb)(255,55,135)}}},zo={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:f.Approximates,layer:x.Bullet,fg:(0,F.fromRgb)(55,55,215)}}},qo={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:"`",layer:x.Bullet,fg:(0,F.fromRgb)(135,255,55)}}},Qo={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},homing:{strength:1,duration:3},appearance:{glyph:f.Square,layer:x.Bullet,fg:(0,F.fromRgb)(175,175,0)}}},Jo={components:{projectile:{damage:2,scaling:{stat:"mind",multiplier:1}},homing:{strength:10,duration:1},explodes:{size:7,type:"Fire",falloff:1},appearance:{glyph:"*",layer:x.Bullet,fg:F.Colors.ORANGE}}},Xo={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:x.Bullet,fg:F.Colors.DARK_RED}}},Zo={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:4},trail:{effectPrefab:"SmokePuff"},explodes:{size:8,type:"Fire",falloff:1},appearance:{glyph:"*",layer:x.Bullet,fg:F.Colors.DARK_RED}}},ti={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.25,duration:5},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:x.Bullet,fg:F.Colors.DARK_RED}}},ei={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.35,duration:8},trail:{effectPrefab:"SmokePuff"},explodes:{size:4,type:"Fire",falloff:1},appearance:{glyph:"*",layer:x.Bullet,fg:F.Colors.DARK_RED}}},oi={components:{projectile:{damage:20,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:30},trail:{effectPrefab:"SmokePuff"},explodes:{size:6,type:"Fire",falloff:1},appearance:{glyph:f.CurlyF,layer:x.Bullet,fg:F.Colors.LIGHT_RED}}},ii={components:{projectile:{damage:3,scaling:{stat:"body",multiplier:1}},appearance:{glyph:"!",layer:x.PlayerBullet,fg:F.Colors.YELLOW}}};var ie={};ot(ie,{AirFistRange:()=>ri,SmokePuff:()=>ni});var yt=D(w());var ri={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:x.Effect,bg:(0,yt.fromRgb)(0,255,255,100),blendMode:yt.BlendMode.Add}}},ni={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:x.Effect,bg:(0,yt.fromRgb)(100,100,100,50),blendMode:yt.BlendMode.Add}}};var re={};ot(re,{AcidSplash:()=>ci,Bellow:()=>Ei,Cleave:()=>mi,CrushPattern:()=>yi,DemandHomage:()=>Si,DroneGun:()=>bi,Outcry:()=>fi,PeaShooter:()=>li,PlayerGun:()=>pi,Salvo:()=>xi,ShuttleLaunch:()=>hi,Smite:()=>gi,TalonSwipe:()=>di,TheDragonWakes:()=>Pi,Veto:()=>ui});var c=(e,t,o,i,r)=>({name:e,x:t,y:o,overlay:i,tags:r}),H=(e,t,o,i=0)=>({name:e,type:t,maxHp:o,hp:0,maxShield:i,shield:0,shieldTimer:0}),B=(e,{salvoCount:t=1,timeBetweenShots:o=1,timeBetweenSalvos:i=1,ammunition:r=1/0},n)=>({name:e,shots:n,salvoCount:t,timeBetweenShots:o,timeBetweenSalvos:i,timer:0,salvo:t,ammunition:r}),u=(e,t,o,i,{canDouble:r,delay:n,offset:a,beam:s}={})=>({type:"bullet",canDouble:r,name:e,prefab:t,angle:o,vel:i,delay:n,offset:a,beam:s}),U=(e,{delay:t,offset:o}={})=>({type:"array",canDouble:!1,tag:e,delay:t,offset:o});var lt=Math.PI/2,Vt=lt/2,ai={Right:0,DownRight:Vt,Down:lt,DownLeft:lt+Vt,Left:lt*2,UpLeft:lt*2+Vt,Up:lt*3,UpRight:lt*3+Vt},d=ai;function Y(e){return typeof e=="undefined"?NaN:Math.floor(e)}var y=(e,t)=>({x:e,y:t});function k(e){return y(Y(e.x),Y(e.y))}function Q(e,t){if(typeof e=="undefined"||typeof t=="undefined")return!1;let o=k(e),i=k(t);return o.x===i.x&&o.y===i.y}function A(e,t){return y(e.x+t.x,e.y+t.y)}var si={Right:y(1,0),DownRight:y(1,1),Down:y(0,1),DownLeft:y(-1,1),Left:y(-1,0),UpLeft:y(-1,-1),Up:y(0,-1),UpRight:y(1,-1),None:y(0,0)},K=si;var li={components:{turret:B("Main Gun",{salvoCount:1,timeBetweenSalvos:3},[u("Bullet","Bullet",d.Down,2,{canDouble:!0})])}},pi={components:{turret:B("Main Gun",{salvoCount:2,timeBetweenShots:0,timeBetweenSalvos:3},[u("Your Bullet","PlayerBullet",d.Up,2,{canDouble:!0})])}},mi={components:{turret:B("Cleave",{salvoCount:1,timeBetweenSalvos:11},[U("Primary"),U("Primary",{delay:1}),U("Primary",{delay:2}),U("Primary",{delay:3}),U("Primary",{delay:4})])}},fi={components:{turret:B("Outcry",{salvoCount:1,timeBetweenSalvos:8},[u("Outcry","OutcryBullet",d.DownLeft,2),u("Outcry","OutcryBullet",d.Left,2),u("Outcry","OutcryBullet",d.UpLeft,2),u("Outcry","OutcryBullet",d.Up,2),u("Outcry","OutcryBullet",d.UpRight,2),u("Outcry","OutcryBullet",d.Right,2),u("Outcry","OutcryBullet",d.DownRight,2)])}},ci={components:{turret:B("Acid Splash",{salvoCount:1,timeBetweenSalvos:13},[u("Acid Splash","AcidBullet",d.UpLeft,2),u("Acid Splash","AcidBullet",d.UpRight,2),u("Acid Splash","AcidBullet",d.Left,2,{delay:1}),u("Acid Splash","AcidBullet",d.Right,2,{delay:1}),u("Acid Splash","AcidBullet",d.DownLeft,2,{delay:2}),u("Acid Splash","AcidBullet",d.DownRight,2,{delay:2}),u("Acid Splash","AcidBullet",d.Left,2,{delay:3}),u("Acid Splash","AcidBullet",d.Right,2,{delay:3}),u("Acid Splash","AcidBullet",d.UpLeft,2,{delay:4}),u("Acid Splash","AcidBullet",d.UpRight,2,{delay:4})])}},hi={components:{turret:B("Shuttle Launch",{salvoCount:1,timeBetweenSalvos:27},[u("Runabout","DroneA",d.Left,0,{offset:K.Left}),u("Runabout","DroneA",d.Right,0,{offset:K.Right})])}},ui={components:{turret:B("Veto",{salvoCount:1,timeBetweenSalvos:21},[u("Veto","HomingMissile",d.Up,1),u("Wasp","DroneB",d.DownRight,0,{offset:K.DownRight})])}},di={components:{turret:B("Talon Swipe",{salvoCount:1,timeBetweenSalvos:10},[u("Talon Swipe","TalonBullet",d.Left,2),u("Talon Swipe","TalonBullet",d.Right,2),u("Talon Swipe","TalonBullet",d.Left,2,{delay:1}),u("Talon Swipe","TalonBullet",d.Right,2,{delay:1}),u("Talon Swipe","TalonBullet",d.Left,2,{delay:2}),u("Talon Swipe","TalonBullet",d.Right,2,{delay:2})])}},yi={components:{turret:B("Crush Pattern",{salvoCount:1,timeBetweenSalvos:15},[u("Crush Pattern","CrushBullet",d.Left,1),u("Crush Pattern","CrushBullet",d.UpLeft,1),u("Crush Pattern","CrushBullet",d.UpRight,1),u("Crush Pattern","CrushBullet",d.Right,1)])}},gi={components:{turret:B("Smite",{salvoCount:1,timeBetweenSalvos:16},[u("Smite","SmiteMissile",d.Right,1),u("Smite","SmiteMissile",d.Right,1,{delay:1})])}},bi={components:{turret:B("Stinger",{salvoCount:1,timeBetweenSalvos:5,ammunition:5},[u("Bullet","DroneBullet","nearestEnemy",1,{canDouble:!0})])}},xi={components:{turret:B("Salvo",{salvoCount:1,timeBetweenSalvos:10},[u("Missile","SalvoMissileA",d.UpLeft,1),u("Missile","SalvoMissileB",d.UpLeft,1),u("Missile","SalvoMissileC",d.UpLeft,1)])}},Pi={components:{turret:B("The Dragon Wakes",{salvoCount:1,timeBetweenSalvos:12},[u("Drone","DroneA",d.Up,0,{offset:K.Up}),u("Missile","HomingMissile",d.DownLeft,2,{offset:K.DownLeft}),u("Missile","HomingMissile",d.DownRight,2,{offset:K.DownRight})])}},Ei={components:{turret:B("Bellow",{salvoCount:1,timeBetweenSalvos:17},[u("Bellow","BellowMissile",d.DownLeft,1),U("Primary"),U("Primary",{delay:1}),U("Primary",{delay:2}),U("Primary",{delay:3})])}},Si={components:{turret:B("Demand Homage",{salvoCount:1,timeBetweenSalvos:21},[u("Pulsar","DroneC",d.DownLeft,0,{offset:K.DownLeft}),u("Pulsar","DroneC",d.UpLeft,0,{offset:K.UpLeft}),u("Pulsar","DroneC",d.UpRight,0,{offset:K.UpRight}),u("Pulsar","DroneC",d.DownRight,0,{offset:K.DownRight})])}};var ne={};ot(ne,{BombItem:()=>wi,DoubleItem:()=>Di,DrainItem:()=>vi,HealItem:()=>Ci,JunkItem:()=>Mi,MoneyItem:()=>Ti,RechargeItem:()=>Bi});var wi={components:{appearance:{glyph:f.DoubleNote,layer:x.Item},item:{type:"bomb",prefab:"BombItem"}}},Di={components:{appearance:{glyph:f.Squared,layer:x.Item},item:{type:"double"}}},vi={components:{appearance:{glyph:"%",layer:x.Item},item:{type:"drain"}}},Ci={components:{appearance:{glyph:f.Heart,layer:x.Item},item:{type:"heal"}}},Mi={components:{appearance:{glyph:f.Beta,layer:x.Item},item:{type:"junk"}}},Ti={components:{appearance:{glyph:f.SetMember,layer:x.Item},item:{type:"money",value:0}}},Bi={components:{appearance:{glyph:"@",layer:x.Item},item:{type:"recharge"}}};var se={};ot(se,{PlayerHull:()=>Hi,PlayerShip:()=>Ai});var ae=D(w());var Hi={components:{solid:!0,appearance:{glyph:"#",layer:x.Player,fg:ae.Colors.DARK_GRAY}}},Ai={components:{player:{weaponArrays:["Primary","Secondary"],bombs:[]},ship:H("Ace of Clubs","Player",20,10),explodes:{type:"Fire",size:6,falloff:1}},children:[c("PlayerHull",0,0,{appearance:{glyph:f.LeftArrow}}),c("PlayerHull",1,0,{appearance:{glyph:f.Club,fg:ae.Colors.LIGHT_GRAY}}),c("PlayerHull",2,0,{appearance:{glyph:f.RightArrow}}),c("PlayerGun",1,0,void 0,["Primary"]),c("Sword",1,0,void 0,["Secondary"])]};var me={};ot(me,{AtomSmasher:()=>qi,CruiseyWing:()=>Vi,Demigod:()=>$i,DroneA:()=>Ni,DroneB:()=>_i,DroneC:()=>Ui,GoutOFlame:()=>Yi,Gremlin:()=>zi,Hull:()=>Ri,Olm:()=>ji,ShipA:()=>Li,ShipB:()=>Ii,ShipC:()=>ki,ShipD:()=>Gi,ShipE:()=>Fi,ShipF:()=>Ki,ShipG:()=>Wi,ShipH:()=>Oi});var ro=D(w());var Ri={components:{solid:!0,appearance:{glyph:"#",layer:x.Ship,fg:ro.Colors.DARK_GRAY}}},O={idealDistance:8,firingDistance:14,speed:1},J=c("PeaShooter",0,0,void 0,["Primary"]),it={type:"Fire",size:4,falloff:1},Li={components:{ai:O,ship:H("Axle","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:f.Pilcrow}}),J,c("Cleave",0,0,void 0,["Special"])]},Ii={components:{ai:O,ship:H("Baying Hound","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:f.Yen}}),J,c("Outcry",0,0,void 0,["Special"])]},ki={components:{ai:O,ship:H("Caustic","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:"W"}}),J,c("AcidSplash",0,0,void 0,["Special"])]},Gi={components:{ai:O,ship:H("Defiant","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:f.Omega}}),J,c("ShuttleLaunch",0,0,void 0,["Special"])]},Fi={components:{ai:O,ship:H("Executor","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:f.DownWedge}}),J,c("Veto",0,0,void 0,["Special"])]},Ki={components:{ai:O,ship:H("Falcon","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:f.Pi}}),J,c("TalonSwipe",0,0,void 0,["Special"])]},Wi={components:{ai:O,ship:H("Gauntlet","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:"M"}}),J,c("CrushPattern",0,0,void 0,["Special"])]},Oi={components:{ai:O,ship:H("Halo","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:f.Female}}),J,c("Smite",0,0,void 0,["Special"])]},le={idealDistance:5,firingDistance:6,speed:1},no=c("DroneGun",0,0,void 0,["Primary"]),pe={type:"Fire",size:3,falloff:1},Ni={components:{ai:le,ship:H("Runabout","Escort",1),explodes:pe},children:[c("Hull",0,0,{appearance:{glyph:f.Theta}}),J]},_i={components:{ai:le,ship:H("Wasp","Escort",1),explodes:pe},children:[c("Hull",0,0,{appearance:{glyph:f.SymbolED}}),no]},Ui={components:{ai:le,ship:H("Pulsar","Escort",1),explodes:pe},children:[c("Hull",0,0,{appearance:{glyph:f.Silcrow}}),no]},gt={type:"Fire",size:6,falloff:1},Vi={components:{ai:O,ship:H("Cruisey Wing","Battleship",10,5),explodes:gt},children:[c("Hull",0,0,{appearance:{glyph:f.Not}}),c("Hull",1,0,{appearance:{glyph:f.HorizontalDivide}}),c("Hull",2,0,{appearance:{glyph:f.NotFlip}}),c("PeaShooter",0,0,void 0,["Primary"]),c("PeaShooter",1,0,void 0,["Primary"]),c("PeaShooter",2,0,void 0,["Primary"]),c("Salvo",1,0,void 0,["Special"])]},ji={components:{ai:O,ship:H("Olm","Battleship",15,4),explodes:gt},children:[c("Hull",0,0,{appearance:{glyph:f.Cent}}),c("Hull",0,1,{appearance:{glyph:f.ResizeVertical}}),c("Hull",0,2,{appearance:{glyph:f.BoxDownSingleHorizontalDouble}}),c("PeaShooter",0,2,void 0,["Primary"]),c("TheDragonWakes",0,0,void 0,["Special"])]},Yi={components:{ai:O,ship:H("Gout-o'-flame","Battleship",5,20),explodes:gt},children:[c("Hull",0,0,{appearance:{glyph:f.Pentagon}}),c("Hull",1,0,{appearance:{glyph:f.BoxVerticalDoubleHorizontalSingle}}),c("Hull",2,0,{appearance:{glyph:f.Pentagon}}),c("Hull",1,1,{appearance:{glyph:f.BoxUpDoubleHorizontalSingle}}),c("PeaShooter",1,1,void 0,["Primary"]),c("Bellow",1,1,void 0,["Special"])]},$i={components:{ai:O,ship:H("Demigod","Battleship",30,15),explodes:gt},children:[c("Hull",1,0,{appearance:{glyph:f.CapitalUUmlaut}}),c("Hull",0,1,{appearance:{glyph:"}"}}),c("Hull",1,1,{appearance:{glyph:f.RingInvert}}),c("Hull",2,1,{appearance:{glyph:"{"}}),c("Hull",1,2,{appearance:{glyph:"Y"}}),c("PeaShooter",1,2,void 0,["Primary"]),c("DemandHomage",1,1,void 0,["Special"])]},zi={components:{ai:O,ship:H("Gremlin","Battleship",30,15),explodes:gt},children:[c("Hull",1,0,{appearance:{glyph:f.ResizeVertical}}),c("Hull",2,0,{appearance:{glyph:f.ResizeVertical}}),c("Hull",0,1,{appearance:{glyph:"]"}}),c("Hull",1,1,{appearance:{glyph:f.BoxLeftSingleUpDouble}}),c("Hull",2,1,{appearance:{glyph:f.BoxRightSingleUpDouble}}),c("Hull",3,1,{appearance:{glyph:f.Male}}),c("Hull",1,2,{appearance:{glyph:f.BoxVerticalSingle}}),c("Hull",2,2,{appearance:{glyph:f.Gamma}}),c("PeaShooter",1,2,void 0,["Primary"]),c("PeaShooter",2,2,void 0,["Primary"])]},qi={components:{ai:O,ship:H("Atom Smasher","Battleship",10,20),explodes:gt},children:[c("Hull",1,0,{appearance:{glyph:f.EHat}}),c("Hull",2,0,{appearance:{glyph:"-"}}),c("Hull",3,0,{appearance:{glyph:f.AHat}}),c("Hull",0,1,{appearance:{glyph:f.Fill2}}),c("Hull",1,1,{appearance:{glyph:f.Fill1}}),c("Hull",2,1,{appearance:{glyph:f.Fill2}}),c("Hull",3,1,{appearance:{glyph:f.Fill3}}),c("Hull",4,1,{appearance:{glyph:f.Filled}}),c("PeaShooter",0,1,void 0,["Primary"]),c("PeaShooter",1,1,void 0,["Primary"]),c("PeaShooter",2,1,void 0,["Primary"]),c("PeaShooter",3,1,void 0,["Primary"]),c("PeaShooter",4,1,void 0,["Primary"])]};var fe={};ot(fe,{Laser:()=>Zi,LaserBeam:()=>tr,Multiball:()=>Ji,MultiballShot:()=>Qi,StubbornDescent:()=>Xi});var vt=D(w());var Qi={components:{projectile:{damage:7},appearance:{glyph:"+",layer:x.Bullet,fg:(0,vt.fromRgb)(255,255,55)}}},Ji={components:{turret:B("Multiball",{salvoCount:1,timeBetweenSalvos:15},[u("Multiball","MultiballShot",d.DownLeft,2),u("Multiball","MultiballShot",d.Left,2),u("Multiball","MultiballShot",d.Right,2),u("Multiball","MultiballShot",d.DownRight,2),u("Runabout","DroneA",d.UpLeft,0,{offset:K.UpLeft}),u("Runabout","DroneA",d.UpRight,0,{offset:K.UpRight})])}},Xi={components:{turret:B("Stubborn Descent",{salvoCount:13,timeBetweenSalvos:21},[U("Primary")])}},Zi={components:{projectile:{damage:2},appearance:{glyph:"|",layer:x.Bullet,fg:vt.Colors.WHITE,bg:vt.Colors.LIGHT_BLUE}}},tr={components:{turret:B("Laser Beam",{salvoCount:10,timeBetweenSalvos:30},[u("Laser","Laser",d.Down,1,{offset:K.Down,beam:{duration:1,appearance:new Array(60)}})])}};var ce={};ot(ce,{Sword:()=>or,SwordBullet:()=>er});var pt=D(w());var er={components:{projectile:{damage:5,special:"increasedDropChance",scaling:{stat:"spirit",multiplier:1}},appearance:{glyph:f.Star,layer:x.PlayerBullet,fg:pt.Colors.LIGHT_GREEN}}},or={components:{turret:B("Sword",{salvoCount:1,timeBetweenSalvos:20},[u("Stab","SwordBullet","lastMovement",1,{beam:{duration:2,appearance:[{glyph:f.Star,fg:pt.Colors.LIGHT_GREEN},{glyph:"o",fg:pt.Colors.LIGHT_GREEN},{glyph:f.Diamond,fg:pt.Colors.LIGHT_GREEN},{glyph:f.Ring,fg:pt.Colors.DARK_GREEN},{glyph:f.Dot,fg:pt.Colors.DARK_GRAY}]}})])}};var ao=G(G(G(G(G(G(G(G({},oe),ie),ne),re),se),me),fe),ce);function jt(e){return ao[e]}function he(e,t){return e.add(new st(e,t).applyPrefab(t,ao[t]))}var Ct=class{constructor(t,o=[]){this.compareFn=t;this.entities=o;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}clearExceptFor(t){for(let o of this.entities)t.includes(o.id)||(o.alive=!1);this.clearDead()}add(t){this.entities.push(t),this.dirty=!0}clearDead(){this.entities=this.entities.filter(t=>t.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var M=D(w());var N=D(w());var _=D(w());function ir(e,t){if(!t||!e.length)throw new Error("Could not get midpoint");let o=i=>e.reduce((r,{offset:n})=>r+n[i],0)/e.length;return y(t.x+o("x"),t.y+o("y"))}function rr(e,t,o,i=[]){let r=[];for(let{offset:n}of t){let a=A(o,n),{oob:s,wall:l,solid:m}=e.getContents(a,i);s?r.push({absolute:a,offset:n,entity:"oob"}):l?r.push({absolute:a,offset:n,entity:"wall"}):m&&r.push({absolute:a,offset:n,entity:m})}return r}function T(e,t){let o=e.getRoot(t);return e.entities.get().filter(i=>e.getRoot(i)===o)}function X(e,t){return T(e,t).map(o=>o.id)}function $(e,t){var s;let o=(s=e.getRoot(t).position)!=null?s:y(0,0),i=T(e,t),r=[],n=0,a=0;for(let l of i){let{attachment:m,solid:p}=l;if(m&&p){let{x:h,y:S}=m;r.push({absolute:A(o,m),offset:{x:h,y:S},entity:l}),n=Math.max(h+1,n),a=Math.max(S+1,a)}}return{layout:r,topLeft:o,width:n,height:a}}function so(e,t,o){let i=X(e,t),{layout:r,topLeft:n}=$(e,t);return!o||!n?[]:rr(e,r,o||n,i)}function I(e,t){let{layout:o,topLeft:i}=$(e,t);if(!i||!o.length){if(t.position)return t.position;throw new Error(`Could not get midpoint of entity#${t.id}`)}return ir(o,i)}function lo(e,t,o,i,r){for(let n=0;n<r;n++)for(let a=0;a<i;a++){let{oob:s,wall:l,solid:m,other:p}=e.getContents({x:t+a,y:o+n});if(s||l||m||p.length)return!1}return!0}var C=class{constructor(t,o){this.list=t;this.filter=o}matches(t){if(!t.alive)return!1;for(let o of this.filter)if(!t[o])return!1;return!0}forEach(t){for(let o of this.list.get())this.matches(o)&&t(o,o)}};var ue=Math.PI*2;function rt(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}function po(e,t){let o=(e-t)%ue,i=(t-e)%ue;return o<i?-o:i}function nt(e){let t=Math.cos(e.angle)*e.vel,o=Math.sin(e.angle)*e.vel;return[t,o]}function mo(e){for(;e<0;)e+=ue;return e}var Do=D(w());function mt(e,t){let o=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);return Math.sqrt(o*o+i*i)}function Yt(e,t,o){let{ship:i}=t;if(!i)throw new Error(`Cannot put pilot into entity ${t.name} (no ship)`);if(t.setPilot(o),i.maxHp+=nr(t),o.special){let r=I(e,t);e.spawn(o.special).setAttachment(Qe(G({},k(r)),{parent:t})).tags.add("Special")}}function bt(e,t){return e.pilot?e.pilot[t]:0}function fo(e){return 7-bt(e,"body")}function nr(e){return bt(e,"body")*4}function co(e){return bt(e,"mind")}function ho(e){return(bt(e,"mind")-1)*5}var uo=(n=>(n[n.None=0]="None",n[n.Healthy=1]="Healthy",n[n.Double=2]="Double",n[n.Drain=4]="Drain",n[n.HasPilot=8]="HasPilot",n))(uo||{}),R=uo;var yo=["Berserker","Chopter","Duelist","Engineer","Fighter","Negotiator","Psychic","Smuggler"];var W=D(w()),$t=[0,W.Colors.DARK_RED,W.Colors.BROWN,W.Colors.LIGHT_RED,W.Colors.ORANGE,W.Colors.YELLOW,W.Colors.WHITE],Z={Typical:{fg:W.Colors.DARK_GRAY},Healthy:{fg:W.Colors.DARK_GREEN},Double:{fg:W.Colors.LIGHT_GRAY},Multi:{fg:W.Colors.DARK_MAGENTA},Drain:{fg:W.Colors.DARK_RED},StarPilot:{fg:W.Colors.YELLOW},Mega:{fg:W.Colors.BLACK,bg:W.Colors.DARK_MAGENTA}};function ft(e){return Math.random()*100<e}function de(e,t=0){let o=[];for(let i=t;i<e;i++)o.push(i);return o}function L(e){if(!e.length)throw new Error("oneOf passed empty array");return e[Math.floor(Math.random()*e.length)]}function xt(e){for(let t=e.length-1;t>0;t--){let o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function zt(e,...t){return e.filter(o=>!t.includes(o))}var be={Typical:R.None,Healthy:R.Healthy,Double:R.Double,Multi:R.Healthy|R.Double,Drain:R.Drain,StarPilot:R.HasPilot,Mega:R.Healthy|R.Double|R.Drain|R.HasPilot},ar={Typical:"Fire",Healthy:"Green",Double:"Fire",Multi:"Magenta",Drain:"Fire",StarPilot:"Yellow",Mega:"Magenta"},ye=["ShipA","ShipB","ShipC","ShipD","ShipE","ShipF","ShipG","ShipH"],ge=["CruiseyWing","Olm","GoutOFlame","Demigod","Gremlin","AtomSmasher"],sr=[{name:"Let Fate Decide",difficulty:1,groups:[{count:7,type:"Escort",prefabs:ye},{count:1,type:"Battleship",prefabs:ge}]},{name:"Court Martial",difficulty:2,groups:[{count:5,type:"Escort",prefabs:["ShipA","ShipE"]},{count:1,type:"Battleship",prefabs:["CruiseyWing"]}]},{name:"Hellhounds",difficulty:3,groups:[{count:2,type:"Escort",prefabs:["ShipB"]},{count:2,type:"Battleship",prefabs:["GoutOFlame"]}]},{name:"Chaos",difficulty:4,groups:[{count:4,type:"Escort",prefabs:["ShipC"]},{count:4,type:"Escort",prefabs:zt(ye,"ShipC")},{count:1,type:"Battleship",prefabs:["Demigod"]}]},{name:"Fly in Formation",difficulty:4,groups:[{count:7,type:"Escort",prefabs:["ShipF"]},{count:1,type:"Battleship",prefabs:ge}]},{name:"Hark!",difficulty:6,groups:[{count:3,type:"Escort",prefabs:["ShipH"]},{count:3,type:"Escort",prefabs:zt(ye,"ShipH")},{count:1,type:"Battleship",prefabs:["Demigod"]}]},{name:"Caverns.com",difficulty:7,groups:[{count:1,type:"Escort",prefabs:["ShipA","ShipG"]},{count:3,type:"Battleship",prefabs:["Olm"]}]},{name:"Humanity to the Rescue",difficulty:8,groups:[{count:7,type:"Escort",prefabs:["ShipA","ShipD","ShipE","ShipG"]},{count:1,type:"Battleship",prefabs:["GoutOFlame"]}]},{name:"Wild Hunt",difficulty:9,groups:[{count:15,type:"Escort",prefabs:["ShipB","ShipF"]},{count:1,type:"Battleship",prefabs:["Olm"]}]},{name:"Arm Wrestling",difficulty:10,groups:[{count:9,type:"Escort",prefabs:["ShipG"]},{count:2,type:"Battleship",prefabs:["CruiseyWing"]}]},{name:"Valis",difficulty:11,groups:[{count:4,type:"Escort",prefabs:["ShipC"]},{count:4,type:"Escort",prefabs:["ShipH"]},{count:1,type:"Battleship",prefabs:ge}]}];function go(e=3){return xt(sr.slice()).slice(0,e).sort((t,o)=>t.difficulty-o.difficulty)}function bo(e,t){return ft(e)?t?"Mega":L(["Healthy","Double","Multi","Drain"]):t?"StarPilot":"Typical"}function lr(e){let t=j(e);for(;t.class.length<t.talent;)t.class.push(L(yo.filter(o=>!t.class.includes(o))));return t}function xo(e,t,o,i){let r=be[o];if(r&R.HasPilot&&!i)throw new Error(`power ${o} needs pilot, none given`);let n=e.spawn(t),{ship:a}=n;if(!a)throw new Error(`Ship prefab ${t} doesn't have a ship component!`);if(a.power=o,r&R.Healthy&&(a.maxHp=a.maxHp*2+3),i){let l=lr(i);Yt(e,n,l)}Mt(a);let s=Z[o];for(let l of T(e,n))l.appearance&&Object.assign(l.appearance,s);return r&R.Double&&n.setDoubleShot({duration:1/0}),n.explodes&&(n.explodes.type=ar[o]),n}function Po(e,t){let{width:o,height:i}=$(e,t);for(let r=0;r<e.term.height;r++){let n=xt(de(e.term.width-o));for(let a of n)if(lo(e,a,r,o,i))return{x:a,y:r}}throw new Error(`Could not find ${o}x${i} spawn location`)}function Mt(e){e.hp=e.maxHp,e.shield=e.maxShield}function xe(e){return e.salvo<=0?e.ammunition<=0?"Spent":"Reloading":e.timer>0?"Chambering":"Ready"}function qt(e){e.timer>0&&(e.timer--,e.timer<=0&&e.salvo<=0&&(e.ammunition?(e.salvo=Math.min(e.salvoCount,e.ammunition),e.ammunition-=e.salvo):e.timer=1/0))}function Qt(e,t){return e.shots.find(o=>o.type==="bullet"&&o.angle==="lastMovement")&&!t.lastMovement?!1:e.timer===0}function Eo(e,t){var i;let o=(i=e.delayedShot)!=null?i:{shots:[]};o.shots.push(t),e.setDelayedShot(o)}function So(e,t,o,i,r,n,a,s,l,m){var h;let p=e.spawn(o).setIgnoreSolid({ids:l}).move(n.x,n.y);return p.name=t,s&&p.setMotion({angle:a,vel:s}),p.ship&&Mt(p.ship),i.ship&&p.setOrigin({owner:i,ship:i.ship,turret:r}),(h=p.projectile)!=null&&h.scaling&&(p.projectile.damage+=Math.floor(bt(i,p.projectile.scaling.stat)*p.projectile.scaling.multiplier)),p.appearance&&m&&Object.assign(p.appearance,m),p}function Pe(e,t,o,i,r,n,a){var g;if(n.doubleShot&&t.canDouble){let E=j(t);E.canDouble=!1,E.delay=n.player?2:1,E.appearance={fg:Do.Colors.LIGHT_GRAY},Eo(n,{turret:o,shot:E})}if(t.delay){let E=j(t);return n.player&&E.delay++,Eo(n,{turret:o,shot:E}),[]}if(t.type==="array"){let E=[];for(let v of T(e,n).filter(et=>et.tags.has(t.tag)))v.position&&v.turret&&E.push(...Pt(e,v.turret,A(v.position,(g=t.offset)!=null?g:y(0,0)),r,n,a));return E}let{angle:s,beam:l,name:m,offset:p,prefab:h,vel:S}=t,b=A(i,p!=null?p:y(.5,.5)),P=s==="nearestEnemy"?rt(b,r):s==="lastMovement"?n.lastMovement.angle:s;if(l&&S){let[E,v]=nt({angle:P,vel:S}),et=y(E,v),_t=A(b,et);return l.appearance.map(Ye=>{let wt=So(e,m,h,n,o,_t,P,0,a,t.appearance).setMotion({angle:P,vel:0}).setLifetime({duration:l.duration});return wt.appearance&&Ye&&Object.assign(wt.appearance,Ye),n.ship&&wt.setOrigin({owner:n,ship:n.ship,turret:o}),e.inBounds(_t)||wt.kill({type:"exitedMap"}),_t=A(_t,et),wt})}return[So(e,m,h,n,o,b,P,S,a,t.appearance)]}function Pt(e,t,o,i,r,n){let{timeBetweenSalvos:a,timeBetweenShots:s}=t;--t.salvo<=0?t.timer=a:t.timer=s;let l=[];for(let m of t.shots)l.push(...Pe(e,m,t,o,i,r,n));return l}function wo(e){return(e==null?void 0:e.type)==="Player"}function Jt(e,t){let o=wo(t.ship),i=I(e,t),r=e.entities.get().filter(s=>s.ship&&wo(s.ship)!==o);if(!r.length)return;let n=1/0,a;for(let s of r){let l=I(e,s),m=mt(i,l);m<n&&(n=m,a=s)}return a}var Ee=[y(-1,-1),y(-1,0),y(-1,1),y(0,1),y(1,1),y(1,0),y(1,-1),y(0,-1)];function Se(e){return Ee.map(t=>A(e,t))}function we(e){let t=new C(e.entities,["ai","position","ship"]);e.on("tick",function(){t.forEach(({ai:i,position:r},n)=>{if(n.setLastMovement(),!i.attacking||!i.attacking.alive){let g=Jt(e,n);if(g)i.attacking=g,e.fire("notice",{e:n,noticed:g});else return}let a=X(e,n),{layout:s}=$(e,n),l=k(r),m=e.getDistanceMap(i.attacking),p=g=>{let{oob:E,solid:v,wall:et}=e.getContents(g,a);return!E&&!v&&!et},h=g=>p(g)?Math.abs(m.getOrDefault(g,1/0)-i.idealDistance):1/0,S=g=>s.reduce((E,{offset:v})=>E+h(A(g,v)),0)/s.length,b=S(l),P=[];for(let g of Ee){let E=A(l,g);if(!m.has(E))continue;let v=S(E);v<b?(b=v,P=[E]):v===b&&P.push(E)}if(P.length){let g=L(P);n.move(g.x,g.y),n.setLastMovement({angle:rt(l,g)});return}})}),e.on("damage",function({e:i,source:r}){r.owner&&i!==r.owner&&i.ai&&!i.ai.attacking&&r.owner.alive&&(i.ai.attacking=r.owner)})}function De(e){let t=new C(e.entities,["delayedShot"]);e.on("tick",function(){t.forEach(({ai:i,delayedShot:r},n)=>{var a,s;if(!n.alive){n.setDelayedShot();return}for(let l=r.shots.length-1;l>=0;l--){let{turret:m,shot:p}=r.shots[l];if(--p.delay<=0){p.delay=0,r.shots.splice(l,1);let h=T(e,n),S=h.find(g=>g.turret===m),b=(a=S==null?void 0:S.position)!=null?a:I(e,n),P=(s=i==null?void 0:i.attacking)!=null&&s.alive?I(e,i.attacking):y(0,0);Pe(e,p,m,b,P,n,h.map(g=>g.id))}}r.shots.length||n.setDelayedShot()})})}function ve(e){let t=new C(e.entities,["appearance","position"]);e.on("draw",function(){t.forEach(({appearance:i,position:r})=>e.drawIfVisible(Y(r.x),Y(r.y),i.glyph,i.fg,i.bg,i.blendMode))})}function Ce(e){e.on("kill",function({e:o,reason:i}){var a;let{position:r,ship:n}=o;if(r&&(n!=null&&n.power)&&i.type==="damage"){let s=be[n.power],l=((a=i.source.e.projectile)==null?void 0:a.special)==="increasedDropChance",m=n.type==="Battleship"?l?92:42:l?32:2,p=(P=1)=>ft(m*P),h=[];s&R.Double&&p()&&h.push("DoubleItem"),s&R.Drain&&p()&&h.push("DrainItem"),s&R.Healthy&&p()&&h.push("HealItem"),p()&&h.push("MoneyItem"),p()&&h.push("JunkItem"),p()&&h.push("RechargeItem");let S;if(p()){let P=T(e,o).filter(g=>g.tags.has("Special")&&g.prefab&&g.turret);P.length&&(S=L(P).prefab,h.push("BombItem"))}let b=xt([y(-1,-1),y(0,-1),y(1,-1),y(-1,0),y(0,0),y(1,0),y(-1,1),y(0,1),y(1,1)]);for(let P of h){let g=A(r,b.pop()),E=e.spawn(P).move(g.x,g.y).setMotion({angle:d.Down,vel:1});P==="BombItem"&&E.setItem({type:"bomb",prefab:S})}}})}var vo=D(w());var Xt=D(w());function Et(e,t,o){return e*(1-o)+t*o}var tt=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[o])=>t-o)}add(t,o){return this.points.push([t,o]),this.sort(),this}get(t){let[o,i]=this.points[0];if(t<=o)return(0,Xt.fromRgb)(...i);let[r,n]=this.points[this.points.length-1];if(t>=r)return(0,Xt.fromRgb)(...n);let a=this.points.findIndex(([et])=>et>t),[s,[l,m,p,h]]=this.points[a-1],[S,[b,P,g,E]]=this.points[a],v=(t-s)/(S-s);return(0,Xt.fromRgb)(Et(l,b,v),Et(m,P,v),Et(p,g,v),Et(h,E,v))}};var pr={Fire:new tt([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Blue:new tt([[0,[0,0,0,0]],[2,[0,0,255,150]],[4,[0,155,255,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Yellow:new tt([[0,[0,0,0,0]],[2,[155,155,0,150]],[4,[255,255,55,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Green:new tt([[0,[0,0,0,0]],[2,[0,215,0,150]],[4,[55,255,55,150]],[6,[215,255,215,150]],[10,[255,255,255,255]]]),Magenta:new tt([[0,[0,0,0,0]],[2,[155,0,115,150]],[4,[255,115,255,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function Me(e){if(!(e.intensity<=0))return{glyph:" ",layer:x.Effect,bg:pr[e.type].get(e.intensity),blendMode:vo.BlendMode.Add}}function Co(e,t){let o=[],i=Math.floor(e.x-t),r=Math.ceil(e.x+t),n=Math.floor(e.y-t),a=Math.ceil(e.y+t);for(let s=n;s<=a;s++)for(let l=i;l<=r;l++){let m=mt(e,{x:l,y:s});m>=t||o.push({x:l,y:s,intensity:t-m})}return o}function Te(e){e.on("kill",function({e:o,reason:i}){if(i.type==="exitedMap")return;let{explodes:r,name:n,position:a}=o;if(r&&a)for(let{x:s,y:l,intensity:m}of Co(I(e,o),r.size))e.add(new st(e,n+"Explosion").setPosition({x:s,y:l}).setField({type:r.type,intensity:m,falloff:r.falloff}))})}function Tt(e,t,o,i){var s;let r=e.getRoot(t);if(!r.ship)return;r.ship.type!=="Player"&&((s=i.origin)==null?void 0:s.ship.type)!=="Player"&&(o=Math.ceil(o/2));let n=o;r.ship.shield>0&&(r.ship.shield>o?(r.ship.shield-=o,n=0):(n-=r.ship.shield,r.ship.shield=0)),n&&(r.ship.hp-=n);let a={e:i,owner:i};i.origin&&(a.owner=i.origin.owner,a.ship=i.origin.ship,a.turret=i.origin.turret),console.log(`${i.name}${i.origin?` (${i.origin.owner.name} #${i.origin.owner.id})`:""} hits ${r.name} for ${o}`),e.fire("damage",{e:r,amount:o,source:a}),r.ship.hp<=0&&e.kill(r,{type:"damage",source:a})}function Be(e){let t=new C(e.entities,["ship"]),o=new C(e.entities,["field","position"]);e.on("tick",function(){o.forEach(({field:r,position:n},a)=>{r.intensity-=r.falloff,a.setAppearance(Me(r)),r.intensity<1?e.kill(a,{type:"expired"}):t.forEach((s,l)=>{let{layout:m}=$(e,l);m.find(({absolute:h})=>Q(h,n))&&Tt(e,l,Math.floor(r.intensity),a)})})}),e.on("spawn",function({e:r}){r.field&&r.setAppearance(Me(r.field))})}var Mo=D(w());var Bt=class{constructor(t,o){this.g=t;this.player=o;this.lines=o.bombs.map(i=>jt(i).components.turret.name),this.width=this.lines.reduce((i,r)=>Math.max(i,r.length),0),this.height=this.lines.length}draw(t,o){for(let i of this.lines)this.g.term.drawString(t,o++,i,Mo.Colors.WHITE)}};var q=D(w());var Ht=D(w());var ct=class{constructor(t,o,i){this.g=t;this.pilot=o;this.full=i;this.width=11,this.height=i?2+o.class.length:1}get isPlayer(){return this.pilot.player}draw(t,o){if(this.full&&(this.g.term.drawString(t,o,this.pilot.name,this.pilot.star?Ht.Colors.YELLOW:Ht.Colors.LIGHT_GRAY),o++),this.drawStat(t,o,"body"),this.drawStat(t+3,o,"mind"),this.drawStat(t+6,o,"spirit"),this.drawStat(t+9,o,"talent"),!!this.full)for(let i of this.pilot.class)this.g.term.drawString(t,++o,i,Ht.Colors.LIGHT_GREEN)}drawStat(t,o,i){let r=this.pilot[i];this.g.term.drawChar(t,o,i[0].toUpperCase(),Ht.Colors.WHITE),this.g.term.drawChar(t+1,o,r.toString(),$t[r])}};var z=D(w());function He(e,t,o,i,r,n,a,s,l){let m=`${Math.ceil(r)}/${n}`,p=Math.floor(r/n*i);e.drawHLine(t,o,i," ",void 0,s),p&&e.drawHLine(t,o,p," ",void 0,a),e.drawCenteredString(t+i/2,o,m,l)}var ht=class{constructor(t,o){this.g=t;this.ship=o;this.width=Math.max(13,o.name.length),this.height=o.maxShield?3:2}draw(t,o){let{ship:i,width:r}=this,{term:n}=this.g,a=r-3;n.drawString(t,o,i.name,z.Colors.WHITE),n.drawString(t,o+1,"HP:",z.Colors.WHITE),He(n,t+3,o+1,a,i.hp,i.maxHp,z.Colors.DARK_GREEN,z.Colors.DARK_RED,z.Colors.WHITE),i.maxShield&&(n.drawString(t,o+2,"Sh:",z.Colors.WHITE),He(n,t+3,o+2,a,i.shield,i.maxShield,z.Colors.DARK_CYAN,z.Colors.LIGHT_BLUE,z.Colors.WHITE))}};var ut=D(w());var mr={Spent:ut.Colors.DARK_GRAY,Reloading:ut.Colors.LIGHT_RED,Ready:ut.Colors.YELLOW,Chambering:ut.Colors.BROWN},dt=class{constructor(t,o){this.g=t;this.turret=o;this.width=Math.max(o.name.length,this.stateLabel.length),this.height=2,o.ammunition>0&&o.ammunition<1/0&&this.height++}get stateLabel(){let{timer:t,salvo:o,salvoCount:i}=this.turret,r=xe(this.turret);if(r==="Spent")return"Out of Ammo";if(r==="Reloading")return`Reloading (${t})`;let n=`${o}/${i}`;return r==="Ready"?n:`${n} (${t})`}draw(t,o){this.g.term.drawString(t,o,this.turret.name,ut.Colors.WHITE);let i=xe(this.turret);this.g.term.drawString(t,o+1,this.stateLabel,mr[i]),this.height>2&&this.g.term.drawString(t,o+2,`${this.turret.ammunition} ammo left`,ut.Colors.LIGHT_GRAY)}};var at=6;function Ae(e){let{mapHeight:t,term:o}=e;e.on("draw",function(){let r=e.player,{pilot:n,player:a,ship:s}=r;o.fillRect(0,t,o.width,at," ",q.Colors.WHITE,q.Colors.BLACK),o.drawSingleBox(0,t,o.width,at);let l=1,m=t+1,p=new ht(e,s);p.draw(l,m);let h=l+Math.floor((p.width-11)/2);new ct(e,n,!1).draw(h,m+3),l+=p.width+1,o.drawChar(l-1,m-1,f.BoxDownSingleHorizontalSingle,q.Colors.WHITE),o.drawVLine(l-1,m,at-2,f.BoxVerticalSingle,q.Colors.WHITE),o.drawChar(l-1,m+at-2,f.BoxUpSingleHorizontalSingle,q.Colors.WHITE);for(let b of a.weaponArrays){let P=l,g=T(e,r).filter(E=>E.turret&&E.tags.has(b));for(let E of g){let v=new dt(e,E.turret);v.draw(l,m+1),l+=v.width+1}o.drawString(P,m,b,q.Colors.LIGHT_CYAN),l=Math.max(l,P+b.length+1)}a.bombs.length&&(o.drawChar(l-1,m-1,f.BoxDownSingleHorizontalSingle,q.Colors.WHITE),o.drawVLine(l-1,m,at-2,f.BoxVerticalSingle,q.Colors.WHITE),o.drawChar(l-1,m+at-2,f.BoxUpSingleHorizontalSingle,q.Colors.WHITE),new Bt(e,a).draw(l,m))})}function Re(e){let t=new C(e.entities,["homing","motion","position"]);e.on("tick",function(){t.forEach(({homing:i,motion:r,position:n},a)=>{var p;if(!((p=i.target)!=null&&p.alive))return;let s=I(e,i.target),l=rt(n,s),m=po(r.angle,l);Math.abs(m)<=i.strength?r.angle=l:m<0?r.angle-=i.strength:r.angle+=i.strength,--i.duration<=0&&(a.setHoming(),a.setTrail())})})}function Le(e){let t=new C(e.entities,["lifetime"]);e.on("tick",function(){t.forEach(({lifetime:i},r)=>{if(--i.duration<=0)e.kill(r,{type:"expired"});else if(i.decayingAppearance&&r.appearance){let n=i.decayingAppearance[i.duration-1];Object.assign(r.appearance,n)}})})}var fr=["Cleave","Outcry","AcidSplash","ShuttleLaunch","Veto","TalonSwipe","CrushPattern","Smite","Salvo","TheDragonWakes","Bellow","DemandHomage","Multiball","StubbornDescent"];function Ie(e,t,o){if(!(!t.ship||!t.player))switch(o.type){case"double":t.doubleShot?t.doubleShot.duration+=9:t.setDoubleShot({duration:9});return;case"heal":{let i=Math.ceil(t.ship.maxHp/4);t.ship.hp=Math.min(t.ship.maxHp,t.ship.hp+i);return}case"recharge":{for(let i of T(e,t))if(i.turret)for(;i.turret.timer<1/0&&i.turret.timer>0;)qt(i.turret);return}case"bomb":for(t.player.bombs.push(o.prefab);t.player.bombs.length>co(t);)t.player.bombs.shift();break;case"junk":if(ft(ho(t)))return Ie(e,t,{type:"bomb",prefab:L(fr)});break}}function Zt(e,t){let o=t.x-e.x,i=t.y-e.y,r=Math.abs(o),n=Math.abs(i),a=o>0?1:-1,s=i>0?1:-1,l=G({},e),m=[G({},l)];for(let p=0,h=0;p<r||h<n;)(.5+p)/r<(.5+h)/n?(l.x+=a,p++):(l.y+=s,h++),m.push(G({},l));return m}function ke(e){let t=new C(e.entities,["motion","position"]);e.on("tick",function(){t.forEach(({motion:i,position:r,projectile:n,ignoreSolid:a,item:s},l)=>{let[m,p]=nt(i),h=y(r.x+m,r.y+p),S=Zt(k(r),k(h)),b=!1,P;for(let g of S){if(!e.inBounds(g)){e.kill(l,{type:"exitedMap"});return}e.move(l,g);let{wall:E,solid:v}=e.getContents(g,a==null?void 0:a.ids);if(E){b=!0;break}else if(v){P=v;break}}b?e.kill(l,{type:"hitWall"}):P?(n&&Tt(e,P,n.damage,l),s&&Ie(e,e.getRoot(P),s),e.kill(l,{type:"hitEntity",other:P})):e.move(l,h)})})}function Ge(e){e.on("playerMove",function({move:o}){let i=e.player,r=i.position,n=A(r,o);so(e,i,n).length||(i.move(n.x,n.y),i.setLastMovement({angle:rt(r,n)}),e.tick())}),e.on("playerFire",function({array:o}){let i=e.player,r=i.player.weaponArrays[o],n=T(e,i),a=n.filter(l=>l.tags.has(r)),s=!1;for(let l of a)!l.position||!l.turret||Qt(l.turret,i)&&(Pt(e,l.turret,l.position,y(0,0),i,n.map(m=>m.id)),s=!0);s&&(i.setLastMovement(),e.tick())}),e.on("playerBomb",function(){var n;let o=e.player,i=o.player.bombs.shift();if(!i)return;let r=jt(i);if((n=r.components)!=null&&n.turret){let a=j(r.components.turret),s=I(e,o),l=Jt(e,o),m=l?I(e,l):y(0,0),p=Pt(e,a,s,m,o,X(e,o));for(let h of p){if(h.ai){h.ai.attacking=l;for(let S of T(e,h).filter(b=>b.turret))for(let b of S.turret.shots)b.type==="bullet"&&typeof b.angle=="number"&&(b.angle+=Math.PI)}h.homing&&(h.homing.target=l)}o.setLastMovement(),e.tick()}})}var To=D(w());function At(e){return typeof e!="undefined"}function Fe(e){let t=new C(e.entities,["ship"]);e.on("tick",function(){t.forEach((i,r)=>{r.doubleShot&&--r.doubleShot.duration<=0&&r.setDoubleShot()})}),e.on("draw",function(){let i=T(e,e.player).map(r=>r.position).filter(At);if(e.player.doubleShot)for(let r of i)e.blend(r.x,r.y,To.Colors.LIGHT_GRAY)})}function Ke(e){let t=new C(e.entities,["ship"]);e.on("tick",function(){t.forEach(({ship:i},r)=>{if(i.shield>=i.maxShield){i.shieldTimer=0;return}let n=fo(r);++i.shieldTimer>=n&&(i.shield++,i.shieldTimer=0)})})}function We(e){e.on("waveBegin",function({wave:i,difficulty:r,pilot:n}){let a=(r+i.difficulty)*3,s=[];for(let p of i.groups)for(let h=0;h<p.count;h++)s.push(L(p.prefabs));let l=i.groups.filter(p=>p.type==="Escort");for(let p=0;p<r;p++){let h=L(l);s.push(L(h.prefabs))}let m=Math.floor(Math.random()*s.length);for(let p=0;p<s.length;p++){let h=p===m&&n!==void 0,S=s[p],b=bo(a,h),P=xo(e,S,b,h?n:void 0),g=Po(e,P);P.move(g.x,g.y)}});let t=1/0;e.on("kill",({e:o})=>{if(!o.ship)return;e.entities.get().filter(r=>r.alive&&r.ship&&r.ship.type!=="Player").length||(t=5)}),e.on("tick",()=>{--t<=0&&(t=1/0,e.fire("waveNext",void 0))})}function Oe(e){e.on("move",function({e:o,old:i,pos:r}){o.trail&&!Q(i,r)&&e.spawn(o.trail.effectPrefab).setPosition(i)})}function Ne(e){let t=new C(e.entities,["position","turret"]);e.on("tick",function(){t.forEach(({position:i,turret:r},n)=>{var m;qt(r);let a=e.getRoot(n);if(!a.ai)return;let s=a.ai.attacking;if(!(s!=null&&s.alive))return;let l=I(e,s);if(!(mt(i,l)>((m=a.ai.firingDistance)!=null?m:1/0))&&Qt(r,a))for(let p of Pt(e,r,i,l,a,X(e,a)))p.homing&&(p.homing.target=s),p.ai&&(p.ai.attacking=s)})})}function Bo(e){Le(e),Re(e),De(e),Ne(e),Be(e),Ke(e),ke(e),we(e),We(e),ve(e),Ae(e),Oe(e),Te(e),Ce(e),Fe(e),Ge(e)}var St=D(w());var Ho=D(w()),V=class{constructor(t){this.g=t;this.width=0,this.height=0,this.instructions=[]}add(t){this.instructions.push(t),this.updateBounds()}addLine(t,o=Ho.Colors.WHITE,i){this.add({x:0,y:this.instructions.length,line:t,fg:o,bg:i})}updateBounds(){this.width=this.instructions.reduce((t,o)=>Math.max(o.line.length+o.x,t),0),this.height=1+this.instructions.reduce((t,o)=>Math.max(o.y,t),0)}draw(t,o){for(let{x:i,y:r,line:n,fg:a,bg:s}of this.instructions)this.g.term.drawString(t+i,o+r,n,a,s)}};var Ao=Math.PI/4,cr=[f.RightArrow,f.DownArrow+f.RightArrow,f.DownArrow,f.DownArrow+f.LeftArrow,f.LeftArrow,f.UpArrow+f.LeftArrow,f.UpArrow,f.UpArrow+f.RightArrow];function hr(e){let t=Math.floor(mo(e)/Ao+Ao/2);return cr[t]}var Rt=class extends V{constructor(o,i){var r,n;super(o);this.e=i;i.name&&!i.ship&&this.addLine(i.name),i.projectile&&this.addLine(`${i.projectile.damage} damage`,St.Colors.LIGHT_RED),i.motion&&this.addLine(`${hr(i.motion.angle)}, vel ${i.motion.vel}`,St.Colors.LIGHT_GRAY),i.homing&&this.addLine(`chasing ${i.homing.target===this.g.player?"you":(n=(r=i.homing.target)==null?void 0:r.ship)==null?void 0:n.name} ${i.homing.duration<1/0?`(${i.homing.duration})`:""}`,St.Colors.DARK_RED),i.lifetime&&this.addLine(`(lasts ${i.lifetime.duration})`,St.Colors.DARK_GRAY),i.explodes&&this.addLine(`explosion ${i.explodes.size}`,St.Colors.ORANGE)}};var Ve=D(w());var _e=D(w());var Lt=class extends V{constructor(o,i){super(o);this.field=i;this.addLine("Explosion"),this.add({x:0,y:1,fg:_e.Colors.LIGHT_GRAY,line:"intensity"}),this.add({x:10,y:1,fg:_e.Colors.YELLOW,line:Math.floor(i.intensity).toString()})}};var Ue=D(w());var It=class extends V{constructor(o,i){super(o);this.item=i;switch(i.type){case"bomb":this.addLine("Smart Bomb");break;case"double":this.addLine("Double",Z.Double.fg,Z.Double.bg);break;case"drain":this.addLine("Drain",Z.Drain.fg,Z.Drain.bg);break;case"heal":this.addLine("Heal",Z.Healthy.fg,Z.Healthy.bg);break;case"junk":this.addLine("Junk",Ue.Colors.DARK_GRAY);break;case"money":this.addLine(`${f.SetMember}${i.value}`,Ue.Colors.YELLOW);break;case"recharge":this.addLine("Recharge");break}}};var Ro=D(w());var kt=class extends V{constructor(o,i){super(o);this.e=i;i.doubleShot&&this.addLine(i.doubleShot.duration===1/0?"2x Shot":`2x Shot (${i.doubleShot.duration})`,Ro.Colors.LIGHT_GRAY)}};function Lo(e,t,o){if(!o.length)return;let i=[],r=1,n=1,a=p=>{i.push({x:r,y:n,object:p}),n+=p.height+1};for(let p of o){p.ship&&a(new ht(e,p.ship)),p.pilot&&a(new ct(e,p.pilot,!0)),p.doubleShot&&a(new kt(e,p));let h=T(e,p);for(let S of h.filter(b=>b.turret))a(new dt(e,S.turret));p.item?a(new It(e,p.item)):(p.motion||p.projectile||p.homing||p.lifetime||p.explodes)&&a(new Rt(e,p)),p.field&&a(new Lt(e,p.field))}if(!i.length)return;let s=Math.max(...i.map(p=>p.object.width))+2,l=Math.min(t.x+2,e.term.width-s),m=Math.min(t.y,e.term.height-n);e.term.fillRect(l,m,s,n," ",Ve.Colors.WHITE,Ve.Colors.BLACK),e.term.drawSingleBox(l,m,s,n);for(let p of i)p.object.draw(l+p.x,m+p.y)}var Gt=class{constructor(t,o){this.g=t;this.campaign=o;this.dirty=!0,this.examining=[]}refresh(){this.dirty=!0}init(){let{g:t}=this;this.examineAt=void 0,this.examining=[],this.waves=go(),t.blankMap(),t.entities.clearExceptFor(X(t,t.player));let{width:o,height:i}=$(t,t.player);t.player.move(Y(t.mapWidth/2-o/2),t.mapHeight-i-4),Bo(t),this.nextWave(),t.on("waveNext",this.nextWave.bind(this))}nextWave(){let t=this.waves.shift();if(t){let o=this.waves.length===0?this.campaign.currentSector.star:void 0;this.g.fire("waveBegin",{wave:t,difficulty:this.campaign.difficulty,pilot:o});return}this.g.player.alive&&(this.campaign.currentSector.completed=!0)}draw(){let{map:t,mapWidth:o,mapHeight:i,overlays:r,term:n}=this.g;for(let a=0;a<i;a++)for(let s=0;s<o;s++){let l=t.grid[a][s];n.drawChar(s,a,0,l.fg,l.bg)}if(this.g.fire("draw",void 0),this.dirty=!1,this.showOverlay){let a=r.get(this.showOverlay);if(a)for(let s=0;s<i;s++)for(let l=0;l<o;l++){let m=a.get({x:l,y:s})||1/0,p=m===1/0?"-":m<10?`${m}`:"*";n.drawChar(l,s,p,_.Colors.LIGHT_RED)}}if(this.examineAt){Lo(this.g,this.examineAt,this.examining);for(let a of this.examining){let{motion:s,position:l}=a;if(s&&l){let[m,p]=nt(s),h=y(l.x+m,l.y+p),S=Zt(k(l),k(h));for(let b of S)this.g.blend(b.x,b.y,_.Colors.DARK_RED)}}}this.campaign.currentSector.completed&&(n.drawCenteredString(n.width/2,5,"SECTOR COMPLETE",_.Colors.WHITE,_.Colors.BLACK),n.drawCenteredString(n.width/2,7,"Hit Enter to continue",_.Colors.WHITE,_.Colors.BLACK))}update(){(this.g.term.mouse.dx||this.g.term.mouse.dy)&&this.refresh(),this.handleKeys(),this.dirty&&(this.handleMouseMove(),this.draw())}examine(t){this.examineAt=t,this.dirty=!0;let{solid:o,other:i}=this.g.getContents(t),r=new Set;o&&r.add(this.g.getRoot(o));for(let n of i)r.add(this.g.getRoot(n));this.examining=[...r]}handleMouseMove(){let{x:t,y:o}=this.g.term.mouse;this.examine({x:t,y:o})}handleKeys(){let{term:t}=this.g;if(this.campaign.currentSector.completed&&(t.isKeyPressed(_.Key.VK_ENTER)||t.isKeyPressed(_.Key.VK_NUMPAD_ENTER))){this.campaign.endCombat();return}let o=t.getMovementKey();if(o){this.g.fire("playerMove",{move:o});return}if(t.isKeyPressed(_.Key.VK_1)){this.g.fire("playerFire",{array:0});return}if(t.isKeyPressed(_.Key.VK_2)){this.g.fire("playerFire",{array:1});return}if(t.isKeyPressed(_.Key.VK_SPACE)){this.g.fire("playerBomb",void 0);return}}};var Ft=class{constructor(t,o,i){this.width=t;this.height=o;this.grid=[];for(let r=0;r<o;r++){let n=[];for(let a=0;a<t;a++)n.push(i(a,r));this.grid.push(n)}}contains({x:t,y:o}){return t>=0&&t<this.width&&o>=0&&o<this.height}get({x:t,y:o}){return this.grid[o][t]}getPositions(){let t=[];for(let o=0;o<this.height;o++)for(let i=0;i<this.width;i++)t.push({x:i,y:o});return t}};var ur={name:"Bodini",star:!0,body:4,mind:2,spirit:3,talent:2,class:[],special:"Multiball"},dr={name:"Splintertooth",star:!0,body:3,mind:3,spirit:3,talent:2,class:[],special:"StubbornDescent"},yr={name:"Gruff",star:!0,body:2,mind:3,spirit:4,talent:2,class:[],special:"LaserBeam"},gr={name:"Star Pilot D",star:!0,body:2,mind:2,spirit:2,talent:2,class:[]},br={name:"Star Pilot E",star:!0,body:2,mind:2,spirit:2,talent:2,class:[]},xr={name:"Star Pilot F",star:!0,body:2,mind:2,spirit:2,talent:2,class:[]},Pr=[ur,dr,yr,gr,br,xr],Io=Pr;var Kt=class{constructor(t,o,i){this.g=t;this.shipPrefab=o;this.pilot=i;this.dirty=!0}get currentSector(){return this.space.get(this.position)}refresh(){this.dirty=!0}init(){let{g:t}=this;t.clearEventHandlers(),t.entities.clear(),t.player=this.makePlayer(),this.difficulty=0,this.position=y(2,2),this.space=new Ft(5,5,()=>({completed:!1}));let o=new Set,i=this.space.getPositions().filter(r=>!Q(this.position,r));for(;o.size<6;){let r=L(Io);if(!o.has(r)){o.add(r);let n=L(i),a=this.space.get(n);a.star=r;let s=i.indexOf(n);i.splice(s,1)}}}startCombat(){this.g.setMode(new Gt(this.g,this))}endCombat(){this.g.clearEventHandlers(),this.currentSector.completed=!0,this.difficulty++,this.g.mode=this,this.refresh()}makePlayer(){let{g:t,shipPrefab:o,pilot:i}=this,r=t.spawn(o);if(!r.ship)throw new Error(`Ship prefab ${o} doesn't have a ship component!`);return Yt(t,r,i),Mt(r.ship),r}draw(){let{term:t}=this.g;t.fillRect(0,0,t.width,t.height," ",N.Colors.WHITE,N.Colors.BLACK);let o=this.space.get(this.position),i=t.width/2;t.drawCenteredString(i,2,"Known Space",N.Colors.WHITE),o.completed||(t.drawCenteredString(i,4,"Hit Enter to fight!",N.Colors.WHITE),o.star&&t.drawCenteredString(i,34,`You will face: ${o.star.name}!`,N.Colors.YELLOW));let r=(t.width-25)/2,n=(t.height-25)/2;for(let a=0;a<5;a++){let s=n+a*5;for(let l=0;l<5;l++){let m=r+l*5,p={x:l,y:a},h=this.space.get(p);t.fillRect(m,s,5,5," ",void 0,h.completed?N.Colors.BLACK:N.Colors.DARK_RED),t.drawSingleBox(m,s,5,5,N.Colors.WHITE),Q(p,this.position)?t.drawChar(m+2,s+2,"@",N.Colors.LIGHT_CYAN):h.star&&t.drawChar(m+2,s+2,"*",N.Colors.YELLOW)}}this.dirty=!1}handleKeys(){let t=this.space.get(this.position);!t.completed&&(this.g.term.isKeyPressed(N.Key.VK_ENTER)||this.g.term.isKeyPressed(N.Key.VK_NUMPAD_ENTER))&&this.startCombat();let o=this.g.term.getMovementKey();if(t.completed&&o){let i=A(this.position,o);this.space.contains(i)&&(this.position=i,this.dirty=!0)}}update(){this.handleKeys(),this.dirty&&this.draw()}};var Wt=class{constructor(t,o=5,i=100){this.g=t;this.starfieldSpeed=o;this.starCount=i}refresh(){this.dirty=!0}init(){this.dirty=!0,this.pilot={name:"Player",player:!0,body:1,mind:1,spirit:1,talent:1,class:[]},this.points=6,this.starfieldCounter=0,this.stars=[];for(let t=0;t<this.starCount;t++)this.stars.push(this.newStar())}draw(){let{term:t}=this.g;t.clear();for(let a of this.stars){let{x:s,y:l}=k(a);t.drawChar(s,l,a.c,a.fg)}let o=t.width/2;t.drawCenteredString(o,2,"Bullet Hell Roguelike",M.Colors.WHITE),t.drawCenteredString(o,9,"Create your Pilot",M.Colors.WHITE),t.drawCenteredString(o,10,`${this.points} points`,M.Colors.YELLOW);let i=2,r=Math.floor((t.width-i*2)/4),n=i+r/2;this.drawStat("body",n),this.drawStat("mind",n+r),this.drawStat("spirit",n+r*2),this.drawStat("talent",n+r*3),this.points===0&&t.drawCenteredString(o,20,"Hit Enter to begin!",M.Colors.WHITE),this.dirty=!1}drawStat(t,o){let{term:i}=this.g,r=`(${t[0].toUpperCase()})${t.slice(1)}`,n=this.pilot[t];i.drawCenteredString(o,13,r,M.Colors.LIGHT_CYAN),i.drawCenteredString(o,14,n.toString(),$t[n])}update(){this.handleStarfield(),this.handleKeys(),this.dirty&&this.draw()}newStar(){let{term:t}=this.g,o=L([M.Colors.DARK_RED,M.Colors.LIGHT_RED,M.Colors.YELLOW,M.Colors.LIGHT_CYAN,M.Colors.WHITE]),i=.5+Math.random(),r=i<.75?".":i<1.25?f.Dot:"*",n=Math.random()*Math.PI*2;return{x:t.width/2,y:t.height/2,c:r,fg:o,vel:i,angle:n}}handleStarfield(){if(this.starfieldCounter<this.starfieldSpeed){this.starfieldCounter++;return}this.starfieldCounter=0,this.dirty=!0;let{width:t,height:o}=this.g.term;for(let i of this.stars){let[r,n]=nt(i);i.x+=r,i.y+=n,(i.x<0||i.x>=t||i.y<0||i.y>=o)&&Object.assign(i,this.newStar())}}isPressed(t,o){let i=this.g.term.isKeyDown(M.Key.VK_SHIFT_LEFT)||this.g.term.isKeyDown(M.Key.VK_SHIFT_RIGHT);return this.g.term.isKeyPressed(t)&&o===i}changeStat(t,o){let i=this.pilot[t]+o;if(i<1||i>4)return!1;this.points-=o,this.pilot[t]=i,this.dirty=!0}handleKeys(){this.points>0&&(this.isPressed(M.Key.VK_B,!1)&&this.changeStat("body",1),this.isPressed(M.Key.VK_M,!1)&&this.changeStat("mind",1),this.isPressed(M.Key.VK_S,!1)&&this.changeStat("spirit",1),this.isPressed(M.Key.VK_T,!1)&&this.changeStat("talent",1)),this.isPressed(M.Key.VK_B,!0)&&this.changeStat("body",-1),this.isPressed(M.Key.VK_M,!0)&&this.changeStat("mind",-1),this.isPressed(M.Key.VK_S,!0)&&this.changeStat("spirit",-1),this.isPressed(M.Key.VK_T,!0)&&this.changeStat("talent",-1),this.points===0&&(this.g.term.isKeyPressed(M.Key.VK_ENTER)||this.g.term.isKeyPressed(M.Key.VK_NUMPAD_ENTER))&&this.g.setMode(new Kt(this.g,"PlayerShip",this.pilot))}};var Ot=class{constructor(t){this.keyFn=t;this.items=new Map}has(t){return this.items.has(this.keyFn(t))}get(t){return this.items.get(this.keyFn(t))}getOrDefault(t,o){let i=this.items.get(this.keyFn(t));return typeof i!="undefined"?i:o}getOrDie(t){let o=this.keyFn(t),i=this.items.get(o);if(typeof i=="undefined")throw new Error(`Invalid key: ${o}`);return i}set(t,o){this.items.set(this.keyFn(t),o)}};function je(e,t,o=1/0){let i=[],r=new Ot(n=>`${n.x},${n.y}`);for(let n of e)i.push(n),r.set(n,0);for(;i.length;){let n=i.shift(),a=r.getOrDie(n)+1;if(!(a>o))for(let s of Se(n))!r.has(s)&&t(s)&&(r.set(s,a),i.push(s))}return r}var Nt=class{constructor(t,o,i){this.term=t;this.mapWidth=o;this.mapHeight=i;t.update=this.update.bind(this),this.map=new te.Console(o,i,()=>!0),this.lastEntityId=0,this.entities=new Ct(eo),this.overlays=new Map,this.clearEventHandlers(),this.setMode(new Wt(this))}setMode(t){this.mode=t,this.mode.init()}clearEventHandlers(){this.eventCallbacks=to(oo.map(t=>[t,[]]))}fire(t,o){for(let i of this.eventCallbacks[t])i(o)}on(t,o){this.eventCallbacks[t].push(o)}spawn(t){return he(this,t)}refresh(){this.mode.refresh()}add(t){return this.refresh(),this.entities.add(t),this.fire("spawn",{e:t}),t}kill(t,o){t.alive&&(t.kill(o),this.fire("kill",{e:t,reason:o}))}move(t,o){let i=t.position;t.move(o.x,o.y),i&&this.fire("move",{e:t,old:i,pos:o})}blankMap(){let{map:t,mapHeight:o,mapWidth:i}=this;t.clear();for(let r=0;r<o;r++)for(let n=0;n<i;n++)t.setBlocked(n,r,!1),t.setBlockedSight(n,r,!1);t.computeFov(0,0,1/0)}drawIfVisible(t,o,i,r,n,a){this.map.isVisible(t,o)&&(a?this.term.drawCell(t,o,{bg:n},a):this.term.drawChar(t,o,i,r,n))}blend(t,o,i){this.term.drawCell(t,o,{bg:i},te.BlendMode.Add)}getRoot(t){return t.attachment?this.getRoot(t.attachment.parent):t}getContents(t,o=[]){let i=k(t);if(!this.inBounds(i))return{oob:!0,other:[]};let r=this.map.isBlocked(i.x,i.y),n=this.entities.get().filter(s=>s.position&&Q(i,s.position)),a=n.filter(s=>!o.includes(s.id)).find(s=>s.solid);return{wall:r,solid:a,other:n.filter(s=>!s.solid)}}tick(){this.overlays.clear(),this.fire("tick",void 0),this.entities.clearDead()}update(){this.mode.update()}inBounds(t){return t.x>=0&&t.y>=0&&t.x<this.mapWidth&&t.y<this.mapHeight}getDistanceMap(t){let o=`${t.id}.distance`,i=this.overlays.get(o);return i||(i=je(T(this,t).map(r=>r.position).filter(At),this.inBounds.bind(this)),this.overlays.set(o,i)),i}};function Er(e){let i=ee.DEFAULT_FONT,r=document.createElement("div");e.appendChild(r);let n=()=>{let m=60*i.charWidth,p=40*i.charHeight,h=Math.floor(window.innerWidth/m),S=Math.floor(window.innerHeight/p),b=Math.min(h,S);r.style.width=`${m*b}px`,r.style.height=`${p*b}px`};window.addEventListener("resize",n),n();let a=document.createElement("canvas");r.appendChild(a),requestAnimationFrame(()=>a.focus());let s=new ee.Terminal(a,60,40,{font:i}),l=new Nt(s,60,40-at);window.g=l}window.addEventListener("load",()=>Er(document.body));})();
//# sourceMappingURL=bundle.js.map
