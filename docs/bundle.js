"use strict";(()=>{var et=Object.create;var A=Object.defineProperty;var it=Object.getOwnPropertyDescriptor;var ot=Object.getOwnPropertyNames,V=Object.getOwnPropertySymbols,nt=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty,rt=Object.prototype.propertyIsEnumerable;var F=(e,t,i)=>t in e?A(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,c=(e,t)=>{for(var i in t||={})O.call(t,i)&&F(e,i,t[i]);if(V)for(var i of V(t))rt.call(t,i)&&F(e,i,t[i]);return e};var st=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),w=(e,t)=>{for(var i in t)A(e,i,{get:t[i],enumerable:!0})},lt=(e,t,i,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of ot(t))!O.call(e,n)&&n!==i&&A(e,n,{get:()=>t[n],enumerable:!(o=it(t,n))||o.enumerable});return e};var b=(e,t,i)=>(i=e!=null?et(nt(e)):{},lt(t||!e||!e.__esModule?A(i,"default",{value:e,enumerable:!0}):i,e));var y=st((wt,z)=>{z.exports=globalThis.wglt});var g=b(y());var h=class{constructor(t,i){this.g=t;this.name=i;this.alive=!0,this.id=++t.lastEntityId,this.player=!1,this.projectile=!1,this.solid=!1,t.add(this)}get[Symbol.toStringTag](){return this.name}kill(){return this.alive=!1,this.eachChild(t=>t.kill()),this}eachChild(t){var i;for(let o of this.g.entities.get())((i=o.attachment)==null?void 0:i.parent)===this&&t(o,o.attachment)}setAppearance(t){return this.g.dirty=!0,this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setPosition(t){return this.g.dirty=!0,this.position=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,i){return this.g.dirty=!0,this.position={x:t,y:i},this.eachChild((o,n)=>o.move(t+n.x,i+n.y)),this.position}};function $(e,t){var n,r,s,l;let i=(r=(n=e.appearance)==null?void 0:n.layer)!=null?r:0,o=(l=(s=t.appearance)==null?void 0:s.layer)!=null?l:0;return i!==o?i-o:e.id-t.id}var T={};w(T,{Battleship:()=>at,BattleshipHull:()=>mt});var H=b(y());var X=(r=>(r[r.Effect=0]="Effect",r[r.Ship=1]="Ship",r[r.Gun=2]="Gun",r[r.Bullet=3]="Bullet",r[r.Player=4]="Player",r))(X||{}),u=X;function at(e){let t=new h(e,"Battleship");return e.spawn("BattleshipHull").setAttachment({parent:t,x:1,y:0}),e.spawn("BattleshipHull").setAttachment({parent:t,x:2,y:0}),e.spawn("BattleshipHull").setAttachment({parent:t,x:0,y:1}),e.spawn("BattleshipHull").setAttachment({parent:t,x:1,y:1}),e.spawn("BattleshipHull").setAttachment({parent:t,x:2,y:1}),e.spawn("MachineGun").setAttachment({parent:t,x:0,y:1}),e.spawn("HomingMissileLauncher").setAttachment({parent:t,x:2,y:1}),t}function mt(e){return new h(e,"BattleshipHull").setAppearance({glyph:"/",layer:u.Ship,fg:H.Colors.WHITE,bg:H.Colors.BROWN}).setSolid(!0)}var k={};w(k,{Bullet:()=>ht,HomingMissile:()=>ft});var B=b(y());function ht(e){return new h(e,"Bullet").setProjectile(!0).setAppearance({glyph:".",layer:u.Bullet,fg:B.Colors.YELLOW})}function ft(e){return new h(e,"HomingMissile").setProjectile(!0).setHoming({strength:.15,duration:10}).setTrail({effectPrefab:"SmokePuff"}).setAppearance({glyph:"*",layer:u.Bullet,fg:B.Colors.DARK_RED})}var S={};w(S,{SmokePuff:()=>pt});var q=b(y());function pt(e){return new h(e,"SmokePuff").setAppearance({glyph:" ",layer:u.Effect,bg:q.Colors.LIGHT_GRAY}).setLifetime({duration:2})}var R={};w(R,{HomingMissileLauncher:()=>ut,MachineGun:()=>ct});var C=b(y());function ct(e){return new h(e,"MachineGun").setAppearance({glyph:"o",layer:u.Gun,fg:C.Colors.WHITE}).setTurret({bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:5,timeBetweenShots:0,timeBetweenSalvos:12})}function ut(e){return new h(e,"HomingMissileLauncher").setAppearance({glyph:"o",layer:u.Gun,fg:C.Colors.YELLOW}).setTurret({bulletPrefab:"HomingMissile",bulletVelocity:1,salvoCount:1,timeBetweenShots:8,timeBetweenSalvos:8})}var L={};w(L,{Player:()=>dt});var I=b(y());function dt(e){return new h(e,"Player").setPlayer(!0).setSolid(!0).setAppearance({glyph:">",layer:u.Player,fg:I.Colors.WHITE,bg:I.Colors.DARK_RED})}var yt=c(c(c(c(c({},T),k),S),R),L);function D(e,t){return yt[t](e)}function d(e){return typeof e=="undefined"?NaN:Math.floor(e)}function G(e){return{x:d(e.x),y:d(e.y)}}var x=class{constructor(t,i=[]){this.compareFn=t;this.items=i;this.dirty=!0}clear(){this.items=[],this.dirty=!1}add(t){this.items.push(t),this.dirty=!0}delete(t){this.items=this.items.filter(i=>i!==t)}sort(){this.items.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.items.slice()}};var J=Math.PI*2;function W(e,t){let i=(e-t)%J,o=(t-e)%J;return i<o?-i:o}function K(e){let t=Math.cos(e.angle)*e.vel,i=Math.sin(e.angle)*e.vel;return[t,i]}function N(e){switch(e.mode){case"fire":e.timer--,e.salvo>0?e.timer<=0&&(e.mode="mid-salvo"):e.mode="reloading";break;case"mid-salvo":e.mode="fire",e.salvo--,e.salvo>0?e.timer=e.timeBetweenShots:e.timer=e.timeBetweenSalvos;break;case"reloading":e.timer--,e.timer<=0&&(e.mode="idle");break;case"idle":default:e.mode="fire",e.salvo=e.salvoCount-1,e.timer=e.timeBetweenShots;break}return e}function _(e,t){let i=t.x-e.x,o=t.y-e.y,n=Math.abs(i),r=Math.abs(o),s=i>0?1:-1,l=o>0?1:-1,a=c({},e),f=[c({},a)];for(let m=0,p=0;m<n||p<r;)(.5+m)/n<(.5+p)/r?(a.x+=s,m++):(a.y+=l,p++),f.push(c({},a));return f}var Q=60,U=40,E=class{constructor(t){this.term=t;t.update=this.update.bind(this),this.dirty=!0,this.fovRecompute=!0,this.map=new g.Console(Q,U,()=>!0),this.lastEntityId=0,this.entities=new x($)}get player(){let t=this.entities.get().find(i=>i.player);if(!t)throw new Error("Could not find a player!");return t}spawn(t){return D(this,t)}add(t){this.dirty=!0,this.entities.add(t)}addMany(t){this.dirty=!0;for(let i of t)this.add(i)}gotoDemoRoom(){this.entities.clear(),this.map.clear(),this.room(1,1,40,30),this.spawn("Player").move(5,25),this.spawn("Battleship").move(8,5)}room(t,i,o,n){let{map:r}=this;for(let s=0;s<n;s++)for(let l=0;l<o;l++){let a=l===0||s===0||l===o-1||s===n-1,f=t+l,m=i+s;r.setBlocked(f,m,a),r.setBlockedSight(f,m,a)}}draw(){let{map:t,player:i,term:o,entities:n}=this;this.fovRecompute&&(t.computeFov(i.position.x,i.position.y,20),this.fovRecompute=!1);for(let s=0;s<U;s++)for(let l=0;l<Q;l++){let a=t.grid[s][l],f=t.isVisible(l,s),m=a.blockedSight,p=g.Colors.BLACK;f?(p=m?g.Colors.WHITE:g.Colors.DARK_GRAY,a.explored=!0):a.explored&&(p=m?g.Colors.LIGHT_GRAY:g.Colors.BLACK),o.drawChar(l,s,0,0,p)}let r=(s,l,a,f,m)=>{t.isVisible(s,l)&&o.drawChar(s,l,a,f,m)};for(let s of n.get()){let{appearance:l,position:a}=s;l&&a&&r(d(a.x),d(a.y),l.glyph,l.fg,l.bg)}this.dirty=!1}getRootID(t){return t.attachment?this.getRootID(t.attachment.parent):t.id}getContents(t){let i={x:d(t.x),y:d(t.y)},o=this.map.isBlocked(i.x,i.y),n=this.entities.get().filter(s=>{var l,a;return d((l=s.position)==null?void 0:l.x)===i.x&&d((a=s.position)==null?void 0:a.y)==i.y}),r=n.find(s=>s.solid);return{wall:o,solid:r,other:n.filter(s=>!s.solid)}}lifetimes(){for(let t of this.entities.get()){let{lifetime:i}=t;i&&--i.duration<=0&&t.kill()}}homing(){let t=this.player.position;for(let i of this.entities.get()){let{homing:o,motion:n,position:r}=i;if(o&&n&&r){let s=Math.atan2(t.y-r.y,t.x-r.x),l=W(n.angle,s);Math.abs(l)<=o.strength?n.angle=s:l<0?n.angle-=o.strength:n.angle+=o.strength,--o.duration<=0&&(i.setHoming(),i.setTrail())}}}turrets(){let{entities:t}=this,i=this.player.position;for(let o of t.get()){let{position:n,turret:r}=o;n&&r&&(N(r),r.mode==="fire"&&this.spawn(r.bulletPrefab).setIgnoreSolid({ids:[this.getRootID(o)]}).setPosition({x:n.x+.5,y:n.y+.5}).setMotion({angle:Math.atan2(i.y-n.y,i.x-n.x),vel:r.bulletVelocity}))}}motion(){let{entities:t}=this;for(let i of t.get()){let{ignoreSolid:o,motion:n,position:r,trail:s}=i;if(r&&n){let l=c({},r),[a,f]=K(n),m={x:r.x+a,y:r.y+f},p=_(G(l),G(m)),v=l,j=!1,Y;for(let P of p){v=P;let{wall:tt,solid:M}=this.getContents(P);if(tt){j=!0;break}else if(M&&!(o!=null&&o.ids.includes(this.getRootID(M)))){Y=M;break}s&&P!==p.slice(-1)[0]&&this.spawn(s.effectPrefab).setPosition(P)}j||Y?i.kill():i.move(m.x,m.y),i.alive}}}kills(){for(let t of this.entities.get())t.alive||this.entities.delete(t)}tick(){this.lifetimes(),this.homing(),this.turrets(),this.motion(),this.kills()}handleKeys(){let{map:t,player:i,term:o}=this,n=o.getMovementKey();if(n){let r=i.position.x+n.x,s=i.position.y+n.y;t.isBlocked(r,s)||(i.move(r,s),this.fovRecompute=!0,this.tick())}}update(){this.handleKeys(),this.dirty&&this.draw()}};var Z=b(y());function gt(e){let o=document.createElement("div");e.appendChild(o);let n=()=>{let m=Math.floor(window.innerWidth/480),p=Math.floor(window.innerHeight/320),v=Math.min(m,p);o.style.width=`${480*v}px`,o.style.height=`${320*v}px`};window.addEventListener("resize",n),n();let r=document.createElement("canvas");o.appendChild(r);let s=new Z.Terminal(r,60,40),l=new E(s);l.gotoDemoRoom(),window.g=l}window.addEventListener("load",()=>gt(document.body));})();
//# sourceMappingURL=bundle.js.map
