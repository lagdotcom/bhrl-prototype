"use strict";(()=>{var si=Object.create;var At=Object.defineProperty;var ai=Object.getOwnPropertyDescriptor;var li=Object.getOwnPropertyNames,De=Object.getOwnPropertySymbols,pi=Object.getPrototypeOf,Te=Object.prototype.hasOwnProperty,mi=Object.prototype.propertyIsEnumerable;var Me=(e,t,i)=>t in e?At(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,R=(e,t)=>{for(var i in t||={})Te.call(t,i)&&Me(e,i,t[i]);if(De)for(var i of De(t))mi.call(t,i)&&Me(e,i,t[i]);return e};var fi=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),q=(e,t)=>{for(var i in t)At(e,i,{get:t[i],enumerable:!0})},ci=(e,t,i,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of li(t))!Te.call(e,r)&&r!==i&&At(e,r,{get:()=>t[r],enumerable:!(o=ai(t,r))||o.enumerable});return e};var x=(e,t,i)=>(i=e!=null?si(pi(e)):{},ci(t||!e||!e.__esModule?At(i,"default",{value:e,enumerable:!0}):i,e));var b=fi((Po,Ce)=>{Ce.exports=globalThis.wglt});var Nt=x(b());var ri=x(b());function mt(e,t=new Map){if(!e||typeof e!="object")return e;if(t.has(e))return t.get(e);let i;if(e.nodeType&&"cloneNode"in e)i=e.cloneNode(!0),t.set(e,i);else if(e instanceof Date)i=new Date(e.getTime()),t.set(e,i);else if(e instanceof RegExp)i=new RegExp(e),t.set(e,i);else if(Array.isArray(e)){i=new Array(e.length),t.set(e,i);for(let o=0;o<e.length;o++)i[o]=mt(e[o],t)}else if(e instanceof Map){i=new Map,t.set(e,i);for(let[o,r]of e.entries())i.set(o,mt(r,t))}else if(e instanceof Set){i=new Set,t.set(e,i);for(let o of e)i.add(mt(o,t))}else if(e instanceof Object){i={},t.set(e,i);for(let[o,r]of Object.entries(e))i[o]=mt(r,t)}else throw Error(`Unable to clone ${e}`);return i}function Ae(e){return mt(e,new Map)}var ft=Ae,Ie=Object.keys,Re=e=>{let t={};for(let[i,o]of e)t[i]=o;return t};var z=class{constructor(t,i){this.g=t;this.name=i;this.alive=!0,this.id=++t.lastEntityId,this.solid=!1,this.tags=new Set}applyPrefab(t,i){if(this.prefab=t,i.components&&Object.assign(this,ft(i.components)),i.children)for(let{name:o,x:r,y:n,overlay:s,tags:a}of i.children){let l=this.g.spawn(o).setAttachment({parent:this,x:r,y:n});if(s)for(let p of Ie(s))Object.assign(l[p],ft(s[p]));if(a)for(let p of a)l.tags.add(p)}return this}get[Symbol.toStringTag](){return this.name}kill(t){return this.alive=!1,this.eachChild(i=>this.g.kill(i,t)),this}eachChild(t){var i;for(let o of this.g.entities.get())((i=o.attachment)==null?void 0:i.parent)===this&&t(o,o.attachment)}setAI(t){return this.ai=t,this}setAppearance(t){return this.g.refresh(),this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setItem(t){return this.item=t,this}setLastMovement(t){return this.lastMovement=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setOrigin(t){return this.origin=t,this}setPilot(t){return this.pilot=t,this}setPosition(t){return this.g.refresh(),this.position=t,this}setShip(t){return this.ship=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,i){return this.g.refresh(),this.position={x:t,y:i},this.eachChild((o,r)=>o.move(t+r.x,i+r.y)),this}};function Be(e,t){var r,n,s,a;let i=(n=(r=e.appearance)==null?void 0:r.layer)!=null?n:0,o=(a=(s=t.appearance)==null?void 0:s.layer)!=null?a:0;return i!==o?i-o:e.id-t.id}var Le=["damage","draw","kill","move","notice","playerFire","playerMove","spawn","tick","waveBegin"];var Wt={};q(Wt,{Bullet:()=>ui,DroneBullet:()=>di,HomingMissile:()=>yi,PlayerBullet:()=>gi});var ct=x(b());var hi={Heart:"",Diamond:"",Club:"",Dot:"\x07",Ring:"	",RingInvert:`
`,Male:"\v",Female:"\f",DoubleNote:"",Star:"",Pilcrow:"",Silcrow:"",ResizeVertical:"",UpArrow:"",DownArrow:"",RightArrow:"",LeftArrow:"\x1B",DownWedge:"",Pentagon:"\x7F",AHat:"\x83",EHat:"\x88",CapitalUUmlaut:"\x9A",Cent:"\x9B",Yen:"\x9D",NotFlip:"\xA9",Not:"\xAA",InvertedExclamation:"\xAD",Fill1:"\xB0",Fill2:"\xB1",Fill3:"\xB2",BoxVerticalSingle:"\xB3",BoxLeftSingleUpDouble:"\xBD",BoxUpSingleHorizontalSingle:"\xC1",BoxDownSingleHorizontalSingle:"\xC2",BoxHorizontalSingle:"\xC4",BoxUpDoubleHorizontalSingle:"\xD0",BoxDownSingleHorizontalDouble:"\xD1",BoxRightSingleUpDouble:"\xD3",BoxVerticalDoubleHorizontalSingle:"\xD7",Filled:"\xDB",Beta:"\xE1",Gamma:"\xE2",Pi:"\xE3",Theta:"\xE9",Omega:"\xEA",SymbolED:"\xED",SetMember:"\xEE",HorizontalDivide:"\xF6",Squared:"\xFD"},m=hi;var ke=(a=>(a[a.Effect=0]="Effect",a[a.Item=1]="Item",a[a.Ship=2]="Ship",a[a.Gun=3]="Gun",a[a.Bullet=4]="Bullet",a[a.Player=5]="Player",a[a.PlayerBullet=6]="PlayerBullet",a))(ke||{}),y=ke;var ui={components:{projectile:{damage:1},appearance:{glyph:m.InvertedExclamation,layer:y.Bullet,fg:ct.Colors.YELLOW}}},di={components:{projectile:{damage:1},appearance:{glyph:".",layer:y.Bullet,fg:ct.Colors.ORANGE}}},yi={components:{projectile:{damage:1},homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:y.Bullet,fg:ct.Colors.DARK_RED}}},gi={components:{projectile:{damage:3},appearance:{glyph:"!",layer:y.PlayerBullet,fg:ct.Colors.YELLOW}}};var Ot={};q(Ot,{AirFistRange:()=>bi,SmokePuff:()=>xi});var nt=x(b());var bi={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:y.Effect,bg:(0,nt.fromRgb)(0,255,255,100),blendMode:nt.BlendMode.Add}}},xi={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:y.Effect,bg:(0,nt.fromRgb)(100,100,100,50),blendMode:nt.BlendMode.Add}}};var _t={};q(_t,{DroneGun:()=>Si,OlmSpray:()=>vi,PeaShooter:()=>Ei,PlayerGun:()=>wi});var c=(e,t,i,o,r)=>({name:e,x:t,y:i,overlay:o,tags:r}),S=(e,t,i,o=0)=>({name:e,type:t,maxHp:i,hp:0,maxShield:o,shield:0,shieldTimer:0}),Q=(e,{salvoCount:t=1,timeBetweenShots:i=1,timeBetweenSalvos:o=1,ammunition:r=1/0},n)=>({name:e,bullets:n,salvoCount:t,timeBetweenShots:i,timeBetweenSalvos:o,timer:0,salvo:t,ammunition:r}),N=(e,t,i,o,r,n)=>({name:e,prefab:t,angle:i,vel:o,offset:r,beam:n});var X=Math.PI/2,It=X/2,Pi={Right:0,DownRight:It,Down:X,DownLeft:X+It,Left:X*2,UpLeft:X*2+It,Up:X*3,UpRight:X*3+It},Y=Pi;var Ei={components:{turret:Q("Pea Shooter",{salvoCount:1,timeBetweenSalvos:3},[N("Bullet","Bullet",Y.Down,2)])}},wi={components:{turret:Q("Pew Pew",{salvoCount:2,timeBetweenShots:0,timeBetweenSalvos:3},[N("Your Bullet","PlayerBullet",Y.Up,2)])}},Si={components:{turret:Q("Stinger",{salvoCount:1,timeBetweenSalvos:5,ammunition:5},[N("Bullet","DroneBullet","nearestEnemy",1)])}},vi={components:{turret:Q("Deployment",{salvoCount:1,timeBetweenSalvos:12},[N("Drone","DroneA",Y.Up,0,{x:0,y:-1}),N("Missile","HomingMissile",Y.DownLeft,2,{x:-1,y:1}),N("Missile","HomingMissile",Y.DownRight,2,{x:1,y:1})])}};var Vt={};q(Vt,{BombItem:()=>Hi,DoubleItem:()=>Di,DrainItem:()=>Mi,HealItem:()=>Ti,JunkItem:()=>Ci,MoneyItem:()=>Ai,RechargeItem:()=>Ii});var Hi={components:{appearance:{glyph:m.DoubleNote,layer:y.Item},item:{type:"bomb"}}},Di={components:{appearance:{glyph:m.Squared,layer:y.Item},item:{type:"double"}}},Mi={components:{appearance:{glyph:"%",layer:y.Item},item:{type:"drain"}}},Ti={components:{appearance:{glyph:m.Heart,layer:y.Item},item:{type:"heal"}}},Ci={components:{appearance:{glyph:m.Beta,layer:y.Item},item:{type:"junk"}}},Ai={components:{appearance:{glyph:m.SetMember,layer:y.Item},item:{type:"money",value:0}}},Ii={components:{appearance:{glyph:"@",layer:y.Item},item:{type:"recharge"}}};var $t={};q($t,{PlayerHull:()=>Ri,PlayerShip:()=>Bi});var Yt=x(b());var Ri={components:{solid:!0,appearance:{glyph:"#",layer:y.Player,fg:Yt.Colors.DARK_GRAY}}},Bi={components:{player:{weaponArrays:["Primary","Secondary"]},ship:S("Ace of Clubs","Battleship",20,10)},children:[c("PlayerHull",0,0,{appearance:{glyph:m.LeftArrow}}),c("PlayerHull",1,0,{appearance:{glyph:m.Club,fg:Yt.Colors.LIGHT_GRAY}}),c("PlayerHull",2,0,{appearance:{glyph:m.RightArrow}}),c("PlayerGun",1,0,void 0,["Primary"]),c("Sword",1,0,void 0,["Secondary"])]};var qt={};q(qt,{AtomSmasher:()=>Xi,CruiseyWing:()=>ji,Demigod:()=>zi,DroneA:()=>Vi,DroneB:()=>Yi,DroneC:()=>$i,GoutOFlame:()=>qi,Gremlin:()=>Qi,Hull:()=>Li,Olm:()=>Ui,ShipA:()=>ki,ShipB:()=>Gi,ShipC:()=>Ki,ShipD:()=>Fi,ShipE:()=>Ni,ShipF:()=>Wi,ShipG:()=>Oi,ShipH:()=>_i});var Ge=x(b());var Li={components:{solid:!0,appearance:{glyph:"#",layer:y.Ship,fg:Ge.Colors.DARK_GRAY}}},C={idealDistance:8,firingDistance:14,speed:1},$=c("PeaShooter",0,0),ki={components:{ai:C,ship:S("Axle","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:m.Pilcrow}}),$]},Gi={components:{ai:C,ship:S("Baying Hound","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:m.Yen}}),$]},Ki={components:{ai:C,ship:S("Caustic","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:"W"}}),$]},Fi={components:{ai:C,ship:S("Defiant","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:m.Omega}}),$]},Ni={components:{ai:C,ship:S("Executor","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:m.DownWedge}}),$]},Wi={components:{ai:C,ship:S("Falcon","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:m.Pi}}),$]},Oi={components:{ai:C,ship:S("Gauntlet","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:"M"}}),$]},_i={components:{ai:C,ship:S("Halo","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:m.Female}}),$]},jt={idealDistance:5,firingDistance:6,speed:1},Ut=c("DroneGun",0,0),Vi={components:{ai:jt,ship:S("Runabout","Escort",1)},children:[c("Hull",0,0,{appearance:{glyph:m.Theta}}),Ut]},Yi={components:{ai:jt,ship:S("Wasp","Escort",1)},children:[c("Hull",0,0,{appearance:{glyph:m.SymbolED}}),Ut]},$i={components:{ai:jt,ship:S("Pulsar","Escort",1)},children:[c("Hull",0,0,{appearance:{glyph:m.Silcrow}}),Ut]},ji={components:{ai:C,ship:S("Cruisey Wing","Battleship",10,5)},children:[c("Hull",0,0,{appearance:{glyph:m.Not}}),c("Hull",1,0,{appearance:{glyph:m.HorizontalDivide}}),c("Hull",2,0,{appearance:{glyph:m.NotFlip}}),c("PeaShooter",0,0),c("PeaShooter",1,0),c("PeaShooter",2,0)]},Ui={components:{ai:C,ship:S("Olm","Battleship",15,4)},children:[c("Hull",0,0,{appearance:{glyph:m.Cent}}),c("Hull",0,1,{appearance:{glyph:m.ResizeVertical}}),c("Hull",0,2,{appearance:{glyph:m.BoxDownSingleHorizontalDouble}}),c("OlmSpray",0,0)]},qi={components:{ai:C,ship:S("Gout-'o-flame","Battleship",5,20)},children:[c("Hull",0,0,{appearance:{glyph:m.Pentagon}}),c("Hull",1,0,{appearance:{glyph:m.BoxVerticalDoubleHorizontalSingle}}),c("Hull",2,0,{appearance:{glyph:m.Pentagon}}),c("Hull",1,1,{appearance:{glyph:m.BoxUpDoubleHorizontalSingle}}),c("PeaShooter",1,1)]},zi={components:{ai:C,ship:S("Demigod","Battleship",30,15)},children:[c("Hull",1,0,{appearance:{glyph:m.CapitalUUmlaut}}),c("Hull",0,1,{appearance:{glyph:"}"}}),c("Hull",1,1,{appearance:{glyph:m.RingInvert}}),c("Hull",2,1,{appearance:{glyph:"{"}}),c("Hull",1,2,{appearance:{glyph:"Y"}}),c("PeaShooter",1,2)]},Qi={components:{ai:C,ship:S("Gremlin","Battleship",30,15)},children:[c("Hull",1,0,{appearance:{glyph:m.ResizeVertical}}),c("Hull",2,0,{appearance:{glyph:m.ResizeVertical}}),c("Hull",0,1,{appearance:{glyph:"]"}}),c("Hull",1,1,{appearance:{glyph:m.BoxLeftSingleUpDouble}}),c("Hull",2,1,{appearance:{glyph:m.BoxRightSingleUpDouble}}),c("Hull",3,1,{appearance:{glyph:m.Male}}),c("Hull",1,2,{appearance:{glyph:m.BoxVerticalSingle}}),c("Hull",2,2,{appearance:{glyph:m.Gamma}}),c("PeaShooter",1,2),c("PeaShooter",2,2)]},Xi={components:{ai:C,ship:S("Atom Smasher","Battleship",10,20)},children:[c("Hull",1,0,{appearance:{glyph:m.EHat}}),c("Hull",2,0,{appearance:{glyph:"-"}}),c("Hull",3,0,{appearance:{glyph:m.AHat}}),c("Hull",0,1,{appearance:{glyph:m.Fill2}}),c("Hull",1,1,{appearance:{glyph:m.Fill1}}),c("Hull",2,1,{appearance:{glyph:m.Fill2}}),c("Hull",3,1,{appearance:{glyph:m.Fill3}}),c("Hull",4,1,{appearance:{glyph:m.Filled}}),c("PeaShooter",0,1),c("PeaShooter",1,1),c("PeaShooter",2,1),c("PeaShooter",3,1),c("PeaShooter",4,1)]};var zt={};q(zt,{Sword:()=>Zi,SwordBullet:()=>Ji});var J=x(b());var Ji={components:{projectile:{damage:5,special:"increasedDropChance"},appearance:{glyph:m.Star,layer:y.PlayerBullet,fg:J.Colors.LIGHT_GREEN}}},Zi={components:{turret:Q("Sword",{salvoCount:1,timeBetweenSalvos:20},[N("Stab","SwordBullet","lastMovement",1,void 0,{duration:2,appearance:[{glyph:m.Star,fg:J.Colors.LIGHT_GREEN},{glyph:"o",fg:J.Colors.LIGHT_GREEN},{glyph:m.Diamond,fg:J.Colors.LIGHT_GREEN},{glyph:m.Ring,fg:J.Colors.DARK_GREEN},{glyph:m.Dot,fg:J.Colors.DARK_GRAY}]})])}};var to=R(R(R(R(R(R(R({},Wt),Ot),Vt),_t),$t),qt),zt);function Qt(e,t){return e.add(new z(e,t).applyPrefab(t,to[t]))}function B(e){return typeof e=="undefined"?NaN:Math.floor(e)}function A(e){return{x:B(e.x),y:B(e.y)}}function W(e,t){if(typeof e=="undefined"||typeof t=="undefined")return!1;let i=A(e),o=A(t);return i.x===o.x&&i.y===o.y}function D(e,t){return{x:e.x+t.x,y:e.y+t.y}}var ht=class{constructor(t,i=[]){this.compareFn=t;this.entities=i;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}add(t){this.entities.push(t),this.dirty=!0}clearDead(){this.entities=this.entities.filter(t=>t.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var g=x(b());var k=x(b());var V=x(b());function eo(e,t){if(!t||!e.length)throw new Error("Could not get midpoint");let i=o=>e.reduce((r,{offset:n})=>r+n[o],0)/e.length;return{x:t.x+i("x"),y:t.y+i("y")}}function io(e,t,i,o=[]){let r=[];for(let{offset:n}of t){let s=D(i,n),{oob:a,wall:l,solid:p}=e.getContents(s,o);a?r.push({absolute:s,offset:n,entity:"oob"}):l?r.push({absolute:s,offset:n,entity:"wall"}):p&&r.push({absolute:s,offset:n,entity:p})}return r}function L(e,t){let i=e.getRoot(t);return e.entities.get().filter(o=>e.getRoot(o)===i)}function ut(e,t){return L(e,t).map(i=>i.id)}function G(e,t){var a;let i=(a=e.getRoot(t).position)!=null?a:{x:0,y:0},o=L(e,t),r=[],n=0,s=0;for(let l of o){let{attachment:p,solid:f}=l;if(p&&f){let{x:h,y:d}=p;r.push({absolute:D(i,p),offset:{x:h,y:d},entity:l}),n=Math.max(h+1,n),s=Math.max(d+1,s)}}return{layout:r,topLeft:i,width:n,height:s}}function Ke(e,t,i){let o=ut(e,t),{layout:r,topLeft:n}=G(e,t);return!i||!n?[]:io(e,r,i||n,o)}function st(e,t){let{layout:i,topLeft:o}=G(e,t);if(!o||!i.length)throw new Error(`Could not get midpoint of entity#${t.id}`);return eo(i,o)}function Fe(e,t,i,o,r){for(let n=0;n<r;n++)for(let s=0;s<o;s++){let{oob:a,wall:l,solid:p,other:f}=e.getContents({x:t+s,y:i+n});if(a||l||p||f.length)return!1}return!0}var v=class{constructor(t,i){this.list=t;this.filter=i}matches(t){if(!t.alive)return!1;for(let i of this.filter)if(!t[i])return!1;return!0}forEach(t){for(let i of this.list.get())this.matches(i)&&t(i,i)}};var Xt=Math.PI*2;function K(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}function Ne(e,t){let i=(e-t)%Xt,o=(t-e)%Xt;return i<o?-i:o}function j(e){let t=Math.cos(e.angle)*e.vel,i=Math.sin(e.angle)*e.vel;return[t,i]}function We(e){for(;e<0;)e+=Xt;return e}var Jt=[{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:-1}];function Zt(e){return Jt.map(t=>D(e,t))}function I(e){if(!e.length)throw new Error("oneOf passed empty array");return e[Math.floor(Math.random()*e.length)]}function te(e){let t=new v(e.entities,["ai","position"]);e.on("tick",function(){t.forEach(({ai:o,position:r},n)=>{n.setLastMovement(),o.attacking||(o.attacking=e.player,e.fire("notice",{e:n,noticed:e.player}));let s=ut(e,n),{layout:a}=G(e,n),l=A(r),p=e.getDistanceMap(o.attacking),f=E=>{let{oob:w,solid:H,wall:U}=e.getContents(E,s);return!w&&!H&&!U},h=E=>f(E)?Math.abs(p.getOrDefault(E,1/0)-o.idealDistance):1/0,d=E=>a.reduce((w,{offset:H})=>w+h(D(E,H)),0)/a.length,u=d(l),P=[];for(let E of Jt){let w=D(l,E);if(!p.has(w))continue;let H=d(w);H<u?(u=H,P=[w]):H===u&&P.push(w)}if(P.length){let E=I(P);n.move(E.x,E.y),n.setLastMovement({angle:K(l,E)});return}})}),e.on("damage",function({e:o,source:r}){r.owner&&o!==r.owner&&o.ai&&!o.ai.attacking&&r.owner.alive&&(o.ai.attacking=r.owner)})}function ee(e){let t=new v(e.entities,["appearance","position"]);e.on("draw",function(){t.forEach(({appearance:o,position:r})=>e.drawIfVisible(B(r.x),B(r.y),o.glyph,o.fg,o.bg,o.blendMode))})}var Oe=(n=>(n[n.None=0]="None",n[n.Healthy=1]="Healthy",n[n.Double=2]="Double",n[n.Drain=4]="Drain",n[n.HasPilot=8]="HasPilot",n))(Oe||{}),M=Oe;var _e=["Berserker","Chopter","Duelist","Engineer","Fighter","Negotiator","Psychic","Smuggler"];var T=x(b()),Rt=[0,T.Colors.DARK_RED,T.Colors.BROWN,T.Colors.LIGHT_RED,T.Colors.ORANGE,T.Colors.YELLOW,T.Colors.WHITE],O={Typical:{fg:T.Colors.DARK_GRAY},Healthy:{fg:T.Colors.DARK_GREEN},Double:{fg:T.Colors.LIGHT_GRAY},Multi:{fg:T.Colors.DARK_MAGENTA},Drain:{fg:T.Colors.DARK_RED},StarPilot:{fg:T.Colors.YELLOW},Mega:{fg:T.Colors.BLACK,bg:T.Colors.DARK_MAGENTA}};function ie(e,t=0){let i=[];for(let o=t;o<e;o++)i.push(o);return i}function Bt(e,t){let{ship:i}=e;if(!i)throw new Error(`Cannot put pilot into entity ${e.name} (no ship)`);e.setPilot(t),i.maxHp+=t.body}function at(e){for(let t=e.length-1;t>0;t--){let i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}return e}function Lt(e,...t){return e.filter(i=>!t.includes(i))}var ne={Typical:M.None,Healthy:M.Healthy,Double:M.Double,Multi:M.Healthy|M.Double,Drain:M.Drain,StarPilot:M.HasPilot,Mega:M.Healthy|M.Double|M.Drain|M.HasPilot},oe=["ShipA","ShipB","ShipC","ShipD","ShipE","ShipF","ShipG","ShipH"],re=["CruiseyWing","Olm","GoutOFlame","Demigod","Gremlin","AtomSmasher"],oo=[{name:"Let Fate Decide",difficulty:1,groups:[{count:7,prefabs:oe},{count:1,prefabs:re}]},{name:"Court Martial",difficulty:2,groups:[{count:5,prefabs:["ShipA","ShipE"]},{count:1,prefabs:["CruiseyWing"]}]},{name:"Hellhounds",difficulty:3,groups:[{count:2,prefabs:["ShipB"]},{count:2,prefabs:["GoutOFlame"]}]},{name:"Chaos",difficulty:4,groups:[{count:4,prefabs:["ShipC"]},{count:4,prefabs:Lt(oe,"ShipC")},{count:1,prefabs:["Demigod"]}]},{name:"Fly in Formation",difficulty:4,groups:[{count:7,prefabs:["ShipF"]},{count:1,prefabs:re}]},{name:"Hark!",difficulty:6,groups:[{count:3,prefabs:["ShipH"]},{count:3,prefabs:Lt(oe,"ShipH")},{count:1,prefabs:["Demigod"]}]},{name:"Caverns.com",difficulty:7,groups:[{count:1,prefabs:["ShipA","ShipG"]},{count:3,prefabs:["Olm"]}]},{name:"Humanity to the Rescue",difficulty:8,groups:[{count:7,prefabs:["ShipA","ShipD","ShipE","ShipG"]},{count:1,prefabs:["GoutOFlame"]}]},{name:"Wild Hunt",difficulty:9,groups:[{count:15,prefabs:["ShipB","ShipF"]},{count:1,prefabs:["Olm"]}]},{name:"Arm Wrestling",difficulty:10,groups:[{count:9,prefabs:["ShipG"]},{count:2,prefabs:["CruiseyWing"]}]},{name:"Valis",difficulty:11,groups:[{count:4,prefabs:["ShipC"]},{count:4,prefabs:["ShipH"]},{count:1,prefabs:re}]}];function Ve(e=3){return at(oo.slice()).slice(0,e).sort((t,i)=>t.difficulty-i.difficulty)}function Ye(e,t){return Math.random()*100>=e?t?"StarPilot":"Typical":t?"Mega":I(["Healthy","Double","Multi","Drain"])}function ro(e){let t=ft(e);for(;t.class.length<t.talent;)t.class.push(I(_e.filter(i=>!t.class.includes(i))));return t}function $e(e,t,i,o){let r=ne[i];if(r&M.HasPilot&&!o)throw new Error(`power ${i} needs pilot, none given`);let n=e.spawn(t),{ship:s}=n;if(!s)throw new Error(`Ship prefab ${t} doesn't have a ship component!`);if(s.power=i,r&M.Healthy&&(s.maxHp=s.maxHp*2+3),o){let l=ro(o);Bt(n,l)}dt(s);let a=O[i];for(let l of L(e,n))l.appearance&&Object.assign(l.appearance,a);return n}function je(e,t){let{width:i,height:o}=G(e,t);for(let r=0;r<e.term.height;r++){let n=at(ie(e.term.width-i));for(let s of n)if(Fe(e,s,r,i,o))return{x:s,y:r}}throw new Error(`Could not find ${i}x${o} spawn location`)}function dt(e){e.hp=e.maxHp,e.shield=e.maxShield}function se(e){e.on("kill",function({e:i,reason:o}){var s;let{position:r,ship:n}=i;if(r&&(n!=null&&n.power)&&o.type==="damage"){let a=ne[n.power],l=((s=o.source.e.projectile)==null?void 0:s.special)==="increasedDropChance",p=n.type==="Battleship"?l?.92:.42:l?.32:.02,f=(u=1)=>Math.random()*u<p,h=[];a&M.Double&&f()&&h.push("DoubleItem"),a&M.Drain&&f()&&h.push("DrainItem"),a&M.Healthy&&f()&&h.push("HealItem"),f()&&h.push("MoneyItem"),f()&&h.push("JunkItem");let d=at([{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1}]);for(let u of h){let P=D(r,d.pop());e.spawn(u).move(P.x,P.y).setMotion({angle:Y.Down,vel:1})}}})}var Ue=x(b());var kt=x(b());function lt(e,t,i){return e*(1-i)+t*i}var yt=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[i])=>t-i)}add(t,i){return this.points.push([t,i]),this.sort(),this}get(t){let[i,o]=this.points[0];if(t<=i)return(0,kt.fromRgb)(...o);let[r,n]=this.points[this.points.length-1];if(t>=r)return(0,kt.fromRgb)(...n);let s=this.points.findIndex(([U])=>U>t),[a,[l,p,f,h]]=this.points[s-1],[d,[u,P,E,w]]=this.points[s],H=(t-a)/(d-a);return(0,kt.fromRgb)(lt(l,u,H),lt(p,P,H),lt(f,E,H),lt(h,w,H))}};function Z(e,t){let i=Math.abs(e.x-t.x),o=Math.abs(e.y-t.y);return Math.sqrt(i*i+o*o)}var no={Fire:new yt([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function ae(e){if(!(e.intensity<=0))return{glyph:" ",layer:y.Effect,bg:no[e.type].get(e.intensity),blendMode:Ue.BlendMode.Add}}function qe(e,t){let i=[],o=Math.floor(e.x-t),r=Math.ceil(e.x+t),n=Math.floor(e.y-t),s=Math.ceil(e.y+t);for(let a=n;a<=s;a++)for(let l=o;l<=r;l++){let p=Z(e,{x:l,y:a});p>=t||i.push({x:l,y:a,intensity:t-p})}return i}function le(e){e.on("kill",function({e:i,reason:o}){if(o.type==="exitedMap")return;let{explodes:r,name:n,position:s}=i;if(r&&s)for(let{x:a,y:l,intensity:p}of qe(s,r.size))e.add(new z(e,n+"Explosion").setPosition({x:a,y:l}).setField({type:r.type,intensity:p,falloff:r.falloff}))})}function gt(e,t,i,o){let r=e.getRoot(t);if(!r.ship)return;let n=i;r.ship.shield>0&&(r.ship.shield>i?(r.ship.shield-=i,n=0):(n-=r.ship.shield,r.ship.shield=0)),n&&(r.ship.hp-=n);let s={e:o,owner:o};o.origin&&(s.owner=o.origin.owner,s.ship=o.origin.ship,s.turret=o.origin.turret),console.log(o.name,"hits",r.name,"for",i),e.fire("damage",{e:r,amount:i,source:s}),r.ship.hp<=0&&e.kill(r,{type:"damage",source:s})}function pe(e){let t=new v(e.entities,["ship"]),i=new v(e.entities,["field","position"]);e.on("tick",function(){i.forEach(({field:r,position:n},s)=>{r.intensity-=r.falloff,s.setAppearance(ae(r)),r.intensity<1?e.kill(s,{type:"expired"}):t.forEach((a,l)=>{let{layout:p}=G(e,l);p.find(({absolute:h})=>W(h,n))&&gt(e,l,Math.floor(r.intensity),s)})})}),e.on("spawn",function({e:r}){r.field&&r.setAppearance(ae(r.field))})}var rt=x(b());var bt=x(b());var tt=class{constructor(t,i,o){this.g=t;this.pilot=i;this.full=o;this.width=11,this.height=o?2+i.class.length:1}get isPlayer(){return isNaN(this.pilot.difficulty)}draw(t,i){if(this.full&&(this.g.term.drawString(t,i,this.pilot.name,this.pilot.star?bt.Colors.YELLOW:bt.Colors.LIGHT_GRAY),i++),this.drawStat(t,i,"body"),this.drawStat(t+3,i,"mind"),this.drawStat(t+6,i,"spirit"),this.drawStat(t+9,i,"talent"),!!this.full)for(let o of this.pilot.class)this.g.term.drawString(t,++i,o,bt.Colors.LIGHT_GREEN)}drawStat(t,i,o){let r=this.pilot[o];this.g.term.drawChar(t,i,o[0].toUpperCase(),bt.Colors.WHITE),this.g.term.drawChar(t+1,i,r.toString(),Rt[r])}};var F=x(b());function me(e,t,i,o,r,n,s,a,l){let p=`${Math.ceil(r)}/${n}`,f=Math.floor(r/n*o);e.drawHLine(t,i,o," ",void 0,a),f&&e.drawHLine(t,i,f," ",void 0,s),e.drawCenteredString(t+o/2,i,p,l)}var et=class{constructor(t,i){this.g=t;this.ship=i;this.width=Math.max(13,i.name.length),this.height=i.maxShield?3:2}draw(t,i){let{ship:o,width:r}=this,{term:n}=this.g,s=r-3;n.drawString(t,i,o.name,F.Colors.WHITE),n.drawString(t,i+1,"HP:",F.Colors.WHITE),me(n,t+3,i+1,s,o.hp,o.maxHp,F.Colors.DARK_GREEN,F.Colors.DARK_RED,F.Colors.WHITE),o.maxShield&&(n.drawString(t,i+2,"Sh:",F.Colors.WHITE),me(n,t+3,i+2,s,o.shield,o.maxShield,F.Colors.DARK_CYAN,F.Colors.LIGHT_BLUE,F.Colors.WHITE))}};var it=x(b());function fe(e){return e.salvo<=0?e.ammunition<=0?"Spent":"Reloading":e.timer>0?"Chambering":"Ready"}function Qe(e){e.timer>0&&(e.timer--,e.timer<=0&&e.salvo<=0&&(e.ammunition?(e.salvo=Math.min(e.salvoCount,e.ammunition),e.ammunition-=e.salvo):e.timer=1/0))}function Gt(e,t){return e.bullets.find(i=>i.angle==="lastMovement")&&!t.lastMovement?!1:e.timer===0}function ze(e,t,i,o,r,n,s,a,l){let p=e.spawn(i).setIgnoreSolid({ids:l}).move(n.x,n.y);return p.name=t,a&&p.setMotion({angle:s,vel:a}),p.ship&&dt(p.ship),o.ship&&p.setOrigin({owner:o,ship:o.ship,turret:r}),p}function so(e,t,i,o,r,n,s){let{angle:a,beam:l,name:p,offset:f,prefab:h,vel:d}=t,u=D(o,f!=null?f:{x:.5,y:.5}),P=a==="nearestEnemy"?K(u,r):a==="lastMovement"?n.lastMovement.angle:a;if(l&&d){let[E,w]=j({angle:P,vel:d}),H={x:E,y:w},U=D(u,H);return l.appearance.map(ni=>{let Ct=ze(e,p,h,n,i,U,P,0,s).setMotion({angle:P,vel:0}).setLifetime({duration:l.duration});return Ct.appearance&&Object.assign(Ct.appearance,ni),n.ship&&Ct.setOrigin({owner:n,ship:n.ship,turret:i}),U=D(U,H),Ct})}return[ze(e,p,h,n,i,u,P,d,s)]}function Kt(e,t,i,o,r,n=[]){let{timeBetweenSalvos:s,timeBetweenShots:a}=t;--t.salvo<=0?t.timer=s:t.timer=a;let l=[];for(let p of t.bullets)l.push(...so(e,p,t,i,o,r,n));return l}var ao={Spent:it.Colors.DARK_GRAY,Reloading:it.Colors.LIGHT_RED,Ready:it.Colors.YELLOW,Chambering:it.Colors.BROWN},ot=class{constructor(t,i){this.g=t;this.turret=i;this.width=Math.max(i.name.length,this.stateLabel.length),this.height=2,i.ammunition>0&&i.ammunition<1/0&&this.height++}get stateLabel(){let{timer:t,salvo:i,salvoCount:o}=this.turret,r=fe(this.turret);if(r==="Spent")return"Out of Ammo";if(r==="Reloading")return`Reloading (${t})`;let n=`${i}/${o}`;return r==="Ready"?n:`${n} (${t})`}draw(t,i){this.g.term.drawString(t,i,this.turret.name,it.Colors.WHITE);let o=fe(this.turret);this.g.term.drawString(t,i+1,this.stateLabel,ao[o]),this.height>2&&this.g.term.drawString(t,i+2,`${this.turret.ammunition} ammo left`,it.Colors.LIGHT_GRAY)}};var pt=6;function ce(e){let{mapHeight:t,term:i}=e;e.on("draw",function(){let r=e.player,{pilot:n,ship:s}=r;i.fillRect(0,t,i.width,pt," ",rt.Colors.WHITE,rt.Colors.BLACK),i.drawSingleBox(0,t,i.width,pt);let a=1,l=t+1,p=new et(e,s);p.draw(a,l);let f=a+Math.floor((p.width-11)/2);new tt(e,n,!1).draw(f,l+3),a+=p.width+1,i.drawChar(a-1,l-1,m.BoxDownSingleHorizontalSingle,rt.Colors.WHITE),i.drawVLine(a-1,l,pt-2,m.BoxVerticalSingle,rt.Colors.WHITE),i.drawChar(a-1,l+pt-2,m.BoxUpSingleHorizontalSingle,rt.Colors.WHITE);let d=a;for(let u of r.player.weaponArrays){let P=d,E=L(e,r).filter(w=>w.turret&&w.tags.has(u));for(let w of E){let H=new ot(e,w.turret);H.draw(d,l+1),d+=H.width+1}i.drawString(P,l,u,rt.Colors.LIGHT_CYAN),d=Math.max(d,P+u.length+1)}})}function he(e){let t=new v(e.entities,["homing","motion","position"]);e.on("tick",function(){t.forEach(({homing:o,motion:r,position:n},s)=>{var f;if(!((f=o.target)!=null&&f.alive))return;let a=st(e,o.target),l=K(n,a),p=Ne(r.angle,l);Math.abs(p)<=o.strength?r.angle=l:p<0?r.angle-=o.strength:r.angle+=o.strength,--o.duration<=0&&(s.setHoming(),s.setTrail())})})}function ue(e){let t=new v(e.entities,["lifetime"]);e.on("tick",function(){t.forEach(({lifetime:o},r)=>{if(--o.duration<=0)e.kill(r,{type:"expired"});else if(o.decayingAppearance&&r.appearance){let n=o.decayingAppearance[o.duration-1];Object.assign(r.appearance,n)}})})}function Ft(e,t){let i=t.x-e.x,o=t.y-e.y,r=Math.abs(i),n=Math.abs(o),s=i>0?1:-1,a=o>0?1:-1,l=R({},e),p=[R({},l)];for(let f=0,h=0;f<r||h<n;)(.5+f)/r<(.5+h)/n?(l.x+=s,f++):(l.y+=a,h++),p.push(R({},l));return p}function Xe(e,t,i){let o=[],r=(n,s)=>{let a=B(n),l=B(s);o.find(p=>p.x===a&&p.y===l)||o.push({x:a,y:l})};for(let n=0;n<=Math.floor(i*Math.sqrt(.5));n++){let s=Math.floor(Math.sqrt(i*i-n*n));r(e-s,t+n),r(e+s,t+n),r(e-s,t-n),r(e+s,t-n),r(e+n,t-s),r(e+n,t+s),r(e-n,t-s),r(e-n,t+s)}return o}function de(e){let t=new v(e.entities,["motion","position"]);e.on("tick",function(){t.forEach(({motion:o,position:r,projectile:n,ignoreSolid:s},a)=>{let[l,p]=j(o),f={x:r.x+l,y:r.y+p},h=Ft(A(r),A(f)),d=!1,u;for(let P of h){if(!e.inBounds(P)){e.kill(a,{type:"exitedMap"});return}e.move(a,P);let{wall:E,solid:w}=e.getContents(P,s==null?void 0:s.ids);if(E){d=!0;break}else if(w){u=w;break}}d?e.kill(a,{type:"hitWall"}):u?(n&&gt(e,u,n.damage,a),e.kill(a,{type:"hitEntity",other:u})):e.move(a,f)})})}function ye(e){e.on("playerMove",function({move:i}){let o=e.player,r=o.position,n=D(r,i);Ke(e,o,n).length||(o.move(n.x,n.y),o.setLastMovement({angle:K(r,n)}),e.tick())}),e.on("playerFire",function({array:i}){let o=e.player,r=o.player.weaponArrays[i],n=L(e,o),s=n.filter(l=>l.tags.has(r)),a=!1;for(let l of s)l.turret&&Gt(l.turret,o)&&(Kt(e,l.turret,l.position,{x:0,y:0},o,n.map(p=>p.id)),a=!0);a&&(o.setLastMovement(),e.tick())})}function ge(e){let t=new v(e.entities,["ship"]);e.on("tick",function(){t.forEach(({pilot:o,ship:r})=>{var s;if(r.shield>=r.maxShield){r.shieldTimer=0;return}let n=6-((s=o==null?void 0:o.body)!=null?s:0);++r.shieldTimer>=n&&(r.shield++,r.shieldTimer=0)})})}function be(e){e.on("waveBegin",function({wave:i,difficulty:o,pilot:r}){let n=(o+i.difficulty)*3,s=[];for(let l of i.groups)for(let p=0;p<l.count;p++)s.push(I(l.prefabs));let a=Math.floor(Math.random()*s.length);for(let l=0;l<s.length;l++){let p=l===a&&r!==void 0,f=s[l],h=Ye(n,p),d=$e(e,f,h),u=je(e,d);d.move(u.x,u.y)}})}function xe(e){e.on("move",function({e:i,old:o,pos:r}){i.trail&&!W(o,r)&&e.spawn(i.trail.effectPrefab).setPosition(o)})}function Pe(e){let t=new v(e.entities,["position","turret"]);e.on("tick",function(){t.forEach(({position:o,turret:r},n)=>{var p;Qe(r);let s=e.getRoot(n);if(!s.ai)return;let a=s.ai.attacking;if(!(a!=null&&a.alive))return;let l=st(e,a);if(!(Z(o,l)>((p=s.ai.firingDistance)!=null?p:1/0))&&Gt(r,s))for(let f of Kt(e,r,o,l,s,ut(e,s)))f.homing&&(f.homing.target=a),f.ai&&(f.ai.attacking=a)})})}function Je(e){ue(e),he(e),Pe(e),pe(e),ge(e),de(e),te(e),be(e),ee(e),ce(e),xe(e),le(e),se(e),ye(e)}var xt=x(b());var Ze=x(b()),_=class{constructor(t){this.g=t;this.width=0,this.height=0,this.instructions=[]}add(t){this.instructions.push(t),this.updateBounds()}addLine(t,i=Ze.Colors.WHITE,o){this.add({x:0,y:this.instructions.length,line:t,fg:i,bg:o})}updateBounds(){this.width=this.instructions.reduce((t,i)=>Math.max(i.line.length+i.x,t),0),this.height=1+this.instructions.reduce((t,i)=>Math.max(i.y,t),0)}draw(t,i){for(let{x:o,y:r,line:n,fg:s,bg:a}of this.instructions)this.g.term.drawString(t+o,i+r,n,s,a)}};var ti=Math.PI/4,lo=[m.RightArrow,m.DownArrow+m.RightArrow,m.DownArrow,m.DownArrow+m.LeftArrow,m.LeftArrow,m.UpArrow+m.LeftArrow,m.UpArrow,m.UpArrow+m.RightArrow];function po(e){let t=Math.floor(We(e)/ti+ti/2);return lo[t]}var Pt=class extends _{constructor(i,o){super(i);this.e=o;this.instructions=[],o.name&&this.addLine(o.name),o.projectile&&this.addLine(`${o.projectile.damage} damage`,xt.Colors.LIGHT_RED),o.motion&&this.addLine(`${po(o.motion.angle)}, vel ${o.motion.vel}`,xt.Colors.LIGHT_GRAY),o.homing&&this.addLine(`chasing ${o.homing.target===this.g.player?"you ":""}${o.homing.duration<1/0?`(${o.homing.duration})`:""}`,xt.Colors.DARK_RED),o.lifetime&&this.addLine(`(lasts ${o.lifetime.duration})`,xt.Colors.DARK_GRAY)}};var Se=x(b());var Ee=x(b());var Et=class extends _{constructor(i,o){super(i);this.field=o;this.addLine(`${o.type} Field`),this.add({x:0,y:1,fg:Ee.Colors.LIGHT_GRAY,line:"intensity"}),this.add({x:10,y:1,fg:Ee.Colors.YELLOW,line:Math.floor(o.intensity).toString()})}};var we=x(b());var wt=class extends _{constructor(i,o){super(i);this.item=o;switch(o.type){case"bomb":this.addLine("Smart Bomb");break;case"double":this.addLine("Double",O.Double.fg,O.Double.bg);break;case"drain":this.addLine("Drain",O.Drain.fg,O.Drain.bg);break;case"heal":this.addLine("Heal",O.Healthy.fg,O.Healthy.bg);break;case"junk":this.addLine("Junk",we.Colors.DARK_GRAY);break;case"money":this.addLine(`${m.SetMember}${o.value}`,we.Colors.YELLOW);break;case"recharge":this.addLine("Recharge");break}}};function ei(e,t,i){if(!i.length)return;let o=[],r=1,n=1,s=f=>{o.push({x:r,y:n,object:f}),n+=f.height+1};for(let f of i){f.ship&&s(new et(e,f.ship)),f.pilot&&s(new tt(e,f.pilot,!0));let h=L(e,f);for(let d of h.filter(u=>u.turret))s(new ot(e,d.turret));(f.motion||f.projectile||f.homing||f.lifetime)&&s(new Pt(e,f)),f.field&&s(new Et(e,f.field)),f.item&&s(new wt(e,f.item))}if(!o.length)return;let a=Math.max(...o.map(f=>f.object.width))+2,l=Math.min(t.x+2,e.term.width-a),p=Math.min(t.y,e.term.height-n);e.term.fillRect(l,p,a,n," ",Se.Colors.WHITE,Se.Colors.BLACK),e.term.drawSingleBox(l,p,a,n);for(let f of o)f.object.draw(l+f.x,p+f.y)}function ii(e,t,i){for(let o of e.entities.get()){let{motion:r,projectile:n,position:s}=o;if(r&&n&&s&&Z(t,s)<=i){let a=K(t,s);r.angle=a,o.setIgnoreSolid()}}for(let o of Xe(t.x,t.y,i))e.spawn("AirFistRange").setPosition(o)}var St=class{constructor(t,i){this.g=t;this.campaign=i;this.dirty=!0,this.examining=[]}refresh(){this.dirty=!0}init(){let{g:t}=this;this.examineAt=void 0,this.examining=[],this.waves=Ve(),t.blankMap();let{width:i,height:o}=G(t,t.player);t.player.move(B(t.mapWidth/2-i/2),t.mapHeight-o-4),Je(t),this.nextWave()}nextWave(){let t=this.waves.shift();if(t){let i=this.waves.length===0?this.campaign.currentSector.star:void 0;this.g.fire("waveBegin",{wave:t,difficulty:this.campaign.difficulty,pilot:i})}}draw(){let{map:t,mapWidth:i,mapHeight:o,overlays:r,term:n}=this.g;for(let s=0;s<o;s++)for(let a=0;a<i;a++){let l=t.grid[s][a];n.drawChar(a,s,0,l.fg,l.bg)}if(this.g.fire("draw",void 0),this.dirty=!1,this.showOverlay){let s=r.get(this.showOverlay);if(s)for(let a=0;a<o;a++)for(let l=0;l<i;l++){let p=s.get({x:l,y:a})||1/0,f=p===1/0?"-":p<10?`${p}`:"*";n.drawChar(l,a,f,V.Colors.LIGHT_RED)}}if(this.examineAt){ei(this.g,this.examineAt,this.examining);for(let s of this.examining){let{motion:a,position:l}=s;if(a&&l){let[p,f]=j(a),h={x:l.x+p,y:l.y+f},d=Ft(A(l),A(h));for(let u of d)n.drawCell(u.x,u.y,{bg:V.Colors.DARK_RED},V.BlendMode.Add)}}}}update(){(this.g.term.mouse.dx||this.g.term.mouse.dy)&&this.refresh(),this.handleKeys(),this.dirty&&(this.handleMouseMove(),this.draw())}examine(t){this.examineAt=t,this.dirty=!0;let{solid:i,other:o}=this.g.getContents(t),r=new Set;i&&r.add(this.g.getRoot(i));for(let n of o)r.add(this.g.getRoot(n));this.examining=[...r]}handleMouseMove(){let{x:t,y:i}=this.g.term.mouse;this.examine({x:t,y:i})}handleKeys(){let{player:t,term:i}=this.g,o=i.getMovementKey();if(o){this.g.fire("playerMove",{move:o});return}if(i.isKeyPressed(V.Key.VK_1)){this.g.fire("playerFire",{array:0});return}if(i.isKeyPressed(V.Key.VK_2)){this.g.fire("playerFire",{array:1});return}if(i.isKeyPressed(V.Key.VK_F)){ii(this.g,st(this.g,t),4.5),this.g.tick();return}}};var vt=class{constructor(t,i,o){this.width=t;this.height=i;this.grid=[];for(let r=0;r<i;r++){let n=[];for(let s=0;s<t;s++)n.push(o(s,r));this.grid.push(n)}}contains({x:t,y:i}){return t>=0&&t<this.width&&i>=0&&i<this.height}get({x:t,y:i}){return this.grid[i][t]}getPositions(){let t=[];for(let i=0;i<this.height;i++)for(let o=0;o<this.width;o++)t.push({x:o,y:i});return t}};var mo={name:"Bodini",star:!0,difficulty:4,body:3,mind:2,spirit:3,talent:2,class:["Psychic"]},fo={name:"Star Pilot B",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},co={name:"Star Pilot C",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},ho={name:"Star Pilot D",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},uo={name:"Star Pilot E",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},yo={name:"Star Pilot F",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},go=[mo,fo,co,ho,uo,yo],oi=go;var Ht=class{constructor(t,i,o){this.g=t;this.shipPrefab=i;this.pilot=o;this.dirty=!0}get currentSector(){return this.space.get(this.position)}refresh(){this.dirty=!0}init(){let{g:t}=this;t.clearEventHandlers(),t.entities.clear(),t.player=this.makePlayer(),this.difficulty=0,this.position={x:2,y:2},this.space=new vt(5,5,()=>({completed:!1}));let i=new Set,o=this.space.getPositions().filter(r=>!W(this.position,r));for(;i.size<6;){let r=I(oi);if(!i.has(r)){i.add(r);let n=I(o),s=this.space.get(n);s.star=r;let a=o.indexOf(n);o.splice(a,1)}}}startCombat(){this.g.setMode(new St(this.g,this))}endCombat(){this.currentSector.completed=!0,this.difficulty++,this.g.mode=this,this.refresh()}makePlayer(){let{g:t,shipPrefab:i,pilot:o}=this,r=t.spawn(i);if(!r.ship)throw new Error(`Ship prefab ${i} doesn't have a ship component!`);return Bt(r,o),dt(r.ship),r}draw(){let{term:t}=this.g;t.clear();let i=this.space.get(this.position),o=t.width/2;t.drawCenteredString(o,2,"Known Space",k.Colors.WHITE),i.completed||t.drawCenteredString(o,4,"Hit Enter to fight!",k.Colors.WHITE);let r=(t.width-25)/2,n=(t.height-25)/2;for(let s=0;s<5;s++){let a=n+s*5;for(let l=0;l<5;l++){let p=r+l*5,f={x:l,y:s},h=this.space.get(f);t.fillRect(p,a,5,5," ",void 0,h.completed?k.Colors.BLACK:k.Colors.DARK_RED),t.drawSingleBox(p,a,5,5,k.Colors.WHITE),W(f,this.position)?t.drawChar(p+2,a+2,"@",k.Colors.LIGHT_CYAN):h.star&&t.drawChar(p+2,a+2,"*",k.Colors.YELLOW)}}this.dirty=!1}handleKeys(){let t=this.space.get(this.position);!t.completed&&(this.g.term.isKeyPressed(k.Key.VK_ENTER)||this.g.term.isKeyPressed(k.Key.VK_NUMPAD_ENTER))&&this.startCombat();let i=this.g.term.getMovementKey();if(t.completed&&i){let o=D(this.position,i);this.space.contains(o)&&(this.position=o,this.dirty=!0)}}update(){this.handleKeys(),this.dirty&&this.draw()}};var Dt=class{constructor(t,i=5,o=100){this.g=t;this.starfieldSpeed=i;this.starCount=o}refresh(){this.dirty=!0}init(){this.dirty=!0,this.pilot={name:"Player",difficulty:NaN,body:1,mind:1,spirit:1,talent:1,class:[]},this.points=6,this.starfieldCounter=0,this.stars=[];for(let t=0;t<this.starCount;t++)this.stars.push(this.newStar())}draw(){let{term:t}=this.g;t.clear();for(let s of this.stars){let{x:a,y:l}=A(s);t.drawChar(a,l,s.c,s.fg)}let i=t.width/2;t.drawCenteredString(i,2,"Bullet Hell Roguelike",g.Colors.WHITE),t.drawCenteredString(i,9,"Create your Pilot",g.Colors.WHITE),t.drawCenteredString(i,10,`${this.points} points`,g.Colors.YELLOW);let o=2,r=Math.floor((t.width-o*2)/4),n=o+r/2;this.drawStat("body",n),this.drawStat("mind",n+r),this.drawStat("spirit",n+r*2),this.drawStat("talent",n+r*3),this.points===0&&t.drawCenteredString(i,20,"Hit Enter to begin!",g.Colors.WHITE),this.dirty=!1}drawStat(t,i){let{term:o}=this.g,r=`(${t[0].toUpperCase()})${t.slice(1)}`,n=this.pilot[t];o.drawCenteredString(i,13,r,g.Colors.LIGHT_CYAN),o.drawCenteredString(i,14,n.toString(),Rt[n])}update(){this.handleStarfield(),this.handleKeys(),this.dirty&&this.draw()}newStar(){let{term:t}=this.g,i=I([g.Colors.DARK_RED,g.Colors.LIGHT_RED,g.Colors.YELLOW,g.Colors.LIGHT_CYAN,g.Colors.WHITE]),o=.5+Math.random(),r=o<.75?".":o<1.25?m.Dot:"*",n=Math.random()*Math.PI*2;return{x:t.width/2,y:t.height/2,c:r,fg:i,vel:o,angle:n}}handleStarfield(){if(this.starfieldCounter<this.starfieldSpeed){this.starfieldCounter++;return}this.starfieldCounter=0,this.dirty=!0;let{width:t,height:i}=this.g.term;for(let o of this.stars){let[r,n]=j(o);o.x+=r,o.y+=n,(o.x<0||o.x>=t||o.y<0||o.y>=i)&&Object.assign(o,this.newStar())}}isPressed(t,i){let o=this.g.term.isKeyDown(g.Key.VK_SHIFT_LEFT)||this.g.term.isKeyDown(g.Key.VK_SHIFT_RIGHT);return this.g.term.isKeyPressed(t)&&i===o}changeStat(t,i){let o=this.pilot[t]+i;if(o<1||o>6)return!1;this.points-=i,this.pilot[t]=o,this.dirty=!0}handleKeys(){this.points>0&&(this.isPressed(g.Key.VK_B,!1)&&this.changeStat("body",1),this.isPressed(g.Key.VK_M,!1)&&this.changeStat("mind",1),this.isPressed(g.Key.VK_S,!1)&&this.changeStat("spirit",1),this.isPressed(g.Key.VK_T,!1)&&this.changeStat("talent",1)),this.isPressed(g.Key.VK_B,!0)&&this.changeStat("body",-1),this.isPressed(g.Key.VK_M,!0)&&this.changeStat("mind",-1),this.isPressed(g.Key.VK_S,!0)&&this.changeStat("spirit",-1),this.isPressed(g.Key.VK_T,!0)&&this.changeStat("talent",-1),this.points===0&&(this.g.term.isKeyPressed(g.Key.VK_ENTER)||this.g.term.isKeyPressed(g.Key.VK_NUMPAD_ENTER))&&this.g.setMode(new Ht(this.g,"PlayerShip",this.pilot))}};var Mt=class{constructor(t){this.keyFn=t;this.items=new Map}has(t){return this.items.has(this.keyFn(t))}get(t){return this.items.get(this.keyFn(t))}getOrDefault(t,i){let o=this.items.get(this.keyFn(t));return typeof o!="undefined"?o:i}getOrDie(t){let i=this.keyFn(t),o=this.items.get(i);if(typeof o=="undefined")throw new Error(`Invalid key: ${i}`);return o}set(t,i){this.items.set(this.keyFn(t),i)}};function ve(e,t,i=1/0){let o=[],r=new Mt(n=>`${n.x},${n.y}`);for(let n of e)o.push(n),r.set(n,0);for(;o.length;){let n=o.shift(),s=r.getOrDie(n)+1;if(!(s>i))for(let a of Zt(n))!r.has(a)&&t(a)&&(r.set(a,s),o.push(a))}return r}function He(e){return typeof e!="undefined"}var Tt=class{constructor(t,i,o){this.term=t;this.mapWidth=i;this.mapHeight=o;t.update=this.update.bind(this),this.map=new ri.Console(i,o,()=>!0),this.lastEntityId=0,this.entities=new ht(Be),this.overlays=new Map,this.clearEventHandlers(),this.setMode(new Dt(this))}setMode(t){this.mode=t,this.mode.init()}clearEventHandlers(){this.eventCallbacks=Re(Le.map(t=>[t,[]]))}fire(t,i){for(let o of this.eventCallbacks[t])o(i)}on(t,i){this.eventCallbacks[t].push(i)}spawn(t){return Qt(this,t)}refresh(){this.mode.refresh()}add(t){return this.refresh(),this.entities.add(t),this.fire("spawn",{e:t}),t}kill(t,i){t.alive&&(t.kill(i),this.fire("kill",{e:t,reason:i}))}move(t,i){let o=t.position;t.move(i.x,i.y),o&&this.fire("move",{e:t,old:o,pos:i})}blankMap(){let{map:t,mapHeight:i,mapWidth:o}=this;t.clear();for(let r=0;r<i;r++)for(let n=0;n<o;n++)t.setBlocked(n,r,!1),t.setBlockedSight(n,r,!1);t.computeFov(0,0,1/0)}drawIfVisible(t,i,o,r,n,s){this.map.isVisible(t,i)&&(s?this.term.drawCell(t,i,{bg:n},s):this.term.drawChar(t,i,o,r,n))}getRoot(t){return t.attachment?this.getRoot(t.attachment.parent):t}getContents(t,i=[]){let o=A(t);if(!this.inBounds(o))return{oob:!0,other:[]};let r=this.map.isBlocked(o.x,o.y),n=this.entities.get().filter(a=>a.position&&W(o,a.position)),s=n.filter(a=>!i.includes(a.id)).find(a=>a.solid);return{wall:r,solid:s,other:n.filter(a=>!a.solid)}}tick(){this.overlays.clear(),this.fire("tick",void 0),this.entities.clearDead()}update(){this.mode.update()}inBounds(t){return t.x>=0&&t.y>=0&&t.x<this.mapWidth&&t.y<this.mapHeight}getDistanceMap(t){let i=`${t.id}.distance`,o=this.overlays.get(i);return o||(o=ve(L(this,t).map(r=>r.position).filter(He),this.inBounds.bind(this)),this.overlays.set(i,o)),o}};function bo(e){let o=Nt.DEFAULT_FONT,r=document.createElement("div");e.appendChild(r);let n=()=>{let p=60*o.charWidth,f=40*o.charHeight,h=Math.floor(window.innerWidth/p),d=Math.floor(window.innerHeight/f),u=Math.min(h,d);r.style.width=`${p*u}px`,r.style.height=`${f*u}px`};window.addEventListener("resize",n),n();let s=document.createElement("canvas");r.appendChild(s),requestAnimationFrame(()=>s.focus());let a=new Nt.Terminal(s,60,40,{font:o}),l=new Tt(a,60,40-pt);window.g=l}window.addEventListener("load",()=>bo(document.body));})();
//# sourceMappingURL=bundle.js.map
