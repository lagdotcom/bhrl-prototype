"use strict";(()=>{var co=Object.create;var Rt=Object.defineProperty;var ho=Object.getOwnPropertyDescriptor;var uo=Object.getOwnPropertyNames,Re=Object.getOwnPropertySymbols,go=Object.getPrototypeOf,Ie=Object.prototype.hasOwnProperty,yo=Object.prototype.propertyIsEnumerable;var Le=(e,t,o)=>t in e?Rt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,F=(e,t)=>{for(var o in t||={})Ie.call(t,o)&&Le(e,o,t[o]);if(Re)for(var o of Re(t))yo.call(t,o)&&Le(e,o,t[o]);return e};var bo=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),J=(e,t)=>{for(var o in t)Rt(e,o,{get:t[o],enumerable:!0})},Po=(e,t,o,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of uo(t))!Ie.call(e,r)&&r!==o&&Rt(e,r,{get:()=>t[r],enumerable:!(i=ho(t,r))||i.enumerable});return e};var S=(e,t,o)=>(o=e!=null?co(go(e)):{},Po(t||!e||!e.__esModule?Rt(o,"default",{value:e,enumerable:!0}):o,e));var E=bo((Yi,ke)=>{ke.exports=globalThis.wglt});var Wt=S(E());var mo=S(E());function ut(e,t=new Map){if(!e||typeof e!="object")return e;if(t.has(e))return t.get(e);let o;if(e.nodeType&&"cloneNode"in e)o=e.cloneNode(!0),t.set(e,o);else if(e instanceof Date)o=new Date(e.getTime()),t.set(e,o);else if(e instanceof RegExp)o=new RegExp(e),t.set(e,o);else if(Array.isArray(e)){o=new Array(e.length),t.set(e,o);for(let i=0;i<e.length;i++)o[i]=ut(e[i],t)}else if(e instanceof Map){o=new Map,t.set(e,o);for(let[i,r]of e.entries())o.set(i,ut(r,t))}else if(e instanceof Set){o=new Set,t.set(e,o);for(let i of e)o.add(ut(i,t))}else if(e instanceof Object){o={},t.set(e,o);for(let[i,r]of Object.entries(e))o[i]=ut(r,t)}else throw Error(`Unable to clone ${e}`);return o}function Ge(e){return ut(e,new Map)}var Z=Ge,Ke=Object.keys,Fe=e=>{let t={};for(let[o,i]of e)t[o]=i;return t};var tt=class{constructor(t,o){this.g=t;this.name=o;this.alive=!0,this.id=++t.lastEntityId,this.solid=!1,this.tags=new Set}applyPrefab(t,o){if(this.prefab=t,o.components&&Object.assign(this,Z(o.components)),o.children)for(let{name:i,x:r,y:n,overlay:s,tags:a}of o.children){let l=this.g.spawn(i).setAttachment({parent:this,x:r,y:n});if(s)for(let p of Ke(s))Object.assign(l[p],Z(s[p]));if(a)for(let p of a)l.tags.add(p)}return this}get[Symbol.toStringTag](){return this.name}kill(t){return this.alive=!1,this.eachChild(o=>this.g.kill(o,t)),this}eachChild(t){var o;for(let i of this.g.entities.get())((o=i.attachment)==null?void 0:o.parent)===this&&t(i,i.attachment)}setAI(t){return this.ai=t,this}setAppearance(t){return this.g.refresh(),this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setDelayedShot(t){return this.delayedShot=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setItem(t){return this.item=t,this}setLastMovement(t){return this.lastMovement=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setOrigin(t){return this.origin=t,this}setPilot(t){return this.pilot=t,this}setPosition(t){return this.g.refresh(),this.position=t,this}setShip(t){return this.ship=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,o){return this.g.refresh(),this.position={x:t,y:o},this.eachChild((i,r)=>i.move(t+r.x,o+r.y)),this}};function Oe(e,t){var r,n,s,a;let o=(n=(r=e.appearance)==null?void 0:r.layer)!=null?n:0,i=(a=(s=t.appearance)==null?void 0:s.layer)!=null?a:0;return o!==i?o-i:e.id-t.id}var Ne=["damage","draw","kill","move","notice","playerFire","playerMove","spawn","tick","waveBegin"];var Ut={};J(Ut,{AcidBullet:()=>Do,BellowMissile:()=>Ro,Bullet:()=>wo,CrushBullet:()=>Co,DroneBullet:()=>Eo,HomingMissile:()=>Ao,OutcryBullet:()=>So,PlayerBullet:()=>Lo,SalvoMissileA:()=>Mo,SalvoMissileB:()=>Bo,SalvoMissileC:()=>To,SmiteMissile:()=>Ho,TalonBullet:()=>vo});var R=S(E());var xo={Heart:"",Diamond:"",Club:"",Dot:"\x07",Ring:"	",RingInvert:`
`,Male:"\v",Female:"\f",DoubleNote:"",Star:"",Pilcrow:"",Silcrow:"",ResizeVertical:"",UpArrow:"",DownArrow:"",RightArrow:"",LeftArrow:"\x1B",DownWedge:"",Pentagon:"\x7F",AHat:"\x83",EHat:"\x88",CapitalUUmlaut:"\x9A",Cent:"\x9B",Yen:"\x9D",CurlyF:"\x9F",NotFlip:"\xA9",Not:"\xAA",InvertedExclamation:"\xAD",Fill1:"\xB0",Fill2:"\xB1",Fill3:"\xB2",BoxVerticalSingle:"\xB3",BoxLeftSingleUpDouble:"\xBD",BoxUpSingleHorizontalSingle:"\xC1",BoxDownSingleHorizontalSingle:"\xC2",BoxHorizontalSingle:"\xC4",BoxUpDoubleHorizontalSingle:"\xD0",BoxDownSingleHorizontalDouble:"\xD1",BoxRightSingleUpDouble:"\xD3",BoxVerticalDoubleHorizontalSingle:"\xD7",Filled:"\xDB",Beta:"\xE1",Gamma:"\xE2",Pi:"\xE3",Theta:"\xE9",Omega:"\xEA",SymbolED:"\xED",SetMember:"\xEE",HorizontalDivide:"\xF6",Approximates:"\xF7",Squared:"\xFD",Square:"\xFE"},m=xo;var We=(a=>(a[a.Effect=0]="Effect",a[a.Item=1]="Item",a[a.Ship=2]="Ship",a[a.Gun=3]="Gun",a[a.Bullet=4]="Bullet",a[a.Player=5]="Player",a[a.PlayerBullet=6]="PlayerBullet",a))(We||{}),b=We;var wo={components:{projectile:{damage:1},appearance:{glyph:m.InvertedExclamation,layer:b.Bullet,fg:R.Colors.YELLOW}}},Eo={components:{projectile:{damage:1},appearance:{glyph:".",layer:b.Bullet,fg:R.Colors.ORANGE}}},So={components:{projectile:{damage:6},appearance:{glyph:"o",layer:b.Bullet,fg:(0,R.fromRgb)(255,55,135)}}},Do={components:{projectile:{damage:6},appearance:{glyph:m.Approximates,layer:b.Bullet,fg:(0,R.fromRgb)(55,55,215)}}},vo={components:{projectile:{damage:6},appearance:{glyph:"`",layer:b.Bullet,fg:(0,R.fromRgb)(135,255,55)}}},Co={components:{projectile:{damage:6},homing:{strength:1,duration:3},appearance:{glyph:m.Square,layer:b.Bullet,fg:(0,R.fromRgb)(175,175,0)}}},Ho={components:{projectile:{damage:2},homing:{strength:10,duration:1},explodes:{size:7,type:"Fire",falloff:1},appearance:{glyph:"*",layer:b.Bullet,fg:R.Colors.ORANGE}}},Ao={components:{projectile:{damage:1},homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:b.Bullet,fg:R.Colors.DARK_RED}}},Mo={components:{projectile:{damage:1},homing:{strength:.15,duration:4},trail:{effectPrefab:"SmokePuff"},explodes:{size:8,type:"Fire",falloff:1},appearance:{glyph:"*",layer:b.Bullet,fg:R.Colors.DARK_RED}}},Bo={components:{projectile:{damage:1},homing:{strength:.25,duration:5},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:b.Bullet,fg:R.Colors.DARK_RED}}},To={components:{projectile:{damage:1},homing:{strength:.35,duration:8},trail:{effectPrefab:"SmokePuff"},explodes:{size:4,type:"Fire",falloff:1},appearance:{glyph:"*",layer:b.Bullet,fg:R.Colors.DARK_RED}}},Ro={components:{projectile:{damage:20},homing:{strength:.15,duration:30},trail:{effectPrefab:"SmokePuff"},explodes:{size:10,type:"Fire",falloff:1},appearance:{glyph:m.CurlyF,layer:b.Bullet,fg:R.Colors.LIGHT_RED}}},Lo={components:{projectile:{damage:3},appearance:{glyph:"!",layer:b.PlayerBullet,fg:R.Colors.YELLOW}}};var Vt={};J(Vt,{AirFistRange:()=>Io,SmokePuff:()=>ko});var pt=S(E());var Io={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:b.Effect,bg:(0,pt.fromRgb)(0,255,255,100),blendMode:pt.BlendMode.Add}}},ko={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:b.Effect,bg:(0,pt.fromRgb)(100,100,100,50),blendMode:pt.BlendMode.Add}}};var jt={};J(jt,{AcidSplash:()=>_o,Bellow:()=>Xo,Cleave:()=>No,CrushPattern:()=>Yo,DemandHomage:()=>Jo,DroneGun:()=>zo,Outcry:()=>Wo,PeaShooter:()=>Fo,PlayerGun:()=>Oo,Salvo:()=>qo,ShuttleLaunch:()=>Uo,Smite:()=>$o,TalonSwipe:()=>jo,TheDragonWakes:()=>Qo,Veto:()=>Vo});var c=(e,t,o,i,r)=>({name:e,x:t,y:o,overlay:i,tags:r}),A=(e,t,o,i=0)=>({name:e,type:t,maxHp:o,hp:0,maxShield:i,shield:0,shieldTimer:0}),M=(e,{salvoCount:t=1,timeBetweenShots:o=1,timeBetweenSalvos:i=1,ammunition:r=1/0},n)=>({name:e,bullets:n,salvoCount:t,timeBetweenShots:o,timeBetweenSalvos:i,timer:0,salvo:t,ammunition:r}),h=(e,t,o,i,{delay:r,offset:n,beam:s}={})=>({name:e,prefab:t,angle:o,vel:i,delay:r,offset:n,beam:s});var et=Math.PI/2,Lt=et/2,Go={Right:0,DownRight:Lt,Down:et,DownLeft:et+Lt,Left:et*2,UpLeft:et*2+Lt,Up:et*3,UpRight:et*3+Lt},u=Go;function O(e){return typeof e=="undefined"?NaN:Math.floor(e)}var d=(e,t)=>({x:e,y:t});function I(e){return d(O(e.x),O(e.y))}function j(e,t){if(typeof e=="undefined"||typeof t=="undefined")return!1;let o=I(e),i=I(t);return o.x===i.x&&o.y===i.y}function B(e,t){return d(e.x+t.x,e.y+t.y)}var Ko={Right:d(1,0),DownRight:d(1,1),Down:d(0,1),DownLeft:d(-1,1),Left:d(-1,0),UpLeft:d(-1,-1),Up:d(0,-1),UpRight:d(1,-1),None:d(0,0)},N=Ko;var Fo={components:{turret:M("Pea Shooter",{salvoCount:1,timeBetweenSalvos:3},[h("Bullet","Bullet",u.Down,2)])}},Oo={components:{turret:M("Pew Pew",{salvoCount:2,timeBetweenShots:0,timeBetweenSalvos:3},[h("Your Bullet","PlayerBullet",u.Up,2)])}},No={components:{turret:M("Cleave",{salvoCount:5,timeBetweenSalvos:11},[h("Bullet","Bullet",u.Down,2)])}},Wo={components:{turret:M("Outcry",{salvoCount:1,timeBetweenSalvos:8},[h("Outcry","OutcryBullet",u.DownLeft,2),h("Outcry","OutcryBullet",u.Left,2),h("Outcry","OutcryBullet",u.UpLeft,2),h("Outcry","OutcryBullet",u.Up,2),h("Outcry","OutcryBullet",u.UpRight,2),h("Outcry","OutcryBullet",u.Right,2),h("Outcry","OutcryBullet",u.DownRight,2)])}},_o={components:{turret:M("Acid Splash",{salvoCount:1,timeBetweenSalvos:13},[h("Acid Splash","AcidBullet",u.UpLeft,2),h("Acid Splash","AcidBullet",u.UpRight,2),h("Acid Splash","AcidBullet",u.Left,2,{delay:1}),h("Acid Splash","AcidBullet",u.Right,2,{delay:1}),h("Acid Splash","AcidBullet",u.DownLeft,2,{delay:2}),h("Acid Splash","AcidBullet",u.DownRight,2,{delay:2}),h("Acid Splash","AcidBullet",u.Left,2,{delay:3}),h("Acid Splash","AcidBullet",u.Right,2,{delay:3}),h("Acid Splash","AcidBullet",u.UpLeft,2,{delay:4}),h("Acid Splash","AcidBullet",u.UpRight,2,{delay:4})])}},Uo={components:{turret:M("Shuttle Launch",{salvoCount:1,timeBetweenSalvos:27},[h("Runabout","DroneA",u.Left,0,{offset:N.Left}),h("Runabout","DroneA",u.Right,0,{offset:N.Right})])}},Vo={components:{turret:M("Veto",{salvoCount:1,timeBetweenSalvos:21},[h("Veto","HomingMissile",u.Up,1),h("Wasp","DroneB",u.DownRight,0,{offset:N.DownRight})])}},jo={components:{turret:M("Talon Swipe",{salvoCount:3,timeBetweenSalvos:10},[h("Talon Swipe","TalonBullet",u.Left,2),h("Talon Swipe","TalonBullet",u.Right,2)])}},Yo={components:{turret:M("Crush Pattern",{salvoCount:1,timeBetweenSalvos:15},[h("Crush Pattern","CrushBullet",u.Left,1),h("Crush Pattern","CrushBullet",u.UpLeft,1),h("Crush Pattern","CrushBullet",u.UpRight,1),h("Crush Pattern","CrushBullet",u.Right,1)])}},$o={components:{turret:M("Smite",{salvoCount:2,timeBetweenSalvos:16},[h("Smite","SmiteMissile",u.Right,1)])}},zo={components:{turret:M("Stinger",{salvoCount:1,timeBetweenSalvos:5,ammunition:5},[h("Bullet","DroneBullet","nearestEnemy",1)])}},qo={components:{turret:M("Salvo",{salvoCount:1,timeBetweenSalvos:10},[h("Missile","SalvoMissileA",u.UpLeft,1),h("Missile","SalvoMissileB",u.UpLeft,1),h("Missile","SalvoMissileC",u.UpLeft,1)])}},Qo={components:{turret:M("The Dragon Wakes",{salvoCount:1,timeBetweenSalvos:12},[h("Drone","DroneA",u.Up,0,{offset:N.Up}),h("Missile","HomingMissile",u.DownLeft,2,{offset:N.DownLeft}),h("Missile","HomingMissile",u.DownRight,2,{offset:N.DownRight})])}},Xo={components:{turret:M("Bellow",{salvoCount:1,timeBetweenSalvos:17},[h("Missile","BellowMissile",u.DownLeft,1),h("Bullet","Bullet",u.Down,2),h("Bullet","Bullet",u.Down,2,{delay:1}),h("Bullet","Bullet",u.Down,2,{delay:2}),h("Bullet","Bullet",u.Down,2,{delay:3})])}},Jo={components:{turret:M("Demand Homage",{salvoCount:1,timeBetweenSalvos:21},[h("Pulsar","DroneC",u.DownLeft,0,{offset:N.DownLeft}),h("Pulsar","DroneC",u.UpLeft,0,{offset:N.UpLeft}),h("Pulsar","DroneC",u.UpRight,0,{offset:N.UpRight}),h("Pulsar","DroneC",u.DownRight,0,{offset:N.DownRight})])}};var Yt={};J(Yt,{BombItem:()=>Zo,DoubleItem:()=>ti,DrainItem:()=>ei,HealItem:()=>oi,JunkItem:()=>ii,MoneyItem:()=>ri,RechargeItem:()=>ni});var Zo={components:{appearance:{glyph:m.DoubleNote,layer:b.Item},item:{type:"bomb"}}},ti={components:{appearance:{glyph:m.Squared,layer:b.Item},item:{type:"double"}}},ei={components:{appearance:{glyph:"%",layer:b.Item},item:{type:"drain"}}},oi={components:{appearance:{glyph:m.Heart,layer:b.Item},item:{type:"heal"}}},ii={components:{appearance:{glyph:m.Beta,layer:b.Item},item:{type:"junk"}}},ri={components:{appearance:{glyph:m.SetMember,layer:b.Item},item:{type:"money",value:0}}},ni={components:{appearance:{glyph:"@",layer:b.Item},item:{type:"recharge"}}};var zt={};J(zt,{PlayerHull:()=>si,PlayerShip:()=>ai});var $t=S(E());var si={components:{solid:!0,appearance:{glyph:"#",layer:b.Player,fg:$t.Colors.DARK_GRAY}}},ai={components:{player:{weaponArrays:["Primary","Secondary"]},ship:A("Ace of Clubs","Battleship",20,10)},children:[c("PlayerHull",0,0,{appearance:{glyph:m.LeftArrow}}),c("PlayerHull",1,0,{appearance:{glyph:m.Club,fg:$t.Colors.LIGHT_GRAY}}),c("PlayerHull",2,0,{appearance:{glyph:m.RightArrow}}),c("PlayerGun",1,0,void 0,["Primary"]),c("Sword",1,0,void 0,["Secondary"])]};var Xt={};J(Xt,{AtomSmasher:()=>vi,CruiseyWing:()=>xi,Demigod:()=>Si,DroneA:()=>yi,DroneB:()=>bi,DroneC:()=>Pi,GoutOFlame:()=>Ei,Gremlin:()=>Di,Hull:()=>li,Olm:()=>wi,ShipA:()=>pi,ShipB:()=>mi,ShipC:()=>fi,ShipD:()=>ci,ShipE:()=>hi,ShipF:()=>ui,ShipG:()=>di,ShipH:()=>gi});var _e=S(E());var li={components:{solid:!0,appearance:{glyph:"#",layer:b.Ship,fg:_e.Colors.DARK_GRAY}}},k={idealDistance:8,firingDistance:14,speed:1},q=c("PeaShooter",0,0),pi={components:{ai:k,ship:A("Axle","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:m.Pilcrow}}),q,c("Cleave",0,0)]},mi={components:{ai:k,ship:A("Baying Hound","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:m.Yen}}),q,c("Outcry",0,0)]},fi={components:{ai:k,ship:A("Caustic","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:"W"}}),q,c("AcidSplash",0,0)]},ci={components:{ai:k,ship:A("Defiant","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:m.Omega}}),q,c("ShuttleLaunch",0,0)]},hi={components:{ai:k,ship:A("Executor","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:m.DownWedge}}),q,c("Veto",0,0)]},ui={components:{ai:k,ship:A("Falcon","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:m.Pi}}),q,c("TalonSwipe",0,0)]},di={components:{ai:k,ship:A("Gauntlet","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:"M"}}),q,c("CrushPattern",0,0)]},gi={components:{ai:k,ship:A("Halo","Escort",2)},children:[c("Hull",0,0,{appearance:{glyph:m.Female}}),q,c("Smite",0,0)]},qt={idealDistance:5,firingDistance:6,speed:1},Qt=c("DroneGun",0,0),yi={components:{ai:qt,ship:A("Runabout","Escort",1)},children:[c("Hull",0,0,{appearance:{glyph:m.Theta}}),Qt]},bi={components:{ai:qt,ship:A("Wasp","Escort",1)},children:[c("Hull",0,0,{appearance:{glyph:m.SymbolED}}),Qt]},Pi={components:{ai:qt,ship:A("Pulsar","Escort",1)},children:[c("Hull",0,0,{appearance:{glyph:m.Silcrow}}),Qt]},xi={components:{ai:k,ship:A("Cruisey Wing","Battleship",10,5)},children:[c("Hull",0,0,{appearance:{glyph:m.Not}}),c("Hull",1,0,{appearance:{glyph:m.HorizontalDivide}}),c("Hull",2,0,{appearance:{glyph:m.NotFlip}}),c("PeaShooter",0,0),c("PeaShooter",1,0),c("PeaShooter",2,0),c("Salvo",1,0)]},wi={components:{ai:k,ship:A("Olm","Battleship",15,4)},children:[c("Hull",0,0,{appearance:{glyph:m.Cent}}),c("Hull",0,1,{appearance:{glyph:m.ResizeVertical}}),c("Hull",0,2,{appearance:{glyph:m.BoxDownSingleHorizontalDouble}}),c("TheDragonWakes",0,0)]},Ei={components:{ai:k,ship:A("Gout-'o-flame","Battleship",5,20)},children:[c("Hull",0,0,{appearance:{glyph:m.Pentagon}}),c("Hull",1,0,{appearance:{glyph:m.BoxVerticalDoubleHorizontalSingle}}),c("Hull",2,0,{appearance:{glyph:m.Pentagon}}),c("Hull",1,1,{appearance:{glyph:m.BoxUpDoubleHorizontalSingle}}),c("PeaShooter",1,1),c("Bellow",1,1)]},Si={components:{ai:k,ship:A("Demigod","Battleship",30,15)},children:[c("Hull",1,0,{appearance:{glyph:m.CapitalUUmlaut}}),c("Hull",0,1,{appearance:{glyph:"}"}}),c("Hull",1,1,{appearance:{glyph:m.RingInvert}}),c("Hull",2,1,{appearance:{glyph:"{"}}),c("Hull",1,2,{appearance:{glyph:"Y"}}),c("PeaShooter",1,2),c("DemandHomage",1,1)]},Di={components:{ai:k,ship:A("Gremlin","Battleship",30,15)},children:[c("Hull",1,0,{appearance:{glyph:m.ResizeVertical}}),c("Hull",2,0,{appearance:{glyph:m.ResizeVertical}}),c("Hull",0,1,{appearance:{glyph:"]"}}),c("Hull",1,1,{appearance:{glyph:m.BoxLeftSingleUpDouble}}),c("Hull",2,1,{appearance:{glyph:m.BoxRightSingleUpDouble}}),c("Hull",3,1,{appearance:{glyph:m.Male}}),c("Hull",1,2,{appearance:{glyph:m.BoxVerticalSingle}}),c("Hull",2,2,{appearance:{glyph:m.Gamma}}),c("PeaShooter",1,2),c("PeaShooter",2,2)]},vi={components:{ai:k,ship:A("Atom Smasher","Battleship",10,20)},children:[c("Hull",1,0,{appearance:{glyph:m.EHat}}),c("Hull",2,0,{appearance:{glyph:"-"}}),c("Hull",3,0,{appearance:{glyph:m.AHat}}),c("Hull",0,1,{appearance:{glyph:m.Fill2}}),c("Hull",1,1,{appearance:{glyph:m.Fill1}}),c("Hull",2,1,{appearance:{glyph:m.Fill2}}),c("Hull",3,1,{appearance:{glyph:m.Fill3}}),c("Hull",4,1,{appearance:{glyph:m.Filled}}),c("PeaShooter",0,1),c("PeaShooter",1,1),c("PeaShooter",2,1),c("PeaShooter",3,1),c("PeaShooter",4,1)]};var Jt={};J(Jt,{Sword:()=>Hi,SwordBullet:()=>Ci});var ot=S(E());var Ci={components:{projectile:{damage:5,special:"increasedDropChance"},appearance:{glyph:m.Star,layer:b.PlayerBullet,fg:ot.Colors.LIGHT_GREEN}}},Hi={components:{turret:M("Sword",{salvoCount:1,timeBetweenSalvos:20},[h("Stab","SwordBullet","lastMovement",1,{beam:{duration:2,appearance:[{glyph:m.Star,fg:ot.Colors.LIGHT_GREEN},{glyph:"o",fg:ot.Colors.LIGHT_GREEN},{glyph:m.Diamond,fg:ot.Colors.LIGHT_GREEN},{glyph:m.Ring,fg:ot.Colors.DARK_GREEN},{glyph:m.Dot,fg:ot.Colors.DARK_GRAY}]}})])}};var Ai=F(F(F(F(F(F(F({},Ut),Vt),Yt),jt),zt),Xt),Jt);function Zt(e,t){return e.add(new tt(e,t).applyPrefab(t,Ai[t]))}var dt=class{constructor(t,o=[]){this.compareFn=t;this.entities=o;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}add(t){this.entities.push(t),this.dirty=!0}clearDead(){this.entities=this.entities.filter(t=>t.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var x=S(E());var W=S(E());var z=S(E());function Mi(e,t){if(!t||!e.length)throw new Error("Could not get midpoint");let o=i=>e.reduce((r,{offset:n})=>r+n[i],0)/e.length;return d(t.x+o("x"),t.y+o("y"))}function Bi(e,t,o,i=[]){let r=[];for(let{offset:n}of t){let s=B(o,n),{oob:a,wall:l,solid:p}=e.getContents(s,i);a?r.push({absolute:s,offset:n,entity:"oob"}):l?r.push({absolute:s,offset:n,entity:"wall"}):p&&r.push({absolute:s,offset:n,entity:p})}return r}function G(e,t){let o=e.getRoot(t);return e.entities.get().filter(i=>e.getRoot(i)===o)}function gt(e,t){return G(e,t).map(o=>o.id)}function _(e,t){var a;let o=(a=e.getRoot(t).position)!=null?a:d(0,0),i=G(e,t),r=[],n=0,s=0;for(let l of i){let{attachment:p,solid:f}=l;if(p&&f){let{x:g,y}=p;r.push({absolute:B(o,p),offset:{x:g,y},entity:l}),n=Math.max(g+1,n),s=Math.max(y+1,s)}}return{layout:r,topLeft:o,width:n,height:s}}function Ue(e,t,o){let i=gt(e,t),{layout:r,topLeft:n}=_(e,t);return!o||!n?[]:Bi(e,r,o||n,i)}function Q(e,t){let{layout:o,topLeft:i}=_(e,t);if(!i||!o.length)throw new Error(`Could not get midpoint of entity#${t.id}`);return Mi(o,i)}function Ve(e,t,o,i,r){for(let n=0;n<r;n++)for(let s=0;s<i;s++){let{oob:a,wall:l,solid:p,other:f}=e.getContents({x:t+s,y:o+n});if(a||l||p||f.length)return!1}return!0}var D=class{constructor(t,o){this.list=t;this.filter=o}matches(t){if(!t.alive)return!1;for(let o of this.filter)if(!t[o])return!1;return!0}forEach(t){for(let o of this.list.get())this.matches(o)&&t(o,o)}};var te=Math.PI*2;function U(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}function je(e,t){let o=(e-t)%te,i=(t-e)%te;return o<i?-o:i}function X(e){let t=Math.cos(e.angle)*e.vel,o=Math.sin(e.angle)*e.vel;return[t,o]}function Ye(e){for(;e<0;)e+=te;return e}var ee=[d(-1,-1),d(-1,0),d(-1,1),d(0,1),d(1,1),d(1,0),d(1,-1),d(0,-1)];function oe(e){return ee.map(t=>B(e,t))}function K(e){if(!e.length)throw new Error("oneOf passed empty array");return e[Math.floor(Math.random()*e.length)]}function ie(e){let t=new D(e.entities,["ai","position"]);e.on("tick",function(){t.forEach(({ai:i,position:r},n)=>{n.setLastMovement(),i.attacking||(i.attacking=e.player,e.fire("notice",{e:n,noticed:e.player}));let s=gt(e,n),{layout:a}=_(e,n),l=I(r),p=e.getDistanceMap(i.attacking),f=w=>{let{oob:v,solid:H,wall:ht}=e.getContents(w,s);return!v&&!H&&!ht},g=w=>f(w)?Math.abs(p.getOrDefault(w,1/0)-i.idealDistance):1/0,y=w=>a.reduce((v,{offset:H})=>v+g(B(w,H)),0)/a.length,P=y(l),C=[];for(let w of ee){let v=B(l,w);if(!p.has(v))continue;let H=y(v);H<P?(P=H,C=[v]):H===P&&C.push(v)}if(C.length){let w=K(C);n.move(w.x,w.y),n.setLastMovement({angle:U(l,w)});return}})}),e.on("damage",function({e:i,source:r}){r.owner&&i!==r.owner&&i.ai&&!i.ai.attacking&&r.owner.alive&&(i.ai.attacking=r.owner)})}var $e=(n=>(n[n.None=0]="None",n[n.Healthy=1]="Healthy",n[n.Double=2]="Double",n[n.Drain=4]="Drain",n[n.HasPilot=8]="HasPilot",n))($e||{}),T=$e;var ze=["Berserker","Chopter","Duelist","Engineer","Fighter","Negotiator","Psychic","Smuggler"];var L=S(E()),It=[0,L.Colors.DARK_RED,L.Colors.BROWN,L.Colors.LIGHT_RED,L.Colors.ORANGE,L.Colors.YELLOW,L.Colors.WHITE],Y={Typical:{fg:L.Colors.DARK_GRAY},Healthy:{fg:L.Colors.DARK_GREEN},Double:{fg:L.Colors.LIGHT_GRAY},Multi:{fg:L.Colors.DARK_MAGENTA},Drain:{fg:L.Colors.DARK_RED},StarPilot:{fg:L.Colors.YELLOW},Mega:{fg:L.Colors.BLACK,bg:L.Colors.DARK_MAGENTA}};function re(e,t=0){let o=[];for(let i=t;i<e;i++)o.push(i);return o}function kt(e,t){let{ship:o}=e;if(!o)throw new Error(`Cannot put pilot into entity ${e.name} (no ship)`);e.setPilot(t),o.maxHp+=t.body}function mt(e){for(let t=e.length-1;t>0;t--){let o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function Gt(e,...t){return e.filter(o=>!t.includes(o))}var ae={Typical:T.None,Healthy:T.Healthy,Double:T.Double,Multi:T.Healthy|T.Double,Drain:T.Drain,StarPilot:T.HasPilot,Mega:T.Healthy|T.Double|T.Drain|T.HasPilot},ne=["ShipA","ShipB","ShipC","ShipD","ShipE","ShipF","ShipG","ShipH"],se=["CruiseyWing","Olm","GoutOFlame","Demigod","Gremlin","AtomSmasher"],Ti=[{name:"Let Fate Decide",difficulty:1,groups:[{count:7,prefabs:ne},{count:1,prefabs:se}]},{name:"Court Martial",difficulty:2,groups:[{count:5,prefabs:["ShipA","ShipE"]},{count:1,prefabs:["CruiseyWing"]}]},{name:"Hellhounds",difficulty:3,groups:[{count:2,prefabs:["ShipB"]},{count:2,prefabs:["GoutOFlame"]}]},{name:"Chaos",difficulty:4,groups:[{count:4,prefabs:["ShipC"]},{count:4,prefabs:Gt(ne,"ShipC")},{count:1,prefabs:["Demigod"]}]},{name:"Fly in Formation",difficulty:4,groups:[{count:7,prefabs:["ShipF"]},{count:1,prefabs:se}]},{name:"Hark!",difficulty:6,groups:[{count:3,prefabs:["ShipH"]},{count:3,prefabs:Gt(ne,"ShipH")},{count:1,prefabs:["Demigod"]}]},{name:"Caverns.com",difficulty:7,groups:[{count:1,prefabs:["ShipA","ShipG"]},{count:3,prefabs:["Olm"]}]},{name:"Humanity to the Rescue",difficulty:8,groups:[{count:7,prefabs:["ShipA","ShipD","ShipE","ShipG"]},{count:1,prefabs:["GoutOFlame"]}]},{name:"Wild Hunt",difficulty:9,groups:[{count:15,prefabs:["ShipB","ShipF"]},{count:1,prefabs:["Olm"]}]},{name:"Arm Wrestling",difficulty:10,groups:[{count:9,prefabs:["ShipG"]},{count:2,prefabs:["CruiseyWing"]}]},{name:"Valis",difficulty:11,groups:[{count:4,prefabs:["ShipC"]},{count:4,prefabs:["ShipH"]},{count:1,prefabs:se}]}];function qe(e=3){return mt(Ti.slice()).slice(0,e).sort((t,o)=>t.difficulty-o.difficulty)}function Qe(e,t){return Math.random()*100>=e?t?"StarPilot":"Typical":t?"Mega":K(["Healthy","Double","Multi","Drain"])}function Ri(e){let t=Z(e);for(;t.class.length<t.talent;)t.class.push(K(ze.filter(o=>!t.class.includes(o))));return t}function Xe(e,t,o,i){let r=ae[o];if(r&T.HasPilot&&!i)throw new Error(`power ${o} needs pilot, none given`);let n=e.spawn(t),{ship:s}=n;if(!s)throw new Error(`Ship prefab ${t} doesn't have a ship component!`);if(s.power=o,r&T.Healthy&&(s.maxHp=s.maxHp*2+3),i){let l=Ri(i);kt(n,l)}yt(s);let a=Y[o];for(let l of G(e,n))l.appearance&&Object.assign(l.appearance,a);return n}function Je(e,t){let{width:o,height:i}=_(e,t);for(let r=0;r<e.term.height;r++){let n=mt(re(e.term.width-o));for(let s of n)if(Ve(e,s,r,o,i))return{x:s,y:r}}throw new Error(`Could not find ${o}x${i} spawn location`)}function yt(e){e.hp=e.maxHp,e.shield=e.maxShield}function le(e){return e.salvo<=0?e.ammunition<=0?"Spent":"Reloading":e.timer>0?"Chambering":"Ready"}function to(e){e.timer>0&&(e.timer--,e.timer<=0&&e.salvo<=0&&(e.ammunition?(e.salvo=Math.min(e.salvoCount,e.ammunition),e.ammunition-=e.salvo):e.timer=1/0))}function Kt(e,t){return e.bullets.find(o=>o.angle==="lastMovement")&&!t.lastMovement?!1:e.timer===0}function Ze(e,t,o,i,r,n,s,a,l){let p=e.spawn(o).setIgnoreSolid({ids:l}).move(n.x,n.y);return p.name=t,a&&p.setMotion({angle:s,vel:a}),p.ship&&yt(p.ship),i.ship&&p.setOrigin({owner:i,ship:i.ship,turret:r}),p}function pe(e,t,o,i,r,n,s){var v;let{angle:a,beam:l,name:p,offset:f,prefab:g,vel:y,delay:P}=t;if(P){let H=(v=n.delayedShot)!=null?v:{shots:[]};return H.shots.push({turret:o,bullet:Z(t)}),n.setDelayedShot(H),[]}let C=B(i,f!=null?f:d(.5,.5)),w=a==="nearestEnemy"?U(C,r):a==="lastMovement"?n.lastMovement.angle:a;if(l&&y){let[H,ht]=X({angle:w,vel:y}),Te=d(H,ht),_t=B(C,Te);return l.appearance.map(fo=>{let Tt=Ze(e,p,g,n,o,_t,w,0,s).setMotion({angle:w,vel:0}).setLifetime({duration:l.duration});return Tt.appearance&&Object.assign(Tt.appearance,fo),n.ship&&Tt.setOrigin({owner:n,ship:n.ship,turret:o}),_t=B(_t,Te),Tt})}return[Ze(e,p,g,n,o,C,w,y,s)]}function Ft(e,t,o,i,r,n=[]){let{timeBetweenSalvos:s,timeBetweenShots:a}=t;--t.salvo<=0?t.timer=s:t.timer=a;let l=[];for(let p of t.bullets)l.push(...pe(e,p,t,o,i,r,n));return l}function me(e){let t=new D(e.entities,["ai","delayedShot"]);e.on("tick",function(){t.forEach(({ai:i,delayedShot:r},n)=>{for(let s=r.shots.length-1;s>=0;s--){let{turret:a,bullet:l}=r.shots[s];if(--l.delay<=0){l.delay=0,r.shots.splice(s,1);let p=G(e,n),f=p.find(y=>y.turret===a);if(!f||!i.attacking)continue;let g=Q(e,i.attacking);pe(e,l,a,f.position,g,n,p.map(y=>y.id))}}r.shots.length||n.setDelayedShot()})})}function fe(e){let t=new D(e.entities,["appearance","position"]);e.on("draw",function(){t.forEach(({appearance:i,position:r})=>e.drawIfVisible(O(r.x),O(r.y),i.glyph,i.fg,i.bg,i.blendMode))})}function ce(e){e.on("kill",function({e:o,reason:i}){var s;let{position:r,ship:n}=o;if(r&&(n!=null&&n.power)&&i.type==="damage"){let a=ae[n.power],l=((s=i.source.e.projectile)==null?void 0:s.special)==="increasedDropChance",p=n.type==="Battleship"?l?.92:.42:l?.32:.02,f=(P=1)=>Math.random()*P<p,g=[];a&T.Double&&f()&&g.push("DoubleItem"),a&T.Drain&&f()&&g.push("DrainItem"),a&T.Healthy&&f()&&g.push("HealItem"),f()&&g.push("MoneyItem"),f()&&g.push("JunkItem");let y=mt([d(-1,-1),d(0,-1),d(1,-1),d(-1,0),d(0,0),d(1,0),d(-1,1),d(0,1),d(1,1)]);for(let P of g){let C=B(r,y.pop());e.spawn(P).move(C.x,C.y).setMotion({angle:u.Down,vel:1})}}})}var eo=S(E());var Ot=S(E());function ft(e,t,o){return e*(1-o)+t*o}var bt=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[o])=>t-o)}add(t,o){return this.points.push([t,o]),this.sort(),this}get(t){let[o,i]=this.points[0];if(t<=o)return(0,Ot.fromRgb)(...i);let[r,n]=this.points[this.points.length-1];if(t>=r)return(0,Ot.fromRgb)(...n);let s=this.points.findIndex(([ht])=>ht>t),[a,[l,p,f,g]]=this.points[s-1],[y,[P,C,w,v]]=this.points[s],H=(t-a)/(y-a);return(0,Ot.fromRgb)(ft(l,P,H),ft(p,C,H),ft(f,w,H),ft(g,v,H))}};function it(e,t){let o=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);return Math.sqrt(o*o+i*i)}var Li={Fire:new bt([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function he(e){if(!(e.intensity<=0))return{glyph:" ",layer:b.Effect,bg:Li[e.type].get(e.intensity),blendMode:eo.BlendMode.Add}}function oo(e,t){let o=[],i=Math.floor(e.x-t),r=Math.ceil(e.x+t),n=Math.floor(e.y-t),s=Math.ceil(e.y+t);for(let a=n;a<=s;a++)for(let l=i;l<=r;l++){let p=it(e,{x:l,y:a});p>=t||o.push({x:l,y:a,intensity:t-p})}return o}function ue(e){e.on("kill",function({e:o,reason:i}){if(i.type==="exitedMap")return;let{explodes:r,name:n,position:s}=o;if(r&&s)for(let{x:a,y:l,intensity:p}of oo(s,r.size))e.add(new tt(e,n+"Explosion").setPosition({x:a,y:l}).setField({type:r.type,intensity:p,falloff:r.falloff}))})}function Pt(e,t,o,i){let r=e.getRoot(t);if(!r.ship)return;let n=o;r.ship.shield>0&&(r.ship.shield>o?(r.ship.shield-=o,n=0):(n-=r.ship.shield,r.ship.shield=0)),n&&(r.ship.hp-=n);let s={e:i,owner:i};i.origin&&(s.owner=i.origin.owner,s.ship=i.origin.ship,s.turret=i.origin.turret),console.log(i.name,"hits",r.name,"for",o),e.fire("damage",{e:r,amount:o,source:s}),r.ship.hp<=0&&e.kill(r,{type:"damage",source:s})}function de(e){let t=new D(e.entities,["ship"]),o=new D(e.entities,["field","position"]);e.on("tick",function(){o.forEach(({field:r,position:n},s)=>{r.intensity-=r.falloff,s.setAppearance(he(r)),r.intensity<1?e.kill(s,{type:"expired"}):t.forEach((a,l)=>{let{layout:p}=_(e,l);p.find(({absolute:g})=>j(g,n))&&Pt(e,l,Math.floor(r.intensity),s)})})}),e.on("spawn",function({e:r}){r.field&&r.setAppearance(he(r.field))})}var lt=S(E());var xt=S(E());var rt=class{constructor(t,o,i){this.g=t;this.pilot=o;this.full=i;this.width=11,this.height=i?2+o.class.length:1}get isPlayer(){return isNaN(this.pilot.difficulty)}draw(t,o){if(this.full&&(this.g.term.drawString(t,o,this.pilot.name,this.pilot.star?xt.Colors.YELLOW:xt.Colors.LIGHT_GRAY),o++),this.drawStat(t,o,"body"),this.drawStat(t+3,o,"mind"),this.drawStat(t+6,o,"spirit"),this.drawStat(t+9,o,"talent"),!!this.full)for(let i of this.pilot.class)this.g.term.drawString(t,++o,i,xt.Colors.LIGHT_GREEN)}drawStat(t,o,i){let r=this.pilot[i];this.g.term.drawChar(t,o,i[0].toUpperCase(),xt.Colors.WHITE),this.g.term.drawChar(t+1,o,r.toString(),It[r])}};var V=S(E());function ge(e,t,o,i,r,n,s,a,l){let p=`${Math.ceil(r)}/${n}`,f=Math.floor(r/n*i);e.drawHLine(t,o,i," ",void 0,a),f&&e.drawHLine(t,o,f," ",void 0,s),e.drawCenteredString(t+i/2,o,p,l)}var nt=class{constructor(t,o){this.g=t;this.ship=o;this.width=Math.max(13,o.name.length),this.height=o.maxShield?3:2}draw(t,o){let{ship:i,width:r}=this,{term:n}=this.g,s=r-3;n.drawString(t,o,i.name,V.Colors.WHITE),n.drawString(t,o+1,"HP:",V.Colors.WHITE),ge(n,t+3,o+1,s,i.hp,i.maxHp,V.Colors.DARK_GREEN,V.Colors.DARK_RED,V.Colors.WHITE),i.maxShield&&(n.drawString(t,o+2,"Sh:",V.Colors.WHITE),ge(n,t+3,o+2,s,i.shield,i.maxShield,V.Colors.DARK_CYAN,V.Colors.LIGHT_BLUE,V.Colors.WHITE))}};var st=S(E());var Ii={Spent:st.Colors.DARK_GRAY,Reloading:st.Colors.LIGHT_RED,Ready:st.Colors.YELLOW,Chambering:st.Colors.BROWN},at=class{constructor(t,o){this.g=t;this.turret=o;this.width=Math.max(o.name.length,this.stateLabel.length),this.height=2,o.ammunition>0&&o.ammunition<1/0&&this.height++}get stateLabel(){let{timer:t,salvo:o,salvoCount:i}=this.turret,r=le(this.turret);if(r==="Spent")return"Out of Ammo";if(r==="Reloading")return`Reloading (${t})`;let n=`${o}/${i}`;return r==="Ready"?n:`${n} (${t})`}draw(t,o){this.g.term.drawString(t,o,this.turret.name,st.Colors.WHITE);let i=le(this.turret);this.g.term.drawString(t,o+1,this.stateLabel,Ii[i]),this.height>2&&this.g.term.drawString(t,o+2,`${this.turret.ammunition} ammo left`,st.Colors.LIGHT_GRAY)}};var ct=6;function ye(e){let{mapHeight:t,term:o}=e;e.on("draw",function(){let r=e.player,{pilot:n,ship:s}=r;o.fillRect(0,t,o.width,ct," ",lt.Colors.WHITE,lt.Colors.BLACK),o.drawSingleBox(0,t,o.width,ct);let a=1,l=t+1,p=new nt(e,s);p.draw(a,l);let f=a+Math.floor((p.width-11)/2);new rt(e,n,!1).draw(f,l+3),a+=p.width+1,o.drawChar(a-1,l-1,m.BoxDownSingleHorizontalSingle,lt.Colors.WHITE),o.drawVLine(a-1,l,ct-2,m.BoxVerticalSingle,lt.Colors.WHITE),o.drawChar(a-1,l+ct-2,m.BoxUpSingleHorizontalSingle,lt.Colors.WHITE);let y=a;for(let P of r.player.weaponArrays){let C=y,w=G(e,r).filter(v=>v.turret&&v.tags.has(P));for(let v of w){let H=new at(e,v.turret);H.draw(y,l+1),y+=H.width+1}o.drawString(C,l,P,lt.Colors.LIGHT_CYAN),y=Math.max(y,C+P.length+1)}})}function be(e){let t=new D(e.entities,["homing","motion","position"]);e.on("tick",function(){t.forEach(({homing:i,motion:r,position:n},s)=>{var f;if(!((f=i.target)!=null&&f.alive))return;let a=Q(e,i.target),l=U(n,a),p=je(r.angle,l);Math.abs(p)<=i.strength?r.angle=l:p<0?r.angle-=i.strength:r.angle+=i.strength,--i.duration<=0&&(s.setHoming(),s.setTrail())})})}function Pe(e){let t=new D(e.entities,["lifetime"]);e.on("tick",function(){t.forEach(({lifetime:i},r)=>{if(--i.duration<=0)e.kill(r,{type:"expired"});else if(i.decayingAppearance&&r.appearance){let n=i.decayingAppearance[i.duration-1];Object.assign(r.appearance,n)}})})}function Nt(e,t){let o=t.x-e.x,i=t.y-e.y,r=Math.abs(o),n=Math.abs(i),s=o>0?1:-1,a=i>0?1:-1,l=F({},e),p=[F({},l)];for(let f=0,g=0;f<r||g<n;)(.5+f)/r<(.5+g)/n?(l.x+=s,f++):(l.y+=a,g++),p.push(F({},l));return p}function io(e,t,o){let i=[],r=(n,s)=>{let a=O(n),l=O(s);i.find(p=>p.x===a&&p.y===l)||i.push({x:a,y:l})};for(let n=0;n<=Math.floor(o*Math.sqrt(.5));n++){let s=Math.floor(Math.sqrt(o*o-n*n));r(e-s,t+n),r(e+s,t+n),r(e-s,t-n),r(e+s,t-n),r(e+n,t-s),r(e+n,t+s),r(e-n,t-s),r(e-n,t+s)}return i}function xe(e){let t=new D(e.entities,["motion","position"]);e.on("tick",function(){t.forEach(({motion:i,position:r,projectile:n,ignoreSolid:s},a)=>{let[l,p]=X(i),f=d(r.x+l,r.y+p),g=Nt(I(r),I(f)),y=!1,P;for(let C of g){if(!e.inBounds(C)){e.kill(a,{type:"exitedMap"});return}e.move(a,C);let{wall:w,solid:v}=e.getContents(C,s==null?void 0:s.ids);if(w){y=!0;break}else if(v){P=v;break}}y?e.kill(a,{type:"hitWall"}):P?(n&&Pt(e,P,n.damage,a),e.kill(a,{type:"hitEntity",other:P})):e.move(a,f)})})}function we(e){e.on("playerMove",function({move:o}){let i=e.player,r=i.position,n=B(r,o);Ue(e,i,n).length||(i.move(n.x,n.y),i.setLastMovement({angle:U(r,n)}),e.tick())}),e.on("playerFire",function({array:o}){let i=e.player,r=i.player.weaponArrays[o],n=G(e,i),s=n.filter(l=>l.tags.has(r)),a=!1;for(let l of s)l.turret&&Kt(l.turret,i)&&(Ft(e,l.turret,l.position,d(0,0),i,n.map(p=>p.id)),a=!0);a&&(i.setLastMovement(),e.tick())})}function Ee(e){let t=new D(e.entities,["ship"]);e.on("tick",function(){t.forEach(({pilot:i,ship:r})=>{var s;if(r.shield>=r.maxShield){r.shieldTimer=0;return}let n=6-((s=i==null?void 0:i.body)!=null?s:0);++r.shieldTimer>=n&&(r.shield++,r.shieldTimer=0)})})}function Se(e){e.on("waveBegin",function({wave:o,difficulty:i,pilot:r}){let n=(i+o.difficulty)*3,s=[];for(let l of o.groups)for(let p=0;p<l.count;p++)s.push(K(l.prefabs));let a=Math.floor(Math.random()*s.length);for(let l=0;l<s.length;l++){let p=l===a&&r!==void 0,f=s[l],g=Qe(n,p),y=Xe(e,f,g),P=Je(e,y);y.move(P.x,P.y)}})}function De(e){e.on("move",function({e:o,old:i,pos:r}){o.trail&&!j(i,r)&&e.spawn(o.trail.effectPrefab).setPosition(i)})}function ve(e){let t=new D(e.entities,["position","turret"]);e.on("tick",function(){t.forEach(({position:i,turret:r},n)=>{var p;to(r);let s=e.getRoot(n);if(!s.ai)return;let a=s.ai.attacking;if(!(a!=null&&a.alive))return;let l=Q(e,a);if(!(it(i,l)>((p=s.ai.firingDistance)!=null?p:1/0))&&Kt(r,s))for(let f of Ft(e,r,i,l,s,gt(e,s)))f.homing&&(f.homing.target=a),f.ai&&(f.ai.attacking=a)})})}function ro(e){Pe(e),be(e),me(e),ve(e),de(e),Ee(e),xe(e),ie(e),Se(e),fe(e),ye(e),De(e),ue(e),ce(e),we(e)}var wt=S(E());var no=S(E()),$=class{constructor(t){this.g=t;this.width=0,this.height=0,this.instructions=[]}add(t){this.instructions.push(t),this.updateBounds()}addLine(t,o=no.Colors.WHITE,i){this.add({x:0,y:this.instructions.length,line:t,fg:o,bg:i})}updateBounds(){this.width=this.instructions.reduce((t,o)=>Math.max(o.line.length+o.x,t),0),this.height=1+this.instructions.reduce((t,o)=>Math.max(o.y,t),0)}draw(t,o){for(let{x:i,y:r,line:n,fg:s,bg:a}of this.instructions)this.g.term.drawString(t+i,o+r,n,s,a)}};var so=Math.PI/4,ki=[m.RightArrow,m.DownArrow+m.RightArrow,m.DownArrow,m.DownArrow+m.LeftArrow,m.LeftArrow,m.UpArrow+m.LeftArrow,m.UpArrow,m.UpArrow+m.RightArrow];function Gi(e){let t=Math.floor(Ye(e)/so+so/2);return ki[t]}var Et=class extends ${constructor(o,i){super(o);this.e=i;this.instructions=[],i.name&&this.addLine(i.name),i.projectile&&this.addLine(`${i.projectile.damage} damage`,wt.Colors.LIGHT_RED),i.motion&&this.addLine(`${Gi(i.motion.angle)}, vel ${i.motion.vel}`,wt.Colors.LIGHT_GRAY),i.homing&&this.addLine(`chasing ${i.homing.target===this.g.player?"you ":""}${i.homing.duration<1/0?`(${i.homing.duration})`:""}`,wt.Colors.DARK_RED),i.lifetime&&this.addLine(`(lasts ${i.lifetime.duration})`,wt.Colors.DARK_GRAY)}};var Ae=S(E());var Ce=S(E());var St=class extends ${constructor(o,i){super(o);this.field=i;this.addLine(`${i.type} Field`),this.add({x:0,y:1,fg:Ce.Colors.LIGHT_GRAY,line:"intensity"}),this.add({x:10,y:1,fg:Ce.Colors.YELLOW,line:Math.floor(i.intensity).toString()})}};var He=S(E());var Dt=class extends ${constructor(o,i){super(o);this.item=i;switch(i.type){case"bomb":this.addLine("Smart Bomb");break;case"double":this.addLine("Double",Y.Double.fg,Y.Double.bg);break;case"drain":this.addLine("Drain",Y.Drain.fg,Y.Drain.bg);break;case"heal":this.addLine("Heal",Y.Healthy.fg,Y.Healthy.bg);break;case"junk":this.addLine("Junk",He.Colors.DARK_GRAY);break;case"money":this.addLine(`${m.SetMember}${i.value}`,He.Colors.YELLOW);break;case"recharge":this.addLine("Recharge");break}}};function ao(e,t,o){if(!o.length)return;let i=[],r=1,n=1,s=f=>{i.push({x:r,y:n,object:f}),n+=f.height+1};for(let f of o){f.ship&&s(new nt(e,f.ship)),f.pilot&&s(new rt(e,f.pilot,!0));let g=G(e,f);for(let y of g.filter(P=>P.turret))s(new at(e,y.turret));(f.motion||f.projectile||f.homing||f.lifetime)&&s(new Et(e,f)),f.field&&s(new St(e,f.field)),f.item&&s(new Dt(e,f.item))}if(!i.length)return;let a=Math.max(...i.map(f=>f.object.width))+2,l=Math.min(t.x+2,e.term.width-a),p=Math.min(t.y,e.term.height-n);e.term.fillRect(l,p,a,n," ",Ae.Colors.WHITE,Ae.Colors.BLACK),e.term.drawSingleBox(l,p,a,n);for(let f of i)f.object.draw(l+f.x,p+f.y)}function lo(e,t,o){for(let i of e.entities.get()){let{motion:r,projectile:n,position:s}=i;if(r&&n&&s&&it(t,s)<=o){let a=U(t,s);r.angle=a,i.setIgnoreSolid()}}for(let i of io(t.x,t.y,o))e.spawn("AirFistRange").setPosition(i)}var vt=class{constructor(t,o){this.g=t;this.campaign=o;this.dirty=!0,this.examining=[]}refresh(){this.dirty=!0}init(){let{g:t}=this;this.examineAt=void 0,this.examining=[],this.waves=qe(),t.blankMap();let{width:o,height:i}=_(t,t.player);t.player.move(O(t.mapWidth/2-o/2),t.mapHeight-i-4),ro(t),this.nextWave()}nextWave(){let t=this.waves.shift();if(t){let o=this.waves.length===0?this.campaign.currentSector.star:void 0;this.g.fire("waveBegin",{wave:t,difficulty:this.campaign.difficulty,pilot:o})}}draw(){let{map:t,mapWidth:o,mapHeight:i,overlays:r,term:n}=this.g;for(let s=0;s<i;s++)for(let a=0;a<o;a++){let l=t.grid[s][a];n.drawChar(a,s,0,l.fg,l.bg)}if(this.g.fire("draw",void 0),this.dirty=!1,this.showOverlay){let s=r.get(this.showOverlay);if(s)for(let a=0;a<i;a++)for(let l=0;l<o;l++){let p=s.get({x:l,y:a})||1/0,f=p===1/0?"-":p<10?`${p}`:"*";n.drawChar(l,a,f,z.Colors.LIGHT_RED)}}if(this.examineAt){ao(this.g,this.examineAt,this.examining);for(let s of this.examining){let{motion:a,position:l}=s;if(a&&l){let[p,f]=X(a),g=d(l.x+p,l.y+f),y=Nt(I(l),I(g));for(let P of y)n.drawCell(P.x,P.y,{bg:z.Colors.DARK_RED},z.BlendMode.Add)}}}}update(){(this.g.term.mouse.dx||this.g.term.mouse.dy)&&this.refresh(),this.handleKeys(),this.dirty&&(this.handleMouseMove(),this.draw())}examine(t){this.examineAt=t,this.dirty=!0;let{solid:o,other:i}=this.g.getContents(t),r=new Set;o&&r.add(this.g.getRoot(o));for(let n of i)r.add(this.g.getRoot(n));this.examining=[...r]}handleMouseMove(){let{x:t,y:o}=this.g.term.mouse;this.examine({x:t,y:o})}handleKeys(){let{player:t,term:o}=this.g,i=o.getMovementKey();if(i){this.g.fire("playerMove",{move:i});return}if(o.isKeyPressed(z.Key.VK_1)){this.g.fire("playerFire",{array:0});return}if(o.isKeyPressed(z.Key.VK_2)){this.g.fire("playerFire",{array:1});return}if(o.isKeyPressed(z.Key.VK_F)){lo(this.g,Q(this.g,t),4.5),this.g.tick();return}}};var Ct=class{constructor(t,o,i){this.width=t;this.height=o;this.grid=[];for(let r=0;r<o;r++){let n=[];for(let s=0;s<t;s++)n.push(i(s,r));this.grid.push(n)}}contains({x:t,y:o}){return t>=0&&t<this.width&&o>=0&&o<this.height}get({x:t,y:o}){return this.grid[o][t]}getPositions(){let t=[];for(let o=0;o<this.height;o++)for(let i=0;i<this.width;i++)t.push({x:i,y:o});return t}};var Ki={name:"Bodini",star:!0,difficulty:4,body:3,mind:2,spirit:3,talent:2,class:["Psychic"]},Fi={name:"Star Pilot B",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},Oi={name:"Star Pilot C",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},Ni={name:"Star Pilot D",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},Wi={name:"Star Pilot E",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},_i={name:"Star Pilot F",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},Ui=[Ki,Fi,Oi,Ni,Wi,_i],po=Ui;var Ht=class{constructor(t,o,i){this.g=t;this.shipPrefab=o;this.pilot=i;this.dirty=!0}get currentSector(){return this.space.get(this.position)}refresh(){this.dirty=!0}init(){let{g:t}=this;t.clearEventHandlers(),t.entities.clear(),t.player=this.makePlayer(),this.difficulty=0,this.position=d(2,2),this.space=new Ct(5,5,()=>({completed:!1}));let o=new Set,i=this.space.getPositions().filter(r=>!j(this.position,r));for(;o.size<6;){let r=K(po);if(!o.has(r)){o.add(r);let n=K(i),s=this.space.get(n);s.star=r;let a=i.indexOf(n);i.splice(a,1)}}}startCombat(){this.g.setMode(new vt(this.g,this))}endCombat(){this.currentSector.completed=!0,this.difficulty++,this.g.mode=this,this.refresh()}makePlayer(){let{g:t,shipPrefab:o,pilot:i}=this,r=t.spawn(o);if(!r.ship)throw new Error(`Ship prefab ${o} doesn't have a ship component!`);return kt(r,i),yt(r.ship),r}draw(){let{term:t}=this.g;t.clear();let o=this.space.get(this.position),i=t.width/2;t.drawCenteredString(i,2,"Known Space",W.Colors.WHITE),o.completed||t.drawCenteredString(i,4,"Hit Enter to fight!",W.Colors.WHITE);let r=(t.width-25)/2,n=(t.height-25)/2;for(let s=0;s<5;s++){let a=n+s*5;for(let l=0;l<5;l++){let p=r+l*5,f={x:l,y:s},g=this.space.get(f);t.fillRect(p,a,5,5," ",void 0,g.completed?W.Colors.BLACK:W.Colors.DARK_RED),t.drawSingleBox(p,a,5,5,W.Colors.WHITE),j(f,this.position)?t.drawChar(p+2,a+2,"@",W.Colors.LIGHT_CYAN):g.star&&t.drawChar(p+2,a+2,"*",W.Colors.YELLOW)}}this.dirty=!1}handleKeys(){let t=this.space.get(this.position);!t.completed&&(this.g.term.isKeyPressed(W.Key.VK_ENTER)||this.g.term.isKeyPressed(W.Key.VK_NUMPAD_ENTER))&&this.startCombat();let o=this.g.term.getMovementKey();if(t.completed&&o){let i=B(this.position,o);this.space.contains(i)&&(this.position=i,this.dirty=!0)}}update(){this.handleKeys(),this.dirty&&this.draw()}};var At=class{constructor(t,o=5,i=100){this.g=t;this.starfieldSpeed=o;this.starCount=i}refresh(){this.dirty=!0}init(){this.dirty=!0,this.pilot={name:"Player",difficulty:NaN,body:1,mind:1,spirit:1,talent:1,class:[]},this.points=6,this.starfieldCounter=0,this.stars=[];for(let t=0;t<this.starCount;t++)this.stars.push(this.newStar())}draw(){let{term:t}=this.g;t.clear();for(let s of this.stars){let{x:a,y:l}=I(s);t.drawChar(a,l,s.c,s.fg)}let o=t.width/2;t.drawCenteredString(o,2,"Bullet Hell Roguelike",x.Colors.WHITE),t.drawCenteredString(o,9,"Create your Pilot",x.Colors.WHITE),t.drawCenteredString(o,10,`${this.points} points`,x.Colors.YELLOW);let i=2,r=Math.floor((t.width-i*2)/4),n=i+r/2;this.drawStat("body",n),this.drawStat("mind",n+r),this.drawStat("spirit",n+r*2),this.drawStat("talent",n+r*3),this.points===0&&t.drawCenteredString(o,20,"Hit Enter to begin!",x.Colors.WHITE),this.dirty=!1}drawStat(t,o){let{term:i}=this.g,r=`(${t[0].toUpperCase()})${t.slice(1)}`,n=this.pilot[t];i.drawCenteredString(o,13,r,x.Colors.LIGHT_CYAN),i.drawCenteredString(o,14,n.toString(),It[n])}update(){this.handleStarfield(),this.handleKeys(),this.dirty&&this.draw()}newStar(){let{term:t}=this.g,o=K([x.Colors.DARK_RED,x.Colors.LIGHT_RED,x.Colors.YELLOW,x.Colors.LIGHT_CYAN,x.Colors.WHITE]),i=.5+Math.random(),r=i<.75?".":i<1.25?m.Dot:"*",n=Math.random()*Math.PI*2;return{x:t.width/2,y:t.height/2,c:r,fg:o,vel:i,angle:n}}handleStarfield(){if(this.starfieldCounter<this.starfieldSpeed){this.starfieldCounter++;return}this.starfieldCounter=0,this.dirty=!0;let{width:t,height:o}=this.g.term;for(let i of this.stars){let[r,n]=X(i);i.x+=r,i.y+=n,(i.x<0||i.x>=t||i.y<0||i.y>=o)&&Object.assign(i,this.newStar())}}isPressed(t,o){let i=this.g.term.isKeyDown(x.Key.VK_SHIFT_LEFT)||this.g.term.isKeyDown(x.Key.VK_SHIFT_RIGHT);return this.g.term.isKeyPressed(t)&&o===i}changeStat(t,o){let i=this.pilot[t]+o;if(i<1||i>6)return!1;this.points-=o,this.pilot[t]=i,this.dirty=!0}handleKeys(){this.points>0&&(this.isPressed(x.Key.VK_B,!1)&&this.changeStat("body",1),this.isPressed(x.Key.VK_M,!1)&&this.changeStat("mind",1),this.isPressed(x.Key.VK_S,!1)&&this.changeStat("spirit",1),this.isPressed(x.Key.VK_T,!1)&&this.changeStat("talent",1)),this.isPressed(x.Key.VK_B,!0)&&this.changeStat("body",-1),this.isPressed(x.Key.VK_M,!0)&&this.changeStat("mind",-1),this.isPressed(x.Key.VK_S,!0)&&this.changeStat("spirit",-1),this.isPressed(x.Key.VK_T,!0)&&this.changeStat("talent",-1),this.points===0&&(this.g.term.isKeyPressed(x.Key.VK_ENTER)||this.g.term.isKeyPressed(x.Key.VK_NUMPAD_ENTER))&&this.g.setMode(new Ht(this.g,"PlayerShip",this.pilot))}};var Mt=class{constructor(t){this.keyFn=t;this.items=new Map}has(t){return this.items.has(this.keyFn(t))}get(t){return this.items.get(this.keyFn(t))}getOrDefault(t,o){let i=this.items.get(this.keyFn(t));return typeof i!="undefined"?i:o}getOrDie(t){let o=this.keyFn(t),i=this.items.get(o);if(typeof i=="undefined")throw new Error(`Invalid key: ${o}`);return i}set(t,o){this.items.set(this.keyFn(t),o)}};function Me(e,t,o=1/0){let i=[],r=new Mt(n=>`${n.x},${n.y}`);for(let n of e)i.push(n),r.set(n,0);for(;i.length;){let n=i.shift(),s=r.getOrDie(n)+1;if(!(s>o))for(let a of oe(n))!r.has(a)&&t(a)&&(r.set(a,s),i.push(a))}return r}function Be(e){return typeof e!="undefined"}var Bt=class{constructor(t,o,i){this.term=t;this.mapWidth=o;this.mapHeight=i;t.update=this.update.bind(this),this.map=new mo.Console(o,i,()=>!0),this.lastEntityId=0,this.entities=new dt(Oe),this.overlays=new Map,this.clearEventHandlers(),this.setMode(new At(this))}setMode(t){this.mode=t,this.mode.init()}clearEventHandlers(){this.eventCallbacks=Fe(Ne.map(t=>[t,[]]))}fire(t,o){for(let i of this.eventCallbacks[t])i(o)}on(t,o){this.eventCallbacks[t].push(o)}spawn(t){return Zt(this,t)}refresh(){this.mode.refresh()}add(t){return this.refresh(),this.entities.add(t),this.fire("spawn",{e:t}),t}kill(t,o){t.alive&&(t.kill(o),this.fire("kill",{e:t,reason:o}))}move(t,o){let i=t.position;t.move(o.x,o.y),i&&this.fire("move",{e:t,old:i,pos:o})}blankMap(){let{map:t,mapHeight:o,mapWidth:i}=this;t.clear();for(let r=0;r<o;r++)for(let n=0;n<i;n++)t.setBlocked(n,r,!1),t.setBlockedSight(n,r,!1);t.computeFov(0,0,1/0)}drawIfVisible(t,o,i,r,n,s){this.map.isVisible(t,o)&&(s?this.term.drawCell(t,o,{bg:n},s):this.term.drawChar(t,o,i,r,n))}getRoot(t){return t.attachment?this.getRoot(t.attachment.parent):t}getContents(t,o=[]){let i=I(t);if(!this.inBounds(i))return{oob:!0,other:[]};let r=this.map.isBlocked(i.x,i.y),n=this.entities.get().filter(a=>a.position&&j(i,a.position)),s=n.filter(a=>!o.includes(a.id)).find(a=>a.solid);return{wall:r,solid:s,other:n.filter(a=>!a.solid)}}tick(){this.overlays.clear(),this.fire("tick",void 0),this.entities.clearDead()}update(){this.mode.update()}inBounds(t){return t.x>=0&&t.y>=0&&t.x<this.mapWidth&&t.y<this.mapHeight}getDistanceMap(t){let o=`${t.id}.distance`,i=this.overlays.get(o);return i||(i=Me(G(this,t).map(r=>r.position).filter(Be),this.inBounds.bind(this)),this.overlays.set(o,i)),i}};function Vi(e){let i=Wt.DEFAULT_FONT,r=document.createElement("div");e.appendChild(r);let n=()=>{let p=60*i.charWidth,f=40*i.charHeight,g=Math.floor(window.innerWidth/p),y=Math.floor(window.innerHeight/f),P=Math.min(g,y);r.style.width=`${p*P}px`,r.style.height=`${f*P}px`};window.addEventListener("resize",n),n();let s=document.createElement("canvas");r.appendChild(s),requestAnimationFrame(()=>s.focus());let a=new Wt.Terminal(s,60,40,{font:i}),l=new Bt(a,60,40-ct);window.g=l}window.addEventListener("load",()=>Vi(document.body));})();
//# sourceMappingURL=bundle.js.map
