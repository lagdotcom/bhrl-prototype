"use strict";(()=>{var ma=Object.create;var ud=Object.defineProperty,oa=Object.defineProperties,ya=Object.getOwnPropertyDescriptor,Ga=Object.getOwnPropertyDescriptors,ua=Object.getOwnPropertyNames,_0=Object.getOwnPropertySymbols,Oa=Object.getPrototypeOf,aa=Object.prototype.hasOwnProperty,za=Object.prototype.propertyIsEnumerable;var da=(a,d,e)=>d in a?ud(a,d,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[d]=e,V=(a,d)=>{for(var e in d||={})aa.call(d,e)&&da(a,e,d[e]);if(_0)for(var e of _0(d))za.call(d,e)&&da(a,e,d[e]);return a},ea=(a,d)=>oa(a,Ga(d));var va=(a,d)=>()=>(d||a((d={exports:{}}).exports,d),d.exports),Ld=(a,d)=>{for(var e in d)ud(a,e,{get:d[e],enumerable:!0})},Wa=(a,d,e,L)=>{if(d&&typeof d=="object"||typeof d=="function")for(let P of ua(d))!aa.call(a,P)&&P!==e&&ud(a,P,{get:()=>d[P],enumerable:!(L=ya(d,P))||L.enumerable});return a};var I=(a,d,e)=>(e=a!=null?ma(Oa(a)):{},Wa(d||!a||!a.__esModule?ud(e,"default",{value:a,enumerable:!0}):e,a));var R=va((LP,ba)=>{ba.exports=globalThis.wglt});function nd(a,d=new Map){if(!a||typeof a!="object")return a;if(d.has(a))return d.get(a);let e;if(a.nodeType&&"cloneNode"in a)e=a.cloneNode(!0),d.set(a,e);else if(a instanceof Date)e=new Date(a.getTime()),d.set(a,e);else if(a instanceof RegExp)e=new RegExp(a),d.set(a,e);else if(Array.isArray(a)){e=new Array(a.length),d.set(a,e);for(let L=0;L<a.length;L++)e[L]=nd(a[L],d)}else if(a instanceof Map){e=new Map,d.set(a,e);for(let[L,P]of a.entries())e.set(L,nd(P,d))}else if(a instanceof Set){e=new Set,d.set(a,e);for(let L of a)e.add(nd(L,d))}else if(a instanceof Object){e={},d.set(a,e);for(let[L,P]of Object.entries(a))e[L]=nd(P,d)}else throw Error(`Unable to clone ${a}`);return e}function La(a){return nd(a,new Map)}var G=La,Pa=Object.keys,$a=a=>{let d={};for(let[e,L]of a)d[e]=L;return d};var bd=class{constructor(d,e){this.g=d;this.name=e;this.alive=!0,this.id=++d.lastEntityId,this.solid=!1,this.tags=new Set}applyPrefab(d,e){if(this.prefab=d,e.components&&Object.assign(this,G(e.components)),e.children)for(let{name:L,x:P,y:$,overlay:D,tags:i}of e.children){let H=this.g.spawn(L).setAttachment({parent:this,x:P,y:$});if(D)for(let b of Pa(D))Object.assign(H[b],G(D[b]));if(i)for(let b of i)H.tags.add(b)}return this}get[Symbol.toStringTag](){return this.name}kill(d){return this.alive=!1,this.eachChild(e=>this.g.kill(e,d)),this}eachChild(d){var e;for(let L of this.g.entities.get())((e=L.attachment)==null?void 0:e.parent)===this&&d(L,L.attachment)}setAI(d){return this.ai=d,this}setAppearance(d){return this.g.refresh(),this.appearance=d,this}setAttachment(d){return this.attachment=d,this}setDelayedShot(d){return this.delayedShot=d,this}setDoubleShot(d){return this.doubleShot=d,this}setExplodes(d){return this.explodes=d,this}setField(d){return this.field=d,this}setHoming(d){return this.homing=d,this}setIgnoreSolid(d){return this.ignoreSolid=d,this}setItem(d){return this.item=d,this}setLastMovement(d){return this.lastMovement=d,this}setLifetime(d){return this.lifetime=d,this}setMotion(d){return this.motion=d,this}setOrigin(d){return this.origin=d,this}setPilot(d){return this.pilot=d,this}setPosition(d){return this.g.refresh(),this.position=d,this}setShip(d){return this.ship=d,this}setTrail(d){return this.trail=d,this}setTurret(d){return this.turret=d,this}setPlayer(d){return this.player=d,this}setProjectile(d){return this.projectile=d,this}setSolid(d){return this.solid=d,this}move(d,e){return this.g.refresh(),this.position={x:d,y:e},this.eachChild((L,P)=>L.move(d+P.x,e+P.y)),this}};function Da(a,d){var P,$,D,i;let e=($=(P=a.appearance)==null?void 0:P.layer)!=null?$:0,L=(i=(D=d.appearance)==null?void 0:D.layer)!=null?i:0;return e!==L?e-L:a.id-d.id}var Ud=class{constructor(d,e=[]){this.compareFn=d;this.entities=e;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}clearExceptFor(d){for(let e of this.entities)d.includes(e.id)||(e.alive=!1);this.clearDead()}add(d){this.entities.push(d),this.dirty=!0}clearDead(){this.entities=this.entities.filter(d=>d.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var ia=["damage","draw","kill","move","notice","playerBomb","playerFire","playerMove","spawn","tick","waveBegin","waveNext"];var Yd=class{constructor(d){this.keyFn=d;this.items=new Map}has(d){return this.items.has(this.keyFn(d))}get(d){return this.items.get(this.keyFn(d))}getOrDefault(d,e){let L=this.items.get(this.keyFn(d));return typeof L!="undefined"?L:e}getOrDie(d){let e=this.keyFn(d),L=this.items.get(e);if(typeof L=="undefined")throw new Error(`Invalid key: ${e}`);return L}set(d,e){this.items.set(this.keyFn(d),e)}};function u(a){return typeof a=="undefined"?NaN:Math.floor(a)}var p=(a,d)=>({x:a,y:d});function Z(a){return p(u(a.x),u(a.y))}function W(a,d){if(typeof a=="undefined"||typeof d=="undefined")return!1;let e=Z(a),L=Z(d);return e.x===L.x&&e.y===L.y}function K(a,d){return p(a.x+d.x,a.y+d.y)}var H0=[p(-1,-1),p(-1,0),p(-1,1),p(0,1),p(1,1),p(1,0),p(1,-1),p(0,-1)];function B0(a){return H0.map(d=>K(a,d))}function b0(a,d,e=1/0){let L=[],P=new Yd(D=>`${D.x},${D.y}`);for(let D of a)L.push(D),P.set(D,0);let $=L.shift();for(;$;){let D=P.getOrDie($)+1;if(D<=e)for(let i of B0($))!P.has(i)&&d(i)&&(P.set(i,D),L.push(i));$=L.shift()}return P}function wa(a,d){if(!d||!a.length)throw new Error("Could not get midpoint");let e=L=>a.reduce((P,{offset:$})=>P+$[L],0)/a.length;return p(d.x+e("x"),d.y+e("y"))}function _a(a,d,e,L=[]){let P=[];for(let{offset:$}of d){let D=K(e,$),{oob:i,wall:H,solid:b}=a.getContents(D,L);i?P.push({absolute:D,offset:$,entity:"oob"}):H?P.push({absolute:D,offset:$,entity:"wall"}):b&&P.push({absolute:D,offset:$,entity:b})}return P}function n(a,d){let e=a.getRoot(d);return a.entities.get().filter(L=>a.getRoot(L)===e)}function w(a,d){return n(a,d).map(e=>e.id)}function O(a,d){var i;let e=(i=a.getRoot(d).position)!=null?i:p(0,0),L=n(a,d),P=[],$=0,D=0;for(let H of L){let{attachment:b,solid:B}=H;if(b&&B){let{x:c,y:r}=b;P.push({absolute:K(e,b),offset:{x:c,y:r},entity:H}),$=Math.max(c+1,$),D=Math.max(r+1,D)}}return{layout:P,topLeft:e,width:$,height:D}}function Ha(a,d,e){let L=w(a,d),{layout:P,topLeft:$}=O(a,d);return!e||!$?[]:_a(a,P,e||$,L)}function x(a,d){let{layout:e,topLeft:L}=O(a,d);if(!L||!e.length){if(d.position)return d.position;throw new Error(`Could not get midpoint of entity#${d.id}`)}return wa(e,L)}function Ba(a,d,e,L,P){for(let $=0;$<P;$++)for(let D=0;D<L;D++){let{oob:i,wall:H,solid:b,other:B}=a.getContents({x:d+D,y:e+$});if(i||H||b||B.length)return!1}return!0}function jd(a,d){if(!a.alive)return!1;for(let e of d)if(!a[e])return!1;return!0}function Pd(a){return d=>jd(d,a)}var N=I(R()),Od=[0,N.Colors.DARK_RED,N.Colors.BROWN,N.Colors.LIGHT_RED,N.Colors.ORANGE,N.Colors.YELLOW,N.Colors.WHITE],_={Typical:{fg:N.Colors.DARK_GRAY},Healthy:{fg:N.Colors.DARK_GREEN},Double:{fg:N.Colors.LIGHT_GRAY},Multi:{fg:N.Colors.DARK_MAGENTA},Drain:{fg:N.Colors.DARK_RED},StarPilot:{fg:N.Colors.YELLOW},Mega:{fg:N.Colors.BLACK,bg:N.Colors.DARK_MAGENTA}};function zd(a,d,e){let{ship:L}=d;if(!L)throw new Error(`Cannot put pilot into entity ${d.name} (no ship)`);if(d.setPilot(e),L.maxHp+=de(d),e.special){let P=x(a,d);a.spawn(e.special).setAttachment(ea(V({},Z(P)),{parent:d})).tags.add("Special")}}function rd(a,d){return a.pilot?a.pilot[d]:0}function ha(a){return 7-rd(a,"body")}function de(a){return rd(a,"body")*4}function Aa(a){return rd(a,"mind")}function fa(a){return(rd(a,"mind")-1)*5}function hd(a){return Math.random()*100<a}function Ad(a,d=0){let e=[];for(let L=d;L<a;L++)e.push(L);return e}function U(a){if(!a.length)throw new Error("oneOf passed empty array");return a[Math.floor(Math.random()*a.length)]}function Jd(a){for(let d=a.length-1;d>0;d--){let e=Math.floor(Math.random()*(d+1));[a[d],a[e]]=[a[e],a[d]]}return a}function vd(a,...d){return a.filter(e=>!d.includes(e))}var Xa=($=>($[$.None=0]="None",$[$.Healthy=1]="Healthy",$[$.Double=2]="Double",$[$.Drain=4]="Drain",$[$.HasPilot=8]="HasPilot",$))(Xa||{}),l=Xa;var ca=["Berserker","Chopter","Duelist","Engineer","Fighter","Negotiator","Psychic","Smuggler"];var f0={Typical:l.None,Healthy:l.Healthy,Double:l.Double,Multi:l.Healthy|l.Double,Drain:l.Drain,StarPilot:l.HasPilot,Mega:l.Healthy|l.Double|l.Drain|l.HasPilot},ae={Typical:"Fire",Healthy:"Green",Double:"Fire",Multi:"Magenta",Drain:"Fire",StarPilot:"Yellow",Mega:"Magenta"},h0=["ShipA","ShipB","ShipC","ShipD","ShipE","ShipF","ShipG","ShipH"],A0=["CruiseyWing","Olm","GoutOFlame","Demigod","Gremlin","AtomSmasher"],ee=[{name:"Let Fate Decide",difficulty:1,groups:[{count:7,type:"Escort",prefabs:h0},{count:1,type:"Battleship",prefabs:A0}]},{name:"Court Martial",difficulty:2,groups:[{count:5,type:"Escort",prefabs:["ShipA","ShipE"]},{count:1,type:"Battleship",prefabs:["CruiseyWing"]}]},{name:"Hellhounds",difficulty:3,groups:[{count:2,type:"Escort",prefabs:["ShipB"]},{count:2,type:"Battleship",prefabs:["GoutOFlame"]}]},{name:"Chaos",difficulty:4,groups:[{count:4,type:"Escort",prefabs:["ShipC"]},{count:4,type:"Escort",prefabs:vd(h0,"ShipC")},{count:1,type:"Battleship",prefabs:["Demigod"]}]},{name:"Fly in Formation",difficulty:4,groups:[{count:7,type:"Escort",prefabs:["ShipF"]},{count:1,type:"Battleship",prefabs:A0}]},{name:"Hark!",difficulty:6,groups:[{count:3,type:"Escort",prefabs:["ShipH"]},{count:3,type:"Escort",prefabs:vd(h0,"ShipH")},{count:1,type:"Battleship",prefabs:["Demigod"]}]},{name:"Caverns.com",difficulty:7,groups:[{count:1,type:"Escort",prefabs:["ShipA","ShipG"]},{count:3,type:"Battleship",prefabs:["Olm"]}]},{name:"Humanity to the Rescue",difficulty:8,groups:[{count:7,type:"Escort",prefabs:["ShipA","ShipD","ShipE","ShipG"]},{count:1,type:"Battleship",prefabs:["GoutOFlame"]}]},{name:"Wild Hunt",difficulty:9,groups:[{count:15,type:"Escort",prefabs:["ShipB","ShipF"]},{count:1,type:"Battleship",prefabs:["Olm"]}]},{name:"Arm Wrestling",difficulty:10,groups:[{count:9,type:"Escort",prefabs:["ShipG"]},{count:2,type:"Battleship",prefabs:["CruiseyWing"]}]},{name:"Valis",difficulty:11,groups:[{count:4,type:"Escort",prefabs:["ShipC"]},{count:4,type:"Escort",prefabs:["ShipH"]},{count:1,type:"Battleship",prefabs:A0}]}];function pa(a=3){return Jd(ee.slice()).slice(0,a).sort((d,e)=>d.difficulty-e.difficulty)}function Ta(a,d){return hd(a)?d?"Mega":U(["Healthy","Double","Multi","Drain"]):d?"StarPilot":"Typical"}function Le(a){let d=G(a);for(;d.class.length<d.talent;)d.class.push(U(ca.filter(e=>!d.class.includes(e))));return d}function Ca(a,d,e,L){let P=f0[e];if(P&l.HasPilot&&!L)throw new Error(`power ${e} needs pilot, none given`);let $=a.spawn(d),{ship:D}=$;if(!D)throw new Error(`Ship prefab ${d} doesn't have a ship component!`);if(D.power=e,P&l.Healthy&&(D.maxHp=D.maxHp*2+3),L){let H=Le(L);zd(a,$,H)}Kd(D);let i=_[e];for(let H of n(a,$))H.appearance&&Object.assign(H.appearance,i);return P&l.Double&&$.setDoubleShot({duration:1/0}),$.explodes&&($.explodes.type=ae[e]),$}function Fa(a,d){let{width:e,height:L}=O(a,d);for(let P=0;P<a.term.height;P++){let $=Jd(Ad(a.term.width-e));for(let D of $)if(Ba(a,D,P,e,L))return{x:D,y:P}}throw new Error(`Could not find ${e}x${L} spawn location`)}function Kd(a){a.hp=a.maxHp,a.shield=a.maxShield}var Pe={Smiley:"",Heart:"",Diamond:"",Club:"",Dot:"\x07",Ring:"	",RingInvert:`
`,Male:"\v",Female:"\f",DoubleNote:"",Star:"",Pilcrow:"",Silcrow:"",ResizeVertical:"",UpArrow:"",DownArrow:"",RightArrow:"",LeftArrow:"\x1B",ResizeHorizontal:"",DownWedge:"",Pentagon:"\x7F",AHat:"\x83",EHat:"\x88",CapitalUUmlaut:"\x9A",Cent:"\x9B",Yen:"\x9D",CurlyF:"\x9F",NotFlip:"\xA9",Not:"\xAA",InvertedExclamation:"\xAD",Fill1:"\xB0",Fill2:"\xB1",Fill3:"\xB2",BoxVerticalSingle:"\xB3",BoxLeftSingleUpDouble:"\xBD",BoxUpSingleHorizontalSingle:"\xC1",BoxDownSingleHorizontalSingle:"\xC2",BoxHorizontalSingle:"\xC4",BoxUpDoubleHorizontalSingle:"\xD0",BoxDownSingleHorizontalDouble:"\xD1",BoxRightSingleUpDouble:"\xD3",BoxVerticalDoubleHorizontalSingle:"\xD7",Filled:"\xDB",Beta:"\xE1",Gamma:"\xE2",Pi:"\xE3",Theta:"\xE9",Omega:"\xEA",SymbolED:"\xED",SetMember:"\xEE",HorizontalDivide:"\xF6",Approximates:"\xF7",Squared:"\xFD",Square:"\xFE"},h=Pe;var Wd=Math.PI*2;function $d(a,d){return Math.atan2(d.y-a.y,d.x-a.x)}function ta(a,d){let e=(a-d)%Wd,L=(d-a)%Wd;return e<L?-e:L}function Dd(a){let d=Math.cos(a.angle)*a.vel,e=Math.sin(a.angle)*a.vel;return[d,e]}function wd(a){for(;a<0;)a+=Wd;return a%Wd}var Rd=I(R());var ra=I(R()),y=class{constructor(d){this.g=d;this.width=0,this.height=0,this.instructions=[]}add(d){this.instructions.push(d),this.updateBounds()}addLine(d,e=ra.Colors.WHITE,L){this.add({x:0,y:this.instructions.length,line:d,fg:e,bg:L})}updateBounds(){this.width=this.instructions.reduce((d,e)=>Math.max(e.line.length+e.x,d),0),this.height=1+this.instructions.reduce((d,e)=>Math.max(e.y,d),0)}draw(d,e){for(let{x:L,y:P,line:$,fg:D,bg:i}of this.instructions)this.g.term.drawString(d+L,e+P,$,D,i)}};var Ja=Math.PI/4,$e=[h.RightArrow,h.DownArrow+h.RightArrow,h.DownArrow,h.DownArrow+h.LeftArrow,h.LeftArrow,h.UpArrow+h.LeftArrow,h.UpArrow,h.UpArrow+h.RightArrow,h.RightArrow];function De(a){let d=Math.floor(wd(a)/Ja+Ja/2);return $e[d]}var ld=class extends y{constructor(e,L){var P,$;super(e);this.e=L;L.name&&!L.ship&&this.addLine(L.name),L.projectile&&this.addLine(`${L.projectile.damage} damage`,Rd.Colors.LIGHT_RED),L.motion&&this.addLine(`${De(L.motion.angle)}, vel ${L.motion.vel}`,Rd.Colors.LIGHT_GRAY),(P=L.homing)!=null&&P.target&&this.addLine(`chasing ${L.homing.target===this.g.player?"you":($=L.homing.target.ship)==null?void 0:$.name} ${L.homing.duration<1/0?`(${L.homing.duration})`:""}`,Rd.Colors.DARK_RED),L.lifetime&&this.addLine(`(lasts ${L.lifetime.duration})`,Rd.Colors.DARK_GRAY),L.explodes&&this.addLine(`explosion ${L.explodes.size}`,Rd.Colors.ORANGE)}};var X0=I(R());var xd=class extends y{constructor(e,L){super(e);this.field=L;this.addLine("Explosion"),this.add({x:0,y:1,fg:X0.Colors.LIGHT_GRAY,line:"intensity"}),this.add({x:10,y:1,fg:X0.Colors.YELLOW,line:Math.floor(L.intensity).toString()})}};var c0=I(R());var Zd=class extends y{constructor(e,L){super(e);this.item=L;switch(L.type){case"bomb":this.addLine("Smart Bomb");break;case"double":this.addLine("Double",_.Double.fg,_.Double.bg);break;case"drain":this.addLine("Drain",_.Drain.fg,_.Drain.bg);break;case"heal":this.addLine("Heal",_.Healthy.fg,_.Healthy.bg);break;case"junk":this.addLine("Junk",c0.Colors.DARK_GRAY);break;case"money":this.addLine(`${h.SetMember}${L.value}`,c0.Colors.YELLOW);break;case"recharge":this.addLine("Recharge");break}}};var sd=I(R()),fd=class{constructor(d,e,L){this.g=d;this.pilot=e;this.full=L;this.width=11,this.height=L?2+e.class.length:1}get isPlayer(){return this.pilot.player}draw(d,e){if(this.full&&(this.g.term.drawString(d,e,this.pilot.name,this.pilot.star?sd.Colors.YELLOW:sd.Colors.LIGHT_GRAY),e++),this.drawStat(d,e,"body"),this.drawStat(d+3,e,"mind"),this.drawStat(d+6,e,"spirit"),this.drawStat(d+9,e,"talent"),!!this.full)for(let L of this.pilot.class)this.g.term.drawString(d,++e,L,sd.Colors.LIGHT_GREEN)}drawStat(d,e,L){let P=this.pilot[L];this.g.term.drawChar(d,e,L[0].toUpperCase(),sd.Colors.WHITE),this.g.term.drawChar(d+1,e,P.toString(),Od[P])}};var Ra=I(R());var Vd=class extends y{constructor(e,L){super(e);this.e=L;L.doubleShot&&this.addLine(L.doubleShot.duration===1/0?"2x Shot":`2x Shot (${L.doubleShot.duration})`,Ra.Colors.LIGHT_GRAY)}};function p0(a,d,e,L,P,$,D,i,H){let b=`${Math.ceil(P)}/${$}`,B=Math.floor(P/$*L);a.drawHLine(d,e,L," ",void 0,i),B&&a.drawHLine(d,e,B," ",void 0,D),a.drawCenteredString(d+L/2,e,b,H)}var z=I(R()),Xd=class{constructor(d,e){this.g=d;this.ship=e;this.width=Math.max(13,e.name.length),this.height=e.maxShield?3:2}draw(d,e){let{ship:L,width:P}=this,{term:$}=this.g,D=P-3;$.drawString(d,e,L.name,z.Colors.WHITE),$.drawString(d,e+1,"HP:",z.Colors.WHITE),p0($,d+3,e+1,D,L.hp,L.maxHp,z.Colors.DARK_GREEN,z.Colors.DARK_RED,z.Colors.WHITE),L.maxShield&&($.drawString(d,e+2,"Sh:",z.Colors.WHITE),p0($,d+3,e+2,D,L.shield,L.maxShield,z.Colors.DARK_CYAN,z.Colors.LIGHT_BLUE,z.Colors.WHITE))}};var cd=Math.PI/2,_d=cd/2,ie={Right:0,DownRight:_d,Down:cd,DownLeft:cd+_d,Left:cd*2,UpLeft:cd*2+_d,Up:cd*3,UpRight:cd*3+_d},s=ie;function pd(a,d){let e=Math.abs(a.x-d.x),L=Math.abs(a.y-d.y);return Math.sqrt(e*e+L*L)}var Ea=I(R());function T0(a){return a.salvo<=0?a.ammunition<=0?"Spent":"Reloading":a.timer>0?"Chambering":"Ready"}function d0(a){a.timer>0&&(a.timer--,a.timer<=0&&a.salvo<=0&&(a.ammunition?(a.salvo=Math.min(a.salvoCount,a.ammunition),a.ammunition-=a.salvo):a.timer=1/0))}function a0(a){return a.timer===0}function Ia(a,d){var L;let e=(L=a.delayedShot)!=null?L:{shots:[]};e.shots.push(d),a.setDelayedShot(e)}function Qa(a,d,e,L,P,$,D,i,H,b){var c;let B=a.spawn(e).setIgnoreSolid({ids:H}).move($.x,$.y);return B.name=d,i&&B.setMotion({angle:D,vel:i}),B.ship&&Kd(B.ship),L.ship&&B.setOrigin({owner:L,ship:L.ship,turret:P}),(c=B.projectile)!=null&&c.scaling&&(B.projectile.damage+=Math.floor(rd(L,B.projectile.scaling.stat)*B.projectile.scaling.multiplier)),B.appearance&&b&&Object.assign(B.appearance,b),B}function He(a,d,e,L,P){var $;switch(e.type){case"lastMovement":return($=P==null?void 0:P.angle)!=null?$:L.firingDirection;case"nearestEnemy":return $d(a,d);case"random":return U([s.Right,s.DownRight,s.Down,s.DownLeft,s.Left,s.UpLeft,s.Up,s.UpRight]);case"relative":return wd(L.firingDirection+e.rel)}}function C0(a,d,e,L,P,$,D){var T;if($.doubleShot&&d.canDouble){let t=G(d);t.canDouble=!1,t.delay=$.player?2:1,t.appearance={fg:Ea.Colors.LIGHT_GRAY},Ia($,{turret:e,shot:t})}if(d.delay){let t=G(d);return $.player&&t.delay++,Ia($,{turret:e,shot:t}),[]}if(d.type==="array"){let t=[];for(let Q of n(a,$).filter(ed=>ed.tags.has(d.tag)).filter(Pd(["position","turret"])))t.push(...Id(a,Q.turret,K(Q.position,(T=d.offset)!=null?T:p(0,0)),P,$,D));return t}let{angle:i,beam:H,name:b,offset:B,prefab:c,vel:r}=d,J=K(L,B!=null?B:p(0,0)),F=He(J,P,i,$.ship,$.lastMovement);if(H&&r){let[t,Q]=Dd({angle:F,vel:r}),ed=p(t,Q),Gd=K(J,ed);return H.appearance.map(w0=>{let Sd=Qa(a,b,c,$,e,Gd,F,0,D,d.appearance).setMotion({angle:F,vel:0}).setLifetime({duration:H.duration});return Sd.appearance&&w0&&Object.assign(Sd.appearance,w0),$.ship&&Sd.setOrigin({owner:$,ship:$.ship,turret:e}),a.inBounds(Gd)||Sd.kill({type:"exitedMap"}),Gd=K(Gd,ed),Sd})}return[Qa(a,b,c,$,e,J,F,r,D,d.appearance)]}function Id(a,d,e,L,P,$){let{timeBetweenSalvos:D,timeBetweenShots:i}=d;--d.salvo<=0?d.timer=D:d.timer=i;let H=[];for(let b of d.shots)H.push(...C0(a,b,d,e,L,P,$));return H}function Ma(a){return(a==null?void 0:a.type)==="Player"}function e0(a,d){let e=Ma(d.ship),L=x(a,d),P=a.entities.get().filter(i=>i.ship&&Ma(i.ship)!==e);if(!P.length)return;let $=1/0,D;for(let i of P){let H=x(a,i),b=pd(L,H);b<$&&($=b,D=i)}return D}var Td=I(R()),Be={Spent:Td.Colors.DARK_GRAY,Reloading:Td.Colors.LIGHT_RED,Ready:Td.Colors.YELLOW,Chambering:Td.Colors.BROWN},Cd=class{constructor(d,e){this.g=d;this.turret=e;this.width=Math.max(e.name.length,this.stateLabel.length),this.height=2,e.ammunition>0&&e.ammunition<1/0&&this.height++}get stateLabel(){let{timer:d,salvo:e,salvoCount:L}=this.turret,P=T0(this.turret);if(P==="Spent")return"Out of Ammo";if(P==="Reloading")return`Reloading (${d})`;let $=`${e}/${L}`;return P==="Ready"?$:`${$} (${d})`}draw(d,e){this.g.term.drawString(d,e,this.turret.name,Td.Colors.WHITE);let L=T0(this.turret);this.g.term.drawString(d,e+1,this.stateLabel,Be[L]),this.height>2&&this.g.term.drawString(d,e+2,`${this.turret.ammunition} ammo left`,Td.Colors.LIGHT_GRAY)}};var F0=I(R());function Sa(a,d,e){if(!e.length)return;let L=[],P=1,$=1,D=B=>{L.push({x:P,y:$,object:B}),$+=B.height+1};for(let B of e){B.ship&&D(new Xd(a,B.ship)),B.pilot&&D(new fd(a,B.pilot,!0)),B.doubleShot&&D(new Vd(a,B));let c=n(a,B);for(let r of c.filter(Pd(["turret"])))D(new Cd(a,r.turret));B.item?D(new Zd(a,B.item)):(B.motion||B.projectile||B.homing||B.lifetime||B.explodes)&&D(new ld(a,B)),B.field&&D(new xd(a,B.field))}if(!L.length)return;let i=Math.max(...L.map(B=>B.object.width))+2,H=Math.min(d.x+2,a.term.width-i),b=Math.min(d.y,a.term.height-$);a.term.fillRect(H,b,i,$," ",F0.Colors.WHITE,F0.Colors.BLACK),a.term.drawSingleBox(H,b,i,$);for(let B of L)B.object.draw(H+B.x,b+B.y)}function L0(a,d){let e=d.x-a.x,L=d.y-a.y,P=Math.abs(e),$=Math.abs(L),D=e>0?1:-1,i=L>0?1:-1,H=V({},a),b=[V({},H)];for(let B=0,c=0;B<P||c<$;)(.5+B)/P<(.5+c)/$?(H.x+=D,B++):(H.y+=i,c++),b.push(V({},H));return b}var E=class{constructor(d,e){this.list=d;this.matches=Pd(e)}forEach(d){for(let e of this.list.get())this.matches(e)&&d(e,e)}};function t0(a){let d=new E(a.entities,["ai","position","ship"]);a.on("tick",function(){d.forEach(({ai:L,position:P},$)=>{if($.setLastMovement(),!L.attacking||!L.attacking.alive){let T=e0(a,$);if(T)L.attacking=T,a.fire("notice",{e:$,noticed:T});else return}let D=w(a,$),{layout:i}=O(a,$),H=Z(P),b=a.getDistanceMap(L.attacking),B=T=>{let{oob:t,solid:Q,wall:ed}=a.getContents(T,D);return!t&&!Q&&!ed},c=T=>B(T)?Math.abs(b.getOrDefault(T,1/0)-L.idealDistance):1/0,r=T=>i.reduce((t,{offset:Q})=>t+c(K(T,Q)),0)/i.length,J=r(H),F=[];for(let T of H0){let t=K(H,T);if(!b.has(t))continue;let Q=r(t);Q<J?(J=Q,F=[t]):Q===J&&F.push(t)}if(F.length){let T=U(F);$.move(T.x,T.y),$.setLastMovement({angle:$d(H,T)});return}})}),a.on("damage",function({e:L,source:P}){P.owner&&L!==P.owner&&L.ai&&!L.ai.attacking&&P.owner.alive&&(L.ai.attacking=P.owner)})}function r0(a){let d=new E(a.entities,["delayedShot","ship"]);a.on("tick",function(){d.forEach(({ai:L,delayedShot:P},$)=>{var D,i;if(!$.alive){$.setDelayedShot();return}for(let H=P.shots.length-1;H>=0;H--){let{turret:b,shot:B}=P.shots[H];if(--B.delay<=0){B.delay=0,P.shots.splice(H,1);let c=n(a,$),r=c.find(T=>T.turret===b),J=(D=r==null?void 0:r.position)!=null?D:x(a,$),F=(i=L==null?void 0:L.attacking)!=null&&i.alive?x(a,L.attacking):p(0,0);C0(a,B,b,J,F,$,c.map(T=>T.id))}}P.shots.length||$.setDelayedShot()})})}function J0(a){let d=new E(a.entities,["appearance","position"]);a.on("draw",function(){d.forEach(({appearance:L,position:P})=>a.drawIfVisible(u(P.x),u(P.y),L.glyph,L.fg,L.bg,L.blendMode))})}function R0(a){a.on("kill",function({e,reason:L}){var D;let{position:P,ship:$}=e;if(P&&($!=null&&$.power)&&L.type==="damage"){let i=f0[$.power],H=((D=L.source.e.projectile)==null?void 0:D.special)==="increasedDropChance",b=$.type==="Battleship"?H?92:42:H?32:2,B=(F=1)=>hd(b*F),c=[];i&l.Double&&B()&&c.push("DoubleItem"),i&l.Drain&&B()&&c.push("DrainItem"),i&l.Healthy&&B()&&c.push("HealItem"),B()&&c.push("MoneyItem"),B()&&c.push("JunkItem"),B()&&c.push("RechargeItem");let r;if(B()){let F=n(a,e).filter(T=>T.tags.has("Special")&&T.prefab&&T.turret);F.length&&(r=U(F).prefab,c.push("BombItem"))}let J=Jd([p(-1,-1),p(0,-1),p(1,-1),p(-1,0),p(0,0),p(1,0),p(-1,1),p(0,1),p(1,1)]);for(let F of c){let T=J.pop();if(!T)return;let t=K(P,T),Q=a.spawn(F).move(t.x,t.y).setMotion({angle:s.Down,vel:1});F==="BombItem"&&r&&Q.setItem({type:"bomb",prefab:r})}}})}function Qd(a,d,e){return a*(1-e)+d*e}var P0=I(R()),dd=class{constructor(d){this.points=d;this.sort()}sort(){this.points.sort(([d],[e])=>d-e)}add(d,e){return this.points.push([d,e]),this.sort(),this}get(d){let[e,L]=this.points[0];if(d<=e)return(0,P0.fromRgb)(...L);let[P,$]=this.points[this.points.length-1];if(d>=P)return(0,P0.fromRgb)(...$);let D=this.points.findIndex(([ed])=>ed>d),[i,[H,b,B,c]]=this.points[D-1],[r,[J,F,T,t]]=this.points[D],Q=(d-i)/(r-i);return(0,P0.fromRgb)(Qd(H,J,Q),Qd(b,F,Q),Qd(B,T,Q),Qd(c,t,Q))}};var na=(i=>(i[i.Effect=0]="Effect",i[i.Item=1]="Item",i[i.Ship=2]="Ship",i[i.Gun=3]="Gun",i[i.Bullet=4]="Bullet",i[i.Player=5]="Player",i[i.PlayerBullet=6]="PlayerBullet",i))(na||{}),C=na;var Ua=I(R()),be={Fire:new dd([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Blue:new dd([[0,[0,0,0,0]],[2,[0,0,255,150]],[4,[0,155,255,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Yellow:new dd([[0,[0,0,0,0]],[2,[155,155,0,150]],[4,[255,255,55,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Green:new dd([[0,[0,0,0,0]],[2,[0,215,0,150]],[4,[55,255,55,150]],[6,[215,255,215,150]],[10,[255,255,255,255]]]),Magenta:new dd([[0,[0,0,0,0]],[2,[155,0,115,150]],[4,[255,115,255,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function I0(a){if(!(a.intensity<=0))return{glyph:" ",layer:C.Effect,bg:be[a.type].get(a.intensity),blendMode:Ua.BlendMode.Add}}function Ya(a,d){let e=[],L=Math.floor(a.x-d),P=Math.ceil(a.x+d),$=Math.floor(a.y-d),D=Math.ceil(a.y+d);for(let i=$;i<=D;i++)for(let H=L;H<=P;H++){let b=pd(a,{x:H,y:i});b>=d||e.push({x:H,y:i,intensity:d-b})}return e}function Q0(a){a.on("kill",function({e,reason:L}){if(L.type==="exitedMap")return;let{explodes:P,name:$,position:D}=e;if(P&&D)for(let{x:i,y:H,intensity:b}of Ya(x(a,e),P.size))a.add(new bd(a,$+"Explosion").setPosition({x:i,y:H}).setField({type:P.type,intensity:b,falloff:P.falloff}))})}function Nd(a,d,e,L){var i;let P=a.getRoot(d);if(!P.ship)return;P.ship.type!=="Player"&&((i=L.origin)==null?void 0:i.ship.type)!=="Player"&&(e=Math.ceil(e/2));let $=e;P.ship.shield>0&&(P.ship.shield>e?(P.ship.shield-=e,$=0):($-=P.ship.shield,P.ship.shield=0)),$&&(P.ship.hp-=$);let D={e:L,owner:L};L.origin&&(D.owner=L.origin.owner,D.ship=L.origin.ship,D.turret=L.origin.turret),console.log(`${L.name}${L.origin?` (${L.origin.owner.name} #${L.origin.owner.id})`:""} hits ${P.name} for ${e}`),a.fire("damage",{e:P,amount:e,source:D}),P.ship.hp<=0&&a.kill(P,{type:"damage",source:D})}function M0(a){let d=new E(a.entities,["ship"]),e=new E(a.entities,["field","position"]);a.on("tick",function(){e.forEach(({field:P,position:$},D)=>{P.intensity-=P.falloff,D.setAppearance(I0(P)),P.intensity<1?a.kill(D,{type:"expired"}):d.forEach((i,H)=>{let{layout:b}=O(a,H);b.find(({absolute:c})=>W(c,$))&&Nd(a,H,Math.floor(P.intensity),D)})})}),a.on("spawn",function({e:P}){P.field&&P.setAppearance(I0(P.field))})}function E0(a){let d=new E(a.entities,["homing","motion","position"]);a.on("tick",function(){d.forEach(({homing:L,motion:P,position:$},D)=>{var B;if(!((B=L.target)!=null&&B.alive))return;let i=x(a,L.target),H=$d($,i),b=ta(P.angle,H);Math.abs(b)<=L.strength?P.angle=H:b<0?P.angle-=L.strength:P.angle+=L.strength,--L.duration<=0&&(D.setHoming(),D.setTrail())})})}var S0={};Ld(S0,{AcidBullet:()=>Xe,BellowMissile:()=>Je,Bullet:()=>he,CrushBullet:()=>pe,DroneBullet:()=>Ae,HomingMissile:()=>Ce,OutcryBullet:()=>fe,PlayerBullet:()=>Re,SalvoMissileA:()=>Fe,SalvoMissileB:()=>te,SalvoMissileC:()=>re,SmiteMissile:()=>Te,TalonBullet:()=>ce});var q=I(R()),he={components:{projectile:{damage:1,scaling:{stat:"body",multiplier:1}},appearance:{glyph:h.InvertedExclamation,layer:C.Bullet,fg:q.Colors.YELLOW}}},Ae={components:{projectile:{damage:1,scaling:{stat:"body",multiplier:1}},appearance:{glyph:".",layer:C.Bullet,fg:q.Colors.ORANGE}}},fe={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:"o",layer:C.Bullet,fg:(0,q.fromRgb)(255,55,135)}}},Xe={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:h.Approximates,layer:C.Bullet,fg:(0,q.fromRgb)(55,55,215)}}},ce={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:"`",layer:C.Bullet,fg:(0,q.fromRgb)(135,255,55)}}},pe={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},homing:{strength:1,duration:3},appearance:{glyph:h.Square,layer:C.Bullet,fg:(0,q.fromRgb)(175,175,0)}}},Te={components:{projectile:{damage:2,scaling:{stat:"mind",multiplier:1}},homing:{strength:10,duration:1},explodes:{size:7,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:q.Colors.ORANGE}}},Ce={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:q.Colors.DARK_RED}}},Fe={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:4},trail:{effectPrefab:"SmokePuff"},explodes:{size:8,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:q.Colors.DARK_RED}}},te={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.25,duration:5},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:q.Colors.DARK_RED}}},re={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.35,duration:8},trail:{effectPrefab:"SmokePuff"},explodes:{size:4,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:q.Colors.DARK_RED}}},Je={components:{projectile:{damage:20,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:30},trail:{effectPrefab:"SmokePuff"},explodes:{size:6,type:"Fire",falloff:1},appearance:{glyph:h.CurlyF,layer:C.Bullet,fg:q.Colors.LIGHT_RED}}},Re={components:{projectile:{damage:3,scaling:{stat:"body",multiplier:1}},appearance:{glyph:"!",layer:C.PlayerBullet,fg:q.Colors.YELLOW}}};var n0={};Ld(n0,{AirFistRange:()=>Ie,SmokePuff:()=>Qe});var Md=I(R()),Ie={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:C.Effect,bg:(0,Md.fromRgb)(0,255,255,100),blendMode:Md.BlendMode.Add}}},Qe={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:C.Effect,bg:(0,Md.fromRgb)(100,100,100,50),blendMode:Md.BlendMode.Add}}};var U0={};Ld(U0,{AcidSplash:()=>je,Bellow:()=>ke,Cleave:()=>Ue,CrushPattern:()=>Ze,DemandHomage:()=>ge,DroneGun:()=>Ve,Outcry:()=>Ye,PeaShooter:()=>Se,PlayerGun:()=>ne,Salvo:()=>Ne,ShuttleLaunch:()=>Ke,Smite:()=>se,TalonSwipe:()=>xe,TheDragonWakes:()=>qe,Veto:()=>le});var Me={Right:p(1,0),DownRight:p(1,1),Down:p(0,1),DownLeft:p(-1,1),Left:p(-1,0),UpLeft:p(-1,-1),Up:p(0,-1),UpRight:p(1,-1),None:p(0,0)},k=Me;var A=(a,d,e,L,P)=>({name:a,x:d,y:e,overlay:L,tags:P}),j=(a,d,e,L=0)=>({name:a,type:d,maxHp:e,hp:0,maxShield:L,shield:0,shieldTimer:0,firingDirection:d==="Player"?s.Up:s.Down}),M=(a,{salvoCount:d=1,timeBetweenShots:e=1,timeBetweenSalvos:L=1,ammunition:P=1/0},$)=>({name:a,shots:$,salvoCount:d,timeBetweenShots:e,timeBetweenSalvos:L,timer:0,salvo:d,ammunition:P}),Ee=["F","FR","R","BR","B","BL","L","FL"],X=a=>({type:"relative",rel:Ee.indexOf(a)*Math.PI/4}),ja={type:"nearestEnemy"},Ka={type:"random"},f=(a,d,e,L,{canDouble:P,delay:$,offset:D,beam:i}={})=>({type:"bullet",canDouble:P,name:a,prefab:d,angle:e,vel:L,delay:$,offset:D,beam:i}),o=(a,{delay:d,offset:e}={})=>({type:"array",canDouble:!1,tag:a,delay:d,offset:e});var Se={components:{turret:M("Main Gun",{salvoCount:1,timeBetweenSalvos:3},[f("Bullet","Bullet",X("F"),2,{canDouble:!0})])}},ne={components:{turret:M("Main Gun",{salvoCount:2,timeBetweenShots:0,timeBetweenSalvos:3},[f("Your Bullet","PlayerBullet",X("F"),2,{canDouble:!0})])}},Ue={components:{turret:M("Cleave",{salvoCount:1,timeBetweenSalvos:11},[o("Primary"),o("Primary",{delay:1}),o("Primary",{delay:2}),o("Primary",{delay:3}),o("Primary",{delay:4})])}},Ye={components:{turret:M("Outcry",{salvoCount:1,timeBetweenSalvos:8},[f("Outcry","OutcryBullet",X("FR"),2),f("Outcry","OutcryBullet",X("R"),2),f("Outcry","OutcryBullet",X("BR"),2),f("Outcry","OutcryBullet",X("B"),2),f("Outcry","OutcryBullet",X("BL"),2),f("Outcry","OutcryBullet",X("L"),2),f("Outcry","OutcryBullet",X("FL"),2)])}},je={components:{turret:M("Acid Splash",{salvoCount:1,timeBetweenSalvos:13},[f("Acid Splash","AcidBullet",X("BR"),2),f("Acid Splash","AcidBullet",X("BL"),2),f("Acid Splash","AcidBullet",X("R"),2,{delay:1}),f("Acid Splash","AcidBullet",X("L"),2,{delay:1}),f("Acid Splash","AcidBullet",X("FR"),2,{delay:2}),f("Acid Splash","AcidBullet",X("FL"),2,{delay:2}),f("Acid Splash","AcidBullet",X("R"),2,{delay:3}),f("Acid Splash","AcidBullet",X("L"),2,{delay:3}),f("Acid Splash","AcidBullet",X("BR"),2,{delay:4}),f("Acid Splash","AcidBullet",X("BL"),2,{delay:4})])}},Ke={components:{turret:M("Shuttle Launch",{salvoCount:1,timeBetweenSalvos:27},[f("Runabout","DroneA",X("R"),0,{offset:k.Left}),f("Runabout","DroneA",X("L"),0,{offset:k.Right})])}},le={components:{turret:M("Veto",{salvoCount:1,timeBetweenSalvos:21},[f("Veto","HomingMissile",X("B"),1),f("Wasp","DroneB",X("FL"),0,{offset:k.DownRight})])}},xe={components:{turret:M("Talon Swipe",{salvoCount:1,timeBetweenSalvos:10},[f("Talon Swipe","TalonBullet",X("R"),2),f("Talon Swipe","TalonBullet",X("L"),2),f("Talon Swipe","TalonBullet",X("R"),2,{delay:1}),f("Talon Swipe","TalonBullet",X("L"),2,{delay:1}),f("Talon Swipe","TalonBullet",X("R"),2,{delay:2}),f("Talon Swipe","TalonBullet",X("L"),2,{delay:2})])}},Ze={components:{turret:M("Crush Pattern",{salvoCount:1,timeBetweenSalvos:15},[f("Crush Pattern","CrushBullet",X("R"),1),f("Crush Pattern","CrushBullet",X("BR"),1),f("Crush Pattern","CrushBullet",X("BL"),1),f("Crush Pattern","CrushBullet",X("L"),1)])}},se={components:{turret:M("Smite",{salvoCount:1,timeBetweenSalvos:16},[f("Smite","SmiteMissile",X("L"),1),f("Smite","SmiteMissile",X("L"),1,{delay:1})])}},Ve={components:{turret:M("Stinger",{salvoCount:1,timeBetweenSalvos:5,ammunition:5},[f("Bullet","DroneBullet",ja,1,{canDouble:!0})])}},Ne={components:{turret:M("Salvo",{salvoCount:1,timeBetweenSalvos:10},[f("Missile","SalvoMissileA",X("BR"),1),f("Missile","SalvoMissileB",X("BR"),1),f("Missile","SalvoMissileC",X("BR"),1)])}},qe={components:{turret:M("The Dragon Wakes",{salvoCount:1,timeBetweenSalvos:12},[f("Drone","DroneA",X("B"),0,{offset:k.Up}),f("Missile","HomingMissile",X("FR"),2,{offset:k.DownLeft}),f("Missile","HomingMissile",X("FL"),2,{offset:k.DownRight})])}},ke={components:{turret:M("Bellow",{salvoCount:1,timeBetweenSalvos:17},[f("Bellow","BellowMissile",X("FR"),1),o("Primary"),o("Primary",{delay:1}),o("Primary",{delay:2}),o("Primary",{delay:3})])}},ge={components:{turret:M("Demand Homage",{salvoCount:1,timeBetweenSalvos:21},[f("Pulsar","DroneC",X("FR"),0,{offset:k.DownLeft}),f("Pulsar","DroneC",X("BR"),0,{offset:k.UpLeft}),f("Pulsar","DroneC",X("BL"),0,{offset:k.UpRight}),f("Pulsar","DroneC",X("FL"),0,{offset:k.DownRight})])}};var Y0={};Ld(Y0,{BombItem:()=>me,DoubleItem:()=>oe,DrainItem:()=>ye,HealItem:()=>Ge,JunkItem:()=>ue,MoneyItem:()=>Oe,RechargeItem:()=>ze});var me={components:{appearance:{glyph:h.DoubleNote,layer:C.Item},item:{type:"bomb",prefab:"BombItem"}}},oe={components:{appearance:{glyph:h.Squared,layer:C.Item},item:{type:"double"}}},ye={components:{appearance:{glyph:"%",layer:C.Item},item:{type:"drain"}}},Ge={components:{appearance:{glyph:h.Heart,layer:C.Item},item:{type:"heal"}}},ue={components:{appearance:{glyph:h.Beta,layer:C.Item},item:{type:"junk"}}},Oe={components:{appearance:{glyph:h.SetMember,layer:C.Item},item:{type:"money",value:0}}},ze={components:{appearance:{glyph:"@",layer:C.Item},item:{type:"recharge"}}};var K0={};Ld(K0,{PlayerHull:()=>ve,PlayerShip:()=>We});var j0=I(R()),ve={components:{solid:!0,appearance:{glyph:"#",layer:C.Player,fg:j0.Colors.DARK_GRAY}}},We={components:{player:{weaponArrays:["Primary","Secondary"],bombs:[]},ship:j("Ace of Clubs","Player",20,10),explodes:{type:"Fire",size:6,falloff:1}},children:[A("PlayerHull",0,0,{appearance:{glyph:h.LeftArrow}}),A("PlayerHull",1,0,{appearance:{glyph:h.Club,fg:j0.Colors.LIGHT_GRAY}}),A("PlayerHull",2,0,{appearance:{glyph:h.RightArrow}}),A("PlayerGun",1,0,void 0,["Primary"]),A("Sword",1,0,void 0,["Secondary"])]};var Z0={};Ld(Z0,{AtomSmasher:()=>cL,CruiseyWing:()=>bL,Demigod:()=>fL,DroneA:()=>iL,DroneB:()=>HL,DroneC:()=>BL,GoutOFlame:()=>AL,Gremlin:()=>XL,Hull:()=>we,Olm:()=>hL,ShipA:()=>_e,ShipB:()=>dL,ShipC:()=>aL,ShipD:()=>eL,ShipE:()=>LL,ShipF:()=>PL,ShipG:()=>$L,ShipH:()=>DL});var la=I(R()),we={components:{solid:!0,appearance:{glyph:"#",layer:C.Ship,fg:la.Colors.DARK_GRAY}}},g={idealDistance:8,firingDistance:14,speed:1},ad=A("PeaShooter",0,0,void 0,["Primary"]),id={type:"Fire",size:4,falloff:1},_e={components:{ai:g,ship:j("Axle","Escort",2),explodes:id},children:[A("Hull",0,0,{appearance:{glyph:h.Pilcrow}}),ad,A("Cleave",0,0,void 0,["Special"])]},dL={components:{ai:g,ship:j("Baying Hound","Escort",2),explodes:id},children:[A("Hull",0,0,{appearance:{glyph:h.Yen}}),ad,A("Outcry",0,0,void 0,["Special"])]},aL={components:{ai:g,ship:j("Caustic","Escort",2),explodes:id},children:[A("Hull",0,0,{appearance:{glyph:"W"}}),ad,A("AcidSplash",0,0,void 0,["Special"])]},eL={components:{ai:g,ship:j("Defiant","Escort",2),explodes:id},children:[A("Hull",0,0,{appearance:{glyph:h.Omega}}),ad,A("ShuttleLaunch",0,0,void 0,["Special"])]},LL={components:{ai:g,ship:j("Executor","Escort",2),explodes:id},children:[A("Hull",0,0,{appearance:{glyph:h.DownWedge}}),ad,A("Veto",0,0,void 0,["Special"])]},PL={components:{ai:g,ship:j("Falcon","Escort",2),explodes:id},children:[A("Hull",0,0,{appearance:{glyph:h.Pi}}),ad,A("TalonSwipe",0,0,void 0,["Special"])]},$L={components:{ai:g,ship:j("Gauntlet","Escort",2),explodes:id},children:[A("Hull",0,0,{appearance:{glyph:"M"}}),ad,A("CrushPattern",0,0,void 0,["Special"])]},DL={components:{ai:g,ship:j("Halo","Escort",2),explodes:id},children:[A("Hull",0,0,{appearance:{glyph:h.Female}}),ad,A("Smite",0,0,void 0,["Special"])]},l0={idealDistance:5,firingDistance:6,speed:1},xa=A("DroneGun",0,0,void 0,["Primary"]),x0={type:"Fire",size:3,falloff:1},iL={components:{ai:l0,ship:j("Runabout","Escort",1),explodes:x0},children:[A("Hull",0,0,{appearance:{glyph:h.Theta}}),ad]},HL={components:{ai:l0,ship:j("Wasp","Escort",1),explodes:x0},children:[A("Hull",0,0,{appearance:{glyph:h.SymbolED}}),xa]},BL={components:{ai:l0,ship:j("Pulsar","Escort",1),explodes:x0},children:[A("Hull",0,0,{appearance:{glyph:h.Silcrow}}),xa]},Ed={type:"Fire",size:6,falloff:1},bL={components:{ai:g,ship:j("Cruisey Wing","Battleship",10,5),explodes:Ed},children:[A("Hull",0,0,{appearance:{glyph:h.Not}}),A("Hull",1,0,{appearance:{glyph:h.HorizontalDivide}}),A("Hull",2,0,{appearance:{glyph:h.NotFlip}}),A("PeaShooter",0,0,void 0,["Primary"]),A("PeaShooter",1,0,void 0,["Primary"]),A("PeaShooter",2,0,void 0,["Primary"]),A("Salvo",1,0,void 0,["Special"])]},hL={components:{ai:g,ship:j("Olm","Battleship",15,4),explodes:Ed},children:[A("Hull",0,0,{appearance:{glyph:h.Cent}}),A("Hull",0,1,{appearance:{glyph:h.ResizeVertical}}),A("Hull",0,2,{appearance:{glyph:h.BoxDownSingleHorizontalDouble}}),A("PeaShooter",0,2,void 0,["Primary"]),A("TheDragonWakes",0,0,void 0,["Special"])]},AL={components:{ai:g,ship:j("Gout-o'-flame","Battleship",5,20),explodes:Ed},children:[A("Hull",0,0,{appearance:{glyph:h.Pentagon}}),A("Hull",1,0,{appearance:{glyph:h.BoxVerticalDoubleHorizontalSingle}}),A("Hull",2,0,{appearance:{glyph:h.Pentagon}}),A("Hull",1,1,{appearance:{glyph:h.BoxUpDoubleHorizontalSingle}}),A("PeaShooter",1,1,void 0,["Primary"]),A("Bellow",1,1,void 0,["Special"])]},fL={components:{ai:g,ship:j("Demigod","Battleship",30,15),explodes:Ed},children:[A("Hull",1,0,{appearance:{glyph:h.CapitalUUmlaut}}),A("Hull",0,1,{appearance:{glyph:"}"}}),A("Hull",1,1,{appearance:{glyph:h.RingInvert}}),A("Hull",2,1,{appearance:{glyph:"{"}}),A("Hull",1,2,{appearance:{glyph:"Y"}}),A("PeaShooter",1,2,void 0,["Primary"]),A("DemandHomage",1,1,void 0,["Special"])]},XL={components:{ai:g,ship:j("Gremlin","Battleship",30,15),explodes:Ed},children:[A("Hull",1,0,{appearance:{glyph:h.ResizeVertical}}),A("Hull",2,0,{appearance:{glyph:h.ResizeVertical}}),A("Hull",0,1,{appearance:{glyph:"]"}}),A("Hull",1,1,{appearance:{glyph:h.BoxLeftSingleUpDouble}}),A("Hull",2,1,{appearance:{glyph:h.BoxRightSingleUpDouble}}),A("Hull",3,1,{appearance:{glyph:h.Male}}),A("Hull",1,2,{appearance:{glyph:h.BoxVerticalSingle}}),A("Hull",2,2,{appearance:{glyph:h.Gamma}}),A("PeaShooter",1,2,void 0,["Primary"]),A("PeaShooter",2,2,void 0,["Primary"])]},cL={components:{ai:g,ship:j("Atom Smasher","Battleship",10,20),explodes:Ed},children:[A("Hull",1,0,{appearance:{glyph:h.EHat}}),A("Hull",2,0,{appearance:{glyph:"-"}}),A("Hull",3,0,{appearance:{glyph:h.AHat}}),A("Hull",0,1,{appearance:{glyph:h.Fill2}}),A("Hull",1,1,{appearance:{glyph:h.Fill1}}),A("Hull",2,1,{appearance:{glyph:h.Fill2}}),A("Hull",3,1,{appearance:{glyph:h.Fill3}}),A("Hull",4,1,{appearance:{glyph:h.Filled}}),A("PeaShooter",0,1,void 0,["Primary"]),A("PeaShooter",1,1,void 0,["Primary"]),A("PeaShooter",2,1,void 0,["Primary"]),A("PeaShooter",3,1,void 0,["Primary"]),A("PeaShooter",4,1,void 0,["Primary"])]};var s0={};Ld(s0,{Laser:()=>FL,LaserBeam:()=>tL,Multiball:()=>TL,MultiballShot:()=>pL,Overload:()=>ML,OverloadBullet:()=>QL,StubbornDescent:()=>CL,SwitchbladeBullet:()=>rL,Switchblades:()=>JL,Triangulate:()=>IL,TriangulateMissile:()=>RL});var Hd=I(R());var pL={components:{projectile:{damage:7},appearance:{glyph:"+",layer:C.Bullet,fg:(0,Hd.fromRgb)(255,255,55)}}},TL={components:{turret:M("Multiball",{salvoCount:1,timeBetweenSalvos:15},[f("Multiball","MultiballShot",X("FR"),2),f("Multiball","MultiballShot",X("R"),2),f("Multiball","MultiballShot",X("L"),2),f("Multiball","MultiballShot",X("FL"),2),f("Runabout","DroneA",X("BR"),0,{offset:k.UpLeft}),f("Runabout","DroneA",X("BL"),0,{offset:k.UpRight})])}},CL={components:{turret:M("Stubborn Descent",{salvoCount:13,timeBetweenSalvos:21},[o("Primary")])}},FL={components:{projectile:{damage:2},appearance:{glyph:"|",layer:C.Bullet,fg:Hd.Colors.WHITE,bg:Hd.Colors.LIGHT_BLUE}}},tL={components:{turret:M("Laser Beam",{salvoCount:10,timeBetweenSalvos:30},[f("Laser","Laser",X("F"),1,{offset:k.Down,beam:{duration:1,appearance:new Array(60)}})])}},rL={components:{projectile:{damage:9},appearance:{glyph:h.ResizeHorizontal,layer:C.Bullet,fg:Hd.Colors.LIGHT_BLUE}}},JL={components:{turret:M("Switchblades",{salvoCount:1,timeBetweenSalvos:11},[...Ad(9).map(a=>f("Switchblade","SwitchbladeBullet",X("FR"),1,{delay:a})),...Ad(9).map(a=>f("Switchblade","SwitchbladeBullet",X("FL"),1,{delay:a}))])}},RL={components:{projectile:{damage:10},homing:{strength:.1,duration:1/0},explodes:{type:"Blue",size:4,falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:Hd.Colors.DARK_CYAN}}},IL={components:{turret:M("Triangulate",{salvoCount:1,timeBetweenSalvos:17},[f("Triangulate","TriangulateMissile",X("FR"),1),f("Triangulate","TriangulateMissile",X("R"),1,{delay:1}),f("Triangulate","TriangulateMissile",X("BR"),1,{delay:2}),f("Triangulate","TriangulateMissile",X("B"),1,{delay:3}),f("Triangulate","TriangulateMissile",X("BL"),1,{delay:4}),f("Triangulate","TriangulateMissile",X("L"),1,{delay:5}),f("Triangulate","TriangulateMissile",X("FL"),1,{delay:6})])}},QL={components:{projectile:{damage:7},appearance:{glyph:h.Smiley,layer:C.Bullet,fg:Hd.Colors.LIGHT_GRAY}}},ML={components:{turret:M("Overload",{salvoCount:1,timeBetweenSalvos:20},Ad(11).map(a=>f("Overload","OverloadBullet",Ka,2,{delay:a})))}};var V0={};Ld(V0,{Sword:()=>SL,SwordBullet:()=>EL});var Fd=I(R());var EL={components:{projectile:{damage:5,special:"increasedDropChance",scaling:{stat:"spirit",multiplier:1}},appearance:{glyph:h.Star,layer:C.PlayerBullet,fg:Fd.Colors.LIGHT_GREEN}}},SL={components:{turret:M("Sword",{salvoCount:1,timeBetweenSalvos:20},[f("Stab","SwordBullet",{type:"lastMovement"},1,{beam:{duration:2,appearance:[{glyph:h.Star,fg:Fd.Colors.LIGHT_GREEN},{glyph:"o",fg:Fd.Colors.LIGHT_GREEN},{glyph:h.Diamond,fg:Fd.Colors.LIGHT_GREEN},{glyph:h.Ring,fg:Fd.Colors.DARK_GREEN},{glyph:h.Dot,fg:Fd.Colors.DARK_GRAY}]}})])}};var Za=V(V(V(V(V(V(V(V({},S0),n0),Y0),U0),K0),Z0),s0),V0);function $0(a){return Za[a]}function N0(a,d){return a.add(new bd(a,d).applyPrefab(d,Za[d]))}var sa=["Cleave","Outcry","AcidSplash","ShuttleLaunch","Veto","TalonSwipe","CrushPattern","Smite","Salvo","TheDragonWakes","Bellow","DemandHomage","Multiball","StubbornDescent","Switchblades","Triangulate","Overload"];var Va=I(R()),qd=class{constructor(d,e){this.g=d;this.player=e;this.lines=e.bombs.map(L=>{var P,$,D;return(D=($=(P=$0(L).components)==null?void 0:P.turret)==null?void 0:$.name)!=null?D:"?"}),this.width=this.lines.reduce((L,P)=>Math.max(L,P.length),0),this.height=this.lines.length}draw(d,e){for(let L of this.lines)this.g.term.drawString(d,e++,L,Va.Colors.WHITE)}};var v=I(R()),Bd=6;function q0(a){let{mapHeight:d,term:e}=a;a.on("draw",function(){let P=a.player,{pilot:$,player:D,ship:i}=P;e.fillRect(0,d,e.width,Bd," ",v.Colors.WHITE,v.Colors.BLACK),e.drawSingleBox(0,d,e.width,Bd);let H=1,b=d+1,B=new Xd(a,i);B.draw(H,b);let c=H+Math.floor((B.width-11)/2);new fd(a,$,!1).draw(c,b+3),H+=B.width+1,e.drawChar(H-1,b-1,h.BoxDownSingleHorizontalSingle,v.Colors.WHITE),e.drawVLine(H-1,b,Bd-2,h.BoxVerticalSingle,v.Colors.WHITE),e.drawChar(H-1,b+Bd-2,h.BoxUpSingleHorizontalSingle,v.Colors.WHITE);for(let J of D.weaponArrays){let F=H,T=n(a,P).filter(t=>t.tags.has(J)).filter(Pd(["turret"]));for(let t of T){let Q=new Cd(a,t.turret);Q.draw(H,b+1),H+=Q.width+1}e.drawString(F,b,J,v.Colors.LIGHT_CYAN),H=Math.max(H,F+J.length+1)}D.bombs.length&&(e.drawChar(H-1,b-1,h.BoxDownSingleHorizontalSingle,v.Colors.WHITE),e.drawVLine(H-1,b,Bd-2,h.BoxVerticalSingle,v.Colors.WHITE),e.drawChar(H-1,b+Bd-2,h.BoxUpSingleHorizontalSingle,v.Colors.WHITE),new qd(a,D).draw(H,b))})}function k0(a){let d=new E(a.entities,["lifetime"]);a.on("tick",function(){d.forEach(({lifetime:L},P)=>{if(--L.duration<=0)a.kill(P,{type:"expired"});else if(L.decayingAppearance&&P.appearance){let $=L.decayingAppearance[L.duration-1];Object.assign(P.appearance,$)}})})}function g0(a,d,e){if(!(!d.ship||!d.player))switch(e.type){case"double":d.doubleShot?d.doubleShot.duration+=9:d.setDoubleShot({duration:9});return;case"heal":{let L=Math.ceil(d.ship.maxHp/4);d.ship.hp=Math.min(d.ship.maxHp,d.ship.hp+L);return}case"recharge":{for(let L of n(a,d))if(L.turret)for(;L.turret.timer<1/0&&L.turret.timer>0;)d0(L.turret);return}case"bomb":for(d.player.bombs.push(e.prefab);d.player.bombs.length>Aa(d);)d.player.bombs.shift();break;case"junk":if(hd(fa(d)))return g0(a,d,{type:"bomb",prefab:U(sa)});break}}function m0(a){let d=new E(a.entities,["motion","position"]);a.on("tick",function(){d.forEach(({motion:L,position:P,projectile:$,ignoreSolid:D,item:i},H)=>{let[b,B]=Dd(L),c=p(P.x+b,P.y+B),r=L0(Z(P),Z(c)),J=!1,F;for(let T of r){if(!a.inBounds(T)){a.kill(H,{type:"exitedMap"});return}a.move(H,T);let{wall:t,solid:Q}=a.getContents(T,D==null?void 0:D.ids);if(t){J=!0;break}else if(Q){F=Q;break}}J?a.kill(H,{type:"hitWall"}):F?($&&Nd(a,F,$.damage,H),i&&g0(a,a.getRoot(F),i),a.kill(H,{type:"hitEntity",other:F})):a.move(H,c)})})}function o0(a){a.on("playerMove",function({move:e}){let L=a.player,P=L.position,$=K(P,e);Ha(a,L,$).length||(L.move($.x,$.y),L.setLastMovement({angle:$d(P,$)}),a.tick())}),a.on("playerFire",function({array:e}){let L=a.player,P=L.player.weaponArrays[e],$=n(a,L),D=$.filter(H=>H.tags.has(P)),i=!1;for(let H of D)!H.position||!H.turret||a0(H.turret)&&(Id(a,H.turret,H.position,p(0,0),L,$.map(b=>b.id)),i=!0);i&&(L.setLastMovement(),a.tick())}),a.on("playerBomb",function(){var $;let e=a.player,L=e.player.bombs.shift();if(!L)return;let P=$0(L);if(($=P.components)!=null&&$.turret){let D=G(P.components.turret),i=x(a,e),H=e0(a,e),b=H?x(a,H):p(0,0),B=Id(a,D,i,b,e,w(a,e));for(let c of B)jd(c,["ai","ship"])&&(c.ai.attacking=H,c.ship.firingDirection=s.Up),c.homing&&(c.homing.target=H);e.setLastMovement(),a.tick()}})}function kd(a){return typeof a!="undefined"}var Na=I(R());function y0(a){let d=new E(a.entities,["ship"]);a.on("tick",function(){d.forEach((L,P)=>{P.doubleShot&&--P.doubleShot.duration<=0&&P.setDoubleShot()})}),a.on("draw",function(){let L=n(a,a.player).map(P=>P.position).filter(kd);if(a.player.doubleShot)for(let P of L)a.blend(P.x,P.y,Na.Colors.LIGHT_GRAY)})}function G0(a){let d=new E(a.entities,["ship"]);a.on("tick",function(){d.forEach(({ship:L},P)=>{if(L.shield>=L.maxShield){L.shieldTimer=0;return}let $=ha(P);++L.shieldTimer>=$&&(L.shield++,L.shieldTimer=0)})})}function u0(a){a.on("waveBegin",function({wave:L,difficulty:P,pilot:$}){let D=(P+L.difficulty)*3,i=[];for(let B of L.groups)for(let c=0;c<B.count;c++)i.push(U(B.prefabs));let H=L.groups.filter(B=>B.type==="Escort");for(let B=0;B<P;B++){let c=U(H);i.push(U(c.prefabs))}let b=Math.floor(Math.random()*i.length);for(let B=0;B<i.length;B++){let c=B===b&&$!==void 0,r=i[B],J=Ta(D,c),F=Ca(a,r,J,c?$:void 0),T=Fa(a,F);F.move(T.x,T.y)}});let d=1/0;a.on("kill",({e})=>{if(!e.ship)return;a.entities.get().filter(P=>P.alive&&P.ship&&P.ship.type!=="Player").length||(d=5)}),a.on("tick",()=>{--d<=0&&(d=1/0,a.fire("waveNext",void 0))})}function O0(a){a.on("move",function({e,old:L,pos:P}){e.trail&&!W(L,P)&&a.spawn(e.trail.effectPrefab).setPosition(L)})}function z0(a){let d=new E(a.entities,["position","turret"]);a.on("tick",function(){d.forEach(({position:L,turret:P},$)=>{var b;d0(P);let D=a.getRoot($);if(!jd(D,["ai","ship"]))return;let i=D.ai.attacking;if(!(i!=null&&i.alive))return;let H=x(a,i);if(!(pd(L,H)>((b=D.ai.firingDistance)!=null?b:1/0))&&a0(P))for(let B of Id(a,P,L,H,D,w(a,D)))B.homing&&(B.homing.target=i),B.ai&&(B.ai.attacking=i)})})}function qa(a){k0(a),E0(a),r0(a),z0(a),M0(a),G0(a),m0(a),t0(a),u0(a),J0(a),q0(a),O0(a),Q0(a),R0(a),y0(a),o0(a)}var Y=I(R());var gd=class{constructor(d,e){this.g=d;this.campaign=e;this.dirty=!0,this.examining=[]}refresh(){this.dirty=!0}init(){let{g:d}=this;this.examineAt=void 0,this.examining=[],this.waves=pa(),d.blankMap(),d.entities.clearExceptFor(w(d,d.player));let{width:e,height:L}=O(d,d.player);d.player.move(u(d.mapWidth/2-e/2),d.mapHeight-L-4),d.player.ship.shield=d.player.ship.maxShield,qa(d),this.nextWave(),d.on("waveNext",this.nextWave.bind(this))}nextWave(){let d=this.waves.shift();if(d){let e=this.waves.length===0?this.campaign.currentSector.star:void 0;this.g.fire("waveBegin",{wave:d,difficulty:this.campaign.difficulty,pilot:e});return}this.g.player.alive&&(this.campaign.currentSector.completed=!0)}draw(){let{map:d,mapWidth:e,mapHeight:L,overlays:P,player:$,term:D}=this.g;for(let i=0;i<L;i++)for(let H=0;H<e;H++){let b=d.grid[i][H];D.drawChar(H,i,0,b.fg,b.bg)}if(this.g.fire("draw",void 0),this.dirty=!1,this.showOverlay){let i=P.get(this.showOverlay);if(i)for(let H=0;H<L;H++)for(let b=0;b<e;b++){let B=i.get({x:b,y:H})||1/0,c=B===1/0?"-":B<10?`${B}`:"*";D.drawChar(b,H,c,Y.Colors.LIGHT_RED)}}if(this.examineAt){Sa(this.g,this.examineAt,this.examining);for(let i of this.examining){let{motion:H,position:b}=i;if(H&&b){let[B,c]=Dd(H),r=p(b.x+B,b.y+c),J=L0(Z(b),Z(r));for(let F of J)this.g.blend(F.x,F.y,Y.Colors.DARK_RED)}}}$.alive?this.campaign.currentSector.completed&&(D.drawCenteredString(D.width/2,5,"SECTOR COMPLETE",Y.Colors.WHITE,Y.Colors.BLACK),D.drawCenteredString(D.width/2,7,"Hit Enter to continue",Y.Colors.WHITE,Y.Colors.BLACK)):(D.drawCenteredString(D.width/2,5,"YOU HAVE PERISHED!",Y.Colors.LIGHT_RED,Y.Colors.BLACK),D.drawCenteredString(D.width/2,7,"Hit Q to try again",Y.Colors.LIGHT_RED,Y.Colors.BLACK))}update(){(this.g.term.mouse.dx||this.g.term.mouse.dy)&&this.refresh(),this.handleKeys(),this.dirty&&(this.handleMouseMove(),this.draw())}examine(d){this.examineAt=d,this.dirty=!0;let{solid:e,other:L}=this.g.getContents(d),P=new Set;e&&P.add(this.g.getRoot(e));for(let $ of L)P.add(this.g.getRoot($));this.examining=[...P]}handleMouseMove(){let{x:d,y:e}=this.g.term.mouse;this.examine({x:d,y:e})}handleKeys(){let{player:d,term:e}=this.g;if(!d.alive){(e.isKeyPressed(Y.Key.VK_Q)||e.isKeyPressed(Y.Key.VK_ESCAPE))&&(this.g.setMode(new td(this.g)),e.fillRect(0,0,e.width,e.height," ",Y.Colors.WHITE,Y.Colors.BLACK));return}if(this.campaign.currentSector.completed&&(e.isKeyPressed(Y.Key.VK_ENTER)||e.isKeyPressed(Y.Key.VK_NUMPAD_ENTER))){this.campaign.endCombat();return}let L=e.getMovementKey();if(L){this.g.fire("playerMove",{move:L});return}if(e.isKeyPressed(Y.Key.VK_1)){this.g.fire("playerFire",{array:0});return}if(e.isKeyPressed(Y.Key.VK_2)){this.g.fire("playerFire",{array:1});return}if(e.isKeyPressed(Y.Key.VK_SPACE)){this.g.fire("playerBomb",void 0);return}}};var md=class{constructor(d,e,L){this.width=d;this.height=e;this.grid=[];for(let P=0;P<e;P++){let $=[];for(let D=0;D<d;D++)$.push(L(D,P));this.grid.push($)}}contains({x:d,y:e}){return d>=0&&d<this.width&&e>=0&&e<this.height}get({x:d,y:e}){return this.grid[e][d]}getPositions(){let d=[];for(let e=0;e<this.height;e++)for(let L=0;L<this.width;L++)d.push({x:L,y:e});return d}};var nL={name:"Bodini",star:!0,body:4,mind:2,spirit:3,talent:2,class:[],special:"Multiball"},UL={name:"Splintertooth",star:!0,body:3,mind:3,spirit:3,talent:2,class:[],special:"StubbornDescent"},YL={name:"Gruff",star:!0,body:2,mind:2,spirit:4,talent:3,class:[],special:"LaserBeam"},jL={name:"Limmhesto",star:!0,body:3,mind:3,spirit:3,talent:2,class:[],special:"Switchblades"},KL={name:"Ceegrave",star:!0,body:1,mind:4,spirit:3,talent:3,class:[],special:"Triangulate"},lL={name:"Sensoria",star:!0,body:4,mind:2,spirit:4,talent:1,class:[],special:"Overload"},xL=[nL,UL,YL,jL,KL,lL],ka=xL;var m=I(R());var ga="./claw yr way back-WFUTJ3MJ.mp3";var v0;function W0(){return v0||(v0=new Promise(a=>{let d=new Audio(ga);d.addEventListener("canplaythrough",()=>{d.play(),d.addEventListener("ended",()=>{d.currentTime=0,d.play()}),a(d)})})),v0}var od=class{constructor(d,e,L){this.g=d;this.shipPrefab=e;this.pilot=L;this.dirty=!0}get currentSector(){return this.space.get(this.position)}refresh(){this.dirty=!0}init(){let{g:d}=this;d.clearEventHandlers(),d.entities.clear(),d.player=this.makePlayer(),this.difficulty=0,this.position=p(2,2),this.space=new md(5,5,()=>({completed:!1}));let e=new Set,L=this.space.getPositions().filter(P=>!W(this.position,P));for(;e.size<6;){let P=U(ka);if(!e.has(P)){e.add(P);let $=U(L),D=this.space.get($);D.star=P;let i=L.indexOf($);L.splice(i,1)}}W0(),this.startCombat()}startCombat(){this.g.setMode(new gd(this.g,this))}endCombat(){this.g.clearEventHandlers(),this.currentSector.completed=!0,this.currentSector.star=void 0,this.difficulty++,this.g.mode=this,this.refresh()}makePlayer(){let{g:d,shipPrefab:e,pilot:L}=this,P=d.spawn(e);if(!P.ship)throw new Error(`Ship prefab ${e} doesn't have a ship component!`);return zd(d,P,L),Kd(P.ship),P}draw(){let{term:d}=this.g;d.fillRect(0,0,d.width,d.height," ",m.Colors.WHITE,m.Colors.BLACK);let e=this.space.get(this.position),L=d.width/2;d.drawCenteredString(L,2,"Known Space",m.Colors.WHITE),e.completed||(d.drawCenteredString(L,4,"Hit Enter to fight!",m.Colors.WHITE),e.star&&d.drawCenteredString(L,34,`You will face: ${e.star.name}!`,m.Colors.YELLOW));let P=(d.width-25)/2,$=(d.height-25)/2;for(let D=0;D<5;D++){let i=$+D*5;for(let H=0;H<5;H++){let b=P+H*5,B={x:H,y:D},c=this.space.get(B);d.fillRect(b,i,5,5," ",void 0,c.completed?m.Colors.BLACK:m.Colors.DARK_RED),d.drawSingleBox(b,i,5,5,m.Colors.WHITE),W(B,this.position)?d.drawChar(b+2,i+2,"@",m.Colors.LIGHT_CYAN):c.star&&d.drawChar(b+2,i+2,"*",m.Colors.YELLOW)}}this.dirty=!1}handleKeys(){let d=this.space.get(this.position);!d.completed&&(this.g.term.isKeyPressed(m.Key.VK_ENTER)||this.g.term.isKeyPressed(m.Key.VK_NUMPAD_ENTER))&&this.startCombat();let e=this.g.term.getMovementKey();if(d.completed&&e){let L=K(this.position,e);this.space.contains(L)&&(this.position=L,this.dirty=!0)}}update(){this.handleKeys(),this.dirty&&this.draw()}};var S=I(R()),td=class{constructor(d,e=5,L=100){this.g=d;this.starfieldSpeed=e;this.starCount=L}refresh(){this.dirty=!0}init(){this.dirty=!0,this.pilot={name:"Player",player:!0,body:1,mind:1,spirit:1,talent:1,class:[]},this.points=6,this.starfieldCounter=0,this.stars=[];for(let d=0;d<this.starCount;d++)this.stars.push(this.newStar())}draw(){let{term:d}=this.g;d.clear();for(let D of this.stars){let{x:i,y:H}=Z(D);d.drawChar(i,H,D.c,D.fg)}let e=d.width/2;d.drawCenteredString(e,2,"CRAVESPACE",S.Colors.WHITE),d.drawCenteredString(e,9,"Create your Pilot",S.Colors.WHITE),d.drawCenteredString(e,10,`${this.points} points`,S.Colors.YELLOW);let L=2,P=Math.floor((d.width-L*2)/4),$=L+P/2;this.drawStat("body",$),this.drawStat("mind",$+P),this.drawStat("spirit",$+P*2),this.drawStat("talent",$+P*3),this.points===0&&d.drawCenteredString(e,20,"Hit Enter to begin!",S.Colors.WHITE),this.dirty=!1}drawStat(d,e){let{term:L}=this.g,P=`(${d[0].toUpperCase()})${d.slice(1)}`,$=this.pilot[d];L.drawCenteredString(e,13,P,S.Colors.LIGHT_CYAN),L.drawCenteredString(e,14,$.toString(),Od[$])}update(){this.handleStarfield(),this.handleKeys(),this.dirty&&this.draw()}newStar(){let{term:d}=this.g,e=U([S.Colors.DARK_RED,S.Colors.LIGHT_RED,S.Colors.YELLOW,S.Colors.LIGHT_CYAN,S.Colors.WHITE]),L=.5+Math.random(),P=L<.75?".":L<1.25?h.Dot:"*",$=Math.random()*Math.PI*2;return{x:d.width/2,y:d.height/2,c:P,fg:e,vel:L,angle:$}}handleStarfield(){if(this.starfieldCounter<this.starfieldSpeed){this.starfieldCounter++;return}this.starfieldCounter=0,this.dirty=!0;let{width:d,height:e}=this.g.term;for(let L of this.stars){let[P,$]=Dd(L);L.x+=P,L.y+=$,(L.x<0||L.x>=d||L.y<0||L.y>=e)&&Object.assign(L,this.newStar())}}isPressed(d,e){let L=this.g.term.isKeyDown(S.Key.VK_SHIFT_LEFT)||this.g.term.isKeyDown(S.Key.VK_SHIFT_RIGHT);return this.g.term.isKeyPressed(d)&&e===L}changeStat(d,e){let L=this.pilot[d]+e;if(L<1||L>4)return!1;this.points-=e,this.pilot[d]=L,this.dirty=!0}handleKeys(){this.points>0&&(this.isPressed(S.Key.VK_B,!1)&&this.changeStat("body",1),this.isPressed(S.Key.VK_M,!1)&&this.changeStat("mind",1),this.isPressed(S.Key.VK_S,!1)&&this.changeStat("spirit",1),this.isPressed(S.Key.VK_T,!1)&&this.changeStat("talent",1)),this.isPressed(S.Key.VK_B,!0)&&this.changeStat("body",-1),this.isPressed(S.Key.VK_M,!0)&&this.changeStat("mind",-1),this.isPressed(S.Key.VK_S,!0)&&this.changeStat("spirit",-1),this.isPressed(S.Key.VK_T,!0)&&this.changeStat("talent",-1),this.points===0&&(this.g.term.isKeyPressed(S.Key.VK_ENTER)||this.g.term.isKeyPressed(S.Key.VK_NUMPAD_ENTER))&&this.g.setMode(new od(this.g,"PlayerShip",this.pilot))}};var D0=I(R()),yd=class{constructor(d,e,L){this.term=d;this.mapWidth=e;this.mapHeight=L;d.update=this.update.bind(this),this.map=new D0.Console(e,L,()=>!0),this.lastEntityId=0,this.entities=new Ud(Da),this.overlays=new Map,this.clearEventHandlers(),this.setMode(new td(this))}setMode(d){this.mode=d,this.mode.init()}clearEventHandlers(){this.eventCallbacks=$a(ia.map(d=>[d,[]]))}fire(d,e){for(let L of this.eventCallbacks[d])L(e)}on(d,e){this.eventCallbacks[d].push(e)}spawn(d){return N0(this,d)}refresh(){this.mode.refresh()}add(d){return this.refresh(),this.entities.add(d),this.fire("spawn",{e:d}),d}kill(d,e){d.alive&&(d.kill(e),this.fire("kill",{e:d,reason:e}))}move(d,e){let L=d.position;d.move(e.x,e.y),L&&this.fire("move",{e:d,old:L,pos:e})}blankMap(){let{map:d,mapHeight:e,mapWidth:L}=this;d.clear();for(let P=0;P<e;P++)for(let $=0;$<L;$++)d.setBlocked($,P,!1),d.setBlockedSight($,P,!1);d.computeFov(0,0,1/0)}drawIfVisible(d,e,L,P,$,D){this.map.isVisible(d,e)&&(D?this.term.drawCell(d,e,{bg:$},D):this.term.drawChar(d,e,L,P,$))}blend(d,e,L){this.term.drawCell(d,e,{bg:L},D0.BlendMode.Add)}getRoot(d){return d.attachment?this.getRoot(d.attachment.parent):d}getContents(d,e=[]){let L=Z(d);if(!this.inBounds(L))return{oob:!0,other:[]};let P=this.map.isBlocked(L.x,L.y),$=this.entities.get().filter(i=>i.position&&W(L,i.position)),D=$.filter(i=>!e.includes(i.id)).find(i=>i.solid);return{wall:P,solid:D,other:$.filter(i=>!i.solid)}}tick(){this.overlays.clear(),this.fire("tick",void 0),this.entities.clearDead()}update(){this.mode.update()}inBounds(d){return d.x>=0&&d.y>=0&&d.x<this.mapWidth&&d.y<this.mapHeight}getDistanceMap(d){let e=`${d.id}.distance`,L=this.overlays.get(e);return L||(L=b0(n(this,d).map(P=>P.position).filter(kd),this.inBounds.bind(this)),this.overlays.set(e,L)),L}};var i0=I(R());function sL(a){let L=i0.DEFAULT_FONT,P=document.createElement("div");a.appendChild(P);let $=()=>{let b=60*L.charWidth,B=40*L.charHeight,c=Math.floor(window.innerWidth/b),r=Math.floor(window.innerHeight/B),J=Math.min(c,r);P.style.width=`${b*J}px`,P.style.height=`${B*J}px`};window.addEventListener("resize",$),$();let D=document.createElement("canvas");P.appendChild(D),requestAnimationFrame(()=>D.focus());let i=new i0.Terminal(D,60,40,{font:L}),H=new yd(i,60,40-Bd);window.g=H}window.addEventListener("load",()=>sL(document.body));})();
//# sourceMappingURL=bundle.js.map
