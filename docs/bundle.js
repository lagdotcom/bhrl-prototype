"use strict";(()=>{var ne=Object.create;var D=Object.defineProperty;var oe=Object.getOwnPropertyDescriptor;var ae=Object.getOwnPropertyNames,Vt=Object.getOwnPropertySymbols,ce=Object.getPrototypeOf,Lt=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable;var qt=(s,t,e)=>t in s?D(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,S=(s,t)=>{for(var e in t||={})Lt.call(t,e)&&qt(s,e,t[e]);if(Vt)for(var e of Vt(t))le.call(t,e)&&qt(s,e,t[e]);return s};var m=(s,t)=>()=>(t||s((t={exports:{}}).exports,t),t.exports),O=(s,t)=>{for(var e in t)D(s,e,{get:t[e],enumerable:!0})},ue=(s,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of ae(t))!Lt.call(s,r)&&r!==e&&D(s,r,{get:()=>t[r],enumerable:!(i=oe(t,r))||i.enumerable});return s};var C=(s,t,e)=>(e=s!=null?ne(ce(s)):{},ue(t||!s||!s.__esModule?D(e,"default",{value:s,enumerable:!0}):e,s));var T=m((ms,Ot)=>{Ot.exports=globalThis.wglt});var Rt=m((Ws,Xt)=>{Xt.exports=globalThis.RBush});var V=m((Ds,Ht)=>{Ht.exports=globalThis.SAT});var w=m(d=>{"use strict";var Pe=d&&d.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(d,"__esModule",{value:!0});d.Types=d.SATPolygon=d.SATVector=d.Response=d.RBush=void 0;var be=Pe(Rt());Object.defineProperty(d,"RBush",{enumerable:!0,get:function(){return be.default}});var xt=V();Object.defineProperty(d,"Response",{enumerable:!0,get:function(){return xt.Response}});Object.defineProperty(d,"SATVector",{enumerable:!0,get:function(){return xt.Vector}});Object.defineProperty(d,"SATPolygon",{enumerable:!0,get:function(){return xt.Polygon}});var we;(function(s){s.Ellipse="Ellipse",s.Line="Line",s.Circle="Circle",s.Box="Box",s.Point="Point",s.Polygon="Polygon"})(we=d.Types||(d.Types={}))});var A=m(c=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0});c.generateId=c.toJSON=c.drawPolygon=c.getSATFunction=c.getBounceDirection=c.ensureConvex=c.mapArrayToVector=c.mapVectorToArray=c.intersectLinePolygon=c.intersectLineLine=c.intersectLineCircle=c.dashLineTo=c.clonePointsArray=c.checkAInB=c.intersectAABB=c.bodyMoved=c.extendBody=c.clockwise=c.distance=c.ensurePolygonPoints=c.ensureVectorPoint=c.createBox=c.createEllipse=void 0;var g=V(),J=w();function _e(s,t=s,e=1){let i=Math.PI*Math.hypot(s,t)*2,r=Math.max(8,Math.ceil(i/Math.max(1,e)));return Array.from({length:r},(n,o)=>{let a=o/r*2*Math.PI,l=Math.cos(a)*s,u=Math.sin(a)*t;return new g.Vector(l,u)})}c.createEllipse=_e;function Ae(s,t){return[new g.Vector(0,0),new g.Vector(s,0),new g.Vector(s,t),new g.Vector(0,t)]}c.createBox=Ae;function Nt(s={}){return s instanceof g.Vector?s:new g.Vector(s.x||0,s.y||0)}c.ensureVectorPoint=Nt;function Be(s){if(!s)throw new Error("No points array provided");let t=s.map(Nt);return Wt(t)?t.reverse():t}c.ensurePolygonPoints=Be;function Ce(s,t){return Math.hypot(s.x-t.x,s.y-t.y)}c.distance=Ce;function Wt(s){let t=0;for(let e=0;e<s.length;e++){let i=s[e],r=s[(e+1)%s.length];t+=(r.x-i.x)*(r.y+i.y)}return t>0}c.clockwise=Wt;function Te(s,t){s.isStatic=!!t?.isStatic,s.isTrigger=!!t?.isTrigger,s.padding=t?.padding||0,t?.center&&s.center(),s.setAngle(t?.angle||0)}c.extendBody=Te;function Ee(s){return s.bbox.minX<s.minX||s.bbox.minY<s.minY||s.bbox.maxX>s.maxX||s.bbox.maxY>s.maxY}c.bodyMoved=Ee;function Me(s,t){return!(t.minX>s.maxX||t.minY>s.maxY||t.maxX<s.minX||t.maxY<s.minY)}c.intersectAABB=Me;function Se(s,t){let e=s.minX>=t.minX&&s.maxX<=t.maxX,i=s.minY>=t.minY&&s.maxY<=t.maxY;return e&&i}c.checkAInB=Se;function Ie(s){return s.map(({x:t,y:e})=>({x:t,y:e}))}c.clonePointsArray=Ie;function Dt(s,t,e,i,r,n=2,o=4){let a=i-t,l=r-e,u=Math.atan2(l,a),h=Math.cos(u),p=Math.sin(u),v=t,ot=e,at=Math.hypot(a,l);for(;at>0;){let It=Math.min(at,n);s.moveTo(v,ot),s.lineTo(v+h*It,ot+p*It),v+=h*(n+o),ot+=p*(n+o),at-=n+o}}c.dashLineTo=Dt;function Ve(s,t){let e={x:s.end.x-s.start.x,y:s.end.y-s.start.y},i={x:s.start.x-t.pos.x,y:s.start.y-t.pos.y},r=(e.x*i.x+e.y*i.y)*-2,n=(e.x*e.x+e.y*e.y)*2,o=Math.sqrt(r*r-(i.x*i.x+i.y*i.y-t.r*t.r)*n*2);if(isNaN(o))return[];let a=(r-o)/n,l=(r+o)/n,u=[];return a<=1&&a>=0&&u.push({x:s.start.x+e.x*a,y:s.start.y+e.y*a}),l<=1&&l>=0&&u.push({x:s.start.x+e.x*l,y:s.start.y+e.y*l}),u}c.intersectLineCircle=Ve;function Gt(s,t){let e=s.end.x-s.start.x,i=s.end.y-s.start.y,r=e*(t.end.y-t.start.y)-(t.end.x-t.start.x)*i;if(r===0)return null;let n=((t.end.y-t.start.y)*(t.end.x-s.start.x)+(t.start.x-t.end.x)*(t.end.y-s.start.y))/r,o=((s.start.y-s.end.y)*(t.end.x-s.start.x)+e*(t.end.y-s.start.y))/r;return!(n>=0&&n<=1)||!(o>=0&&o<=1)?null:{x:s.start.x+n*e,y:s.start.y+n*i}}c.intersectLineLine=Gt;function qe(s,t){return t.calcPoints.map((e,i)=>{let r=i?t.calcPoints[i-1]:t.calcPoints[t.calcPoints.length-1],n={start:{x:r.x+t.pos.x,y:r.y+t.pos.y},end:{x:e.x+t.pos.x,y:e.y+t.pos.y}};return Gt(s,n)}).filter(e=>!!e)}c.intersectLinePolygon=qe;function Le({x:s,y:t}){return[s,t]}c.mapVectorToArray=Le;function Oe([s,t]){return{x:s,y:t}}c.mapArrayToVector=Oe;function Ye(s){return s.isConvex||s.type!==J.Types.Polygon?[s]:s.convexPolygons}c.ensureConvex=Ye;function ke(s,t){let e=new g.Vector(t.x-s.x,t.y-s.y),i=new g.Vector(s.x-t.x,s.y-t.y),r=i.dot(e.normalize())*2;return new g.Vector(e.x*r-i.x,e.y*r-i.y).normalize()}c.getBounceDirection=ke;function je(s,t){return s.type===J.Types.Circle?t.type===J.Types.Circle?g.testCircleCircle:g.testCirclePolygon:t.type===J.Types.Circle?g.testPolygonCircle:g.testPolygonPolygon}c.getSATFunction=je;function Xe(s,{pos:t,calcPoints:e},i=!1){[...e,e[0]].forEach((n,o)=>{let a=t.x+n.x,l=t.y+n.y,u=e[o-1]||e[e.length-1];if(!o)e.length===1?s.arc(a,l,1,0,Math.PI*2):s.moveTo(a,l);else if(e.length>1)if(i){let h=t.x+u.x,p=t.y+u.y;Dt(s,h,p,a,l)}else s.lineTo(a,l)})}c.drawPolygon=Xe;function Re(s){return Object.entries(s).reduce((t,[e,i])=>e!=="system"?Object.assign(Object.assign({},t),{[e]:i}):t,{})}c.toJSON=Re;var He=0;function Ne(){return(++He).toString(36)}c.generateId=Ne});var vt=m(K=>{"use strict";Object.defineProperty(K,"__esModule",{value:!0});K.Circle=void 0;var We=V(),De=w(),N=A(),gt=class extends We.Circle{constructor(t,e,i){super((0,N.ensureVectorPoint)(t),e),this.offsetCopy={x:0,y:0},this.padding=0,this.angle=0,this.isConvex=!0,this.isCentered=!0,this.type=De.Types.Circle,(0,N.extendBody)(this,i),this.radiusBackup=e,this.uid=(0,N.generateId)()}get x(){return this.pos.x}set x(t){var e;this.pos.x=t,(e=this.system)===null||e===void 0||e.insert(this)}get y(){return this.pos.y}set y(t){var e;this.pos.y=t,(e=this.system)===null||e===void 0||e.insert(this)}get scale(){return this.r/this.radiusBackup}set scale(t){this.setScale(t)}get scaleX(){return this.scale}get scaleY(){return this.scale}setPosition(t,e){var i;this.pos.x=t,this.pos.y=e,(i=this.system)===null||i===void 0||i.insert(this)}setScale(t,e){this.r=this.radiusBackup*t}setAngle(t){this.angle=t;let{x:e,y:i}=this.getOffsetWithAngle();return this.offset.x=e,this.offset.y=i,this}setOffset(t){this.offsetCopy.x=t.x,this.offsetCopy.y=t.y;let{x:e,y:i}=this.getOffsetWithAngle();return this.offset.x=e,this.offset.y=i,this}getAABBAsBBox(){let t=this.pos.x+this.offset.x,e=this.pos.y+this.offset.y;return{minX:t-this.r,maxX:t+this.r,minY:e-this.r,maxY:e+this.r}}draw(t){let e=this.pos.x+this.offset.x,i=this.pos.y+this.offset.y;if(this.isTrigger){let r=Math.max(8,this.r);for(let n=0;n<r;n++){let o=n/r*2*Math.PI,a=(n-1)/r*2*Math.PI,l=e+Math.cos(a)*this.r,u=i+Math.sin(a)*this.r,h=e+Math.cos(o)*this.r,p=i+Math.sin(o)*this.r;(0,N.dashLineTo)(t,l,u,h,p)}}else t.moveTo(e+this.r,i),t.arc(e,i,this.r,0,Math.PI*2)}center(){}toJSON(){return(0,N.toJSON)(this)}getOffsetWithAngle(){if(!this.angle)return this.offsetCopy;let t=Math.sin(this.angle),e=Math.cos(this.angle),i=this.offsetCopy.x*e-this.offsetCopy.y*t,r=this.offsetCopy.x*t+this.offsetCopy.y*e;return{x:i,y:r}}};K.Circle=gt});var Kt=m((Fs,Jt)=>{Jt.exports=globalThis.decomp});var q=m(F=>{"use strict";Object.defineProperty(F,"__esModule",{value:!0});F.Polygon=void 0;var Ge=Kt(),Ft=V(),zt=w(),P=A(),Pt=class extends Ft.Polygon{constructor(t,e,i){if(super((0,P.ensureVectorPoint)(t),(0,P.ensurePolygonPoints)(e)),this.padding=0,this.type=zt.Types.Polygon,this.scaleVector={x:1,y:1},!e?.length)throw new Error("No points in polygon");(0,P.extendBody)(this,i),this.uid=(0,P.generateId)()}get x(){return this.pos.x}set x(t){var e;this.pos.x=t,this.updateConvexPolygonPositions(),(e=this.system)===null||e===void 0||e.insert(this)}get y(){return this.pos.y}set y(t){var e;this.pos.y=t,this.updateConvexPolygonPositions(),(e=this.system)===null||e===void 0||e.insert(this)}get scaleX(){return this.scaleVector.x}get scaleY(){return this.scaleVector.y}get scale(){return this.scaleVector.x}set scale(t){this.setScale(t)}setPosition(t,e){var i;this.pos.x=t,this.pos.y=e,this.updateConvexPolygonPositions(),(i=this.system)===null||i===void 0||i.insert(this)}setScale(t,e=t){this.scaleVector.x=t,this.scaleVector.y=e,this.points.forEach((i,r)=>{i.x=this.pointsBackup[r].x*t,i.y=this.pointsBackup[r].y*e}),super.setPoints(this.points)}getAABBAsBBox(){let{pos:t,w:e,h:i}=this.getAABBAsBox();return{minX:t.x,minY:t.y,maxX:t.x+e,maxY:t.y+i}}draw(t){(0,P.drawPolygon)(t,this,this.isTrigger)}getCentroidWithoutRotation(){let t=this.angle;this.setAngle(0);let e=this.getCentroid();return this.setAngle(t),e}setPoints(t){return super.setPoints(t),this.updateIsConvex(),this.pointsBackup=(0,P.clonePointsArray)(t),this}translate(t,e){return super.translate(t,e),this.pointsBackup=(0,P.clonePointsArray)(this.points),this}rotate(t){return super.rotate(t),this.pointsBackup=(0,P.clonePointsArray)(this.points),this}center(){if(this.isCentered)return;let{x:t,y:e}=this.getCentroidWithoutRotation();this.translate(-t,-e),this.pos.x+=t,this.pos.y+=e,this.isCentered=!0}toJSON(){return(0,P.toJSON)(this)}updateConvexPolygonPositions(){var t;(t=this.convexPolygons)===null||t===void 0||t.forEach(e=>{e.pos.x=this.pos.x,e.pos.y=this.pos.y})}getConvex(){return this.type&&this.type!==zt.Types.Polygon||this.points.length<=3?[]:(0,Ge.quickDecomp)(this.calcPoints.map(P.mapVectorToArray))}updateConvexPolygons(t=this.getConvex()){this.isConvex||(this.convexPolygons||(this.convexPolygons=[]),t.forEach((e,i)=>{this.convexPolygons[i]||(this.convexPolygons[i]=new Ft.Polygon),this.convexPolygons[i].pos.x=this.pos.x,this.convexPolygons[i].pos.y=this.pos.y,this.convexPolygons[i].setPoints((0,P.ensurePolygonPoints)(e.map(P.mapArrayToVector)))}),this.convexPolygons.length=t.length)}updateIsConvex(){let t=this.getConvex();this.isConvex=t.length<=1,this.updateConvexPolygons(t)}};F.Polygon=Pt});var wt=m($=>{"use strict";Object.defineProperty($,"__esModule",{value:!0});$.Ellipse=void 0;var Je=w(),z=A(),Ke=q(),bt=class extends Ke.Polygon{constructor(t,e,i=e,r=(e+i)/Math.PI,n){super(t,(0,z.createEllipse)(e,i,r),n),this.type=Je.Types.Ellipse,this.isCentered=!0,this.isConvex=!0,this._radiusX=e,this._radiusY=i,this._step=r}get step(){return this._step}set step(t){this._step=t,this.setPoints((0,z.createEllipse)(this._radiusX,this._radiusY,this._step))}get radiusX(){return this._radiusX}set radiusX(t){this._radiusX=t,this.setPoints((0,z.createEllipse)(this._radiusX,this._radiusY,this._step))}get radiusY(){return this._radiusY}set radiusY(t){this._radiusY=t,this.setPoints((0,z.createEllipse)(this._radiusX,this._radiusY,this._step))}center(){}updateIsConvex(){}};$.Ellipse=bt});var U=m(Q=>{"use strict";Object.defineProperty(Q,"__esModule",{value:!0});Q.Box=void 0;var Fe=w(),_t=A(),ze=q(),At=class extends ze.Polygon{constructor(t,e,i,r){super(t,(0,_t.createBox)(e,i),r),this.type=Fe.Types.Box,this.isConvex=!0,this._width=e,this._height=i}get width(){return this._width}set width(t){this._width=t,this.setPoints((0,_t.createBox)(this._width,this._height))}get height(){return this._height}set height(t){this._height=t,this.setPoints((0,_t.createBox)(this._width,this._height))}updateIsConvex(){}};Q.Box=At});var Ct=m(Z=>{"use strict";Object.defineProperty(Z,"__esModule",{value:!0});Z.Point=void 0;var $e=w(),Qe=A(),Ue=U(),Bt=class extends Ue.Box{constructor(t,e){super((0,Qe.ensureVectorPoint)(t),.001,.001,e),this.type=$e.Types.Point}};Z.Point=Bt});var et=m(tt=>{"use strict";Object.defineProperty(tt,"__esModule",{value:!0});tt.Line=void 0;var Ze=V(),ts=w(),es=q(),Tt=class extends es.Polygon{constructor(t,e,i){if(super(t,[{x:0,y:0},{x:e.x-t.x,y:e.y-t.y}],i),this.type=ts.Types.Line,this.isConvex=!0,this.calcPoints.length===1||!e)throw console.error({start:t,end:e}),new Error("No end point for line provided")}get start(){return{x:this.x+this.calcPoints[0].x,y:this.y+this.calcPoints[0].y}}set start({x:t,y:e}){this.x=t,this.y=e}get end(){return{x:this.x+this.calcPoints[1].x,y:this.y+this.calcPoints[1].y}}set end({x:t,y:e}){this.points[1].x=t-this.start.x,this.points[1].y=e-this.start.y,this.setPoints(this.points)}getCentroid(){return new Ze.Vector((this.end.x-this.start.x)/2,(this.end.y-this.start.y)/2)}updateIsConvex(){}};tt.Line=Tt});var Qt=m(st=>{"use strict";Object.defineProperty(st,"__esModule",{value:!0});st.BaseSystem=void 0;var ss=U(),is=vt(),rs=wt(),ns=et(),os=Ct(),as=q(),cs=w(),$t=A(),Et=class extends cs.RBush{draw(t){this.all().forEach(e=>{e.draw(t)})}drawBVH(t){let e=({minX:i,maxX:r,minY:n,maxY:o,children:a})=>{(0,$t.drawPolygon)(t,{pos:{x:i,y:n},calcPoints:(0,$t.createBox)(r-i,o-n)}),a?.forEach(e)};this.data.children.forEach(e)}createPoint(t,e){let i=new os.Point(t,e);return this.insert(i),i}createLine(t,e,i){let r=new ns.Line(t,e,i);return this.insert(r),r}createCircle(t,e,i){let r=new is.Circle(t,e,i);return this.insert(r),r}createBox(t,e,i,r){let n=new ss.Box(t,e,i,r);return this.insert(n),n}createEllipse(t,e,i=e,r,n){let o=new rs.Ellipse(t,e,i,r,n);return this.insert(o),o}createPolygon(t,e,i){let r=new as.Polygon(t,e,i);return this.insert(r),r}};st.BaseSystem=Et});var Ut=m(rt=>{"use strict";Object.defineProperty(rt,"__esModule",{value:!0});rt.System=void 0;var ls=Qt(),us=et(),it=w(),b=A(),Mt=class extends ls.BaseSystem{constructor(){super(...arguments),this.response=new it.Response,this.bodies={},this.state={collides:!1,aInB:!1,bInA:!1,overlapV:new it.SATVector}}remove(t,e){return t.system&&delete t.system.bodies[t.uid],t.system=void 0,super.remove(t,e)}insert(t){return t.bbox=t.getAABBAsBBox(),t.system&&!(0,b.bodyMoved)(t)?this:(t.system&&t.system.remove(t),t.minX=t.bbox.minX-t.padding,t.minY=t.bbox.minY-t.padding,t.maxX=t.bbox.maxX+t.padding,t.maxY=t.bbox.maxY+t.padding,t.system=this,this.bodies[t.uid]=t,super.insert(t))}updateBody(t){this.insert(t)}update(){this.all().forEach(t=>{t.isStatic||this.insert(t)})}separate(){this.checkAll(({a:t,overlapV:e})=>{if(t.isTrigger)return!1;t.setPosition(t.x-e.x,t.y-e.y)})}checkOne(t,e){return t.isStatic?!1:this.search(t).some(i=>{if(i!==t&&this.checkCollision(t,i))return e(this.response)})}checkAll(t){return this.all().some(e=>this.checkOne(e,t))}getPotentials(t){return this.search(t).filter(e=>e!==t)}checkCollision(t,e){if(t.bbox&&e.bbox&&!(0,b.intersectAABB)(t.bbox,e.bbox))return!1;let i=(0,b.getSATFunction)(t,e);if(this.state.collides=!1,this.response.clear(),t.isConvex&&e.isConvex)this.state.collides=i(t,e,this.response);else if(t.isConvex&&!e.isConvex)(0,b.ensureConvex)(e).forEach(r=>{this.test(i,t,r)});else if(!t.isConvex&&e.isConvex)(0,b.ensureConvex)(t).forEach(r=>{this.test(i,r,e)});else{let r=(0,b.ensureConvex)(t),n=(0,b.ensureConvex)(e);r.forEach(o=>{n.forEach(a=>{this.test(i,o,a)})})}return(!t.isConvex||!e.isConvex)&&(this.response.a=t,this.response.b=e,this.state.collides&&(this.response.overlapV=this.state.overlapV,this.response.overlapN=this.response.overlapV.clone().normalize(),this.response.overlap=this.response.overlapV.len()),this.response.aInB=t.isConvex?this.state.aInB:(0,b.checkAInB)(t,e),this.response.bInA=e.isConvex?this.state.bInA:(0,b.checkAInB)(e,t)),this.state.collides}raycast(t,e,i=()=>!0){let r=1/0,n=null;return this.ray?(this.ray.start=t,this.ray.end=e):this.ray=new us.Line(t,e,{isTrigger:!0}),this.insert(this.ray),this.checkOne(this.ray,({b:o})=>{if(!i(o))return!1;(o.type===it.Types.Circle?(0,b.intersectLineCircle)(this.ray,o):(0,b.intersectLinePolygon)(this.ray,o)).forEach(l=>{let u=(0,b.distance)(t,l);u<r&&(r=u,n={point:l,collider:o})})}),this.remove(this.ray),n}clear(){return super.clear(),this.bodies={},this}traverse(t,{children:e}=this.data){return e?.find((i,r)=>{if(!i)return!1;if(i.type&&t(i,e,r))return!0;i.children&&this.traverse(t,i)})}fromJSON(t){return this.traverse((e,i,r)=>{this.bodies[e.uid]&&(this.bodies[e.uid]=i[r]=Object.assign(this.bodies[e.uid],e))},t),super.fromJSON(t),this}test(t,e,i){let r=t(e,i,this.response);r&&(this.state.collides||(this.state.aInB=!1,this.state.bInA=!1,this.state.overlapV=new it.SATVector),this.state.overlapV.add(this.response.overlapV)),this.state.aInB=this.state.aInB||this.response.aInB,this.state.bInA=this.state.bInA||this.response.bInA,this.state.collides=r||this.state.collides,this.response.clear()}};rt.System=Mt});var Zt=m(x=>{"use strict";var hs=x&&x.__createBinding||(Object.create?function(s,t,e,i){i===void 0&&(i=e);var r=Object.getOwnPropertyDescriptor(t,e);(!r||("get"in r?!t.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return t[e]}}),Object.defineProperty(s,i,r)}:function(s,t,e,i){i===void 0&&(i=e),s[i]=t[e]}),B=x&&x.__exportStar||function(s,t){for(var e in s)e!=="default"&&!Object.prototype.hasOwnProperty.call(t,e)&&hs(t,s,e)};Object.defineProperty(x,"__esModule",{value:!0});B(w(),x);B(vt(),x);B(wt(),x);B(q(),x);B(U(),x);B(Ct(),x);B(et(),x);B(Ut(),x);B(A(),x)});var E=C(T());var M=class{constructor(t,e){this.x=t;this.y=e}};var f=class{constructor(t,e){this.g=t;this.name=e;this.alive=!0,this.id=++t.lastEntityId,this.Player=!1,this.Projectile=!1,this.Solid=!1,t.add(this)}get[Symbol.toStringTag](){return this.name}kill(){return this.alive=!1,this}eachChild(t){var e;for(let i of this.g.entities.get())((e=i.Attachment)==null?void 0:e.parent)===this&&t(i,i.Attachment)}setAppearance(t){return this.g.dirty=!0,this.Appearance=t,this}setAttachment(t){return this.Attachment=t,this}setHoming(t){return this.Homing=t,this}setLifetime(t){return this.Lifetime=t,this}setMotion(t){return this.Motion=t,this}setPosition(t){return this.g.dirty=!0,this.Position=t,this}setTrail(t){return this.Trail=t,this}setTurret(t){return this.Turret=t,this}setPlayer(t){return this.Player=t,this}setProjectile(t){return this.Projectile=t,this}setSolid(t){return this.Solid=t,this}move(t,e){return this.g.dirty=!0,this.Position=new M(t,e),this.eachChild((i,r)=>i.move(t+r.x,e+r.y)),this.Position}};function Yt(s,t){var r,n,o,a;let e=(n=(r=s.Appearance)==null?void 0:r.layer)!=null?n:0,i=(a=(o=t.Appearance)==null?void 0:o.layer)!=null?a:0;return e!==i?e-i:s.id-t.id}var lt={};O(lt,{battleship:()=>he,battleshipHull:()=>pe});var y=class{constructor(t,e,i,r){this.glyph=t;this.layer=e;this.fg=i;this.bg=r}};var _=class{constructor(t,e,i){this.parent=t;this.x=e;this.y=i}};var ct=C(T());function he(s){let t=new f(s,"Battleship");return s.spawn("battleshipHull").setAttachment(new _(t,1,0)),s.spawn("battleshipHull").setAttachment(new _(t,2,0)),s.spawn("machineGun").setAttachment(new _(t,0,1)),s.spawn("battleshipHull").setAttachment(new _(t,1,1)),s.spawn("missileLauncher").setAttachment(new _(t,2,1)),t}function pe(s){return new f(s,"BattleshipHull").setAppearance(new y("/",1,ct.Colors.WHITE,ct.Colors.BROWN)).setSolid(!0)}var ht={};O(ht,{bullet:()=>fe,missile:()=>me});var ut=C(T());var Y=class{constructor(t,e){this.strength=t;this.duration=e}};var k=class{constructor(t,e){this.effectPrefab=t;this.duration=e}};function fe(s){return new f(s,"Bullet").setProjectile(!0).setAppearance(new y(".",2,ut.Colors.YELLOW))}function me(s){return new f(s,"Missile").setProjectile(!0).setHoming(new Y(.15,10)).setTrail(new k("puff",10)).setAppearance(new y("*",2,ut.Colors.DARK_RED))}var pt={};O(pt,{puff:()=>ye});var kt=C(T());var j=class{constructor(t){this.duration=t}};function ye(s){return new f(s,"Puff").setAppearance(new y("#",0,kt.Colors.LIGHT_GRAY)).setLifetime(new j(2))}var ft={};O(ft,{machineGun:()=>de,missileLauncher:()=>xe});var X=C(T());var I=class{constructor(t,e,i,r,n,o="idle",a=0,l=0){this.bulletPrefab=t;this.bulletVelocity=e;this.salvoCount=i;this.timeBetweenShots=r;this.timeBetweenSalvos=n;this.mode=o;this.timer=a;this.salvo=l}};function jt(s){switch(s.mode){case"idle":s.mode="fire",s.salvo=s.salvoCount-1,s.timer=s.timeBetweenShots;break;case"fire":s.timer--,s.salvo>0?s.timer<=0&&(s.mode="mid-salvo"):s.mode="reloading";break;case"mid-salvo":s.mode="fire",s.salvo--,s.salvo>0?s.timer=s.timeBetweenShots:s.timer=s.timeBetweenSalvos;break;case"reloading":s.timer--,s.timer<=0&&(s.mode="idle");break}return s}function de(s){return new f(s,"MachineGun").setAppearance(new y("o",1,X.Colors.WHITE,X.Colors.BROWN)).setTurret(new I("bullet",2,5,0,12)).setSolid(!0)}function xe(s){return new f(s,"MissileLauncher").setAppearance(new y("o",1,X.Colors.YELLOW,X.Colors.BROWN)).setTurret(new I("missile",1,1,8,8)).setSolid(!0)}var yt={};O(yt,{player:()=>ge});var mt=C(T());function ge(s){return new f(s,"Player").setPlayer(!0).setAppearance(new y(">",3,mt.Colors.WHITE,mt.Colors.DARK_RED))}var ve=S(S(S(S(S({},lt),ht),pt),ft),yt);function dt(s,t){return ve[t](s)}var R=class{constructor(t,e){this.angle=t;this.vel=e}get x(){return Math.cos(this.angle)*this.vel}get y(){return Math.sin(this.angle)*this.vel}};var H=class{constructor(t,e=[]){this.compareFn=t;this.items=e;this.dirty=!0}clear(){this.items=[],this.dirty=!1}add(t){this.items.push(t),this.dirty=!0}delete(t){this.items=this.items.filter(e=>e!==t)}sort(){this.items.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.items}};var ie=C(Zt());var te=Math.PI*2;function St(s,t){let e=(s-t)%te,i=(t-s)%te;return e<i?-e:i}function nt(s){return Math.floor(s)}var ee=60,se=40;function L(s,t){return s.tag=t,s}var W=class{constructor(t){this.term=t;t.update=this.update.bind(this),this.dirty=!0,this.fovRecompute=!0,this.map=new E.Console(ee,se,()=>!0),this.lastEntityId=0,this.entities=new H(Yt)}get player(){let t=this.entities.get().find(e=>e.Player);if(!t)throw new Error("Could not find a player!");return t}spawn(t){return dt(this,t)}add(t){this.dirty=!0,this.entities.add(t)}addMany(t){this.dirty=!0;for(let e of t)this.add(e)}gotoDemoRoom(){this.entities.clear(),this.map.clear(),this.room(1,1,40,30),this.spawn("player").setPosition(new M(5,25)),this.spawn("battleship").move(8,5)}room(t,e,i,r){let{map:n}=this;for(let o=0;o<r;o++)for(let a=0;a<i;a++){let l=a===0||o===0||a===i-1||o===r-1,u=t+a,h=e+o;n.setBlocked(u,h,l),n.setBlockedSight(u,h,l)}}draw(){let{map:t,player:e,term:i,entities:r}=this;this.fovRecompute&&(t.computeFov(e.Position.x,e.Position.y,20),this.fovRecompute=!1);for(let o=0;o<se;o++)for(let a=0;a<ee;a++){let l=t.grid[o][a],u=t.isVisible(a,o),h=l.blockedSight,p=E.Colors.BLACK;u?(p=h?E.Colors.WHITE:E.Colors.DARK_GRAY,l.explored=!0):l.explored&&(p=h?E.Colors.LIGHT_GRAY:E.Colors.BLACK),i.drawChar(a,o,0,0,p)}let n=(o,a,l,u,h)=>{t.isVisible(o,a)&&i.drawChar(o,a,l,u,h)};for(let o of r.get()){let{Appearance:a,Position:l}=o;a&&l&&n(nt(l.x),nt(l.y),a.glyph,a.fg,a.bg)}this.dirty=!1}lifetimes(){for(let t of this.entities.get()){let{Lifetime:e}=t;e&&--e.duration<=0&&(t.kill(),this.entities.delete(t))}}trails(){for(let t of this.entities.get()){let{Position:e,Trail:i}=t;e&&i&&(this.spawn(i.effectPrefab).setPosition(e),--i.duration<=0&&t.setTrail())}}homing(){let t=this.player.Position;for(let e of this.entities.get()){let{Homing:i,Motion:r,Position:n}=e;if(i&&r&&n){let o=Math.atan2(t.y-n.y,t.x-n.x),a=St(r.angle,o);Math.abs(a)<=i.strength?r.angle=o:a<0?r.angle-=i.strength:r.angle+=i.strength,--i.duration<=0&&e.setHoming()}}}turrets(){let{entities:t}=this,e=this.player.Position;for(let i of t.get()){let{Position:r,Turret:n}=i;r&&n&&(jt(n),n.mode==="fire"&&this.spawn(n.bulletPrefab).setPosition({x:r.x+.5,y:r.y+.5}).setMotion(new R(Math.atan2(e.y-r.y,e.x-r.x),n.bulletVelocity)))}}motion(){let{entities:t,map:e,player:i}=this,r=new ie.System;for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++)e.isBlocked(o,n)&&L(r.createBox({x:o,y:n},1,1,{isStatic:!0}),{type:"wall"});for(let n of t.get()){let{Solid:o,Motion:a,Position:l,Projectile:u}=n;if(l){let{x:h,y:p}=l;if(o)L(r.createBox({x:h,y:p},1,1),{type:"ship",e:n});else if(u&&a){let v={x:h+a.x,y:p+a.y};L(r.createBox({x:h-.25,y:p-.25},.5,.5),{type:"bullet",e:n}),L(r.createBox({x:v.x-.5,y:v.y-.25},.5,.5),{type:"bullet",e:n}),L(r.createLine({x:h,y:p},v),{type:"bullet",e:n}),n.move(v.x,v.y)}}}L(r.createBox(i.Position,1,1),{type:"player"}),r.update(),r.checkAll(n=>{var l,u,h,p;let o=n.a.tag,a=n.b.tag;if(o.type==="wall"){(l=a.e)!=null&&l.Projectile&&t.delete(a.e);return}if(a.type==="wall"){(u=o.e)!=null&&u.Projectile&&t.delete(o.e);return}o.type==="player"&&a.type==="bullet"&&((h=a.e)!=null&&h.alive)?(a.e.kill(),t.delete(a.e)):a.type==="player"&&o.type==="bullet"&&((p=o.e)!=null&&p.alive)&&(o.e.kill(),t.delete(o.e))})}tick(){this.lifetimes(),this.trails(),this.homing(),this.turrets(),this.motion()}handleKeys(){let{map:t,player:e,term:i}=this,r=i.getMovementKey();if(r){let n=e.Position.x+r.x,o=e.Position.y+r.y;t.isBlocked(n,o)||(e.move(n,o),this.fovRecompute=!0,this.tick())}}update(){this.handleKeys(),this.dirty&&this.draw()}};var re=C(T());function ps(s){let i=document.createElement("div");s.appendChild(i);let r=()=>{let h=Math.floor(window.innerWidth/480),p=Math.floor(window.innerHeight/320),v=Math.min(h,p);i.style.width=`${480*v}px`,i.style.height=`${320*v}px`};window.addEventListener("resize",r),r();let n=document.createElement("canvas");i.appendChild(n);let o=new re.Terminal(n,60,40),a=new W(o);a.gotoDemoRoom(),window.g=a}window.addEventListener("load",()=>ps(document.body));})();
//# sourceMappingURL=bundle.js.map
