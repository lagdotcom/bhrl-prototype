"use strict";(()=>{var Oa=Object.create;var Od=Object.defineProperty,za=Object.defineProperties,va=Object.getOwnPropertyDescriptor,Wa=Object.getOwnPropertyDescriptors,wa=Object.getOwnPropertyNames,La=Object.getOwnPropertySymbols,_a=Object.getPrototypeOf,$a=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable;var Pa=(a,d,e)=>d in a?Od(a,d,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[d]=e,N=(a,d)=>{for(var e in d||={})$a.call(d,e)&&Pa(a,e,d[e]);if(La)for(var e of La(d))de.call(d,e)&&Pa(a,e,d[e]);return a},Da=(a,d)=>za(a,Wa(d));var ae=(a,d)=>()=>(d||a((d={exports:{}}).exports,d),d.exports),$d=(a,d)=>{for(var e in d)Od(a,e,{get:d[e],enumerable:!0})},ee=(a,d,e,L)=>{if(d&&typeof d=="object"||typeof d=="function")for(let P of wa(d))!$a.call(a,P)&&P!==e&&Od(a,P,{get:()=>d[P],enumerable:!(L=va(d,P))||L.enumerable});return a};var I=(a,d,e)=>(e=a!=null?Oa(_a(a)):{},ee(d||!a||!a.__esModule?Od(e,"default",{value:a,enumerable:!0}):e,a));var R=ae((HP,Xa)=>{Xa.exports=globalThis.wglt});function nd(a,d=new Map){if(!a||typeof a!="object")return a;if(d.has(a))return d.get(a);let e;if(a.nodeType&&"cloneNode"in a)e=a.cloneNode(!0),d.set(a,e);else if(a instanceof Date)e=new Date(a.getTime()),d.set(a,e);else if(a instanceof RegExp)e=new RegExp(a),d.set(a,e);else if(Array.isArray(a)){e=new Array(a.length),d.set(a,e);for(let L=0;L<a.length;L++)e[L]=nd(a[L],d)}else if(a instanceof Map){e=new Map,d.set(a,e);for(let[L,P]of a.entries())e.set(L,nd(P,d))}else if(a instanceof Set){e=new Set,d.set(a,e);for(let L of a)e.add(nd(L,d))}else if(a instanceof Object){e={},d.set(a,e);for(let[L,P]of Object.entries(a))e[L]=nd(P,d)}else throw Error(`Unable to clone ${a}`);return e}function ia(a){return nd(a,new Map)}var u=ia,Ha=Object.keys,Ba=a=>{let d={};for(let[e,L]of a)d[e]=L;return d};var Ad=class{constructor(d,e){this.g=d;this.name=e;this.alive=!0,this.id=++d.lastEntityId,this.solid=!1,this.tags=new Set}applyPrefab(d,e){if(this.prefab=d,e.components&&Object.assign(this,u(e.components)),e.children)for(let{name:L,x:P,y:$,overlay:D,tags:i}of e.children){let H=this.g.spawn(L).setAttachment({parent:this,x:P,y:$});if(D)for(let b of Ha(D))Object.assign(H[b],u(D[b]));if(i)for(let b of i)H.tags.add(b)}return this}get[Symbol.toStringTag](){return this.name}kill(d){return this.alive=!1,this.eachChild(e=>this.g.kill(e,d)),this}eachChild(d){var e;for(let L of this.g.entities.get())((e=L.attachment)==null?void 0:e.parent)===this&&d(L,L.attachment)}setAI(d){return this.ai=d,this}setAppearance(d){return this.g.refresh(),this.appearance=d,this}setAttachment(d){return this.attachment=d,this}setDelayedShot(d){return this.delayedShot=d,this}setDoubleShot(d){return this.doubleShot=d,this}setExplodes(d){return this.explodes=d,this}setField(d){return this.field=d,this}setHoming(d){return this.homing=d,this}setIgnoreSolid(d){return this.ignoreSolid=d,this}setItem(d){return this.item=d,this}setLastMovement(d){return this.lastMovement=d,this}setLifetime(d){return this.lifetime=d,this}setMotion(d){return this.motion=d,this}setOrigin(d){return this.origin=d,this}setPilot(d){return this.pilot=d,this}setPosition(d){return this.g.refresh(),this.position=d,this}setShip(d){return this.ship=d,this}setTrail(d){return this.trail=d,this}setTurret(d){return this.turret=d,this}setPlayer(d){return this.player=d,this}setProjectile(d){return this.projectile=d,this}setSolid(d){return this.solid=d,this}move(d,e){return this.g.refresh(),this.position={x:d,y:e},this.eachChild((L,P)=>L.move(d+P.x,e+P.y)),this}};function ba(a,d){var P,$,D,i;let e=($=(P=a.appearance)==null?void 0:P.layer)!=null?$:0,L=(i=(D=d.appearance)==null?void 0:D.layer)!=null?i:0;return e!==L?e-L:a.id-d.id}var Ud=class{constructor(d,e=[]){this.compareFn=d;this.entities=e;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}clearExceptFor(d){for(let e of this.entities)d.includes(e.id)||(e.alive=!1);this.clearDead()}add(d){this.entities.push(d),this.dirty=!0}clearDead(){this.entities=this.entities.filter(d=>d.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var ha=["damage","draw","kill","move","notice","playerBomb","playerFire","playerMove","spawn","tick","waveBegin","waveNext"];var Yd=class{constructor(d){this.keyFn=d;this.items=new Map}has(d){return this.items.has(this.keyFn(d))}get(d){return this.items.get(this.keyFn(d))}getOrDefault(d,e){let L=this.items.get(this.keyFn(d));return typeof L!="undefined"?L:e}getOrDie(d){let e=this.keyFn(d),L=this.items.get(e);if(typeof L=="undefined")throw new Error(`Invalid key: ${e}`);return L}set(d,e){this.items.set(this.keyFn(d),e)}};function O(a){return typeof a=="undefined"?NaN:Math.floor(a)}var p=(a,d)=>({x:a,y:d});function s(a){return p(O(a.x),O(a.y))}function w(a,d){if(typeof a=="undefined"||typeof d=="undefined")return!1;let e=s(a),L=s(d);return e.x===L.x&&e.y===L.y}function K(a,d){return p(a.x+d.x,a.y+d.y)}var b0=[p(-1,-1),p(-1,0),p(-1,1),p(0,1),p(1,1),p(1,0),p(1,-1),p(0,-1)];function h0(a){return b0.map(d=>K(a,d))}function A0(a,d,e=1/0){let L=[],P=new Yd(D=>`${D.x},${D.y}`);for(let D of a)L.push(D),P.set(D,0);let $=L.shift();for(;$;){let D=P.getOrDie($)+1;if(D<=e)for(let i of h0($))!P.has(i)&&d(i)&&(P.set(i,D),L.push(i));$=L.shift()}return P}function Le(a,d){if(!d||!a.length)throw new Error("Could not get midpoint");let e=L=>a.reduce((P,{offset:$})=>P+$[L],0)/a.length;return p(d.x+e("x"),d.y+e("y"))}function Pe(a,d,e,L=[]){let P=[];for(let{offset:$}of d){let D=K(e,$),{oob:i,wall:H,solid:b}=a.getContents(D,L);i?P.push({absolute:D,offset:$,entity:"oob"}):H?P.push({absolute:D,offset:$,entity:"wall"}):b&&P.push({absolute:D,offset:$,entity:b})}return P}function n(a,d){let e=a.getRoot(d);return a.entities.get().filter(L=>a.getRoot(L)===e)}function _(a,d){return n(a,d).map(e=>e.id)}function z(a,d){var i;let e=(i=a.getRoot(d).position)!=null?i:p(0,0),L=n(a,d),P=[],$=0,D=0;for(let H of L){let{attachment:b,solid:B}=H;if(b&&B){let{x:c,y:r}=b;P.push({absolute:K(e,b),offset:{x:c,y:r},entity:H}),$=Math.max(c+1,$),D=Math.max(r+1,D)}}return{layout:P,topLeft:e,width:$,height:D}}function Aa(a,d,e){let L=_(a,d),{layout:P,topLeft:$}=z(a,d);return!e||!$?[]:Pe(a,P,e||$,L)}function l(a,d){let{layout:e,topLeft:L}=z(a,d);if(!L||!e.length){if(d.position)return d.position;throw new Error(`Could not get midpoint of entity#${d.id}`)}return Le(e,L)}function fa(a,d,e,L,P){for(let $=0;$<P;$++)for(let D=0;D<L;D++){let{oob:i,wall:H,solid:b,other:B}=a.getContents({x:d+D,y:e+$});if(i||H||b||B.length)return!1}return!0}function jd(a,d){if(!a.alive)return!1;for(let e of d)if(!a[e])return!1;return!0}function Dd(a){return d=>jd(d,a)}var q=I(R()),zd=[0,q.Colors.DARK_RED,q.Colors.BROWN,q.Colors.LIGHT_RED,q.Colors.ORANGE,q.Colors.YELLOW,q.Colors.WHITE],dd={Typical:{fg:q.Colors.DARK_GRAY},Healthy:{fg:q.Colors.DARK_GREEN},Double:{fg:q.Colors.LIGHT_GRAY},Multi:{fg:q.Colors.DARK_MAGENTA},Drain:{fg:q.Colors.DARK_RED},StarPilot:{fg:q.Colors.YELLOW},Mega:{fg:q.Colors.BLACK,bg:q.Colors.DARK_MAGENTA}};function vd(a,d,e){let{ship:L}=d;if(!L)throw new Error(`Cannot put pilot into entity ${d.name} (no ship)`);if(d.setPilot(e),L.maxHp+=$e(d),e.special){let P=l(a,d);a.spawn(e.special).setAttachment(Da(N({},s(P)),{parent:d})).tags.add("Special")}}function Kd(a,d){return a.pilot?a.pilot[d]:0}function ca(a){return 7-Kd(a,"body")}function $e(a){return Kd(a,"body")*4}function pa(a){return Kd(a,"mind")}function Ta(a){return(Kd(a,"mind")-1)*5}function f0(a,d){return typeof a=="number"?a:Math.floor(a.base+Kd(d,a.stat)*a.multiplier)}function fd(a){return Math.random()*100<a}function ad(a,d=0){let e=[];for(let L=d;L<a;L++)e.push(L);return e}function U(a){if(!a.length)throw new Error("oneOf passed empty array");return a[Math.floor(Math.random()*a.length)]}function Jd(a){for(let d=a.length-1;d>0;d--){let e=Math.floor(Math.random()*(d+1));[a[d],a[e]]=[a[e],a[d]]}return a}function Wd(a,...d){return a.filter(e=>!d.includes(e))}var Ca=($=>($[$.None=0]="None",$[$.Healthy=1]="Healthy",$[$.Double=2]="Double",$[$.Drain=4]="Drain",$[$.HasPilot=8]="HasPilot",$))(Ca||{}),x=Ca;var Fa=["Berserker","Chopter","Duelist","Engineer","Fighter","Negotiator","Psychic","Smuggler"];var p0={Typical:x.None,Healthy:x.Healthy,Double:x.Double,Multi:x.Healthy|x.Double,Drain:x.Drain,StarPilot:x.HasPilot,Mega:x.Healthy|x.Double|x.Drain|x.HasPilot},De={Typical:"Fire",Healthy:"Green",Double:"Fire",Multi:"Magenta",Drain:"Fire",StarPilot:"Yellow",Mega:"Magenta"},X0=["ShipA","ShipB","ShipC","ShipD","ShipE","ShipF","ShipG","ShipH"],c0=["CruiseyWing","Olm","GoutOFlame","Demigod","Gremlin","AtomSmasher"],ie=[{name:"Let Fate Decide",difficulty:1,groups:[{count:7,type:"Escort",prefabs:X0},{count:1,type:"Battleship",prefabs:c0}]},{name:"Court Martial",difficulty:2,groups:[{count:5,type:"Escort",prefabs:["ShipA","ShipE"]},{count:1,type:"Battleship",prefabs:["CruiseyWing"]}]},{name:"Hellhounds",difficulty:3,groups:[{count:2,type:"Escort",prefabs:["ShipB"]},{count:2,type:"Battleship",prefabs:["GoutOFlame"]}]},{name:"Chaos",difficulty:4,groups:[{count:4,type:"Escort",prefabs:["ShipC"]},{count:4,type:"Escort",prefabs:Wd(X0,"ShipC")},{count:1,type:"Battleship",prefabs:["Demigod"]}]},{name:"Fly in Formation",difficulty:4,groups:[{count:7,type:"Escort",prefabs:["ShipF"]},{count:1,type:"Battleship",prefabs:c0}]},{name:"Hark!",difficulty:6,groups:[{count:3,type:"Escort",prefabs:["ShipH"]},{count:3,type:"Escort",prefabs:Wd(X0,"ShipH")},{count:1,type:"Battleship",prefabs:["Demigod"]}]},{name:"Caverns.com",difficulty:7,groups:[{count:1,type:"Escort",prefabs:["ShipA","ShipG"]},{count:3,type:"Battleship",prefabs:["Olm"]}]},{name:"Humanity to the Rescue",difficulty:8,groups:[{count:7,type:"Escort",prefabs:["ShipA","ShipD","ShipE","ShipG"]},{count:1,type:"Battleship",prefabs:["GoutOFlame"]}]},{name:"Wild Hunt",difficulty:9,groups:[{count:15,type:"Escort",prefabs:["ShipB","ShipF"]},{count:1,type:"Battleship",prefabs:["Olm"]}]},{name:"Arm Wrestling",difficulty:10,groups:[{count:9,type:"Escort",prefabs:["ShipG"]},{count:2,type:"Battleship",prefabs:["CruiseyWing"]}]},{name:"Valis",difficulty:11,groups:[{count:4,type:"Escort",prefabs:["ShipC"]},{count:4,type:"Escort",prefabs:["ShipH"]},{count:1,type:"Battleship",prefabs:c0}]}];function ta(a=3){return Jd(ie.slice()).slice(0,a).sort((d,e)=>d.difficulty-e.difficulty)}function ra(a,d){return fd(a)?d?"Mega":U(["Healthy","Double","Multi","Drain"]):d?"StarPilot":"Typical"}function He(a){let d=u(a);for(;d.class.length<d.talent;)d.class.push(U(Fa.filter(e=>!d.class.includes(e))));return d}function Ja(a,d,e,L){let P=p0[e];if(P&x.HasPilot&&!L)throw new Error(`power ${e} needs pilot, none given`);let $=a.spawn(d),{ship:D}=$;if(!D)throw new Error(`Ship prefab ${d} doesn't have a ship component!`);if(D.power=e,P&x.Healthy&&(D.maxHp=D.maxHp*2+3),L){let H=He(L);vd(a,$,H)}xd(D);let i=dd[e];for(let H of n(a,$))H.appearance&&Object.assign(H.appearance,i);return P&x.Double&&$.setDoubleShot({duration:1/0}),$.explodes&&($.explodes.type=De[e]),$}function Ra(a,d){let{width:e,height:L}=z(a,d);for(let P=0;P<a.term.height;P++){let $=Jd(ad(a.term.width-e));for(let D of $)if(fa(a,D,P,e,L))return{x:D,y:P}}throw new Error(`Could not find ${e}x${L} spawn location`)}function xd(a){a.hp=a.maxHp,a.shield=a.maxShield}var Be={Smiley:"",Heart:"",Diamond:"",Club:"",Dot:"\x07",Ring:"	",RingInvert:`
`,Male:"\v",Female:"\f",DoubleNote:"",Star:"",Pilcrow:"",Silcrow:"",ResizeVertical:"",UpArrow:"",DownArrow:"",RightArrow:"",LeftArrow:"\x1B",ResizeHorizontal:"",DownWedge:"",Pentagon:"\x7F",AHat:"\x83",EHat:"\x88",CapitalUUmlaut:"\x9A",Cent:"\x9B",Yen:"\x9D",CurlyF:"\x9F",NotFlip:"\xA9",Not:"\xAA",InvertedExclamation:"\xAD",Fill1:"\xB0",Fill2:"\xB1",Fill3:"\xB2",BoxVerticalSingle:"\xB3",BoxLeftSingleUpDouble:"\xBD",BoxUpSingleHorizontalSingle:"\xC1",BoxDownSingleHorizontalSingle:"\xC2",BoxHorizontalSingle:"\xC4",BoxUpDoubleHorizontalSingle:"\xD0",BoxDownSingleHorizontalDouble:"\xD1",BoxRightSingleUpDouble:"\xD3",BoxVerticalDoubleHorizontalSingle:"\xD7",Filled:"\xDB",Beta:"\xE1",Gamma:"\xE2",Pi:"\xE3",Theta:"\xE9",Omega:"\xEA",SymbolED:"\xED",SetMember:"\xEE",HorizontalDivide:"\xF6",Approximates:"\xF7",Squared:"\xFD",Square:"\xFE"},h=Be;var wd=Math.PI*2;function id(a,d){return Math.atan2(d.y-a.y,d.x-a.x)}function Ia(a,d){let e=(a-d)%wd,L=(d-a)%wd;return e<L?-e:L}function Hd(a){let d=Math.cos(a.angle)*a.vel,e=Math.sin(a.angle)*a.vel;return[d,e]}function _d(a){for(;a<0;)a+=wd;return a%wd}var Qa=I(R()),G=class{constructor(d){this.g=d;this.width=0,this.height=0,this.instructions=[]}add(d){this.instructions.push(d),this.updateBounds()}addLine(d,e=Qa.Colors.WHITE,L){this.add({x:0,y:this.instructions.length,line:d,fg:e,bg:L})}updateBounds(){this.width=this.instructions.reduce((d,e)=>Math.max(e.line.length+e.x,d),0),this.height=1+this.instructions.reduce((d,e)=>Math.max(e.y,d),0)}draw(d,e){for(let{x:L,y:P,line:$,fg:D,bg:i}of this.instructions)this.g.term.drawString(d+L,e+P,$,D,i)}};var Rd=I(R()),Ma=Math.PI/4,be=[h.RightArrow,h.DownArrow+h.RightArrow,h.DownArrow,h.DownArrow+h.LeftArrow,h.LeftArrow,h.UpArrow+h.LeftArrow,h.UpArrow,h.UpArrow+h.RightArrow,h.RightArrow];function he(a){let d=Math.floor(_d(a)/Ma+Ma/2);return be[d]}var ld=class extends G{constructor(e,L){var P,$,D;super(e);this.e=L;L.name&&!L.ship&&this.addLine(L.name),L.projectile&&this.addLine(`${L.projectile.damage} damage`,Rd.Colors.LIGHT_RED),(P=L.motion)!=null&&P.vel&&this.addLine(`${he(L.motion.angle)}, vel ${L.motion.vel}`,Rd.Colors.LIGHT_GRAY),($=L.homing)!=null&&$.target&&this.addLine(`chasing ${L.homing.target===this.g.player?"you":(D=L.homing.target.ship)==null?void 0:D.name} ${L.homing.duration<1/0?`(${L.homing.duration})`:""}`,Rd.Colors.DARK_RED),L.lifetime&&this.addLine(`(lasts ${L.lifetime.duration})`,Rd.Colors.DARK_GRAY),L.explodes&&this.addLine(`explosion ${L.explodes.size}`,Rd.Colors.ORANGE)}};var T0=I(R()),Zd=class extends G{constructor(e,L){super(e);this.field=L;this.addLine("Explosion"),this.add({x:0,y:1,fg:T0.Colors.LIGHT_GRAY,line:"intensity"}),this.add({x:10,y:1,fg:T0.Colors.YELLOW,line:Math.floor(L.intensity).toString()})}};var C0=I(R()),sd=class extends G{constructor(e,L){super(e);this.item=L;switch(L.type){case"bomb":this.addLine("Smart Bomb");break;case"double":this.addLine("Double",dd.Double.fg,dd.Double.bg);break;case"drain":this.addLine("Drain",dd.Drain.fg,dd.Drain.bg);break;case"heal":this.addLine("Heal",dd.Healthy.fg,dd.Healthy.bg);break;case"junk":this.addLine("Junk",C0.Colors.DARK_GRAY);break;case"money":this.addLine(`${h.SetMember}${L.value}`,C0.Colors.YELLOW);break;case"recharge":this.addLine("Recharge");break}}};var Vd=I(R()),Xd=class{constructor(d,e,L){this.g=d;this.pilot=e;this.full=L;this.width=11,this.height=L?2+e.class.length:1}get isPlayer(){return this.pilot.player}draw(d,e){if(this.full&&(this.g.term.drawString(d,e,this.pilot.name,this.pilot.star?Vd.Colors.YELLOW:Vd.Colors.LIGHT_GRAY),e++),this.drawStat(d,e,"body"),this.drawStat(d+3,e,"mind"),this.drawStat(d+6,e,"spirit"),this.drawStat(d+9,e,"talent"),!!this.full)for(let L of this.pilot.class)this.g.term.drawString(d,++e,L,Vd.Colors.LIGHT_GREEN)}drawStat(d,e,L){let P=this.pilot[L];this.g.term.drawChar(d,e,L[0].toUpperCase(),Vd.Colors.WHITE),this.g.term.drawChar(d+1,e,P.toString(),zd[P])}};var Ea=I(R()),Nd=class extends G{constructor(e,L){super(e);this.e=L;L.doubleShot&&this.addLine(L.doubleShot.duration===1/0?"2x Shot":`2x Shot (${L.doubleShot.duration})`,Ea.Colors.LIGHT_GRAY)}};function F0(a,d,e,L,P,$,D,i,H){let b=`${Math.ceil(P)}/${$}`,B=Math.floor(P/$*L);a.drawHLine(d,e,L," ",void 0,i),B&&a.drawHLine(d,e,B," ",void 0,D),a.drawCenteredString(d+L/2,e,b,H)}var v=I(R()),cd=class{constructor(d,e){this.g=d;this.ship=e;this.width=Math.max(13,e.name.length),this.height=e.maxShield?3:2}draw(d,e){let{ship:L,width:P}=this,{term:$}=this.g,D=P-3;$.drawString(d,e,L.name,v.Colors.WHITE),$.drawString(d,e+1,"HP:",v.Colors.WHITE),F0($,d+3,e+1,D,L.hp,L.maxHp,v.Colors.DARK_GREEN,v.Colors.DARK_RED,v.Colors.WHITE),L.maxShield&&($.drawString(d,e+2,"Sh:",v.Colors.WHITE),F0($,d+3,e+2,D,L.shield,L.maxShield,v.Colors.DARK_CYAN,v.Colors.LIGHT_BLUE,v.Colors.WHITE))}};var pd=Math.PI/2,d0=pd/2,Ae={Right:0,DownRight:d0,Down:pd,DownLeft:pd+d0,Left:pd*2,UpLeft:pd*2+d0,Up:pd*3,UpRight:pd*3+d0},V=Ae;function Td(a,d){let e=Math.abs(a.x-d.x),L=Math.abs(a.y-d.y);return Math.sqrt(e*e+L*L)}var Ya=I(R());function t0(a){return a.salvo<=0?a.ammunition<=0?"Spent":"Reloading":a.timer>0?"Chambering":"Ready"}function a0(a){a.timer>0&&(a.timer--,a.timer<=0&&a.salvo<=0&&(a.ammunition?(a.salvo=Math.min(a.salvoCount,a.ammunition),a.ammunition-=a.salvo):a.timer=1/0))}function e0(a){return a.timer===0}function Sa(a,d){var L;let e=(L=a.delayedShot)!=null?L:{shots:[]};e.shots.push(d),a.setDelayedShot(e)}function na(a,d,e,L,P,$,D,i,H,b){var c;let B=a.spawn(e).setIgnoreSolid({ids:H}).move($.x,$.y);return B.name=d,i&&B.setMotion({angle:D,vel:i}),B.ship&&xd(B.ship),L.ship&&B.setOrigin({owner:L,ship:L.ship,turret:P}),(c=B.projectile)!=null&&c.scaling&&(B.projectile.damage=f0(B.projectile.scaling,L)),B.appearance&&b&&Object.assign(B.appearance,b),B}function fe(a,d,e,L,P){var $;switch(e.type){case"lastMovement":return($=P==null?void 0:P.angle)!=null?$:L.firingDirection;case"nearestEnemy":return id(a,d);case"random":return U([V.Right,V.DownRight,V.Down,V.DownLeft,V.Left,V.UpLeft,V.Up,V.UpRight]);case"relative":return _d(L.firingDirection+e.rel)}}function r0(a,d,e,L,P,$,D){var T;if($.doubleShot&&d.canDouble){let t=u(d);t.canDouble=!1,t.delay=$.player?2:1,t.appearance={fg:Ya.Colors.LIGHT_GRAY},Sa($,{turret:e,shot:t})}if(d.delay){let t=u(d);return $.player&&t.delay++,Sa($,{turret:e,shot:t}),[]}if(d.type==="array"){let t=[];for(let Q of n(a,$).filter(Pd=>Pd.tags.has(d.tag)).filter(Dd(["position","turret"])))t.push(...Id(a,Q.turret,K(Q.position,(T=d.offset)!=null?T:p(0,0)),P,$,D));return t}let{angle:i,beam:H,name:b,offset:B,prefab:c,vel:r}=d,J=K(L,B!=null?B:p(0,0)),F=fe(J,P,i,$.ship,$.lastMovement);if(H&&r){let[t,Q]=Hd({angle:F,vel:r}),Pd=p(t,Q),ud=K(J,Pd),aa=f0(H.length,$),ua=B0=>H.appearance[Math.max(0,H.appearance.length-aa+B0)];return ad(aa,0).map(B0=>{let Sd=na(a,b,c,$,e,ud,F,0,D,d.appearance).setMotion({angle:F,vel:0}).setLifetime({duration:H.duration}),ea=ua(B0);return Sd.appearance&&ea&&Object.assign(Sd.appearance,ea),$.ship&&Sd.setOrigin({owner:$,ship:$.ship,turret:e}),a.inBounds(ud)||Sd.kill({type:"exitedMap"}),ud=K(ud,Pd),Sd})}return[na(a,b,c,$,e,J,F,r,D,d.appearance)]}function Id(a,d,e,L,P,$){let{timeBetweenSalvos:D,timeBetweenShots:i}=d;--d.salvo<=0?d.timer=D:d.timer=i;let H=[];for(let b of d.shots)H.push(...r0(a,b,d,e,L,P,$));return H}function Ua(a){return(a==null?void 0:a.type)==="Player"}function L0(a,d){let e=Ua(d.ship),L=l(a,d),P=a.entities.get().filter(i=>i.ship&&Ua(i.ship)!==e);if(!P.length)return;let $=1/0,D;for(let i of P){let H=l(a,i),b=Td(L,H);b<$&&($=b,D=i)}return D}var Cd=I(R()),Xe={Spent:Cd.Colors.DARK_GRAY,Reloading:Cd.Colors.LIGHT_RED,Ready:Cd.Colors.YELLOW,Chambering:Cd.Colors.BROWN},Fd=class{constructor(d,e){this.g=d;this.turret=e;this.width=Math.max(e.name.length,this.stateLabel.length),this.height=2,e.ammunition>0&&e.ammunition<1/0&&this.height++}get stateLabel(){let{timer:d,salvo:e,salvoCount:L}=this.turret,P=t0(this.turret);if(P==="Spent")return"Out of Ammo";if(P==="Reloading")return`Reloading (${d})`;let $=`${e}/${L}`;return P==="Ready"?$:`${$} (${d})`}draw(d,e){this.g.term.drawString(d,e,this.turret.name,Cd.Colors.WHITE);let L=t0(this.turret);this.g.term.drawString(d,e+1,this.stateLabel,Xe[L]),this.height>2&&this.g.term.drawString(d,e+2,`${this.turret.ammunition} ammo left`,Cd.Colors.LIGHT_GRAY)}};var J0=I(R());function ja(a,d,e){if(!e.length)return;let L=[],P=1,$=1,D=B=>{L.push({x:P,y:$,object:B}),$+=B.height+1};for(let B of e){B.ship&&D(new cd(a,B.ship)),B.pilot&&D(new Xd(a,B.pilot,!0)),B.doubleShot&&D(new Nd(a,B));let c=n(a,B);for(let r of c.filter(Dd(["turret"])))D(new Fd(a,r.turret));B.item?D(new sd(a,B.item)):(B.motion||B.projectile||B.homing||B.lifetime||B.explodes)&&D(new ld(a,B)),B.field&&D(new Zd(a,B.field))}if(!L.length)return;let i=Math.max(...L.map(B=>B.object.width))+2,H=Math.min(d.x+2,a.term.width-i),b=Math.min(d.y,a.term.height-$);a.term.fillRect(H,b,i,$," ",J0.Colors.WHITE,J0.Colors.BLACK),a.term.drawSingleBox(H,b,i,$);for(let B of L)B.object.draw(H+B.x,b+B.y)}function P0(a,d){let e=d.x-a.x,L=d.y-a.y,P=Math.abs(e),$=Math.abs(L),D=e>0?1:-1,i=L>0?1:-1,H=N({},a),b=[N({},H)];for(let B=0,c=0;B<P||c<$;)(.5+B)/P<(.5+c)/$?(H.x+=D,B++):(H.y+=i,c++),b.push(N({},H));return b}var E=class{constructor(d,e){this.list=d;this.matches=Dd(e)}forEach(d){for(let e of this.list.get())this.matches(e)&&d(e,e)}};function R0(a){let d=new E(a.entities,["ai","position","ship"]);a.on("tick",function(){d.forEach(({ai:L,position:P},$)=>{if($.setLastMovement(),!L.attacking||!L.attacking.alive){let T=L0(a,$);if(T)L.attacking=T,a.fire("notice",{e:$,noticed:T});else return}let D=_(a,$),{layout:i}=z(a,$),H=s(P),b=a.getDistanceMap(L.attacking),B=T=>{let{oob:t,solid:Q,wall:Pd}=a.getContents(T,D);return!t&&!Q&&!Pd},c=T=>B(T)?Math.abs(b.getOrDefault(T,1/0)-L.idealDistance):1/0,r=T=>i.reduce((t,{offset:Q})=>t+c(K(T,Q)),0)/i.length,J=r(H),F=[];for(let T of b0){let t=K(H,T);if(!b.has(t))continue;let Q=r(t);Q<J?(J=Q,F=[t]):Q===J&&F.push(t)}if(F.length){let T=U(F);$.move(T.x,T.y),$.setLastMovement({angle:id(H,T)});return}})}),a.on("damage",function({e:L,source:P}){P.owner&&L!==P.owner&&L.ai&&!L.ai.attacking&&P.owner.alive&&(L.ai.attacking=P.owner)})}function I0(a){let d=new E(a.entities,["delayedShot","ship"]);a.on("tick",function(){d.forEach(({ai:L,delayedShot:P},$)=>{var D,i;if(!$.alive){$.setDelayedShot();return}for(let H=P.shots.length-1;H>=0;H--){let{turret:b,shot:B}=P.shots[H];if(--B.delay<=0){B.delay=0,P.shots.splice(H,1);let c=n(a,$),r=c.find(T=>T.turret===b),J=(D=r==null?void 0:r.position)!=null?D:l(a,$),F=(i=L==null?void 0:L.attacking)!=null&&i.alive?l(a,L.attacking):p(0,0);r0(a,B,b,J,F,$,c.map(T=>T.id))}}P.shots.length||$.setDelayedShot()})})}function Q0(a){let d=new E(a.entities,["appearance","position"]);a.on("draw",function(){d.forEach(({appearance:L,position:P})=>a.drawIfVisible(O(P.x),O(P.y),L.glyph,L.fg,L.bg,L.blendMode))})}function M0(a){a.on("kill",function({e,reason:L}){var D;let{position:P,ship:$}=e;if(P&&($!=null&&$.power)&&L.type==="damage"){let i=p0[$.power],H=((D=L.source.e.projectile)==null?void 0:D.special)==="increasedDropChance",b=$.type==="Battleship"?H?92:42:H?32:2,B=(F=1)=>fd(b*F),c=[];i&x.Double&&B()&&c.push("DoubleItem"),i&x.Drain&&B()&&c.push("DrainItem"),i&x.Healthy&&B()&&c.push("HealItem"),B()&&c.push("MoneyItem"),B()&&c.push("JunkItem"),B()&&c.push("RechargeItem");let r;if(B()){let F=n(a,e).filter(T=>T.tags.has("Special")&&T.prefab&&T.turret);F.length&&(r=U(F).prefab,c.push("BombItem"))}let J=Jd([p(-1,-1),p(0,-1),p(1,-1),p(-1,0),p(0,0),p(1,0),p(-1,1),p(0,1),p(1,1)]);for(let F of c){let T=J.pop();if(!T)return;let t=K(P,T),Q=a.spawn(F).move(t.x,t.y).setMotion({angle:V.Down,vel:1});F==="BombItem"&&r&&Q.setItem({type:"bomb",prefab:r})}}})}function Qd(a,d,e){return a*(1-e)+d*e}var $0=I(R()),ed=class{constructor(d){this.points=d;this.sort()}sort(){this.points.sort(([d],[e])=>d-e)}add(d,e){return this.points.push([d,e]),this.sort(),this}get(d){let[e,L]=this.points[0];if(d<=e)return(0,$0.fromRgb)(...L);let[P,$]=this.points[this.points.length-1];if(d>=P)return(0,$0.fromRgb)(...$);let D=this.points.findIndex(([Pd])=>Pd>d),[i,[H,b,B,c]]=this.points[D-1],[r,[J,F,T,t]]=this.points[D],Q=(d-i)/(r-i);return(0,$0.fromRgb)(Qd(H,J,Q),Qd(b,F,Q),Qd(B,T,Q),Qd(c,t,Q))}};var Ka=(i=>(i[i.Effect=0]="Effect",i[i.Item=1]="Item",i[i.Ship=2]="Ship",i[i.Gun=3]="Gun",i[i.Bullet=4]="Bullet",i[i.Player=5]="Player",i[i.PlayerBullet=6]="PlayerBullet",i))(Ka||{}),C=Ka;var xa=I(R()),ce={Fire:new ed([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Blue:new ed([[0,[0,0,0,0]],[2,[0,0,255,150]],[4,[0,155,255,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Yellow:new ed([[0,[0,0,0,0]],[2,[155,155,0,150]],[4,[255,255,55,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Green:new ed([[0,[0,0,0,0]],[2,[0,215,0,150]],[4,[55,255,55,150]],[6,[215,255,215,150]],[10,[255,255,255,255]]]),Magenta:new ed([[0,[0,0,0,0]],[2,[155,0,115,150]],[4,[255,115,255,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function E0(a){if(!(a.intensity<=0))return{glyph:" ",layer:C.Effect,bg:ce[a.type].get(a.intensity),blendMode:xa.BlendMode.Add}}function la(a,d){let e=[],L=Math.floor(a.x-d),P=Math.ceil(a.x+d),$=Math.floor(a.y-d),D=Math.ceil(a.y+d);for(let i=$;i<=D;i++)for(let H=L;H<=P;H++){let b=Td(a,{x:H,y:i});b>=d||e.push({x:H,y:i,intensity:d-b})}return e}function S0(a){a.on("kill",function({e,reason:L}){if(L.type==="exitedMap")return;let{explodes:P,name:$,position:D}=e;if(P&&D)for(let{x:i,y:H,intensity:b}of la(l(a,e),P.size))a.add(new Ad(a,$+"Explosion").setPosition({x:i,y:H}).setField({type:P.type,intensity:b,falloff:P.falloff}))})}function qd(a,d,e,L){var i;let P=a.getRoot(d);if(!P.ship)return;P.ship.type!=="Player"&&((i=L.origin)==null?void 0:i.ship.type)!=="Player"&&(e=Math.ceil(e/2));let $=e;P.ship.shield>0&&(P.ship.shield>e?(P.ship.shield-=e,$=0):($-=P.ship.shield,P.ship.shield=0)),$&&(P.ship.hp-=$);let D={e:L,owner:L};L.origin&&(D.owner=L.origin.owner,D.ship=L.origin.ship,D.turret=L.origin.turret),console.log(`${L.name}${L.origin?` (${L.origin.owner.name} #${L.origin.owner.id})`:""} hits ${P.name} for ${e}`),a.fire("damage",{e:P,amount:e,source:D}),P.ship.hp<=0&&a.kill(P,{type:"damage",source:D})}function n0(a){let d=new E(a.entities,["ship"]),e=new E(a.entities,["field","position"]);a.on("tick",function(){e.forEach(({field:P,position:$},D)=>{P.intensity-=P.falloff,D.setAppearance(E0(P)),P.intensity<1?a.kill(D,{type:"expired"}):d.forEach((i,H)=>{let{layout:b}=z(a,H);b.find(({absolute:c})=>w(c,$))&&qd(a,H,Math.floor(P.intensity),D)})})}),a.on("spawn",function({e:P}){P.field&&P.setAppearance(E0(P.field))})}function U0(a){let d=new E(a.entities,["homing","motion","position"]);a.on("tick",function(){d.forEach(({homing:L,motion:P,position:$},D)=>{var B;if(!((B=L.target)!=null&&B.alive))return;let i=l(a,L.target),H=id($,i),b=Ia(P.angle,H);Math.abs(b)<=L.strength?P.angle=H:b<0?P.angle-=L.strength:P.angle+=L.strength,--L.duration<=0&&(D.setHoming(),D.setTrail())})})}var Y0={};$d(Y0,{AcidBullet:()=>te,BellowMissile:()=>Se,Bullet:()=>Te,CrushBullet:()=>Je,DroneBullet:()=>Ce,HomingMissile:()=>Ie,OutcryBullet:()=>Fe,PlayerBullet:()=>ne,SalvoMissileA:()=>Qe,SalvoMissileB:()=>Me,SalvoMissileC:()=>Ee,SmiteMissile:()=>Re,TalonBullet:()=>re});var A=(a,d,e,L,P)=>({name:a,x:d,y:e,overlay:L,tags:P}),j=(a,d,e,L=0)=>({name:a,type:d,maxHp:e,hp:0,maxShield:L,shield:0,shieldTimer:0,firingDirection:d==="Player"?V.Up:V.Down}),M=(a,{salvoCount:d=1,timeBetweenShots:e=1,timeBetweenSalvos:L=1,ammunition:P=1/0},$)=>({name:a,shots:$,salvoCount:d,timeBetweenShots:e,timeBetweenSalvos:L,timer:0,salvo:d,ammunition:P}),pe=["F","FR","R","BR","B","BL","L","FL"],X=a=>({type:"relative",rel:pe.indexOf(a)*Math.PI/4}),Za={type:"nearestEnemy"},sa={type:"random"},Z=(a,d,e=1)=>({type:"pilot",stat:d,base:a,multiplier:e}),f=(a,d,e,L,{canDouble:P,delay:$,offset:D,beam:i}={})=>({type:"bullet",canDouble:P,name:a,prefab:d,angle:e,vel:L,delay:$,offset:D,beam:i}),y=(a,{delay:d,offset:e}={})=>({type:"array",canDouble:!1,tag:a,delay:d,offset:e});var k=I(R()),Te={components:{projectile:{damage:1,scaling:Z(1,"body")},appearance:{glyph:h.InvertedExclamation,layer:C.Bullet,fg:k.Colors.YELLOW}}},Ce={components:{projectile:{damage:1,scaling:Z(1,"body")},appearance:{glyph:".",layer:C.Bullet,fg:k.Colors.ORANGE}}},Fe={components:{projectile:{damage:6,scaling:Z(6,"mind")},appearance:{glyph:"o",layer:C.Bullet,fg:(0,k.fromRgb)(255,55,135)}}},te={components:{projectile:{damage:6,scaling:Z(6,"mind")},appearance:{glyph:h.Approximates,layer:C.Bullet,fg:(0,k.fromRgb)(55,55,215)}}},re={components:{projectile:{damage:6,scaling:Z(6,"mind")},appearance:{glyph:"`",layer:C.Bullet,fg:(0,k.fromRgb)(135,255,55)}}},Je={components:{projectile:{damage:6,scaling:Z(6,"mind")},homing:{strength:1,duration:3},appearance:{glyph:h.Square,layer:C.Bullet,fg:(0,k.fromRgb)(175,175,0)}}},Re={components:{projectile:{damage:2,scaling:Z(2,"mind")},homing:{strength:10,duration:1},explodes:{size:7,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:k.Colors.ORANGE}}},Ie={components:{projectile:{damage:1,scaling:Z(1,"mind")},homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:k.Colors.DARK_RED}}},Qe={components:{projectile:{damage:1,scaling:Z(1,"mind")},homing:{strength:.15,duration:4},trail:{effectPrefab:"SmokePuff"},explodes:{size:8,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:k.Colors.DARK_RED}}},Me={components:{projectile:{damage:1,scaling:Z(1,"mind")},homing:{strength:.25,duration:5},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:k.Colors.DARK_RED}}},Ee={components:{projectile:{damage:1,scaling:Z(1,"mind")},homing:{strength:.35,duration:8},trail:{effectPrefab:"SmokePuff"},explodes:{size:4,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:k.Colors.DARK_RED}}},Se={components:{projectile:{damage:20,scaling:Z(20,"mind")},homing:{strength:.15,duration:30},trail:{effectPrefab:"SmokePuff"},explodes:{size:6,type:"Fire",falloff:1},appearance:{glyph:h.CurlyF,layer:C.Bullet,fg:k.Colors.LIGHT_RED}}},ne={components:{projectile:{damage:3,scaling:Z(3,"body")},appearance:{glyph:"!",layer:C.PlayerBullet,fg:k.Colors.YELLOW}}};var j0={};$d(j0,{AirFistRange:()=>Ue,SmokePuff:()=>Ye});var Md=I(R()),Ue={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:C.Effect,bg:(0,Md.fromRgb)(0,255,255,100),blendMode:Md.BlendMode.Add}}},Ye={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:C.Effect,bg:(0,Md.fromRgb)(100,100,100,50),blendMode:Md.BlendMode.Add}}};var K0={};$d(K0,{AcidSplash:()=>se,Bellow:()=>Ge,Cleave:()=>le,CrushPattern:()=>ke,DemandHomage:()=>ue,DroneGun:()=>me,Outcry:()=>Ze,PeaShooter:()=>Ke,PlayerGun:()=>xe,Salvo:()=>oe,ShuttleLaunch:()=>Ve,Smite:()=>ge,TalonSwipe:()=>qe,TheDragonWakes:()=>ye,Veto:()=>Ne});var je={Right:p(1,0),DownRight:p(1,1),Down:p(0,1),DownLeft:p(-1,1),Left:p(-1,0),UpLeft:p(-1,-1),Up:p(0,-1),UpRight:p(1,-1),None:p(0,0)},g=je;var Ke={components:{turret:M("Main Gun",{salvoCount:1,timeBetweenSalvos:3},[f("Bullet","Bullet",X("F"),2,{canDouble:!0})])}},xe={components:{turret:M("Main Gun",{salvoCount:2,timeBetweenShots:0,timeBetweenSalvos:3},[f("Your Bullet","PlayerBullet",X("F"),2,{canDouble:!0})])}},le={components:{turret:M("Cleave",{salvoCount:1,timeBetweenSalvos:11},[y("Primary"),y("Primary",{delay:1}),y("Primary",{delay:2}),y("Primary",{delay:3}),y("Primary",{delay:4})])}},Ze={components:{turret:M("Outcry",{salvoCount:1,timeBetweenSalvos:8},[f("Outcry","OutcryBullet",X("FR"),2),f("Outcry","OutcryBullet",X("R"),2),f("Outcry","OutcryBullet",X("BR"),2),f("Outcry","OutcryBullet",X("B"),2),f("Outcry","OutcryBullet",X("BL"),2),f("Outcry","OutcryBullet",X("L"),2),f("Outcry","OutcryBullet",X("FL"),2)])}},se={components:{turret:M("Acid Splash",{salvoCount:1,timeBetweenSalvos:13},[f("Acid Splash","AcidBullet",X("BR"),2),f("Acid Splash","AcidBullet",X("BL"),2),f("Acid Splash","AcidBullet",X("R"),2,{delay:1}),f("Acid Splash","AcidBullet",X("L"),2,{delay:1}),f("Acid Splash","AcidBullet",X("FR"),2,{delay:2}),f("Acid Splash","AcidBullet",X("FL"),2,{delay:2}),f("Acid Splash","AcidBullet",X("R"),2,{delay:3}),f("Acid Splash","AcidBullet",X("L"),2,{delay:3}),f("Acid Splash","AcidBullet",X("BR"),2,{delay:4}),f("Acid Splash","AcidBullet",X("BL"),2,{delay:4})])}},Ve={components:{turret:M("Shuttle Launch",{salvoCount:1,timeBetweenSalvos:27},[f("Runabout","DroneA",X("R"),0,{offset:g.Left}),f("Runabout","DroneA",X("L"),0,{offset:g.Right})])}},Ne={components:{turret:M("Veto",{salvoCount:1,timeBetweenSalvos:21},[f("Veto","HomingMissile",X("B"),1),f("Wasp","DroneB",X("FL"),0,{offset:g.DownRight})])}},qe={components:{turret:M("Talon Swipe",{salvoCount:1,timeBetweenSalvos:10},[f("Talon Swipe","TalonBullet",X("R"),2),f("Talon Swipe","TalonBullet",X("L"),2),f("Talon Swipe","TalonBullet",X("R"),2,{delay:1}),f("Talon Swipe","TalonBullet",X("L"),2,{delay:1}),f("Talon Swipe","TalonBullet",X("R"),2,{delay:2}),f("Talon Swipe","TalonBullet",X("L"),2,{delay:2})])}},ke={components:{turret:M("Crush Pattern",{salvoCount:1,timeBetweenSalvos:15},[f("Crush Pattern","CrushBullet",X("R"),1),f("Crush Pattern","CrushBullet",X("BR"),1),f("Crush Pattern","CrushBullet",X("BL"),1),f("Crush Pattern","CrushBullet",X("L"),1)])}},ge={components:{turret:M("Smite",{salvoCount:1,timeBetweenSalvos:16},[f("Smite","SmiteMissile",X("L"),1),f("Smite","SmiteMissile",X("L"),1,{delay:1})])}},me={components:{turret:M("Stinger",{salvoCount:1,timeBetweenSalvos:5,ammunition:5},[f("Bullet","DroneBullet",Za,1,{canDouble:!0})])}},oe={components:{turret:M("Salvo",{salvoCount:1,timeBetweenSalvos:10},[f("Missile","SalvoMissileA",X("BR"),1),f("Missile","SalvoMissileB",X("BR"),1),f("Missile","SalvoMissileC",X("BR"),1)])}},ye={components:{turret:M("The Dragon Wakes",{salvoCount:1,timeBetweenSalvos:12},[f("Drone","DroneA",X("B"),0,{offset:g.Up}),f("Missile","HomingMissile",X("FR"),2,{offset:g.DownLeft}),f("Missile","HomingMissile",X("FL"),2,{offset:g.DownRight})])}},Ge={components:{turret:M("Bellow",{salvoCount:1,timeBetweenSalvos:17},[f("Bellow","BellowMissile",X("FR"),1),y("Primary"),y("Primary",{delay:1}),y("Primary",{delay:2}),y("Primary",{delay:3})])}},ue={components:{turret:M("Demand Homage",{salvoCount:1,timeBetweenSalvos:21},[f("Pulsar","DroneC",X("FR"),0,{offset:g.DownLeft}),f("Pulsar","DroneC",X("BR"),0,{offset:g.UpLeft}),f("Pulsar","DroneC",X("BL"),0,{offset:g.UpRight}),f("Pulsar","DroneC",X("FL"),0,{offset:g.DownRight})])}};var x0={};$d(x0,{BombItem:()=>Oe,DoubleItem:()=>ze,DrainItem:()=>ve,HealItem:()=>We,JunkItem:()=>we,MoneyItem:()=>_e,RechargeItem:()=>dL});var Oe={components:{appearance:{glyph:h.DoubleNote,layer:C.Item},item:{type:"bomb",prefab:"BombItem"}}},ze={components:{appearance:{glyph:h.Squared,layer:C.Item},item:{type:"double"}}},ve={components:{appearance:{glyph:"%",layer:C.Item},item:{type:"drain"}}},We={components:{appearance:{glyph:h.Heart,layer:C.Item},item:{type:"heal"}}},we={components:{appearance:{glyph:h.Beta,layer:C.Item},item:{type:"junk"}}},_e={components:{appearance:{glyph:h.SetMember,layer:C.Item},item:{type:"money",value:0}}},dL={components:{appearance:{glyph:"@",layer:C.Item},item:{type:"recharge"}}};var Z0={};$d(Z0,{PlayerHull:()=>aL,PlayerShip:()=>eL});var l0=I(R()),aL={components:{solid:!0,appearance:{glyph:"#",layer:C.Player,fg:l0.Colors.DARK_GRAY}}},eL={components:{player:{weaponArrays:["Primary","Secondary"],bombs:[]},ship:j("Ace of Clubs","Player",20,10),explodes:{type:"Fire",size:6,falloff:1}},children:[A("PlayerHull",0,0,{appearance:{glyph:h.LeftArrow}}),A("PlayerHull",1,0,{appearance:{glyph:h.Club,fg:l0.Colors.LIGHT_GRAY}}),A("PlayerHull",2,0,{appearance:{glyph:h.RightArrow}}),A("PlayerGun",1,0,void 0,["Primary"]),A("Sword",1,0,void 0,["Secondary"])]};var N0={};$d(N0,{AtomSmasher:()=>tL,CruiseyWing:()=>cL,Demigod:()=>CL,DroneA:()=>AL,DroneB:()=>fL,DroneC:()=>XL,GoutOFlame:()=>TL,Gremlin:()=>FL,Hull:()=>LL,Olm:()=>pL,ShipA:()=>PL,ShipB:()=>$L,ShipC:()=>DL,ShipD:()=>iL,ShipE:()=>HL,ShipF:()=>BL,ShipG:()=>bL,ShipH:()=>hL});var Va=I(R()),LL={components:{solid:!0,appearance:{glyph:"#",layer:C.Ship,fg:Va.Colors.DARK_GRAY}}},m={idealDistance:8,firingDistance:14,speed:1},Ld=A("PeaShooter",0,0,void 0,["Primary"]),Bd={type:"Fire",size:4,falloff:1},PL={components:{ai:m,ship:j("Axle","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:h.Pilcrow}}),Ld,A("Cleave",0,0,void 0,["Special"])]},$L={components:{ai:m,ship:j("Baying Hound","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:h.Yen}}),Ld,A("Outcry",0,0,void 0,["Special"])]},DL={components:{ai:m,ship:j("Caustic","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:"W"}}),Ld,A("AcidSplash",0,0,void 0,["Special"])]},iL={components:{ai:m,ship:j("Defiant","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:h.Omega}}),Ld,A("ShuttleLaunch",0,0,void 0,["Special"])]},HL={components:{ai:m,ship:j("Executor","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:h.DownWedge}}),Ld,A("Veto",0,0,void 0,["Special"])]},BL={components:{ai:m,ship:j("Falcon","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:h.Pi}}),Ld,A("TalonSwipe",0,0,void 0,["Special"])]},bL={components:{ai:m,ship:j("Gauntlet","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:"M"}}),Ld,A("CrushPattern",0,0,void 0,["Special"])]},hL={components:{ai:m,ship:j("Halo","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:h.Female}}),Ld,A("Smite",0,0,void 0,["Special"])]},s0={idealDistance:5,firingDistance:6,speed:1},Na=A("DroneGun",0,0,void 0,["Primary"]),V0={type:"Fire",size:3,falloff:1},AL={components:{ai:s0,ship:j("Runabout","Escort",1),explodes:V0},children:[A("Hull",0,0,{appearance:{glyph:h.Theta}}),Ld]},fL={components:{ai:s0,ship:j("Wasp","Escort",1),explodes:V0},children:[A("Hull",0,0,{appearance:{glyph:h.SymbolED}}),Na]},XL={components:{ai:s0,ship:j("Pulsar","Escort",1),explodes:V0},children:[A("Hull",0,0,{appearance:{glyph:h.Silcrow}}),Na]},Ed={type:"Fire",size:6,falloff:1},cL={components:{ai:m,ship:j("Cruisey Wing","Battleship",10,5),explodes:Ed},children:[A("Hull",0,0,{appearance:{glyph:h.Not}}),A("Hull",1,0,{appearance:{glyph:h.HorizontalDivide}}),A("Hull",2,0,{appearance:{glyph:h.NotFlip}}),A("PeaShooter",0,0,void 0,["Primary"]),A("PeaShooter",1,0,void 0,["Primary"]),A("PeaShooter",2,0,void 0,["Primary"]),A("Salvo",1,0,void 0,["Special"])]},pL={components:{ai:m,ship:j("Olm","Battleship",15,4),explodes:Ed},children:[A("Hull",0,0,{appearance:{glyph:h.Cent}}),A("Hull",0,1,{appearance:{glyph:h.ResizeVertical}}),A("Hull",0,2,{appearance:{glyph:h.BoxDownSingleHorizontalDouble}}),A("PeaShooter",0,2,void 0,["Primary"]),A("TheDragonWakes",0,0,void 0,["Special"])]},TL={components:{ai:m,ship:j("Gout-o'-flame","Battleship",5,20),explodes:Ed},children:[A("Hull",0,0,{appearance:{glyph:h.Pentagon}}),A("Hull",1,0,{appearance:{glyph:h.BoxVerticalDoubleHorizontalSingle}}),A("Hull",2,0,{appearance:{glyph:h.Pentagon}}),A("Hull",1,1,{appearance:{glyph:h.BoxUpDoubleHorizontalSingle}}),A("PeaShooter",1,1,void 0,["Primary"]),A("Bellow",1,1,void 0,["Special"])]},CL={components:{ai:m,ship:j("Demigod","Battleship",30,15),explodes:Ed},children:[A("Hull",1,0,{appearance:{glyph:h.CapitalUUmlaut}}),A("Hull",0,1,{appearance:{glyph:"}"}}),A("Hull",1,1,{appearance:{glyph:h.RingInvert}}),A("Hull",2,1,{appearance:{glyph:"{"}}),A("Hull",1,2,{appearance:{glyph:"Y"}}),A("PeaShooter",1,2,void 0,["Primary"]),A("DemandHomage",1,1,void 0,["Special"])]},FL={components:{ai:m,ship:j("Gremlin","Battleship",30,15),explodes:Ed},children:[A("Hull",1,0,{appearance:{glyph:h.ResizeVertical}}),A("Hull",2,0,{appearance:{glyph:h.ResizeVertical}}),A("Hull",0,1,{appearance:{glyph:"]"}}),A("Hull",1,1,{appearance:{glyph:h.BoxLeftSingleUpDouble}}),A("Hull",2,1,{appearance:{glyph:h.BoxRightSingleUpDouble}}),A("Hull",3,1,{appearance:{glyph:h.Male}}),A("Hull",1,2,{appearance:{glyph:h.BoxVerticalSingle}}),A("Hull",2,2,{appearance:{glyph:h.Gamma}}),A("PeaShooter",1,2,void 0,["Primary"]),A("PeaShooter",2,2,void 0,["Primary"])]},tL={components:{ai:m,ship:j("Atom Smasher","Battleship",10,20),explodes:Ed},children:[A("Hull",1,0,{appearance:{glyph:h.EHat}}),A("Hull",2,0,{appearance:{glyph:"-"}}),A("Hull",3,0,{appearance:{glyph:h.AHat}}),A("Hull",0,1,{appearance:{glyph:h.Fill2}}),A("Hull",1,1,{appearance:{glyph:h.Fill1}}),A("Hull",2,1,{appearance:{glyph:h.Fill2}}),A("Hull",3,1,{appearance:{glyph:h.Fill3}}),A("Hull",4,1,{appearance:{glyph:h.Filled}}),A("PeaShooter",0,1,void 0,["Primary"]),A("PeaShooter",1,1,void 0,["Primary"]),A("PeaShooter",2,1,void 0,["Primary"]),A("PeaShooter",3,1,void 0,["Primary"]),A("PeaShooter",4,1,void 0,["Primary"])]};var q0={};$d(q0,{Laser:()=>IL,LaserBeam:()=>QL,Multiball:()=>JL,MultiballShot:()=>rL,Overload:()=>YL,OverloadBullet:()=>UL,StubbornDescent:()=>RL,SwitchbladeBullet:()=>ML,Switchblades:()=>EL,Triangulate:()=>nL,TriangulateMissile:()=>SL});var bd=I(R()),rL={components:{projectile:{damage:7},appearance:{glyph:"+",layer:C.Bullet,fg:(0,bd.fromRgb)(255,255,55)}}},JL={components:{turret:M("Multiball",{salvoCount:1,timeBetweenSalvos:15},[f("Multiball","MultiballShot",X("FR"),2),f("Multiball","MultiballShot",X("R"),2),f("Multiball","MultiballShot",X("L"),2),f("Multiball","MultiballShot",X("FL"),2),f("Runabout","DroneA",X("BR"),0,{offset:g.UpLeft}),f("Runabout","DroneA",X("BL"),0,{offset:g.UpRight})])}},RL={components:{turret:M("Stubborn Descent",{salvoCount:13,timeBetweenSalvos:21},[y("Primary")])}},IL={components:{projectile:{damage:2},appearance:{glyph:"|",layer:C.Bullet,fg:bd.Colors.WHITE,bg:bd.Colors.LIGHT_BLUE}}},QL={components:{turret:M("Laser Beam",{salvoCount:10,timeBetweenSalvos:30},[f("Laser","Laser",X("F"),1,{offset:g.Down,beam:{duration:1,length:60,appearance:[]}})])}},ML={components:{projectile:{damage:9},appearance:{glyph:h.ResizeHorizontal,layer:C.Bullet,fg:bd.Colors.LIGHT_BLUE}}},EL={components:{turret:M("Switchblades",{salvoCount:1,timeBetweenSalvos:11},[...ad(9).map(a=>f("Switchblade","SwitchbladeBullet",X("FR"),1,{delay:a})),...ad(9).map(a=>f("Switchblade","SwitchbladeBullet",X("FL"),1,{delay:a}))])}},SL={components:{projectile:{damage:10},homing:{strength:.1,duration:1/0},explodes:{type:"Blue",size:4,falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:bd.Colors.DARK_CYAN}}},nL={components:{turret:M("Triangulate",{salvoCount:1,timeBetweenSalvos:17},[f("Triangulate","TriangulateMissile",X("FR"),1),f("Triangulate","TriangulateMissile",X("R"),1,{delay:1}),f("Triangulate","TriangulateMissile",X("BR"),1,{delay:2}),f("Triangulate","TriangulateMissile",X("B"),1,{delay:3}),f("Triangulate","TriangulateMissile",X("BL"),1,{delay:4}),f("Triangulate","TriangulateMissile",X("L"),1,{delay:5}),f("Triangulate","TriangulateMissile",X("FL"),1,{delay:6})])}},UL={components:{projectile:{damage:7},appearance:{glyph:h.Smiley,layer:C.Bullet,fg:bd.Colors.LIGHT_GRAY}}},YL={components:{turret:M("Overload",{salvoCount:1,timeBetweenSalvos:20},ad(11).map(a=>f("Overload","OverloadBullet",sa,2,{delay:a})))}};var k0={};$d(k0,{Sword:()=>KL,SwordBullet:()=>jL});var td=I(R()),jL={components:{projectile:{damage:5,scaling:Z(5,"spirit"),special:"increasedDropChance"},appearance:{glyph:h.Star,layer:C.PlayerBullet,fg:td.Colors.LIGHT_GREEN}}},KL={components:{turret:M("Sword",{salvoCount:1,timeBetweenSalvos:20},[f("Stab","SwordBullet",{type:"lastMovement"},1,{beam:{duration:2,length:Z(4,"spirit"),appearance:[{glyph:h.Star,fg:td.Colors.LIGHT_GREEN},{glyph:"o",fg:td.Colors.LIGHT_GREEN},{glyph:h.Diamond,fg:td.Colors.LIGHT_GREEN},{glyph:h.Ring,fg:td.Colors.DARK_GREEN},{glyph:h.Dot,fg:td.Colors.DARK_GRAY}]}})])}};var qa=N(N(N(N(N(N(N(N({},Y0),j0),x0),K0),Z0),N0),q0),k0);function D0(a){return qa[a]}function g0(a,d){return a.add(new Ad(a,d).applyPrefab(d,qa[d]))}var ka=["Cleave","Outcry","AcidSplash","ShuttleLaunch","Veto","TalonSwipe","CrushPattern","Smite","Salvo","TheDragonWakes","Bellow","DemandHomage","Multiball","StubbornDescent","Switchblades","Triangulate","Overload"];var ga=I(R()),kd=class{constructor(d,e){this.g=d;this.player=e;this.lines=e.bombs.map(L=>{var P,$,D;return(D=($=(P=D0(L).components)==null?void 0:P.turret)==null?void 0:$.name)!=null?D:"?"}),this.width=this.lines.reduce((L,P)=>Math.max(L,P.length),0),this.height=this.lines.length}draw(d,e){for(let L of this.lines)this.g.term.drawString(d,e++,L,ga.Colors.WHITE)}};var W=I(R()),hd=6;function m0(a){let{mapHeight:d,term:e}=a;a.on("draw",function(){let P=a.player,{pilot:$,player:D,ship:i}=P;e.fillRect(0,d,e.width,hd," ",W.Colors.WHITE,W.Colors.BLACK),e.drawSingleBox(0,d,e.width,hd);let H=1,b=d+1,B=new cd(a,i);B.draw(H,b);let c=H+Math.floor((B.width-11)/2);new Xd(a,$,!1).draw(c,b+3),H+=B.width+1,e.drawChar(H-1,b-1,h.BoxDownSingleHorizontalSingle,W.Colors.WHITE),e.drawVLine(H-1,b,hd-2,h.BoxVerticalSingle,W.Colors.WHITE),e.drawChar(H-1,b+hd-2,h.BoxUpSingleHorizontalSingle,W.Colors.WHITE);for(let J of D.weaponArrays){let F=H,T=n(a,P).filter(t=>t.tags.has(J)).filter(Dd(["turret"]));for(let t of T){let Q=new Fd(a,t.turret);Q.draw(H,b+1),H+=Q.width+1}e.drawString(F,b,J,W.Colors.LIGHT_CYAN),H=Math.max(H,F+J.length+1)}D.bombs.length&&(e.drawChar(H-1,b-1,h.BoxDownSingleHorizontalSingle,W.Colors.WHITE),e.drawVLine(H-1,b,hd-2,h.BoxVerticalSingle,W.Colors.WHITE),e.drawChar(H-1,b+hd-2,h.BoxUpSingleHorizontalSingle,W.Colors.WHITE),new kd(a,D).draw(H,b))})}function o0(a){let d=new E(a.entities,["lifetime"]);a.on("tick",function(){d.forEach(({lifetime:L},P)=>{if(--L.duration<=0)a.kill(P,{type:"expired"});else if(L.decayingAppearance&&P.appearance){let $=L.decayingAppearance[L.duration-1];Object.assign(P.appearance,$)}})})}function y0(a,d,e){if(!(!d.ship||!d.player))switch(e.type){case"double":d.doubleShot?d.doubleShot.duration+=9:d.setDoubleShot({duration:9});return;case"heal":{let L=Math.ceil(d.ship.maxHp/4);d.ship.hp=Math.min(d.ship.maxHp,d.ship.hp+L);return}case"recharge":{for(let L of n(a,d))if(L.turret)for(;L.turret.timer<1/0&&L.turret.timer>0;)a0(L.turret);return}case"bomb":for(d.player.bombs.push(e.prefab);d.player.bombs.length>pa(d);)d.player.bombs.shift();break;case"junk":if(fd(Ta(d)))return y0(a,d,{type:"bomb",prefab:U(ka)});break}}function G0(a){let d=new E(a.entities,["motion","position"]);a.on("tick",function(){d.forEach(({motion:L,position:P,projectile:$,ignoreSolid:D,item:i},H)=>{let[b,B]=Hd(L),c=p(P.x+b,P.y+B),r=P0(s(P),s(c)),J=!1,F;for(let T of r){if(!a.inBounds(T)){a.kill(H,{type:"exitedMap"});return}a.move(H,T);let{wall:t,solid:Q}=a.getContents(T,D==null?void 0:D.ids);if(t){J=!0;break}else if(Q){F=Q;break}}J?a.kill(H,{type:"hitWall"}):F?($&&qd(a,F,$.damage,H),i&&y0(a,a.getRoot(F),i),a.kill(H,{type:"hitEntity",other:F})):a.move(H,c)})})}function u0(a){a.on("playerMove",function({move:e}){let L=a.player,P=L.position,$=K(P,e);Aa(a,L,$).length||(L.move($.x,$.y),L.setLastMovement({angle:id(P,$)}),a.tick())}),a.on("playerFire",function({array:e}){let L=a.player,P=L.player.weaponArrays[e],$=n(a,L),D=$.filter(H=>H.tags.has(P)),i=!1;for(let H of D)!H.position||!H.turret||e0(H.turret)&&(Id(a,H.turret,H.position,p(0,0),L,$.map(b=>b.id)),i=!0);i&&(L.setLastMovement(),a.tick())}),a.on("playerBomb",function(){var $;let e=a.player,L=e.player.bombs.shift();if(!L)return;let P=D0(L);if(($=P.components)!=null&&$.turret){let D=u(P.components.turret),i=l(a,e),H=L0(a,e),b=H?l(a,H):p(0,0),B=Id(a,D,i,b,e,_(a,e));for(let c of B)jd(c,["ai","ship"])&&(c.ai.attacking=H,c.ship.firingDirection=V.Up),c.homing&&(c.homing.target=H);e.setLastMovement(),a.tick()}})}function gd(a){return typeof a!="undefined"}var ma=I(R());function O0(a){let d=new E(a.entities,["ship"]);a.on("tick",function(){d.forEach((L,P)=>{P.doubleShot&&--P.doubleShot.duration<=0&&P.setDoubleShot()})}),a.on("draw",function(){let L=n(a,a.player).map(P=>P.position).filter(gd);if(a.player.doubleShot)for(let P of L)a.blend(P.x,P.y,ma.Colors.LIGHT_GRAY)})}function z0(a){let d=new E(a.entities,["ship"]);a.on("tick",function(){d.forEach(({ship:L},P)=>{if(L.shield>=L.maxShield){L.shieldTimer=0;return}let $=ca(P);++L.shieldTimer>=$&&(L.shield++,L.shieldTimer=0)})})}function v0(a){a.on("waveBegin",function({wave:L,difficulty:P,pilot:$}){let D=(P+L.difficulty)*3,i=[];for(let B of L.groups)for(let c=0;c<B.count;c++)i.push(U(B.prefabs));let H=L.groups.filter(B=>B.type==="Escort");for(let B=0;B<P;B++){let c=U(H);i.push(U(c.prefabs))}let b=Math.floor(Math.random()*i.length);for(let B=0;B<i.length;B++){let c=B===b&&$!==void 0,r=i[B],J=ra(D,c),F=Ja(a,r,J,c?$:void 0),T=Ra(a,F);F.move(T.x,T.y)}});let d=1/0;a.on("kill",({e})=>{if(!e.ship)return;a.entities.get().filter(P=>P.alive&&P.ship&&P.ship.type!=="Player").length||(d=5)}),a.on("tick",()=>{--d<=0&&(d=1/0,a.fire("waveNext",void 0))})}function W0(a){a.on("move",function({e,old:L,pos:P}){e.trail&&!w(L,P)&&a.spawn(e.trail.effectPrefab).setPosition(L)})}function w0(a){let d=new E(a.entities,["position","turret"]);a.on("tick",function(){d.forEach(({position:L,turret:P},$)=>{var b;a0(P);let D=a.getRoot($);if(!jd(D,["ai","ship"]))return;let i=D.ai.attacking;if(!(i!=null&&i.alive))return;let H=l(a,i);if(!(Td(L,H)>((b=D.ai.firingDistance)!=null?b:1/0))&&e0(P))for(let B of Id(a,P,L,H,D,_(a,D)))B.homing&&(B.homing.target=i),B.ai&&(B.ai.attacking=i)})})}function oa(a){o0(a),U0(a),I0(a),w0(a),n0(a),z0(a),G0(a),R0(a),v0(a),Q0(a),m0(a),W0(a),S0(a),M0(a),O0(a),u0(a)}var Y=I(R()),md=class{constructor(d,e){this.g=d;this.campaign=e;this.dirty=!0,this.examining=[]}refresh(){this.dirty=!0}init(){let{g:d}=this;this.examineAt=void 0,this.examining=[],this.waves=ta(),d.blankMap(),d.entities.clearExceptFor(_(d,d.player));let{width:e,height:L}=z(d,d.player);d.player.move(O(d.mapWidth/2-e/2),d.mapHeight-L-4),d.player.ship.shield=d.player.ship.maxShield,oa(d),this.nextWave(),d.on("waveNext",this.nextWave.bind(this))}nextWave(){let d=this.waves.shift();if(d){let e=this.waves.length===0?this.campaign.currentSector.star:void 0;this.g.fire("waveBegin",{wave:d,difficulty:this.campaign.difficulty,pilot:e});return}this.g.player.alive&&(this.campaign.currentSector.completed=!0)}draw(){let{map:d,mapWidth:e,mapHeight:L,overlays:P,player:$,term:D}=this.g;for(let i=0;i<L;i++)for(let H=0;H<e;H++){let b=d.grid[i][H];D.drawChar(H,i,0,b.fg,b.bg)}if(this.g.fire("draw",void 0),this.dirty=!1,this.showOverlay){let i=P.get(this.showOverlay);if(i)for(let H=0;H<L;H++)for(let b=0;b<e;b++){let B=i.get({x:b,y:H})||1/0,c=B===1/0?"-":B<10?`${B}`:"*";D.drawChar(b,H,c,Y.Colors.LIGHT_RED)}}if(this.examineAt){ja(this.g,this.examineAt,this.examining);for(let i of this.examining){let{motion:H,position:b}=i;if(H&&b){let[B,c]=Hd(H),r=p(b.x+B,b.y+c),J=P0(s(b),s(r));for(let F of J)this.g.blend(F.x,F.y,Y.Colors.DARK_RED)}}}$.alive?this.campaign.currentSector.completed&&(D.drawCenteredString(D.width/2,5,"SECTOR COMPLETE",Y.Colors.WHITE,Y.Colors.BLACK),D.drawCenteredString(D.width/2,7,"Hit Enter to continue",Y.Colors.WHITE,Y.Colors.BLACK)):(D.drawCenteredString(D.width/2,5,"YOU HAVE PERISHED!",Y.Colors.LIGHT_RED,Y.Colors.BLACK),D.drawCenteredString(D.width/2,7,"Hit Q to try again",Y.Colors.LIGHT_RED,Y.Colors.BLACK))}update(){(this.g.term.mouse.dx||this.g.term.mouse.dy)&&this.refresh(),this.handleKeys(),this.dirty&&(this.handleMouseMove(),this.draw())}examine(d){this.examineAt=d,this.dirty=!0;let{solid:e,other:L}=this.g.getContents(d),P=new Set;e&&P.add(this.g.getRoot(e));for(let $ of L)P.add(this.g.getRoot($));this.examining=[...P]}handleMouseMove(){let{x:d,y:e}=this.g.term.mouse;this.examine({x:d,y:e})}handleKeys(){let{player:d,term:e}=this.g;if(!d.alive){(e.isKeyPressed(Y.Key.VK_Q)||e.isKeyPressed(Y.Key.VK_ESCAPE))&&(this.g.setMode(new rd(this.g)),e.fillRect(0,0,e.width,e.height," ",Y.Colors.WHITE,Y.Colors.BLACK));return}if(this.campaign.currentSector.completed&&(e.isKeyPressed(Y.Key.VK_ENTER)||e.isKeyPressed(Y.Key.VK_NUMPAD_ENTER))){this.campaign.endCombat();return}let L=e.getMovementKey();if(L){this.g.fire("playerMove",{move:L});return}if(e.isKeyPressed(Y.Key.VK_1)){this.g.fire("playerFire",{array:0});return}if(e.isKeyPressed(Y.Key.VK_2)){this.g.fire("playerFire",{array:1});return}if(e.isKeyPressed(Y.Key.VK_SPACE)){this.g.fire("playerBomb",void 0);return}}};var od=class{constructor(d,e,L){this.width=d;this.height=e;this.grid=[];for(let P=0;P<e;P++){let $=[];for(let D=0;D<d;D++)$.push(L(D,P));this.grid.push($)}}contains({x:d,y:e}){return d>=0&&d<this.width&&e>=0&&e<this.height}get({x:d,y:e}){return this.grid[e][d]}getPositions(){let d=[];for(let e=0;e<this.height;e++)for(let L=0;L<this.width;L++)d.push({x:L,y:e});return d}};var ya="./claw yr way back-WFUTJ3MJ.mp3";var _0;function da(){return _0||(_0=new Promise(a=>{let d=new Audio(ya);d.addEventListener("canplaythrough",()=>{d.play(),d.addEventListener("ended",()=>{d.currentTime=0,d.play()}),a(d)})})),_0}var lL={name:"Bodini",star:!0,body:4,mind:2,spirit:3,talent:2,class:[],special:"Multiball"},ZL={name:"Splintertooth",star:!0,body:3,mind:3,spirit:3,talent:2,class:[],special:"StubbornDescent"},sL={name:"Gruff",star:!0,body:2,mind:2,spirit:4,talent:3,class:[],special:"LaserBeam"},VL={name:"Limmhesto",star:!0,body:3,mind:3,spirit:3,talent:2,class:[],special:"Switchblades"},NL={name:"Ceegrave",star:!0,body:1,mind:4,spirit:3,talent:3,class:[],special:"Triangulate"},qL={name:"Sensoria",star:!0,body:4,mind:2,spirit:4,talent:1,class:[],special:"Overload"},kL=[lL,ZL,sL,VL,NL,qL],Ga=kL;var o=I(R()),yd=class{constructor(d,e,L){this.g=d;this.shipPrefab=e;this.pilot=L;this.dirty=!0}get currentSector(){return this.space.get(this.position)}refresh(){this.dirty=!0}init(){let{g:d}=this;d.clearEventHandlers(),d.entities.clear(),d.player=this.makePlayer(),this.difficulty=0,this.position=p(2,2),this.space=new od(5,5,()=>({completed:!1}));let e=new Set,L=this.space.getPositions().filter(P=>!w(this.position,P));for(;e.size<6;){let P=U(Ga);if(!e.has(P)){e.add(P);let $=U(L),D=this.space.get($);D.star=P;let i=L.indexOf($);L.splice(i,1)}}da(),this.startCombat()}startCombat(){this.g.setMode(new md(this.g,this))}endCombat(){this.g.clearEventHandlers(),this.currentSector.completed=!0,this.currentSector.star=void 0,this.difficulty++,this.g.mode=this,this.refresh()}makePlayer(){let{g:d,shipPrefab:e,pilot:L}=this,P=d.spawn(e);if(!P.ship)throw new Error(`Ship prefab ${e} doesn't have a ship component!`);return vd(d,P,L),xd(P.ship),P}draw(){let{term:d}=this.g;d.fillRect(0,0,d.width,d.height," ",o.Colors.WHITE,o.Colors.BLACK);let e=this.space.get(this.position),L=d.width/2;d.drawCenteredString(L,2,"Known Space",o.Colors.WHITE),e.completed||(d.drawCenteredString(L,4,"Hit Enter to fight!",o.Colors.WHITE),e.star&&d.drawCenteredString(L,34,`You will face: ${e.star.name}!`,o.Colors.YELLOW));let P=(d.width-25)/2,$=(d.height-25)/2;for(let D=0;D<5;D++){let i=$+D*5;for(let H=0;H<5;H++){let b=P+H*5,B={x:H,y:D},c=this.space.get(B);d.fillRect(b,i,5,5," ",void 0,c.completed?o.Colors.BLACK:o.Colors.DARK_RED),d.drawSingleBox(b,i,5,5,o.Colors.WHITE),w(B,this.position)?d.drawChar(b+2,i+2,"@",o.Colors.LIGHT_CYAN):c.star&&d.drawChar(b+2,i+2,"*",o.Colors.YELLOW)}}this.dirty=!1}handleKeys(){let d=this.space.get(this.position);!d.completed&&(this.g.term.isKeyPressed(o.Key.VK_ENTER)||this.g.term.isKeyPressed(o.Key.VK_NUMPAD_ENTER))&&this.startCombat();let e=this.g.term.getMovementKey();if(d.completed&&e){let L=K(this.position,e);this.space.contains(L)&&(this.position=L,this.dirty=!0)}}update(){this.handleKeys(),this.dirty&&this.draw()}};var S=I(R()),rd=class{constructor(d,e=5,L=100){this.g=d;this.starfieldSpeed=e;this.starCount=L}refresh(){this.dirty=!0}init(){this.dirty=!0,this.pilot={name:"Player",player:!0,body:1,mind:1,spirit:1,talent:1,class:[]},this.points=6,this.starfieldCounter=0,this.stars=[];for(let d=0;d<this.starCount;d++)this.stars.push(this.newStar())}draw(){let{term:d}=this.g;d.clear();for(let D of this.stars){let{x:i,y:H}=s(D);d.drawChar(i,H,D.c,D.fg)}let e=d.width/2;d.drawCenteredString(e,2,"CRAVESPACE",S.Colors.WHITE),d.drawCenteredString(e,9,"Create your Pilot",S.Colors.WHITE),d.drawCenteredString(e,10,`${this.points} points`,S.Colors.YELLOW);let L=2,P=Math.floor((d.width-L*2)/4),$=L+P/2;this.drawStat("body",$),this.drawStat("mind",$+P),this.drawStat("spirit",$+P*2),this.drawStat("talent",$+P*3),this.points===0&&d.drawCenteredString(e,20,"Hit Enter to begin!",S.Colors.WHITE),this.dirty=!1}drawStat(d,e){let{term:L}=this.g,P=`(${d[0].toUpperCase()})${d.slice(1)}`,$=this.pilot[d];L.drawCenteredString(e,13,P,S.Colors.LIGHT_CYAN),L.drawCenteredString(e,14,$.toString(),zd[$])}update(){this.handleStarfield(),this.handleKeys(),this.dirty&&this.draw()}newStar(){let{term:d}=this.g,e=U([S.Colors.DARK_RED,S.Colors.LIGHT_RED,S.Colors.YELLOW,S.Colors.LIGHT_CYAN,S.Colors.WHITE]),L=.5+Math.random(),P=L<.75?".":L<1.25?h.Dot:"*",$=Math.random()*Math.PI*2;return{x:d.width/2,y:d.height/2,c:P,fg:e,vel:L,angle:$}}handleStarfield(){if(this.starfieldCounter<this.starfieldSpeed){this.starfieldCounter++;return}this.starfieldCounter=0,this.dirty=!0;let{width:d,height:e}=this.g.term;for(let L of this.stars){let[P,$]=Hd(L);L.x+=P,L.y+=$,(L.x<0||L.x>=d||L.y<0||L.y>=e)&&Object.assign(L,this.newStar())}}isPressed(d,e){let L=this.g.term.isKeyDown(S.Key.VK_SHIFT_LEFT)||this.g.term.isKeyDown(S.Key.VK_SHIFT_RIGHT);return this.g.term.isKeyPressed(d)&&e===L}changeStat(d,e){let L=this.pilot[d]+e;if(L<1||L>4)return!1;this.points-=e,this.pilot[d]=L,this.dirty=!0}handleKeys(){this.points>0&&(this.isPressed(S.Key.VK_B,!1)&&this.changeStat("body",1),this.isPressed(S.Key.VK_M,!1)&&this.changeStat("mind",1),this.isPressed(S.Key.VK_S,!1)&&this.changeStat("spirit",1),this.isPressed(S.Key.VK_T,!1)&&this.changeStat("talent",1)),this.isPressed(S.Key.VK_B,!0)&&this.changeStat("body",-1),this.isPressed(S.Key.VK_M,!0)&&this.changeStat("mind",-1),this.isPressed(S.Key.VK_S,!0)&&this.changeStat("spirit",-1),this.isPressed(S.Key.VK_T,!0)&&this.changeStat("talent",-1),this.points===0&&(this.g.term.isKeyPressed(S.Key.VK_ENTER)||this.g.term.isKeyPressed(S.Key.VK_NUMPAD_ENTER))&&this.g.setMode(new yd(this.g,"PlayerShip",this.pilot))}};var i0=I(R()),Gd=class{constructor(d,e,L){this.term=d;this.mapWidth=e;this.mapHeight=L;d.update=this.update.bind(this),this.map=new i0.Console(e,L,()=>!0),this.lastEntityId=0,this.entities=new Ud(ba),this.overlays=new Map,this.clearEventHandlers(),this.setMode(new rd(this))}setMode(d){this.mode=d,this.mode.init()}clearEventHandlers(){this.eventCallbacks=Ba(ha.map(d=>[d,[]]))}fire(d,e){for(let L of this.eventCallbacks[d])L(e)}on(d,e){this.eventCallbacks[d].push(e)}spawn(d){return g0(this,d)}refresh(){this.mode.refresh()}add(d){return this.refresh(),this.entities.add(d),this.fire("spawn",{e:d}),d}kill(d,e){d.alive&&(d.kill(e),this.fire("kill",{e:d,reason:e}))}move(d,e){let L=d.position;d.move(e.x,e.y),L&&this.fire("move",{e:d,old:L,pos:e})}blankMap(){let{map:d,mapHeight:e,mapWidth:L}=this;d.clear();for(let P=0;P<e;P++)for(let $=0;$<L;$++)d.setBlocked($,P,!1),d.setBlockedSight($,P,!1);d.computeFov(0,0,1/0)}drawIfVisible(d,e,L,P,$,D){this.map.isVisible(d,e)&&(D?this.term.drawCell(d,e,{bg:$},D):this.term.drawChar(d,e,L,P,$))}blend(d,e,L){this.term.drawCell(d,e,{bg:L},i0.BlendMode.Add)}getRoot(d){return d.attachment?this.getRoot(d.attachment.parent):d}getContents(d,e=[]){let L=s(d);if(!this.inBounds(L))return{oob:!0,other:[]};let P=this.map.isBlocked(L.x,L.y),$=this.entities.get().filter(i=>i.position&&w(L,i.position)),D=$.filter(i=>!e.includes(i.id)).find(i=>i.solid);return{wall:P,solid:D,other:$.filter(i=>!i.solid)}}tick(){this.overlays.clear(),this.fire("tick",void 0),this.entities.clearDead()}update(){this.mode.update()}inBounds(d){return d.x>=0&&d.y>=0&&d.x<this.mapWidth&&d.y<this.mapHeight}getDistanceMap(d){let e=`${d.id}.distance`,L=this.overlays.get(e);return L||(L=A0(n(this,d).map(P=>P.position).filter(gd),this.inBounds.bind(this)),this.overlays.set(e,L)),L}};var H0=I(R());function gL(a){let L=H0.DEFAULT_FONT,P=document.createElement("div");a.appendChild(P);let $=()=>{let b=60*L.charWidth,B=40*L.charHeight,c=Math.floor(window.innerWidth/b),r=Math.floor(window.innerHeight/B),J=Math.min(c,r);P.style.width=`${b*J}px`,P.style.height=`${B*J}px`};window.addEventListener("resize",$),$();let D=document.createElement("canvas");P.appendChild(D),requestAnimationFrame(()=>D.focus());let i=new H0.Terminal(D,60,40,{font:L}),H=new Gd(i,60,40-hd);window.g=H}window.addEventListener("load",()=>gL(document.body));})();
//# sourceMappingURL=bundle.js.map
