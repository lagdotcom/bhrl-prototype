"use strict";(()=>{var Jt=Object.create;var gt=Object.defineProperty;var Ft=Object.getOwnPropertyDescriptor;var Kt=Object.getOwnPropertyNames;var zt=Object.getPrototypeOf,Gt=Object.prototype.hasOwnProperty;var f=(s,t)=>()=>(t||s((t={exports:{}}).exports,t),t.exports);var $t=(s,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Kt(t))!Gt.call(s,r)&&r!==e&&gt(s,r,{get:()=>t[r],enumerable:!(i=Ft(t,r))||i.enumerable});return s};var V=(s,t,e)=>(e=s!=null?Jt(zt(s)):{},$t(t||!s||!s.__esModule?gt(e,"default",{value:s,enumerable:!0}):e,s));var O=f((Je,vt)=>{vt.exports=globalThis.wglt});var At=f((Ge,_t)=>{_t.exports=globalThis.RBush});var q=f(($e,Bt)=>{Bt.exports=globalThis.SAT});var B=f(m=>{"use strict";var Qt=m&&m.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(m,"__esModule",{value:!0});m.Types=m.SATPolygon=m.SATVector=m.Response=m.RBush=void 0;var Ut=Qt(At());Object.defineProperty(m,"RBush",{enumerable:!0,get:function(){return Ut.default}});var et=q();Object.defineProperty(m,"Response",{enumerable:!0,get:function(){return et.Response}});Object.defineProperty(m,"SATVector",{enumerable:!0,get:function(){return et.Vector}});Object.defineProperty(m,"SATPolygon",{enumerable:!0,get:function(){return et.Polygon}});var Zt;(function(s){s.Ellipse="Ellipse",s.Line="Line",s.Circle="Circle",s.Box="Box",s.Point="Point",s.Polygon="Polygon"})(Zt=m.Types||(m.Types={}))});var b=f(h=>{"use strict";Object.defineProperty(h,"__esModule",{value:!0});h.generateId=h.toJSON=h.drawPolygon=h.getSATFunction=h.getBounceDirection=h.ensureConvex=h.mapArrayToVector=h.mapVectorToArray=h.intersectLinePolygon=h.intersectLineLine=h.intersectLineCircle=h.dashLineTo=h.clonePointsArray=h.checkAInB=h.intersectAABB=h.bodyMoved=h.extendBody=h.clockwise=h.distance=h.ensurePolygonPoints=h.ensureVectorPoint=h.createBox=h.createEllipse=void 0;var x=q(),W=B();function te(s,t=s,e=1){let i=Math.PI*Math.hypot(s,t)*2,r=Math.max(8,Math.ceil(i/Math.max(1,e)));return Array.from({length:r},(n,c)=>{let o=c/r*2*Math.PI,a=Math.cos(o)*s,l=Math.sin(o)*t;return new x.Vector(a,l)})}h.createEllipse=te;function ee(s,t){return[new x.Vector(0,0),new x.Vector(s,0),new x.Vector(s,t),new x.Vector(0,t)]}h.createBox=ee;function wt(s={}){return s instanceof x.Vector?s:new x.Vector(s.x||0,s.y||0)}h.ensureVectorPoint=wt;function se(s){if(!s)throw new Error("No points array provided");let t=s.map(wt);return bt(t)?t.reverse():t}h.ensurePolygonPoints=se;function ie(s,t){return Math.hypot(s.x-t.x,s.y-t.y)}h.distance=ie;function bt(s){let t=0;for(let e=0;e<s.length;e++){let i=s[e],r=s[(e+1)%s.length];t+=(r.x-i.x)*(r.y+i.y)}return t>0}h.clockwise=bt;function re(s,t){s.isStatic=!!t?.isStatic,s.isTrigger=!!t?.isTrigger,s.padding=t?.padding||0,t?.center&&s.center(),s.setAngle(t?.angle||0)}h.extendBody=re;function ne(s){return s.bbox.minX<s.minX||s.bbox.minY<s.minY||s.bbox.maxX>s.maxX||s.bbox.maxY>s.maxY}h.bodyMoved=ne;function oe(s,t){return!(t.minX>s.maxX||t.minY>s.maxY||t.maxX<s.minX||t.maxY<s.minY)}h.intersectAABB=oe;function ce(s,t){let e=s.minX>=t.minX&&s.maxX<=t.maxX,i=s.minY>=t.minY&&s.maxY<=t.maxY;return e&&i}h.checkAInB=ce;function ae(s){return s.map(({x:t,y:e})=>({x:t,y:e}))}h.clonePointsArray=ae;function Ct(s,t,e,i,r,n=2,c=4){let o=i-t,a=r-e,l=Math.atan2(a,o),u=Math.cos(l),d=Math.sin(l),_=t,E=e,A=Math.hypot(o,a);for(;A>0;){let R=Math.min(A,n);s.moveTo(_,E),s.lineTo(_+u*R,E+d*R),_+=u*(n+c),E+=d*(n+c),A-=n+c}}h.dashLineTo=Ct;function he(s,t){let e={x:s.end.x-s.start.x,y:s.end.y-s.start.y},i={x:s.start.x-t.pos.x,y:s.start.y-t.pos.y},r=(e.x*i.x+e.y*i.y)*-2,n=(e.x*e.x+e.y*e.y)*2,c=Math.sqrt(r*r-(i.x*i.x+i.y*i.y-t.r*t.r)*n*2);if(isNaN(c))return[];let o=(r-c)/n,a=(r+c)/n,l=[];return o<=1&&o>=0&&l.push({x:s.start.x+e.x*o,y:s.start.y+e.y*o}),a<=1&&a>=0&&l.push({x:s.start.x+e.x*a,y:s.start.y+e.y*a}),l}h.intersectLineCircle=he;function Tt(s,t){let e=s.end.x-s.start.x,i=s.end.y-s.start.y,r=e*(t.end.y-t.start.y)-(t.end.x-t.start.x)*i;if(r===0)return null;let n=((t.end.y-t.start.y)*(t.end.x-s.start.x)+(t.start.x-t.end.x)*(t.end.y-s.start.y))/r,c=((s.start.y-s.end.y)*(t.end.x-s.start.x)+e*(t.end.y-s.start.y))/r;return!(n>=0&&n<=1)||!(c>=0&&c<=1)?null:{x:s.start.x+n*e,y:s.start.y+n*i}}h.intersectLineLine=Tt;function le(s,t){return t.calcPoints.map((e,i)=>{let r=i?t.calcPoints[i-1]:t.calcPoints[t.calcPoints.length-1],n={start:{x:r.x+t.pos.x,y:r.y+t.pos.y},end:{x:e.x+t.pos.x,y:e.y+t.pos.y}};return Tt(s,n)}).filter(e=>!!e)}h.intersectLinePolygon=le;function ue({x:s,y:t}){return[s,t]}h.mapVectorToArray=ue;function pe([s,t]){return{x:s,y:t}}h.mapArrayToVector=pe;function fe(s){return s.isConvex||s.type!==W.Types.Polygon?[s]:s.convexPolygons}h.ensureConvex=fe;function me(s,t){let e=new x.Vector(t.x-s.x,t.y-s.y),i=new x.Vector(s.x-t.x,s.y-t.y),r=i.dot(e.normalize())*2;return new x.Vector(e.x*r-i.x,e.y*r-i.y).normalize()}h.getBounceDirection=me;function ye(s,t){return s.type===W.Types.Circle?t.type===W.Types.Circle?x.testCircleCircle:x.testCirclePolygon:t.type===W.Types.Circle?x.testPolygonCircle:x.testPolygonPolygon}h.getSATFunction=ye;function de(s,{pos:t,calcPoints:e},i=!1){[...e,e[0]].forEach((n,c)=>{let o=t.x+n.x,a=t.y+n.y,l=e[c-1]||e[e.length-1];if(!c)e.length===1?s.arc(o,a,1,0,Math.PI*2):s.moveTo(o,a);else if(e.length>1)if(i){let u=t.x+l.x,d=t.y+l.y;Ct(s,u,d,o,a)}else s.lineTo(o,a)})}h.drawPolygon=de;function xe(s){return Object.entries(s).reduce((t,[e,i])=>e!=="system"?Object.assign(Object.assign({},t),{[e]:i}):t,{})}h.toJSON=xe;var ge=0;function ve(){return(++ge).toString(36)}h.generateId=ve});var it=f(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});H.Circle=void 0;var Pe=q(),_e=B(),X=b(),st=class extends Pe.Circle{constructor(t,e,i){super((0,X.ensureVectorPoint)(t),e),this.offsetCopy={x:0,y:0},this.padding=0,this.angle=0,this.isConvex=!0,this.isCentered=!0,this.type=_e.Types.Circle,(0,X.extendBody)(this,i),this.radiusBackup=e,this.uid=(0,X.generateId)()}get x(){return this.pos.x}set x(t){var e;this.pos.x=t,(e=this.system)===null||e===void 0||e.insert(this)}get y(){return this.pos.y}set y(t){var e;this.pos.y=t,(e=this.system)===null||e===void 0||e.insert(this)}get scale(){return this.r/this.radiusBackup}set scale(t){this.setScale(t)}get scaleX(){return this.scale}get scaleY(){return this.scale}setPosition(t,e){var i;this.pos.x=t,this.pos.y=e,(i=this.system)===null||i===void 0||i.insert(this)}setScale(t,e){this.r=this.radiusBackup*t}setAngle(t){this.angle=t;let{x:e,y:i}=this.getOffsetWithAngle();return this.offset.x=e,this.offset.y=i,this}setOffset(t){this.offsetCopy.x=t.x,this.offsetCopy.y=t.y;let{x:e,y:i}=this.getOffsetWithAngle();return this.offset.x=e,this.offset.y=i,this}getAABBAsBBox(){let t=this.pos.x+this.offset.x,e=this.pos.y+this.offset.y;return{minX:t-this.r,maxX:t+this.r,minY:e-this.r,maxY:e+this.r}}draw(t){let e=this.pos.x+this.offset.x,i=this.pos.y+this.offset.y;if(this.isTrigger){let r=Math.max(8,this.r);for(let n=0;n<r;n++){let c=n/r*2*Math.PI,o=(n-1)/r*2*Math.PI,a=e+Math.cos(o)*this.r,l=i+Math.sin(o)*this.r,u=e+Math.cos(c)*this.r,d=i+Math.sin(c)*this.r;(0,X.dashLineTo)(t,a,l,u,d)}}else t.moveTo(e+this.r,i),t.arc(e,i,this.r,0,Math.PI*2)}center(){}toJSON(){return(0,X.toJSON)(this)}getOffsetWithAngle(){if(!this.angle)return this.offsetCopy;let t=Math.sin(this.angle),e=Math.cos(this.angle),i=this.offsetCopy.x*e-this.offsetCopy.y*t,r=this.offsetCopy.x*t+this.offsetCopy.y*e;return{x:i,y:r}}};H.Circle=st});var Mt=f((ts,Et)=>{Et.exports=globalThis.decomp});var Y=f(N=>{"use strict";Object.defineProperty(N,"__esModule",{value:!0});N.Polygon=void 0;var Ae=Mt(),St=q(),It=B(),v=b(),rt=class extends St.Polygon{constructor(t,e,i){if(super((0,v.ensureVectorPoint)(t),(0,v.ensurePolygonPoints)(e)),this.padding=0,this.type=It.Types.Polygon,this.scaleVector={x:1,y:1},!e?.length)throw new Error("No points in polygon");(0,v.extendBody)(this,i),this.uid=(0,v.generateId)()}get x(){return this.pos.x}set x(t){var e;this.pos.x=t,this.updateConvexPolygonPositions(),(e=this.system)===null||e===void 0||e.insert(this)}get y(){return this.pos.y}set y(t){var e;this.pos.y=t,this.updateConvexPolygonPositions(),(e=this.system)===null||e===void 0||e.insert(this)}get scaleX(){return this.scaleVector.x}get scaleY(){return this.scaleVector.y}get scale(){return this.scaleVector.x}set scale(t){this.setScale(t)}setPosition(t,e){var i;this.pos.x=t,this.pos.y=e,this.updateConvexPolygonPositions(),(i=this.system)===null||i===void 0||i.insert(this)}setScale(t,e=t){this.scaleVector.x=t,this.scaleVector.y=e,this.points.forEach((i,r)=>{i.x=this.pointsBackup[r].x*t,i.y=this.pointsBackup[r].y*e}),super.setPoints(this.points)}getAABBAsBBox(){let{pos:t,w:e,h:i}=this.getAABBAsBox();return{minX:t.x,minY:t.y,maxX:t.x+e,maxY:t.y+i}}draw(t){(0,v.drawPolygon)(t,this,this.isTrigger)}getCentroidWithoutRotation(){let t=this.angle;this.setAngle(0);let e=this.getCentroid();return this.setAngle(t),e}setPoints(t){return super.setPoints(t),this.updateIsConvex(),this.pointsBackup=(0,v.clonePointsArray)(t),this}translate(t,e){return super.translate(t,e),this.pointsBackup=(0,v.clonePointsArray)(this.points),this}rotate(t){return super.rotate(t),this.pointsBackup=(0,v.clonePointsArray)(this.points),this}center(){if(this.isCentered)return;let{x:t,y:e}=this.getCentroidWithoutRotation();this.translate(-t,-e),this.pos.x+=t,this.pos.y+=e,this.isCentered=!0}toJSON(){return(0,v.toJSON)(this)}updateConvexPolygonPositions(){var t;(t=this.convexPolygons)===null||t===void 0||t.forEach(e=>{e.pos.x=this.pos.x,e.pos.y=this.pos.y})}getConvex(){return this.type&&this.type!==It.Types.Polygon||this.points.length<=3?[]:(0,Ae.quickDecomp)(this.calcPoints.map(v.mapVectorToArray))}updateConvexPolygons(t=this.getConvex()){this.isConvex||(this.convexPolygons||(this.convexPolygons=[]),t.forEach((e,i)=>{this.convexPolygons[i]||(this.convexPolygons[i]=new St.Polygon),this.convexPolygons[i].pos.x=this.pos.x,this.convexPolygons[i].pos.y=this.pos.y,this.convexPolygons[i].setPoints((0,v.ensurePolygonPoints)(e.map(v.mapArrayToVector)))}),this.convexPolygons.length=t.length)}updateIsConvex(){let t=this.getConvex();this.isConvex=t.length<=1,this.updateConvexPolygons(t)}};N.Polygon=rt});var ot=f(J=>{"use strict";Object.defineProperty(J,"__esModule",{value:!0});J.Ellipse=void 0;var Be=B(),D=b(),we=Y(),nt=class extends we.Polygon{constructor(t,e,i=e,r=(e+i)/Math.PI,n){super(t,(0,D.createEllipse)(e,i,r),n),this.type=Be.Types.Ellipse,this.isCentered=!0,this.isConvex=!0,this._radiusX=e,this._radiusY=i,this._step=r}get step(){return this._step}set step(t){this._step=t,this.setPoints((0,D.createEllipse)(this._radiusX,this._radiusY,this._step))}get radiusX(){return this._radiusX}set radiusX(t){this._radiusX=t,this.setPoints((0,D.createEllipse)(this._radiusX,this._radiusY,this._step))}get radiusY(){return this._radiusY}set radiusY(t){this._radiusY=t,this.setPoints((0,D.createEllipse)(this._radiusX,this._radiusY,this._step))}center(){}updateIsConvex(){}};J.Ellipse=nt});var K=f(F=>{"use strict";Object.defineProperty(F,"__esModule",{value:!0});F.Box=void 0;var be=B(),ct=b(),Ce=Y(),at=class extends Ce.Polygon{constructor(t,e,i,r){super(t,(0,ct.createBox)(e,i),r),this.type=be.Types.Box,this.isConvex=!0,this._width=e,this._height=i}get width(){return this._width}set width(t){this._width=t,this.setPoints((0,ct.createBox)(this._width,this._height))}get height(){return this._height}set height(t){this._height=t,this.setPoints((0,ct.createBox)(this._width,this._height))}updateIsConvex(){}};F.Box=at});var lt=f(z=>{"use strict";Object.defineProperty(z,"__esModule",{value:!0});z.Point=void 0;var Te=B(),Ee=b(),Me=K(),ht=class extends Me.Box{constructor(t,e){super((0,Ee.ensureVectorPoint)(t),.001,.001,e),this.type=Te.Types.Point}};z.Point=ht});var $=f(G=>{"use strict";Object.defineProperty(G,"__esModule",{value:!0});G.Line=void 0;var Se=q(),Ie=B(),Ve=Y(),ut=class extends Ve.Polygon{constructor(t,e,i){if(super(t,[{x:0,y:0},{x:e.x-t.x,y:e.y-t.y}],i),this.type=Ie.Types.Line,this.isConvex=!0,this.calcPoints.length===1||!e)throw console.error({start:t,end:e}),new Error("No end point for line provided")}get start(){return{x:this.x+this.calcPoints[0].x,y:this.y+this.calcPoints[0].y}}set start({x:t,y:e}){this.x=t,this.y=e}get end(){return{x:this.x+this.calcPoints[1].x,y:this.y+this.calcPoints[1].y}}set end({x:t,y:e}){this.points[1].x=t-this.start.x,this.points[1].y=e-this.start.y,this.setPoints(this.points)}getCentroid(){return new Se.Vector((this.end.x-this.start.x)/2,(this.end.y-this.start.y)/2)}updateIsConvex(){}};G.Line=ut});var Ot=f(Q=>{"use strict";Object.defineProperty(Q,"__esModule",{value:!0});Q.BaseSystem=void 0;var Oe=K(),qe=it(),Ye=ot(),Le=$(),Xe=lt(),je=Y(),ke=B(),Vt=b(),pt=class extends ke.RBush{draw(t){this.all().forEach(e=>{e.draw(t)})}drawBVH(t){let e=({minX:i,maxX:r,minY:n,maxY:c,children:o})=>{(0,Vt.drawPolygon)(t,{pos:{x:i,y:n},calcPoints:(0,Vt.createBox)(r-i,c-n)}),o?.forEach(e)};this.data.children.forEach(e)}createPoint(t,e){let i=new Xe.Point(t,e);return this.insert(i),i}createLine(t,e,i){let r=new Le.Line(t,e,i);return this.insert(r),r}createCircle(t,e,i){let r=new qe.Circle(t,e,i);return this.insert(r),r}createBox(t,e,i,r){let n=new Oe.Box(t,e,i,r);return this.insert(n),n}createEllipse(t,e,i=e,r,n){let c=new Ye.Ellipse(t,e,i,r,n);return this.insert(c),c}createPolygon(t,e,i){let r=new je.Polygon(t,e,i);return this.insert(r),r}};Q.BaseSystem=pt});var qt=f(Z=>{"use strict";Object.defineProperty(Z,"__esModule",{value:!0});Z.System=void 0;var Re=Ot(),We=$(),U=B(),P=b(),ft=class extends Re.BaseSystem{constructor(){super(...arguments),this.response=new U.Response,this.bodies={},this.state={collides:!1,aInB:!1,bInA:!1,overlapV:new U.SATVector}}remove(t,e){return t.system&&delete t.system.bodies[t.uid],t.system=void 0,super.remove(t,e)}insert(t){return t.bbox=t.getAABBAsBBox(),t.system&&!(0,P.bodyMoved)(t)?this:(t.system&&t.system.remove(t),t.minX=t.bbox.minX-t.padding,t.minY=t.bbox.minY-t.padding,t.maxX=t.bbox.maxX+t.padding,t.maxY=t.bbox.maxY+t.padding,t.system=this,this.bodies[t.uid]=t,super.insert(t))}updateBody(t){this.insert(t)}update(){this.all().forEach(t=>{t.isStatic||this.insert(t)})}separate(){this.checkAll(({a:t,overlapV:e})=>{if(t.isTrigger)return!1;t.setPosition(t.x-e.x,t.y-e.y)})}checkOne(t,e){return t.isStatic?!1:this.search(t).some(i=>{if(i!==t&&this.checkCollision(t,i))return e(this.response)})}checkAll(t){return this.all().some(e=>this.checkOne(e,t))}getPotentials(t){return this.search(t).filter(e=>e!==t)}checkCollision(t,e){if(t.bbox&&e.bbox&&!(0,P.intersectAABB)(t.bbox,e.bbox))return!1;let i=(0,P.getSATFunction)(t,e);if(this.state.collides=!1,this.response.clear(),t.isConvex&&e.isConvex)this.state.collides=i(t,e,this.response);else if(t.isConvex&&!e.isConvex)(0,P.ensureConvex)(e).forEach(r=>{this.test(i,t,r)});else if(!t.isConvex&&e.isConvex)(0,P.ensureConvex)(t).forEach(r=>{this.test(i,r,e)});else{let r=(0,P.ensureConvex)(t),n=(0,P.ensureConvex)(e);r.forEach(c=>{n.forEach(o=>{this.test(i,c,o)})})}return(!t.isConvex||!e.isConvex)&&(this.response.a=t,this.response.b=e,this.state.collides&&(this.response.overlapV=this.state.overlapV,this.response.overlapN=this.response.overlapV.clone().normalize(),this.response.overlap=this.response.overlapV.len()),this.response.aInB=t.isConvex?this.state.aInB:(0,P.checkAInB)(t,e),this.response.bInA=e.isConvex?this.state.bInA:(0,P.checkAInB)(e,t)),this.state.collides}raycast(t,e,i=()=>!0){let r=1/0,n=null;return this.ray?(this.ray.start=t,this.ray.end=e):this.ray=new We.Line(t,e,{isTrigger:!0}),this.insert(this.ray),this.checkOne(this.ray,({b:c})=>{if(!i(c))return!1;(c.type===U.Types.Circle?(0,P.intersectLineCircle)(this.ray,c):(0,P.intersectLinePolygon)(this.ray,c)).forEach(a=>{let l=(0,P.distance)(t,a);l<r&&(r=l,n={point:a,collider:c})})}),this.remove(this.ray),n}clear(){return super.clear(),this.bodies={},this}traverse(t,{children:e}=this.data){return e?.find((i,r)=>{if(!i)return!1;if(i.type&&t(i,e,r))return!0;i.children&&this.traverse(t,i)})}fromJSON(t){return this.traverse((e,i,r)=>{this.bodies[e.uid]&&(this.bodies[e.uid]=i[r]=Object.assign(this.bodies[e.uid],e))},t),super.fromJSON(t),this}test(t,e,i){let r=t(e,i,this.response);r&&(this.state.collides||(this.state.aInB=!1,this.state.bInA=!1,this.state.overlapV=new U.SATVector),this.state.overlapV.add(this.response.overlapV)),this.state.aInB=this.state.aInB||this.response.aInB,this.state.bInA=this.state.bInA||this.response.bInA,this.state.collides=r||this.state.collides,this.response.clear()}};Z.System=ft});var Yt=f(y=>{"use strict";var He=y&&y.__createBinding||(Object.create?function(s,t,e,i){i===void 0&&(i=e);var r=Object.getOwnPropertyDescriptor(t,e);(!r||("get"in r?!t.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return t[e]}}),Object.defineProperty(s,i,r)}:function(s,t,e,i){i===void 0&&(i=e),s[i]=t[e]}),C=y&&y.__exportStar||function(s,t){for(var e in s)e!=="default"&&!Object.prototype.hasOwnProperty.call(t,e)&&He(t,s,e)};Object.defineProperty(y,"__esModule",{value:!0});C(B(),y);C(it(),y);C(ot(),y);C(Y(),y);C(K(),y);C(lt(),y);C($(),y);C(qt(),y);C(b(),y)});var M=V(O());var S=class{constructor(t,e){this.x=t;this.y=e}};var p=class{constructor(t,e){this.g=t;this.name=e;this.alive=!0,this.id=++t.lastEntityId,this.Player=!1,this.Projectile=!1,this.Solid=!1}get[Symbol.toStringTag](){return this.name}kill(){return this.alive=!1,this}eachChild(t){var e;for(let i of this.g.entities.get())((e=i.Attachment)==null?void 0:e.parent)===this&&t(i,i.Attachment)}setAppearance(t){return this.Appearance=t,this}setAttachment(t){return this.Attachment=t,this}setMotion(t){return this.Motion=t,this}setPosition(t){return this.Position=t,this}setTurret(t){return this.Turret=t,this}setPlayer(t){return this.Player=t,this}setProjectile(t){return this.Projectile=t,this}setSolid(t){return this.Solid=t,this}move(t,e){return this.Position=new S(t,e),this.eachChild((i,r)=>i.move(t+r.x,e+r.y)),this.Position}};function Pt(s,t){var r,n,c,o;let e=(n=(r=s.Appearance)==null?void 0:r.layer)!=null?n:0,i=(o=(c=t.Appearance)==null?void 0:c.layer)!=null?o:0;return e-i}var Wt=V(Yt());var I=class{constructor(t,e){this.x=t;this.y=e}static fromAngleAndVelocity(t,e){return new I(Math.cos(t)*e,Math.sin(t)*e)}};var j=class{constructor(t,e=[]){this.compareFn=t;this.items=e;this.dirty=!0}clear(){this.items=[],this.dirty=!1}add(t){this.items.push(t),this.dirty=!0}delete(t){this.items=this.items.filter(e=>e!==t)}sort(){this.items.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.items}};var g=class{constructor(t,e,i,r){this.glyph=t;this.layer=e;this.fg=i;this.bg=r}};var T=class{constructor(t,e,i){this.parent=t;this.x=e;this.y=i}};var w=V(O());var L=class{constructor(t,e,i,r,n="idle",c=0,o=0){this.bulletVelocity=t;this.salvoCount=e;this.timeBetweenShots=i;this.timeBetweenSalvos=r;this.mode=n;this.timer=c;this.salvo=o}};function Lt(s){switch(s.mode){case"idle":s.mode="fire",s.salvo=s.salvoCount-1,s.timer=s.timeBetweenShots;break;case"fire":s.timer--,s.salvo>0?s.timer<=0&&(s.mode="mid-salvo"):s.mode="reloading";break;case"mid-salvo":s.mode="fire",s.salvo--,s.salvo>0?s.timer=s.timeBetweenShots:s.timer=s.timeBetweenSalvos;break;case"reloading":s.timer--,s.timer<=0&&(s.mode="idle");break}return s}function mt(s){let t=new p(s,"Battleship"),e=[new p(s,"BattleshipHull").setAttachment(new T(t,1,0)).setAppearance(new g("/",0,w.Colors.WHITE,w.Colors.BROWN)).setSolid(!0),new p(s,"BattleshipHull").setAttachment(new T(t,2,0)).setAppearance(new g("#",0,w.Colors.WHITE,w.Colors.BROWN)).setSolid(!0),new p(s,"BattleshipTurret").setAttachment(new T(t,0,1)).setAppearance(new g("o",0,w.Colors.WHITE,w.Colors.BROWN)).setTurret(new L(3,2,1,5)).setSolid(!0),new p(s,"BattleshipHull").setAttachment(new T(t,1,1)).setAppearance(new g("#",0,w.Colors.WHITE,w.Colors.BROWN)).setSolid(!0),new p(s,"BattleshipTurret").setAttachment(new T(t,2,1)).setAppearance(new g("o",0,w.Colors.WHITE,w.Colors.BROWN)).setTurret(new L(2,5,0,12)).setSolid(!0)];return{ship:t,parts:e}}var jt=V(O());function yt(s){return new p(s,"Bullet").setProjectile(!0).setAppearance(new g(".",1,jt.Colors.YELLOW))}var dt=V(O());function xt(s){return new p(s,"Player").setPlayer(!0).setAppearance(new g(">",2,dt.Colors.WHITE,dt.Colors.DARK_RED))}function tt(s){return Math.floor(s)}var kt=60,Rt=40,k=class{constructor(t){this.term=t;t.update=this.update.bind(this),this.fovRecompute=!0,this.map=new M.Console(kt,Rt,()=>!0),this.lastEntityId=0,this.entities=new j(Pt)}add(t){this.entities.add(t),t.Player&&(this.player=t)}addMany(t){for(let e of t)this.add(e)}gotoDemoRoom(){this.entities.clear(),this.map.clear(),this.room(1,1,40,30),this.add(xt(this).setPosition(new S(5,25)));let{ship:t,parts:e}=mt(this);this.add(t),this.addMany(e),t.move(8,5)}room(t,e,i,r){let{map:n}=this;for(let c=0;c<r;c++)for(let o=0;o<i;o++){let a=o===0||c===0||o===i-1||c===r-1,l=t+o,u=e+c;n.setBlocked(l,u,a),n.setBlockedSight(l,u,a)}}draw(){let{map:t,player:e,term:i,entities:r}=this;this.fovRecompute&&(t.computeFov(e.Position.x,e.Position.y,20),this.fovRecompute=!1);for(let c=0;c<Rt;c++)for(let o=0;o<kt;o++){let a=t.grid[c][o],l=t.isVisible(o,c),u=a.blockedSight,d=M.Colors.BLACK;l?(d=u?M.Colors.WHITE:M.Colors.DARK_GRAY,a.explored=!0):a.explored&&(d=u?M.Colors.LIGHT_GRAY:M.Colors.BLACK),i.drawChar(o,c,0,0,d)}let n=(c,o,a,l,u)=>{t.isVisible(c,o)&&i.drawChar(c,o,a,l,u)};for(let c of r.get()){let{Appearance:o,Position:a}=c;o&&a&&n(tt(a.x),tt(a.y),o.glyph,o.fg,o.bg)}}turrets(){let{entities:t}=this,e=this.player.Position;for(let i of t.get()){let{Position:r,Turret:n}=i;if(r&&n&&(Lt(n),n.mode==="fire")){let c=yt(this).setPosition({x:r.x+.5,y:r.y+.5}).setMotion(I.fromAngleAndVelocity(Math.atan2(e.y-r.y,e.x-r.x),n.bulletVelocity));t.add(c)}}}motion(){let{entities:t,map:e,player:i}=this,r=new Wt.System,n=new Map;for(let o=0;o<e.height;o++)for(let a=0;a<e.width;a++)if(e.isBlocked(a,o)){let l=r.createBox({x:a,y:o},1,1,{isStatic:!0});n.set(l.uid,{type:"wall"})}for(let o of t.get()){let{Solid:a,Motion:l,Position:u,Projectile:d}=o;if(u){let{x:_,y:E}=u;if(a){let A=r.createBox({x:_,y:E},1,1);n.set(A.uid,{type:"ship",e:o})}else if(d&&l){let A={x:_+l.x,y:E+l.y},R=r.createBox({x:_-.25,y:E-.25},.5,.5);n.set(R.uid,{type:"bullet",e:o});let Nt=r.createBox({x:A.x-.5,y:A.y-.25},.5,.5);n.set(Nt.uid,{type:"bullet",e:o});let Dt=r.createLine({x:_,y:E},A);n.set(Dt.uid,{type:"bullet",e:o}),o.move(A.x,A.y)}}}let c=r.createBox(i.Position,1,1);n.set(c.uid,{type:"player"}),r.update(),r.checkAll(o=>{let a=n.get(o.a.uid),l=n.get(o.b.uid);if(!(!a||!l)){if(a.type==="wall"){l instanceof p&&l.Projectile&&t.delete(l);return}if(l.type==="wall"){a instanceof p&&a.Projectile&&t.delete(a);return}a.type==="player"&&l.type==="bullet"&&l.e.alive?(l.e.kill(),t.delete(l.e)):l.type==="player"&&a.type==="bullet"&&a.e.alive&&(a.e.kill(),t.delete(a.e))}})}tick(){this.turrets(),this.motion()}handleKeys(){let{map:t,player:e,term:i}=this,r=i.getMovementKey();if(r){let n=e.Position.x+r.x,c=e.Position.y+r.y;t.isBlocked(n,c)||(e.move(n,c),this.fovRecompute=!0,this.tick())}}update(){this.handleKeys(),this.draw()}};var Ht=V(O());function Ne(s){let i=document.createElement("div");s.appendChild(i);let r=()=>{let u=Math.floor(window.innerWidth/480),d=Math.floor(window.innerHeight/320),_=Math.min(u,d);i.style.width=`${480*_}px`,i.style.height=`${320*_}px`};window.addEventListener("resize",r),r();let n=document.createElement("canvas");i.appendChild(n);let c=new Ht.Terminal(n,60,40),o=new k(c);o.gotoDemoRoom(),window.g=o}window.addEventListener("load",()=>Ne(document.body));})();
//# sourceMappingURL=bundle.js.map
