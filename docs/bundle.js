"use strict";(()=>{var bt=Object.create;var B=Object.defineProperty;var xt=Object.getOwnPropertyDescriptor;var gt=Object.getOwnPropertyNames,rt=Object.getOwnPropertySymbols,wt=Object.getPrototypeOf,at=Object.prototype.hasOwnProperty,vt=Object.prototype.propertyIsEnumerable;var st=(e,t,i)=>t in e?B(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,y=(e,t)=>{for(var i in t||={})at.call(t,i)&&st(e,i,t[i]);if(rt)for(var i of rt(t))vt.call(t,i)&&st(e,i,t[i]);return e};var Mt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),M=(e,t)=>{for(var i in t)B(e,i,{get:t[i],enumerable:!0})},Pt=(e,t,i,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of gt(t))!at.call(e,s)&&s!==i&&B(e,s,{get:()=>t[s],enumerable:!(o=xt(t,s))||o.enumerable});return e};var b=(e,t,i)=>(i=e!=null?bt(wt(e)):{},Pt(t||!e||!e.__esModule?B(i,"default",{value:e,enumerable:!0}):i,e));var E=Mt((qt,lt)=>{lt.exports=globalThis.wglt});var x=b(E());var m=class{constructor(t,i){this.g=t;this.name=i;this.alive=!0,this.id=++t.lastEntityId,this.player=!1,this.projectile=!1,this.solid=!1}get[Symbol.toStringTag](){return this.name}kill(){return this.alive=!1,this.eachChild(t=>this.g.delete(t)),this}eachChild(t){var i;for(let o of this.g.entities.get())((i=o.attachment)==null?void 0:i.parent)===this&&t(o,o.attachment)}setAppearance(t){return this.g.dirty=!0,this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setPosition(t){return this.g.dirty=!0,this.position=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,i){return this.g.dirty=!0,this.position={x:t,y:i},this.eachChild((o,s)=>o.move(t+s.x,i+s.y)),this.position}};function mt(e,t){var s,n,r,a;let i=(n=(s=e.appearance)==null?void 0:s.layer)!=null?n:0,o=(a=(r=t.appearance)==null?void 0:r.layer)!=null?a:0;return i!==o?i-o:e.id-t.id}var L={};M(L,{Battleship:()=>At,BattleshipHull:()=>Tt});var G=b(E());var pt=(n=>(n[n.Effect=0]="Effect",n[n.Ship=1]="Ship",n[n.Gun=2]="Gun",n[n.Bullet=3]="Bullet",n[n.Player=4]="Player",n))(pt||{}),u=pt;function At(e){let t=new m(e,"Battleship");return e.spawn("BattleshipHull").setAttachment({parent:t,x:1,y:0}),e.spawn("BattleshipHull").setAttachment({parent:t,x:2,y:0}),e.spawn("BattleshipHull").setAttachment({parent:t,x:0,y:1}),e.spawn("BattleshipHull").setAttachment({parent:t,x:1,y:1}),e.spawn("BattleshipHull").setAttachment({parent:t,x:2,y:1}),e.spawn("MachineGun").setAttachment({parent:t,x:0,y:1}),e.spawn("HomingMissileLauncher").setAttachment({parent:t,x:2,y:1}),t}function Tt(e){return new m(e,"BattleshipHull").setAppearance({glyph:"/",layer:u.Ship,fg:G.Colors.WHITE,bg:G.Colors.BROWN}).setSolid(!0)}var W={};M(W,{Bullet:()=>kt,HomingMissile:()=>Ct});var D=b(E());function kt(e){return new m(e,"Bullet").setProjectile(!0).setAppearance({glyph:".",layer:u.Bullet,fg:D.Colors.YELLOW})}function Ct(e){return new m(e,"HomingMissile").setProjectile(!0).setHoming({strength:.15,duration:10}).setTrail({effectPrefab:"SmokePuff"}).setExplodes({size:5,falloff:1}).setAppearance({glyph:"*",layer:u.Bullet,fg:D.Colors.DARK_RED})}var N={};M(N,{SmokePuff:()=>Ht});var R=b(E());function Ht(e){return new m(e,"SmokePuff").setAppearance({glyph:" ",layer:u.Effect,bg:(0,R.fromRgb)(100,100,100,50),blendMode:R.BlendMode.Add}).setLifetime({duration:2})}var K={};M(K,{HomingMissileLauncher:()=>Rt,MachineGun:()=>Bt});var q=b(E());function Bt(e){return new m(e,"MachineGun").setAppearance({glyph:"o",layer:u.Gun,fg:q.Colors.WHITE}).setTurret({bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:5,timeBetweenShots:0,timeBetweenSalvos:12})}function Rt(e){return new m(e,"HomingMissileLauncher").setAppearance({glyph:"o",layer:u.Gun,fg:q.Colors.YELLOW}).setTurret({bulletPrefab:"HomingMissile",bulletVelocity:1,salvoCount:1,timeBetweenShots:8,timeBetweenSalvos:8})}var Y={};M(Y,{Player:()=>St});var Q=b(E());function St(e){return new m(e,"Player").setPlayer(!0).setSolid(!0).setAppearance({glyph:">",layer:u.Player,fg:Q.Colors.WHITE,bg:Q.Colors.DARK_RED})}var Ft=y(y(y(y(y({},L),W),N),K),Y);function j(e,t){return e.add(Ft[t](e))}var P=class{constructor(t,i=[]){this.compareFn=t;this.entities=i;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}add(t){this.entities.push(t),this.dirty=!0}clearDead(){this.entities=this.entities.filter(t=>t.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var d=class{constructor(t,i){this.list=t;this.filter=i}matches(t){if(!t.alive)return!1;for(let i of this.filter)if(!t[i])return!1;return!0}forEach(t){for(let i of this.list.get())this.matches(i)&&t(i,i)}};function c(e){return typeof e=="undefined"?NaN:Math.floor(e)}function A(e){return{x:c(e.x),y:c(e.y)}}function ft(e,t){let i=A(e),o=A(t);return i.x===o.x&&i.y===o.y}function _(e){let t=new d(e.entities,["appearance","position"]);e.on("draw",()=>t.forEach(({appearance:i,position:o})=>e.drawAt(c(o.x),c(o.y),i.glyph,i.fg,i.bg,i.blendMode)))}function V(e,t){let i=Math.abs(e.x-t.x),o=Math.abs(e.y-t.y);return Math.sqrt(i*i+o*o)}function O(e,t){let i=[],o=Math.floor(e.x-t),s=Math.ceil(e.x+t),n=Math.floor(e.y-t),r=Math.ceil(e.y+t);for(let a=n;a<=r;a++)for(let l=o;l<=s;l++){let p=V(e,{x:l,y:a});p>=t||i.push({x:l,y:a,intensity:t-p})}return i}function X(e){e.on("kill",({e:t})=>{let{explodes:i,name:o,position:s}=t;if(i&&s)for(let{x:n,y:r,intensity:a}of O(s,i.size))e.add(new m(e,o+"Explosion").setPosition({x:n,y:r}).setField({type:"fire",intensity:a,falloff:i.falloff}))})}var dt=b(E());var S=b(E());function w(e,t,i){return e*(1-i)+t*i}var T=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[i])=>t-i)}add(t,i){return this.points.push([t,i]),this.sort(),this}get(t){let[i,o]=this.points[0];if(t<=i)return(0,S.fromRgb)(...o);let[s,n]=this.points[this.points.length-1];if(t>=s)return(0,S.fromRgb)(...n);let r=this.points.findIndex(([Et])=>Et>t),[a,[l,p,f,h]]=this.points[r-1],[g,[C,I,v,yt]]=this.points[r],H=(t-a)/(g-a);return(0,S.fromRgb)(w(l,C,H),w(p,I,H),w(f,v,H),w(h,yt,H))}};var It={fire:new T([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function Gt(e,t){return It[e].get(t)}function F(e){if(!(e.intensity<=0))return{glyph:" ",layer:u.Effect,bg:Gt(e.type,e.intensity),blendMode:dt.BlendMode.Add}}function $(e){let t=new d(e.entities,["field","position"]);e.on("tick",()=>t.forEach(({field:i},o)=>{i.intensity-=i.falloff,o.setAppearance(F(i)),i.intensity<=0&&e.delete(o)})),e.on("spawn",({e:i})=>{i.field&&i.setAppearance(F(i.field))})}var ut=Math.PI*2;function J(e,t){let i=(e-t)%ut,o=(t-e)%ut;return i<o?-i:o}function U(e){let t=new d(e.entities,["homing","motion","position"]);e.on("tick",()=>t.forEach(({homing:i,motion:o,position:s},n)=>{let r=Math.atan2(e.player.position.y-s.y,e.player.position.x-s.x),a=J(o.angle,r);Math.abs(a)<=i.strength?o.angle=r:a<0?o.angle-=i.strength:o.angle+=i.strength,--i.duration<=0&&(n.setHoming(),n.setTrail())}))}function Z(e){let t=new d(e.entities,["lifetime"]);e.on("tick",()=>t.forEach(({lifetime:i},o)=>{--i.duration<=0&&e.delete(o)}))}function z(e){let t=Math.cos(e.angle)*e.vel,i=Math.sin(e.angle)*e.vel;return[t,i]}function tt(e,t){let i=t.x-e.x,o=t.y-e.y,s=Math.abs(i),n=Math.abs(o),r=i>0?1:-1,a=o>0?1:-1,l=y({},e),p=[y({},l)];for(let f=0,h=0;f<s||h<n;)(.5+f)/s<(.5+h)/n?(l.x+=r,f++):(l.y+=a,h++),p.push(y({},l));return p}function et(e){let t=new d(e.entities,["motion","position"]);e.on("tick",()=>t.forEach(({motion:i,position:o,explodes:s,ignoreSolid:n},r)=>{let[a,l]=z(i),p={x:o.x+a,y:o.y+l},f=tt(A(o),A(p)),h=!1,g;for(let C of f){e.move(r,C);let{wall:I,solid:v}=e.getContents(C);if(I){h=!0;break}else if(v&&!(n!=null&&n.ids.includes(e.getRootID(v)))){g=v;break}}h||g?e.delete(r):e.move(r,p)}))}function it(e){e.on("move",({e:t,old:i,pos:o})=>{t.trail&&!ft(i,o)&&e.spawn(t.trail.effectPrefab).setPosition(i)})}function ot(e){switch(e.mode){case"fire":e.timer--,e.salvo>0?e.timer<=0&&(e.mode="mid-salvo"):e.mode="reloading";break;case"mid-salvo":e.mode="fire",e.salvo--,e.salvo>0?e.timer=e.timeBetweenShots:e.timer=e.timeBetweenSalvos;break;case"reloading":e.timer--,e.timer<=0&&(e.mode="idle");break;case"idle":default:e.mode="fire",e.salvo=e.salvoCount-1,e.timer=e.timeBetweenShots;break}return e}function nt(e){let t=new d(e.entities,["position","turret"]);e.on("tick",()=>t.forEach(({position:i,turret:o},s)=>{ot(o),o.mode==="fire"&&e.spawn(o.bulletPrefab).setIgnoreSolid({ids:[e.getRootID(s)]}).setPosition({x:i.x+.5,y:i.y+.5}).setMotion({angle:Math.atan2(e.player.position.y-i.y,e.player.position.x-i.x),vel:o.bulletVelocity})}))}function ct(e){Z(e),U(e),nt(e),$(e),et(e),_(e),it(e),X(e)}var Lt=60,Dt=40,k=class{constructor(t,i=Lt,o=Dt){this.term=t;this.mapWidth=i;this.mapHeight=o;t.update=this.update.bind(this),this.dirty=!0,this.fovRecompute=!0,this.map=new x.Console(i,o,()=>!0),this.lastEntityId=0,this.entities=new P(mt),this.eventCallbacks={draw:[],kill:[],move:[],spawn:[],tick:[]},ct(this)}get player(){let t=this.entities.get().find(i=>i.player);if(!t)throw new Error("Could not find a player!");return t}fire(t,i){for(let o of this.eventCallbacks[t])o(i)}on(t,i){this.eventCallbacks[t].push(i)}spawn(t){return j(this,t)}add(t){return this.dirty=!0,this.entities.add(t),this.fire("spawn",{e:t}),t}delete(t){t.alive&&(t.kill(),this.fire("kill",{e:t}))}move(t,i){let o=t.position;t.move(i.x,i.y),o&&this.fire("move",{e:t,old:o,pos:i})}gotoDemoRoom(){this.entities.clear(),this.map.clear(),this.room(1,1,40,30),this.spawn("Player").move(5,25),this.spawn("Battleship").move(8,5)}room(t,i,o,s){let{map:n}=this;for(let r=0;r<s;r++)for(let a=0;a<o;a++){let l=a===0||r===0||a===o-1||r===s-1,p=t+a,f=i+r;n.setBlocked(p,f,l),n.setBlockedSight(p,f,l)}}drawAt(t,i,o,s,n,r){this.map.isVisible(t,i)&&(r?this.term.drawCell(t,i,{bg:n},r):this.term.drawChar(t,i,o,s,n))}draw(){let{map:t,mapWidth:i,mapHeight:o,player:s}=this;this.fovRecompute&&(t.computeFov(s.position.x,s.position.y,20),this.fovRecompute=!1);for(let n=0;n<o;n++)for(let r=0;r<i;r++){let a=t.grid[n][r],l=t.isVisible(r,n),p=a.blockedSight,f=x.Colors.BLACK;l?(f=p?x.Colors.WHITE:x.Colors.DARK_GRAY,a.explored=!0):a.explored&&(f=p?x.Colors.LIGHT_GRAY:x.Colors.BLACK),this.drawAt(r,n,0,0,f)}this.fire("draw",void 0),this.dirty=!1}getRootID(t){return t.attachment?this.getRootID(t.attachment.parent):t.id}getContents(t){let i={x:c(t.x),y:c(t.y)},o=this.map.isBlocked(i.x,i.y),s=this.entities.get().filter(r=>{var a,l;return c((a=r.position)==null?void 0:a.x)===i.x&&c((l=r.position)==null?void 0:l.y)==i.y}),n=s.find(r=>r.solid);return{wall:o,solid:n,other:s.filter(r=>!r.solid)}}tick(){this.fire("tick",void 0),this.entities.clearDead()}handleKeys(){let{map:t,player:i,term:o}=this,s=o.getMovementKey();if(s){let n=i.position.x+s.x,r=i.position.y+s.y;t.isBlocked(n,r)||(i.move(n,r),this.fovRecompute=!0,this.tick())}}update(){this.handleKeys(),this.dirty&&this.draw()}};var ht=b(E());function Wt(e){let o=document.createElement("div");e.appendChild(o);let s=()=>{let f=Math.floor(window.innerWidth/480),h=Math.floor(window.innerHeight/320),g=Math.min(f,h);o.style.width=`${480*g}px`,o.style.height=`${320*g}px`};window.addEventListener("resize",s),s();let n=document.createElement("canvas");o.appendChild(n);let r=new ht.Terminal(n,60,40),a=new k(r);a.gotoDemoRoom(),window.g=a}window.addEventListener("load",()=>Wt(document.body));})();
//# sourceMappingURL=bundle.js.map
