"use strict";(()=>{var St=Object.create;var I=Object.defineProperty;var It=Object.getOwnPropertyDescriptor;var Lt=Object.getOwnPropertyNames,mt=Object.getOwnPropertySymbols,Dt=Object.getPrototypeOf,ft=Object.prototype.hasOwnProperty,Gt=Object.prototype.propertyIsEnumerable;var pt=(e,t,o)=>t in e?I(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,u=(e,t)=>{for(var o in t||={})ft.call(t,o)&&pt(e,o,t[o]);if(mt)for(var o of mt(t))Gt.call(t,o)&&pt(e,o,t[o]);return e};var Nt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),C=(e,t)=>{for(var o in t)I(e,o,{get:t[o],enumerable:!0})},jt=(e,t,o,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Lt(t))!ft.call(e,r)&&r!==o&&I(e,r,{get:()=>t[r],enumerable:!(i=It(t,r))||i.enumerable});return e};var g=(e,t,o)=>(o=e!=null?St(Dt(e)):{},jt(t||!e||!e.__esModule?I(o,"default",{value:e,enumerable:!0}):o,e));var h=Nt((oe,dt)=>{dt.exports=globalThis.wglt});var b=g(h());function k(e,t=new Map){if(!e||typeof e!="object")return e;if(t.has(e))return t.get(e);let o;if(e.nodeType&&"cloneNode"in e)o=e.cloneNode(!0),t.set(e,o);else if(e instanceof Date)o=new Date(e.getTime()),t.set(e,o);else if(e instanceof RegExp)o=new RegExp(e),t.set(e,o);else if(Array.isArray(e)){o=new Array(e.length),t.set(e,o);for(let i=0;i<e.length;i++)o[i]=k(e[i],t)}else if(e instanceof Map){o=new Map,t.set(e,o);for(let[i,r]of e.entries())o.set(i,k(r,t))}else if(e instanceof Set){o=new Set,t.set(e,o);for(let i of e)o.add(k(i,t))}else if(e instanceof Object){o={},t.set(e,o);for(let[i,r]of Object.entries(e))o[i]=k(r,t)}else throw Error(`Unable to clone ${e}`);return o}function ct(e){return k(e,new Map)}var j=ct,ut=Object.keys;var E=class{constructor(t,o){this.g=t;this.name=o;this.alive=!0,this.id=++t.lastEntityId,this.player=!1,this.projectile=!1,this.solid=!1}applyPrefab(t,o){if(this.prefab=t,o.components&&Object.assign(this,j(o.components)),o.children)for(let{name:i,x:r,y:n,overlay:s}of o.children){let a=this.g.spawn(i).setAttachment({parent:this,x:r,y:n});if(s)for(let l of ut(s))Object.assign(a[l],j(s[l]))}return this}get[Symbol.toStringTag](){return this.name}kill(){return this.alive=!1,this.eachChild(t=>this.g.delete(t)),this}eachChild(t){var o;for(let i of this.g.entities.get())((o=i.attachment)==null?void 0:o.parent)===this&&t(i,i.attachment)}setAppearance(t){return this.g.dirty=!0,this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setPosition(t){return this.g.dirty=!0,this.position=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,o){return this.g.dirty=!0,this.position={x:t,y:o},this.eachChild((i,r)=>i.move(t+r.x,o+r.y)),this.position}};function ht(e,t){var r,n,s,a;let o=(n=(r=e.appearance)==null?void 0:r.layer)!=null?n:0,i=(a=(s=t.appearance)==null?void 0:s.layer)!=null?a:0;return o!==i?o-i:e.id-t.id}var K={};C(K,{Battleship:()=>Wt,BattleshipHull:()=>Kt});var W=g(h());var yt=(n=>(n[n.Effect=0]="Effect",n[n.Ship=1]="Ship",n[n.Gun=2]="Gun",n[n.Bullet=3]="Bullet",n[n.Player=4]="Player",n))(yt||{}),f=yt;var Wt={children:[{name:"BattleshipHull",x:1,y:0},{name:"BattleshipHull",x:2,y:0},{name:"BattleshipHull",x:0,y:1},{name:"BattleshipHull",x:1,y:1},{name:"BattleshipHull",x:2,y:1},{name:"MachineGun",x:0,y:1},{name:"HomingMissileLauncher",x:2,y:1}]},Kt={components:{solid:!0,appearance:{glyph:"/",layer:f.Ship,fg:W.Colors.WHITE,bg:W.Colors.BROWN}}};var V={};C(V,{Bullet:()=>qt,HomingMissile:()=>Vt});var q=g(h());var qt={components:{projectile:!0,appearance:{glyph:".",layer:f.Bullet,fg:q.Colors.YELLOW}}},Vt={components:{projectile:!0,homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,falloff:1},appearance:{glyph:"*",layer:f.Bullet,fg:q.Colors.DARK_RED}}};var O={};C(O,{AirFistRange:()=>Ot,SmokePuff:()=>Qt});var w=g(h());var Ot={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:f.Effect,bg:(0,w.fromRgb)(0,255,255,100),blendMode:w.BlendMode.Add}}},Qt={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:f.Effect,bg:(0,w.fromRgb)(100,100,100,50),blendMode:w.BlendMode.Add}}};var _={};C(_,{HomingMissileLauncher:()=>_t,MachineGun:()=>Yt});var Y=g(h());var Q=({bulletPrefab:e="Bullet",bulletVelocity:t=1,salvoCount:o=1,timeBetweenShots:i=1,timeBetweenSalvos:r=1})=>({bulletPrefab:e,bulletVelocity:t,salvoCount:o,timeBetweenShots:i,timeBetweenSalvos:r,timer:0,salvo:o});var Yt={components:{appearance:{glyph:"o",layer:f.Gun,fg:Y.Colors.WHITE},turret:Q({bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:5,timeBetweenShots:0,timeBetweenSalvos:12})}},_t={components:{appearance:{glyph:"o",layer:f.Gun,fg:Y.Colors.YELLOW},turret:Q({bulletPrefab:"HomingMissile",bulletVelocity:1,salvoCount:1,timeBetweenSalvos:8})}};var X={};C(X,{Player:()=>Xt,PlayerHull:()=>$t});var $=g(h());var $t={components:{solid:!0,appearance:{glyph:"#",layer:f.Player,fg:$.Colors.WHITE,bg:$.Colors.DARK_RED}}},Xt={components:{player:!0},children:[{name:"PlayerHull",x:0,y:0},{name:"PlayerHull",x:1,y:0,overlay:{appearance:{glyph:">"}}}]};var Ut=u(u(u(u(u({},K),V),O),_),X);function U(e,t){return e.add(new E(e,t).applyPrefab(t,Ut[t]))}function y(e){return typeof e=="undefined"?NaN:Math.floor(e)}function P(e){return{x:y(e.x),y:y(e.y)}}function L(e,t){let o=P(e),i=P(t);return o.x===i.x&&o.y===i.y}function D(e,t){return{x:e.x+t.x,y:e.y+t.y}}var A=class{constructor(t,o=[]){this.compareFn=t;this.entities=o;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}add(t){this.entities.push(t),this.dirty=!0}clearDead(){this.entities=this.entities.filter(t=>t.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var d=class{constructor(t,o){this.list=t;this.filter=o}matches(t){if(!t.alive)return!1;for(let o of this.filter)if(!t[o])return!1;return!0}forEach(t){for(let o of this.list.get())this.matches(o)&&t(o,o)}};function J(e){let t=new d(e.entities,["appearance","position"]);e.on("draw",()=>t.forEach(({appearance:o,position:i})=>e.drawIfVisible(y(i.x),y(i.y),o.glyph,o.fg,o.bg,o.blendMode)))}var bt=g(h());var G=g(h());function v(e,t,o){return e*(1-o)+t*o}var H=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[o])=>t-o)}add(t,o){return this.points.push([t,o]),this.sort(),this}get(t){let[o,i]=this.points[0];if(t<=o)return(0,G.fromRgb)(...i);let[r,n]=this.points[this.points.length-1];if(t>=r)return(0,G.fromRgb)(...n);let s=this.points.findIndex(([Ft])=>Ft>t),[a,[l,m,p,c]]=this.points[s-1],[x,[N,F,Bt,Rt]]=this.points[s],S=(t-a)/(x-a);return(0,G.fromRgb)(v(l,N,S),v(m,F,S),v(p,Bt,S),v(c,Rt,S))}};function B(e,t){let o=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);return Math.sqrt(o*o+i*i)}var Jt={fire:new H([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function Z(e){if(!(e.intensity<=0))return{glyph:" ",layer:f.Effect,bg:Jt[e.type].get(e.intensity),blendMode:bt.BlendMode.Add}}function gt(e,t){let o=[],i=Math.floor(e.x-t),r=Math.ceil(e.x+t),n=Math.floor(e.y-t),s=Math.ceil(e.y+t);for(let a=n;a<=s;a++)for(let l=i;l<=r;l++){let m=B(e,{x:l,y:a});m>=t||o.push({x:l,y:a,intensity:t-m})}return o}function z(e){e.on("kill",({e:t})=>{let{explodes:o,name:i,position:r}=t;if(o&&r)for(let{x:n,y:s,intensity:a}of gt(r,o.size))e.add(new E(e,i+"Explosion").setPosition({x:n,y:s}).setField({type:"fire",intensity:a,falloff:o.falloff}))})}function tt(e){let t=new d(e.entities,["field","position"]);e.on("tick",()=>t.forEach(({field:o},i)=>{o.intensity-=o.falloff,i.setAppearance(Z(o)),o.intensity<=0&&e.delete(i)})),e.on("spawn",({e:o})=>{o.field&&o.setAppearance(Z(o.field))})}var xt=Math.PI*2;function M(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}function Et(e,t){let o=(e-t)%xt,i=(t-e)%xt;return o<i?-o:i}function Pt(e){let t=Math.cos(e.angle)*e.vel,o=Math.sin(e.angle)*e.vel;return[t,o]}function wt(e,t){let o=e.getRoot(t);return e.entities.get().filter(i=>e.getRoot(i)===o)}function et(e,t){return wt(e,t).map(o=>o.id)}function vt(e,t){let o=wt(e,t),i=[];for(let r of o){let{attachment:n,solid:s}=r;n&&s&&i.push([{x:n.x,y:n.y},r])}return{layout:i,topLeft:e.getRoot(t).position}}function Mt(e,t,o){let i=et(e,t),{layout:r}=vt(e,t),n=[];for(let[s]of r){let a=D(o,s),{wall:l,solid:m}=e.getContents(a,i);l?n.push([a,"wall"]):m&&n.push([a,m])}return n}function T(e,t){let{layout:o,topLeft:i}=vt(e,t);if(!i||!o.length)throw new Error(`Could not get midpoint of entity#${t.id}`);let r=n=>o.reduce((s,[a])=>s+a[n],0)/o.length;return{x:i.x+r("x"),y:i.y+r("y")}}function ot(e){let t=new d(e.entities,["homing","motion","position"]);e.on("tick",()=>t.forEach(({homing:o,motion:i,position:r},n)=>{let s=T(e,e.player),a=M(r,s),l=Et(i.angle,a);Math.abs(l)<=o.strength?i.angle=a:l<0?i.angle-=o.strength:i.angle+=o.strength,--o.duration<=0&&(n.setHoming(),n.setTrail())}))}function it(e){let t=new d(e.entities,["lifetime"]);e.on("tick",()=>t.forEach(({lifetime:o},i)=>{--o.duration<=0&&e.delete(i)}))}function Tt(e,t){let o=t.x-e.x,i=t.y-e.y,r=Math.abs(o),n=Math.abs(i),s=o>0?1:-1,a=i>0?1:-1,l=u({},e),m=[u({},l)];for(let p=0,c=0;p<r||c<n;)(.5+p)/r<(.5+c)/n?(l.x+=s,p++):(l.y+=a,c++),m.push(u({},l));return m}function Ct(e,t,o){let i=[],r=(n,s)=>{let a=y(n),l=y(s);i.find(m=>m.x===a&&m.y===l)||i.push({x:a,y:l})};for(let n=0;n<=Math.floor(o*Math.sqrt(.5));n++){let s=Math.floor(Math.sqrt(o*o-n*n));r(e-s,t+n),r(e+s,t+n),r(e-s,t-n),r(e+s,t-n),r(e+n,t-s),r(e+n,t+s),r(e-n,t-s),r(e-n,t+s)}return i}function nt(e){let t=new d(e.entities,["motion","position"]);e.on("tick",()=>t.forEach(({motion:o,position:i,ignoreSolid:r},n)=>{let[s,a]=Pt(o),l={x:i.x+s,y:i.y+a},m=Tt(P(i),P(l)),p=!1,c;for(let x of m){e.move(n,x);let{wall:N,solid:F}=e.getContents(x,r==null?void 0:r.ids);if(N){p=!0;break}else if(F){c=F;break}}p||c?e.delete(n):e.move(n,l)}))}function rt(e){e.on("playerMove",({move:t})=>{let o=e.player,i=D(o.position,t);Mt(e,o,i).length||(o.move(i.x,i.y),e.fovRecompute=!0,e.tick())})}function st(e){e.on("move",({e:t,old:o,pos:i})=>{t.trail&&!L(o,i)&&e.spawn(t.trail.effectPrefab).setPosition(o)})}function at(e){return e.timer?(e.timer--,e.timer<=0&&e.salvo<=0&&(e.salvo=e.salvoCount),!1):(--e.salvo<=0?e.timer=e.timeBetweenSalvos:e.timer=e.timeBetweenShots,!0)}function lt(e){let t=new d(e.entities,["position","turret"]);e.on("tick",()=>t.forEach(({position:o,turret:i},r)=>{if(at(i)){let n={x:o.x+.5,y:o.y+.5},s=T(e,e.player);e.spawn(i.bulletPrefab).setIgnoreSolid({ids:et(e,r)}).setPosition(n).setMotion({angle:M(n,s),vel:i.bulletVelocity})}}))}function kt(e){it(e),ot(e),lt(e),tt(e),nt(e),J(e),st(e),z(e),rt(e)}function At(e,t,o){for(let i of e.entities.get()){let{motion:r,projectile:n,position:s}=i;if(r&&n&&s&&B(t,s)<=o){let a=M(t,s);r.angle=a,i.setIgnoreSolid()}}for(let i of Ct(t.x,t.y,o))e.spawn("AirFistRange").setPosition(i)}var Zt=60,zt=40,R=class{constructor(t,o=Zt,i=zt){this.term=t;this.mapWidth=o;this.mapHeight=i;t.update=this.update.bind(this),this.dirty=!0,this.fovRecompute=!0,this.map=new b.Console(o,i,()=>!0),this.lastEntityId=0,this.entities=new A(ht),this.eventCallbacks={draw:[],kill:[],move:[],playerMove:[],spawn:[],tick:[]},kt(this)}get player(){let t=this.entities.get().find(o=>o.player);if(!t)throw new Error("Could not find a player!");return t}fire(t,o){for(let i of this.eventCallbacks[t])i(o)}on(t,o){this.eventCallbacks[t].push(o)}spawn(t){return U(this,t)}add(t){return this.dirty=!0,this.entities.add(t),this.fire("spawn",{e:t}),t}delete(t){t.alive&&(t.kill(),this.fire("kill",{e:t}))}move(t,o){let i=t.position;t.move(o.x,o.y),i&&this.fire("move",{e:t,old:i,pos:o})}gotoDemoRoom(){this.entities.clear(),this.map.clear(),this.room(1,1,40,30),this.spawn("Player").move(5,25),this.spawn("Battleship").move(8,5)}room(t,o,i,r){let{map:n}=this;for(let s=0;s<r;s++)for(let a=0;a<i;a++){let l=a===0||s===0||a===i-1||s===r-1,m=t+a,p=o+s;n.setBlocked(m,p,l),n.setBlockedSight(m,p,l)}}drawIfVisible(t,o,i,r,n,s){this.map.isVisible(t,o)&&(s?this.term.drawCell(t,o,{bg:n},s):this.term.drawChar(t,o,i,r,n))}draw(){let{map:t,mapWidth:o,mapHeight:i,player:r,term:n}=this;this.fovRecompute&&(t.computeFov(r.position.x,r.position.y,20),this.fovRecompute=!1);for(let s=0;s<i;s++)for(let a=0;a<o;a++){let l=t.grid[s][a],m=t.isVisible(a,s),p=l.blockedSight,c=b.Colors.BLACK;m?(c=p?b.Colors.WHITE:b.Colors.DARK_GRAY,l.explored=!0):l.explored&&(c=p?b.Colors.LIGHT_GRAY:b.Colors.BLACK),n.drawChar(a,s,0,0,c)}this.fire("draw",void 0),this.dirty=!1}getRoot(t){return t.attachment?this.getRoot(t.attachment.parent):t}getContents(t,o=[]){let i=P(t),r=this.map.isBlocked(i.x,i.y),n=this.entities.get().filter(a=>a.position&&L(i,a.position)),s=n.filter(a=>!o.includes(a.id)).find(a=>a.solid);return{wall:r,solid:s,other:n.filter(a=>!a.solid)}}tick(){this.fire("tick",void 0),this.entities.clearDead()}handleKeys(){let t=this.term.getMovementKey();if(t){this.fire("playerMove",{move:t});return}if(this.term.isKeyPressed(b.Key.VK_F)){At(this,T(this,this.player),4.5),this.tick();return}}update(){this.handleKeys(),this.dirty&&this.draw()}};var Ht=g(h());function te(e){let i=document.createElement("div");e.appendChild(i);let r=()=>{let p=Math.floor(window.innerWidth/480),c=Math.floor(window.innerHeight/320),x=Math.min(p,c);i.style.width=`${480*x}px`,i.style.height=`${320*x}px`};window.addEventListener("resize",r),r();let n=document.createElement("canvas");i.appendChild(n),requestAnimationFrame(()=>n.focus());let s=new Ht.Terminal(n,60,40),a=new R(s);a.gotoDemoRoom(),window.g=a}window.addEventListener("load",()=>te(document.body));})();
//# sourceMappingURL=bundle.js.map
