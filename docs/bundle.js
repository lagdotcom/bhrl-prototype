"use strict";(()=>{var $t=Object.create;var q=Object.defineProperty;var Yt=Object.getOwnPropertyDescriptor;var Qt=Object.getOwnPropertyNames,wt=Object.getOwnPropertySymbols,Xt=Object.getPrototypeOf,kt=Object.prototype.hasOwnProperty,Ut=Object.prototype.propertyIsEnumerable;var Mt=(e,t,o)=>t in e?q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,b=(e,t)=>{for(var o in t||={})kt.call(t,o)&&Mt(e,o,t[o]);if(wt)for(var o of wt(t))Ut.call(t,o)&&Mt(e,o,t[o]);return e};var Jt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),C=(e,t)=>{for(var o in t)q(e,o,{get:t[o],enumerable:!0})},Zt=(e,t,o,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Qt(t))!kt.call(e,n)&&n!==o&&q(e,n,{get:()=>t[n],enumerable:!(i=Yt(t,n))||i.enumerable});return e};var P=(e,t,o)=>(o=e!=null?$t(Xt(e)):{},Zt(t||!e||!e.__esModule?q(o,"default",{value:e,enumerable:!0}):o,e));var E=Jt((Pe,Tt)=>{Tt.exports=globalThis.wglt});var y=P(E());function O(e,t=new Map){if(!e||typeof e!="object")return e;if(t.has(e))return t.get(e);let o;if(e.nodeType&&"cloneNode"in e)o=e.cloneNode(!0),t.set(e,o);else if(e instanceof Date)o=new Date(e.getTime()),t.set(e,o);else if(e instanceof RegExp)o=new RegExp(e),t.set(e,o);else if(Array.isArray(e)){o=new Array(e.length),t.set(e,o);for(let i=0;i<e.length;i++)o[i]=O(e[i],t)}else if(e instanceof Map){o=new Map,t.set(e,o);for(let[i,n]of e.entries())o.set(i,O(n,t))}else if(e instanceof Set){o=new Set,t.set(e,o);for(let i of e)o.add(O(i,t))}else if(e instanceof Object){o={},t.set(e,o);for(let[i,n]of Object.entries(e))o[i]=O(n,t)}else throw Error(`Unable to clone ${e}`);return o}function At(e){return O(e,new Map)}var J=At,Ct=Object.keys,Ht=e=>{let t={};for(let[o,i]of e)t[o]=i;return t};var T=class{constructor(t,o){this.g=t;this.name=o;this.alive=!0,this.id=++t.lastEntityId,this.solid=!1,this.tags=new Set}applyPrefab(t,o){if(this.prefab=t,o.components&&Object.assign(this,J(o.components)),o.children)for(let{name:i,x:n,y:r,overlay:s,tags:a}of o.children){let l=this.g.spawn(i).setAttachment({parent:this,x:n,y:r});if(s)for(let m of Ct(s))Object.assign(l[m],J(s[m]));if(a)for(let m of a)l.tags.add(m)}return this}get[Symbol.toStringTag](){return this.name}kill(t){return this.alive=!1,this.eachChild(o=>this.g.kill(o,t)),this}eachChild(t){var o;for(let i of this.g.entities.get())((o=i.attachment)==null?void 0:o.parent)===this&&t(i,i.attachment)}setOwner(t){return this.owner=t,this}setAI(t){return this.ai=t,this}setAppearance(t){return this.g.dirty=!0,this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setHull(t){return this.hull=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setPosition(t){return this.g.dirty=!0,this.position=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,o){return this.g.dirty=!0,this.position={x:t,y:o},this.eachChild((i,n)=>i.move(t+n.x,o+n.y)),this.position}};function Rt(e,t){var n,r,s,a;let o=(r=(n=e.appearance)==null?void 0:n.layer)!=null?r:0,i=(a=(s=t.appearance)==null?void 0:s.layer)!=null?a:0;return o!==i?o-i:e.id-t.id}var Ft=["damage","draw","kill","move","notice","playerFire","playerMove","spawn","tick"];function v(e){return typeof e=="undefined"?NaN:Math.floor(e)}function k(e){return{x:v(e.x),y:v(e.y)}}function H(e,t){let o=k(e),i=k(t);return o.x===i.x&&o.y===i.y}function x(e,t){return{x:e.x+t.x,y:e.y+t.y}}function zt(e,t){if(!t||!e.length)throw new Error("Could not get midpoint");let o=i=>e.reduce((n,{offset:r})=>n+r[i],0)/e.length;return{x:t.x+o("x"),y:t.y+o("y")}}function te(e,t,o,i=[]){let n=[];for(let{offset:r}of t){let s=x(o,r),{wall:a,solid:l}=e.getContents(s,i);a?n.push({absolute:s,offset:r,entity:"wall"}):l&&n.push({absolute:s,offset:r,entity:l})}return n}function R(e,t){let o=e.getRoot(t);return e.entities.get().filter(i=>e.getRoot(i)===o)}function G(e,t){return R(e,t).map(o=>o.id)}function F(e,t){var s;let o=e.getRoot(t),i=(s=e.getRoot(t).position)!=null?s:{x:0,y:0},n=R(e,t),r=[];for(let a of n){let{attachment:l,solid:m}=a;if(l&&m){let{x:p,y:f}=l;r.push({absolute:x(i,l),offset:{x:p,y:f},entity:a})}}return{layout:r,topLeft:i}}function Bt(e,t,o){let i=G(e,t),{layout:n,topLeft:r}=F(e,t);return!o||!r?[]:te(e,n,o||r,i)}function B(e,t){let{layout:o,topLeft:i}=F(e,t);if(!i||!o.length)throw new Error(`Could not get midpoint of entity#${t.id}`);return zt(o,i)}var z={};C(z,{Battleship:()=>ee,BattleshipHull:()=>oe});var Z=P(E());var It=(r=>(r[r.Effect=0]="Effect",r[r.Ship=1]="Ship",r[r.Gun=2]="Gun",r[r.Bullet=3]="Bullet",r[r.Player=4]="Player",r))(It||{}),c=It;var ee={components:{ai:{idealDistance:8,speed:1,visionRange:10},hull:{hp:40,maxHp:40}},children:[{name:"BattleshipHull",x:1,y:0},{name:"BattleshipHull",x:2,y:0},{name:"BattleshipHull",x:0,y:1},{name:"BattleshipHull",x:1,y:1},{name:"BattleshipHull",x:2,y:1},{name:"MachineGun",x:0,y:1},{name:"HomingMissileLauncher",x:2,y:1},{name:"FighterLauncher",x:2,y:0}]},oe={components:{solid:!0,appearance:{glyph:"/",layer:c.Ship,fg:Z.Colors.WHITE,bg:Z.Colors.BROWN}}};var et={};C(et,{Bullet:()=>ie,HomingMissile:()=>ne});var tt=P(E());var ie={components:{projectile:{damage:1},appearance:{glyph:".",layer:c.Bullet,fg:tt.Colors.YELLOW}}},ne={components:{projectile:{damage:1},homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,falloff:1},appearance:{glyph:"*",layer:c.Bullet,fg:tt.Colors.DARK_RED}}};var ot={};C(ot,{AirFistRange:()=>re,SmokePuff:()=>se});var I=P(E());var re={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:c.Effect,bg:(0,I.fromRgb)(0,255,255,100),blendMode:I.BlendMode.Add}}},se={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:c.Effect,bg:(0,I.fromRgb)(100,100,100,50),blendMode:I.BlendMode.Add}}};var it={};C(it,{Fighter:()=>le,FighterHull:()=>me,FighterLauncher:()=>ae});var $=P(E());var S=({bulletPrefab:e="Bullet",bulletVelocity:t=1,salvoCount:o=1,timeBetweenShots:i=1,timeBetweenSalvos:n=1})=>({bulletPrefab:e,bulletVelocity:t,salvoCount:o,timeBetweenShots:i,timeBetweenSalvos:n,timer:0,salvo:o});var ae={components:{appearance:{glyph:"_",layer:c.Gun,fg:$.Colors.DARK_CYAN},turret:S({bulletPrefab:"Fighter",bulletVelocity:0,salvoCount:1,timeBetweenSalvos:20})}},le={components:{ai:{idealDistance:6,speed:2,visionRange:5},hull:{hp:2,maxHp:2}},children:[{name:"FighterHull",x:0,y:0,overlay:{appearance:{glyph:"<"}}},{name:"FighterHull",x:1,y:0},{name:"FighterHull",x:2,y:0,overlay:{appearance:{glyph:">"}}},{name:"PeaShooter",x:1,y:0}]},me={components:{solid:!0,appearance:{glyph:"-",layer:c.Ship,fg:$.Colors.YELLOW,bg:$.Colors.DARK_BLUE}}};var nt={};C(nt,{HomingMissileLauncher:()=>fe,MachineGun:()=>pe,PeaShooter:()=>ce});var Y=P(E());var pe={components:{appearance:{glyph:"o",layer:c.Gun,fg:Y.Colors.WHITE},turret:S({bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:5,timeBetweenShots:0,timeBetweenSalvos:12})}},fe={components:{appearance:{glyph:"o",layer:c.Gun,fg:Y.Colors.YELLOW},turret:S({bulletPrefab:"HomingMissile",bulletVelocity:1,salvoCount:1,timeBetweenSalvos:8})}},ce={components:{appearance:{glyph:"o",layer:c.Gun,fg:Y.Colors.LIGHT_GRAY},turret:S({bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:1,timeBetweenSalvos:3})}};var rt={};C(rt,{Player:()=>de,PlayerHull:()=>ue});var D=P(E());var ue={components:{solid:!0,appearance:{glyph:"#",layer:c.Player,fg:D.Colors.WHITE,bg:D.Colors.DARK_RED}}},de={components:{player:{visionRange:20,weaponArrays:["primary"]},hull:{hp:20,maxHp:20}},children:[{name:"PlayerHull",x:0,y:0,overlay:{appearance:{glyph:"\x1B",bg:D.Colors.DARK_RED}}},{name:"PlayerHull",x:1,y:0,overlay:{appearance:{glyph:"",bg:D.Colors.DARK_RED}}},{name:"PlayerHull",x:2,y:0,overlay:{appearance:{glyph:"",bg:D.Colors.DARK_RED}}},{name:"MachineGun",x:1,y:0,tags:["primary"]}]};var he=b(b(b(b(b(b({},z),et),ot),it),nt),rt);function st(e,t){return e.add(new T(e,t).applyPrefab(t,he[t]))}var N=class{constructor(t,o=[]){this.compareFn=t;this.entities=o;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}add(t){this.entities.push(t),this.dirty=!0}clearDead(){this.entities=this.entities.filter(t=>t.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var u=class{constructor(t,o){this.list=t;this.filter=o}matches(t){if(!t.alive)return!1;for(let o of this.filter)if(!t[o])return!1;return!0}forEach(t){for(let o of this.list.get())this.matches(o)&&t(o,o)}};function A(e,t){let o=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);return Math.sqrt(o*o+i*i)}var at=[{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:-1}];function lt(e){return at.map(t=>x(e,t))}function mt(e){if(!e.length)throw new Error("oneOf passed empty array");return e[Math.floor(Math.random()*e.length)]}function pt(e){let t=new u(e.entities,["ai","position"]);e.on("tick",()=>t.forEach(({ai:o,position:i},n)=>{if(!o.attacking){if(A(i,e.player.position)>=o.visionRange)return;o.attacking=e.player,e.fire("notice",{e:n,noticed:e.player})}let r=G(e,n),{layout:s}=F(e,n),a=k(i),l=e.getDistanceMap(o.attacking),m=d=>{let{solid:h,wall:M}=e.getContents(d,r);return!h&&!M},p=d=>m(d)?Math.abs(l.getOrDefault(d,1/0)-o.idealDistance):1/0,f=d=>s.reduce((h,{offset:M})=>h+p(x(d,M)),0)/s.length,g=f(a),w=[];for(let d of at){let h=x(a,d);if(!l.has(h))continue;let M=f(h);M<g?(g=M,w=[h]):M===g&&w.push(h)}if(w.length){let d=mt(w);n.move(d.x,d.y);return}})),e.on("damage",({e:o,inflicter:i})=>{if(o!==i&&o.ai&&!o.ai.attacking){let n=e.getRoot(i);n.alive&&(o.ai.attacking=n)}})}function ft(e){let t=new u(e.entities,["appearance","position"]);e.on("draw",()=>t.forEach(({appearance:o,position:i})=>e.drawIfVisible(v(i.x),v(i.y),o.glyph,o.fg,o.bg,o.blendMode)))}var St=P(E());var Q=P(E());function L(e,t,o){return e*(1-o)+t*o}var V=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[o])=>t-o)}add(t,o){return this.points.push([t,o]),this.sort(),this}get(t){let[o,i]=this.points[0];if(t<=o)return(0,Q.fromRgb)(...i);let[n,r]=this.points[this.points.length-1];if(t>=n)return(0,Q.fromRgb)(...r);let s=this.points.findIndex(([qt])=>qt>t),[a,[l,m,p,f]]=this.points[s-1],[g,[w,d,h,M]]=this.points[s],_=(t-a)/(g-a);return(0,Q.fromRgb)(L(l,w,_),L(m,d,_),L(p,h,_),L(f,M,_))}};var ye={fire:new V([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function ct(e){if(!(e.intensity<=0))return{glyph:" ",layer:c.Effect,bg:ye[e.type].get(e.intensity),blendMode:St.BlendMode.Add}}function Dt(e,t){let o=[],i=Math.floor(e.x-t),n=Math.ceil(e.x+t),r=Math.floor(e.y-t),s=Math.ceil(e.y+t);for(let a=r;a<=s;a++)for(let l=i;l<=n;l++){let m=A(e,{x:l,y:a});m>=t||o.push({x:l,y:a,intensity:t-m})}return o}function ut(e){e.on("kill",({e:t})=>{let{explodes:o,name:i,position:n}=t;if(o&&n)for(let{x:r,y:s,intensity:a}of Dt(n,o.size))e.add(new T(e,i+"Explosion").setPosition({x:r,y:s}).setField({type:"fire",intensity:a,falloff:o.falloff}))})}function dt(e){let t=new u(e.entities,["hull"]),o=new u(e.entities,["field","position"]);e.on("tick",()=>o.forEach(({field:i,position:n},r)=>{i.intensity-=i.falloff,r.setAppearance(ct(i)),i.intensity<=0?e.kill(r):t.forEach(({},s)=>{let{layout:a}=F(e,s);a.find(({absolute:m})=>H(m,n))&&e.damage(s,i.intensity,r)})})),e.on("spawn",({e:i})=>{i.field&&i.setAppearance(ct(i.field))})}var Lt=Math.PI*2;function K(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}function Kt(e,t){let o=(e-t)%Lt,i=(t-e)%Lt;return o<i?-o:i}function Ot(e){let t=Math.cos(e.angle)*e.vel,o=Math.sin(e.angle)*e.vel;return[t,o]}function ht(e){let t=new u(e.entities,["homing","motion","position"]);e.on("tick",()=>t.forEach(({homing:o,motion:i,position:n},r)=>{if(!o.target)return;let s=B(e,o.target),a=K(n,s),l=Kt(i.angle,a);Math.abs(l)<=o.strength?i.angle=a:l<0?i.angle-=o.strength:i.angle+=o.strength,--o.duration<=0&&(r.setHoming(),r.setTrail())}))}function yt(e){let t=new u(e.entities,["lifetime"]);e.on("tick",()=>t.forEach(({lifetime:o},i)=>{--o.duration<=0&&e.kill(i)}))}function Gt(e,t){let o=t.x-e.x,i=t.y-e.y,n=Math.abs(o),r=Math.abs(i),s=o>0?1:-1,a=i>0?1:-1,l=b({},e),m=[b({},l)];for(let p=0,f=0;p<n||f<r;)(.5+p)/n<(.5+f)/r?(l.x+=s,p++):(l.y+=a,f++),m.push(b({},l));return m}function Nt(e,t,o){let i=[],n=(r,s)=>{let a=v(r),l=v(s);i.find(m=>m.x===a&&m.y===l)||i.push({x:a,y:l})};for(let r=0;r<=Math.floor(o*Math.sqrt(.5));r++){let s=Math.floor(Math.sqrt(o*o-r*r));n(e-s,t+r),n(e+s,t+r),n(e-s,t-r),n(e+s,t-r),n(e+r,t-s),n(e+r,t+s),n(e-r,t-s),n(e-r,t+s)}return i}function gt(e){let t=new u(e.entities,["motion","position"]);e.on("tick",()=>t.forEach(({motion:o,position:i,projectile:n,ignoreSolid:r},s)=>{let[a,l]=Ot(o),m={x:i.x+a,y:i.y+l},p=Gt(k(i),k(m)),f=!1,g;for(let w of p){e.move(s,w);let{wall:d,solid:h}=e.getContents(w,r==null?void 0:r.ids);if(d){f=!0;break}else if(h){g=h;break}}f?e.kill(s):g?(n&&e.damage(g,n.damage,s),e.kill(s)):e.move(s,m)}))}function Vt(e){if(e.timer>0){e.timer--,e.timer<=0&&e.salvo<=0&&(e.salvo=e.salvoCount);return}}function X(e){return e.timer===0}function U(e,t,o,i,n,r=[]){--t.salvo<=0?t.timer=t.timeBetweenSalvos:t.timer=t.timeBetweenShots;let s={x:o.x+.5,y:o.y+.5},a=e.spawn(t.bulletPrefab).setOwner(n).setIgnoreSolid({ids:r});return a.move(s.x,s.y),t.bulletVelocity&&a.setMotion({angle:K(s,i),vel:t.bulletVelocity}),a}function bt(e){e.on("playerMove",({move:t})=>{let o=e.player,i=x(o.position,t);Bt(e,o,i).length||(o.move(i.x,i.y),e.fovRecompute=!0,e.tick())}),e.on("playerFire",({array:t})=>{let o=e.player,i=o.player.weaponArrays[t],n=R(e,o),r=n.filter(a=>a.tags.has(i)),s=!1;for(let a of r){if(!a.turret)continue;let l=a.position,m=x(l,{x:.5,y:-.5});X(a.turret)&&(U(e,a.turret,l,m,o,n.map(p=>p.id)),s=!0)}})}function Et(e){e.on("move",({e:t,old:o,pos:i})=>{t.trail&&!H(o,i)&&e.spawn(t.trail.effectPrefab).setPosition(o)})}function xt(e){let t=new u(e.entities,["position","turret"]);e.on("tick",()=>t.forEach(({position:o,turret:i},n)=>{var a;let r=e.getRoot(n),s=(a=r.ai)==null?void 0:a.attacking;if(Vt(i),X(i)&&s){let l=B(e,s),m=U(e,i,o,l,r,G(e,n));m.homing&&(m.homing.target=s),m.ai&&(m.ai.attacking=s)}}))}function jt(e){yt(e),ht(e),xt(e),dt(e),gt(e),pt(e),ft(e),Et(e),ut(e),bt(e)}var j=class{constructor(t){this.keyFn=t;this.items=new Map}has(t){return this.items.has(this.keyFn(t))}get(t){return this.items.get(this.keyFn(t))}getOrDefault(t,o){let i=this.items.get(this.keyFn(t));return typeof i!="undefined"?i:o}getOrDie(t){let o=this.keyFn(t),i=this.items.get(o);if(typeof i=="undefined")throw new Error(`Invalid key: ${o}`);return i}set(t,o){this.items.set(this.keyFn(t),o)}};function Pt(e,t,o=1/0){let i=[],n=new j(r=>`${r.x},${r.y}`);for(let r of e)i.push(r),n.set(r,0);for(;;){let r=i.shift();if(!r)break;let s=n.getOrDie(r)+1;if(!(s>o))for(let a of lt(r))!n.has(a)&&t(a)&&(n.set(a,s),i.push(a))}return n}function Wt(e,t,o){for(let i of e.entities.get()){let{motion:n,projectile:r,position:s}=i;if(n&&r&&s&&A(t,s)<=o){let a=K(t,s);n.angle=a,i.setIgnoreSolid()}}for(let i of Nt(t.x,t.y,o))e.spawn("AirFistRange").setPosition(i)}function vt(e){return typeof e!="undefined"}var ge=60,be=40,W=class{constructor(t,o=ge,i=be){this.term=t;this.mapWidth=o;this.mapHeight=i;t.update=this.update.bind(this),this.dirty=!0,this.fovRecompute=!0,this.map=new y.Console(o,i,()=>!0),this.lastEntityId=0,this.entities=new N(Rt),this.overlays=new Map,this.eventCallbacks=Ht(Ft.map(n=>[n,[]])),jt(this)}get player(){let t=this.entities.get().find(o=>o.player);if(!t)throw new Error("Could not find a player!");return t}fire(t,o){for(let i of this.eventCallbacks[t])i(o)}on(t,o){this.eventCallbacks[t].push(o)}spawn(t){return st(this,t)}add(t){return this.dirty=!0,this.entities.add(t),this.fire("spawn",{e:t}),t}kill(t,o){t.alive&&(t.kill(o),this.fire("kill",{e:t,by:o}))}move(t,o){let i=t.position;t.move(o.x,o.y),i&&this.fire("move",{e:t,old:i,pos:o})}gotoDemoRoom(){this.entities.clear(),this.map.clear(),this.room(1,1,40,30),this.spawn("Player").move(5,25),this.spawn("Battleship").move(8,5)}room(t,o,i,n){let{map:r}=this;for(let s=0;s<n;s++)for(let a=0;a<i;a++){let l=a===0||s===0||a===i-1||s===n-1,m=t+a,p=o+s;r.setBlocked(m,p,l),r.setBlockedSight(m,p,l)}}drawIfVisible(t,o,i,n,r,s){this.map.isVisible(t,o)&&(s?this.term.drawCell(t,o,{bg:r},s):this.term.drawChar(t,o,i,n,r))}draw(){let{map:t,mapWidth:o,mapHeight:i,player:n,term:r}=this;this.fovRecompute&&(t.computeFov(n.position.x,n.position.y,n.player.visionRange),this.fovRecompute=!1);for(let s=0;s<i;s++)for(let a=0;a<o;a++){let l=t.grid[s][a],m=t.isVisible(a,s),p=l.blockedSight,f=y.Colors.BLACK;m?(f=p?y.Colors.WHITE:y.Colors.DARK_GRAY,l.explored=!0):l.explored&&(f=p?y.Colors.LIGHT_GRAY:y.Colors.BLACK),r.drawChar(a,s,0,0,f)}if(this.fire("draw",void 0),this.dirty=!1,this.showOverlay){let s=this.overlays.get(this.showOverlay);if(s)for(let a=0;a<i;a++)for(let l=0;l<o;l++){let m=s.get({x:l,y:a})||1/0,p=m===1/0?"-":m<10?`${m}`:"*";r.drawChar(l,a,p,y.Colors.LIGHT_RED)}}}getRoot(t){var i;let o=(i=t.owner)!=null?i:t;return o.attachment?this.getRoot(o.attachment.parent):o}getContents(t,o=[]){let i=k(t),n=this.map.isBlocked(i.x,i.y),r=this.entities.get().filter(a=>a.position&&H(i,a.position)),s=r.filter(a=>!o.includes(a.id)).find(a=>a.solid);return{wall:n,solid:s,other:r.filter(a=>!a.solid)}}tick(){this.overlays.clear(),this.fire("tick",void 0),this.entities.clearDead()}handleKeys(){let t=this.term.getMovementKey();if(t){this.fire("playerMove",{move:t});return}if(this.term.isKeyPressed(y.Key.VK_1)){this.fire("playerFire",{array:0});return}if(this.term.isKeyPressed(y.Key.VK_2)){this.fire("playerFire",{array:1});return}if(this.term.isKeyPressed(y.Key.VK_F)){Wt(this,B(this,this.player),4.5),this.tick();return}}update(){this.handleKeys(),this.dirty&&this.draw()}saveOverlay(t,o,i){this.overlays.set(`${t.id}.${o}`,i)}inBounds(t){return t.x>=0&&t.y>=0&&t.x<this.mapWidth&&t.y<this.mapHeight}getDistanceMap(t){let o=`${t.id}.distance`,i=this.overlays.get(o);return i||(i=Pt(R(this,t).map(n=>n.position).filter(vt),this.inBounds.bind(this)),this.overlays.set(o,i)),i}damage(t,o,i){let n=this.getRoot(t);n.hull&&(n.hull.hp-=o,console.log(i.name,"hits",n.name,"for",o),this.fire("damage",{e:n,inflicter:i,amount:o}),n.hull.hp<=0&&this.kill(n,i))}};var _t=P(E());function Ee(e){let i=document.createElement("div");e.appendChild(i);let n=()=>{let p=Math.floor(window.innerWidth/480),f=Math.floor(window.innerHeight/320),g=Math.min(p,f);i.style.width=`${480*g}px`,i.style.height=`${320*g}px`};window.addEventListener("resize",n),n();let r=document.createElement("canvas");i.appendChild(r),requestAnimationFrame(()=>r.focus());let s=new _t.Terminal(r,60,40),a=new W(s);a.gotoDemoRoom(),window.g=a}window.addEventListener("load",()=>Ee(document.body));})();
//# sourceMappingURL=bundle.js.map
