"use strict";(()=>{var bt=Object.create;var B=Object.defineProperty;var gt=Object.getOwnPropertyDescriptor;var wt=Object.getOwnPropertyNames,nt=Object.getOwnPropertySymbols,vt=Object.getPrototypeOf,st=Object.prototype.hasOwnProperty,Mt=Object.prototype.propertyIsEnumerable;var rt=(e,t,i)=>t in e?B(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,y=(e,t)=>{for(var i in t||={})st.call(t,i)&&rt(e,i,t[i]);if(nt)for(var i of nt(t))Mt.call(t,i)&&rt(e,i,t[i]);return e};var At=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),M=(e,t)=>{for(var i in t)B(e,i,{get:t[i],enumerable:!0})},Pt=(e,t,i,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of wt(t))!st.call(e,r)&&r!==i&&B(e,r,{get:()=>t[r],enumerable:!(o=gt(t,r))||o.enumerable});return e};var x=(e,t,i)=>(i=e!=null?bt(vt(e)):{},Pt(t||!e||!e.__esModule?B(i,"default",{value:e,enumerable:!0}):i,e));var E=At((Kt,at)=>{at.exports=globalThis.wglt});var b=x(E());var m=class{constructor(t,i){this.g=t;this.name=i;this.alive=!0,this.id=++t.lastEntityId,this.player=!1,this.projectile=!1,this.solid=!1}get[Symbol.toStringTag](){return this.name}kill(){return this.alive=!1,this.eachChild(t=>this.g.delete(t)),this}eachChild(t){var i;for(let o of this.g.entities.get())((i=o.attachment)==null?void 0:i.parent)===this&&t(o,o.attachment)}setAppearance(t){return this.g.dirty=!0,this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setPosition(t){return this.g.dirty=!0,this.position=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,i){return this.g.dirty=!0,this.position={x:t,y:i},this.eachChild((o,r)=>o.move(t+r.x,i+r.y)),this.position}};function lt(e,t){var r,n,s,a;let i=(n=(r=e.appearance)==null?void 0:r.layer)!=null?n:0,o=(a=(s=t.appearance)==null?void 0:s.layer)!=null?a:0;return i!==o?i-o:e.id-t.id}var L={};M(L,{Battleship:()=>Tt,BattleshipHull:()=>Ct});var I=x(E());var mt=(n=>(n[n.Effect=0]="Effect",n[n.Ship=1]="Ship",n[n.Gun=2]="Gun",n[n.Bullet=3]="Bullet",n[n.Player=4]="Player",n))(mt||{}),u=mt;function Tt(e){let t=new m(e,"Battleship");return e.spawn("BattleshipHull").setAttachment({parent:t,x:1,y:0}),e.spawn("BattleshipHull").setAttachment({parent:t,x:2,y:0}),e.spawn("BattleshipHull").setAttachment({parent:t,x:0,y:1}),e.spawn("BattleshipHull").setAttachment({parent:t,x:1,y:1}),e.spawn("BattleshipHull").setAttachment({parent:t,x:2,y:1}),e.spawn("MachineGun").setAttachment({parent:t,x:0,y:1}),e.spawn("HomingMissileLauncher").setAttachment({parent:t,x:2,y:1}),t}function Ct(e){return new m(e,"BattleshipHull").setAppearance({glyph:"/",layer:u.Ship,fg:I.Colors.WHITE,bg:I.Colors.BROWN}).setSolid(!0)}var D={};M(D,{Bullet:()=>kt,HomingMissile:()=>Ht});var G=x(E());function kt(e){return new m(e,"Bullet").setProjectile(!0).setAppearance({glyph:".",layer:u.Bullet,fg:G.Colors.YELLOW})}function Ht(e){return new m(e,"HomingMissile").setProjectile(!0).setHoming({strength:.15,duration:10}).setTrail({effectPrefab:"SmokePuff"}).setExplodes({size:5,falloff:1}).setAppearance({glyph:"*",layer:u.Bullet,fg:G.Colors.DARK_RED})}var W={};M(W,{SmokePuff:()=>Bt});var R=x(E());function Bt(e){return new m(e,"SmokePuff").setAppearance({glyph:" ",layer:u.Effect,bg:(0,R.fromRgb)(100,100,100,50),blendMode:R.BlendMode.Add}).setLifetime({duration:2})}var q={};M(q,{HomingMissileLauncher:()=>St,MachineGun:()=>Rt});var K=x(E());var N=({bulletPrefab:e="Bullet",bulletVelocity:t=1,salvoCount:i=1,timeBetweenShots:o=1,timeBetweenSalvos:r=1})=>({bulletPrefab:e,bulletVelocity:t,salvoCount:i,timeBetweenShots:o,timeBetweenSalvos:r,timer:0,salvo:i});function Rt(e){return new m(e,"MachineGun").setAppearance({glyph:"o",layer:u.Gun,fg:K.Colors.WHITE}).setTurret(N({bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:5,timeBetweenShots:0,timeBetweenSalvos:12}))}function St(e){return new m(e,"HomingMissileLauncher").setAppearance({glyph:"o",layer:u.Gun,fg:K.Colors.YELLOW}).setTurret(N({bulletPrefab:"HomingMissile",bulletVelocity:1,salvoCount:1,timeBetweenSalvos:8}))}var Q={};M(Q,{Player:()=>Ft});var j=x(E());function Ft(e){return new m(e,"Player").setPlayer(!0).setSolid(!0).setAppearance({glyph:">",layer:u.Player,fg:j.Colors.WHITE,bg:j.Colors.DARK_RED})}var It=y(y(y(y(y({},L),D),W),q),Q);function Y(e,t){return e.add(It[t](e))}var A=class{constructor(t,i=[]){this.compareFn=t;this.entities=i;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}add(t){this.entities.push(t),this.dirty=!0}clearDead(){this.entities=this.entities.filter(t=>t.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var d=class{constructor(t,i){this.list=t;this.filter=i}matches(t){if(!t.alive)return!1;for(let i of this.filter)if(!t[i])return!1;return!0}forEach(t){for(let i of this.list.get())this.matches(i)&&t(i,i)}};function c(e){return typeof e=="undefined"?NaN:Math.floor(e)}function P(e){return{x:c(e.x),y:c(e.y)}}function pt(e,t){let i=P(e),o=P(t);return i.x===o.x&&i.y===o.y}function _(e){let t=new d(e.entities,["appearance","position"]);e.on("draw",()=>t.forEach(({appearance:i,position:o})=>e.drawAt(c(o.x),c(o.y),i.glyph,i.fg,i.bg,i.blendMode)))}var ft=x(E());var S=x(E());function w(e,t,i){return e*(1-i)+t*i}var T=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[i])=>t-i)}add(t,i){return this.points.push([t,i]),this.sort(),this}get(t){let[i,o]=this.points[0];if(t<=i)return(0,S.fromRgb)(...o);let[r,n]=this.points[this.points.length-1];if(t>=r)return(0,S.fromRgb)(...n);let s=this.points.findIndex(([xt])=>xt>t),[a,[l,p,f,h]]=this.points[s-1],[g,[k,F,v,Et]]=this.points[s],H=(t-a)/(g-a);return(0,S.fromRgb)(w(l,k,H),w(p,F,H),w(f,v,H),w(h,Et,H))}};function V(e,t){let i=Math.abs(e.x-t.x),o=Math.abs(e.y-t.y);return Math.sqrt(i*i+o*o)}var Lt={fire:new T([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function O(e){if(!(e.intensity<=0))return{glyph:" ",layer:u.Effect,bg:Lt[e.type].get(e.intensity),blendMode:ft.BlendMode.Add}}function dt(e,t){let i=[],o=Math.floor(e.x-t),r=Math.ceil(e.x+t),n=Math.floor(e.y-t),s=Math.ceil(e.y+t);for(let a=n;a<=s;a++)for(let l=o;l<=r;l++){let p=V(e,{x:l,y:a});p>=t||i.push({x:l,y:a,intensity:t-p})}return i}function X(e){e.on("kill",({e:t})=>{let{explodes:i,name:o,position:r}=t;if(i&&r)for(let{x:n,y:s,intensity:a}of dt(r,i.size))e.add(new m(e,o+"Explosion").setPosition({x:n,y:s}).setField({type:"fire",intensity:a,falloff:i.falloff}))})}function $(e){let t=new d(e.entities,["field","position"]);e.on("tick",()=>t.forEach(({field:i},o)=>{i.intensity-=i.falloff,o.setAppearance(O(i)),i.intensity<=0&&e.delete(o)})),e.on("spawn",({e:i})=>{i.field&&i.setAppearance(O(i.field))})}var ut=Math.PI*2;function J(e,t){let i=(e-t)%ut,o=(t-e)%ut;return i<o?-i:o}function U(e){let t=new d(e.entities,["homing","motion","position"]);e.on("tick",()=>t.forEach(({homing:i,motion:o,position:r},n)=>{let s=Math.atan2(e.player.position.y-r.y,e.player.position.x-r.x),a=J(o.angle,s);Math.abs(a)<=i.strength?o.angle=s:a<0?o.angle-=i.strength:o.angle+=i.strength,--i.duration<=0&&(n.setHoming(),n.setTrail())}))}function Z(e){let t=new d(e.entities,["lifetime"]);e.on("tick",()=>t.forEach(({lifetime:i},o)=>{--i.duration<=0&&e.delete(o)}))}function z(e){let t=Math.cos(e.angle)*e.vel,i=Math.sin(e.angle)*e.vel;return[t,i]}function ct(e,t){let i=t.x-e.x,o=t.y-e.y,r=Math.abs(i),n=Math.abs(o),s=i>0?1:-1,a=o>0?1:-1,l=y({},e),p=[y({},l)];for(let f=0,h=0;f<r||h<n;)(.5+f)/r<(.5+h)/n?(l.x+=s,f++):(l.y+=a,h++),p.push(y({},l));return p}function tt(e){let t=new d(e.entities,["motion","position"]);e.on("tick",()=>t.forEach(({motion:i,position:o,explodes:r,ignoreSolid:n},s)=>{let[a,l]=z(i),p={x:o.x+a,y:o.y+l},f=ct(P(o),P(p)),h=!1,g;for(let k of f){e.move(s,k);let{wall:F,solid:v}=e.getContents(k);if(F){h=!0;break}else if(v&&!(n!=null&&n.ids.includes(e.getRootID(v)))){g=v;break}}h||g?e.delete(s):e.move(s,p)}))}function et(e){e.on("move",({e:t,old:i,pos:o})=>{t.trail&&!pt(i,o)&&e.spawn(t.trail.effectPrefab).setPosition(i)})}function it(e){return e.timer?(e.timer--,e.timer<=0&&e.salvo<=0&&(e.salvo=e.salvoCount),!1):(--e.salvo<=0?e.timer=e.timeBetweenSalvos:e.timer=e.timeBetweenShots,!0)}function ot(e){let t=new d(e.entities,["position","turret"]);e.on("tick",()=>t.forEach(({position:i,turret:o},r)=>{it(o)&&e.spawn(o.bulletPrefab).setIgnoreSolid({ids:[e.getRootID(r)]}).setPosition({x:i.x+.5,y:i.y+.5}).setMotion({angle:Math.atan2(e.player.position.y-i.y,e.player.position.x-i.x),vel:o.bulletVelocity})}))}function ht(e){Z(e),U(e),ot(e),$(e),tt(e),_(e),et(e),X(e)}var Gt=60,Dt=40,C=class{constructor(t,i=Gt,o=Dt){this.term=t;this.mapWidth=i;this.mapHeight=o;t.update=this.update.bind(this),this.dirty=!0,this.fovRecompute=!0,this.map=new b.Console(i,o,()=>!0),this.lastEntityId=0,this.entities=new A(lt),this.eventCallbacks={draw:[],kill:[],move:[],spawn:[],tick:[]},ht(this)}get player(){let t=this.entities.get().find(i=>i.player);if(!t)throw new Error("Could not find a player!");return t}fire(t,i){for(let o of this.eventCallbacks[t])o(i)}on(t,i){this.eventCallbacks[t].push(i)}spawn(t){return Y(this,t)}add(t){return this.dirty=!0,this.entities.add(t),this.fire("spawn",{e:t}),t}delete(t){t.alive&&(t.kill(),this.fire("kill",{e:t}))}move(t,i){let o=t.position;t.move(i.x,i.y),o&&this.fire("move",{e:t,old:o,pos:i})}gotoDemoRoom(){this.entities.clear(),this.map.clear(),this.room(1,1,40,30),this.spawn("Player").move(5,25),this.spawn("Battleship").move(8,5)}room(t,i,o,r){let{map:n}=this;for(let s=0;s<r;s++)for(let a=0;a<o;a++){let l=a===0||s===0||a===o-1||s===r-1,p=t+a,f=i+s;n.setBlocked(p,f,l),n.setBlockedSight(p,f,l)}}drawAt(t,i,o,r,n,s){this.map.isVisible(t,i)&&(s?this.term.drawCell(t,i,{bg:n},s):this.term.drawChar(t,i,o,r,n))}draw(){let{map:t,mapWidth:i,mapHeight:o,player:r}=this;this.fovRecompute&&(t.computeFov(r.position.x,r.position.y,20),this.fovRecompute=!1);for(let n=0;n<o;n++)for(let s=0;s<i;s++){let a=t.grid[n][s],l=t.isVisible(s,n),p=a.blockedSight,f=b.Colors.BLACK;l?(f=p?b.Colors.WHITE:b.Colors.DARK_GRAY,a.explored=!0):a.explored&&(f=p?b.Colors.LIGHT_GRAY:b.Colors.BLACK),this.drawAt(s,n,0,0,f)}this.fire("draw",void 0),this.dirty=!1}getRootID(t){return t.attachment?this.getRootID(t.attachment.parent):t.id}getContents(t){let i={x:c(t.x),y:c(t.y)},o=this.map.isBlocked(i.x,i.y),r=this.entities.get().filter(s=>{var a,l;return c((a=s.position)==null?void 0:a.x)===i.x&&c((l=s.position)==null?void 0:l.y)==i.y}),n=r.find(s=>s.solid);return{wall:o,solid:n,other:r.filter(s=>!s.solid)}}tick(){this.fire("tick",void 0),this.entities.clearDead()}handleKeys(){let{map:t,player:i,term:o}=this,r=o.getMovementKey();if(r){let n=i.position.x+r.x,s=i.position.y+r.y;t.isBlocked(n,s)||(i.move(n,s),this.fovRecompute=!0,this.tick())}}update(){this.handleKeys(),this.dirty&&this.draw()}};var yt=x(E());function Wt(e){let o=document.createElement("div");e.appendChild(o);let r=()=>{let f=Math.floor(window.innerWidth/480),h=Math.floor(window.innerHeight/320),g=Math.min(f,h);o.style.width=`${480*g}px`,o.style.height=`${320*g}px`};window.addEventListener("resize",r),r();let n=document.createElement("canvas");o.appendChild(n);let s=new yt.Terminal(n,60,40),a=new C(s);a.gotoDemoRoom(),window.g=a}window.addEventListener("load",()=>Wt(document.body));})();
//# sourceMappingURL=bundle.js.map
