"use strict";(()=>{var sa=Object.create;var md=Object.defineProperty,Va=Object.defineProperties,Na=Object.getOwnPropertyDescriptor,qa=Object.getOwnPropertyDescriptors,ka=Object.getOwnPropertyNames,z0=Object.getOwnPropertySymbols,ga=Object.getPrototypeOf,W0=Object.prototype.hasOwnProperty,ma=Object.prototype.propertyIsEnumerable;var v0=(a,d,e)=>d in a?md(a,d,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[d]=e,s=(a,d)=>{for(var e in d||={})W0.call(d,e)&&v0(a,e,d[e]);if(z0)for(var e of z0(d))ma.call(d,e)&&v0(a,e,d[e]);return a},w0=(a,d)=>Va(a,qa(d));var oa=(a,d)=>()=>(d||a((d={exports:{}}).exports,d),d.exports),ed=(a,d)=>{for(var e in d)md(a,e,{get:d[e],enumerable:!0})},ya=(a,d,e,L)=>{if(d&&typeof d=="object"||typeof d=="function")for(let P of ka(d))!W0.call(a,P)&&P!==e&&md(a,P,{get:()=>d[P],enumerable:!(L=Na(d,P))||L.enumerable});return a};var I=(a,d,e)=>(e=a!=null?sa(ga(a)):{},ya(d||!a||!a.__esModule?md(e,"default",{value:a,enumerable:!0}):e,a));var R=oa((ML,_0)=>{_0.exports=globalThis.wglt});var a0=I(R());var d0=I(R());function Qd(a,d=new Map){if(!a||typeof a!="object")return a;if(d.has(a))return d.get(a);let e;if(a.nodeType&&"cloneNode"in a)e=a.cloneNode(!0),d.set(a,e);else if(a instanceof Date)e=new Date(a.getTime()),d.set(a,e);else if(a instanceof RegExp)e=new RegExp(a),d.set(a,e);else if(Array.isArray(a)){e=new Array(a.length),d.set(a,e);for(let L=0;L<a.length;L++)e[L]=Qd(a[L],d)}else if(a instanceof Map){e=new Map,d.set(a,e);for(let[L,P]of a.entries())e.set(L,Qd(P,d))}else if(a instanceof Set){e=new Set,d.set(a,e);for(let L of a)e.add(Qd(L,d))}else if(a instanceof Object){e={},d.set(a,e);for(let[L,P]of Object.entries(a))e[L]=Qd(P,d)}else throw Error(`Unable to clone ${a}`);return e}function da(a){return Qd(a,new Map)}var y=da,aa=Object.keys,ea=a=>{let d={};for(let[e,L]of a)d[e]=L;return d};var Hd=class{constructor(d,e){this.g=d;this.name=e;this.alive=!0,this.id=++d.lastEntityId,this.solid=!1,this.tags=new Set}applyPrefab(d,e){if(this.prefab=d,e.components&&Object.assign(this,y(e.components)),e.children)for(let{name:L,x:P,y:$,overlay:D,tags:H}of e.children){let i=this.g.spawn(L).setAttachment({parent:this,x:P,y:$});if(D)for(let b of aa(D))Object.assign(i[b],y(D[b]));if(H)for(let b of H)i.tags.add(b)}return this}get[Symbol.toStringTag](){return this.name}kill(d){return this.alive=!1,this.eachChild(e=>this.g.kill(e,d)),this}eachChild(d){var e;for(let L of this.g.entities.get())((e=L.attachment)==null?void 0:e.parent)===this&&d(L,L.attachment)}setAI(d){return this.ai=d,this}setAppearance(d){return this.g.refresh(),this.appearance=d,this}setAttachment(d){return this.attachment=d,this}setDelayedShot(d){return this.delayedShot=d,this}setDoubleShot(d){return this.doubleShot=d,this}setExplodes(d){return this.explodes=d,this}setField(d){return this.field=d,this}setHoming(d){return this.homing=d,this}setIgnoreSolid(d){return this.ignoreSolid=d,this}setItem(d){return this.item=d,this}setLastMovement(d){return this.lastMovement=d,this}setLifetime(d){return this.lifetime=d,this}setMotion(d){return this.motion=d,this}setOrigin(d){return this.origin=d,this}setPilot(d){return this.pilot=d,this}setPosition(d){return this.g.refresh(),this.position=d,this}setShip(d){return this.ship=d,this}setTrail(d){return this.trail=d,this}setTurret(d){return this.turret=d,this}setPlayer(d){return this.player=d,this}setProjectile(d){return this.projectile=d,this}setSolid(d){return this.solid=d,this}move(d,e){return this.g.refresh(),this.position={x:d,y:e},this.eachChild((L,P)=>L.move(d+P.x,e+P.y)),this}};function La(a,d){var P,$,D,H;let e=($=(P=a.appearance)==null?void 0:P.layer)!=null?$:0,L=(H=(D=d.appearance)==null?void 0:D.layer)!=null?H:0;return e!==L?e-L:a.id-d.id}var Pa=["damage","draw","kill","move","notice","playerBomb","playerFire","playerMove","spawn","tick","waveBegin","waveNext"];var e0={};ed(e0,{AcidBullet:()=>va,BellowMissile:()=>Pe,Bullet:()=>ua,CrushBullet:()=>wa,DroneBullet:()=>Oa,HomingMissile:()=>de,OutcryBullet:()=>za,PlayerBullet:()=>$e,SalvoMissileA:()=>ae,SalvoMissileB:()=>ee,SalvoMissileC:()=>Le,SmiteMissile:()=>_a,TalonBullet:()=>Wa});var V=I(R());var Ga={Heart:"",Diamond:"",Club:"",Dot:"\x07",Ring:"	",RingInvert:`
`,Male:"\v",Female:"\f",DoubleNote:"",Star:"",Pilcrow:"",Silcrow:"",ResizeVertical:"",UpArrow:"",DownArrow:"",RightArrow:"",LeftArrow:"\x1B",DownWedge:"",Pentagon:"\x7F",AHat:"\x83",EHat:"\x88",CapitalUUmlaut:"\x9A",Cent:"\x9B",Yen:"\x9D",CurlyF:"\x9F",NotFlip:"\xA9",Not:"\xAA",InvertedExclamation:"\xAD",Fill1:"\xB0",Fill2:"\xB1",Fill3:"\xB2",BoxVerticalSingle:"\xB3",BoxLeftSingleUpDouble:"\xBD",BoxUpSingleHorizontalSingle:"\xC1",BoxDownSingleHorizontalSingle:"\xC2",BoxHorizontalSingle:"\xC4",BoxUpDoubleHorizontalSingle:"\xD0",BoxDownSingleHorizontalDouble:"\xD1",BoxRightSingleUpDouble:"\xD3",BoxVerticalDoubleHorizontalSingle:"\xD7",Filled:"\xDB",Beta:"\xE1",Gamma:"\xE2",Pi:"\xE3",Theta:"\xE9",Omega:"\xEA",SymbolED:"\xED",SetMember:"\xEE",HorizontalDivide:"\xF6",Approximates:"\xF7",Squared:"\xFD",Square:"\xFE"},h=Ga;var $a=(H=>(H[H.Effect=0]="Effect",H[H.Item=1]="Item",H[H.Ship=2]="Ship",H[H.Gun=3]="Gun",H[H.Bullet=4]="Bullet",H[H.Player=5]="Player",H[H.PlayerBullet=6]="PlayerBullet",H))($a||{}),t=$a;var ua={components:{projectile:{damage:1,scaling:{stat:"body",multiplier:1}},appearance:{glyph:h.InvertedExclamation,layer:t.Bullet,fg:V.Colors.YELLOW}}},Oa={components:{projectile:{damage:1,scaling:{stat:"body",multiplier:1}},appearance:{glyph:".",layer:t.Bullet,fg:V.Colors.ORANGE}}},za={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:"o",layer:t.Bullet,fg:(0,V.fromRgb)(255,55,135)}}},va={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:h.Approximates,layer:t.Bullet,fg:(0,V.fromRgb)(55,55,215)}}},Wa={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:"`",layer:t.Bullet,fg:(0,V.fromRgb)(135,255,55)}}},wa={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},homing:{strength:1,duration:3},appearance:{glyph:h.Square,layer:t.Bullet,fg:(0,V.fromRgb)(175,175,0)}}},_a={components:{projectile:{damage:2,scaling:{stat:"mind",multiplier:1}},homing:{strength:10,duration:1},explodes:{size:7,type:"Fire",falloff:1},appearance:{glyph:"*",layer:t.Bullet,fg:V.Colors.ORANGE}}},de={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:t.Bullet,fg:V.Colors.DARK_RED}}},ae={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:4},trail:{effectPrefab:"SmokePuff"},explodes:{size:8,type:"Fire",falloff:1},appearance:{glyph:"*",layer:t.Bullet,fg:V.Colors.DARK_RED}}},ee={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.25,duration:5},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:t.Bullet,fg:V.Colors.DARK_RED}}},Le={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.35,duration:8},trail:{effectPrefab:"SmokePuff"},explodes:{size:4,type:"Fire",falloff:1},appearance:{glyph:"*",layer:t.Bullet,fg:V.Colors.DARK_RED}}},Pe={components:{projectile:{damage:20,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:30},trail:{effectPrefab:"SmokePuff"},explodes:{size:6,type:"Fire",falloff:1},appearance:{glyph:h.CurlyF,layer:t.Bullet,fg:V.Colors.LIGHT_RED}}},$e={components:{projectile:{damage:3,scaling:{stat:"body",multiplier:1}},appearance:{glyph:"!",layer:t.PlayerBullet,fg:V.Colors.YELLOW}}};var L0={};ed(L0,{AirFistRange:()=>De,SmokePuff:()=>He});var Td=I(R());var De={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:t.Effect,bg:(0,Td.fromRgb)(0,255,255,100),blendMode:Td.BlendMode.Add}}},He={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:t.Effect,bg:(0,Td.fromRgb)(100,100,100,50),blendMode:Td.BlendMode.Add}}};var P0={};ed(P0,{AcidSplash:()=>Xe,Bellow:()=>Re,Cleave:()=>Ae,CrushPattern:()=>Ce,DemandHomage:()=>Ie,DroneGun:()=>te,Outcry:()=>fe,PeaShooter:()=>be,PlayerGun:()=>he,Salvo:()=>Je,ShuttleLaunch:()=>ce,Smite:()=>Fe,TalonSwipe:()=>Te,TheDragonWakes:()=>re,Veto:()=>pe});var A=(a,d,e,L,P)=>({name:a,x:d,y:e,overlay:L,tags:P}),U=(a,d,e,L=0)=>({name:a,type:d,maxHp:e,hp:0,maxShield:L,shield:0,shieldTimer:0}),n=(a,{salvoCount:d=1,timeBetweenShots:e=1,timeBetweenSalvos:L=1,ammunition:P=1/0},$)=>({name:a,shots:$,salvoCount:d,timeBetweenShots:e,timeBetweenSalvos:L,timer:0,salvo:d,ammunition:P}),X=(a,d,e,L,{canDouble:P,delay:$,offset:D,beam:H}={})=>({type:"bullet",canDouble:P,name:a,prefab:d,angle:e,vel:L,delay:$,offset:D,beam:H}),m=(a,{delay:d,offset:e}={})=>({type:"array",canDouble:!1,tag:a,delay:d,offset:e});var id=Math.PI/2,od=id/2,ie={Right:0,DownRight:od,Down:id,DownLeft:id+od,Left:id*2,UpLeft:id*2+od,Up:id*3,UpRight:id*3+od},c=ie;function G(a){return typeof a=="undefined"?NaN:Math.floor(a)}var p=(a,d)=>({x:a,y:d});function l(a){return p(G(a.x),G(a.y))}function v(a,d){if(typeof a=="undefined"||typeof d=="undefined")return!1;let e=l(a),L=l(d);return e.x===L.x&&e.y===L.y}function j(a,d){return p(a.x+d.x,a.y+d.y)}var Be={Right:p(1,0),DownRight:p(1,1),Down:p(0,1),DownLeft:p(-1,1),Left:p(-1,0),UpLeft:p(-1,-1),Up:p(0,-1),UpRight:p(1,-1),None:p(0,0)},N=Be;var be={components:{turret:n("Main Gun",{salvoCount:1,timeBetweenSalvos:3},[X("Bullet","Bullet",c.Down,2,{canDouble:!0})])}},he={components:{turret:n("Main Gun",{salvoCount:2,timeBetweenShots:0,timeBetweenSalvos:3},[X("Your Bullet","PlayerBullet",c.Up,2,{canDouble:!0})])}},Ae={components:{turret:n("Cleave",{salvoCount:1,timeBetweenSalvos:11},[m("Primary"),m("Primary",{delay:1}),m("Primary",{delay:2}),m("Primary",{delay:3}),m("Primary",{delay:4})])}},fe={components:{turret:n("Outcry",{salvoCount:1,timeBetweenSalvos:8},[X("Outcry","OutcryBullet",c.DownLeft,2),X("Outcry","OutcryBullet",c.Left,2),X("Outcry","OutcryBullet",c.UpLeft,2),X("Outcry","OutcryBullet",c.Up,2),X("Outcry","OutcryBullet",c.UpRight,2),X("Outcry","OutcryBullet",c.Right,2),X("Outcry","OutcryBullet",c.DownRight,2)])}},Xe={components:{turret:n("Acid Splash",{salvoCount:1,timeBetweenSalvos:13},[X("Acid Splash","AcidBullet",c.UpLeft,2),X("Acid Splash","AcidBullet",c.UpRight,2),X("Acid Splash","AcidBullet",c.Left,2,{delay:1}),X("Acid Splash","AcidBullet",c.Right,2,{delay:1}),X("Acid Splash","AcidBullet",c.DownLeft,2,{delay:2}),X("Acid Splash","AcidBullet",c.DownRight,2,{delay:2}),X("Acid Splash","AcidBullet",c.Left,2,{delay:3}),X("Acid Splash","AcidBullet",c.Right,2,{delay:3}),X("Acid Splash","AcidBullet",c.UpLeft,2,{delay:4}),X("Acid Splash","AcidBullet",c.UpRight,2,{delay:4})])}},ce={components:{turret:n("Shuttle Launch",{salvoCount:1,timeBetweenSalvos:27},[X("Runabout","DroneA",c.Left,0,{offset:N.Left}),X("Runabout","DroneA",c.Right,0,{offset:N.Right})])}},pe={components:{turret:n("Veto",{salvoCount:1,timeBetweenSalvos:21},[X("Veto","HomingMissile",c.Up,1),X("Wasp","DroneB",c.DownRight,0,{offset:N.DownRight})])}},Te={components:{turret:n("Talon Swipe",{salvoCount:1,timeBetweenSalvos:10},[X("Talon Swipe","TalonBullet",c.Left,2),X("Talon Swipe","TalonBullet",c.Right,2),X("Talon Swipe","TalonBullet",c.Left,2,{delay:1}),X("Talon Swipe","TalonBullet",c.Right,2,{delay:1}),X("Talon Swipe","TalonBullet",c.Left,2,{delay:2}),X("Talon Swipe","TalonBullet",c.Right,2,{delay:2})])}},Ce={components:{turret:n("Crush Pattern",{salvoCount:1,timeBetweenSalvos:15},[X("Crush Pattern","CrushBullet",c.Left,1),X("Crush Pattern","CrushBullet",c.UpLeft,1),X("Crush Pattern","CrushBullet",c.UpRight,1),X("Crush Pattern","CrushBullet",c.Right,1)])}},Fe={components:{turret:n("Smite",{salvoCount:1,timeBetweenSalvos:16},[X("Smite","SmiteMissile",c.Right,1),X("Smite","SmiteMissile",c.Right,1,{delay:1})])}},te={components:{turret:n("Stinger",{salvoCount:1,timeBetweenSalvos:5,ammunition:5},[X("Bullet","DroneBullet","nearestEnemy",1,{canDouble:!0})])}},Je={components:{turret:n("Salvo",{salvoCount:1,timeBetweenSalvos:10},[X("Missile","SalvoMissileA",c.UpLeft,1),X("Missile","SalvoMissileB",c.UpLeft,1),X("Missile","SalvoMissileC",c.UpLeft,1)])}},re={components:{turret:n("The Dragon Wakes",{salvoCount:1,timeBetweenSalvos:12},[X("Drone","DroneA",c.Up,0,{offset:N.Up}),X("Missile","HomingMissile",c.DownLeft,2,{offset:N.DownLeft}),X("Missile","HomingMissile",c.DownRight,2,{offset:N.DownRight})])}},Re={components:{turret:n("Bellow",{salvoCount:1,timeBetweenSalvos:17},[X("Bellow","BellowMissile",c.DownLeft,1),m("Primary"),m("Primary",{delay:1}),m("Primary",{delay:2}),m("Primary",{delay:3})])}},Ie={components:{turret:n("Demand Homage",{salvoCount:1,timeBetweenSalvos:21},[X("Pulsar","DroneC",c.DownLeft,0,{offset:N.DownLeft}),X("Pulsar","DroneC",c.UpLeft,0,{offset:N.UpLeft}),X("Pulsar","DroneC",c.UpRight,0,{offset:N.UpRight}),X("Pulsar","DroneC",c.DownRight,0,{offset:N.DownRight})])}};var $0={};ed($0,{BombItem:()=>Qe,DoubleItem:()=>Me,DrainItem:()=>Ee,HealItem:()=>Se,JunkItem:()=>ne,MoneyItem:()=>Ue,RechargeItem:()=>Ye});var Qe={components:{appearance:{glyph:h.DoubleNote,layer:t.Item},item:{type:"bomb",prefab:"BombItem"}}},Me={components:{appearance:{glyph:h.Squared,layer:t.Item},item:{type:"double"}}},Ee={components:{appearance:{glyph:"%",layer:t.Item},item:{type:"drain"}}},Se={components:{appearance:{glyph:h.Heart,layer:t.Item},item:{type:"heal"}}},ne={components:{appearance:{glyph:h.Beta,layer:t.Item},item:{type:"junk"}}},Ue={components:{appearance:{glyph:h.SetMember,layer:t.Item},item:{type:"money",value:0}}},Ye={components:{appearance:{glyph:"@",layer:t.Item},item:{type:"recharge"}}};var H0={};ed(H0,{PlayerHull:()=>je,PlayerShip:()=>Ke});var D0=I(R());var je={components:{solid:!0,appearance:{glyph:"#",layer:t.Player,fg:D0.Colors.DARK_GRAY}}},Ke={components:{player:{weaponArrays:["Primary","Secondary"],bombs:[]},ship:U("Ace of Clubs","Player",20,10),explodes:{type:"Fire",size:6,falloff:1}},children:[A("PlayerHull",0,0,{appearance:{glyph:h.LeftArrow}}),A("PlayerHull",1,0,{appearance:{glyph:h.Club,fg:D0.Colors.LIGHT_GRAY}}),A("PlayerHull",2,0,{appearance:{glyph:h.RightArrow}}),A("PlayerGun",1,0,void 0,["Primary"]),A("Sword",1,0,void 0,["Secondary"])]};var b0={};ed(b0,{AtomSmasher:()=>We,CruiseyWing:()=>Ge,Demigod:()=>ze,DroneA:()=>me,DroneB:()=>oe,DroneC:()=>ye,GoutOFlame:()=>Oe,Gremlin:()=>ve,Hull:()=>xe,Olm:()=>ue,ShipA:()=>Ze,ShipB:()=>le,ShipC:()=>se,ShipD:()=>Ve,ShipE:()=>Ne,ShipF:()=>qe,ShipG:()=>ke,ShipH:()=>ge});var Da=I(R());var xe={components:{solid:!0,appearance:{glyph:"#",layer:t.Ship,fg:Da.Colors.DARK_GRAY}}},k={idealDistance:8,firingDistance:14,speed:1},W=A("PeaShooter",0,0,void 0,["Primary"]),Ld={type:"Fire",size:4,falloff:1},Ze={components:{ai:k,ship:U("Axle","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:h.Pilcrow}}),W,A("Cleave",0,0,void 0,["Special"])]},le={components:{ai:k,ship:U("Baying Hound","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:h.Yen}}),W,A("Outcry",0,0,void 0,["Special"])]},se={components:{ai:k,ship:U("Caustic","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:"W"}}),W,A("AcidSplash",0,0,void 0,["Special"])]},Ve={components:{ai:k,ship:U("Defiant","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:h.Omega}}),W,A("ShuttleLaunch",0,0,void 0,["Special"])]},Ne={components:{ai:k,ship:U("Executor","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:h.DownWedge}}),W,A("Veto",0,0,void 0,["Special"])]},qe={components:{ai:k,ship:U("Falcon","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:h.Pi}}),W,A("TalonSwipe",0,0,void 0,["Special"])]},ke={components:{ai:k,ship:U("Gauntlet","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:"M"}}),W,A("CrushPattern",0,0,void 0,["Special"])]},ge={components:{ai:k,ship:U("Halo","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:h.Female}}),W,A("Smite",0,0,void 0,["Special"])]},i0={idealDistance:5,firingDistance:6,speed:1},Ha=A("DroneGun",0,0,void 0,["Primary"]),B0={type:"Fire",size:3,falloff:1},me={components:{ai:i0,ship:U("Runabout","Escort",1),explodes:B0},children:[A("Hull",0,0,{appearance:{glyph:h.Theta}}),W]},oe={components:{ai:i0,ship:U("Wasp","Escort",1),explodes:B0},children:[A("Hull",0,0,{appearance:{glyph:h.SymbolED}}),Ha]},ye={components:{ai:i0,ship:U("Pulsar","Escort",1),explodes:B0},children:[A("Hull",0,0,{appearance:{glyph:h.Silcrow}}),Ha]},Cd={type:"Fire",size:6,falloff:1},Ge={components:{ai:k,ship:U("Cruisey Wing","Battleship",10,5),explodes:Cd},children:[A("Hull",0,0,{appearance:{glyph:h.Not}}),A("Hull",1,0,{appearance:{glyph:h.HorizontalDivide}}),A("Hull",2,0,{appearance:{glyph:h.NotFlip}}),A("PeaShooter",0,0,void 0,["Primary"]),A("PeaShooter",1,0,void 0,["Primary"]),A("PeaShooter",2,0,void 0,["Primary"]),A("Salvo",1,0,void 0,["Special"])]},ue={components:{ai:k,ship:U("Olm","Battleship",15,4),explodes:Cd},children:[A("Hull",0,0,{appearance:{glyph:h.Cent}}),A("Hull",0,1,{appearance:{glyph:h.ResizeVertical}}),A("Hull",0,2,{appearance:{glyph:h.BoxDownSingleHorizontalDouble}}),A("PeaShooter",0,2,void 0,["Primary"]),A("TheDragonWakes",0,0,void 0,["Special"])]},Oe={components:{ai:k,ship:U("Gout-o'-flame","Battleship",5,20),explodes:Cd},children:[A("Hull",0,0,{appearance:{glyph:h.Pentagon}}),A("Hull",1,0,{appearance:{glyph:h.BoxVerticalDoubleHorizontalSingle}}),A("Hull",2,0,{appearance:{glyph:h.Pentagon}}),A("Hull",1,1,{appearance:{glyph:h.BoxUpDoubleHorizontalSingle}}),A("PeaShooter",1,1,void 0,["Primary"]),A("Bellow",1,1,void 0,["Special"])]},ze={components:{ai:k,ship:U("Demigod","Battleship",30,15),explodes:Cd},children:[A("Hull",1,0,{appearance:{glyph:h.CapitalUUmlaut}}),A("Hull",0,1,{appearance:{glyph:"}"}}),A("Hull",1,1,{appearance:{glyph:h.RingInvert}}),A("Hull",2,1,{appearance:{glyph:"{"}}),A("Hull",1,2,{appearance:{glyph:"Y"}}),A("PeaShooter",1,2,void 0,["Primary"]),A("DemandHomage",1,1,void 0,["Special"])]},ve={components:{ai:k,ship:U("Gremlin","Battleship",30,15),explodes:Cd},children:[A("Hull",1,0,{appearance:{glyph:h.ResizeVertical}}),A("Hull",2,0,{appearance:{glyph:h.ResizeVertical}}),A("Hull",0,1,{appearance:{glyph:"]"}}),A("Hull",1,1,{appearance:{glyph:h.BoxLeftSingleUpDouble}}),A("Hull",2,1,{appearance:{glyph:h.BoxRightSingleUpDouble}}),A("Hull",3,1,{appearance:{glyph:h.Male}}),A("Hull",1,2,{appearance:{glyph:h.BoxVerticalSingle}}),A("Hull",2,2,{appearance:{glyph:h.Gamma}}),A("PeaShooter",1,2,void 0,["Primary"]),A("PeaShooter",2,2,void 0,["Primary"])]},We={components:{ai:k,ship:U("Atom Smasher","Battleship",10,20),explodes:Cd},children:[A("Hull",1,0,{appearance:{glyph:h.EHat}}),A("Hull",2,0,{appearance:{glyph:"-"}}),A("Hull",3,0,{appearance:{glyph:h.AHat}}),A("Hull",0,1,{appearance:{glyph:h.Fill2}}),A("Hull",1,1,{appearance:{glyph:h.Fill1}}),A("Hull",2,1,{appearance:{glyph:h.Fill2}}),A("Hull",3,1,{appearance:{glyph:h.Fill3}}),A("Hull",4,1,{appearance:{glyph:h.Filled}}),A("PeaShooter",0,1,void 0,["Primary"]),A("PeaShooter",1,1,void 0,["Primary"]),A("PeaShooter",2,1,void 0,["Primary"]),A("PeaShooter",3,1,void 0,["Primary"]),A("PeaShooter",4,1,void 0,["Primary"])]};var h0={};ed(h0,{Laser:()=>aL,LaserBeam:()=>eL,Multiball:()=>_e,MultiballShot:()=>we,StubbornDescent:()=>dL});var Md=I(R());var we={components:{projectile:{damage:7},appearance:{glyph:"+",layer:t.Bullet,fg:(0,Md.fromRgb)(255,255,55)}}},_e={components:{turret:n("Multiball",{salvoCount:1,timeBetweenSalvos:15},[X("Multiball","MultiballShot",c.DownLeft,2),X("Multiball","MultiballShot",c.Left,2),X("Multiball","MultiballShot",c.Right,2),X("Multiball","MultiballShot",c.DownRight,2),X("Runabout","DroneA",c.UpLeft,0,{offset:N.UpLeft}),X("Runabout","DroneA",c.UpRight,0,{offset:N.UpRight})])}},dL={components:{turret:n("Stubborn Descent",{salvoCount:13,timeBetweenSalvos:21},[m("Primary")])}},aL={components:{projectile:{damage:2},appearance:{glyph:"|",layer:t.Bullet,fg:Md.Colors.WHITE,bg:Md.Colors.LIGHT_BLUE}}},eL={components:{turret:n("Laser Beam",{salvoCount:10,timeBetweenSalvos:30},[X("Laser","Laser",c.Down,1,{offset:N.Down,beam:{duration:1,appearance:new Array(60)}})])}};var A0={};ed(A0,{Sword:()=>PL,SwordBullet:()=>LL});var Bd=I(R());var LL={components:{projectile:{damage:5,special:"increasedDropChance",scaling:{stat:"spirit",multiplier:1}},appearance:{glyph:h.Star,layer:t.PlayerBullet,fg:Bd.Colors.LIGHT_GREEN}}},PL={components:{turret:n("Sword",{salvoCount:1,timeBetweenSalvos:20},[X("Stab","SwordBullet","lastMovement",1,{beam:{duration:2,appearance:[{glyph:h.Star,fg:Bd.Colors.LIGHT_GREEN},{glyph:"o",fg:Bd.Colors.LIGHT_GREEN},{glyph:h.Diamond,fg:Bd.Colors.LIGHT_GREEN},{glyph:h.Ring,fg:Bd.Colors.DARK_GREEN},{glyph:h.Dot,fg:Bd.Colors.DARK_GRAY}]}})])}};var ia=s(s(s(s(s(s(s(s({},e0),L0),$0),P0),H0),b0),h0),A0);function yd(a){return ia[a]}function f0(a,d){return a.add(new Hd(a,d).applyPrefab(d,ia[d]))}var Ed=class{constructor(d,e=[]){this.compareFn=d;this.entities=e;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}clearExceptFor(d){for(let e of this.entities)d.includes(e.id)||(e.alive=!1);this.clearDead()}add(d){this.entities.push(d),this.dirty=!0}clearDead(){this.entities=this.entities.filter(d=>d.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var E=I(R());var g=I(R());var Y=I(R());function $L(a,d){if(!d||!a.length)throw new Error("Could not get midpoint");let e=L=>a.reduce((P,{offset:$})=>P+$[L],0)/a.length;return p(d.x+e("x"),d.y+e("y"))}function DL(a,d,e,L=[]){let P=[];for(let{offset:$}of d){let D=j(e,$),{oob:H,wall:i,solid:b}=a.getContents(D,L);H?P.push({absolute:D,offset:$,entity:"oob"}):i?P.push({absolute:D,offset:$,entity:"wall"}):b&&P.push({absolute:D,offset:$,entity:b})}return P}function S(a,d){let e=a.getRoot(d);return a.entities.get().filter(L=>a.getRoot(L)===e)}function w(a,d){return S(a,d).map(e=>e.id)}function u(a,d){var H;let e=(H=a.getRoot(d).position)!=null?H:p(0,0),L=S(a,d),P=[],$=0,D=0;for(let i of L){let{attachment:b,solid:B}=i;if(b&&B){let{x:f,y:r}=b;P.push({absolute:j(e,b),offset:{x:f,y:r},entity:i}),$=Math.max(f+1,$),D=Math.max(r+1,D)}}return{layout:P,topLeft:e,width:$,height:D}}function Ba(a,d,e){let L=w(a,d),{layout:P,topLeft:$}=u(a,d);return!e||!$?[]:DL(a,P,e||$,L)}function Z(a,d){let{layout:e,topLeft:L}=u(a,d);if(!L||!e.length){if(d.position)return d.position;throw new Error(`Could not get midpoint of entity#${d.id}`)}return $L(e,L)}function ba(a,d,e,L,P){for(let $=0;$<P;$++)for(let D=0;D<L;D++){let{oob:H,wall:i,solid:b,other:B}=a.getContents({x:d+D,y:e+$});if(H||i||b||B.length)return!1}return!0}var M=class{constructor(d,e){this.list=d;this.filter=e}matches(d){if(!d.alive)return!1;for(let e of this.filter)if(!d[e])return!1;return!0}forEach(d){for(let e of this.list.get())this.matches(e)&&d(e,e)}};var X0=Math.PI*2;function Pd(a,d){return Math.atan2(d.y-a.y,d.x-a.x)}function ha(a,d){let e=(a-d)%X0,L=(d-a)%X0;return e<L?-e:L}function $d(a){let d=Math.cos(a.angle)*a.vel,e=Math.sin(a.angle)*a.vel;return[d,e]}function Aa(a){for(;a<0;)a+=X0;return a}var Qa=I(R());function bd(a,d){let e=Math.abs(a.x-d.x),L=Math.abs(a.y-d.y);return Math.sqrt(e*e+L*L)}function Gd(a,d,e){let{ship:L}=d;if(!L)throw new Error(`Cannot put pilot into entity ${d.name} (no ship)`);if(d.setPilot(e),L.maxHp+=HL(d),e.special){let P=Z(a,d);a.spawn(e.special).setAttachment(w0(s({},l(P)),{parent:d})).tags.add("Special")}}function Fd(a,d){return a.pilot?a.pilot[d]:0}function fa(a){return 7-Fd(a,"body")}function HL(a){return Fd(a,"body")*4}function Xa(a){return Fd(a,"mind")}function ca(a){return(Fd(a,"mind")-1)*5}var pa=($=>($[$.None=0]="None",$[$.Healthy=1]="Healthy",$[$.Double=2]="Double",$[$.Drain=4]="Drain",$[$.HasPilot=8]="HasPilot",$))(pa||{}),K=pa;var Ta=["Berserker","Chopter","Duelist","Engineer","Fighter","Negotiator","Psychic","Smuggler"];var q=I(R()),ud=[0,q.Colors.DARK_RED,q.Colors.BROWN,q.Colors.LIGHT_RED,q.Colors.ORANGE,q.Colors.YELLOW,q.Colors.WHITE],_={Typical:{fg:q.Colors.DARK_GRAY},Healthy:{fg:q.Colors.DARK_GREEN},Double:{fg:q.Colors.LIGHT_GRAY},Multi:{fg:q.Colors.DARK_MAGENTA},Drain:{fg:q.Colors.DARK_RED},StarPilot:{fg:q.Colors.YELLOW},Mega:{fg:q.Colors.BLACK,bg:q.Colors.DARK_MAGENTA}};function hd(a){return Math.random()*100<a}function c0(a,d=0){let e=[];for(let L=d;L<a;L++)e.push(L);return e}function x(a){if(!a.length)throw new Error("oneOf passed empty array");return a[Math.floor(Math.random()*a.length)]}function td(a){for(let d=a.length-1;d>0;d--){let e=Math.floor(Math.random()*(d+1));[a[d],a[e]]=[a[e],a[d]]}return a}function Od(a,...d){return a.filter(e=>!d.includes(e))}var C0={Typical:K.None,Healthy:K.Healthy,Double:K.Double,Multi:K.Healthy|K.Double,Drain:K.Drain,StarPilot:K.HasPilot,Mega:K.Healthy|K.Double|K.Drain|K.HasPilot},iL={Typical:"Fire",Healthy:"Green",Double:"Fire",Multi:"Magenta",Drain:"Fire",StarPilot:"Yellow",Mega:"Magenta"},p0=["ShipA","ShipB","ShipC","ShipD","ShipE","ShipF","ShipG","ShipH"],T0=["CruiseyWing","Olm","GoutOFlame","Demigod","Gremlin","AtomSmasher"],BL=[{name:"Let Fate Decide",difficulty:1,groups:[{count:7,type:"Escort",prefabs:p0},{count:1,type:"Battleship",prefabs:T0}]},{name:"Court Martial",difficulty:2,groups:[{count:5,type:"Escort",prefabs:["ShipA","ShipE"]},{count:1,type:"Battleship",prefabs:["CruiseyWing"]}]},{name:"Hellhounds",difficulty:3,groups:[{count:2,type:"Escort",prefabs:["ShipB"]},{count:2,type:"Battleship",prefabs:["GoutOFlame"]}]},{name:"Chaos",difficulty:4,groups:[{count:4,type:"Escort",prefabs:["ShipC"]},{count:4,type:"Escort",prefabs:Od(p0,"ShipC")},{count:1,type:"Battleship",prefabs:["Demigod"]}]},{name:"Fly in Formation",difficulty:4,groups:[{count:7,type:"Escort",prefabs:["ShipF"]},{count:1,type:"Battleship",prefabs:T0}]},{name:"Hark!",difficulty:6,groups:[{count:3,type:"Escort",prefabs:["ShipH"]},{count:3,type:"Escort",prefabs:Od(p0,"ShipH")},{count:1,type:"Battleship",prefabs:["Demigod"]}]},{name:"Caverns.com",difficulty:7,groups:[{count:1,type:"Escort",prefabs:["ShipA","ShipG"]},{count:3,type:"Battleship",prefabs:["Olm"]}]},{name:"Humanity to the Rescue",difficulty:8,groups:[{count:7,type:"Escort",prefabs:["ShipA","ShipD","ShipE","ShipG"]},{count:1,type:"Battleship",prefabs:["GoutOFlame"]}]},{name:"Wild Hunt",difficulty:9,groups:[{count:15,type:"Escort",prefabs:["ShipB","ShipF"]},{count:1,type:"Battleship",prefabs:["Olm"]}]},{name:"Arm Wrestling",difficulty:10,groups:[{count:9,type:"Escort",prefabs:["ShipG"]},{count:2,type:"Battleship",prefabs:["CruiseyWing"]}]},{name:"Valis",difficulty:11,groups:[{count:4,type:"Escort",prefabs:["ShipC"]},{count:4,type:"Escort",prefabs:["ShipH"]},{count:1,type:"Battleship",prefabs:T0}]}];function Ca(a=3){return td(BL.slice()).slice(0,a).sort((d,e)=>d.difficulty-e.difficulty)}function Fa(a,d){return hd(a)?d?"Mega":x(["Healthy","Double","Multi","Drain"]):d?"StarPilot":"Typical"}function bL(a){let d=y(a);for(;d.class.length<d.talent;)d.class.push(x(Ta.filter(e=>!d.class.includes(e))));return d}function ta(a,d,e,L){let P=C0[e];if(P&K.HasPilot&&!L)throw new Error(`power ${e} needs pilot, none given`);let $=a.spawn(d),{ship:D}=$;if(!D)throw new Error(`Ship prefab ${d} doesn't have a ship component!`);if(D.power=e,P&K.Healthy&&(D.maxHp=D.maxHp*2+3),L){let i=bL(L);Gd(a,$,i)}Sd(D);let H=_[e];for(let i of S(a,$))i.appearance&&Object.assign(i.appearance,H);return P&K.Double&&$.setDoubleShot({duration:1/0}),$.explodes&&($.explodes.type=iL[e]),$}function Ja(a,d){let{width:e,height:L}=u(a,d);for(let P=0;P<a.term.height;P++){let $=td(c0(a.term.width-e));for(let D of $)if(ba(a,D,P,e,L))return{x:D,y:P}}throw new Error(`Could not find ${e}x${L} spawn location`)}function Sd(a){a.hp=a.maxHp,a.shield=a.maxShield}function F0(a){return a.salvo<=0?a.ammunition<=0?"Spent":"Reloading":a.timer>0?"Chambering":"Ready"}function zd(a){a.timer>0&&(a.timer--,a.timer<=0&&a.salvo<=0&&(a.ammunition?(a.salvo=Math.min(a.salvoCount,a.ammunition),a.ammunition-=a.salvo):a.timer=1/0))}function vd(a,d){return a.shots.find(e=>e.type==="bullet"&&e.angle==="lastMovement")&&!d.lastMovement?!1:a.timer===0}function ra(a,d){var L;let e=(L=a.delayedShot)!=null?L:{shots:[]};e.shots.push(d),a.setDelayedShot(e)}function Ra(a,d,e,L,P,$,D,H,i,b){var f;let B=a.spawn(e).setIgnoreSolid({ids:i}).move($.x,$.y);return B.name=d,H&&B.setMotion({angle:D,vel:H}),B.ship&&Sd(B.ship),L.ship&&B.setOrigin({owner:L,ship:L.ship,turret:P}),(f=B.projectile)!=null&&f.scaling&&(B.projectile.damage+=Math.floor(Fd(L,B.projectile.scaling.stat)*B.projectile.scaling.multiplier)),B.appearance&&b&&Object.assign(B.appearance,b),B}function t0(a,d,e,L,P,$,D){var T;if($.doubleShot&&d.canDouble){let J=y(d);J.canDouble=!1,J.delay=$.player?2:1,J.appearance={fg:Qa.Colors.LIGHT_GRAY},ra($,{turret:e,shot:J})}if(d.delay){let J=y(d);return $.player&&J.delay++,ra($,{turret:e,shot:J}),[]}if(d.type==="array"){let J=[];for(let Q of S(a,$).filter(ad=>ad.tags.has(d.tag)))Q.position&&Q.turret&&J.push(...Jd(a,Q.turret,j(Q.position,(T=d.offset)!=null?T:p(0,0)),P,$,D));return J}let{angle:H,beam:i,name:b,offset:B,prefab:f,vel:r}=d,C=j(L,B!=null?B:p(.5,.5)),F=H==="nearestEnemy"?Pd(C,P):H==="lastMovement"?$.lastMovement.angle:H;if(i&&r){let[J,Q]=$d({angle:F,vel:r}),ad=p(J,Q),gd=j(C,ad);return i.appearance.map(O0=>{let Id=Ra(a,b,f,$,e,gd,F,0,D,d.appearance).setMotion({angle:F,vel:0}).setLifetime({duration:i.duration});return Id.appearance&&O0&&Object.assign(Id.appearance,O0),$.ship&&Id.setOrigin({owner:$,ship:$.ship,turret:e}),a.inBounds(gd)||Id.kill({type:"exitedMap"}),gd=j(gd,ad),Id})}return[Ra(a,b,f,$,e,C,F,r,D,d.appearance)]}function Jd(a,d,e,L,P,$){let{timeBetweenSalvos:D,timeBetweenShots:H}=d;--d.salvo<=0?d.timer=D:d.timer=H;let i=[];for(let b of d.shots)i.push(...t0(a,b,d,e,L,P,$));return i}function Ia(a){return(a==null?void 0:a.type)==="Player"}function Wd(a,d){let e=Ia(d.ship),L=Z(a,d),P=a.entities.get().filter(H=>H.ship&&Ia(H.ship)!==e);if(!P.length)return;let $=1/0,D;for(let H of P){let i=Z(a,H),b=bd(L,i);b<$&&($=b,D=H)}return D}var J0=[p(-1,-1),p(-1,0),p(-1,1),p(0,1),p(1,1),p(1,0),p(1,-1),p(0,-1)];function r0(a){return J0.map(d=>j(a,d))}function R0(a){let d=new M(a.entities,["ai","position","ship"]);a.on("tick",function(){d.forEach(({ai:L,position:P},$)=>{if($.setLastMovement(),!L.attacking||!L.attacking.alive){let T=Wd(a,$);if(T)L.attacking=T,a.fire("notice",{e:$,noticed:T});else return}let D=w(a,$),{layout:H}=u(a,$),i=l(P),b=a.getDistanceMap(L.attacking),B=T=>{let{oob:J,solid:Q,wall:ad}=a.getContents(T,D);return!J&&!Q&&!ad},f=T=>B(T)?Math.abs(b.getOrDefault(T,1/0)-L.idealDistance):1/0,r=T=>H.reduce((J,{offset:Q})=>J+f(j(T,Q)),0)/H.length,C=r(i),F=[];for(let T of J0){let J=j(i,T);if(!b.has(J))continue;let Q=r(J);Q<C?(C=Q,F=[J]):Q===C&&F.push(J)}if(F.length){let T=x(F);$.move(T.x,T.y),$.setLastMovement({angle:Pd(i,T)});return}})}),a.on("damage",function({e:L,source:P}){P.owner&&L!==P.owner&&L.ai&&!L.ai.attacking&&P.owner.alive&&(L.ai.attacking=P.owner)})}function I0(a){let d=new M(a.entities,["delayedShot"]);a.on("tick",function(){d.forEach(({ai:L,delayedShot:P},$)=>{var D,H;if(!$.alive){$.setDelayedShot();return}for(let i=P.shots.length-1;i>=0;i--){let{turret:b,shot:B}=P.shots[i];if(--B.delay<=0){B.delay=0,P.shots.splice(i,1);let f=S(a,$),r=f.find(T=>T.turret===b),C=(D=r==null?void 0:r.position)!=null?D:Z(a,$),F=(H=L==null?void 0:L.attacking)!=null&&H.alive?Z(a,L.attacking):p(0,0);t0(a,B,b,C,F,$,f.map(T=>T.id))}}P.shots.length||$.setDelayedShot()})})}function Q0(a){let d=new M(a.entities,["appearance","position"]);a.on("draw",function(){d.forEach(({appearance:L,position:P})=>a.drawIfVisible(G(P.x),G(P.y),L.glyph,L.fg,L.bg,L.blendMode))})}function M0(a){a.on("kill",function({e,reason:L}){var D;let{position:P,ship:$}=e;if(P&&($!=null&&$.power)&&L.type==="damage"){let H=C0[$.power],i=((D=L.source.e.projectile)==null?void 0:D.special)==="increasedDropChance",b=$.type==="Battleship"?i?92:42:i?32:2,B=(F=1)=>hd(b*F),f=[];H&K.Double&&B()&&f.push("DoubleItem"),H&K.Drain&&B()&&f.push("DrainItem"),H&K.Healthy&&B()&&f.push("HealItem"),B()&&f.push("MoneyItem"),B()&&f.push("JunkItem"),B()&&f.push("RechargeItem");let r;if(B()){let F=S(a,e).filter(T=>T.tags.has("Special")&&T.prefab&&T.turret);F.length&&(r=x(F).prefab,f.push("BombItem"))}let C=td([p(-1,-1),p(0,-1),p(1,-1),p(-1,0),p(0,0),p(1,0),p(-1,1),p(0,1),p(1,1)]);for(let F of f){let T=j(P,C.pop()),J=a.spawn(F).move(T.x,T.y).setMotion({angle:c.Down,vel:1});F==="BombItem"&&J.setItem({type:"bomb",prefab:r})}}})}var Ma=I(R());var wd=I(R());function rd(a,d,e){return a*(1-e)+d*e}var dd=class{constructor(d){this.points=d;this.sort()}sort(){this.points.sort(([d],[e])=>d-e)}add(d,e){return this.points.push([d,e]),this.sort(),this}get(d){let[e,L]=this.points[0];if(d<=e)return(0,wd.fromRgb)(...L);let[P,$]=this.points[this.points.length-1];if(d>=P)return(0,wd.fromRgb)(...$);let D=this.points.findIndex(([ad])=>ad>d),[H,[i,b,B,f]]=this.points[D-1],[r,[C,F,T,J]]=this.points[D],Q=(d-H)/(r-H);return(0,wd.fromRgb)(rd(i,C,Q),rd(b,F,Q),rd(B,T,Q),rd(f,J,Q))}};var hL={Fire:new dd([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Blue:new dd([[0,[0,0,0,0]],[2,[0,0,255,150]],[4,[0,155,255,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Yellow:new dd([[0,[0,0,0,0]],[2,[155,155,0,150]],[4,[255,255,55,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Green:new dd([[0,[0,0,0,0]],[2,[0,215,0,150]],[4,[55,255,55,150]],[6,[215,255,215,150]],[10,[255,255,255,255]]]),Magenta:new dd([[0,[0,0,0,0]],[2,[155,0,115,150]],[4,[255,115,255,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function E0(a){if(!(a.intensity<=0))return{glyph:" ",layer:t.Effect,bg:hL[a.type].get(a.intensity),blendMode:Ma.BlendMode.Add}}function Ea(a,d){let e=[],L=Math.floor(a.x-d),P=Math.ceil(a.x+d),$=Math.floor(a.y-d),D=Math.ceil(a.y+d);for(let H=$;H<=D;H++)for(let i=L;i<=P;i++){let b=bd(a,{x:i,y:H});b>=d||e.push({x:i,y:H,intensity:d-b})}return e}function S0(a){a.on("kill",function({e,reason:L}){if(L.type==="exitedMap")return;let{explodes:P,name:$,position:D}=e;if(P&&D)for(let{x:H,y:i,intensity:b}of Ea(Z(a,e),P.size))a.add(new Hd(a,$+"Explosion").setPosition({x:H,y:i}).setField({type:P.type,intensity:b,falloff:P.falloff}))})}function nd(a,d,e,L){var H;let P=a.getRoot(d);if(!P.ship)return;P.ship.type!=="Player"&&((H=L.origin)==null?void 0:H.ship.type)!=="Player"&&(e=Math.ceil(e/2));let $=e;P.ship.shield>0&&(P.ship.shield>e?(P.ship.shield-=e,$=0):($-=P.ship.shield,P.ship.shield=0)),$&&(P.ship.hp-=$);let D={e:L,owner:L};L.origin&&(D.owner=L.origin.owner,D.ship=L.origin.ship,D.turret=L.origin.turret),console.log(`${L.name}${L.origin?` (${L.origin.owner.name} #${L.origin.owner.id})`:""} hits ${P.name} for ${e}`),a.fire("damage",{e:P,amount:e,source:D}),P.ship.hp<=0&&a.kill(P,{type:"damage",source:D})}function n0(a){let d=new M(a.entities,["ship"]),e=new M(a.entities,["field","position"]);a.on("tick",function(){e.forEach(({field:P,position:$},D)=>{P.intensity-=P.falloff,D.setAppearance(E0(P)),P.intensity<1?a.kill(D,{type:"expired"}):d.forEach((H,i)=>{let{layout:b}=u(a,i);b.find(({absolute:f})=>v(f,$))&&nd(a,i,Math.floor(P.intensity),D)})})}),a.on("spawn",function({e:P}){P.field&&P.setAppearance(E0(P.field))})}var Sa=I(R());var Ud=class{constructor(d,e){this.g=d;this.player=e;this.lines=e.bombs.map(L=>yd(L).components.turret.name),this.width=this.lines.reduce((L,P)=>Math.max(L,P.length),0),this.height=this.lines.length}draw(d,e){for(let L of this.lines)this.g.term.drawString(d,e++,L,Sa.Colors.WHITE)}};var z=I(R());var Yd=I(R());var Ad=class{constructor(d,e,L){this.g=d;this.pilot=e;this.full=L;this.width=11,this.height=L?2+e.class.length:1}get isPlayer(){return this.pilot.player}draw(d,e){if(this.full&&(this.g.term.drawString(d,e,this.pilot.name,this.pilot.star?Yd.Colors.YELLOW:Yd.Colors.LIGHT_GRAY),e++),this.drawStat(d,e,"body"),this.drawStat(d+3,e,"mind"),this.drawStat(d+6,e,"spirit"),this.drawStat(d+9,e,"talent"),!!this.full)for(let L of this.pilot.class)this.g.term.drawString(d,++e,L,Yd.Colors.LIGHT_GREEN)}drawStat(d,e,L){let P=this.pilot[L];this.g.term.drawChar(d,e,L[0].toUpperCase(),Yd.Colors.WHITE),this.g.term.drawChar(d+1,e,P.toString(),ud[P])}};var O=I(R());function U0(a,d,e,L,P,$,D,H,i){let b=`${Math.ceil(P)}/${$}`,B=Math.floor(P/$*L);a.drawHLine(d,e,L," ",void 0,H),B&&a.drawHLine(d,e,B," ",void 0,D),a.drawCenteredString(d+L/2,e,b,i)}var fd=class{constructor(d,e){this.g=d;this.ship=e;this.width=Math.max(13,e.name.length),this.height=e.maxShield?3:2}draw(d,e){let{ship:L,width:P}=this,{term:$}=this.g,D=P-3;$.drawString(d,e,L.name,O.Colors.WHITE),$.drawString(d,e+1,"HP:",O.Colors.WHITE),U0($,d+3,e+1,D,L.hp,L.maxHp,O.Colors.DARK_GREEN,O.Colors.DARK_RED,O.Colors.WHITE),L.maxShield&&($.drawString(d,e+2,"Sh:",O.Colors.WHITE),U0($,d+3,e+2,D,L.shield,L.maxShield,O.Colors.DARK_CYAN,O.Colors.LIGHT_BLUE,O.Colors.WHITE))}};var Xd=I(R());var AL={Spent:Xd.Colors.DARK_GRAY,Reloading:Xd.Colors.LIGHT_RED,Ready:Xd.Colors.YELLOW,Chambering:Xd.Colors.BROWN},cd=class{constructor(d,e){this.g=d;this.turret=e;this.width=Math.max(e.name.length,this.stateLabel.length),this.height=2,e.ammunition>0&&e.ammunition<1/0&&this.height++}get stateLabel(){let{timer:d,salvo:e,salvoCount:L}=this.turret,P=F0(this.turret);if(P==="Spent")return"Out of Ammo";if(P==="Reloading")return`Reloading (${d})`;let $=`${e}/${L}`;return P==="Ready"?$:`${$} (${d})`}draw(d,e){this.g.term.drawString(d,e,this.turret.name,Xd.Colors.WHITE);let L=F0(this.turret);this.g.term.drawString(d,e+1,this.stateLabel,AL[L]),this.height>2&&this.g.term.drawString(d,e+2,`${this.turret.ammunition} ammo left`,Xd.Colors.LIGHT_GRAY)}};var Dd=6;function Y0(a){let{mapHeight:d,term:e}=a;a.on("draw",function(){let P=a.player,{pilot:$,player:D,ship:H}=P;e.fillRect(0,d,e.width,Dd," ",z.Colors.WHITE,z.Colors.BLACK),e.drawSingleBox(0,d,e.width,Dd);let i=1,b=d+1,B=new fd(a,H);B.draw(i,b);let f=i+Math.floor((B.width-11)/2);new Ad(a,$,!1).draw(f,b+3),i+=B.width+1,e.drawChar(i-1,b-1,h.BoxDownSingleHorizontalSingle,z.Colors.WHITE),e.drawVLine(i-1,b,Dd-2,h.BoxVerticalSingle,z.Colors.WHITE),e.drawChar(i-1,b+Dd-2,h.BoxUpSingleHorizontalSingle,z.Colors.WHITE);for(let C of D.weaponArrays){let F=i,T=S(a,P).filter(J=>J.turret&&J.tags.has(C));for(let J of T){let Q=new cd(a,J.turret);Q.draw(i,b+1),i+=Q.width+1}e.drawString(F,b,C,z.Colors.LIGHT_CYAN),i=Math.max(i,F+C.length+1)}D.bombs.length&&(e.drawChar(i-1,b-1,h.BoxDownSingleHorizontalSingle,z.Colors.WHITE),e.drawVLine(i-1,b,Dd-2,h.BoxVerticalSingle,z.Colors.WHITE),e.drawChar(i-1,b+Dd-2,h.BoxUpSingleHorizontalSingle,z.Colors.WHITE),new Ud(a,D).draw(i,b))})}function j0(a){let d=new M(a.entities,["homing","motion","position"]);a.on("tick",function(){d.forEach(({homing:L,motion:P,position:$},D)=>{var B;if(!((B=L.target)!=null&&B.alive))return;let H=Z(a,L.target),i=Pd($,H),b=ha(P.angle,i);Math.abs(b)<=L.strength?P.angle=i:b<0?P.angle-=L.strength:P.angle+=L.strength,--L.duration<=0&&(D.setHoming(),D.setTrail())})})}function K0(a){let d=new M(a.entities,["lifetime"]);a.on("tick",function(){d.forEach(({lifetime:L},P)=>{if(--L.duration<=0)a.kill(P,{type:"expired"});else if(L.decayingAppearance&&P.appearance){let $=L.decayingAppearance[L.duration-1];Object.assign(P.appearance,$)}})})}var fL=["Cleave","Outcry","AcidSplash","ShuttleLaunch","Veto","TalonSwipe","CrushPattern","Smite","Salvo","TheDragonWakes","Bellow","DemandHomage","Multiball","StubbornDescent"];function x0(a,d,e){if(!(!d.ship||!d.player))switch(e.type){case"double":d.doubleShot?d.doubleShot.duration+=9:d.setDoubleShot({duration:9});return;case"heal":{let L=Math.ceil(d.ship.maxHp/4);d.ship.hp=Math.min(d.ship.maxHp,d.ship.hp+L);return}case"recharge":{for(let L of S(a,d))if(L.turret)for(;L.turret.timer<1/0&&L.turret.timer>0;)zd(L.turret);return}case"bomb":for(d.player.bombs.push(e.prefab);d.player.bombs.length>Xa(d);)d.player.bombs.shift();break;case"junk":if(hd(ca(d)))return x0(a,d,{type:"bomb",prefab:x(fL)});break}}function _d(a,d){let e=d.x-a.x,L=d.y-a.y,P=Math.abs(e),$=Math.abs(L),D=e>0?1:-1,H=L>0?1:-1,i=s({},a),b=[s({},i)];for(let B=0,f=0;B<P||f<$;)(.5+B)/P<(.5+f)/$?(i.x+=D,B++):(i.y+=H,f++),b.push(s({},i));return b}function Z0(a){let d=new M(a.entities,["motion","position"]);a.on("tick",function(){d.forEach(({motion:L,position:P,projectile:$,ignoreSolid:D,item:H},i)=>{let[b,B]=$d(L),f=p(P.x+b,P.y+B),r=_d(l(P),l(f)),C=!1,F;for(let T of r){if(!a.inBounds(T)){a.kill(i,{type:"exitedMap"});return}a.move(i,T);let{wall:J,solid:Q}=a.getContents(T,D==null?void 0:D.ids);if(J){C=!0;break}else if(Q){F=Q;break}}C?a.kill(i,{type:"hitWall"}):F?($&&nd(a,F,$.damage,i),H&&x0(a,a.getRoot(F),H),a.kill(i,{type:"hitEntity",other:F})):a.move(i,f)})})}function l0(a){a.on("playerMove",function({move:e}){let L=a.player,P=L.position,$=j(P,e);Ba(a,L,$).length||(L.move($.x,$.y),L.setLastMovement({angle:Pd(P,$)}),a.tick())}),a.on("playerFire",function({array:e}){let L=a.player,P=L.player.weaponArrays[e],$=S(a,L),D=$.filter(i=>i.tags.has(P)),H=!1;for(let i of D)!i.position||!i.turret||vd(i.turret,L)&&(Jd(a,i.turret,i.position,p(0,0),L,$.map(b=>b.id)),H=!0);H&&(L.setLastMovement(),a.tick())}),a.on("playerBomb",function(){var $;let e=a.player,L=e.player.bombs.shift();if(!L)return;let P=yd(L);if(($=P.components)!=null&&$.turret){let D=y(P.components.turret),H=Z(a,e),i=Wd(a,e),b=i?Z(a,i):p(0,0),B=Jd(a,D,H,b,e,w(a,e));for(let f of B){if(f.ai){f.ai.attacking=i;for(let r of S(a,f).filter(C=>C.turret))for(let C of r.turret.shots)C.type==="bullet"&&typeof C.angle=="number"&&(C.angle+=Math.PI)}f.homing&&(f.homing.target=i)}e.setLastMovement(),a.tick()}})}var na=I(R());function jd(a){return typeof a!="undefined"}function s0(a){let d=new M(a.entities,["ship"]);a.on("tick",function(){d.forEach((L,P)=>{P.doubleShot&&--P.doubleShot.duration<=0&&P.setDoubleShot()})}),a.on("draw",function(){let L=S(a,a.player).map(P=>P.position).filter(jd);if(a.player.doubleShot)for(let P of L)a.blend(P.x,P.y,na.Colors.LIGHT_GRAY)})}function V0(a){let d=new M(a.entities,["ship"]);a.on("tick",function(){d.forEach(({ship:L},P)=>{if(L.shield>=L.maxShield){L.shieldTimer=0;return}let $=fa(P);++L.shieldTimer>=$&&(L.shield++,L.shieldTimer=0)})})}function N0(a){a.on("waveBegin",function({wave:L,difficulty:P,pilot:$}){let D=(P+L.difficulty)*3,H=[];for(let B of L.groups)for(let f=0;f<B.count;f++)H.push(x(B.prefabs));let i=L.groups.filter(B=>B.type==="Escort");for(let B=0;B<P;B++){let f=x(i);H.push(x(f.prefabs))}let b=Math.floor(Math.random()*H.length);for(let B=0;B<H.length;B++){let f=B===b&&$!==void 0,r=H[B],C=Fa(D,f),F=ta(a,r,C,f?$:void 0),T=Ja(a,F);F.move(T.x,T.y)}});let d=1/0;a.on("kill",({e})=>{if(!e.ship)return;a.entities.get().filter(P=>P.alive&&P.ship&&P.ship.type!=="Player").length||(d=5)}),a.on("tick",()=>{--d<=0&&(d=1/0,a.fire("waveNext",void 0))})}function q0(a){a.on("move",function({e,old:L,pos:P}){e.trail&&!v(L,P)&&a.spawn(e.trail.effectPrefab).setPosition(L)})}function k0(a){let d=new M(a.entities,["position","turret"]);a.on("tick",function(){d.forEach(({position:L,turret:P},$)=>{var b;zd(P);let D=a.getRoot($);if(!D.ai)return;let H=D.ai.attacking;if(!(H!=null&&H.alive))return;let i=Z(a,H);if(!(bd(L,i)>((b=D.ai.firingDistance)!=null?b:1/0))&&vd(P,D))for(let B of Jd(a,P,L,i,D,w(a,D)))B.homing&&(B.homing.target=H),B.ai&&(B.ai.attacking=H)})})}function Ua(a){K0(a),j0(a),I0(a),k0(a),n0(a),V0(a),Z0(a),R0(a),N0(a),Q0(a),Y0(a),q0(a),S0(a),M0(a),s0(a),l0(a)}var Rd=I(R());var Ya=I(R()),o=class{constructor(d){this.g=d;this.width=0,this.height=0,this.instructions=[]}add(d){this.instructions.push(d),this.updateBounds()}addLine(d,e=Ya.Colors.WHITE,L){this.add({x:0,y:this.instructions.length,line:d,fg:e,bg:L})}updateBounds(){this.width=this.instructions.reduce((d,e)=>Math.max(e.line.length+e.x,d),0),this.height=1+this.instructions.reduce((d,e)=>Math.max(e.y,d),0)}draw(d,e){for(let{x:L,y:P,line:$,fg:D,bg:H}of this.instructions)this.g.term.drawString(d+L,e+P,$,D,H)}};var ja=Math.PI/4,XL=[h.RightArrow,h.DownArrow+h.RightArrow,h.DownArrow,h.DownArrow+h.LeftArrow,h.LeftArrow,h.UpArrow+h.LeftArrow,h.UpArrow,h.UpArrow+h.RightArrow];function cL(a){let d=Math.floor(Aa(a)/ja+ja/2);return XL[d]}var Kd=class extends o{constructor(e,L){var P,$;super(e);this.e=L;L.name&&!L.ship&&this.addLine(L.name),L.projectile&&this.addLine(`${L.projectile.damage} damage`,Rd.Colors.LIGHT_RED),L.motion&&this.addLine(`${cL(L.motion.angle)}, vel ${L.motion.vel}`,Rd.Colors.LIGHT_GRAY),L.homing&&this.addLine(`chasing ${L.homing.target===this.g.player?"you":($=(P=L.homing.target)==null?void 0:P.ship)==null?void 0:$.name} ${L.homing.duration<1/0?`(${L.homing.duration})`:""}`,Rd.Colors.DARK_RED),L.lifetime&&this.addLine(`(lasts ${L.lifetime.duration})`,Rd.Colors.DARK_GRAY),L.explodes&&this.addLine(`explosion ${L.explodes.size}`,Rd.Colors.ORANGE)}};var o0=I(R());var g0=I(R());var xd=class extends o{constructor(e,L){super(e);this.field=L;this.addLine("Explosion"),this.add({x:0,y:1,fg:g0.Colors.LIGHT_GRAY,line:"intensity"}),this.add({x:10,y:1,fg:g0.Colors.YELLOW,line:Math.floor(L.intensity).toString()})}};var m0=I(R());var Zd=class extends o{constructor(e,L){super(e);this.item=L;switch(L.type){case"bomb":this.addLine("Smart Bomb");break;case"double":this.addLine("Double",_.Double.fg,_.Double.bg);break;case"drain":this.addLine("Drain",_.Drain.fg,_.Drain.bg);break;case"heal":this.addLine("Heal",_.Healthy.fg,_.Healthy.bg);break;case"junk":this.addLine("Junk",m0.Colors.DARK_GRAY);break;case"money":this.addLine(`${h.SetMember}${L.value}`,m0.Colors.YELLOW);break;case"recharge":this.addLine("Recharge");break}}};var Ka=I(R());var ld=class extends o{constructor(e,L){super(e);this.e=L;L.doubleShot&&this.addLine(L.doubleShot.duration===1/0?"2x Shot":`2x Shot (${L.doubleShot.duration})`,Ka.Colors.LIGHT_GRAY)}};function xa(a,d,e){if(!e.length)return;let L=[],P=1,$=1,D=B=>{L.push({x:P,y:$,object:B}),$+=B.height+1};for(let B of e){B.ship&&D(new fd(a,B.ship)),B.pilot&&D(new Ad(a,B.pilot,!0)),B.doubleShot&&D(new ld(a,B));let f=S(a,B);for(let r of f.filter(C=>C.turret))D(new cd(a,r.turret));B.item?D(new Zd(a,B.item)):(B.motion||B.projectile||B.homing||B.lifetime||B.explodes)&&D(new Kd(a,B)),B.field&&D(new xd(a,B.field))}if(!L.length)return;let H=Math.max(...L.map(B=>B.object.width))+2,i=Math.min(d.x+2,a.term.width-H),b=Math.min(d.y,a.term.height-$);a.term.fillRect(i,b,H,$," ",o0.Colors.WHITE,o0.Colors.BLACK),a.term.drawSingleBox(i,b,H,$);for(let B of L)B.object.draw(i+B.x,b+B.y)}var sd=class{constructor(d,e){this.g=d;this.campaign=e;this.dirty=!0,this.examining=[]}refresh(){this.dirty=!0}init(){let{g:d}=this;this.examineAt=void 0,this.examining=[],this.waves=Ca(),d.blankMap(),d.entities.clearExceptFor(w(d,d.player));let{width:e,height:L}=u(d,d.player);d.player.move(G(d.mapWidth/2-e/2),d.mapHeight-L-4),d.player.ship.shield=d.player.ship.maxShield,Ua(d),this.nextWave(),d.on("waveNext",this.nextWave.bind(this))}nextWave(){let d=this.waves.shift();if(d){let e=this.waves.length===0?this.campaign.currentSector.star:void 0;this.g.fire("waveBegin",{wave:d,difficulty:this.campaign.difficulty,pilot:e});return}this.g.player.alive&&(this.campaign.currentSector.completed=!0)}draw(){let{map:d,mapWidth:e,mapHeight:L,overlays:P,player:$,term:D}=this.g;for(let H=0;H<L;H++)for(let i=0;i<e;i++){let b=d.grid[H][i];D.drawChar(i,H,0,b.fg,b.bg)}if(this.g.fire("draw",void 0),this.dirty=!1,this.showOverlay){let H=P.get(this.showOverlay);if(H)for(let i=0;i<L;i++)for(let b=0;b<e;b++){let B=H.get({x:b,y:i})||1/0,f=B===1/0?"-":B<10?`${B}`:"*";D.drawChar(b,i,f,Y.Colors.LIGHT_RED)}}if(this.examineAt){xa(this.g,this.examineAt,this.examining);for(let H of this.examining){let{motion:i,position:b}=H;if(i&&b){let[B,f]=$d(i),r=p(b.x+B,b.y+f),C=_d(l(b),l(r));for(let F of C)this.g.blend(F.x,F.y,Y.Colors.DARK_RED)}}}$.alive?this.campaign.currentSector.completed&&(D.drawCenteredString(D.width/2,5,"SECTOR COMPLETE",Y.Colors.WHITE,Y.Colors.BLACK),D.drawCenteredString(D.width/2,7,"Hit Enter to continue",Y.Colors.WHITE,Y.Colors.BLACK)):(D.drawCenteredString(D.width/2,5,"YOU HAVE PERISHED!",Y.Colors.LIGHT_RED,Y.Colors.BLACK),D.drawCenteredString(D.width/2,7,"Hit Escape to try again",Y.Colors.LIGHT_RED,Y.Colors.BLACK))}update(){(this.g.term.mouse.dx||this.g.term.mouse.dy)&&this.refresh(),this.handleKeys(),this.dirty&&(this.handleMouseMove(),this.draw())}examine(d){this.examineAt=d,this.dirty=!0;let{solid:e,other:L}=this.g.getContents(d),P=new Set;e&&P.add(this.g.getRoot(e));for(let $ of L)P.add(this.g.getRoot($));this.examining=[...P]}handleMouseMove(){let{x:d,y:e}=this.g.term.mouse;this.examine({x:d,y:e})}handleKeys(){let{player:d,term:e}=this.g;if(!d.alive){e.isKeyPressed(Y.Key.VK_ESCAPE)&&(this.g.setMode(new pd(this.g)),e.fillRect(0,0,e.width,e.height," ",Y.Colors.WHITE,Y.Colors.BLACK));return}if(this.campaign.currentSector.completed&&(e.isKeyPressed(Y.Key.VK_ENTER)||e.isKeyPressed(Y.Key.VK_NUMPAD_ENTER))){this.campaign.endCombat();return}let L=e.getMovementKey();if(L){this.g.fire("playerMove",{move:L});return}if(e.isKeyPressed(Y.Key.VK_1)){this.g.fire("playerFire",{array:0});return}if(e.isKeyPressed(Y.Key.VK_2)){this.g.fire("playerFire",{array:1});return}if(e.isKeyPressed(Y.Key.VK_SPACE)){this.g.fire("playerBomb",void 0);return}}};var Vd=class{constructor(d,e,L){this.width=d;this.height=e;this.grid=[];for(let P=0;P<e;P++){let $=[];for(let D=0;D<d;D++)$.push(L(D,P));this.grid.push($)}}contains({x:d,y:e}){return d>=0&&d<this.width&&e>=0&&e<this.height}get({x:d,y:e}){return this.grid[e][d]}getPositions(){let d=[];for(let e=0;e<this.height;e++)for(let L=0;L<this.width;L++)d.push({x:L,y:e});return d}};var pL={name:"Bodini",star:!0,body:4,mind:2,spirit:3,talent:2,class:[],special:"Multiball"},TL={name:"Splintertooth",star:!0,body:3,mind:3,spirit:3,talent:2,class:[],special:"StubbornDescent"},CL={name:"Gruff",star:!0,body:2,mind:3,spirit:4,talent:2,class:[],special:"LaserBeam"},FL={name:"Star Pilot D",star:!0,body:2,mind:2,spirit:2,talent:2,class:[]},tL={name:"Star Pilot E",star:!0,body:2,mind:2,spirit:2,talent:2,class:[]},JL={name:"Star Pilot F",star:!0,body:2,mind:2,spirit:2,talent:2,class:[]},rL=[pL,TL,CL,FL,tL,JL],Za=rL;var la="./claw yr way back-WFUTJ3MJ.mp3";var y0;function G0(){return y0||(y0=new Promise(a=>{let d=new Audio(la);d.addEventListener("canplaythrough",()=>{d.play(),d.addEventListener("ended",()=>{d.currentTime=0,d.play()}),a(d)})})),y0}var Nd=class{constructor(d,e,L){this.g=d;this.shipPrefab=e;this.pilot=L;this.dirty=!0}get currentSector(){return this.space.get(this.position)}refresh(){this.dirty=!0}init(){let{g:d}=this;d.clearEventHandlers(),d.entities.clear(),d.player=this.makePlayer(),this.difficulty=0,this.position=p(2,2),this.space=new Vd(5,5,()=>({completed:!1}));let e=new Set,L=this.space.getPositions().filter(P=>!v(this.position,P));for(;e.size<6;){let P=x(Za);if(!e.has(P)){e.add(P);let $=x(L),D=this.space.get($);D.star=P;let H=L.indexOf($);L.splice(H,1)}}G0(),this.startCombat()}startCombat(){this.g.setMode(new sd(this.g,this))}endCombat(){this.g.clearEventHandlers(),this.currentSector.completed=!0,this.difficulty++,this.g.mode=this,this.refresh()}makePlayer(){let{g:d,shipPrefab:e,pilot:L}=this,P=d.spawn(e);if(!P.ship)throw new Error(`Ship prefab ${e} doesn't have a ship component!`);return Gd(d,P,L),Sd(P.ship),P}draw(){let{term:d}=this.g;d.fillRect(0,0,d.width,d.height," ",g.Colors.WHITE,g.Colors.BLACK);let e=this.space.get(this.position),L=d.width/2;d.drawCenteredString(L,2,"Known Space",g.Colors.WHITE),e.completed||(d.drawCenteredString(L,4,"Hit Enter to fight!",g.Colors.WHITE),e.star&&d.drawCenteredString(L,34,`You will face: ${e.star.name}!`,g.Colors.YELLOW));let P=(d.width-25)/2,$=(d.height-25)/2;for(let D=0;D<5;D++){let H=$+D*5;for(let i=0;i<5;i++){let b=P+i*5,B={x:i,y:D},f=this.space.get(B);d.fillRect(b,H,5,5," ",void 0,f.completed?g.Colors.BLACK:g.Colors.DARK_RED),d.drawSingleBox(b,H,5,5,g.Colors.WHITE),v(B,this.position)?d.drawChar(b+2,H+2,"@",g.Colors.LIGHT_CYAN):f.star&&d.drawChar(b+2,H+2,"*",g.Colors.YELLOW)}}this.dirty=!1}handleKeys(){let d=this.space.get(this.position);!d.completed&&(this.g.term.isKeyPressed(g.Key.VK_ENTER)||this.g.term.isKeyPressed(g.Key.VK_NUMPAD_ENTER))&&this.startCombat();let e=this.g.term.getMovementKey();if(d.completed&&e){let L=j(this.position,e);this.space.contains(L)&&(this.position=L,this.dirty=!0)}}update(){this.handleKeys(),this.dirty&&this.draw()}};var pd=class{constructor(d,e=5,L=100){this.g=d;this.starfieldSpeed=e;this.starCount=L}refresh(){this.dirty=!0}init(){this.dirty=!0,this.pilot={name:"Player",player:!0,body:1,mind:1,spirit:1,talent:1,class:[]},this.points=6,this.starfieldCounter=0,this.stars=[];for(let d=0;d<this.starCount;d++)this.stars.push(this.newStar())}draw(){let{term:d}=this.g;d.clear();for(let D of this.stars){let{x:H,y:i}=l(D);d.drawChar(H,i,D.c,D.fg)}let e=d.width/2;d.drawCenteredString(e,2,"CRAVESPACE",E.Colors.WHITE),d.drawCenteredString(e,9,"Create your Pilot",E.Colors.WHITE),d.drawCenteredString(e,10,`${this.points} points`,E.Colors.YELLOW);let L=2,P=Math.floor((d.width-L*2)/4),$=L+P/2;this.drawStat("body",$),this.drawStat("mind",$+P),this.drawStat("spirit",$+P*2),this.drawStat("talent",$+P*3),this.points===0&&d.drawCenteredString(e,20,"Hit Enter to begin!",E.Colors.WHITE),this.dirty=!1}drawStat(d,e){let{term:L}=this.g,P=`(${d[0].toUpperCase()})${d.slice(1)}`,$=this.pilot[d];L.drawCenteredString(e,13,P,E.Colors.LIGHT_CYAN),L.drawCenteredString(e,14,$.toString(),ud[$])}update(){this.handleStarfield(),this.handleKeys(),this.dirty&&this.draw()}newStar(){let{term:d}=this.g,e=x([E.Colors.DARK_RED,E.Colors.LIGHT_RED,E.Colors.YELLOW,E.Colors.LIGHT_CYAN,E.Colors.WHITE]),L=.5+Math.random(),P=L<.75?".":L<1.25?h.Dot:"*",$=Math.random()*Math.PI*2;return{x:d.width/2,y:d.height/2,c:P,fg:e,vel:L,angle:$}}handleStarfield(){if(this.starfieldCounter<this.starfieldSpeed){this.starfieldCounter++;return}this.starfieldCounter=0,this.dirty=!0;let{width:d,height:e}=this.g.term;for(let L of this.stars){let[P,$]=$d(L);L.x+=P,L.y+=$,(L.x<0||L.x>=d||L.y<0||L.y>=e)&&Object.assign(L,this.newStar())}}isPressed(d,e){let L=this.g.term.isKeyDown(E.Key.VK_SHIFT_LEFT)||this.g.term.isKeyDown(E.Key.VK_SHIFT_RIGHT);return this.g.term.isKeyPressed(d)&&e===L}changeStat(d,e){let L=this.pilot[d]+e;if(L<1||L>4)return!1;this.points-=e,this.pilot[d]=L,this.dirty=!0}handleKeys(){this.points>0&&(this.isPressed(E.Key.VK_B,!1)&&this.changeStat("body",1),this.isPressed(E.Key.VK_M,!1)&&this.changeStat("mind",1),this.isPressed(E.Key.VK_S,!1)&&this.changeStat("spirit",1),this.isPressed(E.Key.VK_T,!1)&&this.changeStat("talent",1)),this.isPressed(E.Key.VK_B,!0)&&this.changeStat("body",-1),this.isPressed(E.Key.VK_M,!0)&&this.changeStat("mind",-1),this.isPressed(E.Key.VK_S,!0)&&this.changeStat("spirit",-1),this.isPressed(E.Key.VK_T,!0)&&this.changeStat("talent",-1),this.points===0&&(this.g.term.isKeyPressed(E.Key.VK_ENTER)||this.g.term.isKeyPressed(E.Key.VK_NUMPAD_ENTER))&&this.g.setMode(new Nd(this.g,"PlayerShip",this.pilot))}};var qd=class{constructor(d){this.keyFn=d;this.items=new Map}has(d){return this.items.has(this.keyFn(d))}get(d){return this.items.get(this.keyFn(d))}getOrDefault(d,e){let L=this.items.get(this.keyFn(d));return typeof L!="undefined"?L:e}getOrDie(d){let e=this.keyFn(d),L=this.items.get(e);if(typeof L=="undefined")throw new Error(`Invalid key: ${e}`);return L}set(d,e){this.items.set(this.keyFn(d),e)}};function u0(a,d,e=1/0){let L=[],P=new qd($=>`${$.x},${$.y}`);for(let $ of a)L.push($),P.set($,0);for(;L.length;){let $=L.shift(),D=P.getOrDie($)+1;if(!(D>e))for(let H of r0($))!P.has(H)&&d(H)&&(P.set(H,D),L.push(H))}return P}var kd=class{constructor(d,e,L){this.term=d;this.mapWidth=e;this.mapHeight=L;d.update=this.update.bind(this),this.map=new d0.Console(e,L,()=>!0),this.lastEntityId=0,this.entities=new Ed(La),this.overlays=new Map,this.clearEventHandlers(),this.setMode(new pd(this))}setMode(d){this.mode=d,this.mode.init()}clearEventHandlers(){this.eventCallbacks=ea(Pa.map(d=>[d,[]]))}fire(d,e){for(let L of this.eventCallbacks[d])L(e)}on(d,e){this.eventCallbacks[d].push(e)}spawn(d){return f0(this,d)}refresh(){this.mode.refresh()}add(d){return this.refresh(),this.entities.add(d),this.fire("spawn",{e:d}),d}kill(d,e){d.alive&&(d.kill(e),this.fire("kill",{e:d,reason:e}))}move(d,e){let L=d.position;d.move(e.x,e.y),L&&this.fire("move",{e:d,old:L,pos:e})}blankMap(){let{map:d,mapHeight:e,mapWidth:L}=this;d.clear();for(let P=0;P<e;P++)for(let $=0;$<L;$++)d.setBlocked($,P,!1),d.setBlockedSight($,P,!1);d.computeFov(0,0,1/0)}drawIfVisible(d,e,L,P,$,D){this.map.isVisible(d,e)&&(D?this.term.drawCell(d,e,{bg:$},D):this.term.drawChar(d,e,L,P,$))}blend(d,e,L){this.term.drawCell(d,e,{bg:L},d0.BlendMode.Add)}getRoot(d){return d.attachment?this.getRoot(d.attachment.parent):d}getContents(d,e=[]){let L=l(d);if(!this.inBounds(L))return{oob:!0,other:[]};let P=this.map.isBlocked(L.x,L.y),$=this.entities.get().filter(H=>H.position&&v(L,H.position)),D=$.filter(H=>!e.includes(H.id)).find(H=>H.solid);return{wall:P,solid:D,other:$.filter(H=>!H.solid)}}tick(){this.overlays.clear(),this.fire("tick",void 0),this.entities.clearDead()}update(){this.mode.update()}inBounds(d){return d.x>=0&&d.y>=0&&d.x<this.mapWidth&&d.y<this.mapHeight}getDistanceMap(d){let e=`${d.id}.distance`,L=this.overlays.get(e);return L||(L=u0(S(this,d).map(P=>P.position).filter(jd),this.inBounds.bind(this)),this.overlays.set(e,L)),L}};function IL(a){let L=a0.DEFAULT_FONT,P=document.createElement("div");a.appendChild(P);let $=()=>{let b=60*L.charWidth,B=40*L.charHeight,f=Math.floor(window.innerWidth/b),r=Math.floor(window.innerHeight/B),C=Math.min(f,r);P.style.width=`${b*C}px`,P.style.height=`${B*C}px`};window.addEventListener("resize",$),$();let D=document.createElement("canvas");P.appendChild(D),requestAnimationFrame(()=>D.focus());let H=new a0.Terminal(D,60,40,{font:L}),i=new kd(H,60,40-Dd);window.g=i}window.addEventListener("load",()=>IL(document.body));})();
//# sourceMappingURL=bundle.js.map
