"use strict";(()=>{var Ht=Object.create;var S=Object.defineProperty;var Bt=Object.getOwnPropertyDescriptor;var Rt=Object.getOwnPropertyNames,at=Object.getOwnPropertySymbols,Ft=Object.getPrototypeOf,mt=Object.prototype.hasOwnProperty,St=Object.prototype.propertyIsEnumerable;var lt=(e,t,i)=>t in e?S(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,h=(e,t)=>{for(var i in t||={})mt.call(t,i)&&lt(e,i,t[i]);if(at)for(var i of at(t))St.call(t,i)&&lt(e,i,t[i]);return e};var It=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),T=(e,t)=>{for(var i in t)S(e,i,{get:t[i],enumerable:!0})},Lt=(e,t,i,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Rt(t))!mt.call(e,r)&&r!==i&&S(e,r,{get:()=>t[r],enumerable:!(o=Bt(t,r))||o.enumerable});return e};var x=(e,t,i)=>(i=e!=null?Ht(Ft(e)):{},Lt(t||!e||!e.__esModule?S(i,"default",{value:e,enumerable:!0}):i,e));var y=It((Zt,pt)=>{pt.exports=globalThis.wglt});var g=x(y());var p=class{constructor(t,i){this.g=t;this.name=i;this.alive=!0,this.id=++t.lastEntityId,this.player=!1,this.projectile=!1,this.solid=!1}get[Symbol.toStringTag](){return this.name}kill(){return this.alive=!1,this.eachChild(t=>this.g.delete(t)),this}eachChild(t){var i;for(let o of this.g.entities.get())((i=o.attachment)==null?void 0:i.parent)===this&&t(o,o.attachment)}setAppearance(t){return this.g.dirty=!0,this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setPosition(t){return this.g.dirty=!0,this.position=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,i){return this.g.dirty=!0,this.position={x:t,y:i},this.eachChild((o,r)=>o.move(t+r.x,i+r.y)),this.position}};function ft(e,t){var r,n,s,a;let i=(n=(r=e.appearance)==null?void 0:r.layer)!=null?n:0,o=(a=(s=t.appearance)==null?void 0:s.layer)!=null?a:0;return i!==o?i-o:e.id-t.id}var K={};T(K,{Battleship:()=>Gt,BattleshipHull:()=>Dt});var W=x(y());var ut=(n=>(n[n.Effect=0]="Effect",n[n.Ship=1]="Ship",n[n.Gun=2]="Gun",n[n.Bullet=3]="Bullet",n[n.Player=4]="Player",n))(ut||{}),u=ut;function Gt(e){let t=new p(e,"Battleship");return e.spawn("BattleshipHull").setAttachment({parent:t,x:1,y:0}),e.spawn("BattleshipHull").setAttachment({parent:t,x:2,y:0}),e.spawn("BattleshipHull").setAttachment({parent:t,x:0,y:1}),e.spawn("BattleshipHull").setAttachment({parent:t,x:1,y:1}),e.spawn("BattleshipHull").setAttachment({parent:t,x:2,y:1}),e.spawn("MachineGun").setAttachment({parent:t,x:0,y:1}),e.spawn("HomingMissileLauncher").setAttachment({parent:t,x:2,y:1}),t}function Dt(e){return new p(e,"BattleshipHull").setAppearance({glyph:"/",layer:u.Ship,fg:W.Colors.WHITE,bg:W.Colors.BROWN}).setSolid(!0)}var N={};T(N,{Bullet:()=>Wt,HomingMissile:()=>Kt});var q=x(y());function Wt(e){return new p(e,"Bullet").setProjectile(!0).setAppearance({glyph:".",layer:u.Bullet,fg:q.Colors.YELLOW})}function Kt(e){return new p(e,"HomingMissile").setProjectile(!0).setHoming({strength:.15,duration:10}).setTrail({effectPrefab:"SmokePuff"}).setExplodes({size:5,falloff:1}).setAppearance({glyph:"*",layer:u.Bullet,fg:q.Colors.DARK_RED})}var j={};T(j,{AirFistRange:()=>qt,SmokePuff:()=>Nt});var P=x(y());function qt(e){return new p(e,"AirFistRange").setAppearance({glyph:" ",layer:u.Effect,bg:(0,P.fromRgb)(0,255,255,100),blendMode:P.BlendMode.Add}).setLifetime({duration:2})}function Nt(e){return new p(e,"SmokePuff").setAppearance({glyph:" ",layer:u.Effect,bg:(0,P.fromRgb)(100,100,100,50),blendMode:P.BlendMode.Add}).setLifetime({duration:2})}var Y={};T(Y,{HomingMissileLauncher:()=>Vt,MachineGun:()=>jt});var Q=x(y());var V=({bulletPrefab:e="Bullet",bulletVelocity:t=1,salvoCount:i=1,timeBetweenShots:o=1,timeBetweenSalvos:r=1})=>({bulletPrefab:e,bulletVelocity:t,salvoCount:i,timeBetweenShots:o,timeBetweenSalvos:r,timer:0,salvo:i});function jt(e){return new p(e,"MachineGun").setAppearance({glyph:"o",layer:u.Gun,fg:Q.Colors.WHITE}).setTurret(V({bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:5,timeBetweenShots:0,timeBetweenSalvos:12}))}function Vt(e){return new p(e,"HomingMissileLauncher").setAppearance({glyph:"o",layer:u.Gun,fg:Q.Colors.YELLOW}).setTurret(V({bulletPrefab:"HomingMissile",bulletVelocity:1,salvoCount:1,timeBetweenSalvos:8}))}var O={};T(O,{Player:()=>Qt,PlayerHull:()=>Yt});var _=x(y());function Qt(e){let t=new p(e,"Player").setPlayer(!0);e.spawn("PlayerHull").setAttachment({parent:t,x:0,y:0});let i=e.spawn("PlayerHull").setAttachment({parent:t,x:1,y:0});return i.appearance.glyph=">",t}function Yt(e){return new p(e,"PlayerHull").setSolid(!0).setAppearance({glyph:"#",layer:u.Player,fg:_.Colors.WHITE,bg:_.Colors.DARK_RED})}var _t=h(h(h(h(h({},K),N),j),Y),O);function X(e,t){return e.add(_t[t](e))}function E(e){return typeof e=="undefined"?NaN:Math.floor(e)}function w(e){return{x:E(e.x),y:E(e.y)}}function I(e,t){let i=w(e),o=w(t);return i.x===o.x&&i.y===o.y}function L(e,t){return{x:e.x+t.x,y:e.y+t.y}}var C=class{constructor(t,i=[]){this.compareFn=t;this.entities=i;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}add(t){this.entities.push(t),this.dirty=!0}clearDead(){this.entities=this.entities.filter(t=>t.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var d=class{constructor(t,i){this.list=t;this.filter=i}matches(t){if(!t.alive)return!1;for(let i of this.filter)if(!t[i])return!1;return!0}forEach(t){for(let i of this.list.get())this.matches(i)&&t(i,i)}};function $(e){let t=new d(e.entities,["appearance","position"]);e.on("draw",()=>t.forEach(({appearance:i,position:o})=>e.drawIfVisible(E(o.x),E(o.y),i.glyph,i.fg,i.bg,i.blendMode)))}var dt=x(y());var G=x(y());function M(e,t,i){return e*(1-i)+t*i}var k=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[i])=>t-i)}add(t,i){return this.points.push([t,i]),this.sort(),this}get(t){let[i,o]=this.points[0];if(t<=i)return(0,G.fromRgb)(...o);let[r,n]=this.points[this.points.length-1];if(t>=r)return(0,G.fromRgb)(...n);let s=this.points.findIndex(([kt])=>kt>t),[a,[l,m,f,c]]=this.points[s-1],[b,[D,R,Tt,Ct]]=this.points[s],F=(t-a)/(b-a);return(0,G.fromRgb)(M(l,D,F),M(m,R,F),M(f,Tt,F),M(c,Ct,F))}};function H(e,t){let i=Math.abs(e.x-t.x),o=Math.abs(e.y-t.y);return Math.sqrt(i*i+o*o)}var Ot={fire:new k([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function J(e){if(!(e.intensity<=0))return{glyph:" ",layer:u.Effect,bg:Ot[e.type].get(e.intensity),blendMode:dt.BlendMode.Add}}function ct(e,t){let i=[],o=Math.floor(e.x-t),r=Math.ceil(e.x+t),n=Math.floor(e.y-t),s=Math.ceil(e.y+t);for(let a=n;a<=s;a++)for(let l=o;l<=r;l++){let m=H(e,{x:l,y:a});m>=t||i.push({x:l,y:a,intensity:t-m})}return i}function U(e){e.on("kill",({e:t})=>{let{explodes:i,name:o,position:r}=t;if(i&&r)for(let{x:n,y:s,intensity:a}of ct(r,i.size))e.add(new p(e,o+"Explosion").setPosition({x:n,y:s}).setField({type:"fire",intensity:a,falloff:i.falloff}))})}function Z(e){let t=new d(e.entities,["field","position"]);e.on("tick",()=>t.forEach(({field:i},o)=>{i.intensity-=i.falloff,o.setAppearance(J(i)),i.intensity<=0&&e.delete(o)})),e.on("spawn",({e:i})=>{i.field&&i.setAppearance(J(i.field))})}var ht=Math.PI*2;function v(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}function yt(e,t){let i=(e-t)%ht,o=(t-e)%ht;return i<o?-i:o}function Et(e){let t=Math.cos(e.angle)*e.vel,i=Math.sin(e.angle)*e.vel;return[t,i]}function gt(e,t){let i=e.getRoot(t);return e.entities.get().filter(o=>e.getRoot(o)===i)}function z(e,t){return gt(e,t).map(i=>i.id)}function xt(e,t){let i=gt(e,t),o=[];for(let r of i){let{attachment:n,solid:s}=r;n&&s&&o.push([{x:n.x,y:n.y},r])}return{layout:o,topLeft:e.getRoot(t).position}}function bt(e,t,i){let o=z(e,t),{layout:r}=xt(e,t),n=[];for(let[s]of r){let a=L(i,s),{wall:l,solid:m}=e.getContents(a,o);l?n.push([a,"wall"]):m&&n.push([a,m])}return n}function A(e,t){let{layout:i,topLeft:o}=xt(e,t);if(!o||!i.length)throw new Error(`Could not get midpoint of entity#${t.id}`);let r=n=>i.reduce((s,[a])=>s+a[n],0)/i.length;return{x:o.x+r("x"),y:o.y+r("y")}}function tt(e){let t=new d(e.entities,["homing","motion","position"]);e.on("tick",()=>t.forEach(({homing:i,motion:o,position:r},n)=>{let s=A(e,e.player),a=v(r,s),l=yt(o.angle,a);Math.abs(l)<=i.strength?o.angle=a:l<0?o.angle-=i.strength:o.angle+=i.strength,--i.duration<=0&&(n.setHoming(),n.setTrail())}))}function et(e){let t=new d(e.entities,["lifetime"]);e.on("tick",()=>t.forEach(({lifetime:i},o)=>{--i.duration<=0&&e.delete(o)}))}function wt(e,t){let i=t.x-e.x,o=t.y-e.y,r=Math.abs(i),n=Math.abs(o),s=i>0?1:-1,a=o>0?1:-1,l=h({},e),m=[h({},l)];for(let f=0,c=0;f<r||c<n;)(.5+f)/r<(.5+c)/n?(l.x+=s,f++):(l.y+=a,c++),m.push(h({},l));return m}function Pt(e,t,i){let o=[],r=(n,s)=>{let a=E(n),l=E(s);o.find(m=>m.x===a&&m.y===l)||o.push({x:a,y:l})};for(let n=0;n<=Math.floor(i*Math.sqrt(.5));n++){let s=Math.floor(Math.sqrt(i*i-n*n));r(e-s,t+n),r(e+s,t+n),r(e-s,t-n),r(e+s,t-n),r(e+n,t-s),r(e+n,t+s),r(e-n,t-s),r(e-n,t+s)}return o}function it(e){let t=new d(e.entities,["motion","position"]);e.on("tick",()=>t.forEach(({motion:i,position:o,ignoreSolid:r},n)=>{let[s,a]=Et(i),l={x:o.x+s,y:o.y+a},m=wt(w(o),w(l)),f=!1,c;for(let b of m){e.move(n,b);let{wall:D,solid:R}=e.getContents(b,r==null?void 0:r.ids);if(D){f=!0;break}else if(R){c=R;break}}f||c?e.delete(n):e.move(n,l)}))}function ot(e){e.on("playerMove",({move:t})=>{let i=e.player,o=L(i.position,t);bt(e,i,o).length||(i.move(o.x,o.y),e.fovRecompute=!0,e.tick())})}function nt(e){e.on("move",({e:t,old:i,pos:o})=>{t.trail&&!I(i,o)&&e.spawn(t.trail.effectPrefab).setPosition(i)})}function rt(e){return e.timer?(e.timer--,e.timer<=0&&e.salvo<=0&&(e.salvo=e.salvoCount),!1):(--e.salvo<=0?e.timer=e.timeBetweenSalvos:e.timer=e.timeBetweenShots,!0)}function st(e){let t=new d(e.entities,["position","turret"]);e.on("tick",()=>t.forEach(({position:i,turret:o},r)=>{if(rt(o)){let n={x:i.x+.5,y:i.y+.5},s=A(e,e.player);e.spawn(o.bulletPrefab).setIgnoreSolid({ids:z(e,r)}).setPosition(n).setMotion({angle:v(n,s),vel:o.bulletVelocity})}}))}function Mt(e){et(e),tt(e),st(e),Z(e),it(e),$(e),nt(e),U(e),ot(e)}function vt(e,t,i){for(let o of e.entities.get()){let{motion:r,projectile:n,position:s}=o;if(r&&n&&s&&H(t,s)<=i){let a=v(t,s);r.angle=a,o.setIgnoreSolid()}}for(let o of Pt(t.x,t.y,i))e.spawn("AirFistRange").setPosition(o)}var Xt=60,$t=40,B=class{constructor(t,i=Xt,o=$t){this.term=t;this.mapWidth=i;this.mapHeight=o;t.update=this.update.bind(this),this.dirty=!0,this.fovRecompute=!0,this.map=new g.Console(i,o,()=>!0),this.lastEntityId=0,this.entities=new C(ft),this.eventCallbacks={draw:[],kill:[],move:[],playerMove:[],spawn:[],tick:[]},Mt(this)}get player(){let t=this.entities.get().find(i=>i.player);if(!t)throw new Error("Could not find a player!");return t}fire(t,i){for(let o of this.eventCallbacks[t])o(i)}on(t,i){this.eventCallbacks[t].push(i)}spawn(t){return X(this,t)}add(t){return this.dirty=!0,this.entities.add(t),this.fire("spawn",{e:t}),t}delete(t){t.alive&&(t.kill(),this.fire("kill",{e:t}))}move(t,i){let o=t.position;t.move(i.x,i.y),o&&this.fire("move",{e:t,old:o,pos:i})}gotoDemoRoom(){this.entities.clear(),this.map.clear(),this.room(1,1,40,30),this.spawn("Player").move(5,25),this.spawn("Battleship").move(8,5)}room(t,i,o,r){let{map:n}=this;for(let s=0;s<r;s++)for(let a=0;a<o;a++){let l=a===0||s===0||a===o-1||s===r-1,m=t+a,f=i+s;n.setBlocked(m,f,l),n.setBlockedSight(m,f,l)}}drawIfVisible(t,i,o,r,n,s){this.map.isVisible(t,i)&&(s?this.term.drawCell(t,i,{bg:n},s):this.term.drawChar(t,i,o,r,n))}draw(){let{map:t,mapWidth:i,mapHeight:o,player:r,term:n}=this;this.fovRecompute&&(t.computeFov(r.position.x,r.position.y,20),this.fovRecompute=!1);for(let s=0;s<o;s++)for(let a=0;a<i;a++){let l=t.grid[s][a],m=t.isVisible(a,s),f=l.blockedSight,c=g.Colors.BLACK;m?(c=f?g.Colors.WHITE:g.Colors.DARK_GRAY,l.explored=!0):l.explored&&(c=f?g.Colors.LIGHT_GRAY:g.Colors.BLACK),n.drawChar(a,s,0,0,c)}this.fire("draw",void 0),this.dirty=!1}getRoot(t){return t.attachment?this.getRoot(t.attachment.parent):t}getContents(t,i=[]){let o=w(t),r=this.map.isBlocked(o.x,o.y),n=this.entities.get().filter(a=>a.position&&I(o,a.position)),s=n.filter(a=>!i.includes(a.id)).find(a=>a.solid);return{wall:r,solid:s,other:n.filter(a=>!a.solid)}}tick(){this.fire("tick",void 0),this.entities.clearDead()}handleKeys(){let t=this.term.getMovementKey();if(t){this.fire("playerMove",{move:t});return}if(this.term.isKeyPressed(g.Key.VK_F)){vt(this,A(this,this.player),4.5),this.tick();return}}update(){this.handleKeys(),this.dirty&&this.draw()}};var At=x(y());function Jt(e){let o=document.createElement("div");e.appendChild(o);let r=()=>{let f=Math.floor(window.innerWidth/480),c=Math.floor(window.innerHeight/320),b=Math.min(f,c);o.style.width=`${480*b}px`,o.style.height=`${320*b}px`};window.addEventListener("resize",r),r();let n=document.createElement("canvas");o.appendChild(n),requestAnimationFrame(()=>n.focus());let s=new At.Terminal(n,60,40),a=new B(s);a.gotoDemoRoom(),window.g=a}window.addEventListener("load",()=>Jt(document.body));})();
//# sourceMappingURL=bundle.js.map
