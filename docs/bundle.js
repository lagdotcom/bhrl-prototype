"use strict";(()=>{var Dt=Object.create;var vt=Object.defineProperty;var Jt=Object.getOwnPropertyDescriptor;var Ft=Object.getOwnPropertyNames;var Kt=Object.getPrototypeOf,zt=Object.prototype.hasOwnProperty;var f=(s,t)=>()=>(t||s((t={exports:{}}).exports,t),t.exports);var Gt=(s,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Ft(t))!zt.call(s,r)&&r!==e&&vt(s,r,{get:()=>t[r],enumerable:!(i=Jt(t,r))||i.enumerable});return s};var S=(s,t,e)=>(e=s!=null?Dt(Kt(s)):{},Gt(t||!s||!s.__esModule?vt(e,"default",{value:s,enumerable:!0}):e,s));var I=f((De,Pt)=>{Pt.exports=globalThis.wglt});var At=f(($e,Bt)=>{Bt.exports=globalThis.RBush});var V=f((Qe,wt)=>{wt.exports=globalThis.SAT});var B=f(y=>{"use strict";var $t=y&&y.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(y,"__esModule",{value:!0});y.Types=y.SATPolygon=y.SATVector=y.Response=y.RBush=void 0;var Qt=$t(At());Object.defineProperty(y,"RBush",{enumerable:!0,get:function(){return Qt.default}});var et=V();Object.defineProperty(y,"Response",{enumerable:!0,get:function(){return et.Response}});Object.defineProperty(y,"SATVector",{enumerable:!0,get:function(){return et.Vector}});Object.defineProperty(y,"SATPolygon",{enumerable:!0,get:function(){return et.Polygon}});var Ut;(function(s){s.Ellipse="Ellipse",s.Line="Line",s.Circle="Circle",s.Box="Box",s.Point="Point",s.Polygon="Polygon"})(Ut=y.Types||(y.Types={}))});var w=f(a=>{"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.generateId=a.toJSON=a.drawPolygon=a.getSATFunction=a.getBounceDirection=a.ensureConvex=a.mapArrayToVector=a.mapVectorToArray=a.intersectLinePolygon=a.intersectLineLine=a.intersectLineCircle=a.dashLineTo=a.clonePointsArray=a.checkAInB=a.intersectAABB=a.bodyMoved=a.extendBody=a.clockwise=a.distance=a.ensurePolygonPoints=a.ensureVectorPoint=a.createBox=a.createEllipse=void 0;var x=V(),k=B();function Zt(s,t=s,e=1){let i=Math.PI*Math.hypot(s,t)*2,r=Math.max(8,Math.ceil(i/Math.max(1,e)));return Array.from({length:r},(o,n)=>{let c=n/r*2*Math.PI,h=Math.cos(c)*s,l=Math.sin(c)*t;return new x.Vector(h,l)})}a.createEllipse=Zt;function te(s,t){return[new x.Vector(0,0),new x.Vector(s,0),new x.Vector(s,t),new x.Vector(0,t)]}a.createBox=te;function bt(s={}){return s instanceof x.Vector?s:new x.Vector(s.x||0,s.y||0)}a.ensureVectorPoint=bt;function ee(s){if(!s)throw new Error("No points array provided");let t=s.map(bt);return Ct(t)?t.reverse():t}a.ensurePolygonPoints=ee;function se(s,t){return Math.hypot(s.x-t.x,s.y-t.y)}a.distance=se;function Ct(s){let t=0;for(let e=0;e<s.length;e++){let i=s[e],r=s[(e+1)%s.length];t+=(r.x-i.x)*(r.y+i.y)}return t>0}a.clockwise=Ct;function ie(s,t){s.isStatic=!!t?.isStatic,s.isTrigger=!!t?.isTrigger,s.padding=t?.padding||0,t?.center&&s.center(),s.setAngle(t?.angle||0)}a.extendBody=ie;function re(s){return s.bbox.minX<s.minX||s.bbox.minY<s.minY||s.bbox.maxX>s.maxX||s.bbox.maxY>s.maxY}a.bodyMoved=re;function ne(s,t){return!(t.minX>s.maxX||t.minY>s.maxY||t.maxX<s.minX||t.maxY<s.minY)}a.intersectAABB=ne;function oe(s,t){let e=s.minX>=t.minX&&s.maxX<=t.maxX,i=s.minY>=t.minY&&s.maxY<=t.maxY;return e&&i}a.checkAInB=oe;function ce(s){return s.map(({x:t,y:e})=>({x:t,y:e}))}a.clonePointsArray=ce;function Tt(s,t,e,i,r,o=2,n=4){let c=i-t,h=r-e,l=Math.atan2(h,c),u=Math.cos(l),p=Math.sin(l),v=t,Z=e,tt=Math.hypot(c,h);for(;tt>0;){let gt=Math.min(tt,o);s.moveTo(v,Z),s.lineTo(v+u*gt,Z+p*gt),v+=u*(o+n),Z+=p*(o+n),tt-=o+n}}a.dashLineTo=Tt;function ae(s,t){let e={x:s.end.x-s.start.x,y:s.end.y-s.start.y},i={x:s.start.x-t.pos.x,y:s.start.y-t.pos.y},r=(e.x*i.x+e.y*i.y)*-2,o=(e.x*e.x+e.y*e.y)*2,n=Math.sqrt(r*r-(i.x*i.x+i.y*i.y-t.r*t.r)*o*2);if(isNaN(n))return[];let c=(r-n)/o,h=(r+n)/o,l=[];return c<=1&&c>=0&&l.push({x:s.start.x+e.x*c,y:s.start.y+e.y*c}),h<=1&&h>=0&&l.push({x:s.start.x+e.x*h,y:s.start.y+e.y*h}),l}a.intersectLineCircle=ae;function Et(s,t){let e=s.end.x-s.start.x,i=s.end.y-s.start.y,r=e*(t.end.y-t.start.y)-(t.end.x-t.start.x)*i;if(r===0)return null;let o=((t.end.y-t.start.y)*(t.end.x-s.start.x)+(t.start.x-t.end.x)*(t.end.y-s.start.y))/r,n=((s.start.y-s.end.y)*(t.end.x-s.start.x)+e*(t.end.y-s.start.y))/r;return!(o>=0&&o<=1)||!(n>=0&&n<=1)?null:{x:s.start.x+o*e,y:s.start.y+o*i}}a.intersectLineLine=Et;function he(s,t){return t.calcPoints.map((e,i)=>{let r=i?t.calcPoints[i-1]:t.calcPoints[t.calcPoints.length-1],o={start:{x:r.x+t.pos.x,y:r.y+t.pos.y},end:{x:e.x+t.pos.x,y:e.y+t.pos.y}};return Et(s,o)}).filter(e=>!!e)}a.intersectLinePolygon=he;function le({x:s,y:t}){return[s,t]}a.mapVectorToArray=le;function ue([s,t]){return{x:s,y:t}}a.mapArrayToVector=ue;function pe(s){return s.isConvex||s.type!==k.Types.Polygon?[s]:s.convexPolygons}a.ensureConvex=pe;function fe(s,t){let e=new x.Vector(t.x-s.x,t.y-s.y),i=new x.Vector(s.x-t.x,s.y-t.y),r=i.dot(e.normalize())*2;return new x.Vector(e.x*r-i.x,e.y*r-i.y).normalize()}a.getBounceDirection=fe;function ye(s,t){return s.type===k.Types.Circle?t.type===k.Types.Circle?x.testCircleCircle:x.testCirclePolygon:t.type===k.Types.Circle?x.testPolygonCircle:x.testPolygonPolygon}a.getSATFunction=ye;function me(s,{pos:t,calcPoints:e},i=!1){[...e,e[0]].forEach((o,n)=>{let c=t.x+o.x,h=t.y+o.y,l=e[n-1]||e[e.length-1];if(!n)e.length===1?s.arc(c,h,1,0,Math.PI*2):s.moveTo(c,h);else if(e.length>1)if(i){let u=t.x+l.x,p=t.y+l.y;Tt(s,u,p,c,h)}else s.lineTo(c,h)})}a.drawPolygon=me;function de(s){return Object.entries(s).reduce((t,[e,i])=>e!=="system"?Object.assign(Object.assign({},t),{[e]:i}):t,{})}a.toJSON=de;var xe=0;function ge(){return(++xe).toString(36)}a.generateId=ge});var it=f(R=>{"use strict";Object.defineProperty(R,"__esModule",{value:!0});R.Circle=void 0;var ve=V(),Pe=B(),X=w(),st=class extends ve.Circle{constructor(t,e,i){super((0,X.ensureVectorPoint)(t),e),this.offsetCopy={x:0,y:0},this.padding=0,this.angle=0,this.isConvex=!0,this.isCentered=!0,this.type=Pe.Types.Circle,(0,X.extendBody)(this,i),this.radiusBackup=e,this.uid=(0,X.generateId)()}get x(){return this.pos.x}set x(t){var e;this.pos.x=t,(e=this.system)===null||e===void 0||e.insert(this)}get y(){return this.pos.y}set y(t){var e;this.pos.y=t,(e=this.system)===null||e===void 0||e.insert(this)}get scale(){return this.r/this.radiusBackup}set scale(t){this.setScale(t)}get scaleX(){return this.scale}get scaleY(){return this.scale}setPosition(t,e){var i;this.pos.x=t,this.pos.y=e,(i=this.system)===null||i===void 0||i.insert(this)}setScale(t,e){this.r=this.radiusBackup*t}setAngle(t){this.angle=t;let{x:e,y:i}=this.getOffsetWithAngle();return this.offset.x=e,this.offset.y=i,this}setOffset(t){this.offsetCopy.x=t.x,this.offsetCopy.y=t.y;let{x:e,y:i}=this.getOffsetWithAngle();return this.offset.x=e,this.offset.y=i,this}getAABBAsBBox(){let t=this.pos.x+this.offset.x,e=this.pos.y+this.offset.y;return{minX:t-this.r,maxX:t+this.r,minY:e-this.r,maxY:e+this.r}}draw(t){let e=this.pos.x+this.offset.x,i=this.pos.y+this.offset.y;if(this.isTrigger){let r=Math.max(8,this.r);for(let o=0;o<r;o++){let n=o/r*2*Math.PI,c=(o-1)/r*2*Math.PI,h=e+Math.cos(c)*this.r,l=i+Math.sin(c)*this.r,u=e+Math.cos(n)*this.r,p=i+Math.sin(n)*this.r;(0,X.dashLineTo)(t,h,l,u,p)}}else t.moveTo(e+this.r,i),t.arc(e,i,this.r,0,Math.PI*2)}center(){}toJSON(){return(0,X.toJSON)(this)}getOffsetWithAngle(){if(!this.angle)return this.offsetCopy;let t=Math.sin(this.angle),e=Math.cos(this.angle),i=this.offsetCopy.x*e-this.offsetCopy.y*t,r=this.offsetCopy.x*t+this.offsetCopy.y*e;return{x:i,y:r}}};R.Circle=st});var St=f((es,Mt)=>{Mt.exports=globalThis.decomp});var O=f(W=>{"use strict";Object.defineProperty(W,"__esModule",{value:!0});W.Polygon=void 0;var _e=St(),It=V(),Vt=B(),P=w(),rt=class extends It.Polygon{constructor(t,e,i){if(super((0,P.ensureVectorPoint)(t),(0,P.ensurePolygonPoints)(e)),this.padding=0,this.type=Vt.Types.Polygon,this.scaleVector={x:1,y:1},!e?.length)throw new Error("No points in polygon");(0,P.extendBody)(this,i),this.uid=(0,P.generateId)()}get x(){return this.pos.x}set x(t){var e;this.pos.x=t,this.updateConvexPolygonPositions(),(e=this.system)===null||e===void 0||e.insert(this)}get y(){return this.pos.y}set y(t){var e;this.pos.y=t,this.updateConvexPolygonPositions(),(e=this.system)===null||e===void 0||e.insert(this)}get scaleX(){return this.scaleVector.x}get scaleY(){return this.scaleVector.y}get scale(){return this.scaleVector.x}set scale(t){this.setScale(t)}setPosition(t,e){var i;this.pos.x=t,this.pos.y=e,this.updateConvexPolygonPositions(),(i=this.system)===null||i===void 0||i.insert(this)}setScale(t,e=t){this.scaleVector.x=t,this.scaleVector.y=e,this.points.forEach((i,r)=>{i.x=this.pointsBackup[r].x*t,i.y=this.pointsBackup[r].y*e}),super.setPoints(this.points)}getAABBAsBBox(){let{pos:t,w:e,h:i}=this.getAABBAsBox();return{minX:t.x,minY:t.y,maxX:t.x+e,maxY:t.y+i}}draw(t){(0,P.drawPolygon)(t,this,this.isTrigger)}getCentroidWithoutRotation(){let t=this.angle;this.setAngle(0);let e=this.getCentroid();return this.setAngle(t),e}setPoints(t){return super.setPoints(t),this.updateIsConvex(),this.pointsBackup=(0,P.clonePointsArray)(t),this}translate(t,e){return super.translate(t,e),this.pointsBackup=(0,P.clonePointsArray)(this.points),this}rotate(t){return super.rotate(t),this.pointsBackup=(0,P.clonePointsArray)(this.points),this}center(){if(this.isCentered)return;let{x:t,y:e}=this.getCentroidWithoutRotation();this.translate(-t,-e),this.pos.x+=t,this.pos.y+=e,this.isCentered=!0}toJSON(){return(0,P.toJSON)(this)}updateConvexPolygonPositions(){var t;(t=this.convexPolygons)===null||t===void 0||t.forEach(e=>{e.pos.x=this.pos.x,e.pos.y=this.pos.y})}getConvex(){return this.type&&this.type!==Vt.Types.Polygon||this.points.length<=3?[]:(0,_e.quickDecomp)(this.calcPoints.map(P.mapVectorToArray))}updateConvexPolygons(t=this.getConvex()){this.isConvex||(this.convexPolygons||(this.convexPolygons=[]),t.forEach((e,i)=>{this.convexPolygons[i]||(this.convexPolygons[i]=new It.Polygon),this.convexPolygons[i].pos.x=this.pos.x,this.convexPolygons[i].pos.y=this.pos.y,this.convexPolygons[i].setPoints((0,P.ensurePolygonPoints)(e.map(P.mapArrayToVector)))}),this.convexPolygons.length=t.length)}updateIsConvex(){let t=this.getConvex();this.isConvex=t.length<=1,this.updateConvexPolygons(t)}};W.Polygon=rt});var ot=f(N=>{"use strict";Object.defineProperty(N,"__esModule",{value:!0});N.Ellipse=void 0;var Be=B(),H=w(),Ae=O(),nt=class extends Ae.Polygon{constructor(t,e,i=e,r=(e+i)/Math.PI,o){super(t,(0,H.createEllipse)(e,i,r),o),this.type=Be.Types.Ellipse,this.isCentered=!0,this.isConvex=!0,this._radiusX=e,this._radiusY=i,this._step=r}get step(){return this._step}set step(t){this._step=t,this.setPoints((0,H.createEllipse)(this._radiusX,this._radiusY,this._step))}get radiusX(){return this._radiusX}set radiusX(t){this._radiusX=t,this.setPoints((0,H.createEllipse)(this._radiusX,this._radiusY,this._step))}get radiusY(){return this._radiusY}set radiusY(t){this._radiusY=t,this.setPoints((0,H.createEllipse)(this._radiusX,this._radiusY,this._step))}center(){}updateIsConvex(){}};N.Ellipse=nt});var J=f(D=>{"use strict";Object.defineProperty(D,"__esModule",{value:!0});D.Box=void 0;var we=B(),ct=w(),be=O(),at=class extends be.Polygon{constructor(t,e,i,r){super(t,(0,ct.createBox)(e,i),r),this.type=we.Types.Box,this.isConvex=!0,this._width=e,this._height=i}get width(){return this._width}set width(t){this._width=t,this.setPoints((0,ct.createBox)(this._width,this._height))}get height(){return this._height}set height(t){this._height=t,this.setPoints((0,ct.createBox)(this._width,this._height))}updateIsConvex(){}};D.Box=at});var lt=f(F=>{"use strict";Object.defineProperty(F,"__esModule",{value:!0});F.Point=void 0;var Ce=B(),Te=w(),Ee=J(),ht=class extends Ee.Box{constructor(t,e){super((0,Te.ensureVectorPoint)(t),.001,.001,e),this.type=Ce.Types.Point}};F.Point=ht});var z=f(K=>{"use strict";Object.defineProperty(K,"__esModule",{value:!0});K.Line=void 0;var Me=V(),Se=B(),Ie=O(),ut=class extends Ie.Polygon{constructor(t,e,i){if(super(t,[{x:0,y:0},{x:e.x-t.x,y:e.y-t.y}],i),this.type=Se.Types.Line,this.isConvex=!0,this.calcPoints.length===1||!e)throw console.error({start:t,end:e}),new Error("No end point for line provided")}get start(){return{x:this.x+this.calcPoints[0].x,y:this.y+this.calcPoints[0].y}}set start({x:t,y:e}){this.x=t,this.y=e}get end(){return{x:this.x+this.calcPoints[1].x,y:this.y+this.calcPoints[1].y}}set end({x:t,y:e}){this.points[1].x=t-this.start.x,this.points[1].y=e-this.start.y,this.setPoints(this.points)}getCentroid(){return new Me.Vector((this.end.x-this.start.x)/2,(this.end.y-this.start.y)/2)}updateIsConvex(){}};K.Line=ut});var qt=f(G=>{"use strict";Object.defineProperty(G,"__esModule",{value:!0});G.BaseSystem=void 0;var Ve=J(),Oe=it(),qe=ot(),Ye=z(),Le=lt(),Xe=O(),je=B(),Ot=w(),pt=class extends je.RBush{draw(t){this.all().forEach(e=>{e.draw(t)})}drawBVH(t){let e=({minX:i,maxX:r,minY:o,maxY:n,children:c})=>{(0,Ot.drawPolygon)(t,{pos:{x:i,y:o},calcPoints:(0,Ot.createBox)(r-i,n-o)}),c?.forEach(e)};this.data.children.forEach(e)}createPoint(t,e){let i=new Le.Point(t,e);return this.insert(i),i}createLine(t,e,i){let r=new Ye.Line(t,e,i);return this.insert(r),r}createCircle(t,e,i){let r=new Oe.Circle(t,e,i);return this.insert(r),r}createBox(t,e,i,r){let o=new Ve.Box(t,e,i,r);return this.insert(o),o}createEllipse(t,e,i=e,r,o){let n=new qe.Ellipse(t,e,i,r,o);return this.insert(n),n}createPolygon(t,e,i){let r=new Xe.Polygon(t,e,i);return this.insert(r),r}};G.BaseSystem=pt});var Yt=f(Q=>{"use strict";Object.defineProperty(Q,"__esModule",{value:!0});Q.System=void 0;var ke=qt(),Re=z(),$=B(),_=w(),ft=class extends ke.BaseSystem{constructor(){super(...arguments),this.response=new $.Response,this.bodies={},this.state={collides:!1,aInB:!1,bInA:!1,overlapV:new $.SATVector}}remove(t,e){return t.system&&delete t.system.bodies[t.uid],t.system=void 0,super.remove(t,e)}insert(t){return t.bbox=t.getAABBAsBBox(),t.system&&!(0,_.bodyMoved)(t)?this:(t.system&&t.system.remove(t),t.minX=t.bbox.minX-t.padding,t.minY=t.bbox.minY-t.padding,t.maxX=t.bbox.maxX+t.padding,t.maxY=t.bbox.maxY+t.padding,t.system=this,this.bodies[t.uid]=t,super.insert(t))}updateBody(t){this.insert(t)}update(){this.all().forEach(t=>{t.isStatic||this.insert(t)})}separate(){this.checkAll(({a:t,overlapV:e})=>{if(t.isTrigger)return!1;t.setPosition(t.x-e.x,t.y-e.y)})}checkOne(t,e){return t.isStatic?!1:this.search(t).some(i=>{if(i!==t&&this.checkCollision(t,i))return e(this.response)})}checkAll(t){return this.all().some(e=>this.checkOne(e,t))}getPotentials(t){return this.search(t).filter(e=>e!==t)}checkCollision(t,e){if(t.bbox&&e.bbox&&!(0,_.intersectAABB)(t.bbox,e.bbox))return!1;let i=(0,_.getSATFunction)(t,e);if(this.state.collides=!1,this.response.clear(),t.isConvex&&e.isConvex)this.state.collides=i(t,e,this.response);else if(t.isConvex&&!e.isConvex)(0,_.ensureConvex)(e).forEach(r=>{this.test(i,t,r)});else if(!t.isConvex&&e.isConvex)(0,_.ensureConvex)(t).forEach(r=>{this.test(i,r,e)});else{let r=(0,_.ensureConvex)(t),o=(0,_.ensureConvex)(e);r.forEach(n=>{o.forEach(c=>{this.test(i,n,c)})})}return(!t.isConvex||!e.isConvex)&&(this.response.a=t,this.response.b=e,this.state.collides&&(this.response.overlapV=this.state.overlapV,this.response.overlapN=this.response.overlapV.clone().normalize(),this.response.overlap=this.response.overlapV.len()),this.response.aInB=t.isConvex?this.state.aInB:(0,_.checkAInB)(t,e),this.response.bInA=e.isConvex?this.state.bInA:(0,_.checkAInB)(e,t)),this.state.collides}raycast(t,e,i=()=>!0){let r=1/0,o=null;return this.ray?(this.ray.start=t,this.ray.end=e):this.ray=new Re.Line(t,e,{isTrigger:!0}),this.insert(this.ray),this.checkOne(this.ray,({b:n})=>{if(!i(n))return!1;(n.type===$.Types.Circle?(0,_.intersectLineCircle)(this.ray,n):(0,_.intersectLinePolygon)(this.ray,n)).forEach(h=>{let l=(0,_.distance)(t,h);l<r&&(r=l,o={point:h,collider:n})})}),this.remove(this.ray),o}clear(){return super.clear(),this.bodies={},this}traverse(t,{children:e}=this.data){return e?.find((i,r)=>{if(!i)return!1;if(i.type&&t(i,e,r))return!0;i.children&&this.traverse(t,i)})}fromJSON(t){return this.traverse((e,i,r)=>{this.bodies[e.uid]&&(this.bodies[e.uid]=i[r]=Object.assign(this.bodies[e.uid],e))},t),super.fromJSON(t),this}test(t,e,i){let r=t(e,i,this.response);r&&(this.state.collides||(this.state.aInB=!1,this.state.bInA=!1,this.state.overlapV=new $.SATVector),this.state.overlapV.add(this.response.overlapV)),this.state.aInB=this.state.aInB||this.response.aInB,this.state.bInA=this.state.bInA||this.response.bInA,this.state.collides=r||this.state.collides,this.response.clear()}};Q.System=ft});var Lt=f(m=>{"use strict";var We=m&&m.__createBinding||(Object.create?function(s,t,e,i){i===void 0&&(i=e);var r=Object.getOwnPropertyDescriptor(t,e);(!r||("get"in r?!t.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return t[e]}}),Object.defineProperty(s,i,r)}:function(s,t,e,i){i===void 0&&(i=e),s[i]=t[e]}),b=m&&m.__exportStar||function(s,t){for(var e in s)e!=="default"&&!Object.prototype.hasOwnProperty.call(t,e)&&We(t,s,e)};Object.defineProperty(m,"__esModule",{value:!0});b(B(),m);b(it(),m);b(ot(),m);b(O(),m);b(J(),m);b(lt(),m);b(z(),m);b(Yt(),m);b(w(),m)});var T=S(I());var E=class{constructor(t,e){this.x=t;this.y=e}};var d=class{constructor(t,e){this.g=t;this.name=e;this.alive=!0,this.id=++t.lastEntityId,this.Player=!1,this.Projectile=!1,this.Solid=!1}get[Symbol.toStringTag](){return this.name}kill(){return this.alive=!1,this}eachChild(t){var e;for(let i of this.g.entities.get())((e=i.Attachment)==null?void 0:e.parent)===this&&t(i,i.Attachment)}setAppearance(t){return this.g.dirty=!0,this.Appearance=t,this}setAttachment(t){return this.Attachment=t,this}setMotion(t){return this.Motion=t,this}setPosition(t){return this.g.dirty=!0,this.Position=t,this}setTurret(t){return this.Turret=t,this}setPlayer(t){return this.Player=t,this}setProjectile(t){return this.Projectile=t,this}setSolid(t){return this.Solid=t,this}move(t,e){return this.g.dirty=!0,this.Position=new E(t,e),this.eachChild((i,r)=>i.move(t+r.x,e+r.y)),this.Position}};function _t(s,t){var r,o,n,c;let e=(o=(r=s.Appearance)==null?void 0:r.layer)!=null?o:0,i=(c=(n=t.Appearance)==null?void 0:n.layer)!=null?c:0;return e!==i?e-i:s.id-t.id}var M=class{constructor(t,e){this.x=t;this.y=e}static fromAngleAndVelocity(t,e){return new M(Math.cos(t)*e,Math.sin(t)*e)}};var L=class{constructor(t,e=[]){this.compareFn=t;this.items=e;this.dirty=!0}clear(){this.items=[],this.dirty=!1}add(t){this.items.push(t),this.dirty=!0}delete(t){this.items=this.items.filter(e=>e!==t)}sort(){this.items.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.items}};var Ht=S(Lt());var g=class{constructor(t,e,i,r){this.glyph=t;this.layer=e;this.fg=i;this.bg=r}};var C=class{constructor(t,e,i){this.parent=t;this.x=e;this.y=i}};var A=S(I());var q=class{constructor(t,e,i,r,o="idle",n=0,c=0){this.bulletVelocity=t;this.salvoCount=e;this.timeBetweenShots=i;this.timeBetweenSalvos=r;this.mode=o;this.timer=n;this.salvo=c}};function Xt(s){switch(s.mode){case"idle":s.mode="fire",s.salvo=s.salvoCount-1,s.timer=s.timeBetweenShots;break;case"fire":s.timer--,s.salvo>0?s.timer<=0&&(s.mode="mid-salvo"):s.mode="reloading";break;case"mid-salvo":s.mode="fire",s.salvo--,s.salvo>0?s.timer=s.timeBetweenShots:s.timer=s.timeBetweenSalvos;break;case"reloading":s.timer--,s.timer<=0&&(s.mode="idle");break}return s}function yt(s){let t=new d(s,"Battleship"),e=[new d(s,"BattleshipHull").setAttachment(new C(t,1,0)).setAppearance(new g("/",0,A.Colors.WHITE,A.Colors.BROWN)).setSolid(!0),new d(s,"BattleshipHull").setAttachment(new C(t,2,0)).setAppearance(new g("#",0,A.Colors.WHITE,A.Colors.BROWN)).setSolid(!0),new d(s,"BattleshipTurret").setAttachment(new C(t,0,1)).setAppearance(new g("o",0,A.Colors.WHITE,A.Colors.BROWN)).setTurret(new q(3,2,1,5)).setSolid(!0),new d(s,"BattleshipHull").setAttachment(new C(t,1,1)).setAppearance(new g("#",0,A.Colors.WHITE,A.Colors.BROWN)).setSolid(!0),new d(s,"BattleshipTurret").setAttachment(new C(t,2,1)).setAppearance(new g("o",0,A.Colors.WHITE,A.Colors.BROWN)).setTurret(new q(2,5,0,12)).setSolid(!0)];return{ship:t,parts:e}}var kt=S(I());function mt(s){return new d(s,"Bullet").setProjectile(!0).setAppearance(new g(".",1,kt.Colors.YELLOW))}var dt=S(I());function xt(s){return new d(s,"Player").setPlayer(!0).setAppearance(new g(">",2,dt.Colors.WHITE,dt.Colors.DARK_RED))}function U(s){return Math.floor(s)}var Rt=60,Wt=40;function Y(s,t){return s.tag=t,s}var j=class{constructor(t){this.term=t;t.update=this.update.bind(this),this.dirty=!0,this.fovRecompute=!0,this.map=new T.Console(Rt,Wt,()=>!0),this.lastEntityId=0,this.entities=new L(_t)}add(t){this.dirty=!0,this.entities.add(t),t.Player&&(this.player=t)}addMany(t){this.dirty=!0;for(let e of t)this.add(e)}gotoDemoRoom(){this.entities.clear(),this.map.clear(),this.room(1,1,40,30),this.add(xt(this).setPosition(new E(5,25)));let{ship:t,parts:e}=yt(this);this.add(t),this.addMany(e),t.move(8,5)}room(t,e,i,r){let{map:o}=this;for(let n=0;n<r;n++)for(let c=0;c<i;c++){let h=c===0||n===0||c===i-1||n===r-1,l=t+c,u=e+n;o.setBlocked(l,u,h),o.setBlockedSight(l,u,h)}}draw(){let{map:t,player:e,term:i,entities:r}=this;this.fovRecompute&&(t.computeFov(e.Position.x,e.Position.y,20),this.fovRecompute=!1);for(let n=0;n<Wt;n++)for(let c=0;c<Rt;c++){let h=t.grid[n][c],l=t.isVisible(c,n),u=h.blockedSight,p=T.Colors.BLACK;l?(p=u?T.Colors.WHITE:T.Colors.DARK_GRAY,h.explored=!0):h.explored&&(p=u?T.Colors.LIGHT_GRAY:T.Colors.BLACK),i.drawChar(c,n,0,0,p)}let o=(n,c,h,l,u)=>{t.isVisible(n,c)&&i.drawChar(n,c,h,l,u)};for(let n of r.get()){let{Appearance:c,Position:h}=n;c&&h&&o(U(h.x),U(h.y),c.glyph,c.fg,c.bg)}this.dirty=!1}turrets(){let{entities:t}=this,e=this.player.Position;for(let i of t.get()){let{Position:r,Turret:o}=i;if(r&&o&&(Xt(o),o.mode==="fire")){let n=mt(this).setPosition({x:r.x+.5,y:r.y+.5}).setMotion(M.fromAngleAndVelocity(Math.atan2(e.y-r.y,e.x-r.x),o.bulletVelocity));t.add(n)}}}motion(){let{entities:t,map:e,player:i}=this,r=new Ht.System;for(let o=0;o<e.height;o++)for(let n=0;n<e.width;n++)e.isBlocked(n,o)&&Y(r.createBox({x:n,y:o},1,1,{isStatic:!0}),{type:"wall"});for(let o of t.get()){let{Solid:n,Motion:c,Position:h,Projectile:l}=o;if(h){let{x:u,y:p}=h;if(n)Y(r.createBox({x:u,y:p},1,1),{type:"ship",e:o});else if(l&&c){let v={x:u+c.x,y:p+c.y};Y(r.createBox({x:u-.25,y:p-.25},.5,.5),{type:"bullet",e:o}),Y(r.createBox({x:v.x-.5,y:v.y-.25},.5,.5),{type:"bullet",e:o}),Y(r.createLine({x:u,y:p},v),{type:"bullet",e:o}),o.move(v.x,v.y)}}}Y(r.createBox(i.Position,1,1),{type:"player"}),r.update(),r.checkAll(o=>{var h,l,u,p;let n=o.a.tag,c=o.b.tag;if(n.type==="wall"){(h=c.e)!=null&&h.Projectile&&t.delete(c.e);return}if(c.type==="wall"){(l=n.e)!=null&&l.Projectile&&t.delete(n.e);return}n.type==="player"&&c.type==="bullet"&&((u=c.e)!=null&&u.alive)?(c.e.kill(),t.delete(c.e)):c.type==="player"&&n.type==="bullet"&&((p=n.e)!=null&&p.alive)&&(n.e.kill(),t.delete(n.e))})}tick(){this.turrets(),this.motion()}handleKeys(){let{map:t,player:e,term:i}=this,r=i.getMovementKey();if(r){let o=e.Position.x+r.x,n=e.Position.y+r.y;t.isBlocked(o,n)||(e.move(o,n),this.fovRecompute=!0,this.tick())}}update(){this.handleKeys(),this.dirty&&this.draw()}};var Nt=S(I());function He(s){let i=document.createElement("div");s.appendChild(i);let r=()=>{let u=Math.floor(window.innerWidth/480),p=Math.floor(window.innerHeight/320),v=Math.min(u,p);i.style.width=`${480*v}px`,i.style.height=`${320*v}px`};window.addEventListener("resize",r),r();let o=document.createElement("canvas");i.appendChild(o);let n=new Nt.Terminal(o,60,40),c=new j(n);c.gotoDemoRoom(),window.g=c}window.addEventListener("load",()=>He(document.body));})();
//# sourceMappingURL=bundle.js.map
