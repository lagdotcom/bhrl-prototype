"use strict";(()=>{var Mi=Object.create;var Nt=Object.defineProperty,Ai=Object.defineProperties,Ci=Object.getOwnPropertyDescriptor,Hi=Object.getOwnPropertyDescriptors,Ti=Object.getOwnPropertyNames,_e=Object.getOwnPropertySymbols,Bi=Object.getPrototypeOf,je=Object.prototype.hasOwnProperty,Ri=Object.prototype.propertyIsEnumerable;var Ue=(e,t,i)=>t in e?Nt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,k=(e,t)=>{for(var i in t||={})je.call(t,i)&&Ue(e,i,t[i]);if(_e)for(var i of _e(t))Ri.call(t,i)&&Ue(e,i,t[i]);return e},Ve=(e,t)=>Ai(e,Hi(t));var Li=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Z=(e,t)=>{for(var i in t)Nt(e,i,{get:t[i],enumerable:!0})},Ii=(e,t,i,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Ti(t))!je.call(e,r)&&r!==i&&Nt(e,r,{get:()=>t[r],enumerable:!(o=Ci(t,r))||o.enumerable});return e};var D=(e,t,i)=>(i=e!=null?Mi(Bi(e)):{},Ii(t||!e||!e.__esModule?Nt(i,"default",{value:e,enumerable:!0}):i,e));var S=Li((ur,Ye)=>{Ye.exports=globalThis.wglt});var Xt=D(S());var Qt=D(S());function Et(e,t=new Map){if(!e||typeof e!="object")return e;if(t.has(e))return t.get(e);let i;if(e.nodeType&&"cloneNode"in e)i=e.cloneNode(!0),t.set(e,i);else if(e instanceof Date)i=new Date(e.getTime()),t.set(e,i);else if(e instanceof RegExp)i=new RegExp(e),t.set(e,i);else if(Array.isArray(e)){i=new Array(e.length),t.set(e,i);for(let o=0;o<e.length;o++)i[o]=Et(e[o],t)}else if(e instanceof Map){i=new Map,t.set(e,i);for(let[o,r]of e.entries())i.set(o,Et(r,t))}else if(e instanceof Set){i=new Set,t.set(e,i);for(let o of e)i.add(Et(o,t))}else if(e instanceof Object){i={},t.set(e,i);for(let[o,r]of Object.entries(e))i[o]=Et(r,t)}else throw Error(`Unable to clone ${e}`);return i}function $e(e){return Et(e,new Map)}var tt=$e,ze=Object.keys,qe=e=>{let t={};for(let[i,o]of e)t[i]=o;return t};var rt=class{constructor(t,i){this.g=t;this.name=i;this.alive=!0,this.id=++t.lastEntityId,this.solid=!1,this.tags=new Set}applyPrefab(t,i){if(this.prefab=t,i.components&&Object.assign(this,tt(i.components)),i.children)for(let{name:o,x:r,y:n,overlay:a,tags:s}of i.children){let l=this.g.spawn(o).setAttachment({parent:this,x:r,y:n});if(a)for(let m of ze(a))Object.assign(l[m],tt(a[m]));if(s)for(let m of s)l.tags.add(m)}return this}get[Symbol.toStringTag](){return this.name}kill(t){return this.alive=!1,this.eachChild(i=>this.g.kill(i,t)),this}eachChild(t){var i;for(let o of this.g.entities.get())((i=o.attachment)==null?void 0:i.parent)===this&&t(o,o.attachment)}setAI(t){return this.ai=t,this}setAppearance(t){return this.g.refresh(),this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setDelayedShot(t){return this.delayedShot=t,this}setDoubleShot(t){return this.doubleShot=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setItem(t){return this.item=t,this}setLastMovement(t){return this.lastMovement=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setOrigin(t){return this.origin=t,this}setPilot(t){return this.pilot=t,this}setPosition(t){return this.g.refresh(),this.position=t,this}setShip(t){return this.ship=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,i){return this.g.refresh(),this.position={x:t,y:i},this.eachChild((o,r)=>o.move(t+r.x,i+r.y)),this}};function Qe(e,t){var r,n,a,s;let i=(n=(r=e.appearance)==null?void 0:r.layer)!=null?n:0,o=(s=(a=t.appearance)==null?void 0:a.layer)!=null?s:0;return i!==o?i-o:e.id-t.id}var Xe=["damage","draw","kill","move","notice","playerFire","playerMove","spawn","tick","waveBegin","waveNext"];var Jt={};Z(Jt,{AcidBullet:()=>Oi,BellowMissile:()=>$i,Bullet:()=>Gi,CrushBullet:()=>Wi,DroneBullet:()=>Fi,HomingMissile:()=>Ui,OutcryBullet:()=>Ki,PlayerBullet:()=>zi,SalvoMissileA:()=>ji,SalvoMissileB:()=>Vi,SalvoMissileC:()=>Yi,SmiteMissile:()=>_i,TalonBullet:()=>Ni});var G=D(S());var ki={Heart:"",Diamond:"",Club:"",Dot:"\x07",Ring:"	",RingInvert:`
`,Male:"\v",Female:"\f",DoubleNote:"",Star:"",Pilcrow:"",Silcrow:"",ResizeVertical:"",UpArrow:"",DownArrow:"",RightArrow:"",LeftArrow:"\x1B",DownWedge:"",Pentagon:"\x7F",AHat:"\x83",EHat:"\x88",CapitalUUmlaut:"\x9A",Cent:"\x9B",Yen:"\x9D",CurlyF:"\x9F",NotFlip:"\xA9",Not:"\xAA",InvertedExclamation:"\xAD",Fill1:"\xB0",Fill2:"\xB1",Fill3:"\xB2",BoxVerticalSingle:"\xB3",BoxLeftSingleUpDouble:"\xBD",BoxUpSingleHorizontalSingle:"\xC1",BoxDownSingleHorizontalSingle:"\xC2",BoxHorizontalSingle:"\xC4",BoxUpDoubleHorizontalSingle:"\xD0",BoxDownSingleHorizontalDouble:"\xD1",BoxRightSingleUpDouble:"\xD3",BoxVerticalDoubleHorizontalSingle:"\xD7",Filled:"\xDB",Beta:"\xE1",Gamma:"\xE2",Pi:"\xE3",Theta:"\xE9",Omega:"\xEA",SymbolED:"\xED",SetMember:"\xEE",HorizontalDivide:"\xF6",Approximates:"\xF7",Squared:"\xFD",Square:"\xFE"},f=ki;var Je=(s=>(s[s.Effect=0]="Effect",s[s.Item=1]="Item",s[s.Ship=2]="Ship",s[s.Gun=3]="Gun",s[s.Bullet=4]="Bullet",s[s.Player=5]="Player",s[s.PlayerBullet=6]="PlayerBullet",s))(Je||{}),g=Je;var Gi={components:{projectile:{damage:1,scaling:{stat:"body",multiplier:1}},appearance:{glyph:f.InvertedExclamation,layer:g.Bullet,fg:G.Colors.YELLOW}}},Fi={components:{projectile:{damage:1,scaling:{stat:"body",multiplier:1}},appearance:{glyph:".",layer:g.Bullet,fg:G.Colors.ORANGE}}},Ki={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:"o",layer:g.Bullet,fg:(0,G.fromRgb)(255,55,135)}}},Oi={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:f.Approximates,layer:g.Bullet,fg:(0,G.fromRgb)(55,55,215)}}},Ni={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:"`",layer:g.Bullet,fg:(0,G.fromRgb)(135,255,55)}}},Wi={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},homing:{strength:1,duration:3},appearance:{glyph:f.Square,layer:g.Bullet,fg:(0,G.fromRgb)(175,175,0)}}},_i={components:{projectile:{damage:2,scaling:{stat:"mind",multiplier:1}},homing:{strength:10,duration:1},explodes:{size:7,type:"Fire",falloff:1},appearance:{glyph:"*",layer:g.Bullet,fg:G.Colors.ORANGE}}},Ui={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:g.Bullet,fg:G.Colors.DARK_RED}}},ji={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:4},trail:{effectPrefab:"SmokePuff"},explodes:{size:8,type:"Fire",falloff:1},appearance:{glyph:"*",layer:g.Bullet,fg:G.Colors.DARK_RED}}},Vi={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.25,duration:5},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:g.Bullet,fg:G.Colors.DARK_RED}}},Yi={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.35,duration:8},trail:{effectPrefab:"SmokePuff"},explodes:{size:4,type:"Fire",falloff:1},appearance:{glyph:"*",layer:g.Bullet,fg:G.Colors.DARK_RED}}},$i={components:{projectile:{damage:20,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:30},trail:{effectPrefab:"SmokePuff"},explodes:{size:6,type:"Fire",falloff:1},appearance:{glyph:f.CurlyF,layer:g.Bullet,fg:G.Colors.LIGHT_RED}}},zi={components:{projectile:{damage:3,scaling:{stat:"body",multiplier:1}},appearance:{glyph:"!",layer:g.PlayerBullet,fg:G.Colors.YELLOW}}};var Zt={};Z(Zt,{AirFistRange:()=>qi,SmokePuff:()=>Qi});var ut=D(S());var qi={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:g.Effect,bg:(0,ut.fromRgb)(0,255,255,100),blendMode:ut.BlendMode.Add}}},Qi={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:g.Effect,bg:(0,ut.fromRgb)(100,100,100,50),blendMode:ut.BlendMode.Add}}};var te={};Z(te,{AcidSplash:()=>oo,Bellow:()=>co,Cleave:()=>eo,CrushPattern:()=>so,DemandHomage:()=>ho,DroneGun:()=>po,Outcry:()=>io,PeaShooter:()=>Zi,PlayerGun:()=>to,Salvo:()=>mo,ShuttleLaunch:()=>ro,Smite:()=>lo,TalonSwipe:()=>ao,TheDragonWakes:()=>fo,Veto:()=>no});var c=(e,t,i,o,r)=>({name:e,x:t,y:i,overlay:o,tags:r}),T=(e,t,i,o=0)=>({name:e,type:t,maxHp:i,hp:0,maxShield:o,shield:0,shieldTimer:0}),C=(e,{salvoCount:t=1,timeBetweenShots:i=1,timeBetweenSalvos:o=1,ammunition:r=1/0},n)=>({name:e,shots:n,salvoCount:t,timeBetweenShots:i,timeBetweenSalvos:o,timer:0,salvo:t,ammunition:r}),h=(e,t,i,o,{canDouble:r,delay:n,offset:a,beam:s}={})=>({type:"bullet",canDouble:r,name:e,prefab:t,angle:i,vel:o,delay:n,offset:a,beam:s}),et=(e,{delay:t,offset:i}={})=>({type:"array",canDouble:!1,tag:e,delay:t,offset:i});var nt=Math.PI/2,Wt=nt/2,Xi={Right:0,DownRight:Wt,Down:nt,DownLeft:nt+Wt,Left:nt*2,UpLeft:nt*2+Wt,Up:nt*3,UpRight:nt*3+Wt},u=Xi;function _(e){return typeof e=="undefined"?NaN:Math.floor(e)}var y=(e,t)=>({x:e,y:t});function I(e){return y(_(e.x),_(e.y))}function z(e,t){if(typeof e=="undefined"||typeof t=="undefined")return!1;let i=I(e),o=I(t);return i.x===o.x&&i.y===o.y}function B(e,t){return y(e.x+t.x,e.y+t.y)}var Ji={Right:y(1,0),DownRight:y(1,1),Down:y(0,1),DownLeft:y(-1,1),Left:y(-1,0),UpLeft:y(-1,-1),Up:y(0,-1),UpRight:y(1,-1),None:y(0,0)},F=Ji;var Zi={components:{turret:C("Main Gun",{salvoCount:1,timeBetweenSalvos:3},[h("Bullet","Bullet",u.Down,2,{canDouble:!0})])}},to={components:{turret:C("Main Gun",{salvoCount:2,timeBetweenShots:0,timeBetweenSalvos:3},[h("Your Bullet","PlayerBullet",u.Up,2,{canDouble:!0})])}},eo={components:{turret:C("Cleave",{salvoCount:5,timeBetweenSalvos:11},[et("Primary")])}},io={components:{turret:C("Outcry",{salvoCount:1,timeBetweenSalvos:8},[h("Outcry","OutcryBullet",u.DownLeft,2),h("Outcry","OutcryBullet",u.Left,2),h("Outcry","OutcryBullet",u.UpLeft,2),h("Outcry","OutcryBullet",u.Up,2),h("Outcry","OutcryBullet",u.UpRight,2),h("Outcry","OutcryBullet",u.Right,2),h("Outcry","OutcryBullet",u.DownRight,2)])}},oo={components:{turret:C("Acid Splash",{salvoCount:1,timeBetweenSalvos:13},[h("Acid Splash","AcidBullet",u.UpLeft,2),h("Acid Splash","AcidBullet",u.UpRight,2),h("Acid Splash","AcidBullet",u.Left,2,{delay:1}),h("Acid Splash","AcidBullet",u.Right,2,{delay:1}),h("Acid Splash","AcidBullet",u.DownLeft,2,{delay:2}),h("Acid Splash","AcidBullet",u.DownRight,2,{delay:2}),h("Acid Splash","AcidBullet",u.Left,2,{delay:3}),h("Acid Splash","AcidBullet",u.Right,2,{delay:3}),h("Acid Splash","AcidBullet",u.UpLeft,2,{delay:4}),h("Acid Splash","AcidBullet",u.UpRight,2,{delay:4})])}},ro={components:{turret:C("Shuttle Launch",{salvoCount:1,timeBetweenSalvos:27},[h("Runabout","DroneA",u.Left,0,{offset:F.Left}),h("Runabout","DroneA",u.Right,0,{offset:F.Right})])}},no={components:{turret:C("Veto",{salvoCount:1,timeBetweenSalvos:21},[h("Veto","HomingMissile",u.Up,1),h("Wasp","DroneB",u.DownRight,0,{offset:F.DownRight})])}},ao={components:{turret:C("Talon Swipe",{salvoCount:3,timeBetweenSalvos:10},[h("Talon Swipe","TalonBullet",u.Left,2),h("Talon Swipe","TalonBullet",u.Right,2)])}},so={components:{turret:C("Crush Pattern",{salvoCount:1,timeBetweenSalvos:15},[h("Crush Pattern","CrushBullet",u.Left,1),h("Crush Pattern","CrushBullet",u.UpLeft,1),h("Crush Pattern","CrushBullet",u.UpRight,1),h("Crush Pattern","CrushBullet",u.Right,1)])}},lo={components:{turret:C("Smite",{salvoCount:2,timeBetweenSalvos:16},[h("Smite","SmiteMissile",u.Right,1)])}},po={components:{turret:C("Stinger",{salvoCount:1,timeBetweenSalvos:5,ammunition:5},[h("Bullet","DroneBullet","nearestEnemy",1,{canDouble:!0})])}},mo={components:{turret:C("Salvo",{salvoCount:1,timeBetweenSalvos:10},[h("Missile","SalvoMissileA",u.UpLeft,1),h("Missile","SalvoMissileB",u.UpLeft,1),h("Missile","SalvoMissileC",u.UpLeft,1)])}},fo={components:{turret:C("The Dragon Wakes",{salvoCount:1,timeBetweenSalvos:12},[h("Drone","DroneA",u.Up,0,{offset:F.Up}),h("Missile","HomingMissile",u.DownLeft,2,{offset:F.DownLeft}),h("Missile","HomingMissile",u.DownRight,2,{offset:F.DownRight})])}},co={components:{turret:C("Bellow",{salvoCount:1,timeBetweenSalvos:17},[h("Bellow","BellowMissile",u.DownLeft,1),et("Primary"),et("Primary",{delay:1}),et("Primary",{delay:2}),et("Primary",{delay:3})])}},ho={components:{turret:C("Demand Homage",{salvoCount:1,timeBetweenSalvos:21},[h("Pulsar","DroneC",u.DownLeft,0,{offset:F.DownLeft}),h("Pulsar","DroneC",u.UpLeft,0,{offset:F.UpLeft}),h("Pulsar","DroneC",u.UpRight,0,{offset:F.UpRight}),h("Pulsar","DroneC",u.DownRight,0,{offset:F.DownRight})])}};var ee={};Z(ee,{BombItem:()=>uo,DoubleItem:()=>yo,DrainItem:()=>go,HealItem:()=>bo,JunkItem:()=>xo,MoneyItem:()=>Po,RechargeItem:()=>Eo});var uo={components:{appearance:{glyph:f.DoubleNote,layer:g.Item},item:{type:"bomb",prefab:"BombItem"}}},yo={components:{appearance:{glyph:f.Squared,layer:g.Item},item:{type:"double"}}},go={components:{appearance:{glyph:"%",layer:g.Item},item:{type:"drain"}}},bo={components:{appearance:{glyph:f.Heart,layer:g.Item},item:{type:"heal"}}},xo={components:{appearance:{glyph:f.Beta,layer:g.Item},item:{type:"junk"}}},Po={components:{appearance:{glyph:f.SetMember,layer:g.Item},item:{type:"money",value:0}}},Eo={components:{appearance:{glyph:"@",layer:g.Item},item:{type:"recharge"}}};var oe={};Z(oe,{PlayerHull:()=>wo,PlayerShip:()=>So});var ie=D(S());var wo={components:{solid:!0,appearance:{glyph:"#",layer:g.Player,fg:ie.Colors.DARK_GRAY}}},So={components:{player:{weaponArrays:["Primary","Secondary"]},ship:T("Ace of Clubs","Player",20,10),explodes:{type:"Fire",size:6,falloff:1}},children:[c("PlayerHull",0,0,{appearance:{glyph:f.LeftArrow}}),c("PlayerHull",1,0,{appearance:{glyph:f.Club,fg:ie.Colors.LIGHT_GRAY}}),c("PlayerHull",2,0,{appearance:{glyph:f.RightArrow}}),c("PlayerGun",1,0,void 0,["Primary"]),c("Sword",1,0,void 0,["Secondary"])]};var ae={};Z(ae,{AtomSmasher:()=>Wo,CruiseyWing:()=>Go,Demigod:()=>Oo,DroneA:()=>Lo,DroneB:()=>Io,DroneC:()=>ko,GoutOFlame:()=>Ko,Gremlin:()=>No,Hull:()=>Do,Olm:()=>Fo,ShipA:()=>vo,ShipB:()=>Mo,ShipC:()=>Ao,ShipD:()=>Co,ShipE:()=>Ho,ShipF:()=>To,ShipG:()=>Bo,ShipH:()=>Ro});var Ze=D(S());var Do={components:{solid:!0,appearance:{glyph:"#",layer:g.Ship,fg:Ze.Colors.DARK_GRAY}}},O={idealDistance:8,firingDistance:14,speed:1},q=c("PeaShooter",0,0,void 0,["Primary"]),it={type:"Fire",size:4,falloff:1},vo={components:{ai:O,ship:T("Axle","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:f.Pilcrow}}),q,c("Cleave",0,0,void 0,["Special"])]},Mo={components:{ai:O,ship:T("Baying Hound","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:f.Yen}}),q,c("Outcry",0,0,void 0,["Special"])]},Ao={components:{ai:O,ship:T("Caustic","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:"W"}}),q,c("AcidSplash",0,0,void 0,["Special"])]},Co={components:{ai:O,ship:T("Defiant","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:f.Omega}}),q,c("ShuttleLaunch",0,0,void 0,["Special"])]},Ho={components:{ai:O,ship:T("Executor","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:f.DownWedge}}),q,c("Veto",0,0,void 0,["Special"])]},To={components:{ai:O,ship:T("Falcon","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:f.Pi}}),q,c("TalonSwipe",0,0,void 0,["Special"])]},Bo={components:{ai:O,ship:T("Gauntlet","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:"M"}}),q,c("CrushPattern",0,0,void 0,["Special"])]},Ro={components:{ai:O,ship:T("Halo","Escort",2),explodes:it},children:[c("Hull",0,0,{appearance:{glyph:f.Female}}),q,c("Smite",0,0,void 0,["Special"])]},re={idealDistance:5,firingDistance:6,speed:1},ti=c("DroneGun",0,0,void 0,["Primary"]),ne={type:"Fire",size:3,falloff:1},Lo={components:{ai:re,ship:T("Runabout","Escort",1),explodes:ne},children:[c("Hull",0,0,{appearance:{glyph:f.Theta}}),q]},Io={components:{ai:re,ship:T("Wasp","Escort",1),explodes:ne},children:[c("Hull",0,0,{appearance:{glyph:f.SymbolED}}),ti]},ko={components:{ai:re,ship:T("Pulsar","Escort",1),explodes:ne},children:[c("Hull",0,0,{appearance:{glyph:f.Silcrow}}),ti]},dt={type:"Fire",size:6,falloff:1},Go={components:{ai:O,ship:T("Cruisey Wing","Battleship",10,5),explodes:dt},children:[c("Hull",0,0,{appearance:{glyph:f.Not}}),c("Hull",1,0,{appearance:{glyph:f.HorizontalDivide}}),c("Hull",2,0,{appearance:{glyph:f.NotFlip}}),c("PeaShooter",0,0,void 0,["Primary"]),c("PeaShooter",1,0,void 0,["Primary"]),c("PeaShooter",2,0,void 0,["Primary"]),c("Salvo",1,0,void 0,["Special"])]},Fo={components:{ai:O,ship:T("Olm","Battleship",15,4),explodes:dt},children:[c("Hull",0,0,{appearance:{glyph:f.Cent}}),c("Hull",0,1,{appearance:{glyph:f.ResizeVertical}}),c("Hull",0,2,{appearance:{glyph:f.BoxDownSingleHorizontalDouble}}),c("PeaShooter",0,2,void 0,["Primary"]),c("TheDragonWakes",0,0,void 0,["Special"])]},Ko={components:{ai:O,ship:T("Gout-o'-flame","Battleship",5,20),explodes:dt},children:[c("Hull",0,0,{appearance:{glyph:f.Pentagon}}),c("Hull",1,0,{appearance:{glyph:f.BoxVerticalDoubleHorizontalSingle}}),c("Hull",2,0,{appearance:{glyph:f.Pentagon}}),c("Hull",1,1,{appearance:{glyph:f.BoxUpDoubleHorizontalSingle}}),c("PeaShooter",1,1,void 0,["Primary"]),c("Bellow",1,1,void 0,["Special"])]},Oo={components:{ai:O,ship:T("Demigod","Battleship",30,15),explodes:dt},children:[c("Hull",1,0,{appearance:{glyph:f.CapitalUUmlaut}}),c("Hull",0,1,{appearance:{glyph:"}"}}),c("Hull",1,1,{appearance:{glyph:f.RingInvert}}),c("Hull",2,1,{appearance:{glyph:"{"}}),c("Hull",1,2,{appearance:{glyph:"Y"}}),c("PeaShooter",1,2,void 0,["Primary"]),c("DemandHomage",1,1,void 0,["Special"])]},No={components:{ai:O,ship:T("Gremlin","Battleship",30,15),explodes:dt},children:[c("Hull",1,0,{appearance:{glyph:f.ResizeVertical}}),c("Hull",2,0,{appearance:{glyph:f.ResizeVertical}}),c("Hull",0,1,{appearance:{glyph:"]"}}),c("Hull",1,1,{appearance:{glyph:f.BoxLeftSingleUpDouble}}),c("Hull",2,1,{appearance:{glyph:f.BoxRightSingleUpDouble}}),c("Hull",3,1,{appearance:{glyph:f.Male}}),c("Hull",1,2,{appearance:{glyph:f.BoxVerticalSingle}}),c("Hull",2,2,{appearance:{glyph:f.Gamma}}),c("PeaShooter",1,2,void 0,["Primary"]),c("PeaShooter",2,2,void 0,["Primary"])]},Wo={components:{ai:O,ship:T("Atom Smasher","Battleship",10,20),explodes:dt},children:[c("Hull",1,0,{appearance:{glyph:f.EHat}}),c("Hull",2,0,{appearance:{glyph:"-"}}),c("Hull",3,0,{appearance:{glyph:f.AHat}}),c("Hull",0,1,{appearance:{glyph:f.Fill2}}),c("Hull",1,1,{appearance:{glyph:f.Fill1}}),c("Hull",2,1,{appearance:{glyph:f.Fill2}}),c("Hull",3,1,{appearance:{glyph:f.Fill3}}),c("Hull",4,1,{appearance:{glyph:f.Filled}}),c("PeaShooter",0,1,void 0,["Primary"]),c("PeaShooter",1,1,void 0,["Primary"]),c("PeaShooter",2,1,void 0,["Primary"]),c("PeaShooter",3,1,void 0,["Primary"]),c("PeaShooter",4,1,void 0,["Primary"])]};var se={};Z(se,{Laser:()=>Vo,LaserBeam:()=>Yo,Multiball:()=>Uo,MultiballShot:()=>_o,StubbornDescent:()=>jo});var wt=D(S());var _o={components:{projectile:{damage:7},appearance:{glyph:"+",layer:g.Bullet,fg:(0,wt.fromRgb)(255,255,55)}}},Uo={components:{turret:C("Multiball",{salvoCount:1,timeBetweenSalvos:15},[h("Multiball","MultiballShot",u.DownLeft,2),h("Multiball","MultiballShot",u.Left,2),h("Multiball","MultiballShot",u.Right,2),h("Multiball","MultiballShot",u.DownRight,2),h("Runabout","DroneA",u.UpLeft,0,{offset:F.UpLeft}),h("Runabout","DroneA",u.UpRight,0,{offset:F.UpRight})])}},jo={components:{turret:C("Stubborn Descent",{salvoCount:13,timeBetweenSalvos:21},[et("Primary")])}},Vo={components:{projectile:{damage:2},appearance:{glyph:"|",layer:g.Bullet,fg:wt.Colors.WHITE,bg:wt.Colors.LIGHT_BLUE}}},Yo={components:{turret:C("Laser Beam",{salvoCount:10,timeBetweenSalvos:30},[h("Laser","Laser",u.Down,1,{offset:F.Down,beam:{duration:1,appearance:new Array(60)}})])}};var le={};Z(le,{Sword:()=>zo,SwordBullet:()=>$o});var at=D(S());var $o={components:{projectile:{damage:5,special:"increasedDropChance",scaling:{stat:"spirit",multiplier:1}},appearance:{glyph:f.Star,layer:g.PlayerBullet,fg:at.Colors.LIGHT_GREEN}}},zo={components:{turret:C("Sword",{salvoCount:1,timeBetweenSalvos:20},[h("Stab","SwordBullet","lastMovement",1,{beam:{duration:2,appearance:[{glyph:f.Star,fg:at.Colors.LIGHT_GREEN},{glyph:"o",fg:at.Colors.LIGHT_GREEN},{glyph:f.Diamond,fg:at.Colors.LIGHT_GREEN},{glyph:f.Ring,fg:at.Colors.DARK_GREEN},{glyph:f.Dot,fg:at.Colors.DARK_GRAY}]}})])}};var qo=k(k(k(k(k(k(k(k({},Jt),Zt),ee),te),oe),ae),se),le);function pe(e,t){return e.add(new rt(e,t).applyPrefab(t,qo[t]))}var St=class{constructor(t,i=[]){this.compareFn=t;this.entities=i;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}clearExceptFor(t){for(let i of this.entities)t.includes(i.id)||(i.alive=!1);this.clearDead()}add(t){this.entities.push(t),this.dirty=!0}clearDead(){this.entities=this.entities.filter(t=>t.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var A=D(S());var N=D(S());var W=D(S());function Qo(e,t){if(!t||!e.length)throw new Error("Could not get midpoint");let i=o=>e.reduce((r,{offset:n})=>r+n[o],0)/e.length;return y(t.x+i("x"),t.y+i("y"))}function Xo(e,t,i,o=[]){let r=[];for(let{offset:n}of t){let a=B(i,n),{oob:s,wall:l,solid:m}=e.getContents(a,o);s?r.push({absolute:a,offset:n,entity:"oob"}):l?r.push({absolute:a,offset:n,entity:"wall"}):m&&r.push({absolute:a,offset:n,entity:m})}return r}function H(e,t){let i=e.getRoot(t);return e.entities.get().filter(o=>e.getRoot(o)===i)}function st(e,t){return H(e,t).map(i=>i.id)}function V(e,t){var s;let i=(s=e.getRoot(t).position)!=null?s:y(0,0),o=H(e,t),r=[],n=0,a=0;for(let l of o){let{attachment:m,solid:p}=l;if(m&&p){let{x:d,y:x}=m;r.push({absolute:B(i,m),offset:{x:d,y:x},entity:l}),n=Math.max(d+1,n),a=Math.max(x+1,a)}}return{layout:r,topLeft:i,width:n,height:a}}function ei(e,t,i){let o=st(e,t),{layout:r,topLeft:n}=V(e,t);return!i||!n?[]:Xo(e,r,i||n,o)}function U(e,t){let{layout:i,topLeft:o}=V(e,t);if(!o||!i.length){if(t.position)return t.position;throw new Error(`Could not get midpoint of entity#${t.id}`)}return Qo(i,o)}function ii(e,t,i,o,r){for(let n=0;n<r;n++)for(let a=0;a<o;a++){let{oob:s,wall:l,solid:m,other:p}=e.getContents({x:t+a,y:i+n});if(s||l||m||p.length)return!1}return!0}var M=class{constructor(t,i){this.list=t;this.filter=i}matches(t){if(!t.alive)return!1;for(let i of this.filter)if(!t[i])return!1;return!0}forEach(t){for(let i of this.list.get())this.matches(i)&&t(i,i)}};var me=Math.PI*2;function Y(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}function oi(e,t){let i=(e-t)%me,o=(t-e)%me;return i<o?-i:o}function ot(e){let t=Math.cos(e.angle)*e.vel,i=Math.sin(e.angle)*e.vel;return[t,i]}function ri(e){for(;e<0;)e+=me;return e}var fe=[y(-1,-1),y(-1,0),y(-1,1),y(0,1),y(1,1),y(1,0),y(1,-1),y(0,-1)];function ce(e){return fe.map(t=>B(e,t))}function L(e){if(!e.length)throw new Error("oneOf passed empty array");return e[Math.floor(Math.random()*e.length)]}function he(e){let t=new M(e.entities,["ai","position"]);e.on("tick",function(){t.forEach(({ai:o,position:r},n)=>{n.setLastMovement(),o.attacking||(o.attacking=e.player,e.fire("notice",{e:n,noticed:e.player}));let a=st(e,n),{layout:s}=V(e,n),l=I(r),m=e.getDistanceMap(o.attacking),p=b=>{let{oob:w,solid:v,wall:J}=e.getContents(b,a);return!w&&!v&&!J},d=b=>p(b)?Math.abs(m.getOrDefault(b,1/0)-o.idealDistance):1/0,x=b=>s.reduce((w,{offset:v})=>w+d(B(b,v)),0)/s.length,P=x(l),E=[];for(let b of fe){let w=B(l,b);if(!m.has(w))continue;let v=x(w);v<P?(P=v,E=[w]):v===P&&E.push(w)}if(E.length){let b=L(E);n.move(b.x,b.y),n.setLastMovement({angle:Y(l,b)});return}})}),e.on("damage",function({e:o,source:r}){r.owner&&o!==r.owner&&o.ai&&!o.ai.attacking&&r.owner.alive&&(o.ai.attacking=r.owner)})}var hi=D(S());function _t(e,t,i){let{ship:o}=t;if(!o)throw new Error(`Cannot put pilot into entity ${t.name} (no ship)`);if(t.setPilot(i),o.maxHp+=i.body*4,i.special){let r=U(e,t);e.spawn(i.special).setAttachment(Ve(k({},I(r)),{parent:t})).tags.add("Special")}}function Ut(e,t){return e.pilot?e.pilot[t]:0}var ni=(n=>(n[n.None=0]="None",n[n.Healthy=1]="Healthy",n[n.Double=2]="Double",n[n.Drain=4]="Drain",n[n.HasPilot=8]="HasPilot",n))(ni||{}),R=ni;var ai=["Berserker","Chopter","Duelist","Engineer","Fighter","Negotiator","Psychic","Smuggler"];var K=D(S()),jt=[0,K.Colors.DARK_RED,K.Colors.BROWN,K.Colors.LIGHT_RED,K.Colors.ORANGE,K.Colors.YELLOW,K.Colors.WHITE],Q={Typical:{fg:K.Colors.DARK_GRAY},Healthy:{fg:K.Colors.DARK_GREEN},Double:{fg:K.Colors.LIGHT_GRAY},Multi:{fg:K.Colors.DARK_MAGENTA},Drain:{fg:K.Colors.DARK_RED},StarPilot:{fg:K.Colors.YELLOW},Mega:{fg:K.Colors.BLACK,bg:K.Colors.DARK_MAGENTA}};function ue(e,t=0){let i=[];for(let o=t;o<e;o++)i.push(o);return i}function yt(e){for(let t=e.length-1;t>0;t--){let i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}return e}function Vt(e,...t){return e.filter(i=>!t.includes(i))}var ge={Typical:R.None,Healthy:R.Healthy,Double:R.Double,Multi:R.Healthy|R.Double,Drain:R.Drain,StarPilot:R.HasPilot,Mega:R.Healthy|R.Double|R.Drain|R.HasPilot},Jo={Typical:"Fire",Healthy:"Green",Double:"Fire",Multi:"Magenta",Drain:"Fire",StarPilot:"Yellow",Mega:"Magenta"},de=["ShipA","ShipB","ShipC","ShipD","ShipE","ShipF","ShipG","ShipH"],ye=["CruiseyWing","Olm","GoutOFlame","Demigod","Gremlin","AtomSmasher"],Zo=[{name:"Let Fate Decide",difficulty:1,groups:[{count:7,type:"Escort",prefabs:de},{count:1,type:"Battleship",prefabs:ye}]},{name:"Court Martial",difficulty:2,groups:[{count:5,type:"Escort",prefabs:["ShipA","ShipE"]},{count:1,type:"Battleship",prefabs:["CruiseyWing"]}]},{name:"Hellhounds",difficulty:3,groups:[{count:2,type:"Escort",prefabs:["ShipB"]},{count:2,type:"Battleship",prefabs:["GoutOFlame"]}]},{name:"Chaos",difficulty:4,groups:[{count:4,type:"Escort",prefabs:["ShipC"]},{count:4,type:"Escort",prefabs:Vt(de,"ShipC")},{count:1,type:"Battleship",prefabs:["Demigod"]}]},{name:"Fly in Formation",difficulty:4,groups:[{count:7,type:"Escort",prefabs:["ShipF"]},{count:1,type:"Battleship",prefabs:ye}]},{name:"Hark!",difficulty:6,groups:[{count:3,type:"Escort",prefabs:["ShipH"]},{count:3,type:"Escort",prefabs:Vt(de,"ShipH")},{count:1,type:"Battleship",prefabs:["Demigod"]}]},{name:"Caverns.com",difficulty:7,groups:[{count:1,type:"Escort",prefabs:["ShipA","ShipG"]},{count:3,type:"Battleship",prefabs:["Olm"]}]},{name:"Humanity to the Rescue",difficulty:8,groups:[{count:7,type:"Escort",prefabs:["ShipA","ShipD","ShipE","ShipG"]},{count:1,type:"Battleship",prefabs:["GoutOFlame"]}]},{name:"Wild Hunt",difficulty:9,groups:[{count:15,type:"Escort",prefabs:["ShipB","ShipF"]},{count:1,type:"Battleship",prefabs:["Olm"]}]},{name:"Arm Wrestling",difficulty:10,groups:[{count:9,type:"Escort",prefabs:["ShipG"]},{count:2,type:"Battleship",prefabs:["CruiseyWing"]}]},{name:"Valis",difficulty:11,groups:[{count:4,type:"Escort",prefabs:["ShipC"]},{count:4,type:"Escort",prefabs:["ShipH"]},{count:1,type:"Battleship",prefabs:ye}]}];function si(e=3){return yt(Zo.slice()).slice(0,e).sort((t,i)=>t.difficulty-i.difficulty)}function li(e,t){return Math.random()*100>=e?t?"StarPilot":"Typical":t?"Mega":L(["Healthy","Double","Multi","Drain"])}function tr(e){let t=tt(e);for(;t.class.length<t.talent;)t.class.push(L(ai.filter(i=>!t.class.includes(i))));return t}function pi(e,t,i,o){let r=ge[i];if(r&R.HasPilot&&!o)throw new Error(`power ${i} needs pilot, none given`);let n=e.spawn(t),{ship:a}=n;if(!a)throw new Error(`Ship prefab ${t} doesn't have a ship component!`);if(a.power=i,r&R.Healthy&&(a.maxHp=a.maxHp*2+3),o){let l=tr(o);_t(e,n,l)}Dt(a);let s=Q[i];for(let l of H(e,n))l.appearance&&Object.assign(l.appearance,s);return r&R.Double&&n.setDoubleShot({duration:1/0}),n.explodes&&(n.explodes.type=Jo[i]),n}function mi(e,t){let{width:i,height:o}=V(e,t);for(let r=0;r<e.term.height;r++){let n=yt(ue(e.term.width-i));for(let a of n)if(ii(e,a,r,i,o))return{x:a,y:r}}throw new Error(`Could not find ${i}x${o} spawn location`)}function Dt(e){e.hp=e.maxHp,e.shield=e.maxShield}function be(e){return e.salvo<=0?e.ammunition<=0?"Spent":"Reloading":e.timer>0?"Chambering":"Ready"}function Yt(e){e.timer>0&&(e.timer--,e.timer<=0&&e.salvo<=0&&(e.ammunition?(e.salvo=Math.min(e.salvoCount,e.ammunition),e.ammunition-=e.salvo):e.timer=1/0))}function $t(e,t){return e.shots.find(i=>i.type==="bullet"&&i.angle==="lastMovement")&&!t.lastMovement?!1:e.timer===0}function fi(e,t){var o;let i=(o=e.delayedShot)!=null?o:{shots:[]};i.shots.push(t),e.setDelayedShot(i)}function ci(e,t,i,o,r,n,a,s,l,m){var d;let p=e.spawn(i).setIgnoreSolid({ids:l}).move(n.x,n.y);return p.name=t,s&&p.setMotion({angle:a,vel:s}),p.ship&&Dt(p.ship),o.ship&&p.setOrigin({owner:o,ship:o.ship,turret:r}),(d=p.projectile)!=null&&d.scaling&&(p.projectile.damage+=Math.floor(Ut(o,p.projectile.scaling.stat)*p.projectile.scaling.multiplier)),p.appearance&&m&&Object.assign(p.appearance,m),p}function xe(e,t,i,o,r,n,a){var b;if(n.doubleShot&&t.canDouble){let w=tt(t);w.canDouble=!1,w.delay=n.player?2:1,w.appearance={fg:hi.Colors.LIGHT_GRAY},fi(n,{turret:i,shot:w})}if(t.delay)return fi(n,{turret:i,shot:tt(t)}),[];if(t.type==="array"){let w=[];for(let v of H(e,n).filter(J=>J.tags.has(t.tag)))v.position&&v.turret&&w.push(...vt(e,v.turret,B(v.position,(b=t.offset)!=null?b:y(0,0)),r,n,a));return w}let{angle:s,beam:l,name:m,offset:p,prefab:d,vel:x}=t,P=B(o,p!=null?p:y(.5,.5)),E=s==="nearestEnemy"?Y(P,r):s==="lastMovement"?n.lastMovement.angle:s;if(l&&x){let[w,v]=ot({angle:E,vel:x}),J=y(w,v),Ot=B(P,J);return l.appearance.map(We=>{let Pt=ci(e,m,d,n,i,Ot,E,0,a,t.appearance).setMotion({angle:E,vel:0}).setLifetime({duration:l.duration});return Pt.appearance&&We&&Object.assign(Pt.appearance,We),n.ship&&Pt.setOrigin({owner:n,ship:n.ship,turret:i}),e.inBounds(Ot)||Pt.kill({type:"exitedMap"}),Ot=B(Ot,J),Pt})}return[ci(e,m,d,n,i,P,E,x,a,t.appearance)]}function vt(e,t,i,o,r,n){let{timeBetweenSalvos:a,timeBetweenShots:s}=t;--t.salvo<=0?t.timer=a:t.timer=s;let l=[];for(let m of t.shots)l.push(...xe(e,m,t,i,o,r,n));return l}function Pe(e){let t=new M(e.entities,["delayedShot"]);e.on("tick",function(){t.forEach(({ai:o,delayedShot:r},n)=>{var a;if(!n.alive){n.setDelayedShot();return}for(let s=r.shots.length-1;s>=0;s--){let{turret:l,shot:m}=r.shots[s];if(--m.delay<=0){m.delay=0,r.shots.splice(s,1);let p=H(e,n),d=p.find(P=>P.turret===l);if(!d)continue;let x=(a=o==null?void 0:o.attacking)!=null&&a.alive?U(e,o.attacking):y(0,0);xe(e,m,l,d.position,x,n,p.map(P=>P.id))}}r.shots.length||n.setDelayedShot()})})}function Ee(e){let t=new M(e.entities,["appearance","position"]);e.on("draw",function(){t.forEach(({appearance:o,position:r})=>e.drawIfVisible(_(r.x),_(r.y),o.glyph,o.fg,o.bg,o.blendMode))})}function we(e){e.on("kill",function({e:i,reason:o}){var a;let{position:r,ship:n}=i;if(r&&(n!=null&&n.power)&&o.type==="damage"){let s=ge[n.power],l=((a=o.source.e.projectile)==null?void 0:a.special)==="increasedDropChance",m=n.type==="Battleship"?l?.92:.42:l?.32:.02,p=(E=1)=>Math.random()*E<m,d=[];s&R.Double&&p()&&d.push("DoubleItem"),s&R.Drain&&p()&&d.push("DrainItem"),s&R.Healthy&&p()&&d.push("HealItem"),p()&&d.push("MoneyItem"),p()&&d.push("JunkItem"),p()&&d.push("RechargeItem");let x;if(p()){let E=H(e,i).filter(b=>b.tags.has("Special")&&b.prefab&&b.turret);E.length&&(x=L(E).prefab,d.push("BombItem"))}let P=yt([y(-1,-1),y(0,-1),y(1,-1),y(-1,0),y(0,0),y(1,0),y(-1,1),y(0,1),y(1,1)]);for(let E of d){let b=B(r,P.pop()),w=e.spawn(E).move(b.x,b.y).setMotion({angle:u.Down,vel:1});E==="BombItem"&&w.setItem({type:"bomb",prefab:x})}}})}var ui=D(S());var zt=D(S());function gt(e,t,i){return e*(1-i)+t*i}var X=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[i])=>t-i)}add(t,i){return this.points.push([t,i]),this.sort(),this}get(t){let[i,o]=this.points[0];if(t<=i)return(0,zt.fromRgb)(...o);let[r,n]=this.points[this.points.length-1];if(t>=r)return(0,zt.fromRgb)(...n);let a=this.points.findIndex(([J])=>J>t),[s,[l,m,p,d]]=this.points[a-1],[x,[P,E,b,w]]=this.points[a],v=(t-s)/(x-s);return(0,zt.fromRgb)(gt(l,P,v),gt(m,E,v),gt(p,b,v),gt(d,w,v))}};function lt(e,t){let i=Math.abs(e.x-t.x),o=Math.abs(e.y-t.y);return Math.sqrt(i*i+o*o)}var er={Fire:new X([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Blue:new X([[0,[0,0,0,0]],[2,[0,0,255,150]],[4,[0,155,255,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Yellow:new X([[0,[0,0,0,0]],[2,[155,155,0,150]],[4,[255,255,55,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Green:new X([[0,[0,0,0,0]],[2,[0,215,0,150]],[4,[55,255,55,150]],[6,[215,255,215,150]],[10,[255,255,255,255]]]),Magenta:new X([[0,[0,0,0,0]],[2,[155,0,115,150]],[4,[255,115,255,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function Se(e){if(!(e.intensity<=0))return{glyph:" ",layer:g.Effect,bg:er[e.type].get(e.intensity),blendMode:ui.BlendMode.Add}}function di(e,t){let i=[],o=Math.floor(e.x-t),r=Math.ceil(e.x+t),n=Math.floor(e.y-t),a=Math.ceil(e.y+t);for(let s=n;s<=a;s++)for(let l=o;l<=r;l++){let m=lt(e,{x:l,y:s});m>=t||i.push({x:l,y:s,intensity:t-m})}return i}function De(e){e.on("kill",function({e:i,reason:o}){if(o.type==="exitedMap")return;let{explodes:r,name:n,position:a}=i;if(r&&a)for(let{x:s,y:l,intensity:m}of di(U(e,i),r.size))e.add(new rt(e,n+"Explosion").setPosition({x:s,y:l}).setField({type:r.type,intensity:m,falloff:r.falloff}))})}function Mt(e,t,i,o){var s;let r=e.getRoot(t);if(!r.ship)return;r.ship.type!=="Player"&&((s=o.origin)==null?void 0:s.ship.type)!=="Player"&&(i=Math.ceil(i/2));let n=i;r.ship.shield>0&&(r.ship.shield>i?(r.ship.shield-=i,n=0):(n-=r.ship.shield,r.ship.shield=0)),n&&(r.ship.hp-=n);let a={e:o,owner:o};o.origin&&(a.owner=o.origin.owner,a.ship=o.origin.ship,a.turret=o.origin.turret),console.log(`${o.name}${o.origin?` (${o.origin.owner.name} #${o.origin.owner.id})`:""} hits ${r.name} for ${i}`),e.fire("damage",{e:r,amount:i,source:a}),r.ship.hp<=0&&e.kill(r,{type:"damage",source:a})}function ve(e){let t=new M(e.entities,["ship"]),i=new M(e.entities,["field","position"]);e.on("tick",function(){i.forEach(({field:r,position:n},a)=>{r.intensity-=r.falloff,a.setAppearance(Se(r)),r.intensity<1?e.kill(a,{type:"expired"}):t.forEach((s,l)=>{let{layout:m}=V(e,l);m.find(({absolute:d})=>z(d,n))&&Mt(e,l,Math.floor(r.intensity),a)})})}),e.on("spawn",function({e:r}){r.field&&r.setAppearance(Se(r.field))})}var ht=D(S());var At=D(S());var pt=class{constructor(t,i,o){this.g=t;this.pilot=i;this.full=o;this.width=11,this.height=o?2+i.class.length:1}get isPlayer(){return this.pilot.player}draw(t,i){if(this.full&&(this.g.term.drawString(t,i,this.pilot.name,this.pilot.star?At.Colors.YELLOW:At.Colors.LIGHT_GRAY),i++),this.drawStat(t,i,"body"),this.drawStat(t+3,i,"mind"),this.drawStat(t+6,i,"spirit"),this.drawStat(t+9,i,"talent"),!!this.full)for(let o of this.pilot.class)this.g.term.drawString(t,++i,o,At.Colors.LIGHT_GREEN)}drawStat(t,i,o){let r=this.pilot[o];this.g.term.drawChar(t,i,o[0].toUpperCase(),At.Colors.WHITE),this.g.term.drawChar(t+1,i,r.toString(),jt[r])}};var $=D(S());function Me(e,t,i,o,r,n,a,s,l){let m=`${Math.ceil(r)}/${n}`,p=Math.floor(r/n*o);e.drawHLine(t,i,o," ",void 0,s),p&&e.drawHLine(t,i,p," ",void 0,a),e.drawCenteredString(t+o/2,i,m,l)}var mt=class{constructor(t,i){this.g=t;this.ship=i;this.width=Math.max(13,i.name.length),this.height=i.maxShield?3:2}draw(t,i){let{ship:o,width:r}=this,{term:n}=this.g,a=r-3;n.drawString(t,i,o.name,$.Colors.WHITE),n.drawString(t,i+1,"HP:",$.Colors.WHITE),Me(n,t+3,i+1,a,o.hp,o.maxHp,$.Colors.DARK_GREEN,$.Colors.DARK_RED,$.Colors.WHITE),o.maxShield&&(n.drawString(t,i+2,"Sh:",$.Colors.WHITE),Me(n,t+3,i+2,a,o.shield,o.maxShield,$.Colors.DARK_CYAN,$.Colors.LIGHT_BLUE,$.Colors.WHITE))}};var ft=D(S());var ir={Spent:ft.Colors.DARK_GRAY,Reloading:ft.Colors.LIGHT_RED,Ready:ft.Colors.YELLOW,Chambering:ft.Colors.BROWN},ct=class{constructor(t,i){this.g=t;this.turret=i;this.width=Math.max(i.name.length,this.stateLabel.length),this.height=2,i.ammunition>0&&i.ammunition<1/0&&this.height++}get stateLabel(){let{timer:t,salvo:i,salvoCount:o}=this.turret,r=be(this.turret);if(r==="Spent")return"Out of Ammo";if(r==="Reloading")return`Reloading (${t})`;let n=`${i}/${o}`;return r==="Ready"?n:`${n} (${t})`}draw(t,i){this.g.term.drawString(t,i,this.turret.name,ft.Colors.WHITE);let o=be(this.turret);this.g.term.drawString(t,i+1,this.stateLabel,ir[o]),this.height>2&&this.g.term.drawString(t,i+2,`${this.turret.ammunition} ammo left`,ft.Colors.LIGHT_GRAY)}};var bt=6;function Ae(e){let{mapHeight:t,term:i}=e;e.on("draw",function(){let r=e.player,{pilot:n,ship:a}=r;i.fillRect(0,t,i.width,bt," ",ht.Colors.WHITE,ht.Colors.BLACK),i.drawSingleBox(0,t,i.width,bt);let s=1,l=t+1,m=new mt(e,a);m.draw(s,l);let p=s+Math.floor((m.width-11)/2);new pt(e,n,!1).draw(p,l+3),s+=m.width+1,i.drawChar(s-1,l-1,f.BoxDownSingleHorizontalSingle,ht.Colors.WHITE),i.drawVLine(s-1,l,bt-2,f.BoxVerticalSingle,ht.Colors.WHITE),i.drawChar(s-1,l+bt-2,f.BoxUpSingleHorizontalSingle,ht.Colors.WHITE);let x=s;for(let P of r.player.weaponArrays){let E=x,b=H(e,r).filter(w=>w.turret&&w.tags.has(P));for(let w of b){let v=new ct(e,w.turret);v.draw(x,l+1),x+=v.width+1}i.drawString(E,l,P,ht.Colors.LIGHT_CYAN),x=Math.max(x,E+P.length+1)}})}function Ce(e){let t=new M(e.entities,["homing","motion","position"]);e.on("tick",function(){t.forEach(({homing:o,motion:r,position:n},a)=>{var p;if(!((p=o.target)!=null&&p.alive))return;let s=U(e,o.target),l=Y(n,s),m=oi(r.angle,l);Math.abs(m)<=o.strength?r.angle=l:m<0?r.angle-=o.strength:r.angle+=o.strength,--o.duration<=0&&(a.setHoming(),a.setTrail())})})}function He(e){let t=new M(e.entities,["lifetime"]);e.on("tick",function(){t.forEach(({lifetime:o},r)=>{if(--o.duration<=0)e.kill(r,{type:"expired"});else if(o.decayingAppearance&&r.appearance){let n=o.decayingAppearance[o.duration-1];Object.assign(r.appearance,n)}})})}function yi(e,t,i){if(t.ship)switch(i.type){case"double":t.doubleShot?t.doubleShot.duration+=9:t.setDoubleShot({duration:9});return;case"heal":{let o=Math.ceil(t.ship.maxHp/4);t.ship.hp=Math.min(t.ship.maxHp,t.ship.hp+o);return}case"recharge":{for(let o of H(e,t))if(o.turret)for(;o.turret.timer<1/0&&o.turret.timer>0;)Yt(o.turret);return}}}function qt(e,t){let i=t.x-e.x,o=t.y-e.y,r=Math.abs(i),n=Math.abs(o),a=i>0?1:-1,s=o>0?1:-1,l=k({},e),m=[k({},l)];for(let p=0,d=0;p<r||d<n;)(.5+p)/r<(.5+d)/n?(l.x+=a,p++):(l.y+=s,d++),m.push(k({},l));return m}function gi(e,t,i){let o=[],r=(n,a)=>{let s=_(n),l=_(a);o.find(m=>m.x===s&&m.y===l)||o.push({x:s,y:l})};for(let n=0;n<=Math.floor(i*Math.sqrt(.5));n++){let a=Math.floor(Math.sqrt(i*i-n*n));r(e-a,t+n),r(e+a,t+n),r(e-a,t-n),r(e+a,t-n),r(e+n,t-a),r(e+n,t+a),r(e-n,t-a),r(e-n,t+a)}return o}function Te(e){let t=new M(e.entities,["motion","position"]);e.on("tick",function(){t.forEach(({motion:o,position:r,projectile:n,ignoreSolid:a,item:s},l)=>{let[m,p]=ot(o),d=y(r.x+m,r.y+p),x=qt(I(r),I(d)),P=!1,E;for(let b of x){if(!e.inBounds(b)){e.kill(l,{type:"exitedMap"});return}e.move(l,b);let{wall:w,solid:v}=e.getContents(b,a==null?void 0:a.ids);if(w){P=!0;break}else if(v){E=v;break}}P?e.kill(l,{type:"hitWall"}):E?(n&&Mt(e,E,n.damage,l),s&&yi(e,e.getRoot(E),s),e.kill(l,{type:"hitEntity",other:E})):e.move(l,d)})})}function Be(e){e.on("playerMove",function({move:i}){let o=e.player,r=o.position,n=B(r,i);ei(e,o,n).length||(o.move(n.x,n.y),o.setLastMovement({angle:Y(r,n)}),e.tick())}),e.on("playerFire",function({array:i}){let o=e.player,r=o.player.weaponArrays[i],n=H(e,o),a=n.filter(l=>l.tags.has(r)),s=!1;for(let l of a)l.turret&&$t(l.turret,o)&&(vt(e,l.turret,l.position,y(0,0),o,n.map(m=>m.id)),s=!0);s&&(o.setLastMovement(),e.tick())})}var bi=D(S());function Ct(e){return typeof e!="undefined"}function Re(e){let t=new M(e.entities,["ship"]);e.on("tick",function(){t.forEach((o,r)=>{r.doubleShot&&--r.doubleShot.duration<=0&&r.setDoubleShot()})}),e.on("draw",function(){let o=H(e,e.player).map(r=>r.position).filter(Ct);if(e.player.doubleShot)for(let r of o)e.blend(r.x,r.y,bi.Colors.LIGHT_GRAY)})}function Le(e){let t=new M(e.entities,["ship"]);e.on("tick",function(){t.forEach(({ship:o},r)=>{if(o.shield>=o.maxShield){o.shieldTimer=0;return}let n=6-Ut(r,"body");++o.shieldTimer>=n&&(o.shield++,o.shieldTimer=0)})})}function Ie(e){e.on("waveBegin",function({wave:o,difficulty:r,pilot:n}){let a=(r+o.difficulty)*3,s=[];for(let p of o.groups)for(let d=0;d<p.count;d++)s.push(L(p.prefabs));let l=o.groups.filter(p=>p.type==="Escort");for(let p=0;p<r;p++){let d=L(l);s.push(L(d.prefabs))}let m=Math.floor(Math.random()*s.length);for(let p=0;p<s.length;p++){let d=p===m&&n!==void 0,x=s[p],P=li(a,d),E=pi(e,x,P,d?n:void 0),b=mi(e,E);E.move(b.x,b.y)}});let t=1/0;e.on("kill",({e:i})=>{if(!i.ship)return;e.entities.get().filter(r=>r.alive&&r.ship&&r.ship.type!=="Player").length||(t=5)}),e.on("tick",()=>{--t<=0&&(t=1/0,e.fire("waveNext",void 0))})}function ke(e){e.on("move",function({e:i,old:o,pos:r}){i.trail&&!z(o,r)&&e.spawn(i.trail.effectPrefab).setPosition(o)})}function Ge(e){let t=new M(e.entities,["position","turret"]);e.on("tick",function(){t.forEach(({position:o,turret:r},n)=>{var m;Yt(r);let a=e.getRoot(n);if(!a.ai)return;let s=a.ai.attacking;if(!(s!=null&&s.alive))return;let l=U(e,s);if(!(lt(o,l)>((m=a.ai.firingDistance)!=null?m:1/0))&&$t(r,a))for(let p of vt(e,r,o,l,a,st(e,a)))p.homing&&(p.homing.target=s),p.ai&&(p.ai.attacking=s)})})}function xi(e){He(e),Ce(e),Pe(e),Ge(e),ve(e),Le(e),Te(e),he(e),Ie(e),Ee(e),Ae(e),ke(e),De(e),we(e),Re(e),Be(e)}var xt=D(S());var Pi=D(S()),j=class{constructor(t){this.g=t;this.width=0,this.height=0,this.instructions=[]}add(t){this.instructions.push(t),this.updateBounds()}addLine(t,i=Pi.Colors.WHITE,o){this.add({x:0,y:this.instructions.length,line:t,fg:i,bg:o})}updateBounds(){this.width=this.instructions.reduce((t,i)=>Math.max(i.line.length+i.x,t),0),this.height=1+this.instructions.reduce((t,i)=>Math.max(i.y,t),0)}draw(t,i){for(let{x:o,y:r,line:n,fg:a,bg:s}of this.instructions)this.g.term.drawString(t+o,i+r,n,a,s)}};var Ei=Math.PI/4,or=[f.RightArrow,f.DownArrow+f.RightArrow,f.DownArrow,f.DownArrow+f.LeftArrow,f.LeftArrow,f.UpArrow+f.LeftArrow,f.UpArrow,f.UpArrow+f.RightArrow];function rr(e){let t=Math.floor(ri(e)/Ei+Ei/2);return or[t]}var Ht=class extends j{constructor(i,o){super(i);this.e=o;o.name&&!o.ship&&this.addLine(o.name),o.projectile&&this.addLine(`${o.projectile.damage} damage`,xt.Colors.LIGHT_RED),o.motion&&this.addLine(`${rr(o.motion.angle)}, vel ${o.motion.vel}`,xt.Colors.LIGHT_GRAY),o.homing&&this.addLine(`chasing ${o.homing.target===this.g.player?"you ":""}${o.homing.duration<1/0?`(${o.homing.duration})`:""}`,xt.Colors.DARK_RED),o.lifetime&&this.addLine(`(lasts ${o.lifetime.duration})`,xt.Colors.DARK_GRAY),o.explodes&&this.addLine(`explosion ${o.explodes.size}`,xt.Colors.ORANGE)}};var Oe=D(S());var Fe=D(S());var Tt=class extends j{constructor(i,o){super(i);this.field=o;this.addLine("Explosion"),this.add({x:0,y:1,fg:Fe.Colors.LIGHT_GRAY,line:"intensity"}),this.add({x:10,y:1,fg:Fe.Colors.YELLOW,line:Math.floor(o.intensity).toString()})}};var Ke=D(S());var Bt=class extends j{constructor(i,o){super(i);this.item=o;switch(o.type){case"bomb":this.addLine("Smart Bomb");break;case"double":this.addLine("Double",Q.Double.fg,Q.Double.bg);break;case"drain":this.addLine("Drain",Q.Drain.fg,Q.Drain.bg);break;case"heal":this.addLine("Heal",Q.Healthy.fg,Q.Healthy.bg);break;case"junk":this.addLine("Junk",Ke.Colors.DARK_GRAY);break;case"money":this.addLine(`${f.SetMember}${o.value}`,Ke.Colors.YELLOW);break;case"recharge":this.addLine("Recharge");break}}};var wi=D(S());var Rt=class extends j{constructor(i,o){super(i);this.e=o;o.doubleShot&&this.addLine(o.doubleShot.duration===1/0?"2x Shot":`2x Shot (${o.doubleShot.duration})`,wi.Colors.LIGHT_GRAY)}};function Si(e,t,i){if(!i.length)return;let o=[],r=1,n=1,a=p=>{o.push({x:r,y:n,object:p}),n+=p.height+1};for(let p of i){p.ship&&a(new mt(e,p.ship)),p.pilot&&a(new pt(e,p.pilot,!0)),p.doubleShot&&a(new Rt(e,p));let d=H(e,p);for(let x of d.filter(P=>P.turret))a(new ct(e,x.turret));(p.motion||p.projectile||p.homing||p.lifetime||p.explodes)&&a(new Ht(e,p)),p.field&&a(new Tt(e,p.field)),p.item&&a(new Bt(e,p.item))}if(!o.length)return;let s=Math.max(...o.map(p=>p.object.width))+2,l=Math.min(t.x+2,e.term.width-s),m=Math.min(t.y,e.term.height-n);e.term.fillRect(l,m,s,n," ",Oe.Colors.WHITE,Oe.Colors.BLACK),e.term.drawSingleBox(l,m,s,n);for(let p of o)p.object.draw(l+p.x,m+p.y)}function Di(e,t,i){for(let o of e.entities.get()){let{motion:r,projectile:n,position:a}=o;if(r&&n&&a&&lt(t,a)<=i){let s=Y(t,a);r.angle=s,o.setIgnoreSolid()}}for(let o of gi(t.x,t.y,i))e.spawn("AirFistRange").setPosition(o)}var Lt=class{constructor(t,i){this.g=t;this.campaign=i;this.dirty=!0,this.examining=[]}refresh(){this.dirty=!0}init(){let{g:t}=this;this.examineAt=void 0,this.examining=[],this.waves=si(),t.blankMap(),t.entities.clearExceptFor(st(t,t.player));let{width:i,height:o}=V(t,t.player);t.player.move(_(t.mapWidth/2-i/2),t.mapHeight-o-4),xi(t),this.nextWave(),t.on("waveNext",this.nextWave.bind(this))}nextWave(){let t=this.waves.shift();if(t){let i=this.waves.length===0?this.campaign.currentSector.star:void 0;this.g.fire("waveBegin",{wave:t,difficulty:this.campaign.difficulty,pilot:i});return}this.g.player.alive&&(this.campaign.currentSector.completed=!0)}draw(){let{map:t,mapWidth:i,mapHeight:o,overlays:r,term:n}=this.g;for(let a=0;a<o;a++)for(let s=0;s<i;s++){let l=t.grid[a][s];n.drawChar(s,a,0,l.fg,l.bg)}if(this.g.fire("draw",void 0),this.dirty=!1,this.showOverlay){let a=r.get(this.showOverlay);if(a)for(let s=0;s<o;s++)for(let l=0;l<i;l++){let m=a.get({x:l,y:s})||1/0,p=m===1/0?"-":m<10?`${m}`:"*";n.drawChar(l,s,p,W.Colors.LIGHT_RED)}}if(this.examineAt){Si(this.g,this.examineAt,this.examining);for(let a of this.examining){let{motion:s,position:l}=a;if(s&&l){let[m,p]=ot(s),d=y(l.x+m,l.y+p),x=qt(I(l),I(d));for(let P of x)this.g.blend(P.x,P.y,W.Colors.DARK_RED)}}}this.campaign.currentSector.completed&&(n.drawCenteredString(n.width/2,5,"SECTOR COMPLETE",W.Colors.WHITE,W.Colors.BLACK),n.drawCenteredString(n.width/2,7,"Hit Enter to continue",W.Colors.WHITE,W.Colors.BLACK))}update(){(this.g.term.mouse.dx||this.g.term.mouse.dy)&&this.refresh(),this.handleKeys(),this.dirty&&(this.handleMouseMove(),this.draw())}examine(t){this.examineAt=t,this.dirty=!0;let{solid:i,other:o}=this.g.getContents(t),r=new Set;i&&r.add(this.g.getRoot(i));for(let n of o)r.add(this.g.getRoot(n));this.examining=[...r]}handleMouseMove(){let{x:t,y:i}=this.g.term.mouse;this.examine({x:t,y:i})}handleKeys(){let{player:t,term:i}=this.g;if(this.campaign.currentSector.completed&&(i.isKeyPressed(W.Key.VK_ENTER)||i.isKeyPressed(W.Key.VK_NUMPAD_ENTER))){this.campaign.endCombat();return}let o=i.getMovementKey();if(o){this.g.fire("playerMove",{move:o});return}if(i.isKeyPressed(W.Key.VK_1)){this.g.fire("playerFire",{array:0});return}if(i.isKeyPressed(W.Key.VK_2)){this.g.fire("playerFire",{array:1});return}if(i.isKeyPressed(W.Key.VK_F)){Di(this.g,U(this.g,t),4.5),this.g.tick();return}}};var It=class{constructor(t,i,o){this.width=t;this.height=i;this.grid=[];for(let r=0;r<i;r++){let n=[];for(let a=0;a<t;a++)n.push(o(a,r));this.grid.push(n)}}contains({x:t,y:i}){return t>=0&&t<this.width&&i>=0&&i<this.height}get({x:t,y:i}){return this.grid[i][t]}getPositions(){let t=[];for(let i=0;i<this.height;i++)for(let o=0;o<this.width;o++)t.push({x:o,y:i});return t}};var nr={name:"Bodini",star:!0,body:4,mind:2,spirit:3,talent:2,class:[],special:"Multiball"},ar={name:"Splintertooth",star:!0,body:3,mind:3,spirit:3,talent:2,class:[],special:"StubbornDescent"},sr={name:"Gruff",star:!0,body:2,mind:3,spirit:4,talent:2,class:[],special:"LaserBeam"},lr={name:"Star Pilot D",star:!0,body:2,mind:2,spirit:2,talent:2,class:[]},pr={name:"Star Pilot E",star:!0,body:2,mind:2,spirit:2,talent:2,class:[]},mr={name:"Star Pilot F",star:!0,body:2,mind:2,spirit:2,talent:2,class:[]},fr=[nr,ar,sr,lr,pr,mr],vi=fr;var kt=class{constructor(t,i,o){this.g=t;this.shipPrefab=i;this.pilot=o;this.dirty=!0}get currentSector(){return this.space.get(this.position)}refresh(){this.dirty=!0}init(){let{g:t}=this;t.clearEventHandlers(),t.entities.clear(),t.player=this.makePlayer(),this.difficulty=0,this.position=y(2,2),this.space=new It(5,5,()=>({completed:!1}));let i=new Set,o=this.space.getPositions().filter(r=>!z(this.position,r));for(;i.size<6;){let r=L(vi);if(!i.has(r)){i.add(r);let n=L(o),a=this.space.get(n);a.star=r;let s=o.indexOf(n);o.splice(s,1)}}}startCombat(){this.g.setMode(new Lt(this.g,this))}endCombat(){this.g.clearEventHandlers(),this.currentSector.completed=!0,this.difficulty++,this.g.mode=this,this.refresh()}makePlayer(){let{g:t,shipPrefab:i,pilot:o}=this,r=t.spawn(i);if(!r.ship)throw new Error(`Ship prefab ${i} doesn't have a ship component!`);return _t(t,r,o),Dt(r.ship),r}draw(){let{term:t}=this.g;t.fillRect(0,0,t.width,t.height," ",N.Colors.WHITE,N.Colors.BLACK);let i=this.space.get(this.position),o=t.width/2;t.drawCenteredString(o,2,"Known Space",N.Colors.WHITE),i.completed||(t.drawCenteredString(o,4,"Hit Enter to fight!",N.Colors.WHITE),i.star&&t.drawCenteredString(o,34,`You will face: ${i.star.name}!`,N.Colors.YELLOW));let r=(t.width-25)/2,n=(t.height-25)/2;for(let a=0;a<5;a++){let s=n+a*5;for(let l=0;l<5;l++){let m=r+l*5,p={x:l,y:a},d=this.space.get(p);t.fillRect(m,s,5,5," ",void 0,d.completed?N.Colors.BLACK:N.Colors.DARK_RED),t.drawSingleBox(m,s,5,5,N.Colors.WHITE),z(p,this.position)?t.drawChar(m+2,s+2,"@",N.Colors.LIGHT_CYAN):d.star&&t.drawChar(m+2,s+2,"*",N.Colors.YELLOW)}}this.dirty=!1}handleKeys(){let t=this.space.get(this.position);!t.completed&&(this.g.term.isKeyPressed(N.Key.VK_ENTER)||this.g.term.isKeyPressed(N.Key.VK_NUMPAD_ENTER))&&this.startCombat();let i=this.g.term.getMovementKey();if(t.completed&&i){let o=B(this.position,i);this.space.contains(o)&&(this.position=o,this.dirty=!0)}}update(){this.handleKeys(),this.dirty&&this.draw()}};var Gt=class{constructor(t,i=5,o=100){this.g=t;this.starfieldSpeed=i;this.starCount=o}refresh(){this.dirty=!0}init(){this.dirty=!0,this.pilot={name:"Player",player:!0,body:1,mind:1,spirit:1,talent:1,class:[]},this.points=6,this.starfieldCounter=0,this.stars=[];for(let t=0;t<this.starCount;t++)this.stars.push(this.newStar())}draw(){let{term:t}=this.g;t.clear();for(let a of this.stars){let{x:s,y:l}=I(a);t.drawChar(s,l,a.c,a.fg)}let i=t.width/2;t.drawCenteredString(i,2,"Bullet Hell Roguelike",A.Colors.WHITE),t.drawCenteredString(i,9,"Create your Pilot",A.Colors.WHITE),t.drawCenteredString(i,10,`${this.points} points`,A.Colors.YELLOW);let o=2,r=Math.floor((t.width-o*2)/4),n=o+r/2;this.drawStat("body",n),this.drawStat("mind",n+r),this.drawStat("spirit",n+r*2),this.drawStat("talent",n+r*3),this.points===0&&t.drawCenteredString(i,20,"Hit Enter to begin!",A.Colors.WHITE),this.dirty=!1}drawStat(t,i){let{term:o}=this.g,r=`(${t[0].toUpperCase()})${t.slice(1)}`,n=this.pilot[t];o.drawCenteredString(i,13,r,A.Colors.LIGHT_CYAN),o.drawCenteredString(i,14,n.toString(),jt[n])}update(){this.handleStarfield(),this.handleKeys(),this.dirty&&this.draw()}newStar(){let{term:t}=this.g,i=L([A.Colors.DARK_RED,A.Colors.LIGHT_RED,A.Colors.YELLOW,A.Colors.LIGHT_CYAN,A.Colors.WHITE]),o=.5+Math.random(),r=o<.75?".":o<1.25?f.Dot:"*",n=Math.random()*Math.PI*2;return{x:t.width/2,y:t.height/2,c:r,fg:i,vel:o,angle:n}}handleStarfield(){if(this.starfieldCounter<this.starfieldSpeed){this.starfieldCounter++;return}this.starfieldCounter=0,this.dirty=!0;let{width:t,height:i}=this.g.term;for(let o of this.stars){let[r,n]=ot(o);o.x+=r,o.y+=n,(o.x<0||o.x>=t||o.y<0||o.y>=i)&&Object.assign(o,this.newStar())}}isPressed(t,i){let o=this.g.term.isKeyDown(A.Key.VK_SHIFT_LEFT)||this.g.term.isKeyDown(A.Key.VK_SHIFT_RIGHT);return this.g.term.isKeyPressed(t)&&i===o}changeStat(t,i){let o=this.pilot[t]+i;if(o<1||o>4)return!1;this.points-=i,this.pilot[t]=o,this.dirty=!0}handleKeys(){this.points>0&&(this.isPressed(A.Key.VK_B,!1)&&this.changeStat("body",1),this.isPressed(A.Key.VK_M,!1)&&this.changeStat("mind",1),this.isPressed(A.Key.VK_S,!1)&&this.changeStat("spirit",1),this.isPressed(A.Key.VK_T,!1)&&this.changeStat("talent",1)),this.isPressed(A.Key.VK_B,!0)&&this.changeStat("body",-1),this.isPressed(A.Key.VK_M,!0)&&this.changeStat("mind",-1),this.isPressed(A.Key.VK_S,!0)&&this.changeStat("spirit",-1),this.isPressed(A.Key.VK_T,!0)&&this.changeStat("talent",-1),this.points===0&&(this.g.term.isKeyPressed(A.Key.VK_ENTER)||this.g.term.isKeyPressed(A.Key.VK_NUMPAD_ENTER))&&this.g.setMode(new kt(this.g,"PlayerShip",this.pilot))}};var Ft=class{constructor(t){this.keyFn=t;this.items=new Map}has(t){return this.items.has(this.keyFn(t))}get(t){return this.items.get(this.keyFn(t))}getOrDefault(t,i){let o=this.items.get(this.keyFn(t));return typeof o!="undefined"?o:i}getOrDie(t){let i=this.keyFn(t),o=this.items.get(i);if(typeof o=="undefined")throw new Error(`Invalid key: ${i}`);return o}set(t,i){this.items.set(this.keyFn(t),i)}};function Ne(e,t,i=1/0){let o=[],r=new Ft(n=>`${n.x},${n.y}`);for(let n of e)o.push(n),r.set(n,0);for(;o.length;){let n=o.shift(),a=r.getOrDie(n)+1;if(!(a>i))for(let s of ce(n))!r.has(s)&&t(s)&&(r.set(s,a),o.push(s))}return r}var Kt=class{constructor(t,i,o){this.term=t;this.mapWidth=i;this.mapHeight=o;t.update=this.update.bind(this),this.map=new Qt.Console(i,o,()=>!0),this.lastEntityId=0,this.entities=new St(Qe),this.overlays=new Map,this.clearEventHandlers(),this.setMode(new Gt(this))}setMode(t){this.mode=t,this.mode.init()}clearEventHandlers(){this.eventCallbacks=qe(Xe.map(t=>[t,[]]))}fire(t,i){for(let o of this.eventCallbacks[t])o(i)}on(t,i){this.eventCallbacks[t].push(i)}spawn(t){return pe(this,t)}refresh(){this.mode.refresh()}add(t){return this.refresh(),this.entities.add(t),this.fire("spawn",{e:t}),t}kill(t,i){t.alive&&(t.kill(i),this.fire("kill",{e:t,reason:i}))}move(t,i){let o=t.position;t.move(i.x,i.y),o&&this.fire("move",{e:t,old:o,pos:i})}blankMap(){let{map:t,mapHeight:i,mapWidth:o}=this;t.clear();for(let r=0;r<i;r++)for(let n=0;n<o;n++)t.setBlocked(n,r,!1),t.setBlockedSight(n,r,!1);t.computeFov(0,0,1/0)}drawIfVisible(t,i,o,r,n,a){this.map.isVisible(t,i)&&(a?this.term.drawCell(t,i,{bg:n},a):this.term.drawChar(t,i,o,r,n))}blend(t,i,o){this.term.drawCell(t,i,{bg:o},Qt.BlendMode.Add)}getRoot(t){return t.attachment?this.getRoot(t.attachment.parent):t}getContents(t,i=[]){let o=I(t);if(!this.inBounds(o))return{oob:!0,other:[]};let r=this.map.isBlocked(o.x,o.y),n=this.entities.get().filter(s=>s.position&&z(o,s.position)),a=n.filter(s=>!i.includes(s.id)).find(s=>s.solid);return{wall:r,solid:a,other:n.filter(s=>!s.solid)}}tick(){this.overlays.clear(),this.fire("tick",void 0),this.entities.clearDead()}update(){this.mode.update()}inBounds(t){return t.x>=0&&t.y>=0&&t.x<this.mapWidth&&t.y<this.mapHeight}getDistanceMap(t){let i=`${t.id}.distance`,o=this.overlays.get(i);return o||(o=Ne(H(this,t).map(r=>r.position).filter(Ct),this.inBounds.bind(this)),this.overlays.set(i,o)),o}};function cr(e){let o=Xt.DEFAULT_FONT,r=document.createElement("div");e.appendChild(r);let n=()=>{let m=60*o.charWidth,p=40*o.charHeight,d=Math.floor(window.innerWidth/m),x=Math.floor(window.innerHeight/p),P=Math.min(d,x);r.style.width=`${m*P}px`,r.style.height=`${p*P}px`};window.addEventListener("resize",n),n();let a=document.createElement("canvas");r.appendChild(a),requestAnimationFrame(()=>a.focus());let s=new Xt.Terminal(a,60,40,{font:o}),l=new Kt(s,60,40-bt);window.g=l}window.addEventListener("load",()=>cr(document.body));})();
//# sourceMappingURL=bundle.js.map
