"use strict";(()=>{var ue=Object.create;var tt=Object.defineProperty;var ye=Object.getOwnPropertyDescriptor;var ge=Object.getOwnPropertyNames,Ot=Object.getOwnPropertySymbols,be=Object.getPrototypeOf,_t=Object.prototype.hasOwnProperty,xe=Object.prototype.propertyIsEnumerable;var Wt=(e,t,i)=>t in e?tt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,H=(e,t)=>{for(var i in t||={})_t.call(t,i)&&Wt(e,i,t[i]);if(Ot)for(var i of Ot(t))xe.call(t,i)&&Wt(e,i,t[i]);return e};var Ee=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),R=(e,t)=>{for(var i in t)tt(e,i,{get:t[i],enumerable:!0})},Pe=(e,t,i,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of ge(t))!_t.call(e,n)&&n!==i&&tt(e,n,{get:()=>t[n],enumerable:!(o=ye(t,n))||o.enumerable});return e};var x=(e,t,i)=>(i=e!=null?ue(be(e)):{},Pe(t||!e||!e.__esModule?tt(i,"default",{value:e,enumerable:!0}):i,e));var g=Ee((Pi,Vt)=>{Vt.exports=globalThis.wglt});var lt=x(g());var ce=x(g());function V(e,t=new Map){if(!e||typeof e!="object")return e;if(t.has(e))return t.get(e);let i;if(e.nodeType&&"cloneNode"in e)i=e.cloneNode(!0),t.set(e,i);else if(e instanceof Date)i=new Date(e.getTime()),t.set(e,i);else if(e instanceof RegExp)i=new RegExp(e),t.set(e,i);else if(Array.isArray(e)){i=new Array(e.length),t.set(e,i);for(let o=0;o<e.length;o++)i[o]=V(e[o],t)}else if(e instanceof Map){i=new Map,t.set(e,i);for(let[o,n]of e.entries())i.set(o,V(n,t))}else if(e instanceof Set){i=new Set,t.set(e,i);for(let o of e)i.add(V(o,t))}else if(e instanceof Object){i={},t.set(e,i);for(let[o,n]of Object.entries(e))i[o]=V(n,t)}else throw Error(`Unable to clone ${e}`);return i}function Yt(e){return V(e,new Map)}var pt=Yt,$t=Object.keys,jt=e=>{let t={};for(let[i,o]of e)t[i]=o;return t};var I=class{constructor(t,i){this.g=t;this.name=i;this.alive=!0,this.id=++t.lastEntityId,this.solid=!1,this.tags=new Set}applyPrefab(t,i){if(this.prefab=t,i.components&&Object.assign(this,pt(i.components)),i.children)for(let{name:o,x:n,y:r,overlay:a,tags:s}of i.children){let l=this.g.spawn(o).setAttachment({parent:this,x:n,y:r});if(a)for(let p of $t(a))Object.assign(l[p],pt(a[p]));if(s)for(let p of s)l.tags.add(p)}return this}get[Symbol.toStringTag](){return this.name}kill(t){return this.alive=!1,this.eachChild(i=>this.g.kill(i,t)),this}eachChild(t){var i;for(let o of this.g.entities.get())((i=o.attachment)==null?void 0:i.parent)===this&&t(o,o.attachment)}setOwner(t){return this.owner=t,this}setAI(t){return this.ai=t,this}setAppearance(t){return this.g.refresh(),this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setPilot(t){return this.pilot=t,this}setPosition(t){return this.g.refresh(),this.position=t,this}setShip(t){return this.ship=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,i){return this.g.refresh(),this.position={x:t,y:i},this.eachChild((o,n)=>o.move(t+n.x,i+n.y)),this}};function Ut(e,t){var n,r,a,s;let i=(r=(n=e.appearance)==null?void 0:n.layer)!=null?r:0,o=(s=(a=t.appearance)==null?void 0:a.layer)!=null?s:0;return i!==o?i-o:e.id-t.id}var zt=["damage","draw","kill","move","notice","playerFire","playerMove","spawn","tick"];var ft={};R(ft,{Battleship:()=>we,BattleshipHull:()=>Se});var mt=x(g());var qt=(r=>(r[r.Effect=0]="Effect",r[r.Ship=1]="Ship",r[r.Gun=2]="Gun",r[r.Bullet=3]="Bullet",r[r.Player=4]="Player",r))(qt||{}),d=qt;var we={components:{ai:{idealDistance:8,speed:1},ship:{name:"Battleship",hp:40,maxHp:40}},children:[{name:"BattleshipHull",x:1,y:0},{name:"BattleshipHull",x:2,y:0},{name:"BattleshipHull",x:0,y:1},{name:"BattleshipHull",x:1,y:1},{name:"BattleshipHull",x:2,y:1},{name:"MachineGun",x:0,y:1},{name:"HomingMissileLauncher",x:2,y:1},{name:"FighterLauncher",x:2,y:0}]},Se={components:{solid:!0,appearance:{glyph:"/",layer:d.Ship,fg:mt.Colors.WHITE,bg:mt.Colors.BROWN}}};var ht={};R(ht,{Bullet:()=>ve,HomingMissile:()=>Me,PlayerBullet:()=>Te});var et=x(g());var He={Club:"",Dot:"\x07",RingInvert:`
`,Female:"\f",Pilcrow:"",Silcrow:"",ResizeVertical:"",RightArrow:"",LeftArrow:"\x1B",DownWedge:"",Pentagon:"\x7F",CapitalUUmlaut:"\x9A",Cent:"\x9B",Yen:"\x9D",NotFlip:"\xA9",Not:"\xAA",InvertedExclamation:"\xAD",BoxVerticalSingle:"\xB3",BoxUpSingleHorizontalSingle:"\xC1",BoxDownSingleHorizontalSingle:"\xC2",BoxHorizontalSingle:"\xC4",BoxUpDoubleHorizontalSingle:"\xD0",BoxDownSingleHorizontalDouble:"\xD1",BoxVerticalDoubleHorizontalSingle:"\xD7",Pi:"\xE3",Theta:"\xE9",Omega:"\xEA",SymbolED:"\xED",HorizontalDivide:"\xF6"},m=He;var ve={components:{projectile:{damage:1},appearance:{glyph:".",layer:d.Bullet,fg:et.Colors.YELLOW}}},Me={components:{projectile:{damage:1},homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,falloff:1},appearance:{glyph:"*",layer:d.Bullet,fg:et.Colors.DARK_RED}}},Te={components:{projectile:{damage:1},appearance:{glyph:m.InvertedExclamation,layer:d.Bullet,fg:et.Colors.YELLOW}}};var ct={};R(ct,{AirFistRange:()=>Ce,SmokePuff:()=>Ae});var F=x(g());var Ce={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:d.Effect,bg:(0,F.fromRgb)(0,255,255,100),blendMode:F.BlendMode.Add}}},Ae={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:d.Effect,bg:(0,F.fromRgb)(100,100,100,50),blendMode:F.BlendMode.Add}}};var dt={};R(dt,{Fighter:()=>ke,FighterHull:()=>Be,FighterLauncher:()=>De});var it=x(g());var L=(e,t,{bulletPrefab:i="Bullet",bulletVelocity:o=1,salvoCount:n=1,timeBetweenShots:r=1,timeBetweenSalvos:a=1})=>({name:e,bulletPrefab:i,bulletAngle:t,bulletVelocity:o,salvoCount:n,timeBetweenShots:r,timeBetweenSalvos:a,timer:0,salvo:n});var De={components:{appearance:{glyph:"_",layer:d.Gun,fg:it.Colors.DARK_CYAN},turret:L("Fighter Bay","nearestEnemy",{bulletPrefab:"Fighter",bulletVelocity:0,salvoCount:1,timeBetweenSalvos:20})}},ke={components:{ai:{idealDistance:6,speed:2},ship:{name:"Fighter",hp:2,maxHp:2}},children:[{name:"FighterHull",x:0,y:0,overlay:{appearance:{glyph:"<"}}},{name:"FighterHull",x:1,y:0},{name:"FighterHull",x:2,y:0,overlay:{appearance:{glyph:">"}}},{name:"PeaShooter",x:1,y:0}]},Be={components:{solid:!0,appearance:{glyph:"-",layer:d.Ship,fg:it.Colors.YELLOW,bg:it.Colors.DARK_BLUE}}};var ut={};R(ut,{HomingMissileLauncher:()=>Le,MachineGun:()=>Ie,PeaShooter:()=>Fe,PlayerGun:()=>Ge});var Re={Right:0,Down:Math.PI/2,Left:Math.PI,Up:Math.PI*3/2},ot=Re;var Y=x(g());var Ie={components:{appearance:{glyph:"o",layer:d.Gun,fg:Y.Colors.WHITE},turret:L("Machine Gun",ot.Down,{bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:5,timeBetweenShots:0,timeBetweenSalvos:12})}},Le={components:{appearance:{glyph:"o",layer:d.Gun,fg:Y.Colors.YELLOW},turret:L("Homing Missile","nearestEnemy",{bulletPrefab:"HomingMissile",bulletVelocity:1,salvoCount:1,timeBetweenSalvos:8})}},Fe={components:{appearance:{glyph:"o",layer:d.Gun,fg:Y.Colors.LIGHT_GRAY},turret:L("Pea Shooter",ot.Down,{bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:1,timeBetweenSalvos:3})}},Ge={components:{appearance:{glyph:"o",layer:d.Gun,fg:Y.Colors.WHITE},turret:L("Pew Pew",ot.Up,{bulletPrefab:"PlayerBullet",bulletVelocity:2,salvoCount:2,timeBetweenShots:0,timeBetweenSalvos:3})}};var gt={};R(gt,{PlayerHull:()=>Ke,PlayerShip:()=>Ne});var yt=x(g());var f=(e,t,i,o,n)=>({name:e,x:t,y:i,overlay:o,tags:n});var Ke={components:{solid:!0,appearance:{glyph:"#",layer:d.Player,fg:yt.Colors.DARK_GRAY}}},Ne={components:{player:{weaponArrays:["Primary"]},ship:{name:"Alpha",hp:20,maxHp:20}},children:[f("PlayerHull",0,0,{appearance:{glyph:m.LeftArrow}}),f("PlayerHull",1,0,{appearance:{glyph:m.Club,fg:yt.Colors.LIGHT_GRAY}}),f("PlayerHull",2,0,{appearance:{glyph:m.RightArrow}}),f("PlayerGun",1,0,void 0,["Primary"])]};var bt={};R(bt,{CruiseyWing:()=>Je,Demigod:()=>ei,DroneA:()=>qe,DroneB:()=>Qe,DroneC:()=>Xe,GoutOFlame:()=>ti,Hull:()=>Oe,Olm:()=>Ze,ShipA:()=>We,ShipB:()=>_e,ShipC:()=>Ve,ShipD:()=>Ye,ShipE:()=>$e,ShipF:()=>je,ShipG:()=>Ue,ShipH:()=>ze});var Qt=x(g());var Oe={components:{solid:!0,appearance:{glyph:"#",layer:d.Ship,fg:Qt.Colors.DARK_GRAY}}},We={components:{ship:{name:"A",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Pilcrow}})]},_e={components:{ship:{name:"B",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Yen}})]},Ve={components:{ship:{name:"C",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:"W"}})]},Ye={components:{ship:{name:"D",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Omega}})]},$e={components:{ship:{name:"E",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.DownWedge}})]},je={components:{ship:{name:"F",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Pi}})]},Ue={components:{ship:{name:"G",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:"M"}})]},ze={components:{ship:{name:"H",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Female}})]},qe={components:{ship:{name:"Drone A",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Theta}})]},Qe={components:{ship:{name:"Drone B",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.SymbolED}})]},Xe={components:{ship:{name:"Drone C",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Silcrow}})]},Je={components:{ship:{name:"Cruisey Wing",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Not}}),f("Hull",1,0,{appearance:{glyph:m.HorizontalDivide}}),f("Hull",2,0,{appearance:{glyph:m.NotFlip}})]},Ze={components:{ship:{name:"Olm",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Cent}}),f("Hull",0,1,{appearance:{glyph:m.ResizeVertical}}),f("Hull",0,2,{appearance:{glyph:m.BoxDownSingleHorizontalDouble}})]},ti={components:{ship:{name:"Gout-'o-flame",hp:1,maxHp:1}},children:[f("Hull",0,0,{appearance:{glyph:m.Pentagon}}),f("Hull",1,0,{appearance:{glyph:m.BoxVerticalDoubleHorizontalSingle}}),f("Hull",2,0,{appearance:{glyph:m.Pentagon}}),f("Hull",1,1,{appearance:{glyph:m.BoxUpDoubleHorizontalSingle}})]},ei={components:{ship:{name:"Demigod",hp:1,maxHp:1}},children:[f("Hull",1,0,{appearance:{glyph:m.CapitalUUmlaut}}),f("Hull",0,1,{appearance:{glyph:"}"}}),f("Hull",1,1,{appearance:{glyph:m.RingInvert}}),f("Hull",2,1,{appearance:{glyph:"{"}}),f("Hull",1,2,{appearance:{glyph:"Y"}})]};var ii=H(H(H(H(H(H(H({},ft),ht),ct),dt),ut),gt),bt);function xt(e,t){return e.add(new I(e,t).applyPrefab(t,ii[t]))}function v(e){return typeof e=="undefined"?NaN:Math.floor(e)}function M(e){return{x:v(e.x),y:v(e.y)}}function G(e,t){let i=M(e),o=M(t);return i.x===o.x&&i.y===o.y}function T(e,t){return{x:e.x+t.x,y:e.y+t.y}}var $=class{constructor(t,i=[]){this.compareFn=t;this.entities=i;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}add(t){this.entities.push(t),this.dirty=!0}clearDead(){this.entities=this.entities.filter(t=>t.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var h=x(g());var _=x(g());function oi(e,t){if(!t||!e.length)throw new Error("Could not get midpoint");let i=o=>e.reduce((n,{offset:r})=>n+r[o],0)/e.length;return{x:t.x+i("x"),y:t.y+i("y")}}function ni(e,t,i,o=[]){let n=[];for(let{offset:r}of t){let a=T(i,r),{wall:s,solid:l}=e.getContents(a,o);s?n.push({absolute:a,offset:r,entity:"wall"}):l&&n.push({absolute:a,offset:r,entity:l})}return n}function C(e,t){let i=e.getRoot(t);return e.entities.get().filter(o=>e.getRoot(o)===i)}function j(e,t){return C(e,t).map(i=>i.id)}function A(e,t){var s;let i=(s=e.getRoot(t).position)!=null?s:{x:0,y:0},o=C(e,t),n=[],r=0,a=0;for(let l of o){let{attachment:p,solid:c}=l;if(p&&c){let{x:u,y:P}=p;n.push({absolute:T(i,p),offset:{x:u,y:P},entity:l}),r=Math.max(u+1,r),a=Math.max(P+1,a)}}return{layout:n,topLeft:i,width:r,height:a}}function Xt(e,t,i){let o=j(e,t),{layout:n,topLeft:r}=A(e,t);return!i||!r?[]:ni(e,n,i||r,o)}function K(e,t){let{layout:i,topLeft:o}=A(e,t);if(!o||!i.length)throw new Error(`Could not get midpoint of entity#${t.id}`);return oi(i,o)}var y=class{constructor(t,i){this.list=t;this.filter=i}matches(t){if(!t.alive)return!1;for(let i of this.filter)if(!t[i])return!1;return!0}forEach(t){for(let i of this.list.get())this.matches(i)&&t(i,i)}};var Et=[{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:-1}];function Pt(e){return Et.map(t=>T(e,t))}function D(e){if(!e.length)throw new Error("oneOf passed empty array");return e[Math.floor(Math.random()*e.length)]}function wt(e){let t=new y(e.entities,["ai","position"]);e.on("tick",()=>t.forEach(({ai:i,position:o},n)=>{i.attacking||(i.attacking=e.player,e.fire("notice",{e:n,noticed:e.player}));let r=j(e,n),{layout:a}=A(e,n),s=M(o),l=e.getDistanceMap(i.attacking),p=b=>{let{solid:S,wall:k}=e.getContents(b,r);return!S&&!k},c=b=>p(b)?Math.abs(l.getOrDefault(b,1/0)-i.idealDistance):1/0,u=b=>a.reduce((S,{offset:k})=>S+c(T(b,k)),0)/a.length,P=u(s),w=[];for(let b of Et){let S=T(s,b);if(!l.has(S))continue;let k=u(S);k<P?(P=k,w=[S]):k===P&&w.push(S)}if(w.length){let b=D(w);n.move(b.x,b.y);return}})),e.on("damage",({e:i,inflicter:o})=>{if(i!==o&&i.ai&&!i.ai.attacking){let n=e.getRoot(o);n.alive&&(i.ai.attacking=n)}})}function St(e){let t=new y(e.entities,["appearance","position"]);e.on("draw",()=>t.forEach(({appearance:i,position:o})=>e.drawIfVisible(v(o.x),v(o.y),i.glyph,i.fg,i.bg,i.blendMode)))}var Jt=x(g());var nt=x(g());function N(e,t,i){return e*(1-i)+t*i}var U=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[i])=>t-i)}add(t,i){return this.points.push([t,i]),this.sort(),this}get(t){let[i,o]=this.points[0];if(t<=i)return(0,nt.fromRgb)(...o);let[n,r]=this.points[this.points.length-1];if(t>=n)return(0,nt.fromRgb)(...r);let a=this.points.findIndex(([de])=>de>t),[s,[l,p,c,u]]=this.points[a-1],[P,[w,b,S,k]]=this.points[a],Z=(t-s)/(P-s);return(0,nt.fromRgb)(N(l,w,Z),N(p,b,Z),N(c,S,Z),N(u,k,Z))}};function z(e,t){let i=Math.abs(e.x-t.x),o=Math.abs(e.y-t.y);return Math.sqrt(i*i+o*o)}var ri={fire:new U([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function Ht(e){if(!(e.intensity<=0))return{glyph:" ",layer:d.Effect,bg:ri[e.type].get(e.intensity),blendMode:Jt.BlendMode.Add}}function Zt(e,t){let i=[],o=Math.floor(e.x-t),n=Math.ceil(e.x+t),r=Math.floor(e.y-t),a=Math.ceil(e.y+t);for(let s=r;s<=a;s++)for(let l=o;l<=n;l++){let p=z(e,{x:l,y:s});p>=t||i.push({x:l,y:s,intensity:t-p})}return i}function vt(e){e.on("kill",({e:t})=>{let{explodes:i,name:o,position:n}=t;if(i&&n)for(let{x:r,y:a,intensity:s}of Zt(n,i.size))e.add(new I(e,o+"Explosion").setPosition({x:r,y:a}).setField({type:"fire",intensity:s,falloff:i.falloff}))})}function Mt(e){let t=new y(e.entities,["ship"]),i=new y(e.entities,["field","position"]);e.on("tick",()=>i.forEach(({field:o,position:n},r)=>{o.intensity-=o.falloff,r.setAppearance(Ht(o)),o.intensity<=0?e.kill(r):t.forEach((a,s)=>{let{layout:l}=A(e,s);l.find(({absolute:c})=>G(c,n))&&e.damage(s,o.intensity,r)})})),e.on("spawn",({e:o})=>{o.field&&o.setAppearance(Ht(o.field))})}var E=x(g());var te=Math.PI*2;function O(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}function ee(e,t){let i=(e-t)%te,o=(t-e)%te;return i<o?-i:o}function rt(e){let t=Math.cos(e.angle)*e.vel,i=Math.sin(e.angle)*e.vel;return[t,i]}function ie(e){return e.salvo<=0?"Reloading":e.timer>0?"Chambering":"Ready"}function oe(e){e.timer>0&&(e.timer--,e.timer<=0&&e.salvo<=0&&(e.salvo=e.salvoCount))}function at(e){return e.timer===0}function st(e,t,i,o,n,r=[]){--t.salvo<=0?t.timer=t.timeBetweenSalvos:t.timer=t.timeBetweenShots;let a={x:i.x+.5,y:i.y+.5},s=t.bulletAngle==="nearestEnemy"?O(a,o):t.bulletAngle,l=e.spawn(t.bulletPrefab).setIgnoreSolid({ids:r}).move(a.x,a.y);return t.bulletVelocity&&l.setMotion({angle:s,vel:t.bulletVelocity}),l.ai||l.setOwner(n),l}function Tt(e,t){return t===1?e:e+"s"}var W=5;function ai(e,t,i,o,n,r,a,s,l){let p=`${Math.ceil(n)}/${r}`,c=Math.floor(n/r*o);e.drawHLine(t,i,o," ",void 0,s),c&&e.drawHLine(t,i,c," ",void 0,a),e.drawCenteredString(t+o/2,i,p,l)}function si(e,t,i,o){e.drawString(t,i,o.name,E.Colors.WHITE);let n=ie(o);if(n==="Reloading"){e.drawString(t,i+1,`Reloading (${o.timer})`,E.Colors.LIGHT_RED);return}let r=`${o.salvo}/${o.salvoCount}`;e.drawString(t,i+1,r,E.Colors.YELLOW),n==="Chambering"&&e.drawString(t+r.length,i+1,` (${o.timer})`,E.Colors.BROWN)}function Ct(e){let{mapHeight:t,term:i}=e;e.on("draw",()=>{let o=e.player;i.fillRect(0,t,i.width,W," "),i.drawSingleBox(0,t,i.width,W,E.Colors.WHITE);let n=1,r=t+1,a=`${o.pilot.name} in ${o.ship.name}`,s=Math.max(10,a.length-3);i.drawString(n,r,a,E.Colors.WHITE),i.drawString(n,r+1,"HP:",E.Colors.WHITE),ai(i,n+3,r+1,s,o.ship.hp,o.ship.maxHp,E.Colors.DARK_GREEN,E.Colors.DARK_RED,E.Colors.WHITE),n+=s+4,i.drawChar(n-1,r-1,m.BoxDownSingleHorizontalSingle,E.Colors.WHITE),i.drawVLine(n-1,r,W-2,m.BoxVerticalSingle,E.Colors.WHITE),i.drawChar(n-1,r+W-2,m.BoxUpSingleHorizontalSingle,E.Colors.WHITE);for(let l of o.player.weaponArrays){let p=C(e,o).filter(u=>u.turret),c=n;for(let u of p)si(i,c,r+1,u.turret),c+=15;i.drawString(n,r,`${l} ${Tt("Weapon",p.length)}`,E.Colors.LIGHT_CYAN)}})}function At(e){let t=new y(e.entities,["homing","motion","position"]);e.on("tick",()=>t.forEach(({homing:i,motion:o,position:n},r)=>{var p;if(!((p=i.target)!=null&&p.alive))return;let a=K(e,i.target),s=O(n,a),l=ee(o.angle,s);Math.abs(l)<=i.strength?o.angle=s:l<0?o.angle-=i.strength:o.angle+=i.strength,--i.duration<=0&&(r.setHoming(),r.setTrail())}))}function Dt(e){let t=new y(e.entities,["lifetime"]);e.on("tick",()=>t.forEach(({lifetime:i},o)=>{--i.duration<=0&&e.kill(o)}))}function ne(e,t){let i=t.x-e.x,o=t.y-e.y,n=Math.abs(i),r=Math.abs(o),a=i>0?1:-1,s=o>0?1:-1,l=H({},e),p=[H({},l)];for(let c=0,u=0;c<n||u<r;)(.5+c)/n<(.5+u)/r?(l.x+=a,c++):(l.y+=s,u++),p.push(H({},l));return p}function re(e,t,i){let o=[],n=(r,a)=>{let s=v(r),l=v(a);o.find(p=>p.x===s&&p.y===l)||o.push({x:s,y:l})};for(let r=0;r<=Math.floor(i*Math.sqrt(.5));r++){let a=Math.floor(Math.sqrt(i*i-r*r));n(e-a,t+r),n(e+a,t+r),n(e-a,t-r),n(e+a,t-r),n(e+r,t-a),n(e+r,t+a),n(e-r,t-a),n(e-r,t+a)}return o}function kt(e){let t=new y(e.entities,["motion","position"]);e.on("tick",()=>t.forEach(({motion:i,position:o,projectile:n,ignoreSolid:r},a)=>{let[s,l]=rt(i),p={x:o.x+s,y:o.y+l},c=ne(M(o),M(p)),u=!1,P;for(let w of c){if(!e.inBounds(w)){e.kill(a);return}e.move(a,w);let{wall:b,solid:S}=e.getContents(w,r==null?void 0:r.ids);if(b){u=!0;break}else if(S){P=S;break}}u?e.kill(a):P?(n&&e.damage(P,n.damage,a),e.kill(a)):e.move(a,p)}))}function Bt(e){e.on("playerMove",({move:t})=>{let i=e.player,o=T(i.position,t);Xt(e,i,o).length||(i.move(o.x,o.y),e.tick())}),e.on("playerFire",({array:t})=>{let i=e.player,o=i.player.weaponArrays[t],n=C(e,i),r=n.filter(s=>s.tags.has(o)),a=!1;for(let s of r)s.turret&&at(s.turret)&&(st(e,s.turret,s.position,{x:0,y:0},i,n.map(l=>l.id)),a=!0);a&&e.tick()})}var ae=["Typical","Healthy","Double","Multi","Drain","StarPilot","Mega"];var B=x(g());var li={name:"Basic",difficulty:0,body:1,mind:1,spirit:1,talent:1,class:[]},pi=[li],se=pi;var mi={name:"Bodini",difficulty:4,body:3,mind:2,spirit:3,talent:2,class:[]},fi=[mi],le=fi;function Rt(e,t=0){let i=[];for(let o=t;o<e;o++)i.push(o);return i}function It(e){for(let t=e.length-1;t>0;t--){let i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}return e}var hi={Typical:{fg:B.Colors.DARK_GRAY},Healthy:{fg:B.Colors.DARK_GREEN},Double:{fg:B.Colors.LIGHT_GRAY},Multi:{fg:B.Colors.DARK_MAGENTA},Drain:{fg:B.Colors.DARK_RED},StarPilot:{fg:B.Colors.YELLOW},Mega:{fg:B.Colors.BLACK,bg:B.Colors.DARK_MAGENTA}};var ci={Typical:0,Healthy:2,Double:3,Multi:6,Drain:4,StarPilot:8,Mega:20},di=["ShipA","ShipB","ShipC","ShipD","ShipE","ShipF","ShipG","ShipH","DroneA","DroneB","DroneC","CruiseyWing","Olm","GoutOFlame","Demigod"],ui={ShipA:1,ShipB:1,ShipC:1,ShipD:1,ShipE:1,ShipF:1,ShipG:1,ShipH:1,DroneA:2,DroneB:2,DroneC:2,CruiseyWing:8,Olm:10,GoutOFlame:20,Demigod:40};function yi(e){return e==="StarPilot"||e==="Mega"?D(le):D(se)}function pe(e,t){for(;;){let i=D(di),o=D(ae),n=yi(o),r=ci[o]+ui[i]+n.difficulty;if(r<=t){let a=e.spawn(i).setPilot(n),s=hi[o];for(let l of C(e,a))l.appearance&&Object.assign(l.appearance,s);return{entity:a,difficulty:r}}}}function gi(e,t,i,o,n){for(let r=0;r<n;r++)for(let a=0;a<o;a++){let{wall:s,solid:l,other:p}=e.getContents({x:t+a,y:i+r});if(s||l||p.length)return!1}return!0}function me(e,t,i){for(let o=0;o<5;o++){let n=It(Rt(e.term.width-t));for(let r of n)if(gi(e,r,o,t,i))return{x:r,y:o}}throw new Error(`Could not find spawn position for ${t}x${i}!`)}function Lt(e){let t=0;e.on("tick",()=>{if(t++,!(t%10)){let i=Math.ceil(t/20),{entity:o}=pe(e,i),{width:n,height:r}=A(e,o),a=me(e,n,r);o.move(a.x,a.y)}})}function Ft(e){e.on("move",({e:t,old:i,pos:o})=>{t.trail&&!G(i,o)&&e.spawn(t.trail.effectPrefab).setPosition(i)})}function Gt(e){let t=new y(e.entities,["position","turret"]);e.on("tick",()=>t.forEach(({position:i,turret:o},n)=>{var s;let r=e.getRoot(n),a=(s=r.ai)==null?void 0:s.attacking;if(oe(o),!!(a!=null&&a.alive)&&at(o)&&a){let l=K(e,a),p=st(e,o,i,l,r,j(e,n));p.homing&&(p.homing.target=a),p.ai&&(p.ai.attacking=a)}}))}function fe(e){Dt(e),At(e),Gt(e),Mt(e),kt(e),wt(e),Lt(e),St(e),Ct(e),Ft(e),vt(e),Bt(e)}function he(e,t,i){for(let o of e.entities.get()){let{motion:n,projectile:r,position:a}=o;if(n&&r&&a&&z(t,a)<=i){let s=O(t,a);n.angle=s,o.setIgnoreSolid()}}for(let o of re(t.x,t.y,i))e.spawn("AirFistRange").setPosition(o)}var q=class{constructor(t,i,o){this.g=t;this.shipPrefab=i;this.pilot=o;this.dirty=!0}init(){let{g:t,shipPrefab:i,pilot:o}=this;t.clearEventHandlers(),t.entities.clear(),t.blankMap(),t.player=t.spawn(i).setPilot(o);let{width:n,height:r}=A(t,t.player);t.player.move(v(t.mapWidth/2-n/2),t.mapHeight-r-4),fe(t)}draw(){let{map:t,mapWidth:i,mapHeight:o,overlays:n,term:r}=this.g;for(let a=0;a<o;a++)for(let s=0;s<i;s++){let l=t.grid[a][s];r.drawChar(s,a,0,l.fg,l.bg)}if(this.g.fire("draw",void 0),this.dirty=!1,this.showOverlay){let a=n.get(this.showOverlay);if(a)for(let s=0;s<o;s++)for(let l=0;l<i;l++){let p=a.get({x:l,y:s})||1/0,c=p===1/0?"-":p<10?`${p}`:"*";r.drawChar(l,s,c,_.Colors.LIGHT_RED)}}}update(){this.handleKeys(),this.dirty&&this.draw()}handleKeys(){let{player:t,term:i}=this.g,o=i.getMovementKey();if(o){this.g.fire("playerMove",{move:o});return}if(i.isKeyPressed(_.Key.VK_1)){this.g.fire("playerFire",{array:0});return}if(i.isKeyPressed(_.Key.VK_2)){this.g.fire("playerFire",{array:1});return}if(i.isKeyPressed(_.Key.VK_F)){he(this.g,K(this.g,t),4.5),this.g.tick();return}}};var bi=[0,h.Colors.DARK_RED,h.Colors.BROWN,h.Colors.LIGHT_RED,h.Colors.ORANGE,h.Colors.YELLOW,h.Colors.WHITE],Q=class{constructor(t,i=5,o=100){this.g=t;this.starfieldSpeed=i;this.starCount=o}init(){this.dirty=!0,this.pilot={name:"Player",difficulty:NaN,body:1,mind:1,spirit:1,talent:1,class:[]},this.points=6,this.starfieldCounter=0,this.stars=[];for(let t=0;t<this.starCount;t++)this.stars.push(this.newStar())}draw(){let{term:t}=this.g;t.clear();for(let a of this.stars){let{x:s,y:l}=M(a);t.drawChar(s,l,a.c,a.fg)}let i=t.width/2;t.drawCenteredString(i,2,"Bullet Hell Roguelike",h.Colors.WHITE),t.drawCenteredString(i,9,"Create your Pilot",h.Colors.WHITE),t.drawCenteredString(i,10,`${this.points} points`,h.Colors.YELLOW);let o=2,n=Math.floor((t.width-o*2)/4),r=o+n/2;this.drawStat("body",r),this.drawStat("mind",r+n),this.drawStat("spirit",r+n*2),this.drawStat("talent",r+n*3),this.points===0&&t.drawCenteredString(i,20,"Hit Enter to begin!",h.Colors.WHITE),this.dirty=!1}drawStat(t,i){let{term:o}=this.g,n=`(${t[0].toUpperCase()})${t.slice(1)}`,r=this.pilot[t];o.drawCenteredString(i,13,n,h.Colors.LIGHT_CYAN),o.drawCenteredString(i,14,r.toString(),bi[r])}update(){this.handleStarfield(),this.handleKeys(),this.dirty&&this.draw()}newStar(){let{term:t}=this.g,i=D([h.Colors.DARK_RED,h.Colors.LIGHT_RED,h.Colors.YELLOW,h.Colors.LIGHT_CYAN,h.Colors.WHITE]),o=.5+Math.random(),n=o<.75?".":o<1.25?m.Dot:"*",r=Math.random()*Math.PI*2;return{x:t.width/2,y:t.height/2,c:n,fg:i,vel:o,angle:r}}handleStarfield(){if(this.starfieldCounter<this.starfieldSpeed){this.starfieldCounter++;return}this.starfieldCounter=0,this.dirty=!0;let{width:t,height:i}=this.g.term;for(let o of this.stars){let[n,r]=rt(o);o.x+=n,o.y+=r,(o.x<0||o.x>=t||o.y<0||o.y>=i)&&Object.assign(o,this.newStar())}}isPressed(t,i){let o=this.g.term.isKeyDown(h.Key.VK_SHIFT_LEFT)||this.g.term.isKeyDown(h.Key.VK_SHIFT_RIGHT);return this.g.term.isKeyPressed(t)&&i===o}changeStat(t,i){let o=this.pilot[t]+i;if(o<1||o>6)return!1;this.points-=i,this.pilot[t]=o,this.dirty=!0}handleKeys(){this.points>0&&(this.isPressed(h.Key.VK_B,!1)&&this.changeStat("body",1),this.isPressed(h.Key.VK_M,!1)&&this.changeStat("mind",1),this.isPressed(h.Key.VK_S,!1)&&this.changeStat("spirit",1),this.isPressed(h.Key.VK_T,!1)&&this.changeStat("talent",1)),this.isPressed(h.Key.VK_B,!0)&&this.changeStat("body",-1),this.isPressed(h.Key.VK_M,!0)&&this.changeStat("mind",-1),this.isPressed(h.Key.VK_S,!0)&&this.changeStat("spirit",-1),this.isPressed(h.Key.VK_T,!0)&&this.changeStat("talent",-1),this.points===0&&this.g.term.isKeyPressed(h.Key.VK_ENTER)&&this.g.setMode(new q(this.g,"PlayerShip",this.pilot))}};var X=class{constructor(t){this.keyFn=t;this.items=new Map}has(t){return this.items.has(this.keyFn(t))}get(t){return this.items.get(this.keyFn(t))}getOrDefault(t,i){let o=this.items.get(this.keyFn(t));return typeof o!="undefined"?o:i}getOrDie(t){let i=this.keyFn(t),o=this.items.get(i);if(typeof o=="undefined")throw new Error(`Invalid key: ${i}`);return o}set(t,i){this.items.set(this.keyFn(t),i)}};function Kt(e,t,i=1/0){let o=[],n=new X(r=>`${r.x},${r.y}`);for(let r of e)o.push(r),n.set(r,0);for(;o.length;){let r=o.shift(),a=n.getOrDie(r)+1;if(!(a>i))for(let s of Pt(r))!n.has(s)&&t(s)&&(n.set(s,a),o.push(s))}return n}function Nt(e){return typeof e!="undefined"}var J=class{constructor(t,i,o){this.term=t;this.mapWidth=i;this.mapHeight=o;t.update=this.update.bind(this),this.map=new ce.Console(i,o,()=>!0),this.lastEntityId=0,this.entities=new $(Ut),this.overlays=new Map,this.clearEventHandlers(),this.setMode(new Q(this))}setMode(t){this.mode=t,this.mode.init()}clearEventHandlers(){this.eventCallbacks=jt(zt.map(t=>[t,[]]))}fire(t,i){for(let o of this.eventCallbacks[t])o(i)}on(t,i){this.eventCallbacks[t].push(i)}spawn(t){return xt(this,t)}refresh(){this.mode.dirty=!0}add(t){return this.refresh(),this.entities.add(t),this.fire("spawn",{e:t}),t}kill(t,i){t.alive&&(t.kill(i),this.fire("kill",{e:t,by:i}))}move(t,i){let o=t.position;t.move(i.x,i.y),o&&this.fire("move",{e:t,old:o,pos:i})}blankMap(){let{map:t,mapHeight:i,mapWidth:o}=this;t.clear();for(let n=0;n<i;n++)for(let r=0;r<o;r++)t.setBlocked(r,n,!1),t.setBlockedSight(r,n,!1);t.computeFov(0,0,1/0)}drawIfVisible(t,i,o,n,r,a){this.map.isVisible(t,i)&&(a?this.term.drawCell(t,i,{bg:r},a):this.term.drawChar(t,i,o,n,r))}getRoot(t){var o;let i=(o=t.owner)!=null?o:t;return i.attachment?this.getRoot(i.attachment.parent):i}getContents(t,i=[]){let o=M(t);if(!this.inBounds(o))return{wall:!0,other:[]};let n=this.map.isBlocked(o.x,o.y),r=this.entities.get().filter(s=>s.position&&G(o,s.position)),a=r.filter(s=>!i.includes(s.id)).find(s=>s.solid);return{wall:n,solid:a,other:r.filter(s=>!s.solid)}}tick(){this.overlays.clear(),this.fire("tick",void 0),this.entities.clearDead()}update(){this.mode.update()}inBounds(t){return t.x>=0&&t.y>=0&&t.x<this.mapWidth&&t.y<this.mapHeight}getDistanceMap(t){let i=`${t.id}.distance`,o=this.overlays.get(i);return o||(o=Kt(C(this,t).map(n=>n.position).filter(Nt),this.inBounds.bind(this)),this.overlays.set(i,o)),o}damage(t,i,o){let n=this.getRoot(t);n.ship&&(n.ship.hp-=i,console.log(o.name,"hits",n.name,"for",i),this.fire("damage",{e:n,inflicter:o,amount:i}),n.ship.hp<=0&&this.kill(n,o))}};function xi(e){let o=lt.DEFAULT_FONT,n=document.createElement("div");e.appendChild(n);let r=()=>{let p=60*o.charWidth,c=40*o.charHeight,u=Math.floor(window.innerWidth/p),P=Math.floor(window.innerHeight/c),w=Math.min(u,P);n.style.width=`${p*w}px`,n.style.height=`${c*w}px`};window.addEventListener("resize",r),r();let a=document.createElement("canvas");n.appendChild(a),requestAnimationFrame(()=>a.focus());let s=new lt.Terminal(a,60,40,{font:o}),l=new J(s,60,40-W);window.g=l}window.addEventListener("load",()=>xi(document.body));})();
//# sourceMappingURL=bundle.js.map
