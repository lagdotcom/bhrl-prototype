"use strict";(()=>{var za=Object.create;var zd=Object.defineProperty,va=Object.defineProperties,Wa=Object.getOwnPropertyDescriptor,wa=Object.getOwnPropertyDescriptors,_a=Object.getOwnPropertyNames,Pa=Object.getOwnPropertySymbols,de=Object.getPrototypeOf,Da=Object.prototype.hasOwnProperty,ae=Object.prototype.propertyIsEnumerable;var $a=(a,d,e)=>d in a?zd(a,d,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[d]=e,N=(a,d)=>{for(var e in d||={})Da.call(d,e)&&$a(a,e,d[e]);if(Pa)for(var e of Pa(d))ae.call(d,e)&&$a(a,e,d[e]);return a},ia=(a,d)=>va(a,wa(d));var ee=(a,d)=>()=>(d||a((d={exports:{}}).exports,d),d.exports),$d=(a,d)=>{for(var e in d)zd(a,e,{get:d[e],enumerable:!0})},Le=(a,d,e,L)=>{if(d&&typeof d=="object"||typeof d=="function")for(let P of _a(d))!Da.call(a,P)&&P!==e&&zd(a,P,{get:()=>d[P],enumerable:!(L=Wa(d,P))||L.enumerable});return a};var I=(a,d,e)=>(e=a!=null?za(de(a)):{},Le(d||!a||!a.__esModule?zd(e,"default",{value:a,enumerable:!0}):e,a));var R=ee((bP,ca)=>{ca.exports=globalThis.wglt});function nd(a,d=new Map){if(!a||typeof a!="object")return a;if(d.has(a))return d.get(a);let e;if(a.nodeType&&"cloneNode"in a)e=a.cloneNode(!0),d.set(a,e);else if(a instanceof Date)e=new Date(a.getTime()),d.set(a,e);else if(a instanceof RegExp)e=new RegExp(a),d.set(a,e);else if(Array.isArray(a)){e=new Array(a.length),d.set(a,e);for(let L=0;L<a.length;L++)e[L]=nd(a[L],d)}else if(a instanceof Map){e=new Map,d.set(a,e);for(let[L,P]of a.entries())e.set(L,nd(P,d))}else if(a instanceof Set){e=new Set,d.set(a,e);for(let L of a)e.add(nd(L,d))}else if(a instanceof Object){e={},d.set(a,e);for(let[L,P]of Object.entries(a))e[L]=nd(P,d)}else throw Error(`Unable to clone ${a}`);return e}function Ha(a){return nd(a,new Map)}var u=Ha,Ba=Object.keys,ba=a=>{let d={};for(let[e,L]of a)d[e]=L;return d};var Ad=class{constructor(d,e){this.g=d;this.name=e;this.alive=!0,this.id=++d.lastEntityId,this.solid=!1,this.tags=new Set}applyPrefab(d,e){if(this.prefab=d,e.components&&Object.assign(this,u(e.components)),e.children)for(let{name:L,x:P,y:$,overlay:D,tags:i}of e.children){let H=this.g.spawn(L).setAttachment({parent:this,x:P,y:$});if(D)for(let B of Ba(D))Object.assign(H[B],u(D[B]));if(i)for(let B of i)H.tags.add(B)}return this}get[Symbol.toStringTag](){return this.name}kill(d){return this.alive=!1,this.eachChild(e=>this.g.kill(e,d)),this}eachChild(d){var e;for(let L of this.g.entities.get())((e=L.attachment)==null?void 0:e.parent)===this&&d(L,L.attachment)}setAI(d){return this.ai=d,this}setAppearance(d){return this.g.refresh(),this.appearance=d,this}setAttachment(d){return this.attachment=d,this}setDelayedShot(d){return this.delayedShot=d,this}setDoubleShot(d){return this.doubleShot=d,this}setExplodes(d){return this.explodes=d,this}setField(d){return this.field=d,this}setHoming(d){return this.homing=d,this}setIgnoreSolid(d){return this.ignoreSolid=d,this}setItem(d){return this.item=d,this}setLastMovement(d){return this.lastMovement=d,this}setLifetime(d){return this.lifetime=d,this}setMotion(d){return this.motion=d,this}setOrigin(d){return this.origin=d,this}setPilot(d){return this.pilot=d,this}setPosition(d){return this.g.refresh(),this.position=d,this}setShip(d){return this.ship=d,this}setTrail(d){return this.trail=d,this}setTurret(d){return this.turret=d,this}setPlayer(d){return this.player=d,this}setProjectile(d){return this.projectile=d,this}setSolid(d){return this.solid=d,this}move(d,e){return this.g.refresh(),this.position={x:d,y:e},this.eachChild((L,P)=>L.move(d+P.x,e+P.y)),this}};function ha(a,d){var P,$,D,i;let e=($=(P=a.appearance)==null?void 0:P.layer)!=null?$:0,L=(i=(D=d.appearance)==null?void 0:D.layer)!=null?i:0;return e!==L?e-L:a.id-d.id}var Ud=class{constructor(d,e=[]){this.compareFn=d;this.entities=e;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}clearExceptFor(d){for(let e of this.entities)d.includes(e.id)||(e.alive=!1);this.clearDead()}add(d){this.entities.push(d),this.dirty=!0}clearDead(){this.entities=this.entities.filter(d=>d.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var Aa=["damage","draw","kill","move","notice","playerBomb","playerFire","playerMove","spawn","tick","waveBegin","waveNext"];var Yd=class{constructor(d){this.keyFn=d;this.items=new Map}has(d){return this.items.has(this.keyFn(d))}get(d){return this.items.get(this.keyFn(d))}getOrDefault(d,e){let L=this.items.get(this.keyFn(d));return typeof L!="undefined"?L:e}getOrDie(d){let e=this.keyFn(d),L=this.items.get(e);if(typeof L=="undefined")throw new Error(`Invalid key: ${e}`);return L}set(d,e){this.items.set(this.keyFn(d),e)}};function O(a){return typeof a=="undefined"?NaN:Math.floor(a)}var p=(a,d)=>({x:a,y:d});function s(a){return p(O(a.x),O(a.y))}function w(a,d){if(typeof a=="undefined"||typeof d=="undefined")return!1;let e=s(a),L=s(d);return e.x===L.x&&e.y===L.y}function l(a,d){return p(a.x+d.x,a.y+d.y)}var A0=[p(-1,-1),p(-1,0),p(-1,1),p(0,1),p(1,1),p(1,0),p(1,-1),p(0,-1)];function f0(a){return A0.map(d=>l(a,d))}function X0(a,d,e=1/0){let L=[],P=new Yd(D=>`${D.x},${D.y}`);for(let D of a)L.push(D),P.set(D,0);let $=L.shift();for(;$;){let D=P.getOrDie($)+1;if(D<=e)for(let i of f0($))!P.has(i)&&d(i)&&(P.set(i,D),L.push(i));$=L.shift()}return P}function Pe(a,d){if(!d||!a.length)throw new Error("Could not get midpoint");let e=L=>a.reduce((P,{offset:$})=>P+$[L],0)/a.length;return p(d.x+e("x"),d.y+e("y"))}function $e(a,d,e,L=[]){let P=[];for(let{offset:$}of d){let D=l(e,$),{oob:i,wall:H,solid:B}=a.getContents(D,L);i?P.push({absolute:D,offset:$,entity:"oob"}):H?P.push({absolute:D,offset:$,entity:"wall"}):B&&P.push({absolute:D,offset:$,entity:B})}return P}function n(a,d){let e=a.getRoot(d);return a.entities.get().filter(L=>a.getRoot(L)===e)}function _(a,d){return n(a,d).map(e=>e.id)}function z(a,d){var i;let e=(i=a.getRoot(d).position)!=null?i:p(0,0),L=n(a,d),P=[],$=0,D=0;for(let H of L){let{attachment:B,solid:b}=H;if(B&&b){let{x:c,y:J}=B;P.push({absolute:l(e,B),offset:{x:c,y:J},entity:H}),$=Math.max(c+1,$),D=Math.max(J+1,D)}}return{layout:P,topLeft:e,width:$,height:D}}function fa(a,d,e){let L=_(a,d),{layout:P,topLeft:$}=z(a,d);return!e||!$?[]:$e(a,P,e||$,L)}function K(a,d){let{layout:e,topLeft:L}=z(a,d);if(!L||!e.length){if(d.position)return d.position;throw new Error(`Could not get midpoint of entity#${d.id}`)}return Pe(e,L)}function Xa(a,d,e,L,P){for(let $=0;$<P;$++)for(let D=0;D<L;D++){let{oob:i,wall:H,solid:B,other:b}=a.getContents({x:d+D,y:e+$});if(i||H||B||b.length)return!1}return!0}function jd(a,d){if(!a.alive)return!1;for(let e of d)if(!a[e])return!1;return!0}function Dd(a){return d=>jd(d,a)}var q=I(R()),vd=[0,q.Colors.DARK_RED,q.Colors.BROWN,q.Colors.LIGHT_RED,q.Colors.ORANGE,q.Colors.YELLOW,q.Colors.WHITE],dd={Typical:{fg:q.Colors.DARK_GRAY},Healthy:{fg:q.Colors.DARK_GREEN},Double:{fg:q.Colors.LIGHT_GRAY},Multi:{fg:q.Colors.DARK_MAGENTA},Drain:{fg:q.Colors.DARK_RED},StarPilot:{fg:q.Colors.YELLOW},Mega:{fg:q.Colors.BLACK,bg:q.Colors.DARK_MAGENTA}};function Wd(a,d,e){let{ship:L}=d;if(!L)throw new Error(`Cannot put pilot into entity ${d.name} (no ship)`);if(d.setPilot(e),L.maxHp+=De(d),e.special){let P=K(a,d);a.spawn(e.special).setAttachment(ia(N({},s(P)),{parent:d})).tags.add("Special")}}function ld(a,d){return a.pilot?a.pilot[d]:0}function pa(a){return 7-ld(a,"body")}function De(a){return ld(a,"body")*4}function Ta(a){return ld(a,"mind")}function Ca(a){return(ld(a,"mind")-1)*5}function c0(a,d){return typeof a=="number"?a:Math.floor(a.base+ld(d,a.stat)*a.multiplier)}function fd(a){return Math.random()*100<a}function ad(a,d=0){let e=[];for(let L=d;L<a;L++)e.push(L);return e}function U(a){if(!a.length)throw new Error("oneOf passed empty array");return a[Math.floor(Math.random()*a.length)]}function Jd(a){for(let d=a.length-1;d>0;d--){let e=Math.floor(Math.random()*(d+1));[a[d],a[e]]=[a[e],a[d]]}return a}function wd(a,...d){return a.filter(e=>!d.includes(e))}var ta=($=>($[$.None=0]="None",$[$.Healthy=1]="Healthy",$[$.Double=2]="Double",$[$.Drain=4]="Drain",$[$.HasPilot=8]="HasPilot",$))(ta||{}),x=ta;var Fa=["Berserker","Chopter","Duelist","Engineer","Fighter","Negotiator","Psychic","Smuggler"];var C0={Typical:x.None,Healthy:x.Healthy,Double:x.Double,Multi:x.Healthy|x.Double,Drain:x.Drain,StarPilot:x.HasPilot,Mega:x.Healthy|x.Double|x.Drain|x.HasPilot},ie={Typical:"Fire",Healthy:"Green",Double:"Fire",Multi:"Magenta",Drain:"Fire",StarPilot:"Yellow",Mega:"Magenta"},p0=["ShipA","ShipB","ShipC","ShipD","ShipE","ShipF","ShipG","ShipH"],T0=["CruiseyWing","Olm","GoutOFlame","Demigod","Gremlin","AtomSmasher"],He=[{name:"Let Fate Decide",difficulty:1,groups:[{count:7,type:"Escort",prefabs:p0},{count:1,type:"Battleship",prefabs:T0}]},{name:"Court Martial",difficulty:2,groups:[{count:5,type:"Escort",prefabs:["ShipA","ShipE"]},{count:1,type:"Battleship",prefabs:["CruiseyWing"]}]},{name:"Hellhounds",difficulty:3,groups:[{count:2,type:"Escort",prefabs:["ShipB"]},{count:2,type:"Battleship",prefabs:["GoutOFlame"]}]},{name:"Chaos",difficulty:4,groups:[{count:4,type:"Escort",prefabs:["ShipC"]},{count:4,type:"Escort",prefabs:wd(p0,"ShipC")},{count:1,type:"Battleship",prefabs:["Demigod"]}]},{name:"Fly in Formation",difficulty:4,groups:[{count:7,type:"Escort",prefabs:["ShipF"]},{count:1,type:"Battleship",prefabs:T0}]},{name:"Hark!",difficulty:6,groups:[{count:3,type:"Escort",prefabs:["ShipH"]},{count:3,type:"Escort",prefabs:wd(p0,"ShipH")},{count:1,type:"Battleship",prefabs:["Demigod"]}]},{name:"Caverns.com",difficulty:7,groups:[{count:1,type:"Escort",prefabs:["ShipA","ShipG"]},{count:3,type:"Battleship",prefabs:["Olm"]}]},{name:"Humanity to the Rescue",difficulty:8,groups:[{count:7,type:"Escort",prefabs:["ShipA","ShipD","ShipE","ShipG"]},{count:1,type:"Battleship",prefabs:["GoutOFlame"]}]},{name:"Wild Hunt",difficulty:9,groups:[{count:15,type:"Escort",prefabs:["ShipB","ShipF"]},{count:1,type:"Battleship",prefabs:["Olm"]}]},{name:"Arm Wrestling",difficulty:10,groups:[{count:9,type:"Escort",prefabs:["ShipG"]},{count:2,type:"Battleship",prefabs:["CruiseyWing"]}]},{name:"Valis",difficulty:11,groups:[{count:4,type:"Escort",prefabs:["ShipC"]},{count:4,type:"Escort",prefabs:["ShipH"]},{count:1,type:"Battleship",prefabs:T0}]}];function ra(a=3){return Jd(He.slice()).slice(0,a).sort((d,e)=>d.difficulty-e.difficulty)}function Ja(a,d){return fd(a)?d?"Mega":U(["Healthy","Double","Multi","Drain"]):d?"StarPilot":"Typical"}function Be(a){let d=u(a);for(;d.class.length<d.talent;)d.class.push(U(Fa.filter(e=>!d.class.includes(e))));return d}function Ra(a,d,e,L){let P=C0[e];if(P&x.HasPilot&&!L)throw new Error(`power ${e} needs pilot, none given`);let $=a.spawn(d),{ship:D}=$;if(!D)throw new Error(`Ship prefab ${d} doesn't have a ship component!`);if(D.power=e,P&x.Healthy&&(D.maxHp=D.maxHp*2+3),L){let H=Be(L);Wd(a,$,H)}xd(D);let i=dd[e];for(let H of n(a,$))H.appearance&&Object.assign(H.appearance,i);return P&x.Double&&$.setDoubleShot({duration:1/0}),$.explodes&&($.explodes.type=ie[e]),$}function Ia(a,d){let{width:e,height:L}=z(a,d);for(let P=0;P<a.term.height;P++){let $=Jd(ad(a.term.width-e));for(let D of $)if(Xa(a,D,P,e,L))return{x:D,y:P}}throw new Error(`Could not find ${e}x${L} spawn location`)}function xd(a){a.hp=a.maxHp,a.shield=a.maxShield}var be={Smiley:"",Heart:"",Diamond:"",Club:"",Dot:"\x07",Ring:"	",RingInvert:`
`,Male:"\v",Female:"\f",DoubleNote:"",Star:"",Pilcrow:"",Silcrow:"",ResizeVertical:"",UpArrow:"",DownArrow:"",RightArrow:"",LeftArrow:"\x1B",ResizeHorizontal:"",DownWedge:"",Pentagon:"\x7F",AHat:"\x83",EHat:"\x88",CapitalUUmlaut:"\x9A",Cent:"\x9B",Yen:"\x9D",CurlyF:"\x9F",NotFlip:"\xA9",Not:"\xAA",InvertedExclamation:"\xAD",Fill1:"\xB0",Fill2:"\xB1",Fill3:"\xB2",BoxVerticalSingle:"\xB3",BoxLeftSingleVerticalDouble:"\xB6",BoxLeftSingleUpDouble:"\xBD",BoxUpSingleHorizontalSingle:"\xC1",BoxDownSingleHorizontalSingle:"\xC2",BoxHorizontalSingle:"\xC4",BoxRightSingleVerticalDouble:"\xC7",BoxUpDoubleHorizontalSingle:"\xD0",BoxDownSingleHorizontalDouble:"\xD1",BoxRightSingleUpDouble:"\xD3",BoxVerticalDoubleHorizontalSingle:"\xD7",Filled:"\xDB",Beta:"\xE1",Gamma:"\xE2",Pi:"\xE3",Theta:"\xE9",Omega:"\xEA",SymbolED:"\xED",SetMember:"\xEE",HorizontalDivide:"\xF6",Approximates:"\xF7",Squared:"\xFD",Square:"\xFE"},h=be;var _d=Math.PI*2;function id(a,d){return Math.atan2(d.y-a.y,d.x-a.x)}function Qa(a,d){let e=(a-d)%_d,L=(d-a)%_d;return e<L?-e:L}function Hd(a){let d=Math.cos(a.angle)*a.vel,e=Math.sin(a.angle)*a.vel;return[d,e]}function d0(a){for(;a<0;)a+=_d;return a%_d}var Ma=I(R()),G=class{constructor(d){this.g=d;this.width=0,this.height=0,this.instructions=[]}add(d){this.instructions.push(d),this.updateBounds()}addLine(d,e=Ma.Colors.WHITE,L){this.add({x:0,y:this.instructions.length,line:d,fg:e,bg:L})}updateBounds(){this.width=this.instructions.reduce((d,e)=>Math.max(e.line.length+e.x,d),0),this.height=1+this.instructions.reduce((d,e)=>Math.max(e.y,d),0)}draw(d,e){for(let{x:L,y:P,line:$,fg:D,bg:i}of this.instructions)this.g.term.drawString(d+L,e+P,$,D,i)}};var Rd=I(R()),Ea=Math.PI/4,he=[h.RightArrow,h.DownArrow+h.RightArrow,h.DownArrow,h.DownArrow+h.LeftArrow,h.LeftArrow,h.UpArrow+h.LeftArrow,h.UpArrow,h.UpArrow+h.RightArrow,h.RightArrow];function Ae(a){let d=Math.floor(d0(a)/Ea+Ea/2);return he[d]}var Kd=class extends G{constructor(e,L){var P,$,D;super(e);this.e=L;L.name&&!L.ship&&this.addLine(L.name),L.projectile&&this.addLine(`${L.projectile.damage} damage`,Rd.Colors.LIGHT_RED),(P=L.motion)!=null&&P.vel&&this.addLine(`${Ae(L.motion.angle)}, vel ${L.motion.vel}`,Rd.Colors.LIGHT_GRAY),($=L.homing)!=null&&$.target&&this.addLine(`chasing ${L.homing.target===this.g.player?"you":(D=L.homing.target.ship)==null?void 0:D.name} ${L.homing.duration<1/0?`(${L.homing.duration})`:""}`,Rd.Colors.DARK_RED),L.lifetime&&this.addLine(`(lasts ${L.lifetime.duration})`,Rd.Colors.DARK_GRAY),L.explodes&&this.addLine(`explosion ${L.explodes.size}`,Rd.Colors.ORANGE)}};var t0=I(R()),Zd=class extends G{constructor(e,L){super(e);this.field=L;this.addLine("Explosion"),this.add({x:0,y:1,fg:t0.Colors.LIGHT_GRAY,line:"intensity"}),this.add({x:10,y:1,fg:t0.Colors.YELLOW,line:Math.floor(L.intensity).toString()})}};var a0=I(R()),sd=class extends G{constructor(e,L){super(e);this.item=L;switch(L.type){case"bomb":this.addLine("Smart Bomb"),this.addLine(L.prefab,a0.Colors.LIGHT_GRAY);break;case"double":this.addLine("Double",dd.Double.fg,dd.Double.bg);break;case"drain":this.addLine("Drain",dd.Drain.fg,dd.Drain.bg);break;case"heal":this.addLine("Heal",dd.Healthy.fg,dd.Healthy.bg);break;case"junk":this.addLine("Junk",a0.Colors.DARK_GRAY);break;case"money":this.addLine(`${h.SetMember}${L.value}`,a0.Colors.YELLOW);break;case"recharge":this.addLine("Recharge");break}}};var Vd=I(R()),Xd=class{constructor(d,e,L){this.g=d;this.pilot=e;this.full=L;this.width=11,this.height=L?2+e.class.length:1}get isPlayer(){return this.pilot.player}draw(d,e){if(this.full&&(this.g.term.drawString(d,e,this.pilot.name,this.pilot.star?Vd.Colors.YELLOW:Vd.Colors.LIGHT_GRAY),e++),this.drawStat(d,e,"body"),this.drawStat(d+3,e,"mind"),this.drawStat(d+6,e,"spirit"),this.drawStat(d+9,e,"talent"),!!this.full)for(let L of this.pilot.class)this.g.term.drawString(d,++e,L,Vd.Colors.LIGHT_GREEN)}drawStat(d,e,L){let P=this.pilot[L];this.g.term.drawChar(d,e,L[0].toUpperCase(),Vd.Colors.WHITE),this.g.term.drawChar(d+1,e,P.toString(),vd[P])}};var Sa=I(R()),Nd=class extends G{constructor(e,L){super(e);this.e=L;L.doubleShot&&this.addLine(L.doubleShot.duration===1/0?"2x Shot":`2x Shot (${L.doubleShot.duration})`,Sa.Colors.LIGHT_GRAY)}};function F0(a,d,e,L,P,$,D,i,H){let B=`${Math.ceil(P)}/${$}`,b=Math.floor(P/$*L);a.drawHLine(d,e,L," ",void 0,i),b&&a.drawHLine(d,e,b," ",void 0,D),a.drawCenteredString(d+L/2,e,B,H)}var v=I(R()),cd=class{constructor(d,e){this.g=d;this.ship=e;this.width=Math.max(13,e.name.length),this.height=e.maxShield?3:2}draw(d,e){let{ship:L,width:P}=this,{term:$}=this.g,D=P-3;$.drawString(d,e,L.name,v.Colors.WHITE),$.drawString(d,e+1,"HP:",v.Colors.WHITE),F0($,d+3,e+1,D,L.hp,L.maxHp,v.Colors.DARK_GREEN,v.Colors.DARK_RED,v.Colors.WHITE),L.maxShield&&($.drawString(d,e+2,"Sh:",v.Colors.WHITE),F0($,d+3,e+2,D,L.shield,L.maxShield,v.Colors.DARK_CYAN,v.Colors.LIGHT_BLUE,v.Colors.WHITE))}};var pd=Math.PI/2,e0=pd/2,fe={Right:0,DownRight:e0,Down:pd,DownLeft:pd+e0,Left:pd*2,UpLeft:pd*2+e0,Up:pd*3,UpRight:pd*3+e0},V=fe;function Td(a,d){let e=Math.abs(a.x-d.x),L=Math.abs(a.y-d.y);return Math.sqrt(e*e+L*L)}var ja=I(R());function r0(a){return a.salvo<=0?a.ammunition<=0?"Spent":"Reloading":a.timer>0?"Chambering":"Ready"}function L0(a){a.timer>0&&(a.timer--,a.timer<=0&&a.salvo<=0&&(a.ammunition?(a.salvo=Math.min(a.salvoCount,a.ammunition),a.ammunition-=a.salvo):a.timer=1/0))}function P0(a){return a.timer===0}function na(a,d){var L;let e=(L=a.delayedShot)!=null?L:{shots:[]};e.shots.push(d),a.setDelayedShot(e)}function Ua(a,d,e,L,P,$,D,i,H,B){var c;let b=a.spawn(e).setIgnoreSolid({ids:H}).move($.x,$.y);return b.name=d,i&&b.setMotion({angle:D,vel:i}),b.ship&&xd(b.ship),L.ship&&b.setOrigin({owner:L,ship:L.ship,turret:P}),(c=b.projectile)!=null&&c.scaling&&(b.projectile.damage=c0(b.projectile.scaling,L)),b.appearance&&B&&Object.assign(b.appearance,B),b}function Xe(a,d,e,L,P){var $;switch(e.type){case"lastMovement":return($=P==null?void 0:P.angle)!=null?$:L.firingDirection;case"nearestEnemy":return id(a,d);case"random":return U([V.Right,V.DownRight,V.Down,V.DownLeft,V.Left,V.UpLeft,V.Up,V.UpRight]);case"relative":return d0(L.firingDirection+e.rel)}}function J0(a,d,e,L,P,$,D){var T;if($.doubleShot&&d.canDouble){let r=u(d);r.canDouble=!1,r.delay=$.player?2:1,r.appearance={fg:ja.Colors.LIGHT_GRAY},na($,{turret:e,shot:r})}if(d.delay){let r=u(d);return $.player&&r.delay++,na($,{turret:e,shot:r}),[]}if(d.type==="array"){let r=[];for(let Q of n(a,$).filter(Pd=>Pd.tags.has(d.tag)).filter(Dd(["position","turret"])))r.push(...Id(a,Q.turret,l(Q.position,(T=d.offset)!=null?T:p(0,0)),P,$,D));return r}let{angle:i,beam:H,name:B,offset:b,prefab:c,vel:J}=d,F=l(L,b!=null?b:p(0,0)),t=Xe(F,P,i,$.ship,$.lastMovement);if(H&&J){let[r,Q]=Hd({angle:t,vel:J}),Pd=p(r,Q),Od=l(F,Pd),ea=c0(H.length,$),Oa=h0=>H.appearance[Math.max(0,H.appearance.length-ea+h0)];return ad(ea,0).map(h0=>{let Sd=Ua(a,B,c,$,e,Od,t,0,D,d.appearance).setMotion({angle:t,vel:0}).setLifetime({duration:H.duration}),La=Oa(h0);return Sd.appearance&&La&&Object.assign(Sd.appearance,La),$.ship&&Sd.setOrigin({owner:$,ship:$.ship,turret:e}),a.inBounds(Od)||Sd.kill({type:"exitedMap"}),Od=l(Od,Pd),Sd})}return[Ua(a,B,c,$,e,F,t,J,D,d.appearance)]}function Id(a,d,e,L,P,$){let{timeBetweenSalvos:D,timeBetweenShots:i}=d;--d.salvo<=0?d.timer=D:d.timer=i;let H=[];for(let B of d.shots)H.push(...J0(a,B,d,e,L,P,$));return H}function Ya(a){return(a==null?void 0:a.type)==="Player"}function $0(a,d){let e=Ya(d.ship),L=K(a,d),P=a.entities.get().filter(i=>i.ship&&Ya(i.ship)!==e);if(!P.length)return;let $=1/0,D;for(let i of P){let H=K(a,i),B=Td(L,H);B<$&&($=B,D=i)}return D}var Cd=I(R()),ce={Spent:Cd.Colors.DARK_GRAY,Reloading:Cd.Colors.LIGHT_RED,Ready:Cd.Colors.YELLOW,Chambering:Cd.Colors.BROWN},td=class{constructor(d,e){this.g=d;this.turret=e;this.width=Math.max(e.name.length,this.stateLabel.length),this.height=2,e.ammunition>0&&e.ammunition<1/0&&this.height++}get stateLabel(){let{timer:d,salvo:e,salvoCount:L}=this.turret,P=r0(this.turret);if(P==="Spent")return"Out of Ammo";if(P==="Reloading")return`Reloading (${d})`;let $=`${e}/${L}`;return P==="Ready"?$:`${$} (${d})`}draw(d,e){this.g.term.drawString(d,e,this.turret.name,Cd.Colors.WHITE);let L=r0(this.turret);this.g.term.drawString(d,e+1,this.stateLabel,ce[L]),this.height>2&&this.g.term.drawString(d,e+2,`${this.turret.ammunition} ammo left`,Cd.Colors.LIGHT_GRAY)}};var qd=class{constructor(d,e){this.g=d;this.e=e;this.instructions=[];let L=0,P=0;this.width=0;let $=i=>{this.instructions.push({x:L,y:P,object:i}),P+=i.height+1,this.width=Math.max(this.width,L+i.width)};e.ship&&$(new cd(d,e.ship)),e.pilot&&$(new Xd(d,e.pilot,!0)),e.doubleShot&&$(new Nd(d,e));let D=n(d,e);for(let i of D.filter(Dd(["turret"])))$(new td(d,i.turret));e.item?$(new sd(d,e.item)):(e.motion||e.projectile||e.homing||e.lifetime||e.explodes)&&$(new Kd(d,e)),e.field&&$(new Zd(d,e.field)),this.height=P-1}draw(d,e){for(let{x:L,y:P,object:$}of this.instructions)$.draw(d+L,e+P)}};var R0=I(R());function la(a,d,e){if(!e.length)return;let L=[];for(let B of e){let b=new qd(a,B);b.height&&L.push(b)}if(!L.length)return;let P=Math.max(...L.map(B=>B.width))+2,$=L.reduce((B,b)=>B+b.height,1+L.length),D=Math.min(d.x+2,a.term.width-P),i=Math.min(d.y,a.term.height-$);a.term.fillRect(D,i,P,$," ",R0.Colors.WHITE,R0.Colors.BLACK),a.term.drawDoubleBox(D,i,P,$);let H=i+1;for(let B of L)H>i+1&&(a.term.drawChar(D,H-1,h.BoxRightSingleVerticalDouble),a.term.drawHLine(D+1,H-1,P-1,h.BoxHorizontalSingle),a.term.drawChar(D+P-1,H-1,h.BoxLeftSingleVerticalDouble)),B.draw(D+1,H),H+=B.height+1}function D0(a,d){let e=d.x-a.x,L=d.y-a.y,P=Math.abs(e),$=Math.abs(L),D=e>0?1:-1,i=L>0?1:-1,H=N({},a),B=[N({},H)];for(let b=0,c=0;b<P||c<$;)(.5+b)/P<(.5+c)/$?(H.x+=D,b++):(H.y+=i,c++),B.push(N({},H));return B}var E=class{constructor(d,e){this.list=d;this.matches=Dd(e)}forEach(d){for(let e of this.list.get())this.matches(e)&&d(e,e)}};function I0(a){let d=new E(a.entities,["ai","position","ship"]);a.on("tick",function(){d.forEach(({ai:L,position:P},$)=>{if($.setLastMovement(),!L.attacking||!L.attacking.alive){let T=$0(a,$);if(T)L.attacking=T,a.fire("notice",{e:$,noticed:T});else return}let D=_(a,$),{layout:i}=z(a,$),H=s(P),B=a.getDistanceMap(L.attacking),b=T=>{let{oob:r,solid:Q,wall:Pd}=a.getContents(T,D);return!r&&!Q&&!Pd},c=T=>b(T)?Math.abs(B.getOrDefault(T,1/0)-L.idealDistance):1/0,J=T=>i.reduce((r,{offset:Q})=>r+c(l(T,Q)),0)/i.length,F=J(H),t=[];for(let T of A0){let r=l(H,T);if(!B.has(r))continue;let Q=J(r);Q<F?(F=Q,t=[r]):Q===F&&t.push(r)}if(t.length){let T=U(t);$.move(T.x,T.y),$.setLastMovement({angle:id(H,T)});return}})}),a.on("damage",function({e:L,source:P}){P.owner&&L!==P.owner&&L.ai&&!L.ai.attacking&&P.owner.alive&&(L.ai.attacking=P.owner)})}function Q0(a){let d=new E(a.entities,["delayedShot","ship"]);a.on("tick",function(){d.forEach(({ai:L,delayedShot:P},$)=>{var D,i;if(!$.alive){$.setDelayedShot();return}for(let H=P.shots.length-1;H>=0;H--){let{turret:B,shot:b}=P.shots[H];if(--b.delay<=0){b.delay=0,P.shots.splice(H,1);let c=n(a,$),J=c.find(T=>T.turret===B),F=(D=J==null?void 0:J.position)!=null?D:K(a,$),t=(i=L==null?void 0:L.attacking)!=null&&i.alive?K(a,L.attacking):p(0,0);J0(a,b,B,F,t,$,c.map(T=>T.id))}}P.shots.length||$.setDelayedShot()})})}function M0(a){let d=new E(a.entities,["appearance","position"]);a.on("draw",function(){d.forEach(({appearance:L,position:P})=>a.drawIfVisible(O(P.x),O(P.y),L.glyph,L.fg,L.bg,L.blendMode))})}function E0(a){a.on("kill",function({e,reason:L}){var D;let{position:P,ship:$}=e;if(P&&($!=null&&$.power)&&L.type==="damage"){let i=C0[$.power],H=((D=L.source.e.projectile)==null?void 0:D.special)==="increasedDropChance",B=$.type==="Battleship"?H?92:42:H?32:2,b=(t=1)=>fd(B*t),c=[];i&x.Double&&b()&&c.push("DoubleItem"),i&x.Drain&&b()&&c.push("DrainItem"),i&x.Healthy&&b()&&c.push("HealItem"),b()&&c.push("MoneyItem"),b()&&c.push("JunkItem"),b()&&c.push("RechargeItem");let J;if(b()){let t=n(a,e).filter(T=>T.tags.has("Special")&&T.prefab&&T.turret);t.length&&(J=U(t).prefab,c.push("BombItem"))}let F=Jd([p(-1,-1),p(0,-1),p(1,-1),p(-1,0),p(0,0),p(1,0),p(-1,1),p(0,1),p(1,1)]);for(let t of c){let T=F.pop();if(!T)return;let r=l(P,T),Q=a.spawn(t).move(r.x,r.y).setMotion({angle:V.Down,vel:1});t==="BombItem"&&J&&Q.setItem({type:"bomb",prefab:J})}}})}function Qd(a,d,e){return a*(1-e)+d*e}var i0=I(R()),ed=class{constructor(d){this.points=d;this.sort()}sort(){this.points.sort(([d],[e])=>d-e)}add(d,e){return this.points.push([d,e]),this.sort(),this}get(d){let[e,L]=this.points[0];if(d<=e)return(0,i0.fromRgb)(...L);let[P,$]=this.points[this.points.length-1];if(d>=P)return(0,i0.fromRgb)(...$);let D=this.points.findIndex(([Pd])=>Pd>d),[i,[H,B,b,c]]=this.points[D-1],[J,[F,t,T,r]]=this.points[D],Q=(d-i)/(J-i);return(0,i0.fromRgb)(Qd(H,F,Q),Qd(B,t,Q),Qd(b,T,Q),Qd(c,r,Q))}};var xa=(i=>(i[i.Effect=0]="Effect",i[i.Item=1]="Item",i[i.Ship=2]="Ship",i[i.Gun=3]="Gun",i[i.Bullet=4]="Bullet",i[i.Player=5]="Player",i[i.PlayerBullet=6]="PlayerBullet",i))(xa||{}),C=xa;var Ka=I(R()),pe={Fire:new ed([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Blue:new ed([[0,[0,0,0,0]],[2,[0,0,255,150]],[4,[0,155,255,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Yellow:new ed([[0,[0,0,0,0]],[2,[155,155,0,150]],[4,[255,255,55,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Green:new ed([[0,[0,0,0,0]],[2,[0,215,0,150]],[4,[55,255,55,150]],[6,[215,255,215,150]],[10,[255,255,255,255]]]),Magenta:new ed([[0,[0,0,0,0]],[2,[155,0,115,150]],[4,[255,115,255,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function S0(a){if(!(a.intensity<=0))return{glyph:" ",layer:C.Effect,bg:pe[a.type].get(a.intensity),blendMode:Ka.BlendMode.Add}}function Za(a,d){let e=[],L=Math.floor(a.x-d),P=Math.ceil(a.x+d),$=Math.floor(a.y-d),D=Math.ceil(a.y+d);for(let i=$;i<=D;i++)for(let H=L;H<=P;H++){let B=Td(a,{x:H,y:i});B>=d||e.push({x:H,y:i,intensity:d-B})}return e}var Te=!1;function n0(a){a.on("kill",function({e,reason:L}){var i;if(L.type==="exitedMap")return;let{explodes:P,name:$,position:D}=e;if(P&&D)for(let{x:H,y:B,intensity:b}of Za(K(a,e),P.size)){let c=!1;if(Te){let{other:J}=a.getContents({x:H,y:B});for(let F of J)if(((i=F.field)==null?void 0:i.type)===P.type){F.field.intensity+=b,F.field.falloff=Math.max(F.field.falloff,P.falloff),c=!0;break}}c||a.add(new Ad(a,$+"Explosion").setPosition({x:H,y:B}).setField({type:P.type,intensity:b,falloff:P.falloff}))}})}function kd(a,d,e,L){var i;let P=a.getRoot(d);if(!P.ship)return;P.ship.type!=="Player"&&((i=L.origin)==null?void 0:i.ship.type)!=="Player"&&(e=Math.ceil(e/2));let $=e;P.ship.shield>0&&(P.ship.shield>e?(P.ship.shield-=e,$=0):($-=P.ship.shield,P.ship.shield=0)),$&&(P.ship.hp-=$);let D={e:L,owner:L};L.origin&&(D.owner=L.origin.owner,D.ship=L.origin.ship,D.turret=L.origin.turret),console.log(`${L.name}${L.origin?` (${L.origin.owner.name} #${L.origin.owner.id})`:""} hits ${P.name} for ${e}`),a.fire("damage",{e:P,amount:e,source:D}),P.ship.hp<=0&&a.kill(P,{type:"damage",source:D})}function U0(a){let d=new E(a.entities,["ship"]),e=new E(a.entities,["field","position"]);a.on("tick",function(){e.forEach(({field:P,position:$},D)=>{P.intensity-=P.falloff,D.setAppearance(S0(P)),P.intensity<1?a.kill(D,{type:"expired"}):d.forEach((i,H)=>{let{layout:B}=z(a,H);B.find(({absolute:c})=>w(c,$))&&kd(a,H,Math.floor(P.intensity),D)})})}),a.on("spawn",function({e:P}){P.field&&P.setAppearance(S0(P.field))})}function Y0(a){let d=new E(a.entities,["homing","motion","position"]);a.on("tick",function(){d.forEach(({homing:L,motion:P,position:$},D)=>{var b;if(!((b=L.target)!=null&&b.alive))return;let i=K(a,L.target),H=id($,i),B=Qa(P.angle,H);Math.abs(B)<=L.strength?P.angle=H:B<0?P.angle-=L.strength:P.angle+=L.strength,--L.duration<=0&&(D.setHoming(),D.setTrail())})})}var j0={};$d(j0,{AcidBullet:()=>Je,BellowMissile:()=>Ue,Bullet:()=>te,CrushBullet:()=>Ie,DroneBullet:()=>Fe,HomingMissile:()=>Me,OutcryBullet:()=>re,PlayerBullet:()=>Ye,SalvoMissileA:()=>Ee,SalvoMissileB:()=>Se,SalvoMissileC:()=>ne,SmiteMissile:()=>Qe,TalonBullet:()=>Re});var A=(a,d,e,L,P)=>({name:a,x:d,y:e,overlay:L,tags:P}),j=(a,d,e,L=0)=>({name:a,type:d,maxHp:e,hp:0,maxShield:L,shield:0,shieldTimer:0,firingDirection:d==="Player"?V.Up:V.Down}),M=(a,{salvoCount:d=1,timeBetweenShots:e=1,timeBetweenSalvos:L=1,ammunition:P=1/0},$)=>({name:a,shots:$,salvoCount:d,timeBetweenShots:e,timeBetweenSalvos:L,timer:0,salvo:d,ammunition:P}),Ce=["F","FR","R","BR","B","BL","L","FL"],X=a=>({type:"relative",rel:Ce.indexOf(a)*Math.PI/4}),sa={type:"nearestEnemy"},Va={type:"random"},Z=(a,d,e=1)=>({type:"pilot",stat:d,base:a,multiplier:e}),f=(a,d,e,L,{canDouble:P,delay:$,offset:D,beam:i}={})=>({type:"bullet",canDouble:P,name:a,prefab:d,angle:e,vel:L,delay:$,offset:D,beam:i}),y=(a,{delay:d,offset:e}={})=>({type:"array",canDouble:!1,tag:a,delay:d,offset:e});var k=I(R()),te={components:{projectile:{damage:1,scaling:Z(1,"body")},appearance:{glyph:h.InvertedExclamation,layer:C.Bullet,fg:k.Colors.YELLOW}}},Fe={components:{projectile:{damage:1,scaling:Z(1,"body")},appearance:{glyph:".",layer:C.Bullet,fg:k.Colors.ORANGE}}},re={components:{projectile:{damage:6,scaling:Z(6,"mind")},appearance:{glyph:"o",layer:C.Bullet,fg:(0,k.fromRgb)(255,55,135)}}},Je={components:{projectile:{damage:6,scaling:Z(6,"mind")},appearance:{glyph:h.Approximates,layer:C.Bullet,fg:(0,k.fromRgb)(55,55,215)}}},Re={components:{projectile:{damage:6,scaling:Z(6,"mind")},appearance:{glyph:"`",layer:C.Bullet,fg:(0,k.fromRgb)(135,255,55)}}},Ie={components:{projectile:{damage:6,scaling:Z(6,"mind")},homing:{strength:1,duration:3},appearance:{glyph:h.Square,layer:C.Bullet,fg:(0,k.fromRgb)(175,175,0)}}},Qe={components:{projectile:{damage:2,scaling:Z(2,"mind")},homing:{strength:10,duration:1},explodes:{size:7,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:k.Colors.ORANGE}}},Me={components:{projectile:{damage:1,scaling:Z(1,"mind")},homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:k.Colors.DARK_RED}}},Ee={components:{projectile:{damage:1,scaling:Z(1,"mind")},homing:{strength:.15,duration:4},trail:{effectPrefab:"SmokePuff"},explodes:{size:8,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:k.Colors.DARK_RED}}},Se={components:{projectile:{damage:1,scaling:Z(1,"mind")},homing:{strength:.25,duration:5},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:k.Colors.DARK_RED}}},ne={components:{projectile:{damage:1,scaling:Z(1,"mind")},homing:{strength:.35,duration:8},trail:{effectPrefab:"SmokePuff"},explodes:{size:4,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:k.Colors.DARK_RED}}},Ue={components:{projectile:{damage:20,scaling:Z(20,"mind")},homing:{strength:.15,duration:30},trail:{effectPrefab:"SmokePuff"},explodes:{size:6,type:"Fire",falloff:1},appearance:{glyph:h.CurlyF,layer:C.Bullet,fg:k.Colors.LIGHT_RED}}},Ye={components:{projectile:{damage:3,scaling:Z(3,"body")},appearance:{glyph:"!",layer:C.PlayerBullet,fg:k.Colors.YELLOW}}};var l0={};$d(l0,{AirFistRange:()=>je,SmokePuff:()=>le});var Md=I(R()),je={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:C.Effect,bg:(0,Md.fromRgb)(0,255,255,100),blendMode:Md.BlendMode.Add}}},le={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:C.Effect,bg:(0,Md.fromRgb)(100,100,100,50),blendMode:Md.BlendMode.Add}}};var x0={};$d(x0,{AcidSplash:()=>Ne,Bellow:()=>Oe,Cleave:()=>se,CrushPattern:()=>me,DemandHomage:()=>ze,DroneGun:()=>ye,Outcry:()=>Ve,PeaShooter:()=>Ke,PlayerGun:()=>Ze,Salvo:()=>Ge,ShuttleLaunch:()=>qe,Smite:()=>oe,TalonSwipe:()=>ge,TheDragonWakes:()=>ue,Veto:()=>ke});var xe={Right:p(1,0),DownRight:p(1,1),Down:p(0,1),DownLeft:p(-1,1),Left:p(-1,0),UpLeft:p(-1,-1),Up:p(0,-1),UpRight:p(1,-1),None:p(0,0)},g=xe;var Ke={components:{turret:M("Main Gun",{salvoCount:1,timeBetweenSalvos:3},[f("Bullet","Bullet",X("F"),2,{canDouble:!0})])}},Ze={components:{turret:M("Main Gun",{salvoCount:2,timeBetweenShots:0,timeBetweenSalvos:3},[f("Your Bullet","PlayerBullet",X("F"),2,{canDouble:!0})])}},se={components:{turret:M("Cleave",{salvoCount:1,timeBetweenSalvos:11},[y("Primary"),y("Primary",{delay:1}),y("Primary",{delay:2}),y("Primary",{delay:3}),y("Primary",{delay:4})])}},Ve={components:{turret:M("Outcry",{salvoCount:1,timeBetweenSalvos:8},[f("Outcry","OutcryBullet",X("FR"),2),f("Outcry","OutcryBullet",X("R"),2),f("Outcry","OutcryBullet",X("BR"),2),f("Outcry","OutcryBullet",X("B"),2),f("Outcry","OutcryBullet",X("BL"),2),f("Outcry","OutcryBullet",X("L"),2),f("Outcry","OutcryBullet",X("FL"),2)])}},Ne={components:{turret:M("Acid Splash",{salvoCount:1,timeBetweenSalvos:13},[f("Acid Splash","AcidBullet",X("BR"),2),f("Acid Splash","AcidBullet",X("BL"),2),f("Acid Splash","AcidBullet",X("R"),2,{delay:1}),f("Acid Splash","AcidBullet",X("L"),2,{delay:1}),f("Acid Splash","AcidBullet",X("FR"),2,{delay:2}),f("Acid Splash","AcidBullet",X("FL"),2,{delay:2}),f("Acid Splash","AcidBullet",X("R"),2,{delay:3}),f("Acid Splash","AcidBullet",X("L"),2,{delay:3}),f("Acid Splash","AcidBullet",X("BR"),2,{delay:4}),f("Acid Splash","AcidBullet",X("BL"),2,{delay:4})])}},qe={components:{turret:M("Shuttle Launch",{salvoCount:1,timeBetweenSalvos:27},[f("Runabout","DroneA",X("R"),0,{offset:g.Left}),f("Runabout","DroneA",X("L"),0,{offset:g.Right})])}},ke={components:{turret:M("Veto",{salvoCount:1,timeBetweenSalvos:21},[f("Veto","HomingMissile",X("B"),1),f("Wasp","DroneB",X("FL"),0,{offset:g.DownRight})])}},ge={components:{turret:M("Talon Swipe",{salvoCount:1,timeBetweenSalvos:10},[f("Talon Swipe","TalonBullet",X("R"),2),f("Talon Swipe","TalonBullet",X("L"),2),f("Talon Swipe","TalonBullet",X("R"),2,{delay:1}),f("Talon Swipe","TalonBullet",X("L"),2,{delay:1}),f("Talon Swipe","TalonBullet",X("R"),2,{delay:2}),f("Talon Swipe","TalonBullet",X("L"),2,{delay:2})])}},me={components:{turret:M("Crush Pattern",{salvoCount:1,timeBetweenSalvos:15},[f("Crush Pattern","CrushBullet",X("R"),1),f("Crush Pattern","CrushBullet",X("BR"),1),f("Crush Pattern","CrushBullet",X("BL"),1),f("Crush Pattern","CrushBullet",X("L"),1)])}},oe={components:{turret:M("Smite",{salvoCount:1,timeBetweenSalvos:16},[f("Smite","SmiteMissile",X("L"),1),f("Smite","SmiteMissile",X("L"),1,{delay:1})])}},ye={components:{turret:M("Stinger",{salvoCount:1,timeBetweenSalvos:5,ammunition:5},[f("Bullet","DroneBullet",sa,1,{canDouble:!0})])}},Ge={components:{turret:M("Salvo",{salvoCount:1,timeBetweenSalvos:10},[f("Missile","SalvoMissileA",X("BR"),1),f("Missile","SalvoMissileB",X("BR"),1),f("Missile","SalvoMissileC",X("BR"),1)])}},ue={components:{turret:M("The Dragon Wakes",{salvoCount:1,timeBetweenSalvos:12},[f("Drone","DroneA",X("B"),0,{offset:g.Up}),f("Missile","HomingMissile",X("FR"),2,{offset:g.DownLeft}),f("Missile","HomingMissile",X("FL"),2,{offset:g.DownRight})])}},Oe={components:{turret:M("Bellow",{salvoCount:1,timeBetweenSalvos:17},[f("Bellow","BellowMissile",X("FR"),1),y("Primary"),y("Primary",{delay:1}),y("Primary",{delay:2}),y("Primary",{delay:3})])}},ze={components:{turret:M("Demand Homage",{salvoCount:1,timeBetweenSalvos:21},[f("Pulsar","DroneC",X("FR"),0,{offset:g.DownLeft}),f("Pulsar","DroneC",X("BR"),0,{offset:g.UpLeft}),f("Pulsar","DroneC",X("BL"),0,{offset:g.UpRight}),f("Pulsar","DroneC",X("FL"),0,{offset:g.DownRight})])}};var K0={};$d(K0,{BombItem:()=>ve,DoubleItem:()=>We,DrainItem:()=>we,HealItem:()=>_e,JunkItem:()=>dL,MoneyItem:()=>aL,RechargeItem:()=>eL});var ve={components:{appearance:{glyph:h.DoubleNote,layer:C.Item},item:{type:"bomb",prefab:"BombItem"}}},We={components:{appearance:{glyph:h.Squared,layer:C.Item},item:{type:"double"}}},we={components:{appearance:{glyph:"%",layer:C.Item},item:{type:"drain"}}},_e={components:{appearance:{glyph:h.Heart,layer:C.Item},item:{type:"heal"}}},dL={components:{appearance:{glyph:h.Beta,layer:C.Item},item:{type:"junk"}}},aL={components:{appearance:{glyph:h.SetMember,layer:C.Item},item:{type:"money",value:0}}},eL={components:{appearance:{glyph:"@",layer:C.Item},item:{type:"recharge"}}};var s0={};$d(s0,{PlayerHull:()=>LL,PlayerShip:()=>PL});var Z0=I(R()),LL={components:{solid:!0,appearance:{glyph:"#",layer:C.Player,fg:Z0.Colors.DARK_GRAY}}},PL={components:{player:{weaponArrays:["Primary","Secondary"],bombs:[]},ship:j("Ace of Clubs","Player",20,10),explodes:{type:"Fire",size:6,falloff:1}},children:[A("PlayerHull",0,0,{appearance:{glyph:h.LeftArrow}}),A("PlayerHull",1,0,{appearance:{glyph:h.Club,fg:Z0.Colors.LIGHT_GRAY}}),A("PlayerHull",2,0,{appearance:{glyph:h.RightArrow}}),A("PlayerGun",1,0,void 0,["Primary"]),A("Sword",1,0,void 0,["Secondary"])]};var q0={};$d(q0,{AtomSmasher:()=>JL,CruiseyWing:()=>TL,Demigod:()=>FL,DroneA:()=>XL,DroneB:()=>cL,DroneC:()=>pL,GoutOFlame:()=>tL,Gremlin:()=>rL,Hull:()=>$L,Olm:()=>CL,ShipA:()=>DL,ShipB:()=>iL,ShipC:()=>HL,ShipD:()=>BL,ShipE:()=>bL,ShipF:()=>hL,ShipG:()=>AL,ShipH:()=>fL});var Na=I(R()),$L={components:{solid:!0,appearance:{glyph:"#",layer:C.Ship,fg:Na.Colors.DARK_GRAY}}},m={idealDistance:8,firingDistance:14,speed:1},Ld=A("PeaShooter",0,0,void 0,["Primary"]),Bd={type:"Fire",size:4,falloff:1},DL={components:{ai:m,ship:j("Axle","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:h.Pilcrow}}),Ld,A("Cleave",0,0,void 0,["Special"])]},iL={components:{ai:m,ship:j("Baying Hound","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:h.Yen}}),Ld,A("Outcry",0,0,void 0,["Special"])]},HL={components:{ai:m,ship:j("Caustic","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:"W"}}),Ld,A("AcidSplash",0,0,void 0,["Special"])]},BL={components:{ai:m,ship:j("Defiant","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:h.Omega}}),Ld,A("ShuttleLaunch",0,0,void 0,["Special"])]},bL={components:{ai:m,ship:j("Executor","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:h.DownWedge}}),Ld,A("Veto",0,0,void 0,["Special"])]},hL={components:{ai:m,ship:j("Falcon","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:h.Pi}}),Ld,A("TalonSwipe",0,0,void 0,["Special"])]},AL={components:{ai:m,ship:j("Gauntlet","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:"M"}}),Ld,A("CrushPattern",0,0,void 0,["Special"])]},fL={components:{ai:m,ship:j("Halo","Escort",2),explodes:Bd},children:[A("Hull",0,0,{appearance:{glyph:h.Female}}),Ld,A("Smite",0,0,void 0,["Special"])]},V0={idealDistance:5,firingDistance:6,speed:1},qa=A("DroneGun",0,0,void 0,["Primary"]),N0={type:"Fire",size:3,falloff:1},XL={components:{ai:V0,ship:j("Runabout","Escort",1),explodes:N0},children:[A("Hull",0,0,{appearance:{glyph:h.Theta}}),Ld]},cL={components:{ai:V0,ship:j("Wasp","Escort",1),explodes:N0},children:[A("Hull",0,0,{appearance:{glyph:h.SymbolED}}),qa]},pL={components:{ai:V0,ship:j("Pulsar","Escort",1),explodes:N0},children:[A("Hull",0,0,{appearance:{glyph:h.Silcrow}}),qa]},Ed={type:"Fire",size:6,falloff:1},TL={components:{ai:m,ship:j("Cruisey Wing","Battleship",10,5),explodes:Ed},children:[A("Hull",0,0,{appearance:{glyph:h.Not}}),A("Hull",1,0,{appearance:{glyph:h.HorizontalDivide}}),A("Hull",2,0,{appearance:{glyph:h.NotFlip}}),A("PeaShooter",0,0,void 0,["Primary"]),A("PeaShooter",1,0,void 0,["Primary"]),A("PeaShooter",2,0,void 0,["Primary"]),A("Salvo",1,0,void 0,["Special"])]},CL={components:{ai:m,ship:j("Olm","Battleship",15,4),explodes:Ed},children:[A("Hull",0,0,{appearance:{glyph:h.Cent}}),A("Hull",0,1,{appearance:{glyph:h.ResizeVertical}}),A("Hull",0,2,{appearance:{glyph:h.BoxDownSingleHorizontalDouble}}),A("PeaShooter",0,2,void 0,["Primary"]),A("TheDragonWakes",0,0,void 0,["Special"])]},tL={components:{ai:m,ship:j("Gout-o'-flame","Battleship",5,20),explodes:Ed},children:[A("Hull",0,0,{appearance:{glyph:h.Pentagon}}),A("Hull",1,0,{appearance:{glyph:h.BoxVerticalDoubleHorizontalSingle}}),A("Hull",2,0,{appearance:{glyph:h.Pentagon}}),A("Hull",1,1,{appearance:{glyph:h.BoxUpDoubleHorizontalSingle}}),A("PeaShooter",1,1,void 0,["Primary"]),A("Bellow",1,1,void 0,["Special"])]},FL={components:{ai:m,ship:j("Demigod","Battleship",30,15),explodes:Ed},children:[A("Hull",1,0,{appearance:{glyph:h.CapitalUUmlaut}}),A("Hull",0,1,{appearance:{glyph:"}"}}),A("Hull",1,1,{appearance:{glyph:h.RingInvert}}),A("Hull",2,1,{appearance:{glyph:"{"}}),A("Hull",1,2,{appearance:{glyph:"Y"}}),A("PeaShooter",1,2,void 0,["Primary"]),A("DemandHomage",1,1,void 0,["Special"])]},rL={components:{ai:m,ship:j("Gremlin","Battleship",30,15),explodes:Ed},children:[A("Hull",1,0,{appearance:{glyph:h.ResizeVertical}}),A("Hull",2,0,{appearance:{glyph:h.ResizeVertical}}),A("Hull",0,1,{appearance:{glyph:"]"}}),A("Hull",1,1,{appearance:{glyph:h.BoxLeftSingleUpDouble}}),A("Hull",2,1,{appearance:{glyph:h.BoxRightSingleUpDouble}}),A("Hull",3,1,{appearance:{glyph:h.Male}}),A("Hull",1,2,{appearance:{glyph:h.BoxVerticalSingle}}),A("Hull",2,2,{appearance:{glyph:h.Gamma}}),A("PeaShooter",1,2,void 0,["Primary"]),A("PeaShooter",2,2,void 0,["Primary"])]},JL={components:{ai:m,ship:j("Atom Smasher","Battleship",10,20),explodes:Ed},children:[A("Hull",1,0,{appearance:{glyph:h.EHat}}),A("Hull",2,0,{appearance:{glyph:"-"}}),A("Hull",3,0,{appearance:{glyph:h.AHat}}),A("Hull",0,1,{appearance:{glyph:h.Fill2}}),A("Hull",1,1,{appearance:{glyph:h.Fill1}}),A("Hull",2,1,{appearance:{glyph:h.Fill2}}),A("Hull",3,1,{appearance:{glyph:h.Fill3}}),A("Hull",4,1,{appearance:{glyph:h.Filled}}),A("PeaShooter",0,1,void 0,["Primary"]),A("PeaShooter",1,1,void 0,["Primary"]),A("PeaShooter",2,1,void 0,["Primary"]),A("PeaShooter",3,1,void 0,["Primary"]),A("PeaShooter",4,1,void 0,["Primary"])]};var k0={};$d(k0,{Laser:()=>ML,LaserBeam:()=>EL,Multiball:()=>IL,MultiballShot:()=>RL,Overload:()=>lL,OverloadBullet:()=>jL,StubbornDescent:()=>QL,SwitchbladeBullet:()=>SL,Switchblades:()=>nL,Triangulate:()=>YL,TriangulateMissile:()=>UL});var bd=I(R()),RL={components:{projectile:{damage:7},appearance:{glyph:"+",layer:C.Bullet,fg:(0,bd.fromRgb)(255,255,55)}}},IL={components:{turret:M("Multiball",{salvoCount:1,timeBetweenSalvos:15},[f("Multiball","MultiballShot",X("FR"),2),f("Multiball","MultiballShot",X("R"),2),f("Multiball","MultiballShot",X("L"),2),f("Multiball","MultiballShot",X("FL"),2),f("Runabout","DroneA",X("BR"),0,{offset:g.UpLeft}),f("Runabout","DroneA",X("BL"),0,{offset:g.UpRight})])}},QL={components:{turret:M("Stubborn Descent",{salvoCount:13,timeBetweenSalvos:21},[y("Primary")])}},ML={components:{projectile:{damage:2},appearance:{glyph:"|",layer:C.Bullet,fg:bd.Colors.WHITE,bg:bd.Colors.LIGHT_BLUE}}},EL={components:{turret:M("Laser Beam",{salvoCount:10,timeBetweenSalvos:30},[f("Laser","Laser",X("F"),1,{offset:g.Down,beam:{duration:1,length:60,appearance:[]}})])}},SL={components:{projectile:{damage:9},appearance:{glyph:h.ResizeHorizontal,layer:C.Bullet,fg:bd.Colors.LIGHT_BLUE}}},nL={components:{turret:M("Switchblades",{salvoCount:1,timeBetweenSalvos:11},[...ad(9).map(a=>f("Switchblade","SwitchbladeBullet",X("FR"),1,{delay:a})),...ad(9).map(a=>f("Switchblade","SwitchbladeBullet",X("FL"),1,{delay:a}))])}},UL={components:{projectile:{damage:10},homing:{strength:.1,duration:1/0},explodes:{type:"Blue",size:4,falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:bd.Colors.DARK_CYAN}}},YL={components:{turret:M("Triangulate",{salvoCount:1,timeBetweenSalvos:17},[f("Triangulate","TriangulateMissile",X("FR"),1),f("Triangulate","TriangulateMissile",X("R"),1,{delay:1}),f("Triangulate","TriangulateMissile",X("BR"),1,{delay:2}),f("Triangulate","TriangulateMissile",X("B"),1,{delay:3}),f("Triangulate","TriangulateMissile",X("BL"),1,{delay:4}),f("Triangulate","TriangulateMissile",X("L"),1,{delay:5}),f("Triangulate","TriangulateMissile",X("FL"),1,{delay:6})])}},jL={components:{projectile:{damage:7},appearance:{glyph:h.Smiley,layer:C.Bullet,fg:bd.Colors.LIGHT_GRAY}}},lL={components:{turret:M("Overload",{salvoCount:1,timeBetweenSalvos:20},ad(11).map(a=>f("Overload","OverloadBullet",Va,2,{delay:a})))}};var g0={};$d(g0,{Sword:()=>KL,SwordBullet:()=>xL});var Fd=I(R()),xL={components:{projectile:{damage:5,scaling:Z(5,"spirit"),special:"increasedDropChance"},appearance:{glyph:h.Star,layer:C.PlayerBullet,fg:Fd.Colors.LIGHT_GREEN}}},KL={components:{turret:M("Sword",{salvoCount:1,timeBetweenSalvos:20},[f("Stab","SwordBullet",{type:"lastMovement"},1,{beam:{duration:2,length:Z(4,"spirit"),appearance:[{glyph:h.Star,fg:Fd.Colors.LIGHT_GREEN},{glyph:"o",fg:Fd.Colors.LIGHT_GREEN},{glyph:h.Diamond,fg:Fd.Colors.LIGHT_GREEN},{glyph:h.Ring,fg:Fd.Colors.DARK_GREEN},{glyph:h.Dot,fg:Fd.Colors.DARK_GRAY}]}})])}};var ka=N(N(N(N(N(N(N(N({},j0),l0),K0),x0),s0),q0),k0),g0);function H0(a){return ka[a]}function m0(a,d){return a.add(new Ad(a,d).applyPrefab(d,ka[d]))}var ga=["Cleave","Outcry","AcidSplash","ShuttleLaunch","Veto","TalonSwipe","CrushPattern","Smite","Salvo","TheDragonWakes","Bellow","DemandHomage","Multiball","StubbornDescent","Switchblades","Triangulate","Overload"];var ma=I(R()),gd=class{constructor(d,e){this.g=d;this.player=e;this.lines=e.bombs.map(L=>{var P,$,D;return(D=($=(P=H0(L).components)==null?void 0:P.turret)==null?void 0:$.name)!=null?D:"?"}),this.width=this.lines.reduce((L,P)=>Math.max(L,P.length),0),this.height=this.lines.length}draw(d,e){for(let L of this.lines)this.g.term.drawString(d,e++,L,ma.Colors.WHITE)}};var W=I(R()),hd=6;function o0(a){let{mapHeight:d,term:e}=a;a.on("draw",function(){let P=a.player,{pilot:$,player:D,ship:i}=P;e.fillRect(0,d,e.width,hd," ",W.Colors.WHITE,W.Colors.BLACK),e.drawSingleBox(0,d,e.width,hd);let H=1,B=d+1,b=new cd(a,i);b.draw(H,B);let c=H+Math.floor((b.width-11)/2);new Xd(a,$,!1).draw(c,B+3),H+=b.width+1,e.drawChar(H-1,B-1,h.BoxDownSingleHorizontalSingle,W.Colors.WHITE),e.drawVLine(H-1,B,hd-2,h.BoxVerticalSingle,W.Colors.WHITE),e.drawChar(H-1,B+hd-2,h.BoxUpSingleHorizontalSingle,W.Colors.WHITE);for(let F of D.weaponArrays){let t=H,T=n(a,P).filter(r=>r.tags.has(F)).filter(Dd(["turret"]));for(let r of T){let Q=new td(a,r.turret);Q.draw(H,B+1),H+=Q.width+1}e.drawString(t,B,F,W.Colors.LIGHT_CYAN),H=Math.max(H,t+F.length+1)}D.bombs.length&&(e.drawChar(H-1,B-1,h.BoxDownSingleHorizontalSingle,W.Colors.WHITE),e.drawVLine(H-1,B,hd-2,h.BoxVerticalSingle,W.Colors.WHITE),e.drawChar(H-1,B+hd-2,h.BoxUpSingleHorizontalSingle,W.Colors.WHITE),new gd(a,D).draw(H,B))})}function y0(a){let d=new E(a.entities,["lifetime"]);a.on("tick",function(){d.forEach(({lifetime:L},P)=>{if(--L.duration<=0)a.kill(P,{type:"expired"});else if(L.decayingAppearance&&P.appearance){let $=L.decayingAppearance[L.duration-1];Object.assign(P.appearance,$)}})})}function G0(a,d,e){if(!(!d.ship||!d.player))switch(e.type){case"double":d.doubleShot?d.doubleShot.duration+=9:d.setDoubleShot({duration:9});return;case"heal":{let L=Math.ceil(d.ship.maxHp/4);d.ship.hp=Math.min(d.ship.maxHp,d.ship.hp+L);return}case"recharge":{for(let L of n(a,d))if(L.turret)for(;L.turret.timer<1/0&&L.turret.timer>0;)L0(L.turret);return}case"bomb":for(d.player.bombs.push(e.prefab);d.player.bombs.length>Ta(d);)d.player.bombs.shift();break;case"junk":if(fd(Ca(d)))return G0(a,d,{type:"bomb",prefab:U(ga)});break}}function u0(a){let d=new E(a.entities,["motion","position"]);a.on("tick",function(){d.forEach(({motion:L,position:P,projectile:$,ignoreSolid:D,item:i},H)=>{let[B,b]=Hd(L),c=p(P.x+B,P.y+b),J=D0(s(P),s(c)),F=!1,t;for(let T of J){if(!a.inBounds(T)){a.kill(H,{type:"exitedMap"});return}a.move(H,T);let{wall:r,solid:Q}=a.getContents(T,D==null?void 0:D.ids);if(r){F=!0;break}else if(Q){t=Q;break}}F?a.kill(H,{type:"hitWall"}):t?($&&kd(a,t,$.damage,H),i&&G0(a,a.getRoot(t),i),a.kill(H,{type:"hitEntity",other:t})):a.move(H,c)})})}function O0(a){a.on("playerMove",function({move:e}){let L=a.player,P=L.position,$=l(P,e);fa(a,L,$).length||(L.move($.x,$.y),L.setLastMovement({angle:id(P,$)}),a.tick())}),a.on("playerFire",function({array:e}){let L=a.player,P=L.player.weaponArrays[e],$=n(a,L),D=$.filter(H=>H.tags.has(P)),i=!1;for(let H of D)!H.position||!H.turret||P0(H.turret)&&(Id(a,H.turret,H.position,p(0,0),L,$.map(B=>B.id)),i=!0);i&&(L.setLastMovement(),a.tick())}),a.on("playerBomb",function(){var $;let e=a.player,L=e.player.bombs.shift();if(!L)return;let P=H0(L);if(($=P.components)!=null&&$.turret){let D=u(P.components.turret),i=K(a,e),H=$0(a,e),B=H?K(a,H):p(0,0),b=Id(a,D,i,B,e,_(a,e));for(let c of b)jd(c,["ai","ship"])&&(c.ai.attacking=H,c.ship.firingDirection=V.Up),c.homing&&(c.homing.target=H);e.setLastMovement(),a.tick()}})}function md(a){return typeof a!="undefined"}var oa=I(R());function z0(a){let d=new E(a.entities,["ship"]);a.on("tick",function(){d.forEach((L,P)=>{P.doubleShot&&--P.doubleShot.duration<=0&&P.setDoubleShot()})}),a.on("draw",function(){let L=n(a,a.player).map(P=>P.position).filter(md);if(a.player.doubleShot)for(let P of L)a.blend(P.x,P.y,oa.Colors.LIGHT_GRAY)})}function v0(a){let d=new E(a.entities,["ship"]);a.on("tick",function(){d.forEach(({ship:L},P)=>{if(L.shield>=L.maxShield){L.shieldTimer=0;return}let $=pa(P);++L.shieldTimer>=$&&(L.shield++,L.shieldTimer=0)})})}function W0(a){a.on("waveBegin",function({wave:L,difficulty:P,pilot:$}){let D=(P+L.difficulty)*3,i=[];for(let b of L.groups)for(let c=0;c<b.count;c++)i.push(U(b.prefabs));let H=L.groups.filter(b=>b.type==="Escort");for(let b=0;b<P;b++){let c=U(H);i.push(U(c.prefabs))}let B=Math.floor(Math.random()*i.length);for(let b=0;b<i.length;b++){let c=b===B&&$!==void 0,J=i[b],F=Ja(D,c),t=Ra(a,J,F,c?$:void 0),T=Ia(a,t);t.move(T.x,T.y)}});let d=1/0;a.on("kill",({e})=>{if(!e.ship)return;a.entities.get().filter(P=>P.alive&&P.ship&&P.ship.type!=="Player").length||(d=5)}),a.on("tick",()=>{--d<=0&&(d=1/0,a.fire("waveNext",void 0))})}function w0(a){a.on("move",function({e,old:L,pos:P}){e.trail&&!w(L,P)&&a.spawn(e.trail.effectPrefab).setPosition(L)})}function _0(a){let d=new E(a.entities,["position","turret"]);a.on("tick",function(){d.forEach(({position:L,turret:P},$)=>{var B;L0(P);let D=a.getRoot($);if(!jd(D,["ai","ship"]))return;let i=D.ai.attacking;if(!(i!=null&&i.alive))return;let H=K(a,i);if(!(Td(L,H)>((B=D.ai.firingDistance)!=null?B:1/0))&&P0(P))for(let b of Id(a,P,L,H,D,_(a,D)))b.homing&&(b.homing.target=i),b.ai&&(b.ai.attacking=i)})})}function ya(a){y0(a),Y0(a),Q0(a),_0(a),U0(a),v0(a),u0(a),I0(a),W0(a),M0(a),o0(a),w0(a),n0(a),E0(a),z0(a),O0(a)}var Y=I(R()),od=class{constructor(d,e){this.g=d;this.campaign=e;this.dirty=!0,this.examining=[]}refresh(){this.dirty=!0}init(){let{g:d}=this;this.examineAt=void 0,this.examining=[],this.waves=ra(),d.blankMap(),d.entities.clearExceptFor(_(d,d.player));let{width:e,height:L}=z(d,d.player);d.player.move(O(d.mapWidth/2-e/2),d.mapHeight-L-4),d.player.ship.shield=d.player.ship.maxShield,ya(d),this.nextWave(),d.on("waveNext",this.nextWave.bind(this))}nextWave(){let d=this.waves.shift();if(d){let e=this.waves.length===0?this.campaign.currentSector.star:void 0;this.g.fire("waveBegin",{wave:d,difficulty:this.campaign.difficulty,pilot:e});return}this.g.player.alive&&(this.campaign.currentSector.completed=!0)}draw(){let{map:d,mapWidth:e,mapHeight:L,overlays:P,player:$,term:D}=this.g;for(let i=0;i<L;i++)for(let H=0;H<e;H++){let B=d.grid[i][H];D.drawChar(H,i,0,B.fg,B.bg)}if(this.g.fire("draw",void 0),this.dirty=!1,this.showOverlay){let i=P.get(this.showOverlay);if(i)for(let H=0;H<L;H++)for(let B=0;B<e;B++){let b=i.get({x:B,y:H})||1/0,c=b===1/0?"-":b<10?`${b}`:"*";D.drawChar(B,H,c,Y.Colors.LIGHT_RED)}}if(this.examineAt){la(this.g,this.examineAt,this.examining);for(let i of this.examining){let{motion:H,position:B}=i;if(H&&B){let[b,c]=Hd(H),J=p(B.x+b,B.y+c),F=D0(s(B),s(J));for(let t of F)this.g.blend(t.x,t.y,Y.Colors.DARK_RED)}}}$.alive?this.campaign.currentSector.completed&&(D.drawCenteredString(D.width/2,5,"SECTOR COMPLETE",Y.Colors.WHITE,Y.Colors.BLACK),D.drawCenteredString(D.width/2,7,"Hit Enter to continue",Y.Colors.WHITE,Y.Colors.BLACK)):(D.drawCenteredString(D.width/2,5,"YOU HAVE PERISHED!",Y.Colors.LIGHT_RED,Y.Colors.BLACK),D.drawCenteredString(D.width/2,7,"Hit Q to try again",Y.Colors.LIGHT_RED,Y.Colors.BLACK))}update(){(this.g.term.mouse.dx||this.g.term.mouse.dy)&&this.refresh(),this.handleKeys(),this.dirty&&(this.handleMouseMove(),this.draw())}examine(d){this.examineAt=d,this.dirty=!0;let{solid:e,other:L}=this.g.getContents(d),P=new Set;e&&P.add(this.g.getRoot(e));for(let $ of L)P.add(this.g.getRoot($));this.examining=[...P]}handleMouseMove(){let{x:d,y:e}=this.g.term.mouse;this.examine({x:d,y:e})}handleKeys(){let{player:d,term:e}=this.g;if(!d.alive){(e.isKeyPressed(Y.Key.VK_Q)||e.isKeyPressed(Y.Key.VK_ESCAPE))&&(this.g.setMode(new rd(this.g)),e.fillRect(0,0,e.width,e.height," ",Y.Colors.WHITE,Y.Colors.BLACK));return}if(this.campaign.currentSector.completed&&(e.isKeyPressed(Y.Key.VK_ENTER)||e.isKeyPressed(Y.Key.VK_NUMPAD_ENTER))){this.campaign.endCombat();return}let L=e.getMovementKey();if(L){this.g.fire("playerMove",{move:L});return}if(e.isKeyPressed(Y.Key.VK_1)){this.g.fire("playerFire",{array:0});return}if(e.isKeyPressed(Y.Key.VK_2)){this.g.fire("playerFire",{array:1});return}if(e.isKeyPressed(Y.Key.VK_SPACE)){this.g.fire("playerBomb",void 0);return}}};var yd=class{constructor(d,e,L){this.width=d;this.height=e;this.grid=[];for(let P=0;P<e;P++){let $=[];for(let D=0;D<d;D++)$.push(L(D,P));this.grid.push($)}}contains({x:d,y:e}){return d>=0&&d<this.width&&e>=0&&e<this.height}get({x:d,y:e}){return this.grid[e][d]}getPositions(){let d=[];for(let e=0;e<this.height;e++)for(let L=0;L<this.width;L++)d.push({x:L,y:e});return d}};var Ga="./claw yr way back-WFUTJ3MJ.mp3";var da;function aa(){return da||(da=new Promise(a=>{let d=new Audio(Ga);d.addEventListener("canplaythrough",()=>{d.play(),d.addEventListener("ended",()=>{d.currentTime=0,d.play()}),a(d)})})),da}var sL={name:"Bodini",star:!0,body:4,mind:2,spirit:3,talent:2,class:[],special:"Multiball"},VL={name:"Splintertooth",star:!0,body:3,mind:3,spirit:3,talent:2,class:[],special:"StubbornDescent"},NL={name:"Gruff",star:!0,body:2,mind:2,spirit:4,talent:3,class:[],special:"LaserBeam"},qL={name:"Limmhesto",star:!0,body:3,mind:3,spirit:3,talent:2,class:[],special:"Switchblades"},kL={name:"Ceegrave",star:!0,body:1,mind:4,spirit:3,talent:3,class:[],special:"Triangulate"},gL={name:"Sensoria",star:!0,body:4,mind:2,spirit:4,talent:1,class:[],special:"Overload"},mL=[sL,VL,NL,qL,kL,gL],ua=mL;var o=I(R()),Gd=class{constructor(d,e,L){this.g=d;this.shipPrefab=e;this.pilot=L;this.dirty=!0}get currentSector(){return this.space.get(this.position)}refresh(){this.dirty=!0}init(){let{g:d}=this;d.clearEventHandlers(),d.entities.clear(),d.player=this.makePlayer(),this.difficulty=0,this.position=p(2,2),this.space=new yd(5,5,()=>({completed:!1}));let e=new Set,L=this.space.getPositions().filter(P=>!w(this.position,P));for(;e.size<6;){let P=U(ua);if(!e.has(P)){e.add(P);let $=U(L),D=this.space.get($);D.star=P;let i=L.indexOf($);L.splice(i,1)}}aa(),this.startCombat()}startCombat(){this.g.setMode(new od(this.g,this))}endCombat(){this.g.clearEventHandlers(),this.currentSector.completed=!0,this.currentSector.star=void 0,this.difficulty++,this.g.mode=this,this.refresh()}makePlayer(){let{g:d,shipPrefab:e,pilot:L}=this,P=d.spawn(e);if(!P.ship)throw new Error(`Ship prefab ${e} doesn't have a ship component!`);return Wd(d,P,L),xd(P.ship),P}draw(){let{term:d}=this.g;d.fillRect(0,0,d.width,d.height," ",o.Colors.WHITE,o.Colors.BLACK);let e=this.space.get(this.position),L=d.width/2;d.drawCenteredString(L,2,"Known Space",o.Colors.WHITE),e.completed||(d.drawCenteredString(L,4,"Hit Enter to fight!",o.Colors.WHITE),e.star&&d.drawCenteredString(L,34,`You will face: ${e.star.name}!`,o.Colors.YELLOW));let P=(d.width-25)/2,$=(d.height-25)/2;for(let D=0;D<5;D++){let i=$+D*5;for(let H=0;H<5;H++){let B=P+H*5,b={x:H,y:D},c=this.space.get(b);d.fillRect(B,i,5,5," ",void 0,c.completed?o.Colors.BLACK:o.Colors.DARK_RED),d.drawSingleBox(B,i,5,5,o.Colors.WHITE),w(b,this.position)?d.drawChar(B+2,i+2,"@",o.Colors.LIGHT_CYAN):c.star&&d.drawChar(B+2,i+2,"*",o.Colors.YELLOW)}}this.dirty=!1}handleKeys(){let d=this.space.get(this.position);!d.completed&&(this.g.term.isKeyPressed(o.Key.VK_ENTER)||this.g.term.isKeyPressed(o.Key.VK_NUMPAD_ENTER))&&this.startCombat();let e=this.g.term.getMovementKey();if(d.completed&&e){let L=l(this.position,e);this.space.contains(L)&&(this.position=L,this.dirty=!0)}}update(){this.handleKeys(),this.dirty&&this.draw()}};var S=I(R()),rd=class{constructor(d,e=5,L=100){this.g=d;this.starfieldSpeed=e;this.starCount=L}refresh(){this.dirty=!0}init(){this.dirty=!0,this.pilot={name:"Player",player:!0,body:1,mind:1,spirit:1,talent:1,class:[]},this.points=6,this.starfieldCounter=0,this.stars=[];for(let d=0;d<this.starCount;d++)this.stars.push(this.newStar())}draw(){let{term:d}=this.g;d.clear();for(let D of this.stars){let{x:i,y:H}=s(D);d.drawChar(i,H,D.c,D.fg)}let e=d.width/2;d.drawCenteredString(e,2,"CRAVESPACE",S.Colors.WHITE),d.drawCenteredString(e,9,"Create your Pilot",S.Colors.WHITE),d.drawCenteredString(e,10,`${this.points} points`,S.Colors.YELLOW);let L=2,P=Math.floor((d.width-L*2)/4),$=L+P/2;this.drawStat("body",$),this.drawStat("mind",$+P),this.drawStat("spirit",$+P*2),this.drawStat("talent",$+P*3),this.points===0&&d.drawCenteredString(e,20,"Hit Enter to begin!",S.Colors.WHITE),this.dirty=!1}drawStat(d,e){let{term:L}=this.g,P=`(${d[0].toUpperCase()})${d.slice(1)}`,$=this.pilot[d];L.drawCenteredString(e,13,P,S.Colors.LIGHT_CYAN),L.drawCenteredString(e,14,$.toString(),vd[$])}update(){this.handleStarfield(),this.handleKeys(),this.dirty&&this.draw()}newStar(){let{term:d}=this.g,e=U([S.Colors.DARK_RED,S.Colors.LIGHT_RED,S.Colors.YELLOW,S.Colors.LIGHT_CYAN,S.Colors.WHITE]),L=.5+Math.random(),P=L<.75?".":L<1.25?h.Dot:"*",$=Math.random()*Math.PI*2;return{x:d.width/2,y:d.height/2,c:P,fg:e,vel:L,angle:$}}handleStarfield(){if(this.starfieldCounter<this.starfieldSpeed){this.starfieldCounter++;return}this.starfieldCounter=0,this.dirty=!0;let{width:d,height:e}=this.g.term;for(let L of this.stars){let[P,$]=Hd(L);L.x+=P,L.y+=$,(L.x<0||L.x>=d||L.y<0||L.y>=e)&&Object.assign(L,this.newStar())}}isPressed(d,e){let L=this.g.term.isKeyDown(S.Key.VK_SHIFT_LEFT)||this.g.term.isKeyDown(S.Key.VK_SHIFT_RIGHT);return this.g.term.isKeyPressed(d)&&e===L}changeStat(d,e){let L=this.pilot[d]+e;if(L<1||L>4)return!1;this.points-=e,this.pilot[d]=L,this.dirty=!0}handleKeys(){this.points>0&&(this.isPressed(S.Key.VK_B,!1)&&this.changeStat("body",1),this.isPressed(S.Key.VK_M,!1)&&this.changeStat("mind",1),this.isPressed(S.Key.VK_S,!1)&&this.changeStat("spirit",1),this.isPressed(S.Key.VK_T,!1)&&this.changeStat("talent",1)),this.isPressed(S.Key.VK_B,!0)&&this.changeStat("body",-1),this.isPressed(S.Key.VK_M,!0)&&this.changeStat("mind",-1),this.isPressed(S.Key.VK_S,!0)&&this.changeStat("spirit",-1),this.isPressed(S.Key.VK_T,!0)&&this.changeStat("talent",-1),this.points===0&&(this.g.term.isKeyPressed(S.Key.VK_ENTER)||this.g.term.isKeyPressed(S.Key.VK_NUMPAD_ENTER))&&this.g.setMode(new Gd(this.g,"PlayerShip",this.pilot))}};var B0=I(R()),ud=class{constructor(d,e,L){this.term=d;this.mapWidth=e;this.mapHeight=L;d.update=this.update.bind(this),this.map=new B0.Console(e,L,()=>!0),this.lastEntityId=0,this.entities=new Ud(ha),this.overlays=new Map,this.clearEventHandlers(),this.setMode(new rd(this))}setMode(d){this.mode=d,this.mode.init()}clearEventHandlers(){this.eventCallbacks=ba(Aa.map(d=>[d,[]]))}fire(d,e){for(let L of this.eventCallbacks[d])L(e)}on(d,e){this.eventCallbacks[d].push(e)}spawn(d){return m0(this,d)}refresh(){this.mode.refresh()}add(d){return this.refresh(),this.entities.add(d),this.fire("spawn",{e:d}),d}kill(d,e){d.alive&&(d.kill(e),this.fire("kill",{e:d,reason:e}))}move(d,e){let L=d.position;d.move(e.x,e.y),L&&this.fire("move",{e:d,old:L,pos:e})}blankMap(){let{map:d,mapHeight:e,mapWidth:L}=this;d.clear();for(let P=0;P<e;P++)for(let $=0;$<L;$++)d.setBlocked($,P,!1),d.setBlockedSight($,P,!1);d.computeFov(0,0,1/0)}drawIfVisible(d,e,L,P,$,D){this.map.isVisible(d,e)&&(D?this.term.drawCell(d,e,{bg:$},D):this.term.drawChar(d,e,L,P,$))}blend(d,e,L){this.term.drawCell(d,e,{bg:L},B0.BlendMode.Add)}getRoot(d){return d.attachment?this.getRoot(d.attachment.parent):d}getContents(d,e=[]){let L=s(d);if(!this.inBounds(L))return{oob:!0,other:[]};let P=this.map.isBlocked(L.x,L.y),$=this.entities.get().filter(i=>i.alive&&i.position&&w(L,i.position)),D=$.filter(i=>!e.includes(i.id)).find(i=>i.solid);return{wall:P,solid:D,other:$.filter(i=>!i.solid)}}tick(){this.overlays.clear(),this.fire("tick",void 0),this.entities.clearDead()}update(){this.mode.update()}inBounds(d){return d.x>=0&&d.y>=0&&d.x<this.mapWidth&&d.y<this.mapHeight}getDistanceMap(d){let e=`${d.id}.distance`,L=this.overlays.get(e);return L||(L=X0(n(this,d).map(P=>P.position).filter(md),this.inBounds.bind(this)),this.overlays.set(e,L)),L}};var b0=I(R());function oL(a){let L=b0.DEFAULT_FONT,P=document.createElement("div");a.appendChild(P);let $=()=>{let B=60*L.charWidth,b=40*L.charHeight,c=Math.floor(window.innerWidth/B),J=Math.floor(window.innerHeight/b),F=Math.min(c,J);P.style.width=`${B*F}px`,P.style.height=`${b*F}px`};window.addEventListener("resize",$),$();let D=document.createElement("canvas");P.appendChild(D),requestAnimationFrame(()=>D.focus());let i=new b0.Terminal(D,60,40,{font:L}),H=new ud(i,60,40-hd);window.g=H}window.addEventListener("load",()=>oL(document.body));})();
//# sourceMappingURL=bundle.js.map
