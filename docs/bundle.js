"use strict";(()=>{var At=Object.create;var H=Object.defineProperty;var Ct=Object.getOwnPropertyDescriptor;var kt=Object.getOwnPropertyNames,at=Object.getOwnPropertySymbols,Ht=Object.getPrototypeOf,mt=Object.prototype.hasOwnProperty,Bt=Object.prototype.propertyIsEnumerable;var lt=(e,t,i)=>t in e?H(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,h=(e,t)=>{for(var i in t||={})mt.call(t,i)&&lt(e,i,t[i]);if(at)for(var i of at(t))Bt.call(t,i)&&lt(e,i,t[i]);return e};var Rt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),v=(e,t)=>{for(var i in t)H(e,i,{get:t[i],enumerable:!0})},St=(e,t,i,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of kt(t))!mt.call(e,r)&&r!==i&&H(e,r,{get:()=>t[r],enumerable:!(o=Ct(t,r))||o.enumerable});return e};var E=(e,t,i)=>(i=e!=null?At(Ht(e)):{},St(t||!e||!e.__esModule?H(i,"default",{value:e,enumerable:!0}):i,e));var y=Rt((Xt,pt)=>{pt.exports=globalThis.wglt});var x=E(y());var m=class{constructor(t,i){this.g=t;this.name=i;this.alive=!0,this.id=++t.lastEntityId,this.player=!1,this.projectile=!1,this.solid=!1}get[Symbol.toStringTag](){return this.name}kill(){return this.alive=!1,this.eachChild(t=>this.g.delete(t)),this}eachChild(t){var i;for(let o of this.g.entities.get())((i=o.attachment)==null?void 0:i.parent)===this&&t(o,o.attachment)}setAppearance(t){return this.g.dirty=!0,this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setPosition(t){return this.g.dirty=!0,this.position=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,i){return this.g.dirty=!0,this.position={x:t,y:i},this.eachChild((o,r)=>o.move(t+r.x,i+r.y)),this.position}};function ft(e,t){var r,n,a,s;let i=(n=(r=e.appearance)==null?void 0:r.layer)!=null?n:0,o=(s=(a=t.appearance)==null?void 0:a.layer)!=null?s:0;return i!==o?i-o:e.id-t.id}var G={};v(G,{Battleship:()=>Ft,BattleshipHull:()=>It});var L=E(y());var ut=(n=>(n[n.Effect=0]="Effect",n[n.Ship=1]="Ship",n[n.Gun=2]="Gun",n[n.Bullet=3]="Bullet",n[n.Player=4]="Player",n))(ut||{}),d=ut;function Ft(e){let t=new m(e,"Battleship");return e.spawn("BattleshipHull").setAttachment({parent:t,x:1,y:0}),e.spawn("BattleshipHull").setAttachment({parent:t,x:2,y:0}),e.spawn("BattleshipHull").setAttachment({parent:t,x:0,y:1}),e.spawn("BattleshipHull").setAttachment({parent:t,x:1,y:1}),e.spawn("BattleshipHull").setAttachment({parent:t,x:2,y:1}),e.spawn("MachineGun").setAttachment({parent:t,x:0,y:1}),e.spawn("HomingMissileLauncher").setAttachment({parent:t,x:2,y:1}),t}function It(e){return new m(e,"BattleshipHull").setAppearance({glyph:"/",layer:d.Ship,fg:L.Colors.WHITE,bg:L.Colors.BROWN}).setSolid(!0)}var W={};v(W,{Bullet:()=>Lt,HomingMissile:()=>Gt});var D=E(y());function Lt(e){return new m(e,"Bullet").setProjectile(!0).setAppearance({glyph:".",layer:d.Bullet,fg:D.Colors.YELLOW})}function Gt(e){return new m(e,"HomingMissile").setProjectile(!0).setHoming({strength:.15,duration:10}).setTrail({effectPrefab:"SmokePuff"}).setExplodes({size:5,falloff:1}).setAppearance({glyph:"*",layer:d.Bullet,fg:D.Colors.DARK_RED})}var N={};v(N,{SmokePuff:()=>Dt});var B=E(y());function Dt(e){return new m(e,"SmokePuff").setAppearance({glyph:" ",layer:d.Effect,bg:(0,B.fromRgb)(100,100,100,50),blendMode:B.BlendMode.Add}).setLifetime({duration:2})}var j={};v(j,{HomingMissileLauncher:()=>Nt,MachineGun:()=>Wt});var K=E(y());var q=({bulletPrefab:e="Bullet",bulletVelocity:t=1,salvoCount:i=1,timeBetweenShots:o=1,timeBetweenSalvos:r=1})=>({bulletPrefab:e,bulletVelocity:t,salvoCount:i,timeBetweenShots:o,timeBetweenSalvos:r,timer:0,salvo:i});function Wt(e){return new m(e,"MachineGun").setAppearance({glyph:"o",layer:d.Gun,fg:K.Colors.WHITE}).setTurret(q({bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:5,timeBetweenShots:0,timeBetweenSalvos:12}))}function Nt(e){return new m(e,"HomingMissileLauncher").setAppearance({glyph:"o",layer:d.Gun,fg:K.Colors.YELLOW}).setTurret(q({bulletPrefab:"HomingMissile",bulletVelocity:1,salvoCount:1,timeBetweenSalvos:8}))}var V={};v(V,{Player:()=>qt,PlayerHull:()=>Kt});var Q=E(y());function qt(e){let t=new m(e,"Player").setPlayer(!0);e.spawn("PlayerHull").setAttachment({parent:t,x:0,y:0});let i=e.spawn("PlayerHull").setAttachment({parent:t,x:1,y:0});return i.appearance.glyph=">",t}function Kt(e){return new m(e,"PlayerHull").setSolid(!0).setAppearance({glyph:"#",layer:d.Player,fg:Q.Colors.WHITE,bg:Q.Colors.DARK_RED})}var jt=h(h(h(h(h({},G),W),N),j),V);function Y(e,t){return e.add(jt[t](e))}function b(e){return typeof e=="undefined"?NaN:Math.floor(e)}function w(e){return{x:b(e.x),y:b(e.y)}}function R(e,t){let i=w(e),o=w(t);return i.x===o.x&&i.y===o.y}function S(e,t){return{x:e.x+t.x,y:e.y+t.y}}var M=class{constructor(t,i=[]){this.compareFn=t;this.entities=i;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}add(t){this.entities.push(t),this.dirty=!0}clearDead(){this.entities=this.entities.filter(t=>t.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var u=class{constructor(t,i){this.list=t;this.filter=i}matches(t){if(!t.alive)return!1;for(let i of this.filter)if(!t[i])return!1;return!0}forEach(t){for(let i of this.list.get())this.matches(i)&&t(i,i)}};function _(e){let t=new u(e.entities,["appearance","position"]);e.on("draw",()=>t.forEach(({appearance:i,position:o})=>e.drawIfVisible(b(o.x),b(o.y),i.glyph,i.fg,i.bg,i.blendMode)))}var ct=E(y());var F=E(y());function P(e,t,i){return e*(1-i)+t*i}var T=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[i])=>t-i)}add(t,i){return this.points.push([t,i]),this.sort(),this}get(t){let[i,o]=this.points[0];if(t<=i)return(0,F.fromRgb)(...o);let[r,n]=this.points[this.points.length-1];if(t>=r)return(0,F.fromRgb)(...n);let a=this.points.findIndex(([Tt])=>Tt>t),[s,[l,p,f,c]]=this.points[a-1],[g,[I,C,vt,Mt]]=this.points[a],k=(t-s)/(g-s);return(0,F.fromRgb)(P(l,I,k),P(p,C,k),P(f,vt,k),P(c,Mt,k))}};function O(e,t){let i=Math.abs(e.x-t.x),o=Math.abs(e.y-t.y);return Math.sqrt(i*i+o*o)}var Qt={fire:new T([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function X(e){if(!(e.intensity<=0))return{glyph:" ",layer:d.Effect,bg:Qt[e.type].get(e.intensity),blendMode:ct.BlendMode.Add}}function dt(e,t){let i=[],o=Math.floor(e.x-t),r=Math.ceil(e.x+t),n=Math.floor(e.y-t),a=Math.ceil(e.y+t);for(let s=n;s<=a;s++)for(let l=o;l<=r;l++){let p=O(e,{x:l,y:s});p>=t||i.push({x:l,y:s,intensity:t-p})}return i}function $(e){e.on("kill",({e:t})=>{let{explodes:i,name:o,position:r}=t;if(i&&r)for(let{x:n,y:a,intensity:s}of dt(r,i.size))e.add(new m(e,o+"Explosion").setPosition({x:n,y:a}).setField({type:"fire",intensity:s,falloff:i.falloff}))})}function J(e){let t=new u(e.entities,["field","position"]);e.on("tick",()=>t.forEach(({field:i},o)=>{i.intensity-=i.falloff,o.setAppearance(X(i)),i.intensity<=0&&e.delete(o)})),e.on("spawn",({e:i})=>{i.field&&i.setAppearance(X(i.field))})}var ht=Math.PI*2;function U(e,t){let i=(e-t)%ht,o=(t-e)%ht;return i<o?-i:o}function Z(e){let t=new u(e.entities,["homing","motion","position"]);e.on("tick",()=>t.forEach(({homing:i,motion:o,position:r},n)=>{let a=Math.atan2(e.player.position.y-r.y,e.player.position.x-r.x),s=U(o.angle,a);Math.abs(s)<=i.strength?o.angle=a:s<0?o.angle-=i.strength:o.angle+=i.strength,--i.duration<=0&&(n.setHoming(),n.setTrail())}))}function z(e){let t=new u(e.entities,["lifetime"]);e.on("tick",()=>t.forEach(({lifetime:i},o)=>{--i.duration<=0&&e.delete(o)}))}function tt(e){let t=Math.cos(e.angle)*e.vel,i=Math.sin(e.angle)*e.vel;return[t,i]}function yt(e,t){let i=t.x-e.x,o=t.y-e.y,r=Math.abs(i),n=Math.abs(o),a=i>0?1:-1,s=o>0?1:-1,l=h({},e),p=[h({},l)];for(let f=0,c=0;f<r||c<n;)(.5+f)/r<(.5+c)/n?(l.x+=a,f++):(l.y+=s,c++),p.push(h({},l));return p}function et(e){let t=new u(e.entities,["motion","position"]);e.on("tick",()=>t.forEach(({motion:i,position:o,ignoreSolid:r},n)=>{let[a,s]=tt(i),l={x:o.x+a,y:o.y+s},p=yt(w(o),w(l)),f=!1,c;for(let g of p){e.move(n,g);let{wall:I,solid:C}=e.getContents(g,r==null?void 0:r.ids);if(I){f=!0;break}else if(C){c=C;break}}f||c?e.delete(n):e.move(n,l)}))}function Et(e,t){let i=e.getRoot(t);return e.entities.get().filter(o=>e.getRoot(o)===i)}function it(e,t){return Et(e,t).map(i=>i.id)}function xt(e,t){let i=Et(e,t),o=[];for(let r of i){let{attachment:n,solid:a}=r;n&&a&&o.push([{x:n.x,y:n.y},r])}return{layout:o,topLeft:e.getRoot(t).position}}function gt(e,t,i){let o=it(e,t),{layout:r}=xt(e,t),n=[];for(let[a]of r){let s=S(i,a),{wall:l,solid:p}=e.getContents(s,o);l?n.push([s,"wall"]):p&&n.push([s,p])}return n}function bt(e,t){let{layout:i,topLeft:o}=xt(e,t);if(!o||!i.length)throw new Error(`Could not get midpoint of entity#${t.id}`);let r=n=>i.reduce((a,[s])=>a+s[n],0)/i.length;return{x:o.x+r("x"),y:o.y+r("y")}}function ot(e){e.on("playerMove",({move:t})=>{let i=e.player,o=S(i.position,t);gt(e,i,o).length||(i.move(o.x,o.y),e.fovRecompute=!0,e.tick())})}function nt(e){e.on("move",({e:t,old:i,pos:o})=>{t.trail&&!R(i,o)&&e.spawn(t.trail.effectPrefab).setPosition(i)})}function rt(e){return e.timer?(e.timer--,e.timer<=0&&e.salvo<=0&&(e.salvo=e.salvoCount),!1):(--e.salvo<=0?e.timer=e.timeBetweenSalvos:e.timer=e.timeBetweenShots,!0)}function st(e){let t=new u(e.entities,["position","turret"]);e.on("tick",()=>t.forEach(({position:i,turret:o},r)=>{if(rt(o)){let n=bt(e,e.player);e.spawn(o.bulletPrefab).setIgnoreSolid({ids:it(e,r)}).setPosition({x:i.x+.5,y:i.y+.5}).setMotion({angle:Math.atan2(n.y-i.y,n.x-i.x),vel:o.bulletVelocity})}}))}function wt(e){z(e),Z(e),st(e),J(e),et(e),_(e),nt(e),$(e),ot(e)}var Vt=60,Yt=40,A=class{constructor(t,i=Vt,o=Yt){this.term=t;this.mapWidth=i;this.mapHeight=o;t.update=this.update.bind(this),this.dirty=!0,this.fovRecompute=!0,this.map=new x.Console(i,o,()=>!0),this.lastEntityId=0,this.entities=new M(ft),this.eventCallbacks={draw:[],kill:[],move:[],playerMove:[],spawn:[],tick:[]},wt(this)}get player(){let t=this.entities.get().find(i=>i.player);if(!t)throw new Error("Could not find a player!");return t}fire(t,i){for(let o of this.eventCallbacks[t])o(i)}on(t,i){this.eventCallbacks[t].push(i)}spawn(t){return Y(this,t)}add(t){return this.dirty=!0,this.entities.add(t),this.fire("spawn",{e:t}),t}delete(t){t.alive&&(t.kill(),this.fire("kill",{e:t}))}move(t,i){let o=t.position;t.move(i.x,i.y),o&&this.fire("move",{e:t,old:o,pos:i})}gotoDemoRoom(){this.entities.clear(),this.map.clear(),this.room(1,1,40,30),this.spawn("Player").move(5,25),this.spawn("Battleship").move(8,5)}room(t,i,o,r){let{map:n}=this;for(let a=0;a<r;a++)for(let s=0;s<o;s++){let l=s===0||a===0||s===o-1||a===r-1,p=t+s,f=i+a;n.setBlocked(p,f,l),n.setBlockedSight(p,f,l)}}drawIfVisible(t,i,o,r,n,a){this.map.isVisible(t,i)&&(a?this.term.drawCell(t,i,{bg:n},a):this.term.drawChar(t,i,o,r,n))}draw(){let{map:t,mapWidth:i,mapHeight:o,player:r,term:n}=this;this.fovRecompute&&(t.computeFov(r.position.x,r.position.y,20),this.fovRecompute=!1);for(let a=0;a<o;a++)for(let s=0;s<i;s++){let l=t.grid[a][s],p=t.isVisible(s,a),f=l.blockedSight,c=x.Colors.BLACK;p?(c=f?x.Colors.WHITE:x.Colors.DARK_GRAY,l.explored=!0):l.explored&&(c=f?x.Colors.LIGHT_GRAY:x.Colors.BLACK),n.drawChar(s,a,0,0,c)}this.fire("draw",void 0),this.dirty=!1}getRoot(t){return t.attachment?this.getRoot(t.attachment.parent):t}getContents(t,i=[]){let o=w(t),r=this.map.isBlocked(o.x,o.y),n=this.entities.get().filter(s=>s.position&&R(o,s.position)),a=n.filter(s=>!i.includes(s.id)).find(s=>s.solid);return{wall:r,solid:a,other:n.filter(s=>!s.solid)}}tick(){this.fire("tick",void 0),this.entities.clearDead()}handleKeys(){let t=this.term.getMovementKey();t&&this.fire("playerMove",{move:t})}update(){this.handleKeys(),this.dirty&&this.draw()}};var Pt=E(y());function _t(e){let o=document.createElement("div");e.appendChild(o);let r=()=>{let f=Math.floor(window.innerWidth/480),c=Math.floor(window.innerHeight/320),g=Math.min(f,c);o.style.width=`${480*g}px`,o.style.height=`${320*g}px`};window.addEventListener("resize",r),r();let n=document.createElement("canvas");o.appendChild(n),requestAnimationFrame(()=>n.focus());let a=new Pt.Terminal(n,60,40),s=new A(a);s.gotoDemoRoom(),window.g=s}window.addEventListener("load",()=>_t(document.body));})();
//# sourceMappingURL=bundle.js.map
