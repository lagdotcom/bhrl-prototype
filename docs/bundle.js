"use strict";(()=>{var Xe=Object.create;var Ht=Object.defineProperty;var Je=Object.getOwnPropertyDescriptor;var Ze=Object.getOwnPropertyNames,Pe=Object.getOwnPropertySymbols,ti=Object.getPrototypeOf,ve=Object.prototype.hasOwnProperty,ei=Object.prototype.propertyIsEnumerable;var Se=(e,t,i)=>t in e?Ht(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,C=(e,t)=>{for(var i in t||={})ve.call(t,i)&&Se(e,i,t[i]);if(Pe)for(var i of Pe(t))ei.call(t,i)&&Se(e,i,t[i]);return e};var ii=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),O=(e,t)=>{for(var i in t)Ht(e,i,{get:t[i],enumerable:!0})},oi=(e,t,i,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Ze(t))!ve.call(e,n)&&n!==i&&Ht(e,n,{get:()=>t[n],enumerable:!(o=Je(t,n))||o.enumerable});return e};var b=(e,t,i)=>(i=e!=null?Xe(ti(e)):{},oi(t||!e||!e.__esModule?Ht(i,"default",{value:e,enumerable:!0}):i,e));var g=ii((co,Me)=>{Me.exports=globalThis.wglt});var Kt=b(g());var Qe=b(g());function lt(e,t=new Map){if(!e||typeof e!="object")return e;if(t.has(e))return t.get(e);let i;if(e.nodeType&&"cloneNode"in e)i=e.cloneNode(!0),t.set(e,i);else if(e instanceof Date)i=new Date(e.getTime()),t.set(e,i);else if(e instanceof RegExp)i=new RegExp(e),t.set(e,i);else if(Array.isArray(e)){i=new Array(e.length),t.set(e,i);for(let o=0;o<e.length;o++)i[o]=lt(e[o],t)}else if(e instanceof Map){i=new Map,t.set(e,i);for(let[o,n]of e.entries())i.set(o,lt(n,t))}else if(e instanceof Set){i=new Set,t.set(e,i);for(let o of e)i.add(lt(o,t))}else if(e instanceof Object){i={},t.set(e,i);for(let[o,n]of Object.entries(e))i[o]=lt(n,t)}else throw Error(`Unable to clone ${e}`);return i}function He(e){return lt(e,new Map)}var pt=He,Te=Object.keys,De=e=>{let t={};for(let[i,o]of e)t[i]=o;return t};var $=class{constructor(t,i){this.g=t;this.name=i;this.alive=!0,this.id=++t.lastEntityId,this.solid=!1,this.tags=new Set}applyPrefab(t,i){if(this.prefab=t,i.components&&Object.assign(this,pt(i.components)),i.children)for(let{name:o,x:n,y:r,overlay:s,tags:a}of i.children){let l=this.g.spawn(o).setAttachment({parent:this,x:n,y:r});if(s)for(let p of Te(s))Object.assign(l[p],pt(s[p]));if(a)for(let p of a)l.tags.add(p)}return this}get[Symbol.toStringTag](){return this.name}kill(t){return this.alive=!1,this.eachChild(i=>this.g.kill(i,t)),this}eachChild(t){var i;for(let o of this.g.entities.get())((i=o.attachment)==null?void 0:i.parent)===this&&t(o,o.attachment)}setAI(t){return this.ai=t,this}setAppearance(t){return this.g.refresh(),this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setLastMovement(t){return this.lastMovement=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setOrigin(t){return this.origin=t,this}setPilot(t){return this.pilot=t,this}setPosition(t){return this.g.refresh(),this.position=t,this}setShip(t){return this.ship=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,i){return this.g.refresh(),this.position={x:t,y:i},this.eachChild((o,n)=>o.move(t+n.x,i+n.y)),this}};function Ce(e,t){var n,r,s,a;let i=(r=(n=e.appearance)==null?void 0:n.layer)!=null?r:0,o=(a=(s=t.appearance)==null?void 0:s.layer)!=null?a:0;return i!==o?i-o:e.id-t.id}var Ae=["damage","draw","kill","move","notice","playerFire","playerMove","spawn","tick","waveBegin"];var Nt={};O(Nt,{Battleship:()=>ni,BattleshipHull:()=>ri});var Ft=b(g());var Re=(r=>(r[r.Effect=0]="Effect",r[r.Ship=1]="Ship",r[r.Gun=2]="Gun",r[r.Bullet=3]="Bullet",r[r.Player=4]="Player",r))(Re||{}),w=Re;var h=(e,t,i,o,n)=>({name:e,x:t,y:i,overlay:o,tags:n}),x=(e,t,i=0)=>({name:e,maxHp:t,hp:0,maxShield:i,shield:0}),B=(e,{salvoCount:t=1,timeBetweenShots:i=1,timeBetweenSalvos:o=1,ammunition:n=1/0},r)=>({name:e,bullets:r,salvoCount:t,timeBetweenShots:i,timeBetweenSalvos:o,timer:0,salvo:t,ammunition:n});var ni={components:{ai:{idealDistance:8,speed:1},ship:x("Battleship",40)},children:[{name:"BattleshipHull",x:1,y:0},{name:"BattleshipHull",x:2,y:0},{name:"BattleshipHull",x:0,y:1},{name:"BattleshipHull",x:1,y:1},{name:"BattleshipHull",x:2,y:1},{name:"MachineGun",x:0,y:1},{name:"HomingMissileLauncher",x:2,y:1},{name:"FighterLauncher",x:2,y:0}]},ri={components:{solid:!0,appearance:{glyph:"/",layer:w.Ship,fg:Ft.Colors.WHITE,bg:Ft.Colors.BROWN}}};var _t={};O(_t,{Bullet:()=>ai,DroneBullet:()=>li,HomingMissile:()=>pi,PlayerBullet:()=>mi});var mt=b(g());var si={Diamond:"",Club:"",Dot:"\x07",Ring:"	",RingInvert:`
`,Female:"\f",Star:"",Pilcrow:"",Silcrow:"",ResizeVertical:"",UpArrow:"",DownArrow:"",RightArrow:"",LeftArrow:"\x1B",DownWedge:"",Pentagon:"\x7F",CapitalUUmlaut:"\x9A",Cent:"\x9B",Yen:"\x9D",NotFlip:"\xA9",Not:"\xAA",InvertedExclamation:"\xAD",BoxVerticalSingle:"\xB3",BoxUpSingleHorizontalSingle:"\xC1",BoxDownSingleHorizontalSingle:"\xC2",BoxHorizontalSingle:"\xC4",BoxUpDoubleHorizontalSingle:"\xD0",BoxDownSingleHorizontalDouble:"\xD1",BoxVerticalDoubleHorizontalSingle:"\xD7",Pi:"\xE3",Theta:"\xE9",Omega:"\xEA",SymbolED:"\xED",HorizontalDivide:"\xF6"},f=si;var ai={components:{projectile:{damage:1},appearance:{glyph:f.InvertedExclamation,layer:w.Bullet,fg:mt.Colors.YELLOW}}},li={components:{projectile:{damage:1},appearance:{glyph:".",layer:w.Bullet,fg:mt.Colors.ORANGE}}},pi={components:{projectile:{damage:1},homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,falloff:1},appearance:{glyph:"*",layer:w.Bullet,fg:mt.Colors.DARK_RED}}},mi={components:{projectile:{damage:3},appearance:{glyph:"!",layer:w.Bullet,fg:mt.Colors.YELLOW}}};var Wt={};O(Wt,{AirFistRange:()=>fi,SmokePuff:()=>hi});var it=b(g());var fi={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:w.Effect,bg:(0,it.fromRgb)(0,255,255,100),blendMode:it.BlendMode.Add}}},hi={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:w.Effect,bg:(0,it.fromRgb)(100,100,100,50),blendMode:it.BlendMode.Add}}};var Ot={};O(Ot,{Fighter:()=>ui,FighterHull:()=>gi,FighterLauncher:()=>di});var j=Math.PI/2,Tt=j/2,ci={Right:0,DownRight:Tt,Down:j,DownLeft:j+Tt,Left:j*2,UpLeft:j*2+Tt,Up:j*3,UpRight:j*3+Tt},F=ci;var Dt=b(g());var di={components:{appearance:{glyph:"_",layer:w.Gun,fg:Dt.Colors.DARK_CYAN},turret:B("Fighter Bay",{salvoCount:1,timeBetweenSalvos:20},[{prefab:"Fighter",angle:F.Down,vel:0}])}},ui={components:{ai:{idealDistance:6,speed:2},ship:x("Fighter",2)},children:[{name:"FighterHull",x:0,y:0,overlay:{appearance:{glyph:"<"}}},{name:"FighterHull",x:1,y:0},{name:"FighterHull",x:2,y:0,overlay:{appearance:{glyph:">"}}},{name:"PeaShooter",x:1,y:0}]},gi={components:{solid:!0,appearance:{glyph:"-",layer:w.Ship,fg:Dt.Colors.YELLOW,bg:Dt.Colors.DARK_BLUE}}};var Vt={};O(Vt,{DroneGun:()=>wi,HomingMissileLauncher:()=>bi,MachineGun:()=>yi,OlmSpray:()=>Pi,PeaShooter:()=>xi,PlayerGun:()=>Ei});var yi={components:{turret:B("Machine Gun",{salvoCount:5,timeBetweenShots:0,timeBetweenSalvos:12},[{prefab:"Bullet",angle:F.Down,vel:2}])}},bi={components:{turret:B("Homing Missile",{salvoCount:1,timeBetweenSalvos:8},[{prefab:"HomingMissile",angle:"nearestEnemy",vel:1}])}},xi={components:{turret:B("Pea Shooter",{salvoCount:1,timeBetweenSalvos:3},[{prefab:"Bullet",angle:F.Down,vel:2}])}},Ei={components:{turret:B("Pew Pew",{salvoCount:2,timeBetweenShots:0,timeBetweenSalvos:3},[{prefab:"PlayerBullet",angle:F.Up,vel:2}])}},wi={components:{turret:B("Stinger",{salvoCount:1,timeBetweenSalvos:5,ammunition:5},[{prefab:"DroneBullet",angle:"nearestEnemy",vel:1}])}},Pi={components:{turret:B("Deployment",{salvoCount:1,timeBetweenSalvos:12},[{prefab:"DroneA",angle:F.Up,vel:0,offset:{x:0,y:-1}},{prefab:"HomingMissile",angle:F.DownLeft,vel:2,offset:{x:-1,y:1}},{prefab:"HomingMissile",angle:F.DownRight,vel:2,offset:{x:1,y:1}}])}};var $t={};O($t,{PlayerHull:()=>Si,PlayerShip:()=>vi});var Yt=b(g());var Si={components:{solid:!0,appearance:{glyph:"#",layer:w.Player,fg:Yt.Colors.DARK_GRAY}}},vi={components:{player:{weaponArrays:["Primary","Secondary"]},ship:x("Ace of Clubs",20,10)},children:[h("PlayerHull",0,0,{appearance:{glyph:f.LeftArrow}}),h("PlayerHull",1,0,{appearance:{glyph:f.Club,fg:Yt.Colors.LIGHT_GRAY}}),h("PlayerHull",2,0,{appearance:{glyph:f.RightArrow}}),h("PlayerGun",1,0,void 0,["Primary"]),h("Sword",1,0,void 0,["Secondary"])]};var qt={};O(qt,{CruiseyWing:()=>Ki,Demigod:()=>_i,DroneA:()=>Ii,DroneB:()=>ki,DroneC:()=>Gi,GoutOFlame:()=>Ni,Hull:()=>Mi,Olm:()=>Fi,ShipA:()=>Hi,ShipB:()=>Ti,ShipC:()=>Di,ShipD:()=>Ci,ShipE:()=>Ai,ShipF:()=>Ri,ShipG:()=>Li,ShipH:()=>Bi});var Le=b(g());var Mi={components:{solid:!0,appearance:{glyph:"#",layer:w.Ship,fg:Le.Colors.DARK_GRAY}}},A={idealDistance:8,firingDistance:14,speed:1},V=h("PeaShooter",0,0),Hi={components:{ai:A,ship:x("A",0)},children:[h("Hull",0,0,{appearance:{glyph:f.Pilcrow}}),V]},Ti={components:{ai:A,ship:x("B",0)},children:[h("Hull",0,0,{appearance:{glyph:f.Yen}}),V]},Di={components:{ai:A,ship:x("C",0)},children:[h("Hull",0,0,{appearance:{glyph:"W"}}),V]},Ci={components:{ai:A,ship:x("D",0)},children:[h("Hull",0,0,{appearance:{glyph:f.Omega}}),V]},Ai={components:{ai:A,ship:x("E",0)},children:[h("Hull",0,0,{appearance:{glyph:f.DownWedge}}),V]},Ri={components:{ai:A,ship:x("F",0)},children:[h("Hull",0,0,{appearance:{glyph:f.Pi}}),V]},Li={components:{ai:A,ship:x("G",0)},children:[h("Hull",0,0,{appearance:{glyph:"M"}}),V]},Bi={components:{ai:A,ship:x("H",0)},children:[h("Hull",0,0,{appearance:{glyph:f.Female}}),V]},jt={idealDistance:5,firingDistance:6,speed:1},Ut=h("DroneGun",0,0),Ii={components:{ai:jt,ship:x("Drone A",1)},children:[h("Hull",0,0,{appearance:{glyph:f.Theta}}),Ut]},ki={components:{ai:jt,ship:x("Drone B",1)},children:[h("Hull",0,0,{appearance:{glyph:f.SymbolED}}),Ut]},Gi={components:{ai:jt,ship:x("Drone C",1)},children:[h("Hull",0,0,{appearance:{glyph:f.Silcrow}}),Ut]},Ki={components:{ai:A,ship:x("Cruisey Wing",10,5)},children:[h("Hull",0,0,{appearance:{glyph:f.Not}}),h("Hull",1,0,{appearance:{glyph:f.HorizontalDivide}}),h("Hull",2,0,{appearance:{glyph:f.NotFlip}})]},Fi={components:{ai:A,ship:x("Olm",15,4)},children:[h("Hull",0,0,{appearance:{glyph:f.Cent}}),h("Hull",0,1,{appearance:{glyph:f.ResizeVertical}}),h("Hull",0,2,{appearance:{glyph:f.BoxDownSingleHorizontalDouble}}),h("OlmSpray",0,0)]},Ni={components:{ai:A,ship:x("Gout-'o-flame",5,20)},children:[h("Hull",0,0,{appearance:{glyph:f.Pentagon}}),h("Hull",1,0,{appearance:{glyph:f.BoxVerticalDoubleHorizontalSingle}}),h("Hull",2,0,{appearance:{glyph:f.Pentagon}}),h("Hull",1,1,{appearance:{glyph:f.BoxUpDoubleHorizontalSingle}})]},_i={components:{ai:A,ship:x("Demigod",30,15)},children:[h("Hull",1,0,{appearance:{glyph:f.CapitalUUmlaut}}),h("Hull",0,1,{appearance:{glyph:"}"}}),h("Hull",1,1,{appearance:{glyph:f.RingInvert}}),h("Hull",2,1,{appearance:{glyph:"{"}}),h("Hull",1,2,{appearance:{glyph:"Y"}})]};var zt={};O(zt,{Sword:()=>Oi,SwordBullet:()=>Wi});var U=b(g());var Wi={components:{projectile:{damage:5},appearance:{glyph:f.Star,layer:w.Bullet,fg:U.Colors.LIGHT_GREEN}}},Oi={components:{turret:B("Sword",{salvoCount:1,timeBetweenSalvos:20},[{prefab:"SwordBullet",angle:"lastMovement",vel:1,beam:{duration:2,appearance:[{glyph:f.Star,fg:U.Colors.LIGHT_GREEN},{glyph:"o",fg:U.Colors.LIGHT_GREEN},{glyph:f.Diamond,fg:U.Colors.LIGHT_GREEN},{glyph:f.Ring,fg:U.Colors.DARK_GREEN},{glyph:f.Dot,fg:U.Colors.DARK_GRAY}]}}])}};var Vi=C(C(C(C(C(C(C(C({},Nt),_t),Wt),Ot),Vt),$t),qt),zt);function Qt(e,t){return e.add(new $(e,t).applyPrefab(t,Vi[t]))}function R(e){return typeof e=="undefined"?NaN:Math.floor(e)}function T(e){return{x:R(e.x),y:R(e.y)}}function N(e,t){if(typeof e=="undefined"||typeof t=="undefined")return!1;let i=T(e),o=T(t);return i.x===o.x&&i.y===o.y}function M(e,t){return{x:e.x+t.x,y:e.y+t.y}}var ft=class{constructor(t,i=[]){this.compareFn=t;this.entities=i;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}add(t){this.entities.push(t),this.dirty=!0}clearDead(){this.entities=this.entities.filter(t=>t.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var y=b(g());var I=b(g());var W=b(g());function Yi(e,t){if(!t||!e.length)throw new Error("Could not get midpoint");let i=o=>e.reduce((n,{offset:r})=>n+r[o],0)/e.length;return{x:t.x+i("x"),y:t.y+i("y")}}function $i(e,t,i,o=[]){let n=[];for(let{offset:r}of t){let s=M(i,r),{wall:a,solid:l}=e.getContents(s,o);a?n.push({absolute:s,offset:r,entity:"wall"}):l&&n.push({absolute:s,offset:r,entity:l})}return n}function L(e,t){let i=e.getRoot(t);return e.entities.get().filter(o=>e.getRoot(o)===i)}function ht(e,t){return L(e,t).map(i=>i.id)}function k(e,t){var a;let i=(a=e.getRoot(t).position)!=null?a:{x:0,y:0},o=L(e,t),n=[],r=0,s=0;for(let l of o){let{attachment:p,solid:m}=l;if(p&&m){let{x:c,y:d}=p;n.push({absolute:M(i,p),offset:{x:c,y:d},entity:l}),r=Math.max(c+1,r),s=Math.max(d+1,s)}}return{layout:n,topLeft:i,width:r,height:s}}function Be(e,t,i){let o=ht(e,t),{layout:n,topLeft:r}=k(e,t);return!i||!r?[]:$i(e,n,i||r,o)}function ot(e,t){let{layout:i,topLeft:o}=k(e,t);if(!o||!i.length)throw new Error(`Could not get midpoint of entity#${t.id}`);return Yi(i,o)}function Ie(e,t,i,o,n){for(let r=0;r<n;r++)for(let s=0;s<o;s++){let{oob:a,wall:l,solid:p,other:m}=e.getContents({x:t+s,y:i+r});if(a||l||p||m.length)return!1}return!0}var S=class{constructor(t,i){this.list=t;this.filter=i}matches(t){if(!t.alive)return!1;for(let i of this.filter)if(!t[i])return!1;return!0}forEach(t){for(let i of this.list.get())this.matches(i)&&t(i,i)}};var Xt=Math.PI*2;function G(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}function ke(e,t){let i=(e-t)%Xt,o=(t-e)%Xt;return i<o?-i:o}function Y(e){let t=Math.cos(e.angle)*e.vel,i=Math.sin(e.angle)*e.vel;return[t,i]}function Ge(e){for(;e<0;)e+=Xt;return e}var Jt=[{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:-1}];function Zt(e){return Jt.map(t=>M(e,t))}function D(e){if(!e.length)throw new Error("oneOf passed empty array");return e[Math.floor(Math.random()*e.length)]}function te(e){let t=new S(e.entities,["ai","position"]);e.on("tick",function(){t.forEach(({ai:o,position:n},r)=>{r.setLastMovement(),o.attacking||(o.attacking=e.player,e.fire("notice",{e:r,noticed:e.player}));let s=ht(e,r),{layout:a}=k(e,r),l=T(n),p=e.getDistanceMap(o.attacking),m=P=>{let{oob:E,solid:v,wall:at}=e.getContents(P,s);return!E&&!v&&!at},c=P=>m(P)?Math.abs(p.getOrDefault(P,1/0)-o.idealDistance):1/0,d=P=>a.reduce((E,{offset:v})=>E+c(M(P,v)),0)/a.length,u=d(l),H=[];for(let P of Jt){let E=M(l,P);if(!p.has(E))continue;let v=d(E);v<u?(u=v,H=[E]):v===u&&H.push(E)}if(H.length){let P=D(H);r.move(P.x,P.y),r.setLastMovement({angle:G(l,P)});return}})}),e.on("damage",function({e:o,source:n}){n.owner&&o!==n.owner&&o.ai&&!o.ai.attacking&&n.owner.alive&&(o.ai.attacking=n.owner)})}function ee(e){let t=new S(e.entities,["appearance","position"]);e.on("draw",function(){t.forEach(({appearance:o,position:n})=>e.drawIfVisible(R(n.x),R(n.y),o.glyph,o.fg,o.bg,o.blendMode))})}var Ke=b(g());var Ct=b(g());function nt(e,t,i){return e*(1-i)+t*i}var ct=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[i])=>t-i)}add(t,i){return this.points.push([t,i]),this.sort(),this}get(t){let[i,o]=this.points[0];if(t<=i)return(0,Ct.fromRgb)(...o);let[n,r]=this.points[this.points.length-1];if(t>=n)return(0,Ct.fromRgb)(...r);let s=this.points.findIndex(([at])=>at>t),[a,[l,p,m,c]]=this.points[s-1],[d,[u,H,P,E]]=this.points[s],v=(t-a)/(d-a);return(0,Ct.fromRgb)(nt(l,u,v),nt(p,H,v),nt(m,P,v),nt(c,E,v))}};function q(e,t){let i=Math.abs(e.x-t.x),o=Math.abs(e.y-t.y);return Math.sqrt(i*i+o*o)}var ji={Fire:new ct([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function ie(e){if(!(e.intensity<=0))return{glyph:" ",layer:w.Effect,bg:ji[e.type].get(e.intensity),blendMode:Ke.BlendMode.Add}}function Fe(e,t){let i=[],o=Math.floor(e.x-t),n=Math.ceil(e.x+t),r=Math.floor(e.y-t),s=Math.ceil(e.y+t);for(let a=r;a<=s;a++)for(let l=o;l<=n;l++){let p=q(e,{x:l,y:a});p>=t||i.push({x:l,y:a,intensity:t-p})}return i}function oe(e){e.on("kill",function({e:i,reason:o}){if(o.type==="exitedMap")return;let{explodes:n,name:r,position:s}=i;if(n&&s)for(let{x:a,y:l,intensity:p}of Fe(s,n.size))e.add(new $(e,r+"Explosion").setPosition({x:a,y:l}).setField({type:"Fire",intensity:p,falloff:n.falloff}))})}function dt(e,t,i,o){let n=e.getRoot(t);if(!n.ship)return;let r=i;n.ship.shield>0&&(n.ship.shield>i?(n.ship.shield-=i,r=0):(r-=n.ship.shield,n.ship.shield=0)),r&&(n.ship.hp-=r);let s={e:o,owner:o};o.origin&&(s.owner=o.origin.owner,s.ship=o.origin.ship,s.turret=o.origin.turret),console.log(o.name,"hits",n.name,"for",i),e.fire("damage",{e:n,amount:i,source:s}),n.ship.hp<=0&&e.kill(n,{type:"damage",source:s})}function ne(e){let t=new S(e.entities,["ship"]),i=new S(e.entities,["field","position"]);e.on("tick",function(){i.forEach(({field:n,position:r},s)=>{n.intensity-=n.falloff,s.setAppearance(ie(n)),n.intensity<1?e.kill(s,{type:"expired"}):t.forEach((a,l)=>{let{layout:p}=k(e,l);p.find(({absolute:c})=>N(c,r))&&dt(e,l,Math.floor(n.intensity),s)})})}),e.on("spawn",function({e:n}){n.field&&n.setAppearance(ie(n.field))})}var tt=b(g());var ut=b(g());var z=b(g()),At=[0,z.Colors.DARK_RED,z.Colors.BROWN,z.Colors.LIGHT_RED,z.Colors.ORANGE,z.Colors.YELLOW,z.Colors.WHITE];var Q=class{constructor(t,i,o){this.g=t;this.pilot=i;this.full=o;this.width=11,this.height=o?2+i.class.length:1}get isPlayer(){return isNaN(this.pilot.difficulty)}draw(t,i){if(this.full&&(this.g.term.drawString(t,i,this.pilot.name,this.pilot.star?ut.Colors.YELLOW:ut.Colors.LIGHT_GRAY),i++),this.drawStat(t,i,"body"),this.drawStat(t+3,i,"mind"),this.drawStat(t+6,i,"spirit"),this.drawStat(t+9,i,"talent"),!!this.full)for(let o of this.pilot.class)this.g.term.drawString(t,++i,o,ut.Colors.LIGHT_GREEN)}drawStat(t,i,o){let n=this.pilot[o];this.g.term.drawChar(t,i,o[0].toUpperCase(),ut.Colors.WHITE),this.g.term.drawChar(t+1,i,n.toString(),At[n])}};var K=b(g());function re(e,t,i,o,n,r,s,a,l){let p=`${Math.ceil(n)}/${r}`,m=Math.floor(n/r*o);e.drawHLine(t,i,o," ",void 0,a),m&&e.drawHLine(t,i,m," ",void 0,s),e.drawCenteredString(t+o/2,i,p,l)}var X=class{constructor(t,i){this.g=t;this.ship=i;this.width=Math.max(13,i.name.length),this.height=i.maxShield?3:2}draw(t,i){let{ship:o,width:n}=this,{term:r}=this.g,s=n-3;r.drawString(t,i,o.name,K.Colors.WHITE),r.drawString(t,i+1,"HP:",K.Colors.WHITE),re(r,t+3,i+1,s,o.hp,o.maxHp,K.Colors.DARK_GREEN,K.Colors.DARK_RED,K.Colors.WHITE),o.maxShield&&(r.drawString(t,i+2,"Sh:",K.Colors.WHITE),re(r,t+3,i+2,s,o.shield,o.maxShield,K.Colors.DARK_CYAN,K.Colors.LIGHT_BLUE,K.Colors.WHITE))}};var J=b(g());var _=b(g());var Ne=["Berserker","Chopter","Duelist","Engineer","Fighter","Negotiator","Psychic","Smuggler"];function se(e,t=0){let i=[];for(let o=t;o<e;o++)i.push(o);return i}function Rt(e,t){let{ship:i}=e;if(!i)throw new Error(`Cannot put pilot into entity ${e.name} (no ship)`);e.setPilot(t),i.maxHp+=t.body}function Lt(e){for(let t=e.length-1;t>0;t--){let i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}return e}var Ui={Typical:{fg:_.Colors.DARK_GRAY},Healthy:{fg:_.Colors.DARK_GREEN},Double:{fg:_.Colors.LIGHT_GRAY},Multi:{fg:_.Colors.DARK_MAGENTA},Drain:{fg:_.Colors.DARK_RED},StarPilot:{fg:_.Colors.YELLOW},Mega:{fg:_.Colors.BLACK,bg:_.Colors.DARK_MAGENTA}},qi={Typical:0,Healthy:1,Double:2,Multi:3,Drain:4,StarPilot:8,Mega:15},zi=["ShipA","ShipB","ShipC"],Qi=["ShipD","DroneA"],Xi=["ShipB","ShipD"],Ji=[{difficulty:1,escorts:5,escortTypes:zi,flagships:1,flagshipTypes:["Olm"]},{difficulty:2,escorts:6,escortTypes:Qi,flagships:1,flagshipTypes:["CruiseyWing"]},{difficulty:3,escorts:7,escortTypes:Xi,flagships:2,flagshipTypes:["Olm"]}];function _e(e=3){return Lt(Ji.slice()).slice(0,e).sort((t,i)=>t.difficulty-i.difficulty)}function ae(e,t){return Math.random()*100>=e?t?"StarPilot":"Typical":t?"Mega":D(["Healthy","Double","Multi","Drain"])}function Zi(e){let t=pt(e);for(;t.class.length<t.talent;)t.class.push(D(Ne.filter(i=>!t.class.includes(i))));return t}function le(e,t,i,o){let n=qi[i];if(n&8&&!o)throw new Error(`power ${i} needs pilot, none given`);let r=e.spawn(t),{ship:s}=r;if(!s)throw new Error(`Ship prefab ${t} doesn't have a ship component!`);if(n&1&&(s.maxHp=s.maxHp*2+3),o){let l=Zi(o);Rt(r,l)}gt(s);let a=Ui[i];for(let l of L(e,r))l.appearance&&Object.assign(l.appearance,a);return r}function We(e,t){let{width:i,height:o}=k(e,t);for(let n=0;n<e.term.height;n++){let r=Lt(se(e.term.width-i));for(let s of r)if(Ie(e,s,n,i,o))return{x:s,y:n}}throw new Error(`Could not find ${i}x${o} spawn location`)}function gt(e){e.hp=e.maxHp,e.shield=e.maxShield}function pe(e){return e.salvo<=0?e.ammunition<=0?"Spent":"Reloading":e.timer>0?"Chambering":"Ready"}function Ve(e){e.timer>0&&(e.timer--,e.timer<=0&&e.salvo<=0&&(e.ammunition?(e.salvo=Math.min(e.salvoCount,e.ammunition),e.ammunition-=e.salvo):e.timer=1/0))}function Bt(e,t){return e.bullets.find(i=>i.angle==="lastMovement")&&!t.lastMovement?!1:e.timer===0}function Oe(e,t,i,o,n,r,s,a){let l=e.spawn(t).setIgnoreSolid({ids:a}).move(n.x,n.y);return s&&l.setMotion({angle:r,vel:s}),l.ship&&gt(l.ship),i.ship&&l.setOrigin({owner:i,ship:i.ship,turret:o}),l}function to(e,t,i,o,n,r,s){let{angle:a,beam:l,offset:p,prefab:m,vel:c}=t,d=M(o,p!=null?p:{x:.5,y:.5}),u=a==="nearestEnemy"?G(d,n):a==="lastMovement"?r.lastMovement.angle:a;if(l&&c){let[H,P]=Y({angle:u,vel:c}),E={x:H,y:P},v=M(d,E);return l.appearance.map(at=>{let Mt=Oe(e,m,r,i,v,u,0,s).setLifetime({duration:l.duration});return Mt.appearance&&Object.assign(Mt.appearance,at),r.ship&&Mt.setOrigin({owner:r,ship:r.ship,turret:i}),v=M(v,E),Mt})}return[Oe(e,m,r,i,d,u,c,s)]}function It(e,t,i,o,n,r=[]){let{timeBetweenSalvos:s,timeBetweenShots:a}=t;--t.salvo<=0?t.timer=s:t.timer=a;let l=[];for(let p of t.bullets)l.push(...to(e,p,t,i,o,n,r));return l}var eo={Spent:J.Colors.DARK_GRAY,Reloading:J.Colors.LIGHT_RED,Ready:J.Colors.YELLOW,Chambering:J.Colors.BROWN},Z=class{constructor(t,i){this.g=t;this.turret=i;this.width=Math.max(i.name.length,this.stateLabel.length),this.height=2,i.ammunition>0&&i.ammunition<1/0&&this.height++}get stateLabel(){let{timer:t,salvo:i,salvoCount:o}=this.turret,n=pe(this.turret);if(n==="Spent")return"Out of Ammo";if(n==="Reloading")return`Reloading (${t})`;let r=`${i}/${o}`;return n==="Ready"?r:`${r} (${t})`}draw(t,i){this.g.term.drawString(t,i,this.turret.name,J.Colors.WHITE);let o=pe(this.turret);this.g.term.drawString(t,i+1,this.stateLabel,eo[o]),this.height>2&&this.g.term.drawString(t,i+2,`${this.turret.ammunition} ammo left`,J.Colors.LIGHT_GRAY)}};var rt=6;function me(e){let{mapHeight:t,term:i}=e;e.on("draw",function(){let n=e.player,{pilot:r,ship:s}=n;i.fillRect(0,t,i.width,rt," ",tt.Colors.WHITE,tt.Colors.BLACK),i.drawSingleBox(0,t,i.width,rt);let a=1,l=t+1,p=new X(e,s);p.draw(a,l);let m=a+Math.floor((p.width-11)/2);new Q(e,r,!1).draw(m,l+3),a+=p.width+1,i.drawChar(a-1,l-1,f.BoxDownSingleHorizontalSingle,tt.Colors.WHITE),i.drawVLine(a-1,l,rt-2,f.BoxVerticalSingle,tt.Colors.WHITE),i.drawChar(a-1,l+rt-2,f.BoxUpSingleHorizontalSingle,tt.Colors.WHITE);let d=a;for(let u of n.player.weaponArrays){let H=d,P=L(e,n).filter(E=>E.turret&&E.tags.has(u));for(let E of P){let v=new Z(e,E.turret);v.draw(d,l+1),d+=v.width+1}i.drawString(H,l,u,tt.Colors.LIGHT_CYAN),d=Math.max(d,H+u.length+1)}})}function fe(e){let t=new S(e.entities,["homing","motion","position"]);e.on("tick",function(){t.forEach(({homing:o,motion:n,position:r},s)=>{var m;if(!((m=o.target)!=null&&m.alive))return;let a=ot(e,o.target),l=G(r,a),p=ke(n.angle,l);Math.abs(p)<=o.strength?n.angle=l:p<0?n.angle-=o.strength:n.angle+=o.strength,--o.duration<=0&&(s.setHoming(),s.setTrail())})})}function he(e){let t=new S(e.entities,["lifetime"]);e.on("tick",function(){t.forEach(({lifetime:o},n)=>{if(--o.duration<=0)e.kill(n,{type:"expired"});else if(o.decayingAppearance&&n.appearance){let r=o.decayingAppearance[o.duration-1];Object.assign(n.appearance,r)}})})}function kt(e,t){let i=t.x-e.x,o=t.y-e.y,n=Math.abs(i),r=Math.abs(o),s=i>0?1:-1,a=o>0?1:-1,l=C({},e),p=[C({},l)];for(let m=0,c=0;m<n||c<r;)(.5+m)/n<(.5+c)/r?(l.x+=s,m++):(l.y+=a,c++),p.push(C({},l));return p}function Ye(e,t,i){let o=[],n=(r,s)=>{let a=R(r),l=R(s);o.find(p=>p.x===a&&p.y===l)||o.push({x:a,y:l})};for(let r=0;r<=Math.floor(i*Math.sqrt(.5));r++){let s=Math.floor(Math.sqrt(i*i-r*r));n(e-s,t+r),n(e+s,t+r),n(e-s,t-r),n(e+s,t-r),n(e+r,t-s),n(e+r,t+s),n(e-r,t-s),n(e-r,t+s)}return o}function ce(e){let t=new S(e.entities,["motion","position"]);e.on("tick",function(){t.forEach(({motion:o,position:n,projectile:r,ignoreSolid:s},a)=>{let[l,p]=Y(o),m={x:n.x+l,y:n.y+p},c=kt(T(n),T(m)),d=!1,u;for(let H of c){if(!e.inBounds(H)){e.kill(a,{type:"exitedMap"});return}e.move(a,H);let{wall:P,solid:E}=e.getContents(H,s==null?void 0:s.ids);if(P){d=!0;break}else if(E){u=E;break}}d?e.kill(a,{type:"hitWall"}):u?(r&&dt(e,u,r.damage,a),e.kill(a,{type:"hitEntity",other:u})):e.move(a,m)})})}function de(e){e.on("playerMove",function({move:i}){let o=e.player,n=o.position,r=M(n,i);Be(e,o,r).length||(o.move(r.x,r.y),o.setLastMovement({angle:G(n,r)}),e.tick())}),e.on("playerFire",function({array:i}){let o=e.player,n=o.player.weaponArrays[i],r=L(e,o),s=r.filter(l=>l.tags.has(n)),a=!1;for(let l of s)l.turret&&Bt(l.turret,o)&&(It(e,l.turret,l.position,{x:0,y:0},o,r.map(p=>p.id)),a=!0);a&&(o.setLastMovement(),e.tick())})}function ue(e){let t=new S(e.entities,["pilot","ship"]);e.on("tick",function(){t.forEach(({pilot:o,ship:n})=>{let r=o.body;n.shield=Math.min(n.maxShield,n.shield+r)})})}function ge(e){e.on("waveBegin",function({wave:i,difficulty:o,pilot:n}){let r=[],s=(o+i.difficulty)*3;for(let l=0;l<i.escorts;l++){let p=ae(s,!1),m=D(i.escortTypes);r.push(le(e,m,p))}let a=Math.floor(Math.random()*i.flagships);for(let l=0;l<i.flagships;l++){let m=ae(s,l===a&&n!==void 0),c=D(i.flagshipTypes);r.push(le(e,c,m))}for(let l of r){let p=We(e,l);l.move(p.x,p.y)}})}function ye(e){e.on("move",function({e:i,old:o,pos:n}){i.trail&&!N(o,n)&&e.spawn(i.trail.effectPrefab).setPosition(o)})}function be(e){let t=new S(e.entities,["position","turret"]);e.on("tick",function(){t.forEach(({position:o,turret:n},r)=>{var p;Ve(n);let s=e.getRoot(r);if(!s.ai)return;let a=s.ai.attacking;if(!(a!=null&&a.alive))return;let l=ot(e,a);if(!(q(o,l)>((p=s.ai.firingDistance)!=null?p:1/0))&&Bt(n,s))for(let m of It(e,n,o,l,s,ht(e,s)))m.homing&&(m.homing.target=a),m.ai&&(m.ai.attacking=a)})})}function $e(e){he(e),fe(e),be(e),ne(e),ue(e),ce(e),te(e),ge(e),ee(e),me(e),ye(e),oe(e),de(e)}var st=b(g());var et=class{constructor(t){this.g=t;this.width=0,this.height=0,this.instructions=[]}add(t){this.instructions.push(t),this.updateBounds()}addLine(t,i){this.add({x:0,y:this.instructions.length,line:t,fg:i})}updateBounds(){this.width=this.instructions.reduce((t,i)=>Math.max(i.line.length+i.x,t),0),this.height=1+this.instructions.reduce((t,i)=>Math.max(i.y,t),0)}draw(t,i){for(let{x:o,y:n,line:r,fg:s}of this.instructions)this.g.term.drawString(t+o,i+n,r,s)}};var je=Math.PI/4,io=[f.RightArrow,f.DownArrow+f.RightArrow,f.DownArrow,f.DownArrow+f.LeftArrow,f.LeftArrow,f.UpArrow+f.LeftArrow,f.UpArrow,f.UpArrow+f.RightArrow];function oo(e){let t=Math.floor(Ge(e)/je+je/2);return io[t]}var yt=class extends et{constructor(i,o){super(i);this.e=o;this.instructions=[],o.name&&this.addLine(o.name,st.Colors.WHITE),o.projectile&&this.addLine(`${o.projectile.damage} damage`,st.Colors.LIGHT_RED),o.motion&&this.addLine(`${oo(o.motion.angle)}, vel ${o.motion.vel}`,st.Colors.LIGHT_GRAY),o.homing&&this.addLine(`chasing ${o.homing.target===this.g.player?"you ":""}${o.homing.duration<1/0?`(${o.homing.duration})`:""}`,st.Colors.DARK_RED),o.lifetime&&this.addLine(`(lasts ${o.lifetime.duration})`,st.Colors.DARK_GRAY)}};var xe=b(g());var Gt=b(g());var bt=class extends et{constructor(i,o){super(i);this.field=o;this.addLine(`${o.type} Field`,Gt.Colors.WHITE),this.add({x:0,y:1,fg:Gt.Colors.LIGHT_GRAY,line:"intensity"}),this.add({x:10,y:1,fg:Gt.Colors.YELLOW,line:Math.floor(o.intensity).toString()})}};function Ue(e,t,i){if(!i.length)return;let o=[],n=1,r=1,s=m=>{o.push({x:n,y:r,object:m}),r+=m.height+1};for(let m of i){m.ship&&s(new X(e,m.ship)),m.pilot&&s(new Q(e,m.pilot,!0));let c=L(e,m);for(let d of c.filter(u=>u.turret))s(new Z(e,d.turret));(m.motion||m.projectile||m.homing||m.lifetime)&&s(new yt(e,m)),m.field&&s(new bt(e,m.field))}if(!o.length)return;let a=Math.max(...o.map(m=>m.object.width))+2,l=Math.min(t.x+2,e.term.width-a),p=Math.min(t.y,e.term.height-r);e.term.fillRect(l,p,a,r," ",xe.Colors.WHITE,xe.Colors.BLACK),e.term.drawSingleBox(l,p,a,r);for(let m of o)m.object.draw(l+m.x,p+m.y)}function qe(e,t,i){for(let o of e.entities.get()){let{motion:n,projectile:r,position:s}=o;if(n&&r&&s&&q(t,s)<=i){let a=G(t,s);n.angle=a,o.setIgnoreSolid()}}for(let o of Ye(t.x,t.y,i))e.spawn("AirFistRange").setPosition(o)}var xt=class{constructor(t,i){this.g=t;this.campaign=i;this.dirty=!0,this.examining=[]}refresh(){this.dirty=!0}init(){let{g:t}=this;this.examineAt=void 0,this.examining=[],this.waves=_e(),t.blankMap();let{width:i,height:o}=k(t,t.player);t.player.move(R(t.mapWidth/2-i/2),t.mapHeight-o-4),$e(t),this.nextWave()}nextWave(){let t=this.waves.shift();if(t){let i=this.waves.length===0?this.campaign.currentSector.star:void 0;this.g.fire("waveBegin",{wave:t,difficulty:this.campaign.difficulty,pilot:i})}}draw(){let{map:t,mapWidth:i,mapHeight:o,overlays:n,term:r}=this.g;for(let s=0;s<o;s++)for(let a=0;a<i;a++){let l=t.grid[s][a];r.drawChar(a,s,0,l.fg,l.bg)}if(this.g.fire("draw",void 0),this.dirty=!1,this.showOverlay){let s=n.get(this.showOverlay);if(s)for(let a=0;a<o;a++)for(let l=0;l<i;l++){let p=s.get({x:l,y:a})||1/0,m=p===1/0?"-":p<10?`${p}`:"*";r.drawChar(l,a,m,W.Colors.LIGHT_RED)}}if(this.examineAt){Ue(this.g,this.examineAt,this.examining);for(let s of this.examining){let{motion:a,position:l}=s;if(a&&l){let[p,m]=Y(a),c={x:l.x+p,y:l.y+m},d=kt(T(l),T(c));for(let u of d)r.drawCell(u.x,u.y,{bg:W.Colors.DARK_RED},W.BlendMode.Add)}}}}update(){(this.g.term.mouse.dx||this.g.term.mouse.dy)&&this.refresh(),this.handleKeys(),this.dirty&&(this.handleMouseMove(),this.draw())}examine(t){this.examineAt=t,this.dirty=!0;let{solid:i,other:o}=this.g.getContents(t),n=new Set;i&&n.add(this.g.getRoot(i));for(let r of o)n.add(this.g.getRoot(r));this.examining=[...n]}handleMouseMove(){let{x:t,y:i}=this.g.term.mouse;this.examine({x:t,y:i})}handleKeys(){let{player:t,term:i}=this.g,o=i.getMovementKey();if(o){this.g.fire("playerMove",{move:o});return}if(i.isKeyPressed(W.Key.VK_1)){this.g.fire("playerFire",{array:0});return}if(i.isKeyPressed(W.Key.VK_2)){this.g.fire("playerFire",{array:1});return}if(i.isKeyPressed(W.Key.VK_F)){qe(this.g,ot(this.g,t),4.5),this.g.tick();return}}};var Et=class{constructor(t,i,o){this.width=t;this.height=i;this.grid=[];for(let n=0;n<i;n++){let r=[];for(let s=0;s<t;s++)r.push(o(s,n));this.grid.push(r)}}contains({x:t,y:i}){return t>=0&&t<this.width&&i>=0&&i<this.height}get({x:t,y:i}){return this.grid[i][t]}getPositions(){let t=[];for(let i=0;i<this.height;i++)for(let o=0;o<this.width;o++)t.push({x:o,y:i});return t}};var no={name:"Bodini",star:!0,difficulty:4,body:3,mind:2,spirit:3,talent:2,class:["Psychic"]},ro={name:"Star Pilot B",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},so={name:"Star Pilot C",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},ao={name:"Star Pilot D",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},lo={name:"Star Pilot E",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},po={name:"Star Pilot F",star:!0,difficulty:2,body:2,mind:2,spirit:2,talent:2,class:[]},mo=[no,ro,so,ao,lo,po],ze=mo;var wt=class{constructor(t,i,o){this.g=t;this.shipPrefab=i;this.pilot=o;this.dirty=!0}get currentSector(){return this.space.get(this.position)}refresh(){this.dirty=!0}init(){let{g:t}=this;t.clearEventHandlers(),t.entities.clear(),t.player=this.makePlayer(),this.difficulty=0,this.position={x:2,y:2},this.space=new Et(5,5,()=>({completed:!1}));let i=new Set,o=this.space.getPositions().filter(n=>!N(this.position,n));for(;i.size<6;){let n=D(ze);if(!i.has(n)){i.add(n);let r=D(o),s=this.space.get(r);s.star=n;let a=o.indexOf(r);o.splice(a,1)}}}startCombat(){this.g.setMode(new xt(this.g,this))}endCombat(){this.currentSector.completed=!0,this.difficulty++,this.g.mode=this,this.refresh()}makePlayer(){let{g:t,shipPrefab:i,pilot:o}=this,n=t.spawn(i);if(!n.ship)throw new Error(`Ship prefab ${i} doesn't have a ship component!`);return Rt(n,o),gt(n.ship),n}draw(){let{term:t}=this.g;t.clear();let i=this.space.get(this.position),o=t.width/2;t.drawCenteredString(o,2,"Known Space",I.Colors.WHITE),i.completed||t.drawCenteredString(o,4,"Hit Enter to fight!",I.Colors.WHITE);let n=(t.width-25)/2,r=(t.height-25)/2;for(let s=0;s<5;s++){let a=r+s*5;for(let l=0;l<5;l++){let p=n+l*5,m={x:l,y:s},c=this.space.get(m);t.fillRect(p,a,5,5," ",void 0,c.completed?I.Colors.BLACK:I.Colors.DARK_RED),t.drawSingleBox(p,a,5,5,I.Colors.WHITE),N(m,this.position)?t.drawChar(p+2,a+2,"@",I.Colors.LIGHT_CYAN):c.star&&t.drawChar(p+2,a+2,"*",I.Colors.YELLOW)}}this.dirty=!1}handleKeys(){let t=this.space.get(this.position);!t.completed&&(this.g.term.isKeyPressed(I.Key.VK_ENTER)||this.g.term.isKeyPressed(I.Key.VK_NUMPAD_ENTER))&&this.startCombat();let i=this.g.term.getMovementKey();if(t.completed&&i){let o=M(this.position,i);this.space.contains(o)&&(this.position=o,this.dirty=!0)}}update(){this.handleKeys(),this.dirty&&this.draw()}};var Pt=class{constructor(t,i=5,o=100){this.g=t;this.starfieldSpeed=i;this.starCount=o}refresh(){this.dirty=!0}init(){this.dirty=!0,this.pilot={name:"Player",difficulty:NaN,body:1,mind:1,spirit:1,talent:1,class:[]},this.points=6,this.starfieldCounter=0,this.stars=[];for(let t=0;t<this.starCount;t++)this.stars.push(this.newStar())}draw(){let{term:t}=this.g;t.clear();for(let s of this.stars){let{x:a,y:l}=T(s);t.drawChar(a,l,s.c,s.fg)}let i=t.width/2;t.drawCenteredString(i,2,"Bullet Hell Roguelike",y.Colors.WHITE),t.drawCenteredString(i,9,"Create your Pilot",y.Colors.WHITE),t.drawCenteredString(i,10,`${this.points} points`,y.Colors.YELLOW);let o=2,n=Math.floor((t.width-o*2)/4),r=o+n/2;this.drawStat("body",r),this.drawStat("mind",r+n),this.drawStat("spirit",r+n*2),this.drawStat("talent",r+n*3),this.points===0&&t.drawCenteredString(i,20,"Hit Enter to begin!",y.Colors.WHITE),this.dirty=!1}drawStat(t,i){let{term:o}=this.g,n=`(${t[0].toUpperCase()})${t.slice(1)}`,r=this.pilot[t];o.drawCenteredString(i,13,n,y.Colors.LIGHT_CYAN),o.drawCenteredString(i,14,r.toString(),At[r])}update(){this.handleStarfield(),this.handleKeys(),this.dirty&&this.draw()}newStar(){let{term:t}=this.g,i=D([y.Colors.DARK_RED,y.Colors.LIGHT_RED,y.Colors.YELLOW,y.Colors.LIGHT_CYAN,y.Colors.WHITE]),o=.5+Math.random(),n=o<.75?".":o<1.25?f.Dot:"*",r=Math.random()*Math.PI*2;return{x:t.width/2,y:t.height/2,c:n,fg:i,vel:o,angle:r}}handleStarfield(){if(this.starfieldCounter<this.starfieldSpeed){this.starfieldCounter++;return}this.starfieldCounter=0,this.dirty=!0;let{width:t,height:i}=this.g.term;for(let o of this.stars){let[n,r]=Y(o);o.x+=n,o.y+=r,(o.x<0||o.x>=t||o.y<0||o.y>=i)&&Object.assign(o,this.newStar())}}isPressed(t,i){let o=this.g.term.isKeyDown(y.Key.VK_SHIFT_LEFT)||this.g.term.isKeyDown(y.Key.VK_SHIFT_RIGHT);return this.g.term.isKeyPressed(t)&&i===o}changeStat(t,i){let o=this.pilot[t]+i;if(o<1||o>6)return!1;this.points-=i,this.pilot[t]=o,this.dirty=!0}handleKeys(){this.points>0&&(this.isPressed(y.Key.VK_B,!1)&&this.changeStat("body",1),this.isPressed(y.Key.VK_M,!1)&&this.changeStat("mind",1),this.isPressed(y.Key.VK_S,!1)&&this.changeStat("spirit",1),this.isPressed(y.Key.VK_T,!1)&&this.changeStat("talent",1)),this.isPressed(y.Key.VK_B,!0)&&this.changeStat("body",-1),this.isPressed(y.Key.VK_M,!0)&&this.changeStat("mind",-1),this.isPressed(y.Key.VK_S,!0)&&this.changeStat("spirit",-1),this.isPressed(y.Key.VK_T,!0)&&this.changeStat("talent",-1),this.points===0&&(this.g.term.isKeyPressed(y.Key.VK_ENTER)||this.g.term.isKeyPressed(y.Key.VK_NUMPAD_ENTER))&&this.g.setMode(new wt(this.g,"PlayerShip",this.pilot))}};var St=class{constructor(t){this.keyFn=t;this.items=new Map}has(t){return this.items.has(this.keyFn(t))}get(t){return this.items.get(this.keyFn(t))}getOrDefault(t,i){let o=this.items.get(this.keyFn(t));return typeof o!="undefined"?o:i}getOrDie(t){let i=this.keyFn(t),o=this.items.get(i);if(typeof o=="undefined")throw new Error(`Invalid key: ${i}`);return o}set(t,i){this.items.set(this.keyFn(t),i)}};function Ee(e,t,i=1/0){let o=[],n=new St(r=>`${r.x},${r.y}`);for(let r of e)o.push(r),n.set(r,0);for(;o.length;){let r=o.shift(),s=n.getOrDie(r)+1;if(!(s>i))for(let a of Zt(r))!n.has(a)&&t(a)&&(n.set(a,s),o.push(a))}return n}function we(e){return typeof e!="undefined"}var vt=class{constructor(t,i,o){this.term=t;this.mapWidth=i;this.mapHeight=o;t.update=this.update.bind(this),this.map=new Qe.Console(i,o,()=>!0),this.lastEntityId=0,this.entities=new ft(Ce),this.overlays=new Map,this.clearEventHandlers(),this.setMode(new Pt(this))}setMode(t){this.mode=t,this.mode.init()}clearEventHandlers(){this.eventCallbacks=De(Ae.map(t=>[t,[]]))}fire(t,i){for(let o of this.eventCallbacks[t])o(i)}on(t,i){this.eventCallbacks[t].push(i)}spawn(t){return Qt(this,t)}refresh(){this.mode.refresh()}add(t){return this.refresh(),this.entities.add(t),this.fire("spawn",{e:t}),t}kill(t,i){t.alive&&(t.kill(i),this.fire("kill",{e:t,reason:i}))}move(t,i){let o=t.position;t.move(i.x,i.y),o&&this.fire("move",{e:t,old:o,pos:i})}blankMap(){let{map:t,mapHeight:i,mapWidth:o}=this;t.clear();for(let n=0;n<i;n++)for(let r=0;r<o;r++)t.setBlocked(r,n,!1),t.setBlockedSight(r,n,!1);t.computeFov(0,0,1/0)}drawIfVisible(t,i,o,n,r,s){this.map.isVisible(t,i)&&(s?this.term.drawCell(t,i,{bg:r},s):this.term.drawChar(t,i,o,n,r))}getRoot(t){return t.attachment?this.getRoot(t.attachment.parent):t}getContents(t,i=[]){let o=T(t);if(!this.inBounds(o))return{oob:!0,other:[]};let n=this.map.isBlocked(o.x,o.y),r=this.entities.get().filter(a=>a.position&&N(o,a.position)),s=r.filter(a=>!i.includes(a.id)).find(a=>a.solid);return{wall:n,solid:s,other:r.filter(a=>!a.solid)}}tick(){this.overlays.clear(),this.fire("tick",void 0),this.entities.clearDead()}update(){this.mode.update()}inBounds(t){return t.x>=0&&t.y>=0&&t.x<this.mapWidth&&t.y<this.mapHeight}getDistanceMap(t){let i=`${t.id}.distance`,o=this.overlays.get(i);return o||(o=Ee(L(this,t).map(n=>n.position).filter(we),this.inBounds.bind(this)),this.overlays.set(i,o)),o}};function fo(e){let o=Kt.DEFAULT_FONT,n=document.createElement("div");e.appendChild(n);let r=()=>{let p=60*o.charWidth,m=40*o.charHeight,c=Math.floor(window.innerWidth/p),d=Math.floor(window.innerHeight/m),u=Math.min(c,d);n.style.width=`${p*u}px`,n.style.height=`${m*u}px`};window.addEventListener("resize",r),r();let s=document.createElement("canvas");n.appendChild(s),requestAnimationFrame(()=>s.focus());let a=new Kt.Terminal(s,60,40,{font:o}),l=new vt(a,60,40-rt);window.g=l}window.addEventListener("load",()=>fo(document.body));})();
//# sourceMappingURL=bundle.js.map
