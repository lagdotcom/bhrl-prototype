"use strict";(()=>{var Va=Object.create;var od=Object.defineProperty,Na=Object.defineProperties,qa=Object.getOwnPropertyDescriptor,ka=Object.getOwnPropertyDescriptors,ga=Object.getOwnPropertyNames,z0=Object.getOwnPropertySymbols,ma=Object.getPrototypeOf,W0=Object.prototype.hasOwnProperty,oa=Object.prototype.propertyIsEnumerable;var v0=(a,d,e)=>d in a?od(a,d,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[d]=e,s=(a,d)=>{for(var e in d||={})W0.call(d,e)&&v0(a,e,d[e]);if(z0)for(var e of z0(d))oa.call(d,e)&&v0(a,e,d[e]);return a},w0=(a,d)=>Na(a,ka(d));var ya=(a,d)=>()=>(d||a((d={exports:{}}).exports,d),d.exports),ed=(a,d)=>{for(var e in d)od(a,e,{get:d[e],enumerable:!0})},Ga=(a,d,e,L)=>{if(d&&typeof d=="object"||typeof d=="function")for(let P of ga(d))!W0.call(a,P)&&P!==e&&od(a,P,{get:()=>d[P],enumerable:!(L=qa(d,P))||L.enumerable});return a};var I=(a,d,e)=>(e=a!=null?Va(ma(a)):{},Ga(d||!a||!a.__esModule?od(e,"default",{value:a,enumerable:!0}):e,a));var R=ya((jL,_0)=>{_0.exports=globalThis.wglt});var e0=I(R());var a0=I(R());function Ed(a,d=new Map){if(!a||typeof a!="object")return a;if(d.has(a))return d.get(a);let e;if(a.nodeType&&"cloneNode"in a)e=a.cloneNode(!0),d.set(a,e);else if(a instanceof Date)e=new Date(a.getTime()),d.set(a,e);else if(a instanceof RegExp)e=new RegExp(a),d.set(a,e);else if(Array.isArray(a)){e=new Array(a.length),d.set(a,e);for(let L=0;L<a.length;L++)e[L]=Ed(a[L],d)}else if(a instanceof Map){e=new Map,d.set(a,e);for(let[L,P]of a.entries())e.set(L,Ed(P,d))}else if(a instanceof Set){e=new Set,d.set(a,e);for(let L of a)e.add(Ed(L,d))}else if(a instanceof Object){e={},d.set(a,e);for(let[L,P]of Object.entries(a))e[L]=Ed(P,d)}else throw Error(`Unable to clone ${a}`);return e}function da(a){return Ed(a,new Map)}var y=da,aa=Object.keys,ea=a=>{let d={};for(let[e,L]of a)d[e]=L;return d};var Hd=class{constructor(d,e){this.g=d;this.name=e;this.alive=!0,this.id=++d.lastEntityId,this.solid=!1,this.tags=new Set}applyPrefab(d,e){if(this.prefab=d,e.components&&Object.assign(this,y(e.components)),e.children)for(let{name:L,x:P,y:$,overlay:D,tags:i}of e.children){let H=this.g.spawn(L).setAttachment({parent:this,x:P,y:$});if(D)for(let b of aa(D))Object.assign(H[b],y(D[b]));if(i)for(let b of i)H.tags.add(b)}return this}get[Symbol.toStringTag](){return this.name}kill(d){return this.alive=!1,this.eachChild(e=>this.g.kill(e,d)),this}eachChild(d){var e;for(let L of this.g.entities.get())((e=L.attachment)==null?void 0:e.parent)===this&&d(L,L.attachment)}setAI(d){return this.ai=d,this}setAppearance(d){return this.g.refresh(),this.appearance=d,this}setAttachment(d){return this.attachment=d,this}setDelayedShot(d){return this.delayedShot=d,this}setDoubleShot(d){return this.doubleShot=d,this}setExplodes(d){return this.explodes=d,this}setField(d){return this.field=d,this}setHoming(d){return this.homing=d,this}setIgnoreSolid(d){return this.ignoreSolid=d,this}setItem(d){return this.item=d,this}setLastMovement(d){return this.lastMovement=d,this}setLifetime(d){return this.lifetime=d,this}setMotion(d){return this.motion=d,this}setOrigin(d){return this.origin=d,this}setPilot(d){return this.pilot=d,this}setPosition(d){return this.g.refresh(),this.position=d,this}setShip(d){return this.ship=d,this}setTrail(d){return this.trail=d,this}setTurret(d){return this.turret=d,this}setPlayer(d){return this.player=d,this}setProjectile(d){return this.projectile=d,this}setSolid(d){return this.solid=d,this}move(d,e){return this.g.refresh(),this.position={x:d,y:e},this.eachChild((L,P)=>L.move(d+P.x,e+P.y)),this}};function La(a,d){var P,$,D,i;let e=($=(P=a.appearance)==null?void 0:P.layer)!=null?$:0,L=(i=(D=d.appearance)==null?void 0:D.layer)!=null?i:0;return e!==L?e-L:a.id-d.id}var Pa=["damage","draw","kill","move","notice","playerBomb","playerFire","playerMove","spawn","tick","waveBegin","waveNext"];var L0={};ed(L0,{AcidBullet:()=>Wa,BellowMissile:()=>$e,Bullet:()=>Oa,CrushBullet:()=>_a,DroneBullet:()=>za,HomingMissile:()=>ae,OutcryBullet:()=>va,PlayerBullet:()=>De,SalvoMissileA:()=>ee,SalvoMissileB:()=>Le,SalvoMissileC:()=>Pe,SmiteMissile:()=>de,TalonBullet:()=>wa});var V=I(R());var ua={Smiley:"",Heart:"",Diamond:"",Club:"",Dot:"\x07",Ring:"	",RingInvert:`
`,Male:"\v",Female:"\f",DoubleNote:"",Star:"",Pilcrow:"",Silcrow:"",ResizeVertical:"",UpArrow:"",DownArrow:"",RightArrow:"",LeftArrow:"\x1B",ResizeHorizontal:"",DownWedge:"",Pentagon:"\x7F",AHat:"\x83",EHat:"\x88",CapitalUUmlaut:"\x9A",Cent:"\x9B",Yen:"\x9D",CurlyF:"\x9F",NotFlip:"\xA9",Not:"\xAA",InvertedExclamation:"\xAD",Fill1:"\xB0",Fill2:"\xB1",Fill3:"\xB2",BoxVerticalSingle:"\xB3",BoxLeftSingleUpDouble:"\xBD",BoxUpSingleHorizontalSingle:"\xC1",BoxDownSingleHorizontalSingle:"\xC2",BoxHorizontalSingle:"\xC4",BoxUpDoubleHorizontalSingle:"\xD0",BoxDownSingleHorizontalDouble:"\xD1",BoxRightSingleUpDouble:"\xD3",BoxVerticalDoubleHorizontalSingle:"\xD7",Filled:"\xDB",Beta:"\xE1",Gamma:"\xE2",Pi:"\xE3",Theta:"\xE9",Omega:"\xEA",SymbolED:"\xED",SetMember:"\xEE",HorizontalDivide:"\xF6",Approximates:"\xF7",Squared:"\xFD",Square:"\xFE"},h=ua;var $a=(i=>(i[i.Effect=0]="Effect",i[i.Item=1]="Item",i[i.Ship=2]="Ship",i[i.Gun=3]="Gun",i[i.Bullet=4]="Bullet",i[i.Player=5]="Player",i[i.PlayerBullet=6]="PlayerBullet",i))($a||{}),C=$a;var Oa={components:{projectile:{damage:1,scaling:{stat:"body",multiplier:1}},appearance:{glyph:h.InvertedExclamation,layer:C.Bullet,fg:V.Colors.YELLOW}}},za={components:{projectile:{damage:1,scaling:{stat:"body",multiplier:1}},appearance:{glyph:".",layer:C.Bullet,fg:V.Colors.ORANGE}}},va={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:"o",layer:C.Bullet,fg:(0,V.fromRgb)(255,55,135)}}},Wa={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:h.Approximates,layer:C.Bullet,fg:(0,V.fromRgb)(55,55,215)}}},wa={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},appearance:{glyph:"`",layer:C.Bullet,fg:(0,V.fromRgb)(135,255,55)}}},_a={components:{projectile:{damage:6,scaling:{stat:"mind",multiplier:1}},homing:{strength:1,duration:3},appearance:{glyph:h.Square,layer:C.Bullet,fg:(0,V.fromRgb)(175,175,0)}}},de={components:{projectile:{damage:2,scaling:{stat:"mind",multiplier:1}},homing:{strength:10,duration:1},explodes:{size:7,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:V.Colors.ORANGE}}},ae={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:V.Colors.DARK_RED}}},ee={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:4},trail:{effectPrefab:"SmokePuff"},explodes:{size:8,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:V.Colors.DARK_RED}}},Le={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.25,duration:5},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:V.Colors.DARK_RED}}},Pe={components:{projectile:{damage:1,scaling:{stat:"mind",multiplier:1}},homing:{strength:.35,duration:8},trail:{effectPrefab:"SmokePuff"},explodes:{size:4,type:"Fire",falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:V.Colors.DARK_RED}}},$e={components:{projectile:{damage:20,scaling:{stat:"mind",multiplier:1}},homing:{strength:.15,duration:30},trail:{effectPrefab:"SmokePuff"},explodes:{size:6,type:"Fire",falloff:1},appearance:{glyph:h.CurlyF,layer:C.Bullet,fg:V.Colors.LIGHT_RED}}},De={components:{projectile:{damage:3,scaling:{stat:"body",multiplier:1}},appearance:{glyph:"!",layer:C.PlayerBullet,fg:V.Colors.YELLOW}}};var P0={};ed(P0,{AirFistRange:()=>ie,SmokePuff:()=>He});var Fd=I(R());var ie={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:C.Effect,bg:(0,Fd.fromRgb)(0,255,255,100),blendMode:Fd.BlendMode.Add}}},He={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:C.Effect,bg:(0,Fd.fromRgb)(100,100,100,50),blendMode:Fd.BlendMode.Add}}};var $0={};ed($0,{AcidSplash:()=>ce,Bellow:()=>Ie,Cleave:()=>fe,CrushPattern:()=>Fe,DemandHomage:()=>Qe,DroneGun:()=>Je,Outcry:()=>Xe,PeaShooter:()=>he,PlayerGun:()=>Ae,Salvo:()=>re,ShuttleLaunch:()=>pe,Smite:()=>te,TalonSwipe:()=>Ce,TheDragonWakes:()=>Re,Veto:()=>Te});var A=(a,d,e,L,P)=>({name:a,x:d,y:e,overlay:L,tags:P}),Y=(a,d,e,L=0)=>({name:a,type:d,maxHp:e,hp:0,maxShield:L,shield:0,shieldTimer:0}),M=(a,{salvoCount:d=1,timeBetweenShots:e=1,timeBetweenSalvos:L=1,ammunition:P=1/0},$)=>({name:a,shots:$,salvoCount:d,timeBetweenShots:e,timeBetweenSalvos:L,timer:0,salvo:d,ammunition:P}),X=(a,d,e,L,{canDouble:P,delay:$,offset:D,beam:i}={})=>({type:"bullet",canDouble:P,name:a,prefab:d,angle:e,vel:L,delay:$,offset:D,beam:i}),m=(a,{delay:d,offset:e}={})=>({type:"array",canDouble:!1,tag:a,delay:d,offset:e});var Bd=Math.PI/2,yd=Bd/2,Be={Right:0,DownRight:yd,Down:Bd,DownLeft:Bd+yd,Left:Bd*2,UpLeft:Bd*2+yd,Up:Bd*3,UpRight:Bd*3+yd},f=Be;function G(a){return typeof a=="undefined"?NaN:Math.floor(a)}var p=(a,d)=>({x:a,y:d});function Z(a){return p(G(a.x),G(a.y))}function v(a,d){if(typeof a=="undefined"||typeof d=="undefined")return!1;let e=Z(a),L=Z(d);return e.x===L.x&&e.y===L.y}function K(a,d){return p(a.x+d.x,a.y+d.y)}var be={Right:p(1,0),DownRight:p(1,1),Down:p(0,1),DownLeft:p(-1,1),Left:p(-1,0),UpLeft:p(-1,-1),Up:p(0,-1),UpRight:p(1,-1),None:p(0,0)},N=be;var he={components:{turret:M("Main Gun",{salvoCount:1,timeBetweenSalvos:3},[X("Bullet","Bullet",f.Down,2,{canDouble:!0})])}},Ae={components:{turret:M("Main Gun",{salvoCount:2,timeBetweenShots:0,timeBetweenSalvos:3},[X("Your Bullet","PlayerBullet",f.Up,2,{canDouble:!0})])}},fe={components:{turret:M("Cleave",{salvoCount:1,timeBetweenSalvos:11},[m("Primary"),m("Primary",{delay:1}),m("Primary",{delay:2}),m("Primary",{delay:3}),m("Primary",{delay:4})])}},Xe={components:{turret:M("Outcry",{salvoCount:1,timeBetweenSalvos:8},[X("Outcry","OutcryBullet",f.DownLeft,2),X("Outcry","OutcryBullet",f.Left,2),X("Outcry","OutcryBullet",f.UpLeft,2),X("Outcry","OutcryBullet",f.Up,2),X("Outcry","OutcryBullet",f.UpRight,2),X("Outcry","OutcryBullet",f.Right,2),X("Outcry","OutcryBullet",f.DownRight,2)])}},ce={components:{turret:M("Acid Splash",{salvoCount:1,timeBetweenSalvos:13},[X("Acid Splash","AcidBullet",f.UpLeft,2),X("Acid Splash","AcidBullet",f.UpRight,2),X("Acid Splash","AcidBullet",f.Left,2,{delay:1}),X("Acid Splash","AcidBullet",f.Right,2,{delay:1}),X("Acid Splash","AcidBullet",f.DownLeft,2,{delay:2}),X("Acid Splash","AcidBullet",f.DownRight,2,{delay:2}),X("Acid Splash","AcidBullet",f.Left,2,{delay:3}),X("Acid Splash","AcidBullet",f.Right,2,{delay:3}),X("Acid Splash","AcidBullet",f.UpLeft,2,{delay:4}),X("Acid Splash","AcidBullet",f.UpRight,2,{delay:4})])}},pe={components:{turret:M("Shuttle Launch",{salvoCount:1,timeBetweenSalvos:27},[X("Runabout","DroneA",f.Left,0,{offset:N.Left}),X("Runabout","DroneA",f.Right,0,{offset:N.Right})])}},Te={components:{turret:M("Veto",{salvoCount:1,timeBetweenSalvos:21},[X("Veto","HomingMissile",f.Up,1),X("Wasp","DroneB",f.DownRight,0,{offset:N.DownRight})])}},Ce={components:{turret:M("Talon Swipe",{salvoCount:1,timeBetweenSalvos:10},[X("Talon Swipe","TalonBullet",f.Left,2),X("Talon Swipe","TalonBullet",f.Right,2),X("Talon Swipe","TalonBullet",f.Left,2,{delay:1}),X("Talon Swipe","TalonBullet",f.Right,2,{delay:1}),X("Talon Swipe","TalonBullet",f.Left,2,{delay:2}),X("Talon Swipe","TalonBullet",f.Right,2,{delay:2})])}},Fe={components:{turret:M("Crush Pattern",{salvoCount:1,timeBetweenSalvos:15},[X("Crush Pattern","CrushBullet",f.Left,1),X("Crush Pattern","CrushBullet",f.UpLeft,1),X("Crush Pattern","CrushBullet",f.UpRight,1),X("Crush Pattern","CrushBullet",f.Right,1)])}},te={components:{turret:M("Smite",{salvoCount:1,timeBetweenSalvos:16},[X("Smite","SmiteMissile",f.Right,1),X("Smite","SmiteMissile",f.Right,1,{delay:1})])}},Je={components:{turret:M("Stinger",{salvoCount:1,timeBetweenSalvos:5,ammunition:5},[X("Bullet","DroneBullet","nearestEnemy",1,{canDouble:!0})])}},re={components:{turret:M("Salvo",{salvoCount:1,timeBetweenSalvos:10},[X("Missile","SalvoMissileA",f.UpLeft,1),X("Missile","SalvoMissileB",f.UpLeft,1),X("Missile","SalvoMissileC",f.UpLeft,1)])}},Re={components:{turret:M("The Dragon Wakes",{salvoCount:1,timeBetweenSalvos:12},[X("Drone","DroneA",f.Up,0,{offset:N.Up}),X("Missile","HomingMissile",f.DownLeft,2,{offset:N.DownLeft}),X("Missile","HomingMissile",f.DownRight,2,{offset:N.DownRight})])}},Ie={components:{turret:M("Bellow",{salvoCount:1,timeBetweenSalvos:17},[X("Bellow","BellowMissile",f.DownLeft,1),m("Primary"),m("Primary",{delay:1}),m("Primary",{delay:2}),m("Primary",{delay:3})])}},Qe={components:{turret:M("Demand Homage",{salvoCount:1,timeBetweenSalvos:21},[X("Pulsar","DroneC",f.DownLeft,0,{offset:N.DownLeft}),X("Pulsar","DroneC",f.UpLeft,0,{offset:N.UpLeft}),X("Pulsar","DroneC",f.UpRight,0,{offset:N.UpRight}),X("Pulsar","DroneC",f.DownRight,0,{offset:N.DownRight})])}};var D0={};ed(D0,{BombItem:()=>Me,DoubleItem:()=>Ee,DrainItem:()=>Se,HealItem:()=>ne,JunkItem:()=>Ue,MoneyItem:()=>Ye,RechargeItem:()=>je});var Me={components:{appearance:{glyph:h.DoubleNote,layer:C.Item},item:{type:"bomb",prefab:"BombItem"}}},Ee={components:{appearance:{glyph:h.Squared,layer:C.Item},item:{type:"double"}}},Se={components:{appearance:{glyph:"%",layer:C.Item},item:{type:"drain"}}},ne={components:{appearance:{glyph:h.Heart,layer:C.Item},item:{type:"heal"}}},Ue={components:{appearance:{glyph:h.Beta,layer:C.Item},item:{type:"junk"}}},Ye={components:{appearance:{glyph:h.SetMember,layer:C.Item},item:{type:"money",value:0}}},je={components:{appearance:{glyph:"@",layer:C.Item},item:{type:"recharge"}}};var H0={};ed(H0,{PlayerHull:()=>Ke,PlayerShip:()=>xe});var i0=I(R());var Ke={components:{solid:!0,appearance:{glyph:"#",layer:C.Player,fg:i0.Colors.DARK_GRAY}}},xe={components:{player:{weaponArrays:["Primary","Secondary"],bombs:[]},ship:Y("Ace of Clubs","Player",20,10),explodes:{type:"Fire",size:6,falloff:1}},children:[A("PlayerHull",0,0,{appearance:{glyph:h.LeftArrow}}),A("PlayerHull",1,0,{appearance:{glyph:h.Club,fg:i0.Colors.LIGHT_GRAY}}),A("PlayerHull",2,0,{appearance:{glyph:h.RightArrow}}),A("PlayerGun",1,0,void 0,["Primary"]),A("Sword",1,0,void 0,["Secondary"])]};var h0={};ed(h0,{AtomSmasher:()=>we,CruiseyWing:()=>ue,Demigod:()=>ve,DroneA:()=>oe,DroneB:()=>ye,DroneC:()=>Ge,GoutOFlame:()=>ze,Gremlin:()=>We,Hull:()=>le,Olm:()=>Oe,ShipA:()=>Ze,ShipB:()=>se,ShipC:()=>Ve,ShipD:()=>Ne,ShipE:()=>qe,ShipF:()=>ke,ShipG:()=>ge,ShipH:()=>me});var Da=I(R());var le={components:{solid:!0,appearance:{glyph:"#",layer:C.Ship,fg:Da.Colors.DARK_GRAY}}},k={idealDistance:8,firingDistance:14,speed:1},W=A("PeaShooter",0,0,void 0,["Primary"]),Ld={type:"Fire",size:4,falloff:1},Ze={components:{ai:k,ship:Y("Axle","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:h.Pilcrow}}),W,A("Cleave",0,0,void 0,["Special"])]},se={components:{ai:k,ship:Y("Baying Hound","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:h.Yen}}),W,A("Outcry",0,0,void 0,["Special"])]},Ve={components:{ai:k,ship:Y("Caustic","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:"W"}}),W,A("AcidSplash",0,0,void 0,["Special"])]},Ne={components:{ai:k,ship:Y("Defiant","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:h.Omega}}),W,A("ShuttleLaunch",0,0,void 0,["Special"])]},qe={components:{ai:k,ship:Y("Executor","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:h.DownWedge}}),W,A("Veto",0,0,void 0,["Special"])]},ke={components:{ai:k,ship:Y("Falcon","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:h.Pi}}),W,A("TalonSwipe",0,0,void 0,["Special"])]},ge={components:{ai:k,ship:Y("Gauntlet","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:"M"}}),W,A("CrushPattern",0,0,void 0,["Special"])]},me={components:{ai:k,ship:Y("Halo","Escort",2),explodes:Ld},children:[A("Hull",0,0,{appearance:{glyph:h.Female}}),W,A("Smite",0,0,void 0,["Special"])]},B0={idealDistance:5,firingDistance:6,speed:1},ia=A("DroneGun",0,0,void 0,["Primary"]),b0={type:"Fire",size:3,falloff:1},oe={components:{ai:B0,ship:Y("Runabout","Escort",1),explodes:b0},children:[A("Hull",0,0,{appearance:{glyph:h.Theta}}),W]},ye={components:{ai:B0,ship:Y("Wasp","Escort",1),explodes:b0},children:[A("Hull",0,0,{appearance:{glyph:h.SymbolED}}),ia]},Ge={components:{ai:B0,ship:Y("Pulsar","Escort",1),explodes:b0},children:[A("Hull",0,0,{appearance:{glyph:h.Silcrow}}),ia]},td={type:"Fire",size:6,falloff:1},ue={components:{ai:k,ship:Y("Cruisey Wing","Battleship",10,5),explodes:td},children:[A("Hull",0,0,{appearance:{glyph:h.Not}}),A("Hull",1,0,{appearance:{glyph:h.HorizontalDivide}}),A("Hull",2,0,{appearance:{glyph:h.NotFlip}}),A("PeaShooter",0,0,void 0,["Primary"]),A("PeaShooter",1,0,void 0,["Primary"]),A("PeaShooter",2,0,void 0,["Primary"]),A("Salvo",1,0,void 0,["Special"])]},Oe={components:{ai:k,ship:Y("Olm","Battleship",15,4),explodes:td},children:[A("Hull",0,0,{appearance:{glyph:h.Cent}}),A("Hull",0,1,{appearance:{glyph:h.ResizeVertical}}),A("Hull",0,2,{appearance:{glyph:h.BoxDownSingleHorizontalDouble}}),A("PeaShooter",0,2,void 0,["Primary"]),A("TheDragonWakes",0,0,void 0,["Special"])]},ze={components:{ai:k,ship:Y("Gout-o'-flame","Battleship",5,20),explodes:td},children:[A("Hull",0,0,{appearance:{glyph:h.Pentagon}}),A("Hull",1,0,{appearance:{glyph:h.BoxVerticalDoubleHorizontalSingle}}),A("Hull",2,0,{appearance:{glyph:h.Pentagon}}),A("Hull",1,1,{appearance:{glyph:h.BoxUpDoubleHorizontalSingle}}),A("PeaShooter",1,1,void 0,["Primary"]),A("Bellow",1,1,void 0,["Special"])]},ve={components:{ai:k,ship:Y("Demigod","Battleship",30,15),explodes:td},children:[A("Hull",1,0,{appearance:{glyph:h.CapitalUUmlaut}}),A("Hull",0,1,{appearance:{glyph:"}"}}),A("Hull",1,1,{appearance:{glyph:h.RingInvert}}),A("Hull",2,1,{appearance:{glyph:"{"}}),A("Hull",1,2,{appearance:{glyph:"Y"}}),A("PeaShooter",1,2,void 0,["Primary"]),A("DemandHomage",1,1,void 0,["Special"])]},We={components:{ai:k,ship:Y("Gremlin","Battleship",30,15),explodes:td},children:[A("Hull",1,0,{appearance:{glyph:h.ResizeVertical}}),A("Hull",2,0,{appearance:{glyph:h.ResizeVertical}}),A("Hull",0,1,{appearance:{glyph:"]"}}),A("Hull",1,1,{appearance:{glyph:h.BoxLeftSingleUpDouble}}),A("Hull",2,1,{appearance:{glyph:h.BoxRightSingleUpDouble}}),A("Hull",3,1,{appearance:{glyph:h.Male}}),A("Hull",1,2,{appearance:{glyph:h.BoxVerticalSingle}}),A("Hull",2,2,{appearance:{glyph:h.Gamma}}),A("PeaShooter",1,2,void 0,["Primary"]),A("PeaShooter",2,2,void 0,["Primary"])]},we={components:{ai:k,ship:Y("Atom Smasher","Battleship",10,20),explodes:td},children:[A("Hull",1,0,{appearance:{glyph:h.EHat}}),A("Hull",2,0,{appearance:{glyph:"-"}}),A("Hull",3,0,{appearance:{glyph:h.AHat}}),A("Hull",0,1,{appearance:{glyph:h.Fill2}}),A("Hull",1,1,{appearance:{glyph:h.Fill1}}),A("Hull",2,1,{appearance:{glyph:h.Fill2}}),A("Hull",3,1,{appearance:{glyph:h.Fill3}}),A("Hull",4,1,{appearance:{glyph:h.Filled}}),A("PeaShooter",0,1,void 0,["Primary"]),A("PeaShooter",1,1,void 0,["Primary"]),A("PeaShooter",2,1,void 0,["Primary"]),A("PeaShooter",3,1,void 0,["Primary"]),A("PeaShooter",4,1,void 0,["Primary"])]};var A0={};ed(A0,{Laser:()=>eL,LaserBeam:()=>LL,Multiball:()=>dL,MultiballShot:()=>_e,Overload:()=>BL,OverloadBullet:()=>HL,StubbornDescent:()=>aL,SwitchbladeBullet:()=>PL,Switchblades:()=>$L,Triangulate:()=>iL,TriangulateMissile:()=>DL});var Pd=I(R());function bd(a,d=0){let e=[];for(let L=d;L<a;L++)e.push(L);return e}var _e={components:{projectile:{damage:7},appearance:{glyph:"+",layer:C.Bullet,fg:(0,Pd.fromRgb)(255,255,55)}}},dL={components:{turret:M("Multiball",{salvoCount:1,timeBetweenSalvos:15},[X("Multiball","MultiballShot",f.DownLeft,2),X("Multiball","MultiballShot",f.Left,2),X("Multiball","MultiballShot",f.Right,2),X("Multiball","MultiballShot",f.DownRight,2),X("Runabout","DroneA",f.UpLeft,0,{offset:N.UpLeft}),X("Runabout","DroneA",f.UpRight,0,{offset:N.UpRight})])}},aL={components:{turret:M("Stubborn Descent",{salvoCount:13,timeBetweenSalvos:21},[m("Primary")])}},eL={components:{projectile:{damage:2},appearance:{glyph:"|",layer:C.Bullet,fg:Pd.Colors.WHITE,bg:Pd.Colors.LIGHT_BLUE}}},LL={components:{turret:M("Laser Beam",{salvoCount:10,timeBetweenSalvos:30},[X("Laser","Laser",f.Down,1,{offset:N.Down,beam:{duration:1,appearance:new Array(60)}})])}},PL={components:{projectile:{damage:9},appearance:{glyph:h.ResizeHorizontal,layer:C.Bullet,fg:Pd.Colors.LIGHT_BLUE}}},$L={components:{turret:M("Switchblades",{salvoCount:1,timeBetweenSalvos:11},[...bd(9).map(a=>X("Switchblade","SwitchbladeBullet",f.DownLeft,1,{delay:a})),...bd(9).map(a=>X("Switchblade","SwitchbladeBullet",f.DownRight,1,{delay:a}))])}},DL={components:{projectile:{damage:10},homing:{strength:.1,duration:1/0},explodes:{type:"Blue",size:4,falloff:1},appearance:{glyph:"*",layer:C.Bullet,fg:Pd.Colors.DARK_CYAN}}},iL={components:{turret:M("Triangulate",{salvoCount:1,timeBetweenSalvos:17},[X("Triangulate","TriangulateMissile",f.DownLeft,1),X("Triangulate","TriangulateMissile",f.Left,1,{delay:1}),X("Triangulate","TriangulateMissile",f.UpLeft,1,{delay:2}),X("Triangulate","TriangulateMissile",f.Up,1,{delay:3}),X("Triangulate","TriangulateMissile",f.UpRight,1,{delay:4}),X("Triangulate","TriangulateMissile",f.Right,1,{delay:5}),X("Triangulate","TriangulateMissile",f.DownRight,1,{delay:6})])}},HL={components:{projectile:{damage:7},appearance:{glyph:h.Smiley,layer:C.Bullet,fg:Pd.Colors.LIGHT_GRAY}}},BL={components:{turret:M("Overload",{salvoCount:1,timeBetweenSalvos:20},bd(11).map(a=>X("Overload","OverloadBullet","random",2,{delay:a})))}};var f0={};ed(f0,{Sword:()=>hL,SwordBullet:()=>bL});var hd=I(R());var bL={components:{projectile:{damage:5,special:"increasedDropChance",scaling:{stat:"spirit",multiplier:1}},appearance:{glyph:h.Star,layer:C.PlayerBullet,fg:hd.Colors.LIGHT_GREEN}}},hL={components:{turret:M("Sword",{salvoCount:1,timeBetweenSalvos:20},[X("Stab","SwordBullet","lastMovement",1,{beam:{duration:2,appearance:[{glyph:h.Star,fg:hd.Colors.LIGHT_GREEN},{glyph:"o",fg:hd.Colors.LIGHT_GREEN},{glyph:h.Diamond,fg:hd.Colors.LIGHT_GREEN},{glyph:h.Ring,fg:hd.Colors.DARK_GREEN},{glyph:h.Dot,fg:hd.Colors.DARK_GRAY}]}})])}};var Ha=s(s(s(s(s(s(s(s({},L0),P0),D0),$0),H0),h0),A0),f0);function Gd(a){return Ha[a]}function X0(a,d){return a.add(new Hd(a,d).applyPrefab(d,Ha[d]))}var Ba=["Cleave","Outcry","AcidSplash","ShuttleLaunch","Veto","TalonSwipe","CrushPattern","Smite","Salvo","TheDragonWakes","Bellow","DemandHomage","Multiball","StubbornDescent","Switchblades","Triangulate","Overload"];var Sd=class{constructor(d,e=[]){this.compareFn=d;this.entities=e;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}clearExceptFor(d){for(let e of this.entities)d.includes(e.id)||(e.alive=!1);this.clearDead()}add(d){this.entities.push(d),this.dirty=!0}clearDead(){this.entities=this.entities.filter(d=>d.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var S=I(R());var g=I(R());var j=I(R());function AL(a,d){if(!d||!a.length)throw new Error("Could not get midpoint");let e=L=>a.reduce((P,{offset:$})=>P+$[L],0)/a.length;return p(d.x+e("x"),d.y+e("y"))}function fL(a,d,e,L=[]){let P=[];for(let{offset:$}of d){let D=K(e,$),{oob:i,wall:H,solid:b}=a.getContents(D,L);i?P.push({absolute:D,offset:$,entity:"oob"}):H?P.push({absolute:D,offset:$,entity:"wall"}):b&&P.push({absolute:D,offset:$,entity:b})}return P}function n(a,d){let e=a.getRoot(d);return a.entities.get().filter(L=>a.getRoot(L)===e)}function w(a,d){return n(a,d).map(e=>e.id)}function u(a,d){var i;let e=(i=a.getRoot(d).position)!=null?i:p(0,0),L=n(a,d),P=[],$=0,D=0;for(let H of L){let{attachment:b,solid:B}=H;if(b&&B){let{x:c,y:r}=b;P.push({absolute:K(e,b),offset:{x:c,y:r},entity:H}),$=Math.max(c+1,$),D=Math.max(r+1,D)}}return{layout:P,topLeft:e,width:$,height:D}}function ba(a,d,e){let L=w(a,d),{layout:P,topLeft:$}=u(a,d);return!e||!$?[]:fL(a,P,e||$,L)}function l(a,d){let{layout:e,topLeft:L}=u(a,d);if(!L||!e.length){if(d.position)return d.position;throw new Error(`Could not get midpoint of entity#${d.id}`)}return AL(e,L)}function ha(a,d,e,L,P){for(let $=0;$<P;$++)for(let D=0;D<L;D++){let{oob:i,wall:H,solid:b,other:B}=a.getContents({x:d+D,y:e+$});if(i||H||b||B.length)return!1}return!0}var E=class{constructor(d,e){this.list=d;this.filter=e}matches(d){if(!d.alive)return!1;for(let e of this.filter)if(!d[e])return!1;return!0}forEach(d){for(let e of this.list.get())this.matches(e)&&d(e,e)}};var c0=Math.PI*2;function $d(a,d){return Math.atan2(d.y-a.y,d.x-a.x)}function Aa(a,d){let e=(a-d)%c0,L=(d-a)%c0;return e<L?-e:L}function Dd(a){let d=Math.cos(a.angle)*a.vel,e=Math.sin(a.angle)*a.vel;return[d,e]}function fa(a){for(;a<0;)a+=c0;return a}var Ma=I(R());function Ad(a,d){let e=Math.abs(a.x-d.x),L=Math.abs(a.y-d.y);return Math.sqrt(e*e+L*L)}function ud(a,d,e){let{ship:L}=d;if(!L)throw new Error(`Cannot put pilot into entity ${d.name} (no ship)`);if(d.setPilot(e),L.maxHp+=XL(d),e.special){let P=l(a,d);a.spawn(e.special).setAttachment(w0(s({},Z(P)),{parent:d})).tags.add("Special")}}function Jd(a,d){return a.pilot?a.pilot[d]:0}function Xa(a){return 7-Jd(a,"body")}function XL(a){return Jd(a,"body")*4}function ca(a){return Jd(a,"mind")}function pa(a){return(Jd(a,"mind")-1)*5}var Ta=($=>($[$.None=0]="None",$[$.Healthy=1]="Healthy",$[$.Double=2]="Double",$[$.Drain=4]="Drain",$[$.HasPilot=8]="HasPilot",$))(Ta||{}),x=Ta;var Ca=["Berserker","Chopter","Duelist","Engineer","Fighter","Negotiator","Psychic","Smuggler"];var q=I(R()),Od=[0,q.Colors.DARK_RED,q.Colors.BROWN,q.Colors.LIGHT_RED,q.Colors.ORANGE,q.Colors.YELLOW,q.Colors.WHITE],_={Typical:{fg:q.Colors.DARK_GRAY},Healthy:{fg:q.Colors.DARK_GREEN},Double:{fg:q.Colors.LIGHT_GRAY},Multi:{fg:q.Colors.DARK_MAGENTA},Drain:{fg:q.Colors.DARK_RED},StarPilot:{fg:q.Colors.YELLOW},Mega:{fg:q.Colors.BLACK,bg:q.Colors.DARK_MAGENTA}};function fd(a){return Math.random()*100<a}function U(a){if(!a.length)throw new Error("oneOf passed empty array");return a[Math.floor(Math.random()*a.length)]}function rd(a){for(let d=a.length-1;d>0;d--){let e=Math.floor(Math.random()*(d+1));[a[d],a[e]]=[a[e],a[d]]}return a}function zd(a,...d){return a.filter(e=>!d.includes(e))}var C0={Typical:x.None,Healthy:x.Healthy,Double:x.Double,Multi:x.Healthy|x.Double,Drain:x.Drain,StarPilot:x.HasPilot,Mega:x.Healthy|x.Double|x.Drain|x.HasPilot},cL={Typical:"Fire",Healthy:"Green",Double:"Fire",Multi:"Magenta",Drain:"Fire",StarPilot:"Yellow",Mega:"Magenta"},p0=["ShipA","ShipB","ShipC","ShipD","ShipE","ShipF","ShipG","ShipH"],T0=["CruiseyWing","Olm","GoutOFlame","Demigod","Gremlin","AtomSmasher"],pL=[{name:"Let Fate Decide",difficulty:1,groups:[{count:7,type:"Escort",prefabs:p0},{count:1,type:"Battleship",prefabs:T0}]},{name:"Court Martial",difficulty:2,groups:[{count:5,type:"Escort",prefabs:["ShipA","ShipE"]},{count:1,type:"Battleship",prefabs:["CruiseyWing"]}]},{name:"Hellhounds",difficulty:3,groups:[{count:2,type:"Escort",prefabs:["ShipB"]},{count:2,type:"Battleship",prefabs:["GoutOFlame"]}]},{name:"Chaos",difficulty:4,groups:[{count:4,type:"Escort",prefabs:["ShipC"]},{count:4,type:"Escort",prefabs:zd(p0,"ShipC")},{count:1,type:"Battleship",prefabs:["Demigod"]}]},{name:"Fly in Formation",difficulty:4,groups:[{count:7,type:"Escort",prefabs:["ShipF"]},{count:1,type:"Battleship",prefabs:T0}]},{name:"Hark!",difficulty:6,groups:[{count:3,type:"Escort",prefabs:["ShipH"]},{count:3,type:"Escort",prefabs:zd(p0,"ShipH")},{count:1,type:"Battleship",prefabs:["Demigod"]}]},{name:"Caverns.com",difficulty:7,groups:[{count:1,type:"Escort",prefabs:["ShipA","ShipG"]},{count:3,type:"Battleship",prefabs:["Olm"]}]},{name:"Humanity to the Rescue",difficulty:8,groups:[{count:7,type:"Escort",prefabs:["ShipA","ShipD","ShipE","ShipG"]},{count:1,type:"Battleship",prefabs:["GoutOFlame"]}]},{name:"Wild Hunt",difficulty:9,groups:[{count:15,type:"Escort",prefabs:["ShipB","ShipF"]},{count:1,type:"Battleship",prefabs:["Olm"]}]},{name:"Arm Wrestling",difficulty:10,groups:[{count:9,type:"Escort",prefabs:["ShipG"]},{count:2,type:"Battleship",prefabs:["CruiseyWing"]}]},{name:"Valis",difficulty:11,groups:[{count:4,type:"Escort",prefabs:["ShipC"]},{count:4,type:"Escort",prefabs:["ShipH"]},{count:1,type:"Battleship",prefabs:T0}]}];function Fa(a=3){return rd(pL.slice()).slice(0,a).sort((d,e)=>d.difficulty-e.difficulty)}function ta(a,d){return fd(a)?d?"Mega":U(["Healthy","Double","Multi","Drain"]):d?"StarPilot":"Typical"}function TL(a){let d=y(a);for(;d.class.length<d.talent;)d.class.push(U(Ca.filter(e=>!d.class.includes(e))));return d}function Ja(a,d,e,L){let P=C0[e];if(P&x.HasPilot&&!L)throw new Error(`power ${e} needs pilot, none given`);let $=a.spawn(d),{ship:D}=$;if(!D)throw new Error(`Ship prefab ${d} doesn't have a ship component!`);if(D.power=e,P&x.Healthy&&(D.maxHp=D.maxHp*2+3),L){let H=TL(L);ud(a,$,H)}nd(D);let i=_[e];for(let H of n(a,$))H.appearance&&Object.assign(H.appearance,i);return P&x.Double&&$.setDoubleShot({duration:1/0}),$.explodes&&($.explodes.type=cL[e]),$}function ra(a,d){let{width:e,height:L}=u(a,d);for(let P=0;P<a.term.height;P++){let $=rd(bd(a.term.width-e));for(let D of $)if(ha(a,D,P,e,L))return{x:D,y:P}}throw new Error(`Could not find ${e}x${L} spawn location`)}function nd(a){a.hp=a.maxHp,a.shield=a.maxShield}function F0(a){return a.salvo<=0?a.ammunition<=0?"Spent":"Reloading":a.timer>0?"Chambering":"Ready"}function vd(a){a.timer>0&&(a.timer--,a.timer<=0&&a.salvo<=0&&(a.ammunition?(a.salvo=Math.min(a.salvoCount,a.ammunition),a.ammunition-=a.salvo):a.timer=1/0))}function Wd(a,d){return a.shots.find(e=>e.type==="bullet"&&e.angle==="lastMovement")&&!d.lastMovement?!1:a.timer===0}function Ra(a,d){var L;let e=(L=a.delayedShot)!=null?L:{shots:[]};e.shots.push(d),a.setDelayedShot(e)}function Ia(a,d,e,L,P,$,D,i,H,b){var c;let B=a.spawn(e).setIgnoreSolid({ids:H}).move($.x,$.y);return B.name=d,i&&B.setMotion({angle:D,vel:i}),B.ship&&nd(B.ship),L.ship&&B.setOrigin({owner:L,ship:L.ship,turret:P}),(c=B.projectile)!=null&&c.scaling&&(B.projectile.damage+=Math.floor(Jd(L,B.projectile.scaling.stat)*B.projectile.scaling.multiplier)),B.appearance&&b&&Object.assign(B.appearance,b),B}function t0(a,d,e,L,P,$,D){var T;if($.doubleShot&&d.canDouble){let J=y(d);J.canDouble=!1,J.delay=$.player?2:1,J.appearance={fg:Ma.Colors.LIGHT_GRAY},Ra($,{turret:e,shot:J})}if(d.delay){let J=y(d);return $.player&&J.delay++,Ra($,{turret:e,shot:J}),[]}if(d.type==="array"){let J=[];for(let Q of n(a,$).filter(ad=>ad.tags.has(d.tag)))Q.position&&Q.turret&&J.push(...Rd(a,Q.turret,K(Q.position,(T=d.offset)!=null?T:p(0,0)),P,$,D));return J}let{angle:i,beam:H,name:b,offset:B,prefab:c,vel:r}=d,F=K(L,B!=null?B:p(.5,.5)),t=i==="nearestEnemy"?$d(F,P):i==="lastMovement"?$.lastMovement.angle:i==="random"?U([f.DownLeft,f.Left,f.UpLeft,f.Up,f.UpRight,f.Right,f.DownRight]):i;if(H&&r){let[J,Q]=Dd({angle:t,vel:r}),ad=p(J,Q),md=K(F,ad);return H.appearance.map(O0=>{let Md=Ia(a,b,c,$,e,md,t,0,D,d.appearance).setMotion({angle:t,vel:0}).setLifetime({duration:H.duration});return Md.appearance&&O0&&Object.assign(Md.appearance,O0),$.ship&&Md.setOrigin({owner:$,ship:$.ship,turret:e}),a.inBounds(md)||Md.kill({type:"exitedMap"}),md=K(md,ad),Md})}return[Ia(a,b,c,$,e,F,t,r,D,d.appearance)]}function Rd(a,d,e,L,P,$){let{timeBetweenSalvos:D,timeBetweenShots:i}=d;--d.salvo<=0?d.timer=D:d.timer=i;let H=[];for(let b of d.shots)H.push(...t0(a,b,d,e,L,P,$));return H}function Qa(a){return(a==null?void 0:a.type)==="Player"}function wd(a,d){let e=Qa(d.ship),L=l(a,d),P=a.entities.get().filter(i=>i.ship&&Qa(i.ship)!==e);if(!P.length)return;let $=1/0,D;for(let i of P){let H=l(a,i),b=Ad(L,H);b<$&&($=b,D=i)}return D}var J0=[p(-1,-1),p(-1,0),p(-1,1),p(0,1),p(1,1),p(1,0),p(1,-1),p(0,-1)];function r0(a){return J0.map(d=>K(a,d))}function R0(a){let d=new E(a.entities,["ai","position","ship"]);a.on("tick",function(){d.forEach(({ai:L,position:P},$)=>{if($.setLastMovement(),!L.attacking||!L.attacking.alive){let T=wd(a,$);if(T)L.attacking=T,a.fire("notice",{e:$,noticed:T});else return}let D=w(a,$),{layout:i}=u(a,$),H=Z(P),b=a.getDistanceMap(L.attacking),B=T=>{let{oob:J,solid:Q,wall:ad}=a.getContents(T,D);return!J&&!Q&&!ad},c=T=>B(T)?Math.abs(b.getOrDefault(T,1/0)-L.idealDistance):1/0,r=T=>i.reduce((J,{offset:Q})=>J+c(K(T,Q)),0)/i.length,F=r(H),t=[];for(let T of J0){let J=K(H,T);if(!b.has(J))continue;let Q=r(J);Q<F?(F=Q,t=[J]):Q===F&&t.push(J)}if(t.length){let T=U(t);$.move(T.x,T.y),$.setLastMovement({angle:$d(H,T)});return}})}),a.on("damage",function({e:L,source:P}){P.owner&&L!==P.owner&&L.ai&&!L.ai.attacking&&P.owner.alive&&(L.ai.attacking=P.owner)})}function I0(a){let d=new E(a.entities,["delayedShot"]);a.on("tick",function(){d.forEach(({ai:L,delayedShot:P},$)=>{var D,i;if(!$.alive){$.setDelayedShot();return}for(let H=P.shots.length-1;H>=0;H--){let{turret:b,shot:B}=P.shots[H];if(--B.delay<=0){B.delay=0,P.shots.splice(H,1);let c=n(a,$),r=c.find(T=>T.turret===b),F=(D=r==null?void 0:r.position)!=null?D:l(a,$),t=(i=L==null?void 0:L.attacking)!=null&&i.alive?l(a,L.attacking):p(0,0);t0(a,B,b,F,t,$,c.map(T=>T.id))}}P.shots.length||$.setDelayedShot()})})}function Q0(a){let d=new E(a.entities,["appearance","position"]);a.on("draw",function(){d.forEach(({appearance:L,position:P})=>a.drawIfVisible(G(P.x),G(P.y),L.glyph,L.fg,L.bg,L.blendMode))})}function M0(a){a.on("kill",function({e,reason:L}){var D;let{position:P,ship:$}=e;if(P&&($!=null&&$.power)&&L.type==="damage"){let i=C0[$.power],H=((D=L.source.e.projectile)==null?void 0:D.special)==="increasedDropChance",b=$.type==="Battleship"?H?92:42:H?32:2,B=(t=1)=>fd(b*t),c=[];i&x.Double&&B()&&c.push("DoubleItem"),i&x.Drain&&B()&&c.push("DrainItem"),i&x.Healthy&&B()&&c.push("HealItem"),B()&&c.push("MoneyItem"),B()&&c.push("JunkItem"),B()&&c.push("RechargeItem");let r;if(B()){let t=n(a,e).filter(T=>T.tags.has("Special")&&T.prefab&&T.turret);t.length&&(r=U(t).prefab,c.push("BombItem"))}let F=rd([p(-1,-1),p(0,-1),p(1,-1),p(-1,0),p(0,0),p(1,0),p(-1,1),p(0,1),p(1,1)]);for(let t of c){let T=K(P,F.pop()),J=a.spawn(t).move(T.x,T.y).setMotion({angle:f.Down,vel:1});t==="BombItem"&&J.setItem({type:"bomb",prefab:r})}}})}var Ea=I(R());var _d=I(R());function Id(a,d,e){return a*(1-e)+d*e}var dd=class{constructor(d){this.points=d;this.sort()}sort(){this.points.sort(([d],[e])=>d-e)}add(d,e){return this.points.push([d,e]),this.sort(),this}get(d){let[e,L]=this.points[0];if(d<=e)return(0,_d.fromRgb)(...L);let[P,$]=this.points[this.points.length-1];if(d>=P)return(0,_d.fromRgb)(...$);let D=this.points.findIndex(([ad])=>ad>d),[i,[H,b,B,c]]=this.points[D-1],[r,[F,t,T,J]]=this.points[D],Q=(d-i)/(r-i);return(0,_d.fromRgb)(Id(H,F,Q),Id(b,t,Q),Id(B,T,Q),Id(c,J,Q))}};var CL={Fire:new dd([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Blue:new dd([[0,[0,0,0,0]],[2,[0,0,255,150]],[4,[0,155,255,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Yellow:new dd([[0,[0,0,0,0]],[2,[155,155,0,150]],[4,[255,255,55,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]]),Green:new dd([[0,[0,0,0,0]],[2,[0,215,0,150]],[4,[55,255,55,150]],[6,[215,255,215,150]],[10,[255,255,255,255]]]),Magenta:new dd([[0,[0,0,0,0]],[2,[155,0,115,150]],[4,[255,115,255,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function E0(a){if(!(a.intensity<=0))return{glyph:" ",layer:C.Effect,bg:CL[a.type].get(a.intensity),blendMode:Ea.BlendMode.Add}}function Sa(a,d){let e=[],L=Math.floor(a.x-d),P=Math.ceil(a.x+d),$=Math.floor(a.y-d),D=Math.ceil(a.y+d);for(let i=$;i<=D;i++)for(let H=L;H<=P;H++){let b=Ad(a,{x:H,y:i});b>=d||e.push({x:H,y:i,intensity:d-b})}return e}function S0(a){a.on("kill",function({e,reason:L}){if(L.type==="exitedMap")return;let{explodes:P,name:$,position:D}=e;if(P&&D)for(let{x:i,y:H,intensity:b}of Sa(l(a,e),P.size))a.add(new Hd(a,$+"Explosion").setPosition({x:i,y:H}).setField({type:P.type,intensity:b,falloff:P.falloff}))})}function Ud(a,d,e,L){var i;let P=a.getRoot(d);if(!P.ship)return;P.ship.type!=="Player"&&((i=L.origin)==null?void 0:i.ship.type)!=="Player"&&(e=Math.ceil(e/2));let $=e;P.ship.shield>0&&(P.ship.shield>e?(P.ship.shield-=e,$=0):($-=P.ship.shield,P.ship.shield=0)),$&&(P.ship.hp-=$);let D={e:L,owner:L};L.origin&&(D.owner=L.origin.owner,D.ship=L.origin.ship,D.turret=L.origin.turret),console.log(`${L.name}${L.origin?` (${L.origin.owner.name} #${L.origin.owner.id})`:""} hits ${P.name} for ${e}`),a.fire("damage",{e:P,amount:e,source:D}),P.ship.hp<=0&&a.kill(P,{type:"damage",source:D})}function n0(a){let d=new E(a.entities,["ship"]),e=new E(a.entities,["field","position"]);a.on("tick",function(){e.forEach(({field:P,position:$},D)=>{P.intensity-=P.falloff,D.setAppearance(E0(P)),P.intensity<1?a.kill(D,{type:"expired"}):d.forEach((i,H)=>{let{layout:b}=u(a,H);b.find(({absolute:c})=>v(c,$))&&Ud(a,H,Math.floor(P.intensity),D)})})}),a.on("spawn",function({e:P}){P.field&&P.setAppearance(E0(P.field))})}var na=I(R());var Yd=class{constructor(d,e){this.g=d;this.player=e;this.lines=e.bombs.map(L=>Gd(L).components.turret.name),this.width=this.lines.reduce((L,P)=>Math.max(L,P.length),0),this.height=this.lines.length}draw(d,e){for(let L of this.lines)this.g.term.drawString(d,e++,L,na.Colors.WHITE)}};var z=I(R());var jd=I(R());var Xd=class{constructor(d,e,L){this.g=d;this.pilot=e;this.full=L;this.width=11,this.height=L?2+e.class.length:1}get isPlayer(){return this.pilot.player}draw(d,e){if(this.full&&(this.g.term.drawString(d,e,this.pilot.name,this.pilot.star?jd.Colors.YELLOW:jd.Colors.LIGHT_GRAY),e++),this.drawStat(d,e,"body"),this.drawStat(d+3,e,"mind"),this.drawStat(d+6,e,"spirit"),this.drawStat(d+9,e,"talent"),!!this.full)for(let L of this.pilot.class)this.g.term.drawString(d,++e,L,jd.Colors.LIGHT_GREEN)}drawStat(d,e,L){let P=this.pilot[L];this.g.term.drawChar(d,e,L[0].toUpperCase(),jd.Colors.WHITE),this.g.term.drawChar(d+1,e,P.toString(),Od[P])}};var O=I(R());function U0(a,d,e,L,P,$,D,i,H){let b=`${Math.ceil(P)}/${$}`,B=Math.floor(P/$*L);a.drawHLine(d,e,L," ",void 0,i),B&&a.drawHLine(d,e,B," ",void 0,D),a.drawCenteredString(d+L/2,e,b,H)}var cd=class{constructor(d,e){this.g=d;this.ship=e;this.width=Math.max(13,e.name.length),this.height=e.maxShield?3:2}draw(d,e){let{ship:L,width:P}=this,{term:$}=this.g,D=P-3;$.drawString(d,e,L.name,O.Colors.WHITE),$.drawString(d,e+1,"HP:",O.Colors.WHITE),U0($,d+3,e+1,D,L.hp,L.maxHp,O.Colors.DARK_GREEN,O.Colors.DARK_RED,O.Colors.WHITE),L.maxShield&&($.drawString(d,e+2,"Sh:",O.Colors.WHITE),U0($,d+3,e+2,D,L.shield,L.maxShield,O.Colors.DARK_CYAN,O.Colors.LIGHT_BLUE,O.Colors.WHITE))}};var pd=I(R());var FL={Spent:pd.Colors.DARK_GRAY,Reloading:pd.Colors.LIGHT_RED,Ready:pd.Colors.YELLOW,Chambering:pd.Colors.BROWN},Td=class{constructor(d,e){this.g=d;this.turret=e;this.width=Math.max(e.name.length,this.stateLabel.length),this.height=2,e.ammunition>0&&e.ammunition<1/0&&this.height++}get stateLabel(){let{timer:d,salvo:e,salvoCount:L}=this.turret,P=F0(this.turret);if(P==="Spent")return"Out of Ammo";if(P==="Reloading")return`Reloading (${d})`;let $=`${e}/${L}`;return P==="Ready"?$:`${$} (${d})`}draw(d,e){this.g.term.drawString(d,e,this.turret.name,pd.Colors.WHITE);let L=F0(this.turret);this.g.term.drawString(d,e+1,this.stateLabel,FL[L]),this.height>2&&this.g.term.drawString(d,e+2,`${this.turret.ammunition} ammo left`,pd.Colors.LIGHT_GRAY)}};var id=6;function Y0(a){let{mapHeight:d,term:e}=a;a.on("draw",function(){let P=a.player,{pilot:$,player:D,ship:i}=P;e.fillRect(0,d,e.width,id," ",z.Colors.WHITE,z.Colors.BLACK),e.drawSingleBox(0,d,e.width,id);let H=1,b=d+1,B=new cd(a,i);B.draw(H,b);let c=H+Math.floor((B.width-11)/2);new Xd(a,$,!1).draw(c,b+3),H+=B.width+1,e.drawChar(H-1,b-1,h.BoxDownSingleHorizontalSingle,z.Colors.WHITE),e.drawVLine(H-1,b,id-2,h.BoxVerticalSingle,z.Colors.WHITE),e.drawChar(H-1,b+id-2,h.BoxUpSingleHorizontalSingle,z.Colors.WHITE);for(let F of D.weaponArrays){let t=H,T=n(a,P).filter(J=>J.turret&&J.tags.has(F));for(let J of T){let Q=new Td(a,J.turret);Q.draw(H,b+1),H+=Q.width+1}e.drawString(t,b,F,z.Colors.LIGHT_CYAN),H=Math.max(H,t+F.length+1)}D.bombs.length&&(e.drawChar(H-1,b-1,h.BoxDownSingleHorizontalSingle,z.Colors.WHITE),e.drawVLine(H-1,b,id-2,h.BoxVerticalSingle,z.Colors.WHITE),e.drawChar(H-1,b+id-2,h.BoxUpSingleHorizontalSingle,z.Colors.WHITE),new Yd(a,D).draw(H,b))})}function j0(a){let d=new E(a.entities,["homing","motion","position"]);a.on("tick",function(){d.forEach(({homing:L,motion:P,position:$},D)=>{var B;if(!((B=L.target)!=null&&B.alive))return;let i=l(a,L.target),H=$d($,i),b=Aa(P.angle,H);Math.abs(b)<=L.strength?P.angle=H:b<0?P.angle-=L.strength:P.angle+=L.strength,--L.duration<=0&&(D.setHoming(),D.setTrail())})})}function K0(a){let d=new E(a.entities,["lifetime"]);a.on("tick",function(){d.forEach(({lifetime:L},P)=>{if(--L.duration<=0)a.kill(P,{type:"expired"});else if(L.decayingAppearance&&P.appearance){let $=L.decayingAppearance[L.duration-1];Object.assign(P.appearance,$)}})})}function x0(a,d,e){if(!(!d.ship||!d.player))switch(e.type){case"double":d.doubleShot?d.doubleShot.duration+=9:d.setDoubleShot({duration:9});return;case"heal":{let L=Math.ceil(d.ship.maxHp/4);d.ship.hp=Math.min(d.ship.maxHp,d.ship.hp+L);return}case"recharge":{for(let L of n(a,d))if(L.turret)for(;L.turret.timer<1/0&&L.turret.timer>0;)vd(L.turret);return}case"bomb":for(d.player.bombs.push(e.prefab);d.player.bombs.length>ca(d);)d.player.bombs.shift();break;case"junk":if(fd(pa(d)))return x0(a,d,{type:"bomb",prefab:U(Ba)});break}}function d0(a,d){let e=d.x-a.x,L=d.y-a.y,P=Math.abs(e),$=Math.abs(L),D=e>0?1:-1,i=L>0?1:-1,H=s({},a),b=[s({},H)];for(let B=0,c=0;B<P||c<$;)(.5+B)/P<(.5+c)/$?(H.x+=D,B++):(H.y+=i,c++),b.push(s({},H));return b}function l0(a){let d=new E(a.entities,["motion","position"]);a.on("tick",function(){d.forEach(({motion:L,position:P,projectile:$,ignoreSolid:D,item:i},H)=>{let[b,B]=Dd(L),c=p(P.x+b,P.y+B),r=d0(Z(P),Z(c)),F=!1,t;for(let T of r){if(!a.inBounds(T)){a.kill(H,{type:"exitedMap"});return}a.move(H,T);let{wall:J,solid:Q}=a.getContents(T,D==null?void 0:D.ids);if(J){F=!0;break}else if(Q){t=Q;break}}F?a.kill(H,{type:"hitWall"}):t?($&&Ud(a,t,$.damage,H),i&&x0(a,a.getRoot(t),i),a.kill(H,{type:"hitEntity",other:t})):a.move(H,c)})})}function Z0(a){a.on("playerMove",function({move:e}){let L=a.player,P=L.position,$=K(P,e);ba(a,L,$).length||(L.move($.x,$.y),L.setLastMovement({angle:$d(P,$)}),a.tick())}),a.on("playerFire",function({array:e}){let L=a.player,P=L.player.weaponArrays[e],$=n(a,L),D=$.filter(H=>H.tags.has(P)),i=!1;for(let H of D)!H.position||!H.turret||Wd(H.turret,L)&&(Rd(a,H.turret,H.position,p(0,0),L,$.map(b=>b.id)),i=!0);i&&(L.setLastMovement(),a.tick())}),a.on("playerBomb",function(){var $;let e=a.player,L=e.player.bombs.shift();if(!L)return;let P=Gd(L);if(($=P.components)!=null&&$.turret){let D=y(P.components.turret),i=l(a,e),H=wd(a,e),b=H?l(a,H):p(0,0),B=Rd(a,D,i,b,e,w(a,e));for(let c of B){if(c.ai){c.ai.attacking=H;for(let r of n(a,c).filter(F=>F.turret))for(let F of r.turret.shots)F.type==="bullet"&&typeof F.angle=="number"&&(F.angle+=Math.PI)}c.homing&&(c.homing.target=H)}e.setLastMovement(),a.tick()}})}var Ua=I(R());function Kd(a){return typeof a!="undefined"}function s0(a){let d=new E(a.entities,["ship"]);a.on("tick",function(){d.forEach((L,P)=>{P.doubleShot&&--P.doubleShot.duration<=0&&P.setDoubleShot()})}),a.on("draw",function(){let L=n(a,a.player).map(P=>P.position).filter(Kd);if(a.player.doubleShot)for(let P of L)a.blend(P.x,P.y,Ua.Colors.LIGHT_GRAY)})}function V0(a){let d=new E(a.entities,["ship"]);a.on("tick",function(){d.forEach(({ship:L},P)=>{if(L.shield>=L.maxShield){L.shieldTimer=0;return}let $=Xa(P);++L.shieldTimer>=$&&(L.shield++,L.shieldTimer=0)})})}function N0(a){a.on("waveBegin",function({wave:L,difficulty:P,pilot:$}){let D=(P+L.difficulty)*3,i=[];for(let B of L.groups)for(let c=0;c<B.count;c++)i.push(U(B.prefabs));let H=L.groups.filter(B=>B.type==="Escort");for(let B=0;B<P;B++){let c=U(H);i.push(U(c.prefabs))}let b=Math.floor(Math.random()*i.length);for(let B=0;B<i.length;B++){let c=B===b&&$!==void 0,r=i[B],F=ta(D,c),t=Ja(a,r,F,c?$:void 0),T=ra(a,t);t.move(T.x,T.y)}});let d=1/0;a.on("kill",({e})=>{if(!e.ship)return;a.entities.get().filter(P=>P.alive&&P.ship&&P.ship.type!=="Player").length||(d=5)}),a.on("tick",()=>{--d<=0&&(d=1/0,a.fire("waveNext",void 0))})}function q0(a){a.on("move",function({e,old:L,pos:P}){e.trail&&!v(L,P)&&a.spawn(e.trail.effectPrefab).setPosition(L)})}function k0(a){let d=new E(a.entities,["position","turret"]);a.on("tick",function(){d.forEach(({position:L,turret:P},$)=>{var b;vd(P);let D=a.getRoot($);if(!D.ai)return;let i=D.ai.attacking;if(!(i!=null&&i.alive))return;let H=l(a,i);if(!(Ad(L,H)>((b=D.ai.firingDistance)!=null?b:1/0))&&Wd(P,D))for(let B of Rd(a,P,L,H,D,w(a,D)))B.homing&&(B.homing.target=i),B.ai&&(B.ai.attacking=i)})})}function Ya(a){K0(a),j0(a),I0(a),k0(a),n0(a),V0(a),l0(a),R0(a),N0(a),Q0(a),Y0(a),q0(a),S0(a),M0(a),s0(a),Z0(a)}var Qd=I(R());var ja=I(R()),o=class{constructor(d){this.g=d;this.width=0,this.height=0,this.instructions=[]}add(d){this.instructions.push(d),this.updateBounds()}addLine(d,e=ja.Colors.WHITE,L){this.add({x:0,y:this.instructions.length,line:d,fg:e,bg:L})}updateBounds(){this.width=this.instructions.reduce((d,e)=>Math.max(e.line.length+e.x,d),0),this.height=1+this.instructions.reduce((d,e)=>Math.max(e.y,d),0)}draw(d,e){for(let{x:L,y:P,line:$,fg:D,bg:i}of this.instructions)this.g.term.drawString(d+L,e+P,$,D,i)}};var Ka=Math.PI/4,tL=[h.RightArrow,h.DownArrow+h.RightArrow,h.DownArrow,h.DownArrow+h.LeftArrow,h.LeftArrow,h.UpArrow+h.LeftArrow,h.UpArrow,h.UpArrow+h.RightArrow];function JL(a){let d=Math.floor(fa(a)/Ka+Ka/2);return tL[d]}var xd=class extends o{constructor(e,L){var P,$;super(e);this.e=L;L.name&&!L.ship&&this.addLine(L.name),L.projectile&&this.addLine(`${L.projectile.damage} damage`,Qd.Colors.LIGHT_RED),L.motion&&this.addLine(`${JL(L.motion.angle)}, vel ${L.motion.vel}`,Qd.Colors.LIGHT_GRAY),L.homing&&this.addLine(`chasing ${L.homing.target===this.g.player?"you":($=(P=L.homing.target)==null?void 0:P.ship)==null?void 0:$.name} ${L.homing.duration<1/0?`(${L.homing.duration})`:""}`,Qd.Colors.DARK_RED),L.lifetime&&this.addLine(`(lasts ${L.lifetime.duration})`,Qd.Colors.DARK_GRAY),L.explodes&&this.addLine(`explosion ${L.explodes.size}`,Qd.Colors.ORANGE)}};var o0=I(R());var g0=I(R());var ld=class extends o{constructor(e,L){super(e);this.field=L;this.addLine("Explosion"),this.add({x:0,y:1,fg:g0.Colors.LIGHT_GRAY,line:"intensity"}),this.add({x:10,y:1,fg:g0.Colors.YELLOW,line:Math.floor(L.intensity).toString()})}};var m0=I(R());var Zd=class extends o{constructor(e,L){super(e);this.item=L;switch(L.type){case"bomb":this.addLine("Smart Bomb");break;case"double":this.addLine("Double",_.Double.fg,_.Double.bg);break;case"drain":this.addLine("Drain",_.Drain.fg,_.Drain.bg);break;case"heal":this.addLine("Heal",_.Healthy.fg,_.Healthy.bg);break;case"junk":this.addLine("Junk",m0.Colors.DARK_GRAY);break;case"money":this.addLine(`${h.SetMember}${L.value}`,m0.Colors.YELLOW);break;case"recharge":this.addLine("Recharge");break}}};var xa=I(R());var sd=class extends o{constructor(e,L){super(e);this.e=L;L.doubleShot&&this.addLine(L.doubleShot.duration===1/0?"2x Shot":`2x Shot (${L.doubleShot.duration})`,xa.Colors.LIGHT_GRAY)}};function la(a,d,e){if(!e.length)return;let L=[],P=1,$=1,D=B=>{L.push({x:P,y:$,object:B}),$+=B.height+1};for(let B of e){B.ship&&D(new cd(a,B.ship)),B.pilot&&D(new Xd(a,B.pilot,!0)),B.doubleShot&&D(new sd(a,B));let c=n(a,B);for(let r of c.filter(F=>F.turret))D(new Td(a,r.turret));B.item?D(new Zd(a,B.item)):(B.motion||B.projectile||B.homing||B.lifetime||B.explodes)&&D(new xd(a,B)),B.field&&D(new ld(a,B.field))}if(!L.length)return;let i=Math.max(...L.map(B=>B.object.width))+2,H=Math.min(d.x+2,a.term.width-i),b=Math.min(d.y,a.term.height-$);a.term.fillRect(H,b,i,$," ",o0.Colors.WHITE,o0.Colors.BLACK),a.term.drawSingleBox(H,b,i,$);for(let B of L)B.object.draw(H+B.x,b+B.y)}var Vd=class{constructor(d,e){this.g=d;this.campaign=e;this.dirty=!0,this.examining=[]}refresh(){this.dirty=!0}init(){let{g:d}=this;this.examineAt=void 0,this.examining=[],this.waves=Fa(),d.blankMap(),d.entities.clearExceptFor(w(d,d.player));let{width:e,height:L}=u(d,d.player);d.player.move(G(d.mapWidth/2-e/2),d.mapHeight-L-4),d.player.ship.shield=d.player.ship.maxShield,Ya(d),this.nextWave(),d.on("waveNext",this.nextWave.bind(this))}nextWave(){let d=this.waves.shift();if(d){let e=this.waves.length===0?this.campaign.currentSector.star:void 0;this.g.fire("waveBegin",{wave:d,difficulty:this.campaign.difficulty,pilot:e});return}this.g.player.alive&&(this.campaign.currentSector.completed=!0)}draw(){let{map:d,mapWidth:e,mapHeight:L,overlays:P,player:$,term:D}=this.g;for(let i=0;i<L;i++)for(let H=0;H<e;H++){let b=d.grid[i][H];D.drawChar(H,i,0,b.fg,b.bg)}if(this.g.fire("draw",void 0),this.dirty=!1,this.showOverlay){let i=P.get(this.showOverlay);if(i)for(let H=0;H<L;H++)for(let b=0;b<e;b++){let B=i.get({x:b,y:H})||1/0,c=B===1/0?"-":B<10?`${B}`:"*";D.drawChar(b,H,c,j.Colors.LIGHT_RED)}}if(this.examineAt){la(this.g,this.examineAt,this.examining);for(let i of this.examining){let{motion:H,position:b}=i;if(H&&b){let[B,c]=Dd(H),r=p(b.x+B,b.y+c),F=d0(Z(b),Z(r));for(let t of F)this.g.blend(t.x,t.y,j.Colors.DARK_RED)}}}$.alive?this.campaign.currentSector.completed&&(D.drawCenteredString(D.width/2,5,"SECTOR COMPLETE",j.Colors.WHITE,j.Colors.BLACK),D.drawCenteredString(D.width/2,7,"Hit Enter to continue",j.Colors.WHITE,j.Colors.BLACK)):(D.drawCenteredString(D.width/2,5,"YOU HAVE PERISHED!",j.Colors.LIGHT_RED,j.Colors.BLACK),D.drawCenteredString(D.width/2,7,"Hit Escape to try again",j.Colors.LIGHT_RED,j.Colors.BLACK))}update(){(this.g.term.mouse.dx||this.g.term.mouse.dy)&&this.refresh(),this.handleKeys(),this.dirty&&(this.handleMouseMove(),this.draw())}examine(d){this.examineAt=d,this.dirty=!0;let{solid:e,other:L}=this.g.getContents(d),P=new Set;e&&P.add(this.g.getRoot(e));for(let $ of L)P.add(this.g.getRoot($));this.examining=[...P]}handleMouseMove(){let{x:d,y:e}=this.g.term.mouse;this.examine({x:d,y:e})}handleKeys(){let{player:d,term:e}=this.g;if(!d.alive){e.isKeyPressed(j.Key.VK_ESCAPE)&&(this.g.setMode(new Cd(this.g)),e.fillRect(0,0,e.width,e.height," ",j.Colors.WHITE,j.Colors.BLACK));return}if(this.campaign.currentSector.completed&&(e.isKeyPressed(j.Key.VK_ENTER)||e.isKeyPressed(j.Key.VK_NUMPAD_ENTER))){this.campaign.endCombat();return}let L=e.getMovementKey();if(L){this.g.fire("playerMove",{move:L});return}if(e.isKeyPressed(j.Key.VK_1)){this.g.fire("playerFire",{array:0});return}if(e.isKeyPressed(j.Key.VK_2)){this.g.fire("playerFire",{array:1});return}if(e.isKeyPressed(j.Key.VK_SPACE)){this.g.fire("playerBomb",void 0);return}}};var Nd=class{constructor(d,e,L){this.width=d;this.height=e;this.grid=[];for(let P=0;P<e;P++){let $=[];for(let D=0;D<d;D++)$.push(L(D,P));this.grid.push($)}}contains({x:d,y:e}){return d>=0&&d<this.width&&e>=0&&e<this.height}get({x:d,y:e}){return this.grid[e][d]}getPositions(){let d=[];for(let e=0;e<this.height;e++)for(let L=0;L<this.width;L++)d.push({x:L,y:e});return d}};var rL={name:"Bodini",star:!0,body:4,mind:2,spirit:3,talent:2,class:[],special:"Multiball"},RL={name:"Splintertooth",star:!0,body:3,mind:3,spirit:3,talent:2,class:[],special:"StubbornDescent"},IL={name:"Gruff",star:!0,body:2,mind:2,spirit:4,talent:3,class:[],special:"LaserBeam"},QL={name:"Limmhesto",star:!0,body:3,mind:3,spirit:3,talent:2,class:[],special:"Switchblades"},ML={name:"Ceegrave",star:!0,body:1,mind:4,spirit:3,talent:3,class:[],special:"Triangulate"},EL={name:"Sensoria",star:!0,body:4,mind:2,spirit:4,talent:1,class:[],special:"Overload"},SL=[rL,RL,IL,QL,ML,EL],Za=SL;var sa="./claw yr way back-WFUTJ3MJ.mp3";var y0;function G0(){return y0||(y0=new Promise(a=>{let d=new Audio(sa);d.addEventListener("canplaythrough",()=>{d.play(),d.addEventListener("ended",()=>{d.currentTime=0,d.play()}),a(d)})})),y0}var qd=class{constructor(d,e,L){this.g=d;this.shipPrefab=e;this.pilot=L;this.dirty=!0}get currentSector(){return this.space.get(this.position)}refresh(){this.dirty=!0}init(){let{g:d}=this;d.clearEventHandlers(),d.entities.clear(),d.player=this.makePlayer(),this.difficulty=0,this.position=p(2,2),this.space=new Nd(5,5,()=>({completed:!1}));let e=new Set,L=this.space.getPositions().filter(P=>!v(this.position,P));for(;e.size<6;){let P=U(Za);if(!e.has(P)){e.add(P);let $=U(L),D=this.space.get($);D.star=P;let i=L.indexOf($);L.splice(i,1)}}G0(),this.startCombat()}startCombat(){this.g.setMode(new Vd(this.g,this))}endCombat(){this.g.clearEventHandlers(),this.currentSector.completed=!0,this.currentSector.star=void 0,this.difficulty++,this.g.mode=this,this.refresh()}makePlayer(){let{g:d,shipPrefab:e,pilot:L}=this,P=d.spawn(e);if(!P.ship)throw new Error(`Ship prefab ${e} doesn't have a ship component!`);return ud(d,P,L),nd(P.ship),P}draw(){let{term:d}=this.g;d.fillRect(0,0,d.width,d.height," ",g.Colors.WHITE,g.Colors.BLACK);let e=this.space.get(this.position),L=d.width/2;d.drawCenteredString(L,2,"Known Space",g.Colors.WHITE),e.completed||(d.drawCenteredString(L,4,"Hit Enter to fight!",g.Colors.WHITE),e.star&&d.drawCenteredString(L,34,`You will face: ${e.star.name}!`,g.Colors.YELLOW));let P=(d.width-25)/2,$=(d.height-25)/2;for(let D=0;D<5;D++){let i=$+D*5;for(let H=0;H<5;H++){let b=P+H*5,B={x:H,y:D},c=this.space.get(B);d.fillRect(b,i,5,5," ",void 0,c.completed?g.Colors.BLACK:g.Colors.DARK_RED),d.drawSingleBox(b,i,5,5,g.Colors.WHITE),v(B,this.position)?d.drawChar(b+2,i+2,"@",g.Colors.LIGHT_CYAN):c.star&&d.drawChar(b+2,i+2,"*",g.Colors.YELLOW)}}this.dirty=!1}handleKeys(){let d=this.space.get(this.position);!d.completed&&(this.g.term.isKeyPressed(g.Key.VK_ENTER)||this.g.term.isKeyPressed(g.Key.VK_NUMPAD_ENTER))&&this.startCombat();let e=this.g.term.getMovementKey();if(d.completed&&e){let L=K(this.position,e);this.space.contains(L)&&(this.position=L,this.dirty=!0)}}update(){this.handleKeys(),this.dirty&&this.draw()}};var Cd=class{constructor(d,e=5,L=100){this.g=d;this.starfieldSpeed=e;this.starCount=L}refresh(){this.dirty=!0}init(){this.dirty=!0,this.pilot={name:"Player",player:!0,body:1,mind:1,spirit:1,talent:1,class:[]},this.points=6,this.starfieldCounter=0,this.stars=[];for(let d=0;d<this.starCount;d++)this.stars.push(this.newStar())}draw(){let{term:d}=this.g;d.clear();for(let D of this.stars){let{x:i,y:H}=Z(D);d.drawChar(i,H,D.c,D.fg)}let e=d.width/2;d.drawCenteredString(e,2,"CRAVESPACE",S.Colors.WHITE),d.drawCenteredString(e,9,"Create your Pilot",S.Colors.WHITE),d.drawCenteredString(e,10,`${this.points} points`,S.Colors.YELLOW);let L=2,P=Math.floor((d.width-L*2)/4),$=L+P/2;this.drawStat("body",$),this.drawStat("mind",$+P),this.drawStat("spirit",$+P*2),this.drawStat("talent",$+P*3),this.points===0&&d.drawCenteredString(e,20,"Hit Enter to begin!",S.Colors.WHITE),this.dirty=!1}drawStat(d,e){let{term:L}=this.g,P=`(${d[0].toUpperCase()})${d.slice(1)}`,$=this.pilot[d];L.drawCenteredString(e,13,P,S.Colors.LIGHT_CYAN),L.drawCenteredString(e,14,$.toString(),Od[$])}update(){this.handleStarfield(),this.handleKeys(),this.dirty&&this.draw()}newStar(){let{term:d}=this.g,e=U([S.Colors.DARK_RED,S.Colors.LIGHT_RED,S.Colors.YELLOW,S.Colors.LIGHT_CYAN,S.Colors.WHITE]),L=.5+Math.random(),P=L<.75?".":L<1.25?h.Dot:"*",$=Math.random()*Math.PI*2;return{x:d.width/2,y:d.height/2,c:P,fg:e,vel:L,angle:$}}handleStarfield(){if(this.starfieldCounter<this.starfieldSpeed){this.starfieldCounter++;return}this.starfieldCounter=0,this.dirty=!0;let{width:d,height:e}=this.g.term;for(let L of this.stars){let[P,$]=Dd(L);L.x+=P,L.y+=$,(L.x<0||L.x>=d||L.y<0||L.y>=e)&&Object.assign(L,this.newStar())}}isPressed(d,e){let L=this.g.term.isKeyDown(S.Key.VK_SHIFT_LEFT)||this.g.term.isKeyDown(S.Key.VK_SHIFT_RIGHT);return this.g.term.isKeyPressed(d)&&e===L}changeStat(d,e){let L=this.pilot[d]+e;if(L<1||L>4)return!1;this.points-=e,this.pilot[d]=L,this.dirty=!0}handleKeys(){this.points>0&&(this.isPressed(S.Key.VK_B,!1)&&this.changeStat("body",1),this.isPressed(S.Key.VK_M,!1)&&this.changeStat("mind",1),this.isPressed(S.Key.VK_S,!1)&&this.changeStat("spirit",1),this.isPressed(S.Key.VK_T,!1)&&this.changeStat("talent",1)),this.isPressed(S.Key.VK_B,!0)&&this.changeStat("body",-1),this.isPressed(S.Key.VK_M,!0)&&this.changeStat("mind",-1),this.isPressed(S.Key.VK_S,!0)&&this.changeStat("spirit",-1),this.isPressed(S.Key.VK_T,!0)&&this.changeStat("talent",-1),this.points===0&&(this.g.term.isKeyPressed(S.Key.VK_ENTER)||this.g.term.isKeyPressed(S.Key.VK_NUMPAD_ENTER))&&this.g.setMode(new qd(this.g,"PlayerShip",this.pilot))}};var kd=class{constructor(d){this.keyFn=d;this.items=new Map}has(d){return this.items.has(this.keyFn(d))}get(d){return this.items.get(this.keyFn(d))}getOrDefault(d,e){let L=this.items.get(this.keyFn(d));return typeof L!="undefined"?L:e}getOrDie(d){let e=this.keyFn(d),L=this.items.get(e);if(typeof L=="undefined")throw new Error(`Invalid key: ${e}`);return L}set(d,e){this.items.set(this.keyFn(d),e)}};function u0(a,d,e=1/0){let L=[],P=new kd($=>`${$.x},${$.y}`);for(let $ of a)L.push($),P.set($,0);for(;L.length;){let $=L.shift(),D=P.getOrDie($)+1;if(!(D>e))for(let i of r0($))!P.has(i)&&d(i)&&(P.set(i,D),L.push(i))}return P}var gd=class{constructor(d,e,L){this.term=d;this.mapWidth=e;this.mapHeight=L;d.update=this.update.bind(this),this.map=new a0.Console(e,L,()=>!0),this.lastEntityId=0,this.entities=new Sd(La),this.overlays=new Map,this.clearEventHandlers(),this.setMode(new Cd(this))}setMode(d){this.mode=d,this.mode.init()}clearEventHandlers(){this.eventCallbacks=ea(Pa.map(d=>[d,[]]))}fire(d,e){for(let L of this.eventCallbacks[d])L(e)}on(d,e){this.eventCallbacks[d].push(e)}spawn(d){return X0(this,d)}refresh(){this.mode.refresh()}add(d){return this.refresh(),this.entities.add(d),this.fire("spawn",{e:d}),d}kill(d,e){d.alive&&(d.kill(e),this.fire("kill",{e:d,reason:e}))}move(d,e){let L=d.position;d.move(e.x,e.y),L&&this.fire("move",{e:d,old:L,pos:e})}blankMap(){let{map:d,mapHeight:e,mapWidth:L}=this;d.clear();for(let P=0;P<e;P++)for(let $=0;$<L;$++)d.setBlocked($,P,!1),d.setBlockedSight($,P,!1);d.computeFov(0,0,1/0)}drawIfVisible(d,e,L,P,$,D){this.map.isVisible(d,e)&&(D?this.term.drawCell(d,e,{bg:$},D):this.term.drawChar(d,e,L,P,$))}blend(d,e,L){this.term.drawCell(d,e,{bg:L},a0.BlendMode.Add)}getRoot(d){return d.attachment?this.getRoot(d.attachment.parent):d}getContents(d,e=[]){let L=Z(d);if(!this.inBounds(L))return{oob:!0,other:[]};let P=this.map.isBlocked(L.x,L.y),$=this.entities.get().filter(i=>i.position&&v(L,i.position)),D=$.filter(i=>!e.includes(i.id)).find(i=>i.solid);return{wall:P,solid:D,other:$.filter(i=>!i.solid)}}tick(){this.overlays.clear(),this.fire("tick",void 0),this.entities.clearDead()}update(){this.mode.update()}inBounds(d){return d.x>=0&&d.y>=0&&d.x<this.mapWidth&&d.y<this.mapHeight}getDistanceMap(d){let e=`${d.id}.distance`,L=this.overlays.get(e);return L||(L=u0(n(this,d).map(P=>P.position).filter(Kd),this.inBounds.bind(this)),this.overlays.set(e,L)),L}};function UL(a){let L=e0.DEFAULT_FONT,P=document.createElement("div");a.appendChild(P);let $=()=>{let b=60*L.charWidth,B=40*L.charHeight,c=Math.floor(window.innerWidth/b),r=Math.floor(window.innerHeight/B),F=Math.min(c,r);P.style.width=`${b*F}px`,P.style.height=`${B*F}px`};window.addEventListener("resize",$),$();let D=document.createElement("canvas");P.appendChild(D),requestAnimationFrame(()=>D.focus());let i=new e0.Terminal(D,60,40,{font:L}),H=new gd(i,60,40-id);window.g=H}window.addEventListener("load",()=>UL(document.body));})();
//# sourceMappingURL=bundle.js.map
