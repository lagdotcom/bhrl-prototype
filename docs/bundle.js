"use strict";(()=>{var Ut=Object.create;var k=Object.defineProperty;var Zt=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames,wt=Object.getOwnPropertySymbols,ee=Object.getPrototypeOf,Tt=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var Ct=(s,t,e)=>t in s?k(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,E=(s,t)=>{for(var e in t||={})Tt.call(t,e)&&Ct(s,e,t[e]);if(wt)for(var e of wt(t))se.call(t,e)&&Ct(s,e,t[e]);return s};var m=(s,t)=>()=>(t||s((t={exports:{}}).exports,t),t.exports),q=(s,t)=>{for(var e in t)k(s,e,{get:t[e],enumerable:!0})},ie=(s,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of te(t))!Tt.call(s,r)&&r!==e&&k(s,r,{get:()=>t[r],enumerable:!(i=Zt(t,r))||i.enumerable});return s};var w=(s,t,e)=>(e=s!=null?Ut(ee(s)):{},ie(t||!s||!s.__esModule?k(e,"default",{value:s,enumerable:!0}):e,s));var C=m((as,Et)=>{Et.exports=globalThis.wglt});var It=m((Bs,Vt)=>{Vt.exports=globalThis.RBush});var M=m((ws,qt)=>{qt.exports=globalThis.SAT});var P=m(y=>{"use strict";var fe=y&&y.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(y,"__esModule",{value:!0});y.Types=y.SATPolygon=y.SATVector=y.Response=y.RBush=void 0;var me=fe(It());Object.defineProperty(y,"RBush",{enumerable:!0,get:function(){return me.default}});var lt=M();Object.defineProperty(y,"Response",{enumerable:!0,get:function(){return lt.Response}});Object.defineProperty(y,"SATVector",{enumerable:!0,get:function(){return lt.Vector}});Object.defineProperty(y,"SATPolygon",{enumerable:!0,get:function(){return lt.Polygon}});var ye;(function(s){s.Ellipse="Ellipse",s.Line="Line",s.Circle="Circle",s.Box="Box",s.Point="Point",s.Polygon="Polygon"})(ye=y.Types||(y.Types={}))});var b=m(c=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0});c.generateId=c.toJSON=c.drawPolygon=c.getSATFunction=c.getBounceDirection=c.ensureConvex=c.mapArrayToVector=c.mapVectorToArray=c.intersectLinePolygon=c.intersectLineLine=c.intersectLineCircle=c.dashLineTo=c.clonePointsArray=c.checkAInB=c.intersectAABB=c.bodyMoved=c.extendBody=c.clockwise=c.distance=c.ensurePolygonPoints=c.ensureVectorPoint=c.createBox=c.createEllipse=void 0;var x=M(),X=P();function de(s,t=s,e=1){let i=Math.PI*Math.hypot(s,t)*2,r=Math.max(8,Math.ceil(i/Math.max(1,e)));return Array.from({length:r},(n,o)=>{let a=o/r*2*Math.PI,l=Math.cos(a)*s,h=Math.sin(a)*t;return new x.Vector(l,h)})}c.createEllipse=de;function xe(s,t){return[new x.Vector(0,0),new x.Vector(s,0),new x.Vector(s,t),new x.Vector(0,t)]}c.createBox=xe;function Ot(s={}){return s instanceof x.Vector?s:new x.Vector(s.x||0,s.y||0)}c.ensureVectorPoint=Ot;function ge(s){if(!s)throw new Error("No points array provided");let t=s.map(Ot);return Lt(t)?t.reverse():t}c.ensurePolygonPoints=ge;function ve(s,t){return Math.hypot(s.x-t.x,s.y-t.y)}c.distance=ve;function Lt(s){let t=0;for(let e=0;e<s.length;e++){let i=s[e],r=s[(e+1)%s.length];t+=(r.x-i.x)*(r.y+i.y)}return t>0}c.clockwise=Lt;function Pe(s,t){s.isStatic=!!t?.isStatic,s.isTrigger=!!t?.isTrigger,s.padding=t?.padding||0,t?.center&&s.center(),s.setAngle(t?.angle||0)}c.extendBody=Pe;function _e(s){return s.bbox.minX<s.minX||s.bbox.minY<s.minY||s.bbox.maxX>s.maxX||s.bbox.maxY>s.maxY}c.bodyMoved=_e;function be(s,t){return!(t.minX>s.maxX||t.minY>s.maxY||t.maxX<s.minX||t.maxY<s.minY)}c.intersectAABB=be;function Ae(s,t){let e=s.minX>=t.minX&&s.maxX<=t.maxX,i=s.minY>=t.minY&&s.maxY<=t.maxY;return e&&i}c.checkAInB=Ae;function Be(s){return s.map(({x:t,y:e})=>({x:t,y:e}))}c.clonePointsArray=Be;function Yt(s,t,e,i,r,n=2,o=4){let a=i-t,l=r-e,h=Math.atan2(l,a),u=Math.cos(h),p=Math.sin(h),B=t,I=e,_=Math.hypot(a,l);for(;_>0;){let Bt=Math.min(_,n);s.moveTo(B,I),s.lineTo(B+u*Bt,I+p*Bt),B+=u*(n+o),I+=p*(n+o),_-=n+o}}c.dashLineTo=Yt;function we(s,t){let e={x:s.end.x-s.start.x,y:s.end.y-s.start.y},i={x:s.start.x-t.pos.x,y:s.start.y-t.pos.y},r=(e.x*i.x+e.y*i.y)*-2,n=(e.x*e.x+e.y*e.y)*2,o=Math.sqrt(r*r-(i.x*i.x+i.y*i.y-t.r*t.r)*n*2);if(isNaN(o))return[];let a=(r-o)/n,l=(r+o)/n,h=[];return a<=1&&a>=0&&h.push({x:s.start.x+e.x*a,y:s.start.y+e.y*a}),l<=1&&l>=0&&h.push({x:s.start.x+e.x*l,y:s.start.y+e.y*l}),h}c.intersectLineCircle=we;function kt(s,t){let e=s.end.x-s.start.x,i=s.end.y-s.start.y,r=e*(t.end.y-t.start.y)-(t.end.x-t.start.x)*i;if(r===0)return null;let n=((t.end.y-t.start.y)*(t.end.x-s.start.x)+(t.start.x-t.end.x)*(t.end.y-s.start.y))/r,o=((s.start.y-s.end.y)*(t.end.x-s.start.x)+e*(t.end.y-s.start.y))/r;return!(n>=0&&n<=1)||!(o>=0&&o<=1)?null:{x:s.start.x+n*e,y:s.start.y+n*i}}c.intersectLineLine=kt;function Ce(s,t){return t.calcPoints.map((e,i)=>{let r=i?t.calcPoints[i-1]:t.calcPoints[t.calcPoints.length-1],n={start:{x:r.x+t.pos.x,y:r.y+t.pos.y},end:{x:e.x+t.pos.x,y:e.y+t.pos.y}};return kt(s,n)}).filter(e=>!!e)}c.intersectLinePolygon=Ce;function Te({x:s,y:t}){return[s,t]}c.mapVectorToArray=Te;function Ee([s,t]){return{x:s,y:t}}c.mapArrayToVector=Ee;function Me(s){return s.isConvex||s.type!==X.Types.Polygon?[s]:s.convexPolygons}c.ensureConvex=Me;function Se(s,t){let e=new x.Vector(t.x-s.x,t.y-s.y),i=new x.Vector(s.x-t.x,s.y-t.y),r=i.dot(e.normalize())*2;return new x.Vector(e.x*r-i.x,e.y*r-i.y).normalize()}c.getBounceDirection=Se;function Ve(s,t){return s.type===X.Types.Circle?t.type===X.Types.Circle?x.testCircleCircle:x.testCirclePolygon:t.type===X.Types.Circle?x.testPolygonCircle:x.testPolygonPolygon}c.getSATFunction=Ve;function Ie(s,{pos:t,calcPoints:e},i=!1){[...e,e[0]].forEach((n,o)=>{let a=t.x+n.x,l=t.y+n.y,h=e[o-1]||e[e.length-1];if(!o)e.length===1?s.arc(a,l,1,0,Math.PI*2):s.moveTo(a,l);else if(e.length>1)if(i){let u=t.x+h.x,p=t.y+h.y;Yt(s,u,p,a,l)}else s.lineTo(a,l)})}c.drawPolygon=Ie;function qe(s){return Object.entries(s).reduce((t,[e,i])=>e!=="system"?Object.assign(Object.assign({},t),{[e]:i}):t,{})}c.toJSON=qe;var Oe=0;function Le(){return(++Oe).toString(36)}c.generateId=Le});var ut=m(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});H.Circle=void 0;var Ye=M(),ke=P(),L=b(),ht=class extends Ye.Circle{constructor(t,e,i){super((0,L.ensureVectorPoint)(t),e),this.offsetCopy={x:0,y:0},this.padding=0,this.angle=0,this.isConvex=!0,this.isCentered=!0,this.type=ke.Types.Circle,(0,L.extendBody)(this,i),this.radiusBackup=e,this.uid=(0,L.generateId)()}get x(){return this.pos.x}set x(t){var e;this.pos.x=t,(e=this.system)===null||e===void 0||e.insert(this)}get y(){return this.pos.y}set y(t){var e;this.pos.y=t,(e=this.system)===null||e===void 0||e.insert(this)}get scale(){return this.r/this.radiusBackup}set scale(t){this.setScale(t)}get scaleX(){return this.scale}get scaleY(){return this.scale}setPosition(t,e){var i;this.pos.x=t,this.pos.y=e,(i=this.system)===null||i===void 0||i.insert(this)}setScale(t,e){this.r=this.radiusBackup*t}setAngle(t){this.angle=t;let{x:e,y:i}=this.getOffsetWithAngle();return this.offset.x=e,this.offset.y=i,this}setOffset(t){this.offsetCopy.x=t.x,this.offsetCopy.y=t.y;let{x:e,y:i}=this.getOffsetWithAngle();return this.offset.x=e,this.offset.y=i,this}getAABBAsBBox(){let t=this.pos.x+this.offset.x,e=this.pos.y+this.offset.y;return{minX:t-this.r,maxX:t+this.r,minY:e-this.r,maxY:e+this.r}}draw(t){let e=this.pos.x+this.offset.x,i=this.pos.y+this.offset.y;if(this.isTrigger){let r=Math.max(8,this.r);for(let n=0;n<r;n++){let o=n/r*2*Math.PI,a=(n-1)/r*2*Math.PI,l=e+Math.cos(a)*this.r,h=i+Math.sin(a)*this.r,u=e+Math.cos(o)*this.r,p=i+Math.sin(o)*this.r;(0,L.dashLineTo)(t,l,h,u,p)}}else t.moveTo(e+this.r,i),t.arc(e,i,this.r,0,Math.PI*2)}center(){}toJSON(){return(0,L.toJSON)(this)}getOffsetWithAngle(){if(!this.angle)return this.offsetCopy;let t=Math.sin(this.angle),e=Math.cos(this.angle),i=this.offsetCopy.x*e-this.offsetCopy.y*t,r=this.offsetCopy.x*t+this.offsetCopy.y*e;return{x:i,y:r}}};H.Circle=ht});var Xt=m((Ms,jt)=>{jt.exports=globalThis.decomp});var S=m(R=>{"use strict";Object.defineProperty(R,"__esModule",{value:!0});R.Polygon=void 0;var je=Xt(),Ht=M(),Rt=P(),g=b(),pt=class extends Ht.Polygon{constructor(t,e,i){if(super((0,g.ensureVectorPoint)(t),(0,g.ensurePolygonPoints)(e)),this.padding=0,this.type=Rt.Types.Polygon,this.scaleVector={x:1,y:1},!e?.length)throw new Error("No points in polygon");(0,g.extendBody)(this,i),this.uid=(0,g.generateId)()}get x(){return this.pos.x}set x(t){var e;this.pos.x=t,this.updateConvexPolygonPositions(),(e=this.system)===null||e===void 0||e.insert(this)}get y(){return this.pos.y}set y(t){var e;this.pos.y=t,this.updateConvexPolygonPositions(),(e=this.system)===null||e===void 0||e.insert(this)}get scaleX(){return this.scaleVector.x}get scaleY(){return this.scaleVector.y}get scale(){return this.scaleVector.x}set scale(t){this.setScale(t)}setPosition(t,e){var i;this.pos.x=t,this.pos.y=e,this.updateConvexPolygonPositions(),(i=this.system)===null||i===void 0||i.insert(this)}setScale(t,e=t){this.scaleVector.x=t,this.scaleVector.y=e,this.points.forEach((i,r)=>{i.x=this.pointsBackup[r].x*t,i.y=this.pointsBackup[r].y*e}),super.setPoints(this.points)}getAABBAsBBox(){let{pos:t,w:e,h:i}=this.getAABBAsBox();return{minX:t.x,minY:t.y,maxX:t.x+e,maxY:t.y+i}}draw(t){(0,g.drawPolygon)(t,this,this.isTrigger)}getCentroidWithoutRotation(){let t=this.angle;this.setAngle(0);let e=this.getCentroid();return this.setAngle(t),e}setPoints(t){return super.setPoints(t),this.updateIsConvex(),this.pointsBackup=(0,g.clonePointsArray)(t),this}translate(t,e){return super.translate(t,e),this.pointsBackup=(0,g.clonePointsArray)(this.points),this}rotate(t){return super.rotate(t),this.pointsBackup=(0,g.clonePointsArray)(this.points),this}center(){if(this.isCentered)return;let{x:t,y:e}=this.getCentroidWithoutRotation();this.translate(-t,-e),this.pos.x+=t,this.pos.y+=e,this.isCentered=!0}toJSON(){return(0,g.toJSON)(this)}updateConvexPolygonPositions(){var t;(t=this.convexPolygons)===null||t===void 0||t.forEach(e=>{e.pos.x=this.pos.x,e.pos.y=this.pos.y})}getConvex(){return this.type&&this.type!==Rt.Types.Polygon||this.points.length<=3?[]:(0,je.quickDecomp)(this.calcPoints.map(g.mapVectorToArray))}updateConvexPolygons(t=this.getConvex()){this.isConvex||(this.convexPolygons||(this.convexPolygons=[]),t.forEach((e,i)=>{this.convexPolygons[i]||(this.convexPolygons[i]=new Ht.Polygon),this.convexPolygons[i].pos.x=this.pos.x,this.convexPolygons[i].pos.y=this.pos.y,this.convexPolygons[i].setPoints((0,g.ensurePolygonPoints)(e.map(g.mapArrayToVector)))}),this.convexPolygons.length=t.length)}updateIsConvex(){let t=this.getConvex();this.isConvex=t.length<=1,this.updateConvexPolygons(t)}};R.Polygon=pt});var mt=m(D=>{"use strict";Object.defineProperty(D,"__esModule",{value:!0});D.Ellipse=void 0;var Xe=P(),N=b(),He=S(),ft=class extends He.Polygon{constructor(t,e,i=e,r=(e+i)/Math.PI,n){super(t,(0,N.createEllipse)(e,i,r),n),this.type=Xe.Types.Ellipse,this.isCentered=!0,this.isConvex=!0,this._radiusX=e,this._radiusY=i,this._step=r}get step(){return this._step}set step(t){this._step=t,this.setPoints((0,N.createEllipse)(this._radiusX,this._radiusY,this._step))}get radiusX(){return this._radiusX}set radiusX(t){this._radiusX=t,this.setPoints((0,N.createEllipse)(this._radiusX,this._radiusY,this._step))}get radiusY(){return this._radiusY}set radiusY(t){this._radiusY=t,this.setPoints((0,N.createEllipse)(this._radiusX,this._radiusY,this._step))}center(){}updateIsConvex(){}};D.Ellipse=ft});var G=m(W=>{"use strict";Object.defineProperty(W,"__esModule",{value:!0});W.Box=void 0;var Re=P(),yt=b(),Ne=S(),dt=class extends Ne.Polygon{constructor(t,e,i,r){super(t,(0,yt.createBox)(e,i),r),this.type=Re.Types.Box,this.isConvex=!0,this._width=e,this._height=i}get width(){return this._width}set width(t){this._width=t,this.setPoints((0,yt.createBox)(this._width,this._height))}get height(){return this._height}set height(t){this._height=t,this.setPoints((0,yt.createBox)(this._width,this._height))}updateIsConvex(){}};W.Box=dt});var gt=m(J=>{"use strict";Object.defineProperty(J,"__esModule",{value:!0});J.Point=void 0;var De=P(),We=b(),Ge=G(),xt=class extends Ge.Box{constructor(t,e){super((0,We.ensureVectorPoint)(t),.001,.001,e),this.type=De.Types.Point}};J.Point=xt});var F=m(K=>{"use strict";Object.defineProperty(K,"__esModule",{value:!0});K.Line=void 0;var Je=M(),Ke=P(),Fe=S(),vt=class extends Fe.Polygon{constructor(t,e,i){if(super(t,[{x:0,y:0},{x:e.x-t.x,y:e.y-t.y}],i),this.type=Ke.Types.Line,this.isConvex=!0,this.calcPoints.length===1||!e)throw console.error({start:t,end:e}),new Error("No end point for line provided")}get start(){return{x:this.x+this.calcPoints[0].x,y:this.y+this.calcPoints[0].y}}set start({x:t,y:e}){this.x=t,this.y=e}get end(){return{x:this.x+this.calcPoints[1].x,y:this.y+this.calcPoints[1].y}}set end({x:t,y:e}){this.points[1].x=t-this.start.x,this.points[1].y=e-this.start.y,this.setPoints(this.points)}getCentroid(){return new Je.Vector((this.end.x-this.start.x)/2,(this.end.y-this.start.y)/2)}updateIsConvex(){}};K.Line=vt});var Dt=m(z=>{"use strict";Object.defineProperty(z,"__esModule",{value:!0});z.BaseSystem=void 0;var ze=G(),$e=ut(),Qe=mt(),Ue=F(),Ze=gt(),ts=S(),es=P(),Nt=b(),Pt=class extends es.RBush{draw(t){this.all().forEach(e=>{e.draw(t)})}drawBVH(t){let e=({minX:i,maxX:r,minY:n,maxY:o,children:a})=>{(0,Nt.drawPolygon)(t,{pos:{x:i,y:n},calcPoints:(0,Nt.createBox)(r-i,o-n)}),a?.forEach(e)};this.data.children.forEach(e)}createPoint(t,e){let i=new Ze.Point(t,e);return this.insert(i),i}createLine(t,e,i){let r=new Ue.Line(t,e,i);return this.insert(r),r}createCircle(t,e,i){let r=new $e.Circle(t,e,i);return this.insert(r),r}createBox(t,e,i,r){let n=new ze.Box(t,e,i,r);return this.insert(n),n}createEllipse(t,e,i=e,r,n){let o=new Qe.Ellipse(t,e,i,r,n);return this.insert(o),o}createPolygon(t,e,i){let r=new ts.Polygon(t,e,i);return this.insert(r),r}};z.BaseSystem=Pt});var Wt=m(Q=>{"use strict";Object.defineProperty(Q,"__esModule",{value:!0});Q.System=void 0;var ss=Dt(),is=F(),$=P(),v=b(),_t=class extends ss.BaseSystem{constructor(){super(...arguments),this.response=new $.Response,this.bodies={},this.state={collides:!1,aInB:!1,bInA:!1,overlapV:new $.SATVector}}remove(t,e){return t.system&&delete t.system.bodies[t.uid],t.system=void 0,super.remove(t,e)}insert(t){return t.bbox=t.getAABBAsBBox(),t.system&&!(0,v.bodyMoved)(t)?this:(t.system&&t.system.remove(t),t.minX=t.bbox.minX-t.padding,t.minY=t.bbox.minY-t.padding,t.maxX=t.bbox.maxX+t.padding,t.maxY=t.bbox.maxY+t.padding,t.system=this,this.bodies[t.uid]=t,super.insert(t))}updateBody(t){this.insert(t)}update(){this.all().forEach(t=>{t.isStatic||this.insert(t)})}separate(){this.checkAll(({a:t,overlapV:e})=>{if(t.isTrigger)return!1;t.setPosition(t.x-e.x,t.y-e.y)})}checkOne(t,e){return t.isStatic?!1:this.search(t).some(i=>{if(i!==t&&this.checkCollision(t,i))return e(this.response)})}checkAll(t){return this.all().some(e=>this.checkOne(e,t))}getPotentials(t){return this.search(t).filter(e=>e!==t)}checkCollision(t,e){if(t.bbox&&e.bbox&&!(0,v.intersectAABB)(t.bbox,e.bbox))return!1;let i=(0,v.getSATFunction)(t,e);if(this.state.collides=!1,this.response.clear(),t.isConvex&&e.isConvex)this.state.collides=i(t,e,this.response);else if(t.isConvex&&!e.isConvex)(0,v.ensureConvex)(e).forEach(r=>{this.test(i,t,r)});else if(!t.isConvex&&e.isConvex)(0,v.ensureConvex)(t).forEach(r=>{this.test(i,r,e)});else{let r=(0,v.ensureConvex)(t),n=(0,v.ensureConvex)(e);r.forEach(o=>{n.forEach(a=>{this.test(i,o,a)})})}return(!t.isConvex||!e.isConvex)&&(this.response.a=t,this.response.b=e,this.state.collides&&(this.response.overlapV=this.state.overlapV,this.response.overlapN=this.response.overlapV.clone().normalize(),this.response.overlap=this.response.overlapV.len()),this.response.aInB=t.isConvex?this.state.aInB:(0,v.checkAInB)(t,e),this.response.bInA=e.isConvex?this.state.bInA:(0,v.checkAInB)(e,t)),this.state.collides}raycast(t,e,i=()=>!0){let r=1/0,n=null;return this.ray?(this.ray.start=t,this.ray.end=e):this.ray=new is.Line(t,e,{isTrigger:!0}),this.insert(this.ray),this.checkOne(this.ray,({b:o})=>{if(!i(o))return!1;(o.type===$.Types.Circle?(0,v.intersectLineCircle)(this.ray,o):(0,v.intersectLinePolygon)(this.ray,o)).forEach(l=>{let h=(0,v.distance)(t,l);h<r&&(r=h,n={point:l,collider:o})})}),this.remove(this.ray),n}clear(){return super.clear(),this.bodies={},this}traverse(t,{children:e}=this.data){return e?.find((i,r)=>{if(!i)return!1;if(i.type&&t(i,e,r))return!0;i.children&&this.traverse(t,i)})}fromJSON(t){return this.traverse((e,i,r)=>{this.bodies[e.uid]&&(this.bodies[e.uid]=i[r]=Object.assign(this.bodies[e.uid],e))},t),super.fromJSON(t),this}test(t,e,i){let r=t(e,i,this.response);r&&(this.state.collides||(this.state.aInB=!1,this.state.bInA=!1,this.state.overlapV=new $.SATVector),this.state.overlapV.add(this.response.overlapV)),this.state.aInB=this.state.aInB||this.response.aInB,this.state.bInA=this.state.bInA||this.response.bInA,this.state.collides=r||this.state.collides,this.response.clear()}};Q.System=_t});var Gt=m(d=>{"use strict";var rs=d&&d.__createBinding||(Object.create?function(s,t,e,i){i===void 0&&(i=e);var r=Object.getOwnPropertyDescriptor(t,e);(!r||("get"in r?!t.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return t[e]}}),Object.defineProperty(s,i,r)}:function(s,t,e,i){i===void 0&&(i=e),s[i]=t[e]}),A=d&&d.__exportStar||function(s,t){for(var e in s)e!=="default"&&!Object.prototype.hasOwnProperty.call(t,e)&&rs(t,s,e)};Object.defineProperty(d,"__esModule",{value:!0});A(P(),d);A(ut(),d);A(mt(),d);A(S(),d);A(G(),d);A(gt(),d);A(F(),d);A(Wt(),d);A(b(),d)});var T=w(C());var f=class{constructor(t,e){this.g=t;this.name=e;this.alive=!0,this.id=++t.lastEntityId,this.player=!1,this.projectile=!1,this.solid=!1,t.add(this)}get[Symbol.toStringTag](){return this.name}kill(){return this.alive=!1,this.eachChild(t=>t.kill()),this}eachChild(t){var e;for(let i of this.g.entities.get())((e=i.attachment)==null?void 0:e.parent)===this&&t(i,i.attachment)}setAppearance(t){return this.g.dirty=!0,this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setHoming(t){return this.homing=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setPosition(t){return this.g.dirty=!0,this.position=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,e){return this.g.dirty=!0,this.position={x:t,y:e},this.eachChild((i,r)=>i.move(t+r.x,e+r.y)),this.position}};function Mt(s,t){var r,n,o,a;let e=(n=(r=s.appearance)==null?void 0:r.layer)!=null?n:0,i=(a=(o=t.appearance)==null?void 0:o.layer)!=null?a:0;return e!==i?e-i:s.id-t.id}var tt={};q(tt,{battleship:()=>re,battleshipHull:()=>ne});var Z=w(C());function re(s){let t=new f(s,"Battleship");return s.spawn("battleshipHull").setAttachment({parent:t,x:1,y:0}),s.spawn("battleshipHull").setAttachment({parent:t,x:2,y:0}),s.spawn("battleshipHull").setAttachment({parent:t,x:0,y:1}),s.spawn("battleshipHull").setAttachment({parent:t,x:1,y:1}),s.spawn("battleshipHull").setAttachment({parent:t,x:2,y:1}),s.spawn("machineGun").setAttachment({parent:t,x:0,y:1}),s.spawn("missileLauncher").setAttachment({parent:t,x:2,y:1}),t}function ne(s){return new f(s,"BattleshipHull").setAppearance({glyph:"/",layer:1,fg:Z.Colors.WHITE,bg:Z.Colors.BROWN}).setSolid(!0)}var st={};q(st,{bullet:()=>oe,missile:()=>ae});var et=w(C());function oe(s){return new f(s,"Bullet").setProjectile(!0).setAppearance({glyph:".",layer:3,fg:et.Colors.YELLOW})}function ae(s){let t=new f(s,"Missile").setProjectile(!0).setHoming({strength:.15,duration:10}).setAppearance({glyph:"*",layer:3,fg:et.Colors.DARK_RED});return new f(s,"MissileTrail").setAttachment({parent:t,x:0,y:0}).setTrail({effectPrefab:"puff"}).setLifetime({duration:10}),t}var it={};q(it,{puff:()=>ce});var St=w(C());function ce(s){return new f(s,"Puff").setAppearance({glyph:" ",layer:0,bg:St.Colors.LIGHT_GRAY}).setLifetime({duration:2})}var nt={};q(nt,{machineGun:()=>le,missileLauncher:()=>he});var rt=w(C());function le(s){return new f(s,"MachineGun").setAppearance({glyph:"o",layer:2,fg:rt.Colors.WHITE}).setTurret({bulletPrefab:"bullet",bulletVelocity:2,salvoCount:5,timeBetweenShots:0,timeBetweenSalvos:12})}function he(s){return new f(s,"MissileLauncher").setAppearance({glyph:"o",layer:2,fg:rt.Colors.YELLOW}).setTurret({bulletPrefab:"missile",bulletVelocity:1,salvoCount:1,timeBetweenShots:8,timeBetweenSalvos:8})}var at={};q(at,{player:()=>ue});var ot=w(C());function ue(s){return new f(s,"Player").setPlayer(!0).setAppearance({glyph:">",layer:4,fg:ot.Colors.WHITE,bg:ot.Colors.DARK_RED})}var pe=E(E(E(E(E({},tt),st),it),nt),at);function ct(s,t){return pe[t](s)}var O=class{constructor(t,e=[]){this.compareFn=t;this.items=e;this.dirty=!0}clear(){this.items=[],this.dirty=!1}add(t){this.items.push(t),this.dirty=!0}delete(t){this.items=this.items.filter(e=>e!==t)}sort(){this.items.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.items}};var $t=w(Gt());var Jt=Math.PI*2;function bt(s,t){let e=(s-t)%Jt,i=(t-s)%Jt;return e<i?-e:i}function At(s){let t=Math.cos(s.angle)*s.vel,e=Math.sin(s.angle)*s.vel;return[t,e]}function U(s){return Math.floor(s)}function Kt(s){switch(s.mode){case"fire":s.timer--,s.salvo>0?s.timer<=0&&(s.mode="mid-salvo"):s.mode="reloading";break;case"mid-salvo":s.mode="fire",s.salvo--,s.salvo>0?s.timer=s.timeBetweenShots:s.timer=s.timeBetweenSalvos;break;case"reloading":s.timer--,s.timer<=0&&(s.mode="idle");break;case"idle":default:s.mode="fire",s.salvo=s.salvoCount-1,s.timer=s.timeBetweenShots;break}return s}var Ft=60,zt=40;function V(s,t){return s.tag=t,s}var Y=class{constructor(t){this.term=t;t.update=this.update.bind(this),this.dirty=!0,this.fovRecompute=!0,this.map=new T.Console(Ft,zt,()=>!0),this.lastEntityId=0,this.entities=new O(Mt)}get player(){let t=this.entities.get().find(e=>e.player);if(!t)throw new Error("Could not find a player!");return t}spawn(t){return ct(this,t)}add(t){this.dirty=!0,this.entities.add(t)}addMany(t){this.dirty=!0;for(let e of t)this.add(e)}gotoDemoRoom(){this.entities.clear(),this.map.clear(),this.room(1,1,40,30),this.spawn("player").move(5,25),this.spawn("battleship").move(8,5)}room(t,e,i,r){let{map:n}=this;for(let o=0;o<r;o++)for(let a=0;a<i;a++){let l=a===0||o===0||a===i-1||o===r-1,h=t+a,u=e+o;n.setBlocked(h,u,l),n.setBlockedSight(h,u,l)}}draw(){let{map:t,player:e,term:i,entities:r}=this;this.fovRecompute&&(t.computeFov(e.position.x,e.position.y,20),this.fovRecompute=!1);for(let o=0;o<zt;o++)for(let a=0;a<Ft;a++){let l=t.grid[o][a],h=t.isVisible(a,o),u=l.blockedSight,p=T.Colors.BLACK;h?(p=u?T.Colors.WHITE:T.Colors.DARK_GRAY,l.explored=!0):l.explored&&(p=u?T.Colors.LIGHT_GRAY:T.Colors.BLACK),i.drawChar(a,o,0,0,p)}let n=(o,a,l,h,u)=>{t.isVisible(o,a)&&i.drawChar(o,a,l,h,u)};for(let o of r.get()){let{appearance:a,position:l}=o;a&&l&&n(U(l.x),U(l.y),a.glyph,a.fg,a.bg)}this.dirty=!1}lifetimes(){for(let t of this.entities.get()){let{lifetime:e}=t;e&&--e.duration<=0&&t.kill()}}trails(){for(let t of this.entities.get()){let{position:e,trail:i}=t;e&&i&&this.spawn(i.effectPrefab).setPosition(e)}}homing(){let t=this.player.position;for(let e of this.entities.get()){let{homing:i,motion:r,position:n}=e;if(i&&r&&n){let o=Math.atan2(t.y-n.y,t.x-n.x),a=bt(r.angle,o);Math.abs(a)<=i.strength?r.angle=o:a<0?r.angle-=i.strength:r.angle+=i.strength,--i.duration<=0&&e.setHoming()}}}turrets(){let{entities:t}=this,e=this.player.position;for(let i of t.get()){let{position:r,turret:n}=i;r&&n&&(Kt(n),n.mode==="fire"&&this.spawn(n.bulletPrefab).setPosition({x:r.x+.5,y:r.y+.5}).setMotion({angle:Math.atan2(e.y-r.y,e.x-r.x),vel:n.bulletVelocity}))}}motion(){let{entities:t,map:e,player:i}=this,r=new $t.System;for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++)e.isBlocked(o,n)&&V(r.createBox({x:o,y:n},1,1,{isStatic:!0}),{type:"wall"});for(let n of t.get()){let{solid:o,motion:a,position:l,projectile:h}=n;if(l){let{x:u,y:p}=l;if(o)V(r.createBox({x:u,y:p},1,1),{type:"ship",e:n});else if(h&&a){let[B,I]=At(a),_={x:u+B,y:p+I};V(r.createBox({x:u-.25,y:p-.25},.5,.5),{type:"bullet",e:n}),V(r.createBox({x:_.x-.5,y:_.y-.25},.5,.5),{type:"bullet",e:n}),V(r.createLine({x:u,y:p},_),{type:"bullet",e:n}),n.move(_.x,_.y)}}}V(r.createBox(i.position,1,1),{type:"player"}),r.update(),r.checkAll(n=>{var l,h,u,p;let o=n.a.tag,a=n.b.tag;if(o.type==="wall"){(l=a.e)!=null&&l.projectile&&a.e.kill();return}if(a.type==="wall"){(h=o.e)!=null&&h.projectile&&o.e.kill();return}o.type==="player"&&a.type==="bullet"&&((u=a.e)!=null&&u.alive)?a.e.kill():a.type==="player"&&o.type==="bullet"&&((p=o.e)!=null&&p.alive)&&o.e.kill()})}kills(){for(let t of this.entities.get())t.alive||this.entities.delete(t)}tick(){this.lifetimes(),this.trails(),this.homing(),this.turrets(),this.motion(),this.kills()}handleKeys(){let{map:t,player:e,term:i}=this,r=i.getMovementKey();if(r){let n=e.position.x+r.x,o=e.position.y+r.y;t.isBlocked(n,o)||(e.move(n,o),this.fovRecompute=!0,this.tick())}}update(){this.handleKeys(),this.dirty&&this.draw()}};var Qt=w(C());function ns(s){let i=document.createElement("div");s.appendChild(i);let r=()=>{let u=Math.floor(window.innerWidth/480),p=Math.floor(window.innerHeight/320),B=Math.min(u,p);i.style.width=`${480*B}px`,i.style.height=`${320*B}px`};window.addEventListener("resize",r),r();let n=document.createElement("canvas");i.appendChild(n);let o=new Qt.Terminal(n,60,40),a=new Y(o);a.gotoDemoRoom(),window.g=a}window.addEventListener("load",()=>ns(document.body));})();
//# sourceMappingURL=bundle.js.map
