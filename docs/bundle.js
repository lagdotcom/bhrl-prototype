"use strict";(()=>{var ft=Object.create;var k=Object.defineProperty;var pt=Object.getOwnPropertyDescriptor;var ht=Object.getOwnPropertyNames,z=Object.getOwnPropertySymbols,ct=Object.getPrototypeOf,et=Object.prototype.hasOwnProperty,dt=Object.prototype.propertyIsEnumerable;var tt=(e,t,i)=>t in e?k(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,d=(e,t)=>{for(var i in t||={})et.call(t,i)&&tt(e,i,t[i]);if(z)for(var i of z(t))dt.call(t,i)&&tt(e,i,t[i]);return e};var ut=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),A=(e,t)=>{for(var i in t)k(e,i,{get:t[i],enumerable:!0})},yt=(e,t,i,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of ht(t))!et.call(e,n)&&n!==i&&k(e,n,{get:()=>t[n],enumerable:!(o=pt(t,n))||o.enumerable});return e};var g=(e,t,i)=>(i=e!=null?ft(ct(e)):{},yt(t||!e||!e.__esModule?k(i,"default",{value:e,enumerable:!0}):i,e));var u=ut((Rt,it)=>{it.exports=globalThis.wglt});var w=g(u());var p=class{constructor(t,i){this.g=t;this.name=i;this.alive=!0,this.id=++t.lastEntityId,this.player=!1,this.projectile=!1,this.solid=!1,t.add(this)}get[Symbol.toStringTag](){return this.name}kill(){return this.alive=!1,this.eachChild(t=>t.kill()),this}eachChild(t){var i;for(let o of this.g.entities.get())((i=o.attachment)==null?void 0:i.parent)===this&&t(o,o.attachment)}setAppearance(t){return this.g.dirty=!0,this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setPosition(t){return this.g.dirty=!0,this.position=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,i){return this.g.dirty=!0,this.position={x:t,y:i},this.eachChild((o,n)=>o.move(t+n.x,i+n.y)),this.position}};function ot(e,t){var n,s,r,l;let i=(s=(n=e.appearance)==null?void 0:n.layer)!=null?s:0,o=(l=(r=t.appearance)==null?void 0:r.layer)!=null?l:0;return i!==o?i-o:e.id-t.id}var L={};A(L,{Battleship:()=>gt,BattleshipHull:()=>bt});var G=g(u());var nt=(s=>(s[s.Effect=0]="Effect",s[s.Ship=1]="Ship",s[s.Gun=2]="Gun",s[s.Bullet=3]="Bullet",s[s.Player=4]="Player",s))(nt||{}),c=nt;function gt(e){let t=new p(e,"Battleship");return e.spawn("BattleshipHull").setAttachment({parent:t,x:1,y:0}),e.spawn("BattleshipHull").setAttachment({parent:t,x:2,y:0}),e.spawn("BattleshipHull").setAttachment({parent:t,x:0,y:1}),e.spawn("BattleshipHull").setAttachment({parent:t,x:1,y:1}),e.spawn("BattleshipHull").setAttachment({parent:t,x:2,y:1}),e.spawn("MachineGun").setAttachment({parent:t,x:0,y:1}),e.spawn("HomingMissileLauncher").setAttachment({parent:t,x:2,y:1}),t}function bt(e){return new p(e,"BattleshipHull").setAppearance({glyph:"/",layer:c.Ship,fg:G.Colors.WHITE,bg:G.Colors.BROWN}).setSolid(!0)}var W={};A(W,{Bullet:()=>xt,HomingMissile:()=>wt});var D=g(u());function xt(e){return new p(e,"Bullet").setProjectile(!0).setAppearance({glyph:".",layer:c.Bullet,fg:D.Colors.YELLOW})}function wt(e){return new p(e,"HomingMissile").setProjectile(!0).setHoming({strength:.15,duration:10}).setTrail({effectPrefab:"SmokePuff"}).setExplodes({size:5,falloff:1}).setAppearance({glyph:"*",layer:c.Bullet,fg:D.Colors.DARK_RED})}var K={};A(K,{SmokePuff:()=>Et});var S=g(u());function Et(e){return new p(e,"SmokePuff").setAppearance({glyph:" ",layer:c.Effect,bg:(0,S.fromRgb)(100,100,100,50),blendMode:S.BlendMode.Add}).setLifetime({duration:2})}var Y={};A(Y,{HomingMissileLauncher:()=>Mt,MachineGun:()=>Pt});var N=g(u());function Pt(e){return new p(e,"MachineGun").setAppearance({glyph:"o",layer:c.Gun,fg:N.Colors.WHITE}).setTurret({bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:5,timeBetweenShots:0,timeBetweenSalvos:12})}function Mt(e){return new p(e,"HomingMissileLauncher").setAppearance({glyph:"o",layer:c.Gun,fg:N.Colors.YELLOW}).setTurret({bulletPrefab:"HomingMissile",bulletVelocity:1,salvoCount:1,timeBetweenShots:8,timeBetweenSalvos:8})}var _={};A(_,{Player:()=>At});var j=g(u());function At(e){return new p(e,"Player").setPlayer(!0).setSolid(!0).setAppearance({glyph:">",layer:c.Player,fg:j.Colors.WHITE,bg:j.Colors.DARK_RED})}var vt=d(d(d(d(d({},L),W),K),Y),_);function V(e,t){return vt[t](e)}function y(e){return typeof e=="undefined"?NaN:Math.floor(e)}function O(e){return{x:y(e.x),y:y(e.y)}}var v=class{constructor(t,i=[]){this.compareFn=t;this.items=i;this.dirty=!0}clear(){this.items=[],this.dirty=!1}add(t){this.items.push(t),this.dirty=!0}delete(t){this.items=this.items.filter(i=>i!==t)}sort(){this.items.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.items.slice()}};var rt=Math.PI*2;function X(e,t){let i=(e-t)%rt,o=(t-e)%rt;return i<o?-i:o}function q(e){let t=Math.cos(e.angle)*e.vel,i=Math.sin(e.angle)*e.vel;return[t,i]}function $(e,t){let i=Math.abs(e.x-t.x),o=Math.abs(e.y-t.y);return Math.sqrt(i*i+o*o)}function J(e,t){let i=[],o=Math.floor(e.x-t),n=Math.ceil(e.x+t),s=Math.floor(e.y-t),r=Math.ceil(e.y+t);for(let l=s;l<=r;l++)for(let a=o;a<=n;a++){let h=$(e,{x:a,y:l});h>=t||i.push({x:a,y:l,intensity:t-h})}return i}var st=g(u());var I=g(u());function M(e,t,i){return e*(1-i)+t*i}var B=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[i])=>t-i)}add(t,i){return this.points.push([t,i]),this.sort(),this}get(t){let[i,o]=this.points[0];if(t<=i)return(0,I.fromRgb)(...o);let[n,s]=this.points[this.points.length-1];if(t>=n)return(0,I.fromRgb)(...s);let r=this.points.findIndex(([P])=>P>t),[l,[a,h,m,f]]=this.points[r-1],[E,[H,C,R,b]]=this.points[r],x=(t-l)/(E-l);return(0,I.fromRgb)(M(a,H,x),M(h,C,x),M(m,R,x),M(f,b,x))}};var Bt={fire:new B([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function Tt(e,t){return Bt[e].get(t)}function F(e){if(!(e.intensity<=0))return{glyph:" ",layer:c.Effect,bg:Tt(e.type,e.intensity),blendMode:st.BlendMode.Add}}function Q(e){switch(e.mode){case"fire":e.timer--,e.salvo>0?e.timer<=0&&(e.mode="mid-salvo"):e.mode="reloading";break;case"mid-salvo":e.mode="fire",e.salvo--,e.salvo>0?e.timer=e.timeBetweenShots:e.timer=e.timeBetweenSalvos;break;case"reloading":e.timer--,e.timer<=0&&(e.mode="idle");break;case"idle":default:e.mode="fire",e.salvo=e.salvoCount-1,e.timer=e.timeBetweenShots;break}return e}function U(e,t){let i=t.x-e.x,o=t.y-e.y,n=Math.abs(i),s=Math.abs(o),r=i>0?1:-1,l=o>0?1:-1,a=d({},e),h=[d({},a)];for(let m=0,f=0;m<n||f<s;)(.5+m)/n<(.5+f)/s?(a.x+=r,m++):(a.y+=l,f++),h.push(d({},a));return h}var lt=60,at=40,T=class{constructor(t){this.term=t;t.update=this.update.bind(this),this.dirty=!0,this.fovRecompute=!0,this.map=new w.Console(lt,at,()=>!0),this.lastEntityId=0,this.entities=new v(ot)}get player(){let t=this.entities.get().find(i=>i.player);if(!t)throw new Error("Could not find a player!");return t}spawn(t){return V(this,t)}add(t){this.dirty=!0,this.entities.add(t)}addMany(t){this.dirty=!0;for(let i of t)this.add(i)}gotoDemoRoom(){this.entities.clear(),this.map.clear(),this.room(1,1,40,30),this.spawn("Player").move(5,25),this.spawn("Battleship").move(8,5)}room(t,i,o,n){let{map:s}=this;for(let r=0;r<n;r++)for(let l=0;l<o;l++){let a=l===0||r===0||l===o-1||r===n-1,h=t+l,m=i+r;s.setBlocked(h,m,a),s.setBlockedSight(h,m,a)}}draw(){let{map:t,player:i,term:o,entities:n}=this;this.fovRecompute&&(t.computeFov(i.position.x,i.position.y,20),this.fovRecompute=!1);for(let r=0;r<at;r++)for(let l=0;l<lt;l++){let a=t.grid[r][l],h=t.isVisible(l,r),m=a.blockedSight,f=w.Colors.BLACK;h?(f=m?w.Colors.WHITE:w.Colors.DARK_GRAY,a.explored=!0):a.explored&&(f=m?w.Colors.LIGHT_GRAY:w.Colors.BLACK),o.drawChar(l,r,0,0,f)}let s=(r,l,a,h,m,f)=>{t.isVisible(r,l)&&(f?o.drawCell(r,l,{bg:m},f):o.drawChar(r,l,a,h,m))};for(let r of n.get()){let{appearance:l,position:a}=r;l&&a&&s(y(a.x),y(a.y),l.glyph,l.fg,l.bg,l.blendMode)}this.dirty=!1}getRootID(t){return t.attachment?this.getRootID(t.attachment.parent):t.id}getContents(t){let i={x:y(t.x),y:y(t.y)},o=this.map.isBlocked(i.x,i.y),n=this.entities.get().filter(r=>{var l,a;return y((l=r.position)==null?void 0:l.x)===i.x&&y((a=r.position)==null?void 0:a.y)==i.y}),s=n.find(r=>r.solid);return{wall:o,solid:s,other:n.filter(r=>!r.solid)}}lifetimes(){for(let t of this.entities.get()){let{lifetime:i}=t;i&&--i.duration<=0&&t.kill()}}homing(){let t=this.player.position;for(let i of this.entities.get()){let{homing:o,motion:n,position:s}=i;if(o&&n&&s){let r=Math.atan2(t.y-s.y,t.x-s.x),l=X(n.angle,r);Math.abs(l)<=o.strength?n.angle=r:l<0?n.angle-=o.strength:n.angle+=o.strength,--o.duration<=0&&(i.setHoming(),i.setTrail())}}}turrets(){let{entities:t}=this,i=this.player.position;for(let o of t.get()){let{position:n,turret:s}=o;n&&s&&(Q(s),s.mode==="fire"&&this.spawn(s.bulletPrefab).setIgnoreSolid({ids:[this.getRootID(o)]}).setPosition({x:n.x+.5,y:n.y+.5}).setMotion({angle:Math.atan2(i.y-n.y,i.x-n.x),vel:s.bulletVelocity}))}}fields(){let{entities:t}=this;for(let i of t.get()){let{field:o,position:n}=i;o&&n&&(o.intensity-=o.falloff,i.setAppearance(F(o)),o.intensity<=0&&i.kill())}}motion(){let{entities:t}=this;for(let i of t.get()){let{explodes:o,ignoreSolid:n,motion:s,position:r,trail:l}=i;if(r&&s){let a=d({},r),[h,m]=q(s),f={x:r.x+h,y:r.y+m},E=U(O(a),O(f)),H=a,C=!1,R;for(let b of E){H=b;let{wall:x,solid:P}=this.getContents(b);if(x){C=!0;break}else if(P&&!(n!=null&&n.ids.includes(this.getRootID(P)))){R=P;break}l&&b!==E.slice(-1)[0]&&this.spawn(l.effectPrefab).setPosition(b)}if(C||R?i.kill():i.move(f.x,f.y),!i.alive&&o)for(let{x:b,y:x,intensity:P}of J(H,o.size)){let Z=new p(this,i.name+"Explosion").setPosition({x:b,y:x}).setField({type:"fire",intensity:P,falloff:o.falloff});Z.setAppearance(F(Z.field))}}}}kills(){for(let t of this.entities.get())t.alive||this.entities.delete(t)}tick(){this.lifetimes(),this.homing(),this.turrets(),this.fields(),this.motion(),this.kills()}handleKeys(){let{map:t,player:i,term:o}=this,n=o.getMovementKey();if(n){let s=i.position.x+n.x,r=i.position.y+n.y;t.isBlocked(s,r)||(i.move(s,r),this.fovRecompute=!0,this.tick())}}update(){this.handleKeys(),this.dirty&&this.draw()}};var mt=g(u());function Ht(e){let o=document.createElement("div");e.appendChild(o);let n=()=>{let m=Math.floor(window.innerWidth/480),f=Math.floor(window.innerHeight/320),E=Math.min(m,f);o.style.width=`${480*E}px`,o.style.height=`${320*E}px`};window.addEventListener("resize",n),n();let s=document.createElement("canvas");o.appendChild(s);let r=new mt.Terminal(s,60,40),l=new T(r);l.gotoDemoRoom(),window.g=l}window.addEventListener("load",()=>Ht(document.body));})();
//# sourceMappingURL=bundle.js.map
