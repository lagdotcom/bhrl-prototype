"use strict";(()=>{var De=Object.create;var at=Object.defineProperty;var Ae=Object.getOwnPropertyDescriptor;var ke=Object.getOwnPropertyNames,te=Object.getOwnPropertySymbols,Ie=Object.getPrototypeOf,ie=Object.prototype.hasOwnProperty,Be=Object.prototype.propertyIsEnumerable;var ee=(e,t,i)=>t in e?at(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,H=(e,t)=>{for(var i in t||={})ie.call(t,i)&&ee(e,i,t[i]);if(te)for(var i of te(t))Be.call(t,i)&&ee(e,i,t[i]);return e};var Re=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),L=(e,t)=>{for(var i in t)at(e,i,{get:t[i],enumerable:!0})},Le=(e,t,i,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of ke(t))!ie.call(e,r)&&r!==i&&at(e,r,{get:()=>t[r],enumerable:!(o=Ae(t,r))||o.enumerable});return e};var x=(e,t,i)=>(i=e!=null?De(Ie(e)):{},Le(t||!e||!e.__esModule?at(i,"default",{value:e,enumerable:!0}):i,e));var b=Re((Li,oe)=>{oe.exports=globalThis.wglt});var bt=x(b());var Ce=x(b());function z(e,t=new Map){if(!e||typeof e!="object")return e;if(t.has(e))return t.get(e);let i;if(e.nodeType&&"cloneNode"in e)i=e.cloneNode(!0),t.set(e,i);else if(e instanceof Date)i=new Date(e.getTime()),t.set(e,i);else if(e instanceof RegExp)i=new RegExp(e),t.set(e,i);else if(Array.isArray(e)){i=new Array(e.length),t.set(e,i);for(let o=0;o<e.length;o++)i[o]=z(e[o],t)}else if(e instanceof Map){i=new Map,t.set(e,i);for(let[o,r]of e.entries())i.set(o,z(r,t))}else if(e instanceof Set){i=new Set,t.set(e,i);for(let o of e)i.add(z(o,t))}else if(e instanceof Object){i={},t.set(e,i);for(let[o,r]of Object.entries(e))i[o]=z(r,t)}else throw Error(`Unable to clone ${e}`);return i}function re(e){return z(e,new Map)}var xt=re,ne=Object.keys,se=e=>{let t={};for(let[i,o]of e)t[i]=o;return t};var F=class{constructor(t,i){this.g=t;this.name=i;this.alive=!0,this.id=++t.lastEntityId,this.solid=!1,this.tags=new Set}applyPrefab(t,i){if(this.prefab=t,i.components&&Object.assign(this,xt(i.components)),i.children)for(let{name:o,x:r,y:n,overlay:s,tags:a}of i.children){let l=this.g.spawn(o).setAttachment({parent:this,x:r,y:n});if(s)for(let p of ne(s))Object.assign(l[p],xt(s[p]));if(a)for(let p of a)l.tags.add(p)}return this}get[Symbol.toStringTag](){return this.name}kill(t){return this.alive=!1,this.eachChild(i=>this.g.kill(i,t)),this}eachChild(t){var i;for(let o of this.g.entities.get())((i=o.attachment)==null?void 0:i.parent)===this&&t(o,o.attachment)}setOwner(t){return this.owner=t,this}setAI(t){return this.ai=t,this}setAppearance(t){return this.g.refresh(),this.appearance=t,this}setAttachment(t){return this.attachment=t,this}setExplodes(t){return this.explodes=t,this}setField(t){return this.field=t,this}setHoming(t){return this.homing=t,this}setIgnoreSolid(t){return this.ignoreSolid=t,this}setLifetime(t){return this.lifetime=t,this}setMotion(t){return this.motion=t,this}setPilot(t){return this.pilot=t,this}setPosition(t){return this.g.refresh(),this.position=t,this}setShip(t){return this.ship=t,this}setTrail(t){return this.trail=t,this}setTurret(t){return this.turret=t,this}setPlayer(t){return this.player=t,this}setProjectile(t){return this.projectile=t,this}setSolid(t){return this.solid=t,this}move(t,i){return this.g.refresh(),this.position={x:t,y:i},this.eachChild((o,r)=>o.move(t+r.x,i+r.y)),this}};function ae(e,t){var r,n,s,a;let i=(n=(r=e.appearance)==null?void 0:r.layer)!=null?n:0,o=(a=(s=t.appearance)==null?void 0:s.layer)!=null?a:0;return i!==o?i-o:e.id-t.id}var le=["damage","draw","kill","move","notice","playerFire","playerMove","spawn","tick"];var Pt={};L(Pt,{Battleship:()=>Fe,BattleshipHull:()=>Ge});var Et=x(b());var pe=(n=>(n[n.Effect=0]="Effect",n[n.Ship=1]="Ship",n[n.Gun=2]="Gun",n[n.Bullet=3]="Bullet",n[n.Player=4]="Player",n))(pe||{}),d=pe;var f=(e,t,i,o,r)=>({name:e,x:t,y:i,overlay:o,tags:r}),g=(e,t,i=0)=>({name:e,maxHp:t,hp:0,maxShield:i,shield:0});var Fe={components:{ai:{idealDistance:8,speed:1},ship:g("Battleship",40)},children:[{name:"BattleshipHull",x:1,y:0},{name:"BattleshipHull",x:2,y:0},{name:"BattleshipHull",x:0,y:1},{name:"BattleshipHull",x:1,y:1},{name:"BattleshipHull",x:2,y:1},{name:"MachineGun",x:0,y:1},{name:"HomingMissileLauncher",x:2,y:1},{name:"FighterLauncher",x:2,y:0}]},Ge={components:{solid:!0,appearance:{glyph:"/",layer:d.Ship,fg:Et.Colors.WHITE,bg:Et.Colors.BROWN}}};var wt={};L(wt,{Bullet:()=>Oe,HomingMissile:()=>We,PlayerBullet:()=>Ne});var lt=x(b());var Ke={Club:"",Dot:"\x07",RingInvert:`
`,Female:"\f",Pilcrow:"",Silcrow:"",ResizeVertical:"",RightArrow:"",LeftArrow:"\x1B",DownWedge:"",Pentagon:"\x7F",CapitalUUmlaut:"\x9A",Cent:"\x9B",Yen:"\x9D",NotFlip:"\xA9",Not:"\xAA",InvertedExclamation:"\xAD",BoxVerticalSingle:"\xB3",BoxUpSingleHorizontalSingle:"\xC1",BoxDownSingleHorizontalSingle:"\xC2",BoxHorizontalSingle:"\xC4",BoxUpDoubleHorizontalSingle:"\xD0",BoxDownSingleHorizontalDouble:"\xD1",BoxVerticalDoubleHorizontalSingle:"\xD7",Pi:"\xE3",Theta:"\xE9",Omega:"\xEA",SymbolED:"\xED",HorizontalDivide:"\xF6"},m=Ke;var Oe={components:{projectile:{damage:1},appearance:{glyph:".",layer:d.Bullet,fg:lt.Colors.YELLOW}}},We={components:{projectile:{damage:1},homing:{strength:.15,duration:10},trail:{effectPrefab:"SmokePuff"},explodes:{size:5,falloff:1},appearance:{glyph:"*",layer:d.Bullet,fg:lt.Colors.DARK_RED}}},Ne={components:{projectile:{damage:3},appearance:{glyph:m.InvertedExclamation,layer:d.Bullet,fg:lt.Colors.YELLOW}}};var St={};L(St,{AirFistRange:()=>_e,SmokePuff:()=>Ve});var V=x(b());var _e={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:d.Effect,bg:(0,V.fromRgb)(0,255,255,100),blendMode:V.BlendMode.Add}}},Ve={components:{lifetime:{duration:2},appearance:{glyph:" ",layer:d.Effect,bg:(0,V.fromRgb)(100,100,100,50),blendMode:V.BlendMode.Add}}};var Ht={};L(Ht,{Fighter:()=>Ye,FighterHull:()=>$e,FighterLauncher:()=>je});var pt=x(b());var G=(e,t,{bulletPrefab:i="Bullet",bulletVelocity:o=1,salvoCount:r=1,timeBetweenShots:n=1,timeBetweenSalvos:s=1})=>({name:e,bulletPrefab:i,bulletAngle:t,bulletVelocity:o,salvoCount:r,timeBetweenShots:n,timeBetweenSalvos:s,timer:0,salvo:r});var je={components:{appearance:{glyph:"_",layer:d.Gun,fg:pt.Colors.DARK_CYAN},turret:G("Fighter Bay","nearestEnemy",{bulletPrefab:"Fighter",bulletVelocity:0,salvoCount:1,timeBetweenSalvos:20})}},Ye={components:{ai:{idealDistance:6,speed:2},ship:g("Fighter",2)},children:[{name:"FighterHull",x:0,y:0,overlay:{appearance:{glyph:"<"}}},{name:"FighterHull",x:1,y:0},{name:"FighterHull",x:2,y:0,overlay:{appearance:{glyph:">"}}},{name:"PeaShooter",x:1,y:0}]},$e={components:{solid:!0,appearance:{glyph:"-",layer:d.Ship,fg:pt.Colors.YELLOW,bg:pt.Colors.DARK_BLUE}}};var vt={};L(vt,{HomingMissileLauncher:()=>ze,MachineGun:()=>qe,PeaShooter:()=>Qe,PlayerGun:()=>Xe});var Ue={Right:0,Down:Math.PI/2,Left:Math.PI,Up:Math.PI*3/2},mt=Ue;var Q=x(b());var qe={components:{appearance:{glyph:"o",layer:d.Gun,fg:Q.Colors.WHITE},turret:G("Machine Gun",mt.Down,{bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:5,timeBetweenShots:0,timeBetweenSalvos:12})}},ze={components:{appearance:{glyph:"o",layer:d.Gun,fg:Q.Colors.YELLOW},turret:G("Homing Missile","nearestEnemy",{bulletPrefab:"HomingMissile",bulletVelocity:1,salvoCount:1,timeBetweenSalvos:8})}},Qe={components:{appearance:{glyph:"o",layer:d.Gun,fg:Q.Colors.LIGHT_GRAY},turret:G("Pea Shooter",mt.Down,{bulletPrefab:"Bullet",bulletVelocity:2,salvoCount:1,timeBetweenSalvos:3})}},Xe={components:{appearance:{glyph:"o",layer:d.Gun,fg:Q.Colors.WHITE},turret:G("Pew Pew",mt.Up,{bulletPrefab:"PlayerBullet",bulletVelocity:2,salvoCount:2,timeBetweenShots:0,timeBetweenSalvos:3})}};var Ct={};L(Ct,{PlayerHull:()=>Je,PlayerShip:()=>Ze});var Mt=x(b());var Je={components:{solid:!0,appearance:{glyph:"#",layer:d.Player,fg:Mt.Colors.DARK_GRAY}}},Ze={components:{player:{weaponArrays:["Primary"]},ship:g("Ace of Clubs",20,10)},children:[f("PlayerHull",0,0,{appearance:{glyph:m.LeftArrow}}),f("PlayerHull",1,0,{appearance:{glyph:m.Club,fg:Mt.Colors.LIGHT_GRAY}}),f("PlayerHull",2,0,{appearance:{glyph:m.RightArrow}}),f("PlayerGun",1,0,void 0,["Primary"])]};var Tt={};L(Tt,{CruiseyWing:()=>hi,Demigod:()=>ui,DroneA:()=>pi,DroneB:()=>mi,DroneC:()=>fi,GoutOFlame:()=>di,Hull:()=>ti,Olm:()=>ci,ShipA:()=>ei,ShipB:()=>ii,ShipC:()=>oi,ShipD:()=>ri,ShipE:()=>ni,ShipF:()=>si,ShipG:()=>ai,ShipH:()=>li});var me=x(b());var ti={components:{solid:!0,appearance:{glyph:"#",layer:d.Ship,fg:me.Colors.DARK_GRAY}}},ei={components:{ship:g("A",0)},children:[f("Hull",0,0,{appearance:{glyph:m.Pilcrow}})]},ii={components:{ship:g("B",0)},children:[f("Hull",0,0,{appearance:{glyph:m.Yen}})]},oi={components:{ship:g("C",0)},children:[f("Hull",0,0,{appearance:{glyph:"W"}})]},ri={components:{ship:g("D",0)},children:[f("Hull",0,0,{appearance:{glyph:m.Omega}})]},ni={components:{ship:g("E",0)},children:[f("Hull",0,0,{appearance:{glyph:m.DownWedge}})]},si={components:{ship:g("F",0)},children:[f("Hull",0,0,{appearance:{glyph:m.Pi}})]},ai={components:{ship:g("G",0)},children:[f("Hull",0,0,{appearance:{glyph:"M"}})]},li={components:{ship:g("H",0)},children:[f("Hull",0,0,{appearance:{glyph:m.Female}})]},pi={components:{ship:g("Drone A",1)},children:[f("Hull",0,0,{appearance:{glyph:m.Theta}})]},mi={components:{ship:g("Drone B",1)},children:[f("Hull",0,0,{appearance:{glyph:m.SymbolED}})]},fi={components:{ship:g("Drone C",1)},children:[f("Hull",0,0,{appearance:{glyph:m.Silcrow}})]},hi={components:{ship:g("Cruisey Wing",10,5)},children:[f("Hull",0,0,{appearance:{glyph:m.Not}}),f("Hull",1,0,{appearance:{glyph:m.HorizontalDivide}}),f("Hull",2,0,{appearance:{glyph:m.NotFlip}})]},ci={components:{ship:g("Olm",15,4)},children:[f("Hull",0,0,{appearance:{glyph:m.Cent}}),f("Hull",0,1,{appearance:{glyph:m.ResizeVertical}}),f("Hull",0,2,{appearance:{glyph:m.BoxDownSingleHorizontalDouble}})]},di={components:{ship:g("Gout-'o-flame",5,20)},children:[f("Hull",0,0,{appearance:{glyph:m.Pentagon}}),f("Hull",1,0,{appearance:{glyph:m.BoxVerticalDoubleHorizontalSingle}}),f("Hull",2,0,{appearance:{glyph:m.Pentagon}}),f("Hull",1,1,{appearance:{glyph:m.BoxUpDoubleHorizontalSingle}})]},ui={components:{ship:g("Demigod",30,15)},children:[f("Hull",1,0,{appearance:{glyph:m.CapitalUUmlaut}}),f("Hull",0,1,{appearance:{glyph:"}"}}),f("Hull",1,1,{appearance:{glyph:m.RingInvert}}),f("Hull",2,1,{appearance:{glyph:"{"}}),f("Hull",1,2,{appearance:{glyph:"Y"}})]};var yi=H(H(H(H(H(H(H({},Pt),wt),St),Ht),vt),Ct),Tt);function Dt(e,t){return e.add(new F(e,t).applyPrefab(t,yi[t]))}function v(e){return typeof e=="undefined"?NaN:Math.floor(e)}function C(e){return{x:v(e.x),y:v(e.y)}}function R(e,t){if(typeof e=="undefined"||typeof t=="undefined")return!1;let i=C(e),o=C(t);return i.x===o.x&&i.y===o.y}function T(e,t){return{x:e.x+t.x,y:e.y+t.y}}var X=class{constructor(t,i=[]){this.compareFn=t;this.entities=i;this.dirty=!0}clear(){this.entities=[],this.dirty=!1}add(t){this.entities.push(t),this.dirty=!0}clearDead(){this.entities=this.entities.filter(t=>t.alive)}sort(){this.entities.sort(this.compareFn),this.dirty=!1}get(){return this.dirty&&this.sort(),this.entities.slice()}};var u=x(b());var q=x(b());function gi(e,t){if(!t||!e.length)throw new Error("Could not get midpoint");let i=o=>e.reduce((r,{offset:n})=>r+n[o],0)/e.length;return{x:t.x+i("x"),y:t.y+i("y")}}function bi(e,t,i,o=[]){let r=[];for(let{offset:n}of t){let s=T(i,n),{wall:a,solid:l}=e.getContents(s,o);a?r.push({absolute:s,offset:n,entity:"wall"}):l&&r.push({absolute:s,offset:n,entity:l})}return r}function M(e,t){let i=e.getRoot(t);return e.entities.get().filter(o=>e.getRoot(o)===i)}function J(e,t){return M(e,t).map(i=>i.id)}function D(e,t){var a;let i=(a=e.getRoot(t).position)!=null?a:{x:0,y:0},o=M(e,t),r=[],n=0,s=0;for(let l of o){let{attachment:p,solid:h}=l;if(p&&h){let{x:c,y}=p;r.push({absolute:T(i,p),offset:{x:c,y},entity:l}),n=Math.max(c+1,n),s=Math.max(y+1,s)}}return{layout:r,topLeft:i,width:n,height:s}}function fe(e,t,i){let o=J(e,t),{layout:r,topLeft:n}=D(e,t);return!i||!n?[]:bi(e,r,i||n,o)}function j(e,t){let{layout:i,topLeft:o}=D(e,t);if(!o||!i.length)throw new Error(`Could not get midpoint of entity#${t.id}`);return gi(i,o)}var E=class{constructor(t,i){this.list=t;this.filter=i}matches(t){if(!t.alive)return!1;for(let i of this.filter)if(!t[i])return!1;return!0}forEach(t){for(let i of this.list.get())this.matches(i)&&t(i,i)}};var At=[{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:-1}];function kt(e){return At.map(t=>T(e,t))}function A(e){if(!e.length)throw new Error("oneOf passed empty array");return e[Math.floor(Math.random()*e.length)]}function It(e){let t=new E(e.entities,["ai","position"]);e.on("tick",()=>t.forEach(({ai:i,position:o},r)=>{i.attacking||(i.attacking=e.player,e.fire("notice",{e:r,noticed:e.player}));let n=J(e,r),{layout:s}=D(e,r),a=C(o),l=e.getDistanceMap(i.attacking),p=P=>{let{solid:S,wall:I}=e.getContents(P,n);return!S&&!I},h=P=>p(P)?Math.abs(l.getOrDefault(P,1/0)-i.idealDistance):1/0,c=P=>s.reduce((S,{offset:I})=>S+h(T(P,I)),0)/s.length,y=c(a),w=[];for(let P of At){let S=T(a,P);if(!l.has(S))continue;let I=c(S);I<y?(y=I,w=[S]):I===y&&w.push(S)}if(w.length){let P=A(w);r.move(P.x,P.y);return}})),e.on("damage",({e:i,inflicter:o})=>{var r;if(i!==o&&i.ai&&!i.ai.attacking){let n=e.getRoot((r=o.owner)!=null?r:o);n.alive&&(i.ai.attacking=n)}})}function Bt(e){let t=new E(e.entities,["appearance","position"]);e.on("draw",()=>t.forEach(({appearance:i,position:o})=>e.drawIfVisible(v(o.x),v(o.y),i.glyph,i.fg,i.bg,i.blendMode)))}var he=x(b());var ft=x(b());function Y(e,t,i){return e*(1-i)+t*i}var Z=class{constructor(t){this.points=t;this.sort()}sort(){this.points.sort(([t],[i])=>t-i)}add(t,i){return this.points.push([t,i]),this.sort(),this}get(t){let[i,o]=this.points[0];if(t<=i)return(0,ft.fromRgb)(...o);let[r,n]=this.points[this.points.length-1];if(t>=r)return(0,ft.fromRgb)(...n);let s=this.points.findIndex(([Te])=>Te>t),[a,[l,p,h,c]]=this.points[s-1],[y,[w,P,S,I]]=this.points[s],st=(t-a)/(y-a);return(0,ft.fromRgb)(Y(l,w,st),Y(p,P,st),Y(h,S,st),Y(c,I,st))}};function tt(e,t){let i=Math.abs(e.x-t.x),o=Math.abs(e.y-t.y);return Math.sqrt(i*i+o*o)}var xi={fire:new Z([[0,[0,0,0,0]],[2,[255,0,0,150]],[4,[255,255,0,150]],[6,[255,255,255,150]],[10,[255,255,255,255]]])};function Rt(e){if(!(e.intensity<=0))return{glyph:" ",layer:d.Effect,bg:xi[e.type].get(e.intensity),blendMode:he.BlendMode.Add}}function ce(e,t){let i=[],o=Math.floor(e.x-t),r=Math.ceil(e.x+t),n=Math.floor(e.y-t),s=Math.ceil(e.y+t);for(let a=n;a<=s;a++)for(let l=o;l<=r;l++){let p=tt(e,{x:l,y:a});p>=t||i.push({x:l,y:a,intensity:t-p})}return i}function Lt(e){e.on("kill",({e:t})=>{let{explodes:i,name:o,position:r}=t;if(i&&r)for(let{x:n,y:s,intensity:a}of ce(r,i.size))e.add(new F(e,o+"Explosion").setPosition({x:n,y:s}).setField({type:"fire",intensity:a,falloff:i.falloff}))})}function Ft(e){let t=new E(e.entities,["ship"]),i=new E(e.entities,["field","position"]);e.on("tick",()=>i.forEach(({field:o,position:r},n)=>{o.intensity-=o.falloff,n.setAppearance(Rt(o)),o.intensity<=0?e.kill(n):t.forEach((s,a)=>{let{layout:l}=D(e,a);l.find(({absolute:h})=>R(h,r))&&e.damage(a,o.intensity,n)})})),e.on("spawn",({e:o})=>{o.field&&o.setAppearance(Rt(o.field))})}var _=x(b());var ct=x(b());var K=x(b()),ht=[0,K.Colors.DARK_RED,K.Colors.BROWN,K.Colors.LIGHT_RED,K.Colors.ORANGE,K.Colors.YELLOW,K.Colors.WHITE];var O=class{constructor(t,i){this.g=t;this.pilot=i;this.width=11,this.height=this.isPlayer?1:2}get isPlayer(){return isNaN(this.pilot.difficulty)}draw(t,i){this.isPlayer||(this.g.term.drawString(t,i,this.pilot.name,this.pilot.star?ct.Colors.YELLOW:ct.Colors.LIGHT_GRAY),i++),this.drawStat(t,i,"body"),this.drawStat(t+3,i,"mind"),this.drawStat(t+6,i,"spirit"),this.drawStat(t+9,i,"talent")}drawStat(t,i,o){let r=this.pilot[o];this.g.term.drawChar(t,i,o[0].toUpperCase(),ct.Colors.WHITE),this.g.term.drawChar(t+1,i,r.toString(),ht[r])}};var k=x(b());function Gt(e,t,i,o,r,n,s,a,l){let p=`${Math.ceil(r)}/${n}`,h=Math.floor(r/n*o);e.drawHLine(t,i,o," ",void 0,a),h&&e.drawHLine(t,i,h," ",void 0,s),e.drawCenteredString(t+o/2,i,p,l)}var W=class{constructor(t,i){this.g=t;this.ship=i;this.width=Math.max(13,i.name.length),this.height=i.maxShield?3:2}draw(t,i){let{ship:o,width:r}=this,{term:n}=this.g,s=r-3;n.drawString(t,i,o.name,k.Colors.WHITE),n.drawString(t,i+1,"HP:",k.Colors.WHITE),Gt(n,t+3,i+1,s,o.hp,o.maxHp,k.Colors.DARK_GREEN,k.Colors.DARK_RED,k.Colors.WHITE),o.maxShield&&(n.drawString(t,i+2,"Sh:",k.Colors.WHITE),Gt(n,t+3,i+2,s,o.shield,o.maxShield,k.Colors.DARK_CYAN,k.Colors.LIGHT_BLUE,k.Colors.WHITE))}};var et=x(b());var de=Math.PI*2;function $(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}function ue(e,t){let i=(e-t)%de,o=(t-e)%de;return i<o?-i:o}function dt(e){let t=Math.cos(e.angle)*e.vel,i=Math.sin(e.angle)*e.vel;return[t,i]}function Kt(e){return e.salvo<=0?"Reloading":e.timer>0?"Chambering":"Ready"}function ye(e){e.timer>0&&(e.timer--,e.timer<=0&&e.salvo<=0&&(e.salvo=e.salvoCount))}function ut(e){return e.timer===0}function yt(e,t,i,o,r,n=[]){--t.salvo<=0?t.timer=t.timeBetweenSalvos:t.timer=t.timeBetweenShots;let s={x:i.x+.5,y:i.y+.5},a=t.bulletAngle==="nearestEnemy"?$(s,o):t.bulletAngle,l=e.spawn(t.bulletPrefab).setIgnoreSolid({ids:n}).move(s.x,s.y);return t.bulletVelocity&&l.setMotion({angle:a,vel:t.bulletVelocity}),l.ai||l.setOwner(r),l}var Ei={Reloading:et.Colors.LIGHT_RED,Ready:et.Colors.YELLOW,Chambering:et.Colors.BROWN},N=class{constructor(t,i){this.g=t;this.turret=i;this.width=Math.max(i.name.length,this.stateLabel.length),this.height=2}get stateLabel(){let{timer:t,salvo:i,salvoCount:o}=this.turret,r=Kt(this.turret);if(r==="Reloading")return`Reloading (${t})`;let n=`${i}/${o}`;return r==="Ready"?n:`${n} (${t})`}draw(t,i){this.g.term.drawString(t,i,this.turret.name,et.Colors.WHITE);let o=Kt(this.turret);this.g.term.drawString(t,i+1,this.stateLabel,Ei[o])}};function Ot(e,t){return t===1?e:e+"s"}var U=6;function Wt(e){let{mapHeight:t,term:i}=e;e.on("draw",()=>{let o=e.player,{pilot:r,ship:n}=o;i.fillRect(0,t,i.width,U," ",_.Colors.WHITE,_.Colors.BLACK),i.drawSingleBox(0,t,i.width,U);let s=1,a=t+1,l=new W(e,n);l.draw(s,a);let p=s+Math.floor((l.width-11)/2);new O(e,r).draw(p,a+3),s+=l.width+1,i.drawChar(s-1,a-1,m.BoxDownSingleHorizontalSingle,_.Colors.WHITE),i.drawVLine(s-1,a,U-2,m.BoxVerticalSingle,_.Colors.WHITE),i.drawChar(s-1,a+U-2,m.BoxUpSingleHorizontalSingle,_.Colors.WHITE);for(let c of o.player.weaponArrays){let y=M(e,o).filter(P=>P.turret),w=s;for(let P of y){let S=new N(e,P.turret);S.draw(w,a+1),w+=S.width+1}i.drawString(s,a,`${c} ${Ot("Weapon",y.length)}`,_.Colors.LIGHT_CYAN)}})}function Nt(e){let t=new E(e.entities,["homing","motion","position"]);e.on("tick",()=>t.forEach(({homing:i,motion:o,position:r},n)=>{var p;if(!((p=i.target)!=null&&p.alive))return;let s=j(e,i.target),a=$(r,s),l=ue(o.angle,a);Math.abs(l)<=i.strength?o.angle=a:l<0?o.angle-=i.strength:o.angle+=i.strength,--i.duration<=0&&(n.setHoming(),n.setTrail())}))}function _t(e){let t=new E(e.entities,["lifetime"]);e.on("tick",()=>t.forEach(({lifetime:i},o)=>{--i.duration<=0&&e.kill(o)}))}function ge(e,t){let i=t.x-e.x,o=t.y-e.y,r=Math.abs(i),n=Math.abs(o),s=i>0?1:-1,a=o>0?1:-1,l=H({},e),p=[H({},l)];for(let h=0,c=0;h<r||c<n;)(.5+h)/r<(.5+c)/n?(l.x+=s,h++):(l.y+=a,c++),p.push(H({},l));return p}function be(e,t,i){let o=[],r=(n,s)=>{let a=v(n),l=v(s);o.find(p=>p.x===a&&p.y===l)||o.push({x:a,y:l})};for(let n=0;n<=Math.floor(i*Math.sqrt(.5));n++){let s=Math.floor(Math.sqrt(i*i-n*n));r(e-s,t+n),r(e+s,t+n),r(e-s,t-n),r(e+s,t-n),r(e+n,t-s),r(e+n,t+s),r(e-n,t-s),r(e-n,t+s)}return o}function Vt(e){let t=new E(e.entities,["motion","position"]);e.on("tick",()=>t.forEach(({motion:i,position:o,projectile:r,ignoreSolid:n},s)=>{let[a,l]=dt(i),p={x:o.x+a,y:o.y+l},h=ge(C(o),C(p)),c=!1,y;for(let w of h){if(!e.inBounds(w)){e.kill(s);return}e.move(s,w);let{wall:P,solid:S}=e.getContents(w,n==null?void 0:n.ids);if(P){c=!0;break}else if(S){y=S;break}}c?e.kill(s):y?(r&&e.damage(y,r.damage,s),e.kill(s)):e.move(s,p)}))}function jt(e){e.on("playerMove",({move:t})=>{let i=e.player,o=T(i.position,t);fe(e,i,o).length||(i.move(o.x,o.y),e.tick())}),e.on("playerFire",({array:t})=>{let i=e.player,o=i.player.weaponArrays[t],r=M(e,i),n=r.filter(a=>a.tags.has(o)),s=!1;for(let a of n)a.turret&&ut(a.turret)&&(yt(e,a.turret,a.position,{x:0,y:0},i,r.map(l=>l.id)),s=!0);s&&e.tick()})}function Yt(e){let t=new E(e.entities,["pilot","ship"]);e.on("tick",()=>t.forEach(({pilot:i,ship:o})=>{let r=i.body;o.shield=Math.min(o.maxShield,o.shield+r)}))}var xe=["Typical","Healthy","Double","Multi","Drain","StarPilot","Mega"];var B=x(b());var Pi={name:"Basic",difficulty:0,body:1,mind:1,spirit:1,talent:1,class:[]},wi=[Pi],Ee=wi;var Si={name:"Bodini",star:!0,difficulty:4,body:3,mind:2,spirit:3,talent:2,class:[]},Hi=[Si],Pe=Hi;function $t(e,t=0){let i=[];for(let o=t;o<e;o++)i.push(o);return i}function gt(e,t){let{ship:i}=e;if(!i)throw new Error(`Cannot put pilot into entity ${e.name} (no ship)`);e.setPilot(t),i.maxHp+=t.body}function Ut(e){for(let t=e.length-1;t>0;t--){let i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}return e}var vi=e=>["DroneA","DroneB","DroneC"].includes(e),Mi=e=>["Healthy","Multi","Mega"].includes(e),Ci={Typical:{fg:B.Colors.DARK_GRAY},Healthy:{fg:B.Colors.DARK_GREEN},Double:{fg:B.Colors.LIGHT_GRAY},Multi:{fg:B.Colors.DARK_MAGENTA},Drain:{fg:B.Colors.DARK_RED},StarPilot:{fg:B.Colors.YELLOW},Mega:{fg:B.Colors.BLACK,bg:B.Colors.DARK_MAGENTA}};var Ti={Typical:0,Healthy:2,Double:3,Multi:6,Drain:4,StarPilot:8,Mega:20},Di=["ShipA","ShipB","ShipC","ShipD","ShipE","ShipF","ShipG","ShipH","DroneA","DroneB","DroneC","CruiseyWing","Olm","GoutOFlame","Demigod"],Ai={ShipA:1,ShipB:1,ShipC:1,ShipD:1,ShipE:1,ShipF:1,ShipG:1,ShipH:1,DroneA:2,DroneB:2,DroneC:2,CruiseyWing:8,Olm:10,GoutOFlame:20,Demigod:40};function ki(e,t){if(!vi(e))return t==="StarPilot"||t==="Mega"?A(Pe):A(Ee)}function we(e,t){var i;for(;;){let o=A(Di),r=A(xe),n=ki(o,r),s=Ti[r]+Ai[o]+((i=n==null?void 0:n.difficulty)!=null?i:0);if(s<=t){let a=e.spawn(o),{ship:l}=a;if(!l)throw new Error(`Ship prefab ${o} doesn't have a ship component!`);Mi(r)&&(l.maxHp=l.maxHp*2+3),n&&gt(a,n),a.setAI({idealDistance:6,speed:1}),l.hp=l.maxHp,l.shield=l.maxShield;let p=Ci[r];for(let h of M(e,a))h.appearance&&Object.assign(h.appearance,p);return{entity:a,difficulty:s}}}}function Ii(e,t,i,o,r){for(let n=0;n<r;n++)for(let s=0;s<o;s++){let{wall:a,solid:l,other:p}=e.getContents({x:t+s,y:i+n});if(a||l||p.length)return!1}return!0}function Se(e,t,i){for(let o=0;o<5;o++){let r=Ut($t(e.term.width-t));for(let n of r)if(Ii(e,n,o,t,i))return{x:n,y:o}}throw new Error(`Could not find spawn position for ${t}x${i}!`)}function qt(e){let t=0;e.on("tick",()=>{if(t++,!(t%10)){let i=Math.ceil(t/20),{entity:o}=we(e,i),{width:r,height:n}=D(e,o),s=Se(e,r,n);o.move(s.x,s.y)}})}function zt(e){e.on("move",({e:t,old:i,pos:o})=>{t.trail&&!R(i,o)&&e.spawn(t.trail.effectPrefab).setPosition(i)})}function Qt(e){let t=new E(e.entities,["position","turret"]);e.on("tick",()=>t.forEach(({position:i,turret:o},r)=>{var a;let n=e.getRoot(r),s=(a=n.ai)==null?void 0:a.attacking;if(ye(o),!!(s!=null&&s.alive)&&ut(o)&&s){let l=j(e,s),p=yt(e,o,i,l,n,J(e,r));p.homing&&(p.homing.target=s),p.ai&&(p.ai.attacking=s)}}))}function He(e){_t(e),Nt(e),Qt(e),Ft(e),Yt(e),Vt(e),It(e),qt(e),Bt(e),Wt(e),zt(e),Lt(e),jt(e)}var Xt=x(b());function ve(e,t,i){if(!i.length)return;let o=[],r=1,n=1;for(let p of i){if(p.ship){let c=new W(e,p.ship);o.push({x:r,y:n,object:c}),n+=c.height+1}if(p.pilot){let c=new O(e,p.pilot);o.push({x:r,y:n,object:c}),n+=c.height+1}let h=M(e,p);for(let c of h.filter(y=>y.turret)){let y=new N(e,c.turret);o.push({x:r,y:n,object:y}),n+=y.height+1}}let s=Math.max(...o.map(p=>p.object.width))+2,a=Math.min(t.x+2,e.term.width-s),l=Math.min(t.y,e.term.height-n);e.term.fillRect(a,l,s,n," ",Xt.Colors.WHITE,Xt.Colors.BLACK),e.term.drawSingleBox(a,l,s,n);for(let p of o)p.object.draw(a+p.x,l+p.y)}function Me(e,t,i){for(let o of e.entities.get()){let{motion:r,projectile:n,position:s}=o;if(r&&n&&s&&tt(t,s)<=i){let a=$(t,s);r.angle=a,o.setIgnoreSolid()}}for(let o of be(t.x,t.y,i))e.spawn("AirFistRange").setPosition(o)}var it=class{constructor(t,i,o){this.g=t;this.shipPrefab=i;this.pilot=o;this.dirty=!0,this.examining=[]}init(){let{g:t}=this;this.examineAt=void 0,this.examining=[],t.clearEventHandlers(),t.entities.clear(),t.blankMap(),t.player=this.makePlayer();let{width:i,height:o}=D(t,t.player);t.player.move(v(t.mapWidth/2-i/2),t.mapHeight-o-4),He(t)}makePlayer(){let{g:t,shipPrefab:i,pilot:o}=this,r=t.spawn(i);if(!r.ship)throw new Error(`Ship prefab ${i} doesn't have a ship component!`);return gt(r,o),r.ship.hp=r.ship.maxHp,r.ship.shield=r.ship.maxShield,r}draw(){let{map:t,mapWidth:i,mapHeight:o,overlays:r,term:n}=this.g;for(let s=0;s<o;s++)for(let a=0;a<i;a++){let l=t.grid[s][a];n.drawChar(a,s,0,l.fg,l.bg)}if(this.g.fire("draw",void 0),this.dirty=!1,this.showOverlay){let s=r.get(this.showOverlay);if(s)for(let a=0;a<o;a++)for(let l=0;l<i;l++){let p=s.get({x:l,y:a})||1/0,h=p===1/0?"-":p<10?`${p}`:"*";n.drawChar(l,a,h,q.Colors.LIGHT_RED)}}this.examineAt&&ve(this.g,this.examineAt,this.examining)}update(){(this.g.term.mouse.dx||this.g.term.mouse.dy)&&this.handleMouseMove(),this.handleKeys(),this.dirty&&this.draw()}examine(t){if(R(this.examineAt,t))return;this.examineAt=t,this.dirty=!0;let{solid:i,other:o}=this.g.getContents(t),r=new Set;i&&r.add(this.g.getRoot(i));for(let n of o)r.add(this.g.getRoot(n));this.examining=[...r]}handleMouseMove(){let{x:t,y:i}=this.g.term.mouse;this.examine({x:t,y:i})}handleKeys(){let{player:t,term:i}=this.g,o=i.getMovementKey();if(o){this.g.fire("playerMove",{move:o});return}if(i.isKeyPressed(q.Key.VK_1)){this.g.fire("playerFire",{array:0});return}if(i.isKeyPressed(q.Key.VK_2)){this.g.fire("playerFire",{array:1});return}if(i.isKeyPressed(q.Key.VK_F)){Me(this.g,j(this.g,t),4.5),this.g.tick();return}}};var ot=class{constructor(t,i=5,o=100){this.g=t;this.starfieldSpeed=i;this.starCount=o}init(){this.dirty=!0,this.pilot={name:"Player",difficulty:NaN,body:1,mind:1,spirit:1,talent:1,class:[]},this.points=6,this.starfieldCounter=0,this.stars=[];for(let t=0;t<this.starCount;t++)this.stars.push(this.newStar())}draw(){let{term:t}=this.g;t.clear();for(let s of this.stars){let{x:a,y:l}=C(s);t.drawChar(a,l,s.c,s.fg)}let i=t.width/2;t.drawCenteredString(i,2,"Bullet Hell Roguelike",u.Colors.WHITE),t.drawCenteredString(i,9,"Create your Pilot",u.Colors.WHITE),t.drawCenteredString(i,10,`${this.points} points`,u.Colors.YELLOW);let o=2,r=Math.floor((t.width-o*2)/4),n=o+r/2;this.drawStat("body",n),this.drawStat("mind",n+r),this.drawStat("spirit",n+r*2),this.drawStat("talent",n+r*3),this.points===0&&t.drawCenteredString(i,20,"Hit Enter to begin!",u.Colors.WHITE),this.dirty=!1}drawStat(t,i){let{term:o}=this.g,r=`(${t[0].toUpperCase()})${t.slice(1)}`,n=this.pilot[t];o.drawCenteredString(i,13,r,u.Colors.LIGHT_CYAN),o.drawCenteredString(i,14,n.toString(),ht[n])}update(){this.handleStarfield(),this.handleKeys(),this.dirty&&this.draw()}newStar(){let{term:t}=this.g,i=A([u.Colors.DARK_RED,u.Colors.LIGHT_RED,u.Colors.YELLOW,u.Colors.LIGHT_CYAN,u.Colors.WHITE]),o=.5+Math.random(),r=o<.75?".":o<1.25?m.Dot:"*",n=Math.random()*Math.PI*2;return{x:t.width/2,y:t.height/2,c:r,fg:i,vel:o,angle:n}}handleStarfield(){if(this.starfieldCounter<this.starfieldSpeed){this.starfieldCounter++;return}this.starfieldCounter=0,this.dirty=!0;let{width:t,height:i}=this.g.term;for(let o of this.stars){let[r,n]=dt(o);o.x+=r,o.y+=n,(o.x<0||o.x>=t||o.y<0||o.y>=i)&&Object.assign(o,this.newStar())}}isPressed(t,i){let o=this.g.term.isKeyDown(u.Key.VK_SHIFT_LEFT)||this.g.term.isKeyDown(u.Key.VK_SHIFT_RIGHT);return this.g.term.isKeyPressed(t)&&i===o}changeStat(t,i){let o=this.pilot[t]+i;if(o<1||o>6)return!1;this.points-=i,this.pilot[t]=o,this.dirty=!0}handleKeys(){this.points>0&&(this.isPressed(u.Key.VK_B,!1)&&this.changeStat("body",1),this.isPressed(u.Key.VK_M,!1)&&this.changeStat("mind",1),this.isPressed(u.Key.VK_S,!1)&&this.changeStat("spirit",1),this.isPressed(u.Key.VK_T,!1)&&this.changeStat("talent",1)),this.isPressed(u.Key.VK_B,!0)&&this.changeStat("body",-1),this.isPressed(u.Key.VK_M,!0)&&this.changeStat("mind",-1),this.isPressed(u.Key.VK_S,!0)&&this.changeStat("spirit",-1),this.isPressed(u.Key.VK_T,!0)&&this.changeStat("talent",-1),this.points===0&&this.g.term.isKeyPressed(u.Key.VK_ENTER)&&this.g.setMode(new it(this.g,"PlayerShip",this.pilot))}};var rt=class{constructor(t){this.keyFn=t;this.items=new Map}has(t){return this.items.has(this.keyFn(t))}get(t){return this.items.get(this.keyFn(t))}getOrDefault(t,i){let o=this.items.get(this.keyFn(t));return typeof o!="undefined"?o:i}getOrDie(t){let i=this.keyFn(t),o=this.items.get(i);if(typeof o=="undefined")throw new Error(`Invalid key: ${i}`);return o}set(t,i){this.items.set(this.keyFn(t),i)}};function Jt(e,t,i=1/0){let o=[],r=new rt(n=>`${n.x},${n.y}`);for(let n of e)o.push(n),r.set(n,0);for(;o.length;){let n=o.shift(),s=r.getOrDie(n)+1;if(!(s>i))for(let a of kt(n))!r.has(a)&&t(a)&&(r.set(a,s),o.push(a))}return r}function Zt(e){return typeof e!="undefined"}var nt=class{constructor(t,i,o){this.term=t;this.mapWidth=i;this.mapHeight=o;t.update=this.update.bind(this),this.map=new Ce.Console(i,o,()=>!0),this.lastEntityId=0,this.entities=new X(ae),this.overlays=new Map,this.clearEventHandlers(),this.setMode(new ot(this))}setMode(t){this.mode=t,this.mode.init()}clearEventHandlers(){this.eventCallbacks=se(le.map(t=>[t,[]]))}fire(t,i){for(let o of this.eventCallbacks[t])o(i)}on(t,i){this.eventCallbacks[t].push(i)}spawn(t){return Dt(this,t)}refresh(){this.mode.dirty=!0}add(t){return this.refresh(),this.entities.add(t),this.fire("spawn",{e:t}),t}kill(t,i){t.alive&&(t.kill(i),this.fire("kill",{e:t,by:i}))}move(t,i){let o=t.position;t.move(i.x,i.y),o&&this.fire("move",{e:t,old:o,pos:i})}blankMap(){let{map:t,mapHeight:i,mapWidth:o}=this;t.clear();for(let r=0;r<i;r++)for(let n=0;n<o;n++)t.setBlocked(n,r,!1),t.setBlockedSight(n,r,!1);t.computeFov(0,0,1/0)}drawIfVisible(t,i,o,r,n,s){this.map.isVisible(t,i)&&(s?this.term.drawCell(t,i,{bg:n},s):this.term.drawChar(t,i,o,r,n))}getRoot(t){return t.attachment?this.getRoot(t.attachment.parent):t}getContents(t,i=[]){let o=C(t);if(!this.inBounds(o))return{wall:!0,other:[]};let r=this.map.isBlocked(o.x,o.y),n=this.entities.get().filter(a=>a.position&&R(o,a.position)),s=n.filter(a=>!i.includes(a.id)).find(a=>a.solid);return{wall:r,solid:s,other:n.filter(a=>!a.solid)}}tick(){this.overlays.clear(),this.fire("tick",void 0),this.entities.clearDead()}update(){this.mode.update()}inBounds(t){return t.x>=0&&t.y>=0&&t.x<this.mapWidth&&t.y<this.mapHeight}getDistanceMap(t){let i=`${t.id}.distance`,o=this.overlays.get(i);return o||(o=Jt(M(this,t).map(r=>r.position).filter(Zt),this.inBounds.bind(this)),this.overlays.set(i,o)),o}damage(t,i,o){let r=this.getRoot(t);if(!r.ship)return;let n=i;r.ship.shield>0&&(r.ship.shield>i?(r.ship.shield-=i,n=0):(n-=r.ship.shield,r.ship.shield=0)),n&&(r.ship.hp-=n),console.log(o.name,"hits",r.name,"for",i),this.fire("damage",{e:r,inflicter:o,amount:i}),r.ship.hp<=0&&this.kill(r,o)}};function Bi(e){let o=bt.DEFAULT_FONT,r=document.createElement("div");e.appendChild(r);let n=()=>{let p=60*o.charWidth,h=40*o.charHeight,c=Math.floor(window.innerWidth/p),y=Math.floor(window.innerHeight/h),w=Math.min(c,y);r.style.width=`${p*w}px`,r.style.height=`${h*w}px`};window.addEventListener("resize",n),n();let s=document.createElement("canvas");r.appendChild(s),requestAnimationFrame(()=>s.focus());let a=new bt.Terminal(s,60,40,{font:o}),l=new nt(a,60,40-U);window.g=l}window.addEventListener("load",()=>Bi(document.body));})();
//# sourceMappingURL=bundle.js.map
